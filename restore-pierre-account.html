<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restore Pierre Super User Account</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
    }
    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }
    h1 {
      margin-top: 0;
      font-size: 2.5em;
      text-align: center;
    }
    .status {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 10px;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
      max-height: 400px;
      overflow-y: auto;
    }
    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 1.1em;
      border-radius: 10px;
      cursor: pointer;
      width: 100%;
      margin: 10px 0;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .info-box {
      background: rgba(255, 255, 255, 0.15);
      padding: 20px;
      border-radius: 10px;
      margin: 20px 0;
    }
    .success {
      color: #4ade80;
      font-weight: bold;
    }
    .error {
      color: #f87171;
      font-weight: bold;
    }
    .warning {
      color: #fbbf24;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîê Restore Pierre Super User</h1>

    <div class="info-box">
      <h3>Account Details:</h3>
      <p><strong>Email:</strong> pierre@phaetonai.com</p>
      <p><strong>Role:</strong> Super User</p>
      <p><strong>Password:</strong> $Ineed1millie$_carexps</p>
    </div>

    <button id="checkBtn" onclick="checkUserExists()">Step 1: Check User Status</button>
    <button id="restoreBtn" onclick="restoreUser()" disabled>Step 2: Restore User Account</button>
    <button id="verifyBtn" onclick="verifyRestore()" disabled>Step 3: Verify Restoration</button>

    <div id="status" class="status"></div>
  </div>

  <script type="module">
    import { UserManagementService } from './src/services/userManagementService.ts'

    window.userService = UserManagementService

    function log(message, type = 'info') {
      const statusDiv = document.getElementById('status')
      const timestamp = new Date().toLocaleTimeString()
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : ''
      statusDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`
      statusDiv.scrollTop = statusDiv.scrollHeight
    }

    window.checkUserExists = async function() {
      log('üîç Checking if pierre@phaetonai.com exists...', 'info')

      try {
        const response = await window.userService.loadSystemUsers()

        if (response.status === 'error') {
          log(`‚ùå Error loading users: ${response.error}`, 'error')
          return
        }

        const users = response.data || []
        const pierreUser = users.find(u => u.email === 'pierre@phaetonai.com')

        if (pierreUser) {
          log(`‚úÖ User FOUND in database!`, 'success')
          log(`   ID: ${pierreUser.id}`, 'info')
          log(`   Name: ${pierreUser.name}`, 'info')
          log(`   Role: ${pierreUser.role}`, 'info')
          log(`   Status: ${pierreUser.isActive ? 'Active' : 'Inactive'}`, 'info')

          if (pierreUser.role === 'super_user') {
            log(`‚úÖ User already has Super User role - no restoration needed!`, 'success')
            document.getElementById('verifyBtn').disabled = false
          } else {
            log(`‚ö†Ô∏è User exists but role is ${pierreUser.role} instead of super_user`, 'warning')
            document.getElementById('restoreBtn').disabled = false
          }
        } else {
          log(`‚ö†Ô∏è User NOT FOUND - will create new user`, 'warning')
          document.getElementById('restoreBtn').disabled = false
        }

        document.getElementById('checkBtn').disabled = true

      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error')
      }
    }

    window.restoreUser = async function() {
      log('üîÑ Starting user restoration...', 'info')

      try {
        // Check if user exists first
        const checkResponse = await window.userService.loadSystemUsers()
        const users = checkResponse.data || []
        const existingUser = users.find(u => u.email === 'pierre@phaetonai.com')

        if (existingUser) {
          log('üìù User exists, updating profile...', 'info')

          // Update existing user
          const updateData = {
            ...existingUser,
            role: 'super_user',
            name: 'Pierre Morenzie',
            isActive: true
          }

          const saveResponse = await window.userService.saveSystemUsers([updateData])

          if (saveResponse.status === 'error') {
            log(`‚ùå Update failed: ${saveResponse.error}`, 'error')
            return
          }

          log('‚úÖ User profile updated successfully!', 'success')
        } else {
          log('üë§ Creating new user account...', 'info')

          const userData = {
            email: 'pierre@phaetonai.com',
            name: 'Pierre Morenzie',
            role: 'super_user',
            isActive: true,
            mfaEnabled: false
          }

          const credentials = {
            username: 'pierre@phaetonai.com',
            password: '$Ineed1millie$_carexps'
          }

          const createResponse = await window.userService.createSystemUser(userData, credentials)

          if (createResponse.status === 'error') {
            log(`‚ùå Creation failed: ${createResponse.error}`, 'error')
            return
          }

          log('‚úÖ User account created successfully!', 'success')
          log(`   User ID: ${createResponse.data.id}`, 'info')
        }

        document.getElementById('restoreBtn').disabled = true
        document.getElementById('verifyBtn').disabled = false

      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error')
      }
    }

    window.verifyRestore = async function() {
      log('üîç Verifying restoration...', 'info')

      try {
        // Test authentication
        log('üîê Testing authentication...', 'info')

        const authResponse = await window.userService.authenticateUser(
          'pierre@phaetonai.com',
          '$Ineed1millie$_carexps'
        )

        if (authResponse.status === 'error') {
          log(`‚ùå Authentication failed: ${authResponse.error}`, 'error')
          return
        }

        if (!authResponse.data) {
          log(`‚ùå Authentication failed: Invalid credentials`, 'error')
          return
        }

        const user = authResponse.data
        log('‚úÖ Authentication SUCCESSFUL!', 'success')
        log(`   Email: ${user.email}`, 'info')
        log(`   Name: ${user.name}`, 'info')
        log(`   Role: ${user.role}`, 'info')

        if (user.role === 'super_user') {
          log('‚úÖ Super User role CONFIRMED!', 'success')
        } else {
          log(`‚ö†Ô∏è Warning: Role is ${user.role} instead of super_user`, 'warning')
        }

        log('', 'info')
        log('üéâ RESTORATION COMPLETE!', 'success')
        log('You can now log in with pierre@phaetonai.com', 'success')

        document.getElementById('verifyBtn').disabled = true

      } catch (error) {
        log(`‚ùå Error: ${error.message}`, 'error')
      }
    }

    // Auto-run check on page load
    window.addEventListener('load', () => {
      log('üöÄ Pierre Super User Restoration Utility Loaded', 'info')
      log('Click "Check User Status" to begin...', 'info')
    })
  </script>
</body>
</html>
