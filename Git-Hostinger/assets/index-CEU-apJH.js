const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index.es-B8PC5nDV.js","assets/vendor-Boaau3YS.js","assets/auth-D7jcBZ_O.js","assets/router-CLkQIfY9.js","assets/utils-FKoCXWpg.js","assets/virtual_pwa-register-Drt9AF-2.js"])))=>i.map(i=>d[i]);
var e=Object.defineProperty,t=Object.defineProperties,s=Object.getOwnPropertyDescriptors,i=Object.getOwnPropertySymbols,n=Object.getPrototypeOf,r=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,o=Reflect.get,l=Math.pow,c=(t,s,i)=>s in t?e(t,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[s]=i,d=(e,t)=>{for(var s in t||(t={}))r.call(t,s)&&c(e,s,t[s]);if(i)for(var s of i(t))a.call(t,s)&&c(e,s,t[s]);return e},u=(e,i)=>t(e,s(i)),h=(e,t)=>{var s={};for(var n in e)r.call(e,n)&&t.indexOf(n)<0&&(s[n]=e[n]);if(null!=e&&i)for(var n of i(e))t.indexOf(n)<0&&a.call(e,n)&&(s[n]=e[n]);return s},f=(e,t,s)=>c(e,"symbol"!=typeof t?t+"":t,s),m=(e,t,s)=>o(n(e),s,t),p=(e,t,s)=>new Promise((i,n)=>{var r=e=>{try{o(s.next(e))}catch(Tx){n(Tx)}},a=e=>{try{o(s.throw(e))}catch(Tx){n(Tx)}},o=e=>e.done?i(e.value):Promise.resolve(e.value).then(r,a);o((s=s.apply(e,t)).next())});import{_ as g}from"./auth-D7jcBZ_O.js";import{r as v,b as y,g as b,c as x,a as w,d as S}from"./vendor-Boaau3YS.js";import{u as k,N as _,B as C,R as N,a as T,b as A}from"./router-CLkQIfY9.js";import{C as E}from"./utils-FKoCXWpg.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const s of e)if("childList"===s.type)for(const e of s.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var j={exports:{}},P={},I=v,L=Symbol.for("react.element"),R=Symbol.for("react.fragment"),O=Object.prototype.hasOwnProperty,D=I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,M={key:!0,ref:!0,__self:!0,__source:!0};function U(e,t,s){var i,n={},r=null,a=null;for(i in void 0!==s&&(r=""+s),void 0!==t.key&&(r=""+t.key),void 0!==t.ref&&(a=t.ref),t)O.call(t,i)&&!M.hasOwnProperty(i)&&(n[i]=t[i]);if(e&&e.defaultProps)for(i in t=e.defaultProps)void 0===n[i]&&(n[i]=t[i]);return{$$typeof:L,type:e,key:r,ref:a,props:n,_owner:D.current}}P.Fragment=R,P.jsx=U,P.jsxs=U,j.exports=P;var F=j.exports,B={},q=y;B.createRoot=q.createRoot,B.hydrateRoot=q.hydrateRoot;const $={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_APP_ENVIRONMENT:"production",VITE_APP_URL:"https://carexps.nexasync.ca",VITE_AUDIT_ENCRYPTION_KEY:"dummy_key_for_dev",VITE_HIPAA_MODE:"true",VITE_PHI_ENCRYPTION_KEY:"dummy_key_for_dev",VITE_SUPABASE_ANON_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0",VITE_SUPABASE_SERVICE_ROLE_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU",VITE_SUPABASE_URL:"http://localhost:54321"};const z=new class{constructor(){f(this,"encryptionKey",null),f(this,"keyLength",256),f(this,"algorithm","AES-GCM"),f(this,"ivLength",12),f(this,"tagLength",16)}initialize(e){return p(this,null,function*(){try{const t=e||(null==$?void 0:$.VITE_ENCRYPTION_MASTER_KEY)||"hipaa-compliant-key-2024",s=(new TextEncoder).encode(t),i=yield crypto.subtle.importKey("raw",s,"PBKDF2",!1,["deriveBits","deriveKey"]),n=new Uint8Array([72,73,80,65,65,45,67,82,77,45,50,48,50,52,45,83]);this.encryptionKey=yield crypto.subtle.deriveKey({name:"PBKDF2",salt:n,iterations:1e5,hash:"SHA-256"},i,{name:this.algorithm,length:this.keyLength},!1,["encrypt","decrypt"])}catch(t){throw new Error("Encryption service initialization failed")}})}encrypt(e){return p(this,null,function*(){if(this.encryptionKey||(yield this.initialize()),!this.encryptionKey)throw new Error("Encryption key not available");try{const t=(new TextEncoder).encode(e),s=crypto.getRandomValues(new Uint8Array(this.ivLength)),i=yield crypto.subtle.encrypt({name:this.algorithm,iv:s,tagLength:8*this.tagLength},this.encryptionKey,t),n=new Uint8Array(i),r=n.slice(0,-this.tagLength),a=n.slice(-this.tagLength);return{data:this.arrayBufferToBase64(r),iv:this.arrayBufferToBase64(s),tag:this.arrayBufferToBase64(a),timestamp:Date.now()}}catch(t){throw new Error("Failed to encrypt data")}})}decrypt(e){return p(this,null,function*(){if(this.encryptionKey||(yield this.initialize()),!this.encryptionKey)throw new Error("Encryption key not available");try{const t=this.base64ToArrayBuffer(e.data),s=this.base64ToArrayBuffer(e.iv),i=this.base64ToArrayBuffer(e.tag),n=new Uint8Array(t.byteLength+i.byteLength);n.set(new Uint8Array(t),0),n.set(new Uint8Array(i),t.byteLength);const r=yield crypto.subtle.decrypt({name:this.algorithm,iv:s,tagLength:8*this.tagLength},this.encryptionKey,n);return(new TextDecoder).decode(r)}catch(t){throw new Error("Failed to decrypt data - data may be corrupted or key is invalid")}})}encryptObject(e,t){return p(this,null,function*(){const s=d({},e);for(const e of t)if(s[e]&&"string"==typeof s[e])try{s[e]=yield this.encrypt(s[e])}catch(i){throw i}return s})}decryptObject(e,t){return p(this,null,function*(){const s=d({},e);for(const e of t)if(s[e]&&"object"==typeof s[e])try{const t=s[e];t.data&&t.iv&&t.tag&&(s[e]=yield this.decrypt(t))}catch(i){s[e]="[ENCRYPTED_DATA]"}return s})}arrayBufferToBase64(e){const t=new Uint8Array(e);let s="";for(let i=0;i<t.byteLength;i++)s+=String.fromCharCode(t[i]);return btoa(s)}base64ToArrayBuffer(e){const t=atob(e),s=new Uint8Array(t.length);for(let i=0;i<t.length;i++)s[i]=t.charCodeAt(i);return s.buffer}testEncryption(){return p(this,null,function*(){try{const e="HIPAA Test Data: Patient John Doe, DOB: 1980-01-01",t=yield this.encrypt(e);return(yield this.decrypt(t))===e}catch(e){return!1}})}clearKey(){this.encryptionKey=null}encryptString(e){return p(this,null,function*(){const t=yield this.encrypt(e);return`${t.data}:${t.iv}:${t.tag}:${t.timestamp}`})}decryptString(e){return p(this,null,function*(){try{if(e.includes(":")&&4===e.split(":").length){const[t,s,i,n]=e.split(":"),r={data:t,iv:s,tag:i,timestamp:parseInt(n)};return yield this.decrypt(r)}try{const t=JSON.parse(e);return yield this.decrypt(t)}catch(Tx){throw new Error("Invalid encrypted string format")}}catch(t){throw new Error("Failed to decrypt string - data may be corrupted or key is invalid")}})}};z.initialize().catch(e=>{});const H=Object.freeze(Object.defineProperty({__proto__:null,encryptionService:z},Symbol.toStringTag,{value:"Module"}));var V=(e=>(e.VIEW="VIEW",e.READ="READ",e.SEARCH="SEARCH",e.EXPORT="EXPORT",e.DOWNLOAD="DOWNLOAD",e.CREATE="CREATE",e.UPDATE="UPDATE",e.DELETE="DELETE",e.LOGIN="LOGIN",e.LOGOUT="LOGOUT",e.LOGIN_FAILURE="LOGIN_FAILURE",e.BACKUP="BACKUP",e.RESTORE="RESTORE",e.SYSTEM_ACCESS="SYSTEM_ACCESS",e.ENCRYPT="ENCRYPT",e.DECRYPT="DECRYPT",e.KEY_ACCESS="KEY_ACCESS",e))(V||{}),G=(e=>(e.PATIENT="PATIENT",e.CALL="CALL",e.SMS="SMS",e.TRANSCRIPT="TRANSCRIPT",e.REPORT="REPORT",e.SYSTEM="SYSTEM",e.USER="USER",e.AUDIT_LOG="AUDIT_LOG",e))(G||{}),J=(e=>(e.SUCCESS="SUCCESS",e.FAILURE="FAILURE",e.WARNING="WARNING",e))(J||{});const W=new class{constructor(){f(this,"sessionId",""),f(this,"currentUser",null),this.sessionId=this.generateSessionId(),this.getCurrentUser()}initialize(e){return p(this,null,function*(){this.currentUser=e,this.sessionId=this.generateSessionId(),yield this.logAuditEvent({action:"SYSTEM_ACCESS",resourceType:"SYSTEM",resourceId:"carexps-crm",phiAccessed:!1,outcome:"SUCCESS",additionalInfo:{systemComponent:"audit-logger",initializationTime:(new Date).toISOString()}})})}logPHIAccess(e,t,s,i="SUCCESS",n){return p(this,null,function*(){yield this.logAuditEvent({action:e,resourceType:t,resourceId:s,phiAccessed:!0,outcome:i,additionalInfo:u(d({},n),{phiDataType:t,complianceNote:"HIPAA PHI access logged per § 164.312(b)"})})})}logEncryptionOperation(e,t,s,i,n){return p(this,null,function*(){yield this.logAuditEvent({action:e,resourceType:t,resourceId:s,phiAccessed:!0,outcome:i,failureReason:n,additionalInfo:{encryptionStandard:"AES-256-GCM",complianceNote:"HIPAA encryption operation per § 164.312(a)(2)(iv)"}})})}logAuthenticationEvent(e,t,s,i){return p(this,null,function*(){yield this.logAuditEvent({action:e,resourceType:"SYSTEM",resourceId:"authentication-system",phiAccessed:!1,outcome:s,failureReason:i,additionalInfo:{authenticationMethod:"local-storage-demo",complianceNote:"HIPAA authentication event per § 164.312(d)"}})})}logSecurityEvent(e,t,s,i){return p(this,null,function*(){let n,r,a=!1;switch(e.includes("AUTHENTICATION")?n=e.includes("SUCCESS")?"LOGIN":e.includes("FAILURE")||e.includes("ERROR")?"LOGIN_FAILURE":"LOGIN":e.includes("CREATE")?n="CREATE":e.includes("UPDATE")?n="UPDATE":e.includes("DELETE")?n="DELETE":e.includes("ACCESS")?(n="VIEW",a=!0):n="SYSTEM_ACCESS",t.toLowerCase()){case"users":r="USER";break;case"calls":r="CALL",a=!0;break;case"sms":r="SMS",a=!0;break;case"patients":r="PATIENT",a=!0;break;default:r="SYSTEM"}const o=s?"SUCCESS":"FAILURE";yield this.logAuditEvent({action:n,resourceType:r,resourceId:e,phiAccessed:a,outcome:o,failureReason:s?void 0:(null==i?void 0:i.error)||"Operation failed",additionalInfo:u(d({},i),{originalEventType:e,complianceNote:"HIPAA security event logged per § 164.312(b)"})})})}logAuditEvent(e){return p(this,null,function*(){var t,s,i;try{const n=(new Date).toISOString(),r=this.getSourceInformation(),a={timestamp:n,user_id:(null==(t=this.currentUser)?void 0:t.id)||"anonymous",user_name:(null==(s=this.currentUser)?void 0:s.name)||"Anonymous User",user_role:(null==(i=this.currentUser)?void 0:i.role)||"unknown",action:e.action,resource_type:e.resourceType,resource_id:e.resourceId,phi_accessed:e.phiAccessed,source_ip:r.ip,user_agent:r.userAgent,session_id:this.sessionId,outcome:e.outcome,failure_reason:e.failureReason,additional_info:u(d({},e.additionalInfo),{hipaaCompliant:!0,auditVersion:"1.0",retentionPeriod:"6-years"})},o=yield this.encryptAuditEntry(a);yield this.storeAuditEntry(o)}catch(n){try{const t={timestamp:(new Date).toISOString(),error:"AUDIT_LOG_FAILURE",originalAction:e.action,failureDetails:n instanceof Error?n.message:"Unknown error"};localStorage.setItem(`audit_failure_${Date.now()}`,JSON.stringify(t))}catch(r){}}})}encryptAuditEntry(e){return p(this,null,function*(){const t=["user_name","additional_info","failure_reason"],s=d({},e);for(const e of t)if(s[e]){const t=s[e];"string"==typeof t?s[e]=yield z.encrypt(t):"object"==typeof t&&(s[e]=yield z.encrypt(JSON.stringify(t)))}return s})}storeAuditEntry(e){return p(this,null,function*(){this.storeAuditEntryLocally(e)})}storeAuditEntryLocally(e){try{const s=localStorage.getItem("auditLogs");let i=[];if(s)try{i=JSON.parse(s)}catch(t){i=[]}i.push(u(d({},e),{stored_locally:!0,local_timestamp:(new Date).toISOString()})),i.length>1e3&&(i=i.slice(-1e3)),localStorage.setItem("auditLogs",JSON.stringify(i))}catch(t){}}getAuditLogs(){return p(this,arguments,function*(e={}){try{if(!this.hasAuditAccess())throw yield this.logAuditEvent({action:"VIEW",resourceType:"AUDIT_LOG",resourceId:"audit-access-denied",phiAccessed:!1,outcome:"FAILURE",failureReason:"Insufficient permissions for audit log access"}),new Error("Insufficient permissions to access audit logs");yield this.logAuditEvent({action:"VIEW",resourceType:"AUDIT_LOG",resourceId:"audit-query",phiAccessed:!0,outcome:"SUCCESS",additionalInfo:{searchCriteria:e}});let s=[];s=this.getAuditLogsFromLocalStorage(e);const i=[];for(const e of s||[])try{const t=yield this.decryptAuditEntry(e);i.push(t)}catch(t){i.push(u(d({},e),{user_name:"[ENCRYPTED_DATA]",additional_info:{decryptionFailed:!0},failure_reason:"[ENCRYPTED_DATA]"}))}const n=this.generateAuditSummary(i,e);return{entries:i,totalCount:i.length,summary:n}}catch(s){throw s}})}getAuditLogsFromLocalStorage(e){try{const t=localStorage.getItem("auditLogs");if(!t)return[];let s=JSON.parse(t);e.startDate&&(s=s.filter(t=>new Date(t.timestamp)>=e.startDate)),e.endDate&&(s=s.filter(t=>new Date(t.timestamp)<=e.endDate)),e.userId&&(s=s.filter(t=>t.user_id===e.userId)),e.action&&(s=s.filter(t=>t.action===e.action)),e.resourceType&&(s=s.filter(t=>t.resource_type===e.resourceType)),e.outcome&&(s=s.filter(t=>t.outcome===e.outcome)),void 0!==e.phiAccessed&&(s=s.filter(t=>t.phi_accessed===e.phiAccessed)),s.sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime());const i=e.offset||0,n=e.limit||100;return s.slice(i,i+n)}catch(t){return[]}}decryptAuditEntry(e){return p(this,null,function*(){const t=d({},e),s=["user_name","additional_info","failure_reason"];for(const e of s)if(t[e]&&"object"==typeof t[e]&&t[e].data)try{const s=yield z.decrypt(t[e]);t[e]="additional_info"===e?JSON.parse(s):s}catch(i){t[e]="[ENCRYPTED_DATA]"}return t})}generateAuditSummary(e,t){const s=e.filter(e=>e.phi_accessed).length,i=e.filter(e=>"FAILURE"===e.outcome).length,n=new Set(e.map(e=>e.user_id)).size,r=e.map(e=>new Date(e.timestamp)),a=r.length>0?new Date(Math.min(...r.map(e=>e.getTime()))):new Date,o=r.length>0?new Date(Math.max(...r.map(e=>e.getTime()))):new Date;return{totalAccess:e.length,phiAccess:s,failures:i,uniqueUsers:n,timeRange:{start:t.startDate||a,end:t.endDate||o}}}exportAuditLogs(e,t="json"){return p(this,null,function*(){var s;yield this.logAuditEvent({action:"EXPORT",resourceType:"AUDIT_LOG",resourceId:"audit-export",phiAccessed:!0,outcome:"SUCCESS",additionalInfo:{exportFormat:t,criteria:e}});const i=yield this.getAuditLogs(e);return"csv"===t?this.convertToCSV(i.entries):JSON.stringify(d({exportTimestamp:(new Date).toISOString(),exportedBy:(null==(s=this.currentUser)?void 0:s.name)||"System",complianceNote:"HIPAA audit log export per § 164.312(b)",retentionRequirement:"6 years minimum"},i),null,2)})}convertToCSV(e){const t=[["Timestamp","User ID","User Name","User Role","Action","Resource Type","Resource ID","PHI Accessed","Source IP","Session ID","Outcome","Failure Reason"].join(",")];for(const s of e){const e=[s.timestamp,s.user_id,`"${s.user_name}"`,s.user_role,s.action,s.resource_type,s.resource_id,s.phi_accessed.toString(),s.source_ip,s.session_id,s.outcome,s.failure_reason?`"${s.failure_reason}"`:""];t.push(e.join(","))}return t.join("\n")}hasAuditAccess(){var e;return["super_user","compliance_officer","system_admin"].includes((null==(e=this.currentUser)?void 0:e.role)||"")}getSourceInformation(){return{ip:"127.0.0.1",userAgent:navigator.userAgent||"Unknown"}}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}getCurrentUser(){try{const e=localStorage.getItem("currentUser");e&&(this.currentUser=JSON.parse(e))}catch(e){}}cleanup(){return p(this,null,function*(){yield this.logAuditEvent({action:"LOGOUT",resourceType:"SYSTEM",resourceId:"audit-logger",phiAccessed:!1,outcome:"SUCCESS",additionalInfo:{sessionDuration:Date.now()-parseInt(this.sessionId.split("_")[1]),cleanupTime:(new Date).toISOString()}})})}},K=()=>{try{const e=localStorage.getItem("currentUser");if(e){const t=JSON.parse(e);W.initialize(t)}}catch(e){}};K(),window.addEventListener("storage",e=>{"currentUser"===e.key&&K()});class Y extends Error{constructor(e,t="FunctionsError",s){super(e),this.name=t,this.context=s}}class X extends Y{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class Q extends Y{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class Z extends Y{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var ee,te;(te=ee||(ee={})).Any="any",te.ApNortheast1="ap-northeast-1",te.ApNortheast2="ap-northeast-2",te.ApSouth1="ap-south-1",te.ApSoutheast1="ap-southeast-1",te.ApSoutheast2="ap-southeast-2",te.CaCentral1="ca-central-1",te.EuCentral1="eu-central-1",te.EuWest1="eu-west-1",te.EuWest2="eu-west-2",te.EuWest3="eu-west-3",te.SaEast1="sa-east-1",te.UsEast1="us-east-1",te.UsWest1="us-west-1",te.UsWest2="us-west-2";var se=function(e,t,s,i){return new(s||(s=Promise))(function(n,r){function a(e){try{l(i.next(e))}catch(Tx){r(Tx)}}function o(e){try{l(i.throw(e))}catch(Tx){r(Tx)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(a,o)}l((i=i.apply(e,t||[])).next())})};class ie{constructor(e,{headers:t={},customFetch:s,region:i=ee.Any}={}){this.url=e,this.headers=t,this.region=i,this.fetch=(e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>g(()=>p(void 0,null,function*(){const{default:e}=yield Promise.resolve().then(()=>ge);return{default:e}}),void 0).then(({default:t})=>t(...e)):fetch),(...e)=>t(...e)})(s)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,t={}){var s;return se(this,void 0,void 0,function*(){try{const{headers:i,method:n,body:r}=t;let a={},{region:o}=t;o||(o=this.region);const l=new URL(`${this.url}/${e}`);let c;o&&"any"!==o&&(a["x-region"]=o,l.searchParams.set("forceFunctionRegion",o)),r&&(i&&!Object.prototype.hasOwnProperty.call(i,"Content-Type")||!i)&&("undefined"!=typeof Blob&&r instanceof Blob||r instanceof ArrayBuffer?(a["Content-Type"]="application/octet-stream",c=r):"string"==typeof r?(a["Content-Type"]="text/plain",c=r):"undefined"!=typeof FormData&&r instanceof FormData?c=r:(a["Content-Type"]="application/json",c=JSON.stringify(r)));const d=yield this.fetch(l.toString(),{method:n||"POST",headers:Object.assign(Object.assign(Object.assign({},a),this.headers),i),body:c}).catch(e=>{throw new X(e)}),u=d.headers.get("x-relay-error");if(u&&"true"===u)throw new Q(d);if(!d.ok)throw new Z(d);let h,f=(null!==(s=d.headers.get("Content-Type"))&&void 0!==s?s:"text/plain").split(";")[0].trim();return h="application/json"===f?yield d.json():"application/octet-stream"===f?yield d.blob():"text/event-stream"===f?d:"multipart/form-data"===f?yield d.formData():yield d.text(),{data:h,error:null,response:d}}catch(i){return{data:null,error:i,response:i instanceof Z||i instanceof Q?i.context:void 0}}})}}var ne={},re={},ae={},oe={},le={},ce={},de=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("unable to locate global object")}();const ue=de.fetch,he=de.fetch.bind(de),fe=de.Headers,me=de.Request,pe=de.Response,ge=Object.freeze(Object.defineProperty({__proto__:null,Headers:fe,Request:me,Response:pe,default:he,fetch:ue},Symbol.toStringTag,{value:"Module"})),ve=b(ge);var ye={};Object.defineProperty(ye,"__esModule",{value:!0});let be=class extends Error{constructor(e){super(e.message),this.name="PostgrestError",this.details=e.details,this.hint=e.hint,this.code=e.code}};ye.default=be;var xe=x&&x.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(ce,"__esModule",{value:!0});const we=xe(ve),Se=xe(ye);ce.default=class{constructor(e){var t,s;this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=new Headers(e.headers),this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=null!==(t=e.shouldThrowOnError)&&void 0!==t&&t,this.signal=e.signal,this.isMaybeSingle=null!==(s=e.isMaybeSingle)&&void 0!==s&&s,e.fetch?this.fetch=e.fetch:"undefined"==typeof fetch?this.fetch=we.default:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(e,t){return this.headers=new Headers(this.headers),this.headers.set(e,t),this}then(e,t){void 0===this.schema||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),"GET"!==this.method&&"HEAD"!==this.method&&this.headers.set("Content-Type","application/json");let s=(0,this.fetch)(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(e=>p(this,null,function*(){var t,s,i,n;let r=null,a=null,o=null,l=e.status,c=e.statusText;if(e.ok){if("HEAD"!==this.method){const s=yield e.text();""===s||(a="text/csv"===this.headers.get("Accept")||this.headers.get("Accept")&&(null===(t=this.headers.get("Accept"))||void 0===t?void 0:t.includes("application/vnd.pgrst.plan+text"))?s:JSON.parse(s))}const n=null===(s=this.headers.get("Prefer"))||void 0===s?void 0:s.match(/count=(exact|planned|estimated)/),d=null===(i=e.headers.get("content-range"))||void 0===i?void 0:i.split("/");n&&d&&d.length>1&&(o=parseInt(d[1])),this.isMaybeSingle&&"GET"===this.method&&Array.isArray(a)&&(a.length>1?(r={code:"PGRST116",details:`Results contain ${a.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},a=null,o=null,l=406,c="Not Acceptable"):a=1===a.length?a[0]:null)}else{const t=yield e.text();try{r=JSON.parse(t),Array.isArray(r)&&404===e.status&&(a=[],r=null,l=200,c="OK")}catch(d){404===e.status&&""===t?(l=204,c="No Content"):r={message:t}}if(r&&this.isMaybeSingle&&(null===(n=null==r?void 0:r.details)||void 0===n?void 0:n.includes("0 rows"))&&(r=null,l=200,c="OK"),r&&this.shouldThrowOnError)throw new Se.default(r)}return{error:r,data:a,count:o,status:l,statusText:c}}));return this.shouldThrowOnError||(s=s.catch(e=>{var t,s,i;return{error:{message:`${null!==(t=null==e?void 0:e.name)&&void 0!==t?t:"FetchError"}: ${null==e?void 0:e.message}`,details:`${null!==(s=null==e?void 0:e.stack)&&void 0!==s?s:""}`,hint:"",code:`${null!==(i=null==e?void 0:e.code)&&void 0!==i?i:""}`},data:null,count:null,status:0,statusText:""}})),s.then(e,t)}returns(){return this}overrideTypes(){return this}};var ke=x&&x.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(le,"__esModule",{value:!0});const _e=ke(ce);let Ce=class extends _e.default{select(e){let t=!1;const s=(null!=e?e:"*").split("").map(e=>/\s/.test(e)&&!t?"":('"'===e&&(t=!t),e)).join("");return this.url.searchParams.set("select",s),this.headers.append("Prefer","return=representation"),this}order(e,{ascending:t=!0,nullsFirst:s,foreignTable:i,referencedTable:n=i}={}){const r=n?`${n}.order`:"order",a=this.url.searchParams.get(r);return this.url.searchParams.set(r,`${a?`${a},`:""}${e}.${t?"asc":"desc"}${void 0===s?"":s?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t,referencedTable:s=t}={}){const i=void 0===s?"limit":`${s}.limit`;return this.url.searchParams.set(i,`${e}`),this}range(e,t,{foreignTable:s,referencedTable:i=s}={}){const n=void 0===i?"offset":`${i}.offset`,r=void 0===i?"limit":`${i}.limit`;return this.url.searchParams.set(n,`${e}`),this.url.searchParams.set(r,""+(t-e+1)),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return"GET"===this.method?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:e=!1,verbose:t=!1,settings:s=!1,buffers:i=!1,wal:n=!1,format:r="text"}={}){var a;const o=[e?"analyze":null,t?"verbose":null,s?"settings":null,i?"buffers":null,n?"wal":null].filter(Boolean).join("|"),l=null!==(a=this.headers.get("Accept"))&&void 0!==a?a:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${r}; for="${l}"; options=${o};`),this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(e){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${e}`),this}};le.default=Ce;var Ne=x&&x.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(oe,"__esModule",{value:!0});const Te=Ne(le);let Ae=class extends Te.default{eq(e,t){return this.url.searchParams.append(e,`eq.${t}`),this}neq(e,t){return this.url.searchParams.append(e,`neq.${t}`),this}gt(e,t){return this.url.searchParams.append(e,`gt.${t}`),this}gte(e,t){return this.url.searchParams.append(e,`gte.${t}`),this}lt(e,t){return this.url.searchParams.append(e,`lt.${t}`),this}lte(e,t){return this.url.searchParams.append(e,`lte.${t}`),this}like(e,t){return this.url.searchParams.append(e,`like.${t}`),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,`ilike.${t}`),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}is(e,t){return this.url.searchParams.append(e,`is.${t}`),this}in(e,t){const s=Array.from(new Set(t)).map(e=>"string"==typeof e&&new RegExp("[,()]").test(e)?`"${e}"`:`${e}`).join(",");return this.url.searchParams.append(e,`in.(${s})`),this}contains(e,t){return"string"==typeof t?this.url.searchParams.append(e,`cs.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(t)}`),this}containedBy(e,t){return"string"==typeof t?this.url.searchParams.append(e,`cd.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(t)}`),this}rangeGt(e,t){return this.url.searchParams.append(e,`sr.${t}`),this}rangeGte(e,t){return this.url.searchParams.append(e,`nxl.${t}`),this}rangeLt(e,t){return this.url.searchParams.append(e,`sl.${t}`),this}rangeLte(e,t){return this.url.searchParams.append(e,`nxr.${t}`),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,`adj.${t}`),this}overlaps(e,t){return"string"==typeof t?this.url.searchParams.append(e,`ov.${t}`):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:s,type:i}={}){let n="";"plain"===i?n="pl":"phrase"===i?n="ph":"websearch"===i&&(n="w");const r=void 0===s?"":`(${s})`;return this.url.searchParams.append(e,`${n}fts${r}.${t}`),this}match(e){return Object.entries(e).forEach(([e,t])=>{this.url.searchParams.append(e,`eq.${t}`)}),this}not(e,t,s){return this.url.searchParams.append(e,`not.${t}.${s}`),this}or(e,{foreignTable:t,referencedTable:s=t}={}){const i=s?`${s}.or`:"or";return this.url.searchParams.append(i,`(${e})`),this}filter(e,t,s){return this.url.searchParams.append(e,`${t}.${s}`),this}};oe.default=Ae;var Ee=x&&x.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(ae,"__esModule",{value:!0});const je=Ee(oe);ae.default=class{constructor(e,{headers:t={},schema:s,fetch:i}){this.url=e,this.headers=new Headers(t),this.schema=s,this.fetch=i}select(e,{head:t=!1,count:s}={}){const i=t?"HEAD":"GET";let n=!1;const r=(null!=e?e:"*").split("").map(e=>/\s/.test(e)&&!n?"":('"'===e&&(n=!n),e)).join("");return this.url.searchParams.set("select",r),s&&this.headers.append("Prefer",`count=${s}`),new je.default({method:i,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch})}insert(e,{count:t,defaultToNull:s=!0}={}){var i;if(t&&this.headers.append("Prefer",`count=${t}`),s||this.headers.append("Prefer","missing=default"),Array.isArray(e)){const t=e.reduce((e,t)=>e.concat(Object.keys(t)),[]);if(t.length>0){const e=[...new Set(t)].map(e=>`"${e}"`);this.url.searchParams.set("columns",e.join(","))}}return new je.default({method:"POST",url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:null!==(i=this.fetch)&&void 0!==i?i:fetch})}upsert(e,{onConflict:t,ignoreDuplicates:s=!1,count:i,defaultToNull:n=!0}={}){var r;if(this.headers.append("Prefer",`resolution=${s?"ignore":"merge"}-duplicates`),void 0!==t&&this.url.searchParams.set("on_conflict",t),i&&this.headers.append("Prefer",`count=${i}`),n||this.headers.append("Prefer","missing=default"),Array.isArray(e)){const t=e.reduce((e,t)=>e.concat(Object.keys(t)),[]);if(t.length>0){const e=[...new Set(t)].map(e=>`"${e}"`);this.url.searchParams.set("columns",e.join(","))}}return new je.default({method:"POST",url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:null!==(r=this.fetch)&&void 0!==r?r:fetch})}update(e,{count:t}={}){var s;return t&&this.headers.append("Prefer",`count=${t}`),new je.default({method:"PATCH",url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:null!==(s=this.fetch)&&void 0!==s?s:fetch})}delete({count:e}={}){var t;return e&&this.headers.append("Prefer",`count=${e}`),new je.default({method:"DELETE",url:this.url,headers:this.headers,schema:this.schema,fetch:null!==(t=this.fetch)&&void 0!==t?t:fetch})}};var Pe=x&&x.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(re,"__esModule",{value:!0});const Ie=Pe(ae),Le=Pe(oe);re.default=class e{constructor(e,{headers:t={},schema:s,fetch:i}={}){this.url=e,this.headers=new Headers(t),this.schemaName=s,this.fetch=i}from(e){const t=new URL(`${this.url}/${e}`);return new Ie.default(t,{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(t){return new e(this.url,{headers:this.headers,schema:t,fetch:this.fetch})}rpc(e,t={},{head:s=!1,get:i=!1,count:n}={}){var r;let a;const o=new URL(`${this.url}/rpc/${e}`);let l;s||i?(a=s?"HEAD":"GET",Object.entries(t).filter(([e,t])=>void 0!==t).map(([e,t])=>[e,Array.isArray(t)?`{${t.join(",")}}`:`${t}`]).forEach(([e,t])=>{o.searchParams.append(e,t)})):(a="POST",l=t);const c=new Headers(this.headers);return n&&c.set("Prefer",`count=${n}`),new Le.default({method:a,url:o,headers:c,schema:this.schemaName,body:l,fetch:null!==(r=this.fetch)&&void 0!==r?r:fetch})}};var Re=x&&x.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(ne,"__esModule",{value:!0}),ne.PostgrestError=ne.PostgrestBuilder=ne.PostgrestTransformBuilder=ne.PostgrestFilterBuilder=ne.PostgrestQueryBuilder=ne.PostgrestClient=void 0;const Oe=Re(re);ne.PostgrestClient=Oe.default;const De=Re(ae);ne.PostgrestQueryBuilder=De.default;const Me=Re(oe);ne.PostgrestFilterBuilder=Me.default;const Ue=Re(le);ne.PostgrestTransformBuilder=Ue.default;const Fe=Re(ce);ne.PostgrestBuilder=Fe.default;const Be=Re(ye);ne.PostgrestError=Be.default;var qe=ne.default={PostgrestClient:Oe.default,PostgrestQueryBuilder:De.default,PostgrestFilterBuilder:Me.default,PostgrestTransformBuilder:Ue.default,PostgrestBuilder:Fe.default,PostgrestError:Be.default};const{PostgrestClient:$e,PostgrestQueryBuilder:ze,PostgrestFilterBuilder:He,PostgrestTransformBuilder:Ve,PostgrestBuilder:Ge,PostgrestError:Je}=qe;class We{static detectEnvironment(){var e;if("undefined"!=typeof WebSocket)return{type:"native",constructor:WebSocket};if("undefined"!=typeof globalThis&&void 0!==globalThis.WebSocket)return{type:"native",constructor:globalThis.WebSocket};if("undefined"!=typeof global&&void 0!==global.WebSocket)return{type:"native",constructor:global.WebSocket};if("undefined"!=typeof globalThis&&void 0!==globalThis.WebSocketPair&&void 0===globalThis.WebSocket)return{type:"cloudflare",error:"Cloudflare Workers detected. WebSocket clients are not supported in Cloudflare Workers.",workaround:"Use Cloudflare Workers WebSocket API for server-side WebSocket handling, or deploy to a different runtime."};if("undefined"!=typeof globalThis&&globalThis.EdgeRuntime||"undefined"!=typeof navigator&&(null===(e=navigator.userAgent)||void 0===e?void 0:e.includes("Vercel-Edge")))return{type:"unsupported",error:"Edge runtime detected (Vercel Edge/Netlify Edge). WebSockets are not supported in edge functions.",workaround:"Use serverless functions or a different deployment target for WebSocket functionality."};if("undefined"!=typeof process){const e=process.versions;if(e&&e.node){const t=e.node,s=parseInt(t.replace(/^v/,"").split(".")[0]);return s>=22?void 0!==globalThis.WebSocket?{type:"native",constructor:globalThis.WebSocket}:{type:"unsupported",error:`Node.js ${s} detected but native WebSocket not found.`,workaround:"Provide a WebSocket implementation via the transport option."}:{type:"unsupported",error:`Node.js ${s} detected without native WebSocket support.`,workaround:'For Node.js < 22, install "ws" package and provide it via the transport option:\nimport ws from "ws"\nnew RealtimeClient(url, { transport: ws })'}}}return{type:"unsupported",error:"Unknown JavaScript runtime without WebSocket support.",workaround:"Ensure you're running in a supported environment (browser, Node.js, Deno) or provide a custom WebSocket implementation."}}static getWebSocketConstructor(){const e=this.detectEnvironment();if(e.constructor)return e.constructor;let t=e.error||"WebSocket not supported in this environment.";throw e.workaround&&(t+=`\n\nSuggested solution: ${e.workaround}`),new Error(t)}static createWebSocket(e,t){return new(this.getWebSocketConstructor())(e,t)}static isWebSocketSupported(){try{const e=this.detectEnvironment();return"native"===e.type||"ws"===e.type}catch(e){return!1}}}const Ke=1e4;var Ye,Xe,Qe,Ze,et,tt,st,it,nt,rt,at;(Xe=Ye||(Ye={}))[Xe.connecting=0]="connecting",Xe[Xe.open=1]="open",Xe[Xe.closing=2]="closing",Xe[Xe.closed=3]="closed",(Ze=Qe||(Qe={})).closed="closed",Ze.errored="errored",Ze.joined="joined",Ze.joining="joining",Ze.leaving="leaving",(tt=et||(et={})).close="phx_close",tt.error="phx_error",tt.join="phx_join",tt.reply="phx_reply",tt.leave="phx_leave",tt.access_token="access_token",(st||(st={})).websocket="websocket",(nt=it||(it={})).Connecting="connecting",nt.Open="open",nt.Closing="closing",nt.Closed="closed";class ot{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t("string"==typeof e?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),s=new TextDecoder;return this._decodeBroadcast(e,t,s)}_decodeBroadcast(e,t,s){const i=t.getUint8(1),n=t.getUint8(2);let r=this.HEADER_LENGTH+2;const a=s.decode(e.slice(r,r+i));r+=i;const o=s.decode(e.slice(r,r+n));r+=n;return{ref:null,topic:a,event:o,payload:JSON.parse(s.decode(e.slice(r,e.byteLength)))}}}class lt{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer),this.timer=void 0}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}(at=rt||(rt={})).abstime="abstime",at.bool="bool",at.date="date",at.daterange="daterange",at.float4="float4",at.float8="float8",at.int2="int2",at.int4="int4",at.int4range="int4range",at.int8="int8",at.int8range="int8range",at.json="json",at.jsonb="jsonb",at.money="money",at.numeric="numeric",at.oid="oid",at.reltime="reltime",at.text="text",at.time="time",at.timestamp="timestamp",at.timestamptz="timestamptz",at.timetz="timetz",at.tsrange="tsrange",at.tstzrange="tstzrange";const ct=(e,t,s={})=>{var i;const n=null!==(i=s.skipTypes)&&void 0!==i?i:[];return Object.keys(t).reduce((s,i)=>(s[i]=dt(i,e,t,n),s),{})},dt=(e,t,s,i)=>{const n=t.find(t=>t.name===e),r=null==n?void 0:n.type,a=s[e];return r&&!i.includes(r)?ut(r,a):ht(a)},ut=(e,t)=>{if("_"===e.charAt(0)){const s=e.slice(1,e.length);return gt(t,s)}switch(e){case rt.bool:return ft(t);case rt.float4:case rt.float8:case rt.int2:case rt.int4:case rt.int8:case rt.numeric:case rt.oid:return mt(t);case rt.json:case rt.jsonb:return pt(t);case rt.timestamp:return vt(t);case rt.abstime:case rt.date:case rt.daterange:case rt.int4range:case rt.int8range:case rt.money:case rt.reltime:case rt.text:case rt.time:case rt.timestamptz:case rt.timetz:case rt.tsrange:case rt.tstzrange:default:return ht(t)}},ht=e=>e,ft=e=>{switch(e){case"t":return!0;case"f":return!1;default:return e}},mt=e=>{if("string"==typeof e){const t=parseFloat(e);if(!Number.isNaN(t))return t}return e},pt=e=>{if("string"==typeof e)try{return JSON.parse(e)}catch(t){return e}return e},gt=(e,t)=>{if("string"!=typeof e)return e;const s=e.length-1,i=e[s];if("{"===e[0]&&"}"===i){let i;const r=e.slice(1,s);try{i=JSON.parse("["+r+"]")}catch(n){i=r?r.split(","):[]}return i.map(e=>ut(t,e))}return e},vt=e=>"string"==typeof e?e.replace(" ","T"):e,yt=e=>{let t=e;return t=t.replace(/^ws/i,"http"),t=t.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),t.replace(/\/+$/,"")+"/api/broadcast"};class bt{constructor(e,t,s={},i=1e4){this.channel=e,this.event=t,this.payload=s,this.timeout=i,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var s;return this._hasReceived(e)&&t(null===(s=this.receivedResp)||void 0===s?void 0:s.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);this.channel._on(this.refEvent,{},e=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=e,this._matchReceive(e)}),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(t=>t.status===e).forEach(e=>e.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var xt,wt,St,kt,_t,Ct,Nt,Tt;(wt=xt||(xt={})).SYNC="sync",wt.JOIN="join",wt.LEAVE="leave";class At{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.enabled=!1,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const s=(null==t?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(s.state,{},e=>{const{onJoin:t,onLeave:s,onSync:i}=this.caller;this.joinRef=this.channel._joinRef(),this.state=At.syncState(this.state,e,t,s),this.pendingDiffs.forEach(e=>{this.state=At.syncDiff(this.state,e,t,s)}),this.pendingDiffs=[],i()}),this.channel._on(s.diff,{},e=>{const{onJoin:t,onLeave:s,onSync:i}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(e):(this.state=At.syncDiff(this.state,e,t,s),i())}),this.onJoin((e,t,s)=>{this.channel._trigger("presence",{event:"join",key:e,currentPresences:t,newPresences:s})}),this.onLeave((e,t,s)=>{this.channel._trigger("presence",{event:"leave",key:e,currentPresences:t,leftPresences:s})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,s,i){const n=this.cloneDeep(e),r=this.transformState(t),a={},o={};return this.map(n,(e,t)=>{r[e]||(o[e]=t)}),this.map(r,(e,t)=>{const s=n[e];if(s){const i=t.map(e=>e.presence_ref),n=s.map(e=>e.presence_ref),r=t.filter(e=>n.indexOf(e.presence_ref)<0),l=s.filter(e=>i.indexOf(e.presence_ref)<0);r.length>0&&(a[e]=r),l.length>0&&(o[e]=l)}else a[e]=t}),this.syncDiff(n,{joins:a,leaves:o},s,i)}static syncDiff(e,t,s,i){const{joins:n,leaves:r}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return s||(s=()=>{}),i||(i=()=>{}),this.map(n,(t,i)=>{var n;const r=null!==(n=e[t])&&void 0!==n?n:[];if(e[t]=this.cloneDeep(i),r.length>0){const s=e[t].map(e=>e.presence_ref),i=r.filter(e=>s.indexOf(e.presence_ref)<0);e[t].unshift(...i)}s(t,r,i)}),this.map(r,(t,s)=>{let n=e[t];if(!n)return;const r=s.map(e=>e.presence_ref);n=n.filter(e=>r.indexOf(e.presence_ref)<0),e[t]=n,i(t,n,s),0===n.length&&delete e[t]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(s=>t(s,e[s]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,s)=>{const i=e[s];return t[s]="metas"in i?i.metas.map(e=>(e.presence_ref=e.phx_ref,delete e.phx_ref,delete e.phx_ref_prev,e)):i,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}(kt=St||(St={})).ALL="*",kt.INSERT="INSERT",kt.UPDATE="UPDATE",kt.DELETE="DELETE",(Ct=_t||(_t={})).BROADCAST="broadcast",Ct.PRESENCE="presence",Ct.POSTGRES_CHANGES="postgres_changes",Ct.SYSTEM="system",(Tt=Nt||(Nt={})).SUBSCRIBED="SUBSCRIBED",Tt.TIMED_OUT="TIMED_OUT",Tt.CLOSED="CLOSED",Tt.CHANNEL_ERROR="CHANNEL_ERROR";class Et{constructor(e,t={config:{}},s){this.topic=e,this.params=t,this.socket=s,this.bindings={},this.state=Qe.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:"",enabled:!1},private:!1},t.config),this.timeout=this.socket.timeout,this.joinPush=new bt(this,et.join,this.params,this.timeout),this.rejoinTimer=new lt(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=Qe.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(e=>e.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=Qe.closed,this.socket._remove(this)}),this._onError(e=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,e),this.state=Qe.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=Qe.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("error",e=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,e),this.state=Qe.errored,this.rejoinTimer.scheduleTimeout())}),this._on(et.reply,{},(e,t)=>{this._trigger(this._replyEventName(t),e)}),this.presence=new At(this),this.broadcastEndpointURL=yt(this.socket.endPoint),this.private=this.params.config.private||!1}subscribe(e,t=this.timeout){var s,i,n;if(this.socket.isConnected()||this.socket.connect(),this.state==Qe.closed){const{config:{broadcast:r,presence:a,private:o}}=this.params,l=null!==(i=null===(s=this.bindings.postgres_changes)||void 0===s?void 0:s.map(e=>e.filter))&&void 0!==i?i:[],c=!!this.bindings[_t.PRESENCE]&&this.bindings[_t.PRESENCE].length>0||!0===(null===(n=this.params.config.presence)||void 0===n?void 0:n.enabled),d={},u={broadcast:r,presence:Object.assign(Object.assign({},a),{enabled:c}),postgres_changes:l,private:o};this.socket.accessTokenValue&&(d.access_token=this.socket.accessTokenValue),this._onError(t=>null==e?void 0:e(Nt.CHANNEL_ERROR,t)),this._onClose(()=>null==e?void 0:e(Nt.CLOSED)),this.updateJoinPayload(Object.assign({config:u},d)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",t=>p(this,[t],function*({postgres_changes:t}){var s;if(this.socket.setAuth(),void 0!==t){const i=this.bindings.postgres_changes,n=null!==(s=null==i?void 0:i.length)&&void 0!==s?s:0,r=[];for(let s=0;s<n;s++){const n=i[s],{filter:{event:a,schema:o,table:l,filter:c}}=n,d=t&&t[s];if(!d||d.event!==a||d.schema!==o||d.table!==l||d.filter!==c)return this.unsubscribe(),this.state=Qe.errored,void(null==e||e(Nt.CHANNEL_ERROR,new Error("mismatch between server and client bindings for postgres changes")));r.push(Object.assign(Object.assign({},n),{id:d.id}))}return this.bindings.postgres_changes=r,void(e&&e(Nt.SUBSCRIBED))}null==e||e(Nt.SUBSCRIBED)})).receive("error",t=>{this.state=Qe.errored,null==e||e(Nt.CHANNEL_ERROR,new Error(JSON.stringify(Object.values(t).join(", ")||"error")))}).receive("timeout",()=>{null==e||e(Nt.TIMED_OUT)})}return this}presenceState(){return this.presence.state}track(e){return p(this,arguments,function*(e,t={}){return yield this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)})}untrack(){return p(this,arguments,function*(e={}){return yield this.send({type:"presence",event:"untrack"},e)})}on(e,t,s){return this.state===Qe.joined&&e===_t.PRESENCE&&(this.socket.log("channel",`resubscribe to ${this.topic} due to change in presence callbacks on joined channel`),this.unsubscribe().then(()=>this.subscribe())),this._on(e,t,s)}send(e){return p(this,arguments,function*(e,t={}){var s,i;if(this._canPush()||"broadcast"!==e.type)return new Promise(s=>{var i,n,r;const a=this._push(e.type,e,t.timeout||this.timeout);"broadcast"!==e.type||(null===(r=null===(n=null===(i=this.params)||void 0===i?void 0:i.config)||void 0===n?void 0:n.broadcast)||void 0===r?void 0:r.ack)||s("ok"),a.receive("ok",()=>s("ok")),a.receive("error",()=>s("error")),a.receive("timeout",()=>s("timed out"))});{const{event:r,payload:a}=e,o={method:"POST",headers:{Authorization:this.socket.accessTokenValue?`Bearer ${this.socket.accessTokenValue}`:"",apikey:this.socket.apiKey?this.socket.apiKey:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:r,payload:a,private:this.private}]})};try{const e=yield this._fetchWithTimeout(this.broadcastEndpointURL,o,null!==(s=t.timeout)&&void 0!==s?s:this.timeout);return yield null===(i=e.body)||void 0===i?void 0:i.cancel(),e.ok?"ok":"error"}catch(n){return"AbortError"===n.name?"timed out":"error"}}})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=Qe.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(et.close,"leave",this._joinRef())};this.joinPush.destroy();let s=null;return new Promise(i=>{s=new bt(this,et.leave,{},e),s.receive("ok",()=>{t(),i("ok")}).receive("timeout",()=>{t(),i("timed out")}).receive("error",()=>{i("error")}),s.send(),this._canPush()||s.trigger("ok",{})}).finally(()=>{null==s||s.destroy()})}teardown(){this.pushBuffer.forEach(e=>e.destroy()),this.pushBuffer=[],this.rejoinTimer.reset(),this.joinPush.destroy(),this.state=Qe.closed,this.bindings={}}_fetchWithTimeout(e,t,s){return p(this,null,function*(){const i=new AbortController,n=setTimeout(()=>i.abort(),s),r=yield this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:i.signal}));return clearTimeout(n),r})}_push(e,t,s=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let i=new bt(this,e,t,s);return this._canPush()?i.send():this._addToPushBuffer(i),i}_addToPushBuffer(e){if(e.startTimeout(),this.pushBuffer.push(e),this.pushBuffer.length>100){const e=this.pushBuffer.shift();e&&(e.destroy(),this.socket.log("channel",`discarded push due to buffer overflow: ${e.event}`,e.payload))}}_onMessage(e,t,s){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,s){var i,n;const r=e.toLocaleLowerCase(),{close:a,error:o,leave:l,join:c}=et;if(s&&[a,o,l,c].indexOf(r)>=0&&s!==this._joinRef())return;let d=this._onMessage(r,t,s);if(t&&!d)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(r)?null===(i=this.bindings.postgres_changes)||void 0===i||i.filter(e=>{var t,s,i;return"*"===(null===(t=e.filter)||void 0===t?void 0:t.event)||(null===(i=null===(s=e.filter)||void 0===s?void 0:s.event)||void 0===i?void 0:i.toLocaleLowerCase())===r}).map(e=>e.callback(d,s)):null===(n=this.bindings[r])||void 0===n||n.filter(e=>{var s,i,n,a,o,l;if(["broadcast","presence","postgres_changes"].includes(r)){if("id"in e){const r=e.id,a=null===(s=e.filter)||void 0===s?void 0:s.event;return r&&(null===(i=t.ids)||void 0===i?void 0:i.includes(r))&&("*"===a||(null==a?void 0:a.toLocaleLowerCase())===(null===(n=t.data)||void 0===n?void 0:n.type.toLocaleLowerCase()))}{const s=null===(o=null===(a=null==e?void 0:e.filter)||void 0===a?void 0:a.event)||void 0===o?void 0:o.toLocaleLowerCase();return"*"===s||s===(null===(l=null==t?void 0:t.event)||void 0===l?void 0:l.toLocaleLowerCase())}}return e.type.toLocaleLowerCase()===r}).map(e=>{if("object"==typeof d&&"ids"in d){const e=d.data,{schema:t,table:s,commit_timestamp:i,type:n,errors:r}=e,a={schema:t,table:s,commit_timestamp:i,eventType:n,new:{},old:{},errors:r};d=Object.assign(Object.assign({},a),this._getPayloadRecords(e))}e.callback(d,s)})}_isClosed(){return this.state===Qe.closed}_isJoined(){return this.state===Qe.joined}_isJoining(){return this.state===Qe.joining}_isLeaving(){return this.state===Qe.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,s){const i=e.toLocaleLowerCase(),n={type:i,filter:t,callback:s};return this.bindings[i]?this.bindings[i].push(n):this.bindings[i]=[n],this}_off(e,t){const s=e.toLocaleLowerCase();return this.bindings[s]&&(this.bindings[s]=this.bindings[s].filter(e=>{var i;return!((null===(i=e.type)||void 0===i?void 0:i.toLocaleLowerCase())===s&&Et.isEqual(e.filter,t))})),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const s in e)if(e[s]!==t[s])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(et.close,{},e)}_onError(e){this._on(et.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=Qe.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return"INSERT"!==e.type&&"UPDATE"!==e.type||(t.new=ct(e.columns,e.record)),"UPDATE"!==e.type&&"DELETE"!==e.type||(t.old=ct(e.columns,e.old_record)),t}}const jt=()=>{},Pt=25e3,It=10,Lt=100,Rt=[1e3,2e3,5e3,1e4];class Ot{constructor(e,t){var s;if(this.accessTokenValue=null,this.apiKey=null,this.channels=new Array,this.endPoint="",this.httpEndpoint="",this.headers={},this.params={},this.timeout=Ke,this.transport=null,this.heartbeatIntervalMs=Pt,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.heartbeatCallback=jt,this.ref=0,this.reconnectTimer=null,this.logger=jt,this.conn=null,this.sendBuffer=[],this.serializer=new ot,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this.accessToken=null,this._connectionState="disconnected",this._wasManualDisconnect=!1,this._authPromise=null,this._resolveFetch=e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>g(()=>p(this,null,function*(){const{default:e}=yield Promise.resolve().then(()=>ge);return{default:e}}),void 0).then(({default:t})=>t(...e)).catch(e=>{throw new Error(`Failed to load @supabase/node-fetch: ${e.message}. This is required for HTTP requests in Node.js environments without native fetch.`)}):fetch),(...e)=>t(...e)},!(null===(s=null==t?void 0:t.params)||void 0===s?void 0:s.apikey))throw new Error("API key is required to connect to Realtime");this.apiKey=t.params.apikey,this.endPoint=`${e}/${st.websocket}`,this.httpEndpoint=yt(e),this._initializeOptions(t),this._setupReconnectionTimer(),this.fetch=this._resolveFetch(null==t?void 0:t.fetch)}connect(){if(!(this.isConnecting()||this.isDisconnecting()||null!==this.conn&&this.isConnected())){if(this._setConnectionState("connecting"),this._setAuthSafely("connect"),this.transport)this.conn=new this.transport(this.endpointURL());else try{this.conn=We.createWebSocket(this.endpointURL())}catch(e){this._setConnectionState("disconnected");const t=e.message;if(t.includes("Node.js"))throw new Error(`${t}\n\nTo use Realtime in Node.js, you need to provide a WebSocket implementation:\n\nOption 1: Use Node.js 22+ which has native WebSocket support\nOption 2: Install and provide the "ws" package:\n\n  npm install ws\n\n  import ws from "ws"\n  const client = new RealtimeClient(url, {\n    ...options,\n    transport: ws\n  })`);throw new Error(`WebSocket not available: ${t}`)}this._setupConnectionHandlers()}}endpointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:"1.0.0"}))}disconnect(e,t){if(!this.isDisconnecting())if(this._setConnectionState("disconnecting",!0),this.conn){const s=setTimeout(()=>{this._setConnectionState("disconnected")},100);this.conn.onclose=()=>{clearTimeout(s),this._setConnectionState("disconnected")},e?this.conn.close(e,null!=t?t:""):this.conn.close(),this._teardownConnection()}else this._setConnectionState("disconnected")}getChannels(){return this.channels}removeChannel(e){return p(this,null,function*(){const t=yield e.unsubscribe();return 0===this.channels.length&&this.disconnect(),t})}removeAllChannels(){return p(this,null,function*(){const e=yield Promise.all(this.channels.map(e=>e.unsubscribe()));return this.channels=[],this.disconnect(),e})}log(e,t,s){this.logger(e,t,s)}connectionState(){switch(this.conn&&this.conn.readyState){case Ye.connecting:return it.Connecting;case Ye.open:return it.Open;case Ye.closing:return it.Closing;default:return it.Closed}}isConnected(){return this.connectionState()===it.Open}isConnecting(){return"connecting"===this._connectionState}isDisconnecting(){return"disconnecting"===this._connectionState}channel(e,t={config:{}}){const s=`realtime:${e}`,i=this.getChannels().find(e=>e.topic===s);if(i)return i;{const s=new Et(`realtime:${e}`,t,this);return this.channels.push(s),s}}push(e){const{topic:t,event:s,payload:i,ref:n}=e,r=()=>{this.encode(e,e=>{var t;null===(t=this.conn)||void 0===t||t.send(e)})};this.log("push",`${t} ${s} (${n})`,i),this.isConnected()?r():this.sendBuffer.push(r)}setAuth(e=null){return p(this,null,function*(){this._authPromise=this._performAuth(e);try{yield this._authPromise}finally{this._authPromise=null}})}sendHeartbeat(){return p(this,null,function*(){var e;if(this.isConnected()){if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection");try{this.heartbeatCallback("timeout")}catch(Tx){this.log("error","error in heartbeat callback",Tx)}return this._wasManualDisconnect=!1,null===(e=this.conn)||void 0===e||e.close(1e3,"heartbeat timeout"),void setTimeout(()=>{var e;this.isConnected()||null===(e=this.reconnectTimer)||void 0===e||e.scheduleTimeout()},Lt)}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef});try{this.heartbeatCallback("sent")}catch(Tx){this.log("error","error in heartbeat callback",Tx)}this._setAuthSafely("heartbeat")}else try{this.heartbeatCallback("disconnected")}catch(Tx){this.log("error","error in heartbeat callback",Tx)}})}onHeartbeat(e){this.heartbeatCallback=e}flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(t=>t.topic===e&&(t._isJoined()||t._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t.topic!==e.topic)}_onConnMessage(e){this.decode(e.data,e=>{if("phoenix"===e.topic&&"phx_reply"===e.event)try{this.heartbeatCallback("ok"===e.payload.status?"ok":"error")}catch(Tx){this.log("error","error in heartbeat callback",Tx)}e.ref&&e.ref===this.pendingHeartbeatRef&&(this.pendingHeartbeatRef=null);const{topic:t,event:s,payload:i,ref:n}=e,r=n?`(${n})`:"",a=i.status||"";this.log("receive",`${a} ${t} ${s} ${r}`.trim(),i),this.channels.filter(e=>e._isMember(t)).forEach(e=>e._trigger(s,i,n)),this._triggerStateCallbacks("message",e)})}_clearTimer(e){var t;"heartbeat"===e&&this.heartbeatTimer?(clearInterval(this.heartbeatTimer),this.heartbeatTimer=void 0):"reconnect"===e&&(null===(t=this.reconnectTimer)||void 0===t||t.reset())}_clearAllTimers(){this._clearTimer("heartbeat"),this._clearTimer("reconnect")}_setupConnectionHandlers(){this.conn&&("binaryType"in this.conn&&(this.conn.binaryType="arraybuffer"),this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_teardownConnection(){this.conn&&(this.conn.onopen=null,this.conn.onerror=null,this.conn.onmessage=null,this.conn.onclose=null,this.conn=null),this._clearAllTimers(),this.channels.forEach(e=>e.teardown())}_onConnOpen(){this._setConnectionState("connected"),this.log("transport",`connected to ${this.endpointURL()}`),this.flushSendBuffer(),this._clearTimer("reconnect"),this.worker?this.workerRef||this._startWorkerHeartbeat():this._startHeartbeat(),this._triggerStateCallbacks("open")}_startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this.sendHeartbeat(),this.heartbeatIntervalMs)}_startWorkerHeartbeat(){this.workerUrl?this.log("worker",`starting worker for from ${this.workerUrl}`):this.log("worker","starting default worker");const e=this._workerObjectUrl(this.workerUrl);this.workerRef=new Worker(e),this.workerRef.onerror=e=>{this.log("worker","worker error",e.message),this.workerRef.terminate()},this.workerRef.onmessage=e=>{"keepAlive"===e.data.event&&this.sendHeartbeat()},this.workerRef.postMessage({event:"start",interval:this.heartbeatIntervalMs})}_onConnClose(e){var t;this._setConnectionState("disconnected"),this.log("transport","close",e),this._triggerChanError(),this._clearTimer("heartbeat"),this._wasManualDisconnect||null===(t=this.reconnectTimer)||void 0===t||t.scheduleTimeout(),this._triggerStateCallbacks("close",e)}_onConnError(e){this._setConnectionState("disconnected"),this.log("transport",`${e}`),this._triggerChanError(),this._triggerStateCallbacks("error",e)}_triggerChanError(){this.channels.forEach(e=>e._trigger(et.error))}_appendParams(e,t){if(0===Object.keys(t).length)return e;const s=e.match(/\?/)?"&":"?";return`${e}${s}${new URLSearchParams(t)}`}_workerObjectUrl(e){let t;if(e)t=e;else{const e=new Blob(['\n  addEventListener("message", (e) => {\n    if (e.data.event === "start") {\n      setInterval(() => postMessage({ event: "keepAlive" }), e.data.interval);\n    }\n  });'],{type:"application/javascript"});t=URL.createObjectURL(e)}return t}_setConnectionState(e,t=!1){this._connectionState=e,"connecting"===e?this._wasManualDisconnect=!1:"disconnecting"===e&&(this._wasManualDisconnect=t)}_performAuth(e=null){return p(this,null,function*(){let t;t=e||(this.accessToken?yield this.accessToken():this.accessTokenValue),this.accessTokenValue!=t&&(this.accessTokenValue=t,this.channels.forEach(e=>{const s={access_token:t,version:"realtime-js/2.15.5"};t&&e.updateJoinPayload(s),e.joinedOnce&&e._isJoined()&&e._push(et.access_token,{access_token:t})}))})}_waitForAuthIfNeeded(){return p(this,null,function*(){this._authPromise&&(yield this._authPromise)})}_setAuthSafely(e="general"){this.setAuth().catch(t=>{this.log("error",`error setting auth in ${e}`,t)})}_triggerStateCallbacks(e,t){try{this.stateChangeCallbacks[e].forEach(s=>{try{s(t)}catch(Tx){this.log("error",`error in ${e} callback`,Tx)}})}catch(Tx){this.log("error",`error triggering ${e} callbacks`,Tx)}}_setupReconnectionTimer(){this.reconnectTimer=new lt(()=>p(this,null,function*(){setTimeout(()=>p(this,null,function*(){yield this._waitForAuthIfNeeded(),this.isConnected()||this.connect()}),It)}),this.reconnectAfterMs)}_initializeOptions(e){var t,s,i,n,r,a,o,l,c;if(this.transport=null!==(t=null==e?void 0:e.transport)&&void 0!==t?t:null,this.timeout=null!==(s=null==e?void 0:e.timeout)&&void 0!==s?s:Ke,this.heartbeatIntervalMs=null!==(i=null==e?void 0:e.heartbeatIntervalMs)&&void 0!==i?i:Pt,this.worker=null!==(n=null==e?void 0:e.worker)&&void 0!==n&&n,this.accessToken=null!==(r=null==e?void 0:e.accessToken)&&void 0!==r?r:null,this.heartbeatCallback=null!==(a=null==e?void 0:e.heartbeatCallback)&&void 0!==a?a:jt,(null==e?void 0:e.params)&&(this.params=e.params),(null==e?void 0:e.logger)&&(this.logger=e.logger),((null==e?void 0:e.logLevel)||(null==e?void 0:e.log_level))&&(this.logLevel=e.logLevel||e.log_level,this.params=Object.assign(Object.assign({},this.params),{log_level:this.logLevel})),this.reconnectAfterMs=null!==(o=null==e?void 0:e.reconnectAfterMs)&&void 0!==o?o:e=>Rt[e-1]||1e4,this.encode=null!==(l=null==e?void 0:e.encode)&&void 0!==l?l:(e,t)=>t(JSON.stringify(e)),this.decode=null!==(c=null==e?void 0:e.decode)&&void 0!==c?c:this.serializer.decode.bind(this.serializer),this.worker){if("undefined"!=typeof window&&!window.Worker)throw new Error("Web Worker is not supported");this.workerUrl=null==e?void 0:e.workerUrl}}}class Dt extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function Mt(e){return"object"==typeof e&&null!==e&&"__isStorageError"in e}class Ut extends Dt{constructor(e,t,s){super(e),this.name="StorageApiError",this.status=t,this.statusCode=s}toJSON(){return{name:this.name,message:this.message,status:this.status,statusCode:this.statusCode}}}class Ft extends Dt{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}var Bt=function(e,t,s,i){return new(s||(s=Promise))(function(n,r){function a(e){try{l(i.next(e))}catch(Tx){r(Tx)}}function o(e){try{l(i.throw(e))}catch(Tx){r(Tx)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(a,o)}l((i=i.apply(e,t||[])).next())})};const qt=e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>g(()=>p(void 0,null,function*(){const{default:e}=yield Promise.resolve().then(()=>ge);return{default:e}}),void 0).then(({default:t})=>t(...e)):fetch),(...e)=>t(...e)},$t=e=>{if(Array.isArray(e))return e.map(e=>$t(e));if("function"==typeof e||e!==Object(e))return e;const t={};return Object.entries(e).forEach(([e,s])=>{const i=e.replace(/([-_][a-z])/gi,e=>e.toUpperCase().replace(/[-_]/g,""));t[i]=$t(s)}),t};var zt=function(e,t,s,i){return new(s||(s=Promise))(function(n,r){function a(e){try{l(i.next(e))}catch(Tx){r(Tx)}}function o(e){try{l(i.throw(e))}catch(Tx){r(Tx)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(a,o)}l((i=i.apply(e,t||[])).next())})};const Ht=e=>e.msg||e.message||e.error_description||e.error||JSON.stringify(e),Vt=(e,t,s)=>zt(void 0,void 0,void 0,function*(){const i=yield Bt(void 0,void 0,void 0,function*(){return"undefined"==typeof Response?(yield g(()=>Promise.resolve().then(()=>ge),void 0)).Response:Response});e instanceof i&&!(null==s?void 0:s.noResolveJson)?e.json().then(s=>{const i=e.status||500,n=(null==s?void 0:s.statusCode)||i+"";t(new Ut(Ht(s),i,n))}).catch(e=>{t(new Ft(Ht(e),e))}):t(new Ft(Ht(e),e))}),Gt=(e,t,s,i)=>{const n={method:e,headers:(null==t?void 0:t.headers)||{}};return"GET"!==e&&i?((e=>{if("object"!=typeof e||null===e)return!1;const t=Object.getPrototypeOf(e);return!(null!==t&&t!==Object.prototype&&null!==Object.getPrototypeOf(t)||Symbol.toStringTag in e||Symbol.iterator in e)})(i)?(n.headers=Object.assign({"Content-Type":"application/json"},null==t?void 0:t.headers),n.body=JSON.stringify(i)):n.body=i,(null==t?void 0:t.duplex)&&(n.duplex=t.duplex),Object.assign(Object.assign({},n),s)):n};function Jt(e,t,s,i,n,r){return zt(this,void 0,void 0,function*(){return new Promise((a,o)=>{e(s,Gt(t,i,n,r)).then(e=>{if(!e.ok)throw e;return(null==i?void 0:i.noResolveJson)?e:e.json()}).then(e=>a(e)).catch(e=>Vt(e,o,i))})})}function Wt(e,t,s,i){return zt(this,void 0,void 0,function*(){return Jt(e,"GET",t,s,i)})}function Kt(e,t,s,i,n){return zt(this,void 0,void 0,function*(){return Jt(e,"POST",t,i,n,s)})}function Yt(e,t,s,i,n){return zt(this,void 0,void 0,function*(){return Jt(e,"PUT",t,i,n,s)})}function Xt(e,t,s,i,n){return zt(this,void 0,void 0,function*(){return Jt(e,"DELETE",t,i,n,s)})}var Qt=function(e,t,s,i){return new(s||(s=Promise))(function(n,r){function a(e){try{l(i.next(e))}catch(Tx){r(Tx)}}function o(e){try{l(i.throw(e))}catch(Tx){r(Tx)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(a,o)}l((i=i.apply(e,t||[])).next())})};const Zt={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},es={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class ts{constructor(e,t={},s,i){this.shouldThrowOnError=!1,this.url=e,this.headers=t,this.bucketId=s,this.fetch=qt(i)}throwOnError(){return this.shouldThrowOnError=!0,this}uploadOrUpdate(e,t,s,i){return Qt(this,void 0,void 0,function*(){try{let n;const r=Object.assign(Object.assign({},es),i);let a=Object.assign(Object.assign({},this.headers),"POST"===e&&{"x-upsert":String(r.upsert)});const o=r.metadata;"undefined"!=typeof Blob&&s instanceof Blob?(n=new FormData,n.append("cacheControl",r.cacheControl),o&&n.append("metadata",this.encodeMetadata(o)),n.append("",s)):"undefined"!=typeof FormData&&s instanceof FormData?(n=s,n.append("cacheControl",r.cacheControl),o&&n.append("metadata",this.encodeMetadata(o))):(n=s,a["cache-control"]=`max-age=${r.cacheControl}`,a["content-type"]=r.contentType,o&&(a["x-metadata"]=this.toBase64(this.encodeMetadata(o)))),(null==i?void 0:i.headers)&&(a=Object.assign(Object.assign({},a),i.headers));const l=this._removeEmptyFolders(t),c=this._getFinalPath(l),d=yield("PUT"==e?Yt:Kt)(this.fetch,`${this.url}/object/${c}`,n,Object.assign({headers:a},(null==r?void 0:r.duplex)?{duplex:r.duplex}:{}));return{data:{path:l,id:d.Id,fullPath:d.Key},error:null}}catch(n){if(this.shouldThrowOnError)throw n;if(Mt(n))return{data:null,error:n};throw n}})}upload(e,t,s){return Qt(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,s)})}uploadToSignedUrl(e,t,s,i){return Qt(this,void 0,void 0,function*(){const n=this._removeEmptyFolders(e),r=this._getFinalPath(n),a=new URL(this.url+`/object/upload/sign/${r}`);a.searchParams.set("token",t);try{let e;const t=Object.assign({upsert:es.upsert},i),r=Object.assign(Object.assign({},this.headers),{"x-upsert":String(t.upsert)});"undefined"!=typeof Blob&&s instanceof Blob?(e=new FormData,e.append("cacheControl",t.cacheControl),e.append("",s)):"undefined"!=typeof FormData&&s instanceof FormData?(e=s,e.append("cacheControl",t.cacheControl)):(e=s,r["cache-control"]=`max-age=${t.cacheControl}`,r["content-type"]=t.contentType);return{data:{path:n,fullPath:(yield Yt(this.fetch,a.toString(),e,{headers:r})).Key},error:null}}catch(o){if(this.shouldThrowOnError)throw o;if(Mt(o))return{data:null,error:o};throw o}})}createSignedUploadUrl(e,t){return Qt(this,void 0,void 0,function*(){try{let s=this._getFinalPath(e);const i=Object.assign({},this.headers);(null==t?void 0:t.upsert)&&(i["x-upsert"]="true");const n=yield Kt(this.fetch,`${this.url}/object/upload/sign/${s}`,{},{headers:i}),r=new URL(this.url+n.url),a=r.searchParams.get("token");if(!a)throw new Dt("No token returned by API");return{data:{signedUrl:r.toString(),path:e,token:a},error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(Mt(s))return{data:null,error:s};throw s}})}update(e,t,s){return Qt(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,s)})}move(e,t,s){return Qt(this,void 0,void 0,function*(){try{return{data:yield Kt(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:null==s?void 0:s.destinationBucket},{headers:this.headers}),error:null}}catch(i){if(this.shouldThrowOnError)throw i;if(Mt(i))return{data:null,error:i};throw i}})}copy(e,t,s){return Qt(this,void 0,void 0,function*(){try{return{data:{path:(yield Kt(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t,destinationBucket:null==s?void 0:s.destinationBucket},{headers:this.headers})).Key},error:null}}catch(i){if(this.shouldThrowOnError)throw i;if(Mt(i))return{data:null,error:i};throw i}})}createSignedUrl(e,t,s){return Qt(this,void 0,void 0,function*(){try{let i=this._getFinalPath(e),n=yield Kt(this.fetch,`${this.url}/object/sign/${i}`,Object.assign({expiresIn:t},(null==s?void 0:s.transform)?{transform:s.transform}:{}),{headers:this.headers});const r=(null==s?void 0:s.download)?`&download=${!0===s.download?"":s.download}`:"";return n={signedUrl:encodeURI(`${this.url}${n.signedURL}${r}`)},{data:n,error:null}}catch(i){if(this.shouldThrowOnError)throw i;if(Mt(i))return{data:null,error:i};throw i}})}createSignedUrls(e,t,s){return Qt(this,void 0,void 0,function*(){try{const i=yield Kt(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),n=(null==s?void 0:s.download)?`&download=${!0===s.download?"":s.download}`:"";return{data:i.map(e=>Object.assign(Object.assign({},e),{signedUrl:e.signedURL?encodeURI(`${this.url}${e.signedURL}${n}`):null})),error:null}}catch(i){if(this.shouldThrowOnError)throw i;if(Mt(i))return{data:null,error:i};throw i}})}download(e,t){return Qt(this,void 0,void 0,function*(){const s=void 0!==(null==t?void 0:t.transform)?"render/image/authenticated":"object",i=this.transformOptsToQueryString((null==t?void 0:t.transform)||{}),n=i?`?${i}`:"";try{const t=this._getFinalPath(e),i=yield Wt(this.fetch,`${this.url}/${s}/${t}${n}`,{headers:this.headers,noResolveJson:!0});return{data:yield i.blob(),error:null}}catch(r){if(this.shouldThrowOnError)throw r;if(Mt(r))return{data:null,error:r};throw r}})}info(e){return Qt(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{const e=yield Wt(this.fetch,`${this.url}/object/info/${t}`,{headers:this.headers});return{data:$t(e),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(Mt(s))return{data:null,error:s};throw s}})}exists(e){return Qt(this,void 0,void 0,function*(){const t=this._getFinalPath(e);try{return yield function(e,t,s,i){return zt(this,void 0,void 0,function*(){return Jt(e,"HEAD",t,Object.assign(Object.assign({},s),{noResolveJson:!0}),i)})}(this.fetch,`${this.url}/object/${t}`,{headers:this.headers}),{data:!0,error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(Mt(s)&&s instanceof Ft){const e=s.originalError;if([400,404].includes(null==e?void 0:e.status))return{data:!1,error:s}}throw s}})}getPublicUrl(e,t){const s=this._getFinalPath(e),i=[],n=(null==t?void 0:t.download)?`download=${!0===t.download?"":t.download}`:"";""!==n&&i.push(n);const r=void 0!==(null==t?void 0:t.transform)?"render/image":"object",a=this.transformOptsToQueryString((null==t?void 0:t.transform)||{});""!==a&&i.push(a);let o=i.join("&");return""!==o&&(o=`?${o}`),{data:{publicUrl:encodeURI(`${this.url}/${r}/public/${s}${o}`)}}}remove(e){return Qt(this,void 0,void 0,function*(){try{return{data:yield Xt(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Mt(t))return{data:null,error:t};throw t}})}list(e,t,s){return Qt(this,void 0,void 0,function*(){try{const i=Object.assign(Object.assign(Object.assign({},Zt),t),{prefix:e||""});return{data:yield Kt(this.fetch,`${this.url}/object/list/${this.bucketId}`,i,{headers:this.headers},s),error:null}}catch(i){if(this.shouldThrowOnError)throw i;if(Mt(i))return{data:null,error:i};throw i}})}listV2(e,t){return Qt(this,void 0,void 0,function*(){try{const s=Object.assign({},e);return{data:yield Kt(this.fetch,`${this.url}/object/list-v2/${this.bucketId}`,s,{headers:this.headers},t),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(Mt(s))return{data:null,error:s};throw s}})}encodeMetadata(e){return JSON.stringify(e)}toBase64(e){return"undefined"!=typeof Buffer?Buffer.from(e).toString("base64"):btoa(e)}_getFinalPath(e){return`${this.bucketId}/${e.replace(/^\/+/,"")}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const ss={"X-Client-Info":"storage-js/2.12.1"};var is=function(e,t,s,i){return new(s||(s=Promise))(function(n,r){function a(e){try{l(i.next(e))}catch(Tx){r(Tx)}}function o(e){try{l(i.throw(e))}catch(Tx){r(Tx)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(a,o)}l((i=i.apply(e,t||[])).next())})};class ns{constructor(e,t={},s,i){this.shouldThrowOnError=!1;const n=new URL(e);if(null==i?void 0:i.useNewHostname){/supabase\.(co|in|red)$/.test(n.hostname)&&!n.hostname.includes("storage.supabase.")&&(n.hostname=n.hostname.replace("supabase.","storage.supabase."))}this.url=n.href,this.headers=Object.assign(Object.assign({},ss),t),this.fetch=qt(s)}throwOnError(){return this.shouldThrowOnError=!0,this}listBuckets(){return is(this,void 0,void 0,function*(){try{return{data:yield Wt(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(this.shouldThrowOnError)throw e;if(Mt(e))return{data:null,error:e};throw e}})}getBucket(e){return is(this,void 0,void 0,function*(){try{return{data:yield Wt(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Mt(t))return{data:null,error:t};throw t}})}createBucket(e,t={public:!1}){return is(this,void 0,void 0,function*(){try{return{data:yield Kt(this.fetch,`${this.url}/bucket`,{id:e,name:e,type:t.type,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(Mt(s))return{data:null,error:s};throw s}})}updateBucket(e,t){return is(this,void 0,void 0,function*(){try{return{data:yield Yt(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(s){if(this.shouldThrowOnError)throw s;if(Mt(s))return{data:null,error:s};throw s}})}emptyBucket(e){return is(this,void 0,void 0,function*(){try{return{data:yield Kt(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Mt(t))return{data:null,error:t};throw t}})}deleteBucket(e){return is(this,void 0,void 0,function*(){try{return{data:yield Xt(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(this.shouldThrowOnError)throw t;if(Mt(t))return{data:null,error:t};throw t}})}}class rs extends ns{constructor(e,t={},s,i){super(e,t,s,i)}from(e){return new ts(this.url,this.headers,e,this.fetch)}}let as="";as="undefined"!=typeof Deno?"deno":"undefined"!=typeof document?"web":"undefined"!=typeof navigator&&"ReactNative"===navigator.product?"react-native":"node";const os={headers:{"X-Client-Info":`supabase-js-${as}/2.57.4`}},ls={schema:"public"},cs={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},ds={};var us=function(e,t,s,i){return new(s||(s=Promise))(function(n,r){function a(e){try{l(i.next(e))}catch(Tx){r(Tx)}}function o(e){try{l(i.throw(e))}catch(Tx){r(Tx)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(a,o)}l((i=i.apply(e,t||[])).next())})};const hs=(e,t,s)=>{const i=(e=>{let t;return t=e||("undefined"==typeof fetch?he:fetch),(...e)=>t(...e)})(s),n="undefined"==typeof Headers?fe:Headers;return(s,r)=>us(void 0,void 0,void 0,function*(){var a;const o=null!==(a=yield t())&&void 0!==a?a:e;let l=new n(null==r?void 0:r.headers);return l.has("apikey")||l.set("apikey",e),l.has("Authorization")||l.set("Authorization",`Bearer ${o}`),i(s,Object.assign(Object.assign({},r),{headers:l}))})};var fs=function(e,t,s,i){return new(s||(s=Promise))(function(n,r){function a(e){try{l(i.next(e))}catch(Tx){r(Tx)}}function o(e){try{l(i.throw(e))}catch(Tx){r(Tx)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(a,o)}l((i=i.apply(e,t||[])).next())})};const ms="2.71.1",ps=3e4,gs=9e4,vs={"X-Client-Info":`gotrue-js/${ms}`},ys="X-Supabase-Api-Version",bs={timestamp:Date.parse("2024-01-01T00:00:00.0Z"),name:"2024-01-01"},xs=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}$|[a-z0-9_-]{2}$)$/i;class ws extends Error{constructor(e,t,s){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t,this.code=s}}function Ss(e){return"object"==typeof e&&null!==e&&"__isAuthError"in e}class ks extends ws{constructor(e,t,s){super(e,t,s),this.name="AuthApiError",this.status=t,this.code=s}}class _s extends ws{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class Cs extends ws{constructor(e,t,s,i){super(e,s,i),this.name=t,this.status=s}}class Ns extends Cs{constructor(){super("Auth session missing!","AuthSessionMissingError",400,void 0)}}class Ts extends Cs{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500,void 0)}}class As extends Cs{constructor(e){super(e,"AuthInvalidCredentialsError",400,void 0)}}class Es extends Cs{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class js extends Cs{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500,void 0),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class Ps extends Cs{constructor(e,t){super(e,"AuthRetryableFetchError",t,void 0)}}function Is(e){return Ss(e)&&"AuthRetryableFetchError"===e.name}class Ls extends Cs{constructor(e,t,s){super(e,"AuthWeakPasswordError",t,"weak_password"),this.reasons=s}}class Rs extends Cs{constructor(e){super(e,"AuthInvalidJwtError",400,"invalid_jwt")}}const Os="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_".split(""),Ds=" \t\n\r=".split(""),Ms=(()=>{const e=new Array(128);for(let t=0;t<e.length;t+=1)e[t]=-1;for(let t=0;t<Ds.length;t+=1)e[Ds[t].charCodeAt(0)]=-2;for(let t=0;t<Os.length;t+=1)e[Os[t].charCodeAt(0)]=t;return e})();function Us(e,t,s){if(null!==e)for(t.queue=t.queue<<8|e,t.queuedBits+=8;t.queuedBits>=6;){const e=t.queue>>t.queuedBits-6&63;s(Os[e]),t.queuedBits-=6}else if(t.queuedBits>0)for(t.queue=t.queue<<6-t.queuedBits,t.queuedBits=6;t.queuedBits>=6;){const e=t.queue>>t.queuedBits-6&63;s(Os[e]),t.queuedBits-=6}}function Fs(e,t,s){const i=Ms[e];if(!(i>-1)){if(-2===i)return;throw new Error(`Invalid Base64-URL character "${String.fromCharCode(e)}"`)}for(t.queue=t.queue<<6|i,t.queuedBits+=6;t.queuedBits>=8;)s(t.queue>>t.queuedBits-8&255),t.queuedBits-=8}function Bs(e){const t=[],s=e=>{t.push(String.fromCodePoint(e))},i={utf8seq:0,codepoint:0},n={queue:0,queuedBits:0},r=e=>{!function(e,t,s){if(0===t.utf8seq){if(e<=127)return void s(e);for(let s=1;s<6;s+=1)if(!(e>>7-s&1)){t.utf8seq=s;break}if(2===t.utf8seq)t.codepoint=31&e;else if(3===t.utf8seq)t.codepoint=15&e;else{if(4!==t.utf8seq)throw new Error("Invalid UTF-8 sequence");t.codepoint=7&e}t.utf8seq-=1}else if(t.utf8seq>0){if(e<=127)throw new Error("Invalid UTF-8 sequence");t.codepoint=t.codepoint<<6|63&e,t.utf8seq-=1,0===t.utf8seq&&s(t.codepoint)}}(e,i,s)};for(let a=0;a<e.length;a+=1)Fs(e.charCodeAt(a),n,r);return t.join("")}function qs(e,t){if(!(e<=127)){if(e<=2047)return t(192|e>>6),void t(128|63&e);if(e<=65535)return t(224|e>>12),t(128|e>>6&63),void t(128|63&e);if(e<=1114111)return t(240|e>>18),t(128|e>>12&63),t(128|e>>6&63),void t(128|63&e);throw new Error(`Unrecognized Unicode codepoint: ${e.toString(16)}`)}t(e)}function $s(e){const t=[],s={queue:0,queuedBits:0},i=e=>{t.push(e)};for(let n=0;n<e.length;n+=1)Fs(e.charCodeAt(n),s,i);return new Uint8Array(t)}function zs(e){const t=[];return function(e,t){for(let s=0;s<e.length;s+=1){let i=e.charCodeAt(s);if(i>55295&&i<=56319){const t=1024*(i-55296)&65535;i=65536+(e.charCodeAt(s+1)-56320&65535|t),s+=1}qs(i,t)}}(e,e=>t.push(e)),new Uint8Array(t)}function Hs(e){const t=[],s={queue:0,queuedBits:0},i=e=>{t.push(e)};return e.forEach(e=>Us(e,s,i)),Us(null,s,i),t.join("")}const Vs=()=>"undefined"!=typeof window&&"undefined"!=typeof document,Gs={tested:!1,writable:!1},Js=()=>{if(!Vs())return!1;try{if("object"!=typeof globalThis.localStorage)return!1}catch(Tx){return!1}if(Gs.tested)return Gs.writable;const e=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(e,e),globalThis.localStorage.removeItem(e),Gs.tested=!0,Gs.writable=!0}catch(Tx){Gs.tested=!0,Gs.writable=!1}return Gs.writable};const Ws=e=>{let t;return t=e||("undefined"==typeof fetch?(...e)=>g(()=>p(void 0,null,function*(){const{default:e}=yield Promise.resolve().then(()=>ge);return{default:e}}),void 0).then(({default:t})=>t(...e)):fetch),(...e)=>t(...e)},Ks=(e,t,s)=>p(void 0,null,function*(){yield e.setItem(t,JSON.stringify(s))}),Ys=(e,t)=>p(void 0,null,function*(){const s=yield e.getItem(t);if(!s)return null;try{return JSON.parse(s)}catch(i){return s}}),Xs=(e,t)=>p(void 0,null,function*(){yield e.removeItem(t)});class Qs{constructor(){this.promise=new Qs.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}function Zs(e){const t=e.split(".");if(3!==t.length)throw new Rs("Invalid JWT structure");for(let s=0;s<t.length;s++)if(!xs.test(t[s]))throw new Rs("JWT not in base64url format");return{header:JSON.parse(Bs(t[0])),payload:JSON.parse(Bs(t[1])),signature:$s(t[2]),raw:{header:t[0],payload:t[1]}}}function ei(e){return("0"+e.toString(16)).substr(-2)}function ti(e){return p(this,null,function*(){if(!("undefined"!=typeof crypto&&void 0!==crypto.subtle&&"undefined"!=typeof TextEncoder))return e;const t=yield function(e){return p(this,null,function*(){const t=(new TextEncoder).encode(e),s=yield crypto.subtle.digest("SHA-256",t),i=new Uint8Array(s);return Array.from(i).map(e=>String.fromCharCode(e)).join("")})}(e);return btoa(t).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")})}function si(e,t,s=!1){return p(this,null,function*(){const i=function(){const e=new Uint32Array(56);if("undefined"==typeof crypto){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",t=e.length;let s="";for(let i=0;i<56;i++)s+=e.charAt(Math.floor(Math.random()*t));return s}return crypto.getRandomValues(e),Array.from(e,ei).join("")}();let n=i;s&&(n+="/PASSWORD_RECOVERY"),yield Ks(e,`${t}-code-verifier`,n);const r=yield ti(i);return[r,i===r?"plain":"s256"]})}Qs.promiseConstructor=Promise;const ii=/^2[0-9]{3}-(0[1-9]|1[0-2])-(0[1-9]|1[0-9]|2[0-9]|3[0-1])$/i;const ni=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/;function ri(e){if(!ni.test(e))throw new Error("@supabase/auth-js: Expected parameter to be UUID but is not")}function ai(){return new Proxy({},{get:(e,t)=>{if("__isUserNotAvailableProxy"===t)return!0;if("symbol"==typeof t){const e=t.toString();if("Symbol(Symbol.toPrimitive)"===e||"Symbol(Symbol.toStringTag)"===e||"Symbol(util.inspect.custom)"===e)return}throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Accessing the "${t}" property of the session object is not supported. Please use getUser() instead.`)},set:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Setting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)},deleteProperty:(e,t)=>{throw new Error(`@supabase/auth-js: client was created with userStorage option and there was no user stored in the user storage. Deleting the "${t}" property of the session object is not supported. Please use getUser() to fetch a user object you can manipulate.`)}})}function oi(e){return JSON.parse(JSON.stringify(e))}const li=e=>e.msg||e.message||e.error_description||e.error||JSON.stringify(e),ci=[502,503,504];function di(e){return p(this,null,function*(){var t,s;if(!("object"==typeof(s=e)&&null!==s&&"status"in s&&"ok"in s&&"json"in s&&"function"==typeof s.json))throw new Ps(li(e),0);if(ci.includes(e.status))throw new Ps(li(e),e.status);let i,n;try{i=yield e.json()}catch(Tx){throw new _s(li(Tx),Tx)}const r=function(e){const t=e.headers.get(ys);if(!t)return null;if(!t.match(ii))return null;try{return new Date(`${t}T00:00:00.0Z`)}catch(Tx){return null}}(e);if(r&&r.getTime()>=bs.timestamp&&"object"==typeof i&&i&&"string"==typeof i.code?n=i.code:"object"==typeof i&&i&&"string"==typeof i.error_code&&(n=i.error_code),n){if("weak_password"===n)throw new Ls(li(i),e.status,(null===(t=i.weak_password)||void 0===t?void 0:t.reasons)||[]);if("session_not_found"===n)throw new Ns}else if("object"==typeof i&&i&&"object"==typeof i.weak_password&&i.weak_password&&Array.isArray(i.weak_password.reasons)&&i.weak_password.reasons.length&&i.weak_password.reasons.reduce((e,t)=>e&&"string"==typeof t,!0))throw new Ls(li(i),e.status,i.weak_password.reasons);throw new ks(li(i),e.status||500,n)})}function ui(e,t,s,i){return p(this,null,function*(){var n;const r=Object.assign({},null==i?void 0:i.headers);r[ys]||(r[ys]=bs.name),(null==i?void 0:i.jwt)&&(r.Authorization=`Bearer ${i.jwt}`);const a=null!==(n=null==i?void 0:i.query)&&void 0!==n?n:{};(null==i?void 0:i.redirectTo)&&(a.redirect_to=i.redirectTo);const o=Object.keys(a).length?"?"+new URLSearchParams(a).toString():"",l=yield function(e,t,s,i,n,r){return p(this,null,function*(){const a=((e,t,s,i)=>{const n={method:e,headers:(null==t?void 0:t.headers)||{}};return"GET"===e?n:(n.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},null==t?void 0:t.headers),n.body=JSON.stringify(i),Object.assign(Object.assign({},n),s))})(t,i,n,r);let o;try{o=yield e(s,Object.assign({},a))}catch(Tx){throw new Ps(li(Tx),0)}if(o.ok||(yield di(o)),null==i?void 0:i.noResolveJson)return o;try{return yield o.json()}catch(Tx){yield di(Tx)}})}(e,t,s+o,{headers:r,noResolveJson:null==i?void 0:i.noResolveJson},{},null==i?void 0:i.body);return(null==i?void 0:i.xform)?null==i?void 0:i.xform(l):{data:Object.assign({},l),error:null}})}function hi(e){var t;let s=null;var i;(function(e){return e.access_token&&e.refresh_token&&e.expires_in})(e)&&(s=Object.assign({},e),e.expires_at||(s.expires_at=(i=e.expires_in,Math.round(Date.now()/1e3)+i)));return{data:{session:s,user:null!==(t=e.user)&&void 0!==t?t:e},error:null}}function fi(e){const t=hi(e);return!t.error&&e.weak_password&&"object"==typeof e.weak_password&&Array.isArray(e.weak_password.reasons)&&e.weak_password.reasons.length&&e.weak_password.message&&"string"==typeof e.weak_password.message&&e.weak_password.reasons.reduce((e,t)=>e&&"string"==typeof t,!0)&&(t.data.weak_password=e.weak_password),t}function mi(e){var t;return{data:{user:null!==(t=e.user)&&void 0!==t?t:e},error:null}}function pi(e){return{data:e,error:null}}function gi(e){const{action_link:t,email_otp:s,hashed_token:i,redirect_to:n,verification_type:r}=e,a=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(s[i[n]]=e[i[n]])}return s}(e,["action_link","email_otp","hashed_token","redirect_to","verification_type"]);return{data:{properties:{action_link:t,email_otp:s,hashed_token:i,redirect_to:n,verification_type:r},user:Object.assign({},a)},error:null}}function vi(e){return e}const yi=["global","local","others"];class bi{constructor({url:e="",headers:t={},fetch:s}){this.url=e,this.headers=t,this.fetch=Ws(s),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}signOut(e){return p(this,arguments,function*(e,t=yi[0]){if(yi.indexOf(t)<0)throw new Error(`@supabase/auth-js: Parameter scope must be one of ${yi.join(", ")}`);try{return yield ui(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(s){if(Ss(s))return{data:null,error:s};throw s}})}inviteUserByEmail(e){return p(this,arguments,function*(e,t={}){try{return yield ui(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:mi})}catch(s){if(Ss(s))return{data:{user:null},error:s};throw s}})}generateLink(e){return p(this,null,function*(){try{const{options:t}=e,s=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(s[i[n]]=e[i[n]])}return s}(e,["options"]),i=Object.assign(Object.assign({},s),t);return"newEmail"in s&&(i.new_email=null==s?void 0:s.newEmail,delete i.newEmail),yield ui(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:i,headers:this.headers,xform:gi,redirectTo:null==t?void 0:t.redirectTo})}catch(t){if(Ss(t))return{data:{properties:null,user:null},error:t};throw t}})}createUser(e){return p(this,null,function*(){try{return yield ui(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:mi})}catch(t){if(Ss(t))return{data:{user:null},error:t};throw t}})}listUsers(e){return p(this,null,function*(){var t,s,i,n,r,a,o;try{const l={nextPage:null,lastPage:0,total:0},c=yield ui(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:null!==(s=null===(t=null==e?void 0:e.page)||void 0===t?void 0:t.toString())&&void 0!==s?s:"",per_page:null!==(n=null===(i=null==e?void 0:e.perPage)||void 0===i?void 0:i.toString())&&void 0!==n?n:""},xform:vi});if(c.error)throw c.error;const d=yield c.json(),u=null!==(r=c.headers.get("x-total-count"))&&void 0!==r?r:0,h=null!==(o=null===(a=c.headers.get("link"))||void 0===a?void 0:a.split(","))&&void 0!==o?o:[];return h.length>0&&(h.forEach(e=>{const t=parseInt(e.split(";")[0].split("=")[1].substring(0,1)),s=JSON.parse(e.split(";")[1].split("=")[1]);l[`${s}Page`]=t}),l.total=parseInt(u)),{data:Object.assign(Object.assign({},d),l),error:null}}catch(l){if(Ss(l))return{data:{users:[]},error:l};throw l}})}getUserById(e){return p(this,null,function*(){ri(e);try{return yield ui(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:mi})}catch(t){if(Ss(t))return{data:{user:null},error:t};throw t}})}updateUserById(e,t){return p(this,null,function*(){ri(e);try{return yield ui(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:mi})}catch(s){if(Ss(s))return{data:{user:null},error:s};throw s}})}deleteUser(e,t=!1){return p(this,null,function*(){ri(e);try{return yield ui(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:mi})}catch(s){if(Ss(s))return{data:{user:null},error:s};throw s}})}_listFactors(e){return p(this,null,function*(){ri(e.userId);try{const{data:t,error:s}=yield ui(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:e=>({data:{factors:e},error:null})});return{data:t,error:s}}catch(t){if(Ss(t))return{data:null,error:t};throw t}})}_deleteFactor(e){return p(this,null,function*(){ri(e.userId),ri(e.id);try{return{data:yield ui(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(Ss(t))return{data:null,error:t};throw t}})}}function xi(e={}){return{getItem:t=>e[t]||null,setItem:(t,s)=>{e[t]=s},removeItem:t=>{delete e[t]}}}const wi=!!(globalThis&&Js()&&globalThis.localStorage&&"true"===globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug"));class Si extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class ki extends Si{}function _i(e,t,s){return p(this,null,function*(){const i=new globalThis.AbortController;return t>0&&setTimeout(()=>{i.abort()},t),yield Promise.resolve().then(()=>globalThis.navigator.locks.request(e,0===t?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:i.signal},i=>p(this,null,function*(){if(!i){if(0===t)throw new ki(`Acquiring an exclusive Navigator LockManager lock "${e}" immediately failed`);if(wi)try{yield globalThis.navigator.locks.query()}catch(Tx){}return yield s()}try{return yield s()}finally{}})))})}!function(){if("object"!=typeof globalThis)try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch(Tx){"undefined"!=typeof self&&(self.globalThis=self)}}();const Ci={url:"http://localhost:9999",storageKey:"supabase.auth.token",autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:vs,flowType:"implicit",debug:!1,hasCustomAuthorizationHeader:!1};function Ni(e,t,s){return p(this,null,function*(){return yield s()})}const Ti={};class Ai{constructor(e){var t,s;this.userStorage=null,this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.hasCustomAuthorizationHeader=!1,this.suppressGetSessionWarning=!1,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=Ai.nextInstanceID,Ai.nextInstanceID+=1,this.instanceID>0&&Vs();const i=Object.assign(Object.assign({},Ci),e);if(this.logDebugMessages=!!i.debug,"function"==typeof i.debug&&(this.logger=i.debug),this.persistSession=i.persistSession,this.storageKey=i.storageKey,this.autoRefreshToken=i.autoRefreshToken,this.admin=new bi({url:i.url,headers:i.headers,fetch:i.fetch}),this.url=i.url,this.headers=i.headers,this.fetch=Ws(i.fetch),this.lock=i.lock||Ni,this.detectSessionInUrl=i.detectSessionInUrl,this.flowType=i.flowType,this.hasCustomAuthorizationHeader=i.hasCustomAuthorizationHeader,i.lock?this.lock=i.lock:Vs()&&(null===(t=null===globalThis||void 0===globalThis?void 0:globalThis.navigator)||void 0===t?void 0:t.locks)?this.lock=_i:this.lock=Ni,this.jwks||(this.jwks={keys:[]},this.jwks_cached_at=Number.MIN_SAFE_INTEGER),this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?(i.storage?this.storage=i.storage:Js()?this.storage=globalThis.localStorage:(this.memoryStorage={},this.storage=xi(this.memoryStorage)),i.userStorage&&(this.userStorage=i.userStorage)):(this.memoryStorage={},this.storage=xi(this.memoryStorage)),Vs()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(Tx){}null===(s=this.broadcastChannel)||void 0===s||s.addEventListener("message",e=>p(this,null,function*(){this._debug("received broadcast notification from other tab or client",e),yield this._notifyAllSubscribers(e.data.event,e.data.session,!1)}))}this.initialize()}get jwks(){var e,t;return null!==(t=null===(e=Ti[this.storageKey])||void 0===e?void 0:e.jwks)&&void 0!==t?t:{keys:[]}}set jwks(e){Ti[this.storageKey]=Object.assign(Object.assign({},Ti[this.storageKey]),{jwks:e})}get jwks_cached_at(){var e,t;return null!==(t=null===(e=Ti[this.storageKey])||void 0===e?void 0:e.cachedAt)&&void 0!==t?t:Number.MIN_SAFE_INTEGER}set jwks_cached_at(e){Ti[this.storageKey]=Object.assign(Object.assign({},Ti[this.storageKey]),{cachedAt:e})}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${ms}) ${(new Date).toISOString()}`,...e),this}initialize(){return p(this,null,function*(){return this.initializePromise||(this.initializePromise=(()=>p(this,null,function*(){return yield this._acquireLock(-1,()=>p(this,null,function*(){return yield this._initialize()}))}))()),yield this.initializePromise})}_initialize(){return p(this,null,function*(){var e;try{const t=function(e){const t={},s=new URL(e);if(s.hash&&"#"===s.hash[0])try{new URLSearchParams(s.hash.substring(1)).forEach((e,s)=>{t[s]=e})}catch(Tx){}return s.searchParams.forEach((e,s)=>{t[s]=e}),t}(window.location.href);let s="none";if(this._isImplicitGrantCallback(t)?s="implicit":(yield this._isPKCECallback(t))&&(s="pkce"),Vs()&&this.detectSessionInUrl&&"none"!==s){const{data:i,error:n}=yield this._getSessionFromURL(t,s);if(n){if(this._debug("#_initialize()","error detecting session from URL",n),function(e){return Ss(e)&&"AuthImplicitGrantRedirectError"===e.name}(n)){const t=null===(e=n.details)||void 0===e?void 0:e.code;if("identity_already_exists"===t||"identity_not_found"===t||"single_identity_not_deletable"===t)return{error:n}}return yield this._removeSession(),{error:n}}const{session:r,redirectType:a}=i;return this._debug("#_initialize()","detected session in URL",r,"redirect type",a),yield this._saveSession(r),setTimeout(()=>p(this,null,function*(){"recovery"===a?yield this._notifyAllSubscribers("PASSWORD_RECOVERY",r):yield this._notifyAllSubscribers("SIGNED_IN",r)}),0),{error:null}}return yield this._recoverAndRefresh(),{error:null}}catch(t){return Ss(t)?{error:t}:{error:new _s("Unexpected error during initialization",t)}}finally{yield this._handleVisibilityChange(),this._debug("#_initialize()","end")}})}signInAnonymously(e){return p(this,null,function*(){var t,s,i;try{const n=yield ui(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{data:null!==(s=null===(t=null==e?void 0:e.options)||void 0===t?void 0:t.data)&&void 0!==s?s:{},gotrue_meta_security:{captcha_token:null===(i=null==e?void 0:e.options)||void 0===i?void 0:i.captchaToken}},xform:hi}),{data:r,error:a}=n;if(a||!r)return{data:{user:null,session:null},error:a};const o=r.session,l=r.user;return r.session&&(yield this._saveSession(r.session),yield this._notifyAllSubscribers("SIGNED_IN",o)),{data:{user:l,session:o},error:null}}catch(n){if(Ss(n))return{data:{user:null,session:null},error:n};throw n}})}signUp(e){return p(this,null,function*(){var t,s,i;try{let n;if("email"in e){const{email:s,password:i,options:r}=e;let a=null,o=null;"pkce"===this.flowType&&([a,o]=yield si(this.storage,this.storageKey)),n=yield ui(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:null==r?void 0:r.emailRedirectTo,body:{email:s,password:i,data:null!==(t=null==r?void 0:r.data)&&void 0!==t?t:{},gotrue_meta_security:{captcha_token:null==r?void 0:r.captchaToken},code_challenge:a,code_challenge_method:o},xform:hi})}else{if(!("phone"in e))throw new As("You must provide either an email or phone number and a password");{const{phone:t,password:r,options:a}=e;n=yield ui(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:t,password:r,data:null!==(s=null==a?void 0:a.data)&&void 0!==s?s:{},channel:null!==(i=null==a?void 0:a.channel)&&void 0!==i?i:"sms",gotrue_meta_security:{captcha_token:null==a?void 0:a.captchaToken}},xform:hi})}}const{data:r,error:a}=n;if(a||!r)return{data:{user:null,session:null},error:a};const o=r.session,l=r.user;return r.session&&(yield this._saveSession(r.session),yield this._notifyAllSubscribers("SIGNED_IN",o)),{data:{user:l,session:o},error:null}}catch(n){if(Ss(n))return{data:{user:null,session:null},error:n};throw n}})}signInWithPassword(e){return p(this,null,function*(){try{let t;if("email"in e){const{email:s,password:i,options:n}=e;t=yield ui(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:s,password:i,gotrue_meta_security:{captcha_token:null==n?void 0:n.captchaToken}},xform:fi})}else{if(!("phone"in e))throw new As("You must provide either an email or phone number and a password");{const{phone:s,password:i,options:n}=e;t=yield ui(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:s,password:i,gotrue_meta_security:{captcha_token:null==n?void 0:n.captchaToken}},xform:fi})}}const{data:s,error:i}=t;return i?{data:{user:null,session:null},error:i}:s&&s.session&&s.user?(s.session&&(yield this._saveSession(s.session),yield this._notifyAllSubscribers("SIGNED_IN",s.session)),{data:Object.assign({user:s.user,session:s.session},s.weak_password?{weakPassword:s.weak_password}:null),error:i}):{data:{user:null,session:null},error:new Ts}}catch(t){if(Ss(t))return{data:{user:null,session:null},error:t};throw t}})}signInWithOAuth(e){return p(this,null,function*(){var t,s,i,n;return yield this._handleProviderSignIn(e.provider,{redirectTo:null===(t=e.options)||void 0===t?void 0:t.redirectTo,scopes:null===(s=e.options)||void 0===s?void 0:s.scopes,queryParams:null===(i=e.options)||void 0===i?void 0:i.queryParams,skipBrowserRedirect:null===(n=e.options)||void 0===n?void 0:n.skipBrowserRedirect})})}exchangeCodeForSession(e){return p(this,null,function*(){return yield this.initializePromise,this._acquireLock(-1,()=>p(this,null,function*(){return this._exchangeCodeForSession(e)}))})}signInWithWeb3(e){return p(this,null,function*(){const{chain:t}=e;if("solana"===t)return yield this.signInWithSolana(e);throw new Error(`@supabase/auth-js: Unsupported chain "${t}"`)})}signInWithSolana(e){return p(this,null,function*(){var t,s,i,n,r,a,o,l,c,d,u,h;let f,m;if("message"in e)f=e.message,m=e.signature;else{const{chain:u,wallet:h,statement:p,options:g}=e;let v;if(Vs())if("object"==typeof h)v=h;else{const e=window;if(!("solana"in e)||"object"!=typeof e.solana||!("signIn"in e.solana&&"function"==typeof e.solana.signIn||"signMessage"in e.solana&&"function"==typeof e.solana.signMessage))throw new Error("@supabase/auth-js: No compatible Solana wallet interface on the window object (window.solana) detected. Make sure the user already has a wallet installed and connected for this app. Prefer passing the wallet interface object directly to signInWithWeb3({ chain: 'solana', wallet: resolvedUserWallet }) instead.");v=e.solana}else{if("object"!=typeof h||!(null==g?void 0:g.url))throw new Error("@supabase/auth-js: Both wallet and url must be specified in non-browser environments.");v=h}const y=new URL(null!==(t=null==g?void 0:g.url)&&void 0!==t?t:window.location.href);if("signIn"in v&&v.signIn){const e=yield v.signIn(Object.assign(Object.assign(Object.assign({issuedAt:(new Date).toISOString()},null==g?void 0:g.signInWithSolana),{version:"1",domain:y.host,uri:y.href}),p?{statement:p}:null));let t;if(Array.isArray(e)&&e[0]&&"object"==typeof e[0])t=e[0];else{if(!(e&&"object"==typeof e&&"signedMessage"in e&&"signature"in e))throw new Error("@supabase/auth-js: Wallet method signIn() returned unrecognized value");t=e}if(!("signedMessage"in t&&"signature"in t&&("string"==typeof t.signedMessage||t.signedMessage instanceof Uint8Array)&&t.signature instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet method signIn() API returned object without signedMessage and signature fields");f="string"==typeof t.signedMessage?t.signedMessage:(new TextDecoder).decode(t.signedMessage),m=t.signature}else{if(!("signMessage"in v&&"function"==typeof v.signMessage&&"publicKey"in v&&"object"==typeof v&&v.publicKey&&"toBase58"in v.publicKey&&"function"==typeof v.publicKey.toBase58))throw new Error("@supabase/auth-js: Wallet does not have a compatible signMessage() and publicKey.toBase58() API");f=[`${y.host} wants you to sign in with your Solana account:`,v.publicKey.toBase58(),...p?["",p,""]:[""],"Version: 1",`URI: ${y.href}`,`Issued At: ${null!==(i=null===(s=null==g?void 0:g.signInWithSolana)||void 0===s?void 0:s.issuedAt)&&void 0!==i?i:(new Date).toISOString()}`,...(null===(n=null==g?void 0:g.signInWithSolana)||void 0===n?void 0:n.notBefore)?[`Not Before: ${g.signInWithSolana.notBefore}`]:[],...(null===(r=null==g?void 0:g.signInWithSolana)||void 0===r?void 0:r.expirationTime)?[`Expiration Time: ${g.signInWithSolana.expirationTime}`]:[],...(null===(a=null==g?void 0:g.signInWithSolana)||void 0===a?void 0:a.chainId)?[`Chain ID: ${g.signInWithSolana.chainId}`]:[],...(null===(o=null==g?void 0:g.signInWithSolana)||void 0===o?void 0:o.nonce)?[`Nonce: ${g.signInWithSolana.nonce}`]:[],...(null===(l=null==g?void 0:g.signInWithSolana)||void 0===l?void 0:l.requestId)?[`Request ID: ${g.signInWithSolana.requestId}`]:[],...(null===(d=null===(c=null==g?void 0:g.signInWithSolana)||void 0===c?void 0:c.resources)||void 0===d?void 0:d.length)?["Resources",...g.signInWithSolana.resources.map(e=>`- ${e}`)]:[]].join("\n");const e=yield v.signMessage((new TextEncoder).encode(f),"utf8");if(!(e&&e instanceof Uint8Array))throw new Error("@supabase/auth-js: Wallet signMessage() API returned an recognized value");m=e}}try{const{data:t,error:s}=yield ui(this.fetch,"POST",`${this.url}/token?grant_type=web3`,{headers:this.headers,body:Object.assign({chain:"solana",message:f,signature:Hs(m)},(null===(u=e.options)||void 0===u?void 0:u.captchaToken)?{gotrue_meta_security:{captcha_token:null===(h=e.options)||void 0===h?void 0:h.captchaToken}}:null),xform:hi});if(s)throw s;return t&&t.session&&t.user?(t.session&&(yield this._saveSession(t.session),yield this._notifyAllSubscribers("SIGNED_IN",t.session)),{data:Object.assign({},t),error:s}):{data:{user:null,session:null},error:new Ts}}catch(p){if(Ss(p))return{data:{user:null,session:null},error:p};throw p}})}_exchangeCodeForSession(e){return p(this,null,function*(){const t=yield Ys(this.storage,`${this.storageKey}-code-verifier`),[s,i]=(null!=t?t:"").split("/");try{const{data:t,error:n}=yield ui(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:s},xform:hi});if(yield Xs(this.storage,`${this.storageKey}-code-verifier`),n)throw n;return t&&t.session&&t.user?(t.session&&(yield this._saveSession(t.session),yield this._notifyAllSubscribers("SIGNED_IN",t.session)),{data:Object.assign(Object.assign({},t),{redirectType:null!=i?i:null}),error:n}):{data:{user:null,session:null,redirectType:null},error:new Ts}}catch(n){if(Ss(n))return{data:{user:null,session:null,redirectType:null},error:n};throw n}})}signInWithIdToken(e){return p(this,null,function*(){try{const{options:t,provider:s,token:i,access_token:n,nonce:r}=e,a=yield ui(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:s,id_token:i,access_token:n,nonce:r,gotrue_meta_security:{captcha_token:null==t?void 0:t.captchaToken}},xform:hi}),{data:o,error:l}=a;return l?{data:{user:null,session:null},error:l}:o&&o.session&&o.user?(o.session&&(yield this._saveSession(o.session),yield this._notifyAllSubscribers("SIGNED_IN",o.session)),{data:o,error:l}):{data:{user:null,session:null},error:new Ts}}catch(t){if(Ss(t))return{data:{user:null,session:null},error:t};throw t}})}signInWithOtp(e){return p(this,null,function*(){var t,s,i,n,r;try{if("email"in e){const{email:i,options:n}=e;let r=null,a=null;"pkce"===this.flowType&&([r,a]=yield si(this.storage,this.storageKey));const{error:o}=yield ui(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:i,data:null!==(t=null==n?void 0:n.data)&&void 0!==t?t:{},create_user:null===(s=null==n?void 0:n.shouldCreateUser)||void 0===s||s,gotrue_meta_security:{captcha_token:null==n?void 0:n.captchaToken},code_challenge:r,code_challenge_method:a},redirectTo:null==n?void 0:n.emailRedirectTo});return{data:{user:null,session:null},error:o}}if("phone"in e){const{phone:t,options:s}=e,{data:a,error:o}=yield ui(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:t,data:null!==(i=null==s?void 0:s.data)&&void 0!==i?i:{},create_user:null===(n=null==s?void 0:s.shouldCreateUser)||void 0===n||n,gotrue_meta_security:{captcha_token:null==s?void 0:s.captchaToken},channel:null!==(r=null==s?void 0:s.channel)&&void 0!==r?r:"sms"}});return{data:{user:null,session:null,messageId:null==a?void 0:a.message_id},error:o}}throw new As("You must provide either an email or phone number.")}catch(a){if(Ss(a))return{data:{user:null,session:null},error:a};throw a}})}verifyOtp(e){return p(this,null,function*(){var t,s;try{let i,n;"options"in e&&(i=null===(t=e.options)||void 0===t?void 0:t.redirectTo,n=null===(s=e.options)||void 0===s?void 0:s.captchaToken);const{data:r,error:a}=yield ui(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:n}}),redirectTo:i,xform:hi});if(a)throw a;if(!r)throw new Error("An error occurred on token verification.");const o=r.session,l=r.user;return(null==o?void 0:o.access_token)&&(yield this._saveSession(o),yield this._notifyAllSubscribers("recovery"==e.type?"PASSWORD_RECOVERY":"SIGNED_IN",o)),{data:{user:l,session:o},error:null}}catch(i){if(Ss(i))return{data:{user:null,session:null},error:i};throw i}})}signInWithSSO(e){return p(this,null,function*(){var t,s,i;try{let n=null,r=null;return"pkce"===this.flowType&&([n,r]=yield si(this.storage,this.storageKey)),yield ui(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:null!==(s=null===(t=e.options)||void 0===t?void 0:t.redirectTo)&&void 0!==s?s:void 0}),(null===(i=null==e?void 0:e.options)||void 0===i?void 0:i.captchaToken)?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:n,code_challenge_method:r}),headers:this.headers,xform:pi})}catch(n){if(Ss(n))return{data:null,error:n};throw n}})}reauthenticate(){return p(this,null,function*(){return yield this.initializePromise,yield this._acquireLock(-1,()=>p(this,null,function*(){return yield this._reauthenticate()}))})}_reauthenticate(){return p(this,null,function*(){try{return yield this._useSession(e=>p(this,null,function*(){const{data:{session:t},error:s}=e;if(s)throw s;if(!t)throw new Ns;const{error:i}=yield ui(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return{data:{user:null,session:null},error:i}}))}catch(e){if(Ss(e))return{data:{user:null,session:null},error:e};throw e}})}resend(e){return p(this,null,function*(){try{const t=`${this.url}/resend`;if("email"in e){const{email:s,type:i,options:n}=e,{error:r}=yield ui(this.fetch,"POST",t,{headers:this.headers,body:{email:s,type:i,gotrue_meta_security:{captcha_token:null==n?void 0:n.captchaToken}},redirectTo:null==n?void 0:n.emailRedirectTo});return{data:{user:null,session:null},error:r}}if("phone"in e){const{phone:s,type:i,options:n}=e,{data:r,error:a}=yield ui(this.fetch,"POST",t,{headers:this.headers,body:{phone:s,type:i,gotrue_meta_security:{captcha_token:null==n?void 0:n.captchaToken}}});return{data:{user:null,session:null,messageId:null==r?void 0:r.message_id},error:a}}throw new As("You must provide either an email or phone number and a type")}catch(t){if(Ss(t))return{data:{user:null,session:null},error:t};throw t}})}getSession(){return p(this,null,function*(){yield this.initializePromise;return yield this._acquireLock(-1,()=>p(this,null,function*(){return this._useSession(e=>p(this,null,function*(){return e}))}))})}_acquireLock(e,t){return p(this,null,function*(){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const e=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),s=(()=>p(this,null,function*(){return yield e,yield t()}))();return this.pendingInLock.push((()=>p(this,null,function*(){try{yield s}catch(Tx){}}))()),s}return yield this.lock(`lock:${this.storageKey}`,e,()=>p(this,null,function*(){this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const e=t();for(this.pendingInLock.push((()=>p(this,null,function*(){try{yield e}catch(Tx){}}))()),yield e;this.pendingInLock.length;){const e=[...this.pendingInLock];yield Promise.all(e),this.pendingInLock.splice(0,e.length)}return yield e}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}}))}finally{this._debug("#_acquireLock","end")}})}_useSession(e){return p(this,null,function*(){this._debug("#_useSession","begin");try{const t=yield this.__loadSession();return yield e(t)}finally{this._debug("#_useSession","end")}})}__loadSession(){return p(this,null,function*(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",(new Error).stack);try{let e=null;const t=yield Ys(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),null!==t&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),yield this._removeSession())),!e)return{data:{session:null},error:null};const s=!!e.expires_at&&1e3*e.expires_at-Date.now()<gs;if(this._debug("#__loadSession()",`session has${s?"":" not"} expired`,"expires_at",e.expires_at),!s){if(this.userStorage){const t=yield Ys(this.userStorage,this.storageKey+"-user");(null==t?void 0:t.user)?e.user=t.user:e.user=ai()}if(this.storage.isServer&&e.user){let t=this.suppressGetSessionWarning;e=new Proxy(e,{get:(e,s,i)=>(t||"user"!==s||(t=!0,this.suppressGetSessionWarning=!0),Reflect.get(e,s,i))})}return{data:{session:e},error:null}}const{session:i,error:n}=yield this._callRefreshToken(e.refresh_token);return n?{data:{session:null},error:n}:{data:{session:i},error:null}}finally{this._debug("#__loadSession()","end")}})}getUser(e){return p(this,null,function*(){if(e)return yield this._getUser(e);yield this.initializePromise;return yield this._acquireLock(-1,()=>p(this,null,function*(){return yield this._getUser()}))})}_getUser(e){return p(this,null,function*(){try{return e?yield ui(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:mi}):yield this._useSession(e=>p(this,null,function*(){var t,s,i;const{data:n,error:r}=e;if(r)throw r;return(null===(t=n.session)||void 0===t?void 0:t.access_token)||this.hasCustomAuthorizationHeader?yield ui(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:null!==(i=null===(s=n.session)||void 0===s?void 0:s.access_token)&&void 0!==i?i:void 0,xform:mi}):{data:{user:null},error:new Ns}}))}catch(t){if(Ss(t))return function(e){return Ss(e)&&"AuthSessionMissingError"===e.name}(t)&&(yield this._removeSession(),yield Xs(this.storage,`${this.storageKey}-code-verifier`)),{data:{user:null},error:t};throw t}})}updateUser(e){return p(this,arguments,function*(e,t={}){return yield this.initializePromise,yield this._acquireLock(-1,()=>p(this,null,function*(){return yield this._updateUser(e,t)}))})}_updateUser(e){return p(this,arguments,function*(e,t={}){try{return yield this._useSession(s=>p(this,null,function*(){const{data:i,error:n}=s;if(n)throw n;if(!i.session)throw new Ns;const r=i.session;let a=null,o=null;"pkce"===this.flowType&&null!=e.email&&([a,o]=yield si(this.storage,this.storageKey));const{data:l,error:c}=yield ui(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:null==t?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:a,code_challenge_method:o}),jwt:r.access_token,xform:mi});if(c)throw c;return r.user=l.user,yield this._saveSession(r),yield this._notifyAllSubscribers("USER_UPDATED",r),{data:{user:r.user},error:null}}))}catch(s){if(Ss(s))return{data:{user:null},error:s};throw s}})}setSession(e){return p(this,null,function*(){return yield this.initializePromise,yield this._acquireLock(-1,()=>p(this,null,function*(){return yield this._setSession(e)}))})}_setSession(e){return p(this,null,function*(){try{if(!e.access_token||!e.refresh_token)throw new Ns;const t=Date.now()/1e3;let s=t,i=!0,n=null;const{payload:r}=Zs(e.access_token);if(r.exp&&(s=r.exp,i=s<=t),i){const{session:t,error:s}=yield this._callRefreshToken(e.refresh_token);if(s)return{data:{user:null,session:null},error:s};if(!t)return{data:{user:null,session:null},error:null};n=t}else{const{data:i,error:r}=yield this._getUser(e.access_token);if(r)throw r;n={access_token:e.access_token,refresh_token:e.refresh_token,user:i.user,token_type:"bearer",expires_in:s-t,expires_at:s},yield this._saveSession(n),yield this._notifyAllSubscribers("SIGNED_IN",n)}return{data:{user:n.user,session:n},error:null}}catch(t){if(Ss(t))return{data:{session:null,user:null},error:t};throw t}})}refreshSession(e){return p(this,null,function*(){return yield this.initializePromise,yield this._acquireLock(-1,()=>p(this,null,function*(){return yield this._refreshSession(e)}))})}_refreshSession(e){return p(this,null,function*(){try{return yield this._useSession(t=>p(this,null,function*(){var s;if(!e){const{data:i,error:n}=t;if(n)throw n;e=null!==(s=i.session)&&void 0!==s?s:void 0}if(!(null==e?void 0:e.refresh_token))throw new Ns;const{session:i,error:n}=yield this._callRefreshToken(e.refresh_token);return n?{data:{user:null,session:null},error:n}:i?{data:{user:i.user,session:i},error:null}:{data:{user:null,session:null},error:null}}))}catch(t){if(Ss(t))return{data:{user:null,session:null},error:t};throw t}})}_getSessionFromURL(e,t){return p(this,null,function*(){try{if(!Vs())throw new Es("No browser detected.");if(e.error||e.error_description||e.error_code)throw new Es(e.error_description||"Error in URL with unspecified error_description",{error:e.error||"unspecified_error",code:e.error_code||"unspecified_code"});switch(t){case"implicit":if("pkce"===this.flowType)throw new js("Not a valid PKCE flow url.");break;case"pkce":if("implicit"===this.flowType)throw new Es("Not a valid implicit grant flow url.")}if("pkce"===t){if(this._debug("#_initialize()","begin","is PKCE flow",!0),!e.code)throw new js("No code detected.");const{data:t,error:s}=yield this._exchangeCodeForSession(e.code);if(s)throw s;const i=new URL(window.location.href);return i.searchParams.delete("code"),window.history.replaceState(window.history.state,"",i.toString()),{data:{session:t.session,redirectType:null},error:null}}const{provider_token:s,provider_refresh_token:i,access_token:n,refresh_token:r,expires_in:a,expires_at:o,token_type:l}=e;if(!(n&&a&&r&&l))throw new Es("No session defined in URL");const c=Math.round(Date.now()/1e3),d=parseInt(a);let u=c+d;o&&(u=parseInt(o));const{data:h,error:f}=yield this._getUser(n);if(f)throw f;const m={provider_token:s,provider_refresh_token:i,access_token:n,expires_in:d,expires_at:u,refresh_token:r,token_type:l,user:h.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:m,redirectType:e.type},error:null}}catch(s){if(Ss(s))return{data:{session:null,redirectType:null},error:s};throw s}})}_isImplicitGrantCallback(e){return Boolean(e.access_token||e.error_description)}_isPKCECallback(e){return p(this,null,function*(){const t=yield Ys(this.storage,`${this.storageKey}-code-verifier`);return!(!e.code||!t)})}signOut(){return p(this,arguments,function*(e={scope:"global"}){return yield this.initializePromise,yield this._acquireLock(-1,()=>p(this,null,function*(){return yield this._signOut(e)}))})}_signOut(){return p(this,arguments,function*({scope:e}={scope:"global"}){return yield this._useSession(t=>p(this,null,function*(){var s;const{data:i,error:n}=t;if(n)return{error:n};const r=null===(s=i.session)||void 0===s?void 0:s.access_token;if(r){const{error:t}=yield this.admin.signOut(r,e);if(t&&(!function(e){return Ss(e)&&"AuthApiError"===e.name}(t)||404!==t.status&&401!==t.status&&403!==t.status))return{error:t}}return"others"!==e&&(yield this._removeSession(),yield Xs(this.storage,`${this.storageKey}-code-verifier`)),{error:null}}))})}onAuthStateChange(e){const t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}),s={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,s),(()=>{p(this,null,function*(){yield this.initializePromise,yield this._acquireLock(-1,()=>p(this,null,function*(){this._emitInitialSession(t)}))})})(),{data:{subscription:s}}}_emitInitialSession(e){return p(this,null,function*(){return yield this._useSession(t=>p(this,null,function*(){var s,i;try{const{data:{session:i},error:n}=t;if(n)throw n;yield null===(s=this.stateChangeEmitters.get(e))||void 0===s?void 0:s.callback("INITIAL_SESSION",i),this._debug("INITIAL_SESSION","callback id",e,"session",i)}catch(n){yield null===(i=this.stateChangeEmitters.get(e))||void 0===i?void 0:i.callback("INITIAL_SESSION",null),this._debug("INITIAL_SESSION","callback id",e,"error",n)}}))})}resetPasswordForEmail(e){return p(this,arguments,function*(e,t={}){let s=null,i=null;"pkce"===this.flowType&&([s,i]=yield si(this.storage,this.storageKey,!0));try{return yield ui(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:s,code_challenge_method:i,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(n){if(Ss(n))return{data:null,error:n};throw n}})}getUserIdentities(){return p(this,null,function*(){var e;try{const{data:t,error:s}=yield this.getUser();if(s)throw s;return{data:{identities:null!==(e=t.user.identities)&&void 0!==e?e:[]},error:null}}catch(t){if(Ss(t))return{data:null,error:t};throw t}})}linkIdentity(e){return p(this,null,function*(){var t;try{const{data:s,error:i}=yield this._useSession(t=>p(this,null,function*(){var s,i,n,r,a;const{data:o,error:l}=t;if(l)throw l;const c=yield this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:null===(s=e.options)||void 0===s?void 0:s.redirectTo,scopes:null===(i=e.options)||void 0===i?void 0:i.scopes,queryParams:null===(n=e.options)||void 0===n?void 0:n.queryParams,skipBrowserRedirect:!0});return yield ui(this.fetch,"GET",c,{headers:this.headers,jwt:null!==(a=null===(r=o.session)||void 0===r?void 0:r.access_token)&&void 0!==a?a:void 0})}));if(i)throw i;return Vs()&&!(null===(t=e.options)||void 0===t?void 0:t.skipBrowserRedirect)&&window.location.assign(null==s?void 0:s.url),{data:{provider:e.provider,url:null==s?void 0:s.url},error:null}}catch(s){if(Ss(s))return{data:{provider:e.provider,url:null},error:s};throw s}})}unlinkIdentity(e){return p(this,null,function*(){try{return yield this._useSession(t=>p(this,null,function*(){var s,i;const{data:n,error:r}=t;if(r)throw r;return yield ui(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:null!==(i=null===(s=n.session)||void 0===s?void 0:s.access_token)&&void 0!==i?i:void 0})}))}catch(t){if(Ss(t))return{data:null,error:t};throw t}})}_refreshAccessToken(e){return p(this,null,function*(){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const s=Date.now();return yield function(e,t){return new Promise((s,i)=>{(()=>{p(this,null,function*(){for(let n=0;n<1/0;n++)try{const i=yield e(n);if(!t(n,null,i))return void s(i)}catch(Tx){if(!t(n,Tx))return void i(Tx)}})})()})}(s=>p(this,null,function*(){return s>0&&(yield function(e){return p(this,null,function*(){return yield new Promise(t=>{setTimeout(()=>t(null),e)})})}(200*Math.pow(2,s-1))),this._debug(t,"refreshing attempt",s),yield ui(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:hi})}),(e,t)=>{const i=200*Math.pow(2,e);return t&&Is(t)&&Date.now()+i-s<ps})}catch(s){if(this._debug(t,"error",s),Ss(s))return{data:{session:null,user:null},error:s};throw s}finally{this._debug(t,"end")}})}_isValidSession(e){return"object"==typeof e&&null!==e&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}_handleProviderSignIn(e,t){return p(this,null,function*(){const s=yield this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",s),Vs()&&!t.skipBrowserRedirect&&window.location.assign(s),{data:{provider:e,url:s},error:null}})}_recoverAndRefresh(){return p(this,null,function*(){var e,t;const s="#_recoverAndRefresh()";this._debug(s,"begin");try{const n=yield Ys(this.storage,this.storageKey);if(n&&this.userStorage){let t=yield Ys(this.userStorage,this.storageKey+"-user");this.storage.isServer||!Object.is(this.storage,this.userStorage)||t||(t={user:n.user},yield Ks(this.userStorage,this.storageKey+"-user",t)),n.user=null!==(e=null==t?void 0:t.user)&&void 0!==e?e:ai()}else if(n&&!n.user&&!n.user){const e=yield Ys(this.storage,this.storageKey+"-user");e&&(null==e?void 0:e.user)?(n.user=e.user,yield Xs(this.storage,this.storageKey+"-user"),yield Ks(this.storage,this.storageKey,n)):n.user=ai()}if(this._debug(s,"session from storage",n),!this._isValidSession(n))return this._debug(s,"session is not valid"),void(null!==n&&(yield this._removeSession()));const r=1e3*(null!==(t=n.expires_at)&&void 0!==t?t:1/0)-Date.now()<gs;if(this._debug(s,`session has${r?"":" not"} expired with margin of 90000s`),r){if(this.autoRefreshToken&&n.refresh_token){const{error:e}=yield this._callRefreshToken(n.refresh_token);e&&(Is(e)||(this._debug(s,"refresh failed with a non-retryable error, removing the session",e),yield this._removeSession()))}}else if(n.user&&!0===n.user.__isUserNotAvailableProxy)try{const{data:e,error:t}=yield this._getUser(n.access_token);!t&&(null==e?void 0:e.user)?(n.user=e.user,yield this._saveSession(n),yield this._notifyAllSubscribers("SIGNED_IN",n)):this._debug(s,"could not get user data, skipping SIGNED_IN notification")}catch(i){this._debug(s,"error getting user data, skipping SIGNED_IN notification",i)}else yield this._notifyAllSubscribers("SIGNED_IN",n)}catch(n){return void this._debug(s,"error",n)}finally{this._debug(s,"end")}})}_callRefreshToken(e){return p(this,null,function*(){var t,s;if(!e)throw new Ns;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const i=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(i,"begin");try{this.refreshingDeferred=new Qs;const{data:t,error:s}=yield this._refreshAccessToken(e);if(s)throw s;if(!t.session)throw new Ns;yield this._saveSession(t.session),yield this._notifyAllSubscribers("TOKEN_REFRESHED",t.session);const i={session:t.session,error:null};return this.refreshingDeferred.resolve(i),i}catch(n){if(this._debug(i,"error",n),Ss(n)){const e={session:null,error:n};return Is(n)||(yield this._removeSession()),null===(t=this.refreshingDeferred)||void 0===t||t.resolve(e),e}throw null===(s=this.refreshingDeferred)||void 0===s||s.reject(n),n}finally{this.refreshingDeferred=null,this._debug(i,"end")}})}_notifyAllSubscribers(e,t,s=!0){return p(this,null,function*(){const i=`#_notifyAllSubscribers(${e})`;this._debug(i,"begin",t,`broadcast = ${s}`);try{this.broadcastChannel&&s&&this.broadcastChannel.postMessage({event:e,session:t});const i=[],n=Array.from(this.stateChangeEmitters.values()).map(s=>p(this,null,function*(){try{yield s.callback(e,t)}catch(Tx){i.push(Tx)}}));if(yield Promise.all(n),i.length>0){for(let e=0;e<i.length;e+=1);throw i[0]}}finally{this._debug(i,"end")}})}_saveSession(e){return p(this,null,function*(){this._debug("#_saveSession()",e),this.suppressGetSessionWarning=!0;const t=Object.assign({},e),s=t.user&&!0===t.user.__isUserNotAvailableProxy;if(this.userStorage){!s&&t.user&&(yield Ks(this.userStorage,this.storageKey+"-user",{user:t.user}));const e=Object.assign({},t);delete e.user;const i=oi(e);yield Ks(this.storage,this.storageKey,i)}else{const e=oi(t);yield Ks(this.storage,this.storageKey,e)}})}_removeSession(){return p(this,null,function*(){this._debug("#_removeSession()"),yield Xs(this.storage,this.storageKey),yield Xs(this.storage,this.storageKey+"-code-verifier"),yield Xs(this.storage,this.storageKey+"-user"),this.userStorage&&(yield Xs(this.userStorage,this.storageKey+"-user")),yield this._notifyAllSubscribers("SIGNED_OUT",null)})}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&Vs()&&(null===window||void 0===window?void 0:window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(Tx){}}_startAutoRefresh(){return p(this,null,function*(){yield this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),ps);this.autoRefreshTicker=e,e&&"object"==typeof e&&"function"==typeof e.unref?e.unref():"undefined"!=typeof Deno&&"function"==typeof Deno.unrefTimer&&Deno.unrefTimer(e),setTimeout(()=>p(this,null,function*(){yield this.initializePromise,yield this._autoRefreshTokenTick()}),0)})}_stopAutoRefresh(){return p(this,null,function*(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)})}startAutoRefresh(){return p(this,null,function*(){this._removeVisibilityChangedCallback(),yield this._startAutoRefresh()})}stopAutoRefresh(){return p(this,null,function*(){this._removeVisibilityChangedCallback(),yield this._stopAutoRefresh()})}_autoRefreshTokenTick(){return p(this,null,function*(){this._debug("#_autoRefreshTokenTick()","begin");try{yield this._acquireLock(0,()=>p(this,null,function*(){try{const e=Date.now();try{return yield this._useSession(t=>p(this,null,function*(){const{data:{session:s}}=t;if(!s||!s.refresh_token||!s.expires_at)return void this._debug("#_autoRefreshTokenTick()","no session");const i=Math.floor((1e3*s.expires_at-e)/ps);this._debug("#_autoRefreshTokenTick()",`access token expires in ${i} ticks, a tick lasts 30000ms, refresh threshold is 3 ticks`),i<=3&&(yield this._callRefreshToken(s.refresh_token))}))}catch(Tx){}}finally{this._debug("#_autoRefreshTokenTick()","end")}}))}catch(Tx){if(!(Tx.isAcquireTimeout||Tx instanceof Si))throw Tx;this._debug("auto refresh token tick lock not available")}})}_handleVisibilityChange(){return p(this,null,function*(){if(this._debug("#_handleVisibilityChange()"),!Vs()||!(null===window||void 0===window?void 0:window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=()=>p(this,null,function*(){return yield this._onVisibilityChanged(!1)}),null===window||void 0===window||window.addEventListener("visibilitychange",this.visibilityChangedCallback),yield this._onVisibilityChanged(!0)}catch(e){}})}_onVisibilityChanged(e){return p(this,null,function*(){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),"visible"===document.visibilityState?(this.autoRefreshToken&&this._startAutoRefresh(),e||(yield this.initializePromise,yield this._acquireLock(-1,()=>p(this,null,function*(){"visible"===document.visibilityState?yield this._recoverAndRefresh():this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting")})))):"hidden"===document.visibilityState&&this.autoRefreshToken&&this._stopAutoRefresh()})}_getUrlForProvider(e,t,s){return p(this,null,function*(){const i=[`provider=${encodeURIComponent(t)}`];if((null==s?void 0:s.redirectTo)&&i.push(`redirect_to=${encodeURIComponent(s.redirectTo)}`),(null==s?void 0:s.scopes)&&i.push(`scopes=${encodeURIComponent(s.scopes)}`),"pkce"===this.flowType){const[e,t]=yield si(this.storage,this.storageKey),s=new URLSearchParams({code_challenge:`${encodeURIComponent(e)}`,code_challenge_method:`${encodeURIComponent(t)}`});i.push(s.toString())}if(null==s?void 0:s.queryParams){const e=new URLSearchParams(s.queryParams);i.push(e.toString())}return(null==s?void 0:s.skipBrowserRedirect)&&i.push(`skip_http_redirect=${s.skipBrowserRedirect}`),`${e}?${i.join("&")}`})}_unenroll(e){return p(this,null,function*(){try{return yield this._useSession(t=>p(this,null,function*(){var s;const{data:i,error:n}=t;return n?{data:null,error:n}:yield ui(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:null===(s=null==i?void 0:i.session)||void 0===s?void 0:s.access_token})}))}catch(t){if(Ss(t))return{data:null,error:t};throw t}})}_enroll(e){return p(this,null,function*(){try{return yield this._useSession(t=>p(this,null,function*(){var s,i;const{data:n,error:r}=t;if(r)return{data:null,error:r};const a=Object.assign({friendly_name:e.friendlyName,factor_type:e.factorType},"phone"===e.factorType?{phone:e.phone}:{issuer:e.issuer}),{data:o,error:l}=yield ui(this.fetch,"POST",`${this.url}/factors`,{body:a,headers:this.headers,jwt:null===(s=null==n?void 0:n.session)||void 0===s?void 0:s.access_token});return l?{data:null,error:l}:("totp"===e.factorType&&(null===(i=null==o?void 0:o.totp)||void 0===i?void 0:i.qr_code)&&(o.totp.qr_code=`data:image/svg+xml;utf-8,${o.totp.qr_code}`),{data:o,error:null})}))}catch(t){if(Ss(t))return{data:null,error:t};throw t}})}_verify(e){return p(this,null,function*(){return this._acquireLock(-1,()=>p(this,null,function*(){try{return yield this._useSession(t=>p(this,null,function*(){var s;const{data:i,error:n}=t;if(n)return{data:null,error:n};const{data:r,error:a}=yield ui(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:null===(s=null==i?void 0:i.session)||void 0===s?void 0:s.access_token});return a?{data:null,error:a}:(yield this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+r.expires_in},r)),yield this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",r),{data:r,error:a})}))}catch(t){if(Ss(t))return{data:null,error:t};throw t}}))})}_challenge(e){return p(this,null,function*(){return this._acquireLock(-1,()=>p(this,null,function*(){try{return yield this._useSession(t=>p(this,null,function*(){var s;const{data:i,error:n}=t;return n?{data:null,error:n}:yield ui(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{body:{channel:e.channel},headers:this.headers,jwt:null===(s=null==i?void 0:i.session)||void 0===s?void 0:s.access_token})}))}catch(t){if(Ss(t))return{data:null,error:t};throw t}}))})}_challengeAndVerify(e){return p(this,null,function*(){const{data:t,error:s}=yield this._challenge({factorId:e.factorId});return s?{data:null,error:s}:yield this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})})}_listFactors(){return p(this,null,function*(){const{data:{user:e},error:t}=yield this.getUser();if(t)return{data:null,error:t};const s=(null==e?void 0:e.factors)||[],i=s.filter(e=>"totp"===e.factor_type&&"verified"===e.status),n=s.filter(e=>"phone"===e.factor_type&&"verified"===e.status);return{data:{all:s,totp:i,phone:n},error:null}})}_getAuthenticatorAssuranceLevel(){return p(this,null,function*(){return this._acquireLock(-1,()=>p(this,null,function*(){return yield this._useSession(e=>p(this,null,function*(){var t,s;const{data:{session:i},error:n}=e;if(n)return{data:null,error:n};if(!i)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const{payload:r}=Zs(i.access_token);let a=null;r.aal&&(a=r.aal);let o=a;(null!==(s=null===(t=i.user.factors)||void 0===t?void 0:t.filter(e=>"verified"===e.status))&&void 0!==s?s:[]).length>0&&(o="aal2");return{data:{currentLevel:a,nextLevel:o,currentAuthenticationMethods:r.amr||[]},error:null}}))}))})}fetchJwk(e){return p(this,arguments,function*(e,t={keys:[]}){let s=t.keys.find(t=>t.kid===e);if(s)return s;const i=Date.now();if(s=this.jwks.keys.find(t=>t.kid===e),s&&this.jwks_cached_at+6e5>i)return s;const{data:n,error:r}=yield ui(this.fetch,"GET",`${this.url}/.well-known/jwks.json`,{headers:this.headers});if(r)throw r;return n.keys&&0!==n.keys.length?(this.jwks=n,this.jwks_cached_at=i,s=n.keys.find(t=>t.kid===e),s||null):null})}getClaims(e){return p(this,arguments,function*(e,t={}){try{let s=e;if(!s){const{data:e,error:t}=yield this.getSession();if(t||!e.session)return{data:null,error:t};s=e.session.access_token}const{header:i,payload:n,signature:r,raw:{header:a,payload:o}}=Zs(s);(null==t?void 0:t.allowExpired)||function(e){if(!e)throw new Error("Missing exp claim");if(e<=Math.floor(Date.now()/1e3))throw new Error("JWT has expired")}(n.exp);const l=i.alg&&!i.alg.startsWith("HS")&&i.kid&&"crypto"in globalThis&&"subtle"in globalThis.crypto?yield this.fetchJwk(i.kid,(null==t?void 0:t.keys)?{keys:t.keys}:null==t?void 0:t.jwks):null;if(!l){const{error:e}=yield this.getUser(s);if(e)throw e;return{data:{claims:n,header:i,signature:r},error:null}}const c=function(e){switch(e){case"RS256":return{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}};case"ES256":return{name:"ECDSA",namedCurve:"P-256",hash:{name:"SHA-256"}};default:throw new Error("Invalid alg claim")}}(i.alg),d=yield crypto.subtle.importKey("jwk",l,c,!0,["verify"]);if(!(yield crypto.subtle.verify(c,d,r,zs(`${a}.${o}`))))throw new Rs("Invalid JWT signature");return{data:{claims:n,header:i,signature:r},error:null}}catch(s){if(Ss(s))return{data:null,error:s};throw s}})}}Ai.nextInstanceID=0;const Ei=Ai;class ji extends Ei{constructor(e){super(e)}}var Pi=function(e,t,s,i){return new(s||(s=Promise))(function(n,r){function a(e){try{l(i.next(e))}catch(Tx){r(Tx)}}function o(e){try{l(i.throw(e))}catch(Tx){r(Tx)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(a,o)}l((i=i.apply(e,t||[])).next())})};class Ii{constructor(e,t,s){var i,n,r;this.supabaseUrl=e,this.supabaseKey=t;const a=function(e){const t=null==e?void 0:e.trim();if(!t)throw new Error("supabaseUrl is required.");if(!t.match(/^https?:\/\//i))throw new Error("Invalid supabaseUrl: Must be a valid HTTP or HTTPS URL.");try{return new URL((s=t).endsWith("/")?s:s+"/")}catch(i){throw Error("Invalid supabaseUrl: Provided URL is malformed.")}var s}(e);if(!t)throw new Error("supabaseKey is required.");this.realtimeUrl=new URL("realtime/v1",a),this.realtimeUrl.protocol=this.realtimeUrl.protocol.replace("http","ws"),this.authUrl=new URL("auth/v1",a),this.storageUrl=new URL("storage/v1",a),this.functionsUrl=new URL("functions/v1",a);const o=`sb-${a.hostname.split(".")[0]}-auth-token`,l=function(e,t){var s,i;const{db:n,auth:r,realtime:a,global:o}=e,{db:l,auth:c,realtime:d,global:u}=t,h={db:Object.assign(Object.assign({},l),n),auth:Object.assign(Object.assign({},c),r),realtime:Object.assign(Object.assign({},d),a),storage:{},global:Object.assign(Object.assign(Object.assign({},u),o),{headers:Object.assign(Object.assign({},null!==(s=null==u?void 0:u.headers)&&void 0!==s?s:{}),null!==(i=null==o?void 0:o.headers)&&void 0!==i?i:{})}),accessToken:()=>fs(this,void 0,void 0,function*(){return""})};return e.accessToken?h.accessToken=e.accessToken:delete h.accessToken,h}(null!=s?s:{},{db:ls,realtime:ds,auth:Object.assign(Object.assign({},cs),{storageKey:o}),global:os});this.storageKey=null!==(i=l.auth.storageKey)&&void 0!==i?i:"",this.headers=null!==(n=l.global.headers)&&void 0!==n?n:{},l.accessToken?(this.accessToken=l.accessToken,this.auth=new Proxy({},{get:(e,t)=>{throw new Error(`@supabase/supabase-js: Supabase Client is configured with the accessToken option, accessing supabase.auth.${String(t)} is not possible`)}})):this.auth=this._initSupabaseAuthClient(null!==(r=l.auth)&&void 0!==r?r:{},this.headers,l.global.fetch),this.fetch=hs(t,this._getAccessToken.bind(this),l.global.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers,accessToken:this._getAccessToken.bind(this)},l.realtime)),this.rest=new $e(new URL("rest/v1",a).href,{headers:this.headers,schema:l.db.schema,fetch:this.fetch}),this.storage=new rs(this.storageUrl.href,this.headers,this.fetch,null==s?void 0:s.storage),l.accessToken||this._listenForAuthEvents()}get functions(){return new ie(this.functionsUrl.href,{headers:this.headers,customFetch:this.fetch})}from(e){return this.rest.from(e)}schema(e){return this.rest.schema(e)}rpc(e,t={},s={}){return this.rest.rpc(e,t,s)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,t;return Pi(this,void 0,void 0,function*(){if(this.accessToken)return yield this.accessToken();const{data:s}=yield this.auth.getSession();return null!==(t=null===(e=s.session)||void 0===e?void 0:e.access_token)&&void 0!==t?t:this.supabaseKey})}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:i,userStorage:n,storageKey:r,flowType:a,lock:o,debug:l},c,d){const u={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new ji({url:this.authUrl.href,headers:Object.assign(Object.assign({},u),c),storageKey:r,autoRefreshToken:e,persistSession:t,detectSessionInUrl:s,storage:i,userStorage:n,flowType:a,lock:o,debug:l,fetch:d,hasCustomAuthorizationHeader:Object.keys(this.headers).some(e=>"authorization"===e.toLowerCase())})}_initRealtimeClient(e){return new Ot(this.realtimeUrl.href,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},null==e?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((e,t)=>{this._handleTokenChanged(e,"CLIENT",null==t?void 0:t.access_token)})}_handleTokenChanged(e,t,s){"TOKEN_REFRESHED"!==e&&"SIGNED_IN"!==e||this.changedAccessToken===s?"SIGNED_OUT"===e&&(this.realtime.setAuth(),"STORAGE"==t&&this.auth.signOut(),this.changedAccessToken=void 0):this.changedAccessToken=s}}const Li=(e,t,s)=>new Ii(e,t,s);!function(){if("undefined"!=typeof window)return!1;if("undefined"==typeof process)return!1;const e=process.version;if(null==e)return!1;const t=e.match(/^v(\d+)\./);!!t&&parseInt(t[1],10)}();const Ri="http://localhost:54321",Oi="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0",Di=(()=>{try{return Ri.includes("example.")?Li("http://localhost:54321","dummy-key",{auth:{detectSessionInUrl:!1,persistSession:!1,autoRefreshToken:!1,storageKey:"carexps-auth-fallback"}}):Li(Ri,Oi,{auth:{detectSessionInUrl:!1,persistSession:!1,autoRefreshToken:!1,storageKey:"carexps-auth"},realtime:{params:{eventsPerSecond:10},logger:(e,t,s)=>{}},global:{headers:{"X-Client-Info":"carexps-healthcare-crm/1.0.0",Authorization:`Bearer ${Oi}`}}})}catch(e){return Li("http://localhost:54321","dummy-key",{auth:{detectSessionInUrl:!1,persistSession:!1,autoRefreshToken:!1,storageKey:"carexps-auth-fallback"}})}})();Li(Ri,"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU",{auth:{autoRefreshToken:!1,persistSession:!1}});const Mi={encryptionEnabled:!0,auditLoggingEnabled:!0,dataRetentionDays:2555,sessionTimeoutMinutes:15,maxFailedLoginAttempts:3,passwordExpirationDays:90,requireMFA:!0},Ui={phiKey:"dummy_key_for_dev",auditKey:"dummy_key_for_dev",algorithm:"AES-256-GCM"},Fi=Object.freeze(Object.defineProperty({__proto__:null,encryptionConfig:Ui,hipaaConfig:Mi,supabase:Di},Symbol.toStringTag,{value:"Module"}));class Bi{static uploadAvatar(e,t){return p(this,arguments,function*(e,t,s={}){try{yield W.logSecurityEvent("AVATAR_UPLOAD_START","users",!0,{userId:e});const i=yield this.processImage(t,s);if(!i.success)return{status:"error",error:i.error};yield this.removeAvatar(e,!1);const n=yield this.uploadToSupabaseStorage(e,i.blob);if("error"===n.status)return n;const r=n.data,a=n.storagePath,o=yield this.synchronizeAvatarData(e,{url:r,storagePath:a,uploadedAt:(new Date).toISOString(),synchronized:!0});return"error"===o.status?(yield this.cleanupStorageFile(a),o):(yield W.logSecurityEvent("AVATAR_UPLOAD_SUCCESS","users",!0,{userId:e,avatarUrl:r,fileSize:i.blob.size}),{status:"success",data:r})}catch(i){return yield W.logSecurityEvent("AVATAR_UPLOAD_ERROR","users",!1,{userId:e,error:i.message}),{status:"error",error:`Avatar upload failed: ${i.message}`}}})}static removeAvatar(e,t=!0){return p(this,null,function*(){try{t&&(yield W.logSecurityEvent("AVATAR_REMOVE_START","users",!0,{userId:e}));const s=yield this.getAvatarInfo(e);return(null==s?void 0:s.storagePath)&&(yield this.cleanupStorageFile(s.storagePath)),yield this.synchronizeAvatarData(e,null),t&&(yield W.logSecurityEvent("AVATAR_REMOVE_SUCCESS","users",!0,{userId:e})),{status:"success"}}catch(s){return t&&(yield W.logSecurityEvent("AVATAR_REMOVE_ERROR","users",!1,{userId:e,error:s.message})),{status:"error",error:`Avatar removal failed: ${s.message}`}}})}static getAvatarUrl(e){return p(this,null,function*(){try{const t=this.getLocalAvatarInfo(e);if(null==t?void 0:t.url)return t.url;const s=localStorage.getItem(`avatar_data_${e}`);return s||null}catch(t){const s=this.getLocalAvatarInfo(e);return(null==s?void 0:s.url)||null}})}static syncAvatarAcrossDevices(e){return p(this,null,function*(){try{yield W.logSecurityEvent("AVATAR_SYNC_START","users",!0,{userId:e});const{data:t,error:s}=yield Di.from("users").select("avatar_url").eq("id",e).single();if(s)return{status:"error",error:`Failed to sync avatar: ${s.message}`};const i=(null==t?void 0:t.avatar_url)||null;return i?(this.cacheAvatarLocally(e,i),yield this.updateLocalUserData(e,i)):(this.clearLocalAvatarCache(e),yield this.updateLocalUserData(e,null)),yield W.logSecurityEvent("AVATAR_SYNC_SUCCESS","users",!0,{userId:e,avatarUrl:i||"none"}),{status:"success",data:i}}catch(t){return yield W.logSecurityEvent("AVATAR_SYNC_ERROR","users",!1,{userId:e,error:t.message}),{status:"error",error:`Avatar sync failed: ${t.message}`}}})}static processImage(e,t){return p(this,null,function*(){try{const i=t.maxSize||this.MAX_FILE_SIZE,n=t.quality||this.DEFAULT_QUALITY,r=t.maxDimensions||this.DEFAULT_MAX_DIMENSIONS;let a;if("string"==typeof e){let t,i="image/png";if(e.startsWith("data:")){const s=e.match(/^data:([a-zA-Z0-9]+\/[a-zA-Z0-9-.+]+).*,(.*)$/);if(!s||3!==s.length)throw new Error("Invalid data URI format");i=s[1],t=s[2]}else t=e;try{const e=atob(t),s=new Uint8Array(e.length);for(let t=0;t<e.length;t++)s[t]=e.charCodeAt(t);a=new Blob([s],{type:i})}catch(s){throw new Error("Failed to decode base64 image data")}}else a=e;if(!this.SUPPORTED_FORMATS.includes(a.type))return{success:!1,error:"Unsupported image format. Please use JPEG, PNG, WebP, or GIF."};if(a.size>i)return{success:!1,error:`File size too large. Maximum size is ${Math.round(i/1024/1024)}MB.`};return{success:!0,blob:yield this.optimizeImage(a,r,n)}}catch(s){return{success:!1,error:`Image processing failed: ${s.message}`}}})}static optimizeImage(e,t,s){return p(this,null,function*(){return new Promise((i,n)=>{const r=new Image,a=document.createElement("canvas"),o=a.getContext("2d");if(!o)return void n(new Error("Canvas context not available"));r.onload=()=>{let{width:e,height:l}=r;const c=e/l;(e>t.width||l>t.height)&&(e>l?(e=t.width,l=e/c):(l=t.height,e=l*c)),a.width=e,a.height=l,o.fillStyle="#FFFFFF",o.fillRect(0,0,e,l),o.drawImage(r,0,0,e,l),a.toBlob(e=>{e?i(e):n(new Error("Image optimization failed"))},"image/jpeg",s)},r.onerror=()=>n(new Error("Failed to load image"));const l=new FileReader;l.onload=()=>{r.src=l.result},l.onerror=()=>n(new Error("Failed to read image data")),l.readAsDataURL(e)})})}static uploadToSupabaseStorage(e,t){return p(this,null,function*(){try{const s=`${e}/avatar_${Date.now()}.jpg`,{data:i,error:n}=yield Di.storage.from(this.STORAGE_BUCKET).upload(s,t,{cacheControl:"3600",upsert:!0,contentType:"image/jpeg"});if(n)return this.fallbackToLocalStorage(e,t);const{data:r}=Di.storage.from(this.STORAGE_BUCKET).getPublicUrl(s);return{status:"success",data:r.publicUrl,storagePath:s}}catch(s){return this.fallbackToLocalStorage(e,t)}})}static fallbackToLocalStorage(e,t){return p(this,null,function*(){try{const s=yield this.blobToBase64(t),i=`avatar_data_${e}`;return localStorage.setItem(i,s),{status:"success",data:s,storagePath:i}}catch(s){return{status:"error",error:`Fallback storage failed: ${s.message}`}}})}static blobToBase64(e){return p(this,null,function*(){return new Promise((t,s)=>{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=s,i.readAsDataURL(e)})})}static synchronizeAvatarData(e,t){return p(this,null,function*(){const s=[];try{const{error:r}=yield Di.from("users").update({avatar_url:(null==t?void 0:t.url)||null,updated_at:(new Date).toISOString()}).eq("id",e);r&&s.push(`Database update failed: ${r.message}`),t?localStorage.setItem(`avatar_${e}`,JSON.stringify(t)):localStorage.removeItem(`avatar_${e}`),yield this.updateLocalUserData(e,(null==t?void 0:t.url)||null);const a=localStorage.getItem(`userProfile_${e}`);if(a)try{const s=JSON.parse(a);(null==t?void 0:t.url)?(s.avatar=t.url,s.updated_at=(new Date).toISOString()):(delete s.avatar,s.updated_at=(new Date).toISOString()),localStorage.setItem(`userProfile_${e}`,JSON.stringify(s))}catch(i){s.push(`User profile update failed: ${i}`)}try{const s=localStorage.getItem(`settingsUser_${e}`);if(s){const i=JSON.parse(s);(null==t?void 0:t.url)?i.avatar=t.url:delete i.avatar,localStorage.setItem(`settingsUser_${e}`,JSON.stringify(i))}}catch(n){}return s.length>0&&1===s.length&&s[0].includes("Database update failed")?{status:"success"}:s.length>0?{status:"error",error:`Sync partially failed: ${s.join(", ")}`}:{status:"success"}}catch(r){return{status:"error",error:`Synchronization failed: ${r.message}`}}})}static updateLocalUserData(e,t){return p(this,null,function*(){try{const i=localStorage.getItem("systemUsers");if(i){const s=JSON.parse(i),n=s.findIndex(t=>t.id===e);n>=0&&(t?s[n].avatar=t:delete s[n].avatar,localStorage.setItem("systemUsers",JSON.stringify(s)))}const n=localStorage.getItem("currentUser");if(n)try{const s=JSON.parse(n);s.id===e&&(t?s.avatar=t:delete s.avatar,localStorage.setItem("currentUser",JSON.stringify(s)),window.dispatchEvent(new Event("userDataUpdated")),window.dispatchEvent(new StorageEvent("storage",{key:"currentUser",newValue:JSON.stringify(s),storageArea:localStorage})))}catch(s){}}catch(i){}})}static getLocalAvatarInfo(e){try{const t=localStorage.getItem(`avatar_${e}`);return t?JSON.parse(t):null}catch(t){return null}}static cacheAvatarLocally(e,t){try{const s={url:t,storagePath:this.extractStoragePathFromUrl(t),uploadedAt:(new Date).toISOString(),synchronized:!0};localStorage.setItem(`avatar_${e}`,JSON.stringify(s))}catch(s){}}static clearLocalAvatarCache(e){localStorage.removeItem(`avatar_${e}`)}static getAvatarInfo(e){return p(this,null,function*(){const t=this.getLocalAvatarInfo(e);if(t)return t;try{const{data:t}=yield Di.from("users").select("avatar_url").eq("id",e).single();if(null==t?void 0:t.avatar_url)return{url:t.avatar_url,storagePath:this.extractStoragePathFromUrl(t.avatar_url),uploadedAt:(new Date).toISOString(),synchronized:!0}}catch(s){}return null})}static extractStoragePathFromUrl(e){try{const t=new URL(e).pathname.split("/"),s=t.findIndex(e=>e===this.STORAGE_BUCKET);if(s>=0&&s<t.length-1)return t.slice(s+1).join("/")}catch(t){}return""}static cleanupStorageFile(e){return p(this,null,function*(){try{if(e){const{error:t}=yield Di.storage.from(this.STORAGE_BUCKET).remove([e])}}catch(t){}})}static verifyAvatarUrl(e){return p(this,null,function*(){try{if(e.startsWith("data:"))return!0;return(yield fetch(e,{method:"HEAD"})).ok}catch(t){return!1}})}static initialize(){return p(this,null,function*(){try{const{data:e}=yield Di.storage.listBuckets();null==e||e.find(e=>e.name===this.STORAGE_BUCKET)}catch(e){}})}static cleanupOrphanedAvatars(){return p(this,null,function*(){try{const{data:e,error:t}=yield Di.storage.from(this.STORAGE_BUCKET).list();if(t)return{status:"error",error:`Failed to list storage files: ${t.message}`};const{data:s,error:i}=yield Di.from("users").select("id, avatar_url").not("avatar_url","is",null);if(i)return{status:"error",error:`Failed to get users: ${i.message}`};const n=new Set((null==s?void 0:s.map(e=>this.extractStoragePathFromUrl(e.avatar_url)).filter(Boolean))||[]),r=[];if(null==e||e.forEach(e=>{n.has(e.name)||r.push(e.name)}),r.length>0){const{error:e}=yield Di.storage.from(this.STORAGE_BUCKET).remove(r)}return yield W.logSecurityEvent("AVATAR_CLEANUP","storage",!0,{filesDeleted:r.length,totalFiles:(null==e?void 0:e.length)||0}),{status:"success",data:r.length}}catch(e){return{status:"error",error:`Cleanup failed: ${e.message}`}}})}}f(Bi,"STORAGE_BUCKET","avatars"),f(Bi,"MAX_FILE_SIZE",5242880),f(Bi,"SUPPORTED_FORMATS",["image/jpeg","image/png","image/webp","image/gif"]),f(Bi,"DEFAULT_QUALITY",.8),f(Bi,"DEFAULT_MAX_DIMENSIONS",{width:512,height:512});const qi=Bi;class $i{static loadUserProfile(e){return p(this,null,function*(){try{const s=this.cache.get(e);if(s&&Date.now()-s.timestamp<this.CACHE_TTL)return{status:"success",data:this.transformToUserProfileData(s.data)};const i=localStorage.getItem("currentUser");if(i)try{const t=JSON.parse(i);if(t.id===e){return{status:"success",data:{id:t.id,email:t.email,name:t.name,role:t.role||"staff",avatar:t.avatar,mfa_enabled:t.mfa_enabled||!1,settings:t.settings||{}}}}}catch(t){}return{status:"success",data:null}}catch(s){return{status:"error",error:s.message}}})}static saveUserProfile(e){return p(this,null,function*(){try{const i=e.id;yield W.logSecurityEvent("USER_PROFILE_UPDATE","user_profiles",!0,{userId:i});const n=(new Date).toISOString(),r=u(d({},e),{created_at:n,updated_at:n});localStorage.setItem(`userProfile_${i}`,JSON.stringify(r));const a=localStorage.getItem("systemUsers");let o=[];try{o=a?JSON.parse(a):[]}catch(t){o=[]}const l=o.findIndex(e=>e.id===i);if(l>=0){const e=o[l];o[l]=u(d({},r),{created_at:e.created_at||n,updated_at:n})}else o.push(r);localStorage.setItem("systemUsers",JSON.stringify(o));const c=localStorage.getItem("currentUser");if(c)try{const t=JSON.parse(c);if(t.id===i){const s=u(d(d({},t),e),{updated_at:n});localStorage.setItem("currentUser",JSON.stringify(s)),window.dispatchEvent(new CustomEvent("userProfileUpdated",{detail:s}))}}catch(t){}if(e.avatar)try{const t=yield this.saveAvatar(i,e.avatar);"success"===t.status&&(e.avatar=t.data)}catch(s){}else{const t=yield qi.getAvatarUrl(i);t&&(e.avatar=t)}return this.cache.delete(i),{status:"success",data:e}}catch(t){return yield W.logSecurityEvent("USER_PROFILE_UPDATE_FAILED","user_profiles",!1,{userId:e.id,error:t.message}),{status:"error",error:t.message}}})}static syncUserSettings(e,t){return p(this,null,function*(){try{yield W.logSecurityEvent("USER_SETTINGS_SYNC","user_settings",!0,{userId:e});const s={user_id:e,updated_at:(new Date).toISOString(),last_synced:(new Date).toISOString()};t.theme&&(s.theme=t.theme),t.notifications&&(s.notifications=t.notifications),(t.retellApiKey||t.callAgentId||t.smsAgentId)&&(s.retell_config={api_key:t.retellApiKey?yield z.encrypt(t.retellApiKey):void 0,call_agent_id:t.callAgentId,sms_agent_id:t.smsAgentId}),s.ui_preferences=d({dashboard_layout:t.dashboard_layout,sidebar_collapsed:t.sidebar_collapsed,preferred_view:t.preferred_view},t.ui_preferences);const{data:i,error:n}=yield Di.from("user_settings").upsert(s).select().single();if(n)throw new Error(`Failed to sync settings: ${n.message}`);return this.cache.delete(e),{status:"success",data:i}}catch(s){return yield W.logSecurityEvent("USER_SETTINGS_SYNC_FAILED","user_settings",!1,{userId:e,error:s.message}),{status:"error",error:s.message}}})}static loadSystemUsers(){return p(this,null,function*(){try{yield W.logSecurityEvent("SYSTEM_USERS_ACCESS","users",!0);const t=(new Date).toISOString(),s=()=>[{id:"super-user-456",email:"elmfarrell@yahoo.com",name:"Dr. Farrell",role:"super_user",mfa_enabled:!1,settings:{theme:"dark",notifications:{}},created_at:t,updated_at:t},{id:"pierre-user-789",email:"pierre@phaetonai.com",name:"Pierre PhaetonAI",role:"super_user",mfa_enabled:!1,settings:{theme:"light",notifications:{calls:!0,sms:!0,system:!0}},created_at:t,updated_at:t},{id:"guest-user-456",email:"guest@email.com",name:"Guest User",role:"staff",mfa_enabled:!1,settings:{theme:"light",notifications:{}},created_at:t,updated_at:t}],i=localStorage.getItem("systemUsers");let n=[];if(i)try{n=JSON.parse(i);let e=!1;n=n.map(s=>s.created_at&&s.updated_at?s:(e=!0,u(d({},s),{created_at:s.created_at||t,updated_at:s.updated_at||t})));n.some(e=>{if(["super-user-456","pierre-user-789","guest-user-456"].includes(e.id)){const t=new Date(e.created_at),s=new Date;return t.toDateString()!==s.toDateString()}return!1})&&(e=!0,n=n.map(e=>["super-user-456","pierre-user-789","guest-user-456"].includes(e.id)?u(d({},e),{created_at:t,updated_at:t}):e)),e&&localStorage.setItem("systemUsers",JSON.stringify(n))}catch(e){n=demoUsers}else n=demoUsers,localStorage.setItem("systemUsers",JSON.stringify(demoUsers));const r=localStorage.getItem("deletedUsers");let a=[];if(r)try{a=JSON.parse(r)}catch(e){}const o=s(),l=localStorage.getItem("deletedUserEmails");let c=[];if(l)try{c=JSON.parse(l)}catch(e){}o.forEach(e=>{const s=n.findIndex(t=>t.id===e.id),i=n.findIndex(t=>t.email.toLowerCase()===e.email.toLowerCase()),r=a.includes(e.id),o=c.includes(e.email.toLowerCase());if(!(r||o||i>=0&&s!==i))if(-1===s)-1===i&&n.push(e);else{const i=n[s];n[s]=u(d(d({},e),i),{id:e.id,email:e.email,created_at:i.created_at||e.created_at,updated_at:i.updated_at||t})}});const h=yield Promise.all(n.map(e=>p(this,null,function*(){try{const t=yield qi.getAvatarUrl(e.id);if(t)return u(d({},e),{avatar:t})}catch(t){}return e})));return localStorage.setItem("systemUsers",JSON.stringify(h)),{status:"success",data:h}}catch(t){return{status:"error",error:t instanceof Error?t.message:"Failed to load users"}}})}static userExistsByEmail(e){return p(this,null,function*(){try{const t=yield this.getUserByEmail(e);return"error"===t.status?{status:"error",error:t.error}:{status:"success",data:null!==t.data}}catch(t){return{status:"error",error:t.message}}})}static createUser(e){return p(this,null,function*(){try{yield W.logSecurityEvent("USER_CREATE","users",!0);const i=yield this.userExistsByEmail(e.email);if("error"===i.status)return{status:"error",error:`Failed to check for existing user: ${i.error}`};if(i.data)return{status:"error",error:`A user with email ${e.email} already exists`};let n;try{const{data:t,error:s}=yield Di.from("users").insert({email:e.email,name:e.name,role:e.role,mfa_enabled:e.mfa_enabled||!1,is_active:!0}).select().single();if(s||!t)throw new Error((null==s?void 0:s.message)||"Failed to create user in Supabase");n={id:t.id,email:t.email,name:t.name,role:t.role,mfa_enabled:t.mfa_enabled,settings:e.settings||{}},e.settings&&Object.keys(e.settings).length>0&&(yield this.syncUserSettings(t.id,e.settings))}catch(t){n={id:`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,email:e.email,name:e.name,role:e.role,mfa_enabled:e.mfa_enabled||!1,settings:e.settings||{},created_at:(new Date).toISOString()};const i=localStorage.getItem("systemUsers");let r=[];if(i)try{r=JSON.parse(i);if(r.find(t=>t.email.toLowerCase()===e.email.toLowerCase()))throw new Error(`User with email ${e.email} already exists in localStorage`)}catch(s){if(s instanceof Error&&s.message.includes("already exists"))throw s;r=[]}r.push(n),localStorage.setItem("systemUsers",JSON.stringify(r))}return yield W.logSecurityEvent("USER_CREATED","users",!0,{userId:n.id,email:e.email,role:e.role}),{status:"success",data:n}}catch(i){return yield W.logSecurityEvent("USER_CREATE_FAILED","users",!1,{email:e.email,error:i.message}),{status:"error",error:i.message}}})}static deleteUser(e){return p(this,null,function*(){try{yield W.logSecurityEvent("USER_DELETE","users",!0,{userId:e});const s=localStorage.getItem("systemUsers");if(s)try{const t=JSON.parse(s).filter(t=>t.id!==e);localStorage.setItem("systemUsers",JSON.stringify(t))}catch(t){}localStorage.removeItem(`userProfile_${e}`);const i=localStorage.getItem("deletedUsers");let n=[];if(i)try{n=JSON.parse(i)}catch(t){}n.includes(e)||(n.push(e),localStorage.setItem("deletedUsers",JSON.stringify(n)));const r=localStorage.getItem("deletedUserEmails");let a=[];if(r)try{a=JSON.parse(r)}catch(t){}const o=yield this.getUserEmailFromStorage(e);return o&&!a.includes(o.toLowerCase())&&(a.push(o.toLowerCase()),localStorage.setItem("deletedUserEmails",JSON.stringify(a))),this.cache.delete(e),yield W.logSecurityEvent("USER_DELETED","users",!0,{userId:e}),{status:"success"}}catch(s){return yield W.logSecurityEvent("USER_DELETE_FAILED","users",!1,{userId:e,error:s.message}),{status:"error",error:s.message}}})}static saveAvatar(e,t){return p(this,null,function*(){try{const s=yield qi.uploadAvatar(e,t);return"error"===s.status||this.cache.delete(e),s}catch(s){return yield W.logSecurityEvent("AVATAR_UPLOAD_FAILED","users",!1,{userId:e,error:s.message}),{status:"error",error:`Avatar upload failed: ${s.message}`}}})}static removeAvatar(e){return p(this,null,function*(){try{const t=yield qi.removeAvatar(e);return"error"===t.status?t:(this.cache.delete(e),{status:"success"})}catch(t){return yield W.logSecurityEvent("AVATAR_REMOVE_FAILED","users",!1,{userId:e,error:t.message}),{status:"error",error:`Avatar removal failed: ${t.message}`}}})}static getUserByEmail(e){return p(this,null,function*(){try{try{const{data:i,error:n}=yield Di.from("users").select("*").eq("email",e).eq("is_active",!0).single();if(!n&&i){let e=null;try{const{data:t}=yield Di.from("user_profiles").select("*").eq("user_id",i.id).single();e=t}catch(t){}let n=null;try{const{data:e}=yield Di.from("user_settings").select("*").eq("user_id",i.id).single();n=e}catch(s){}const r={user:i,profile:e,settings:n,permissions:[]};return{status:"success",data:this.transformToUserProfileData(r)}}if("PGRST116"!==n.code)throw new Error(`Failed to get user by email: ${n.message}`)}catch(i){}const r=localStorage.getItem("systemUsers");if(r)try{const t=JSON.parse(r).find(t=>t.email.toLowerCase()===e.toLowerCase());if(t)return{status:"success",data:t}}catch(n){}const a=Object.keys(localStorage).filter(e=>e.startsWith("userProfile_"));for(const t of a)try{const s=JSON.parse(localStorage.getItem(t)||"{}");if(s.email&&s.email.toLowerCase()===e.toLowerCase())return{status:"success",data:s}}catch(n){}return{status:"success",data:null}}catch(n){return{status:"error",error:n.message}}})}static syncUserAvatar(e){return p(this,null,function*(){try{const t=yield qi.syncAvatarAcrossDevices(e);return"success"===t.status&&this.cache.delete(e),t}catch(t){return{status:"error",error:`Avatar sync failed: ${t.message}`}}})}static getUserAvatar(e){return p(this,null,function*(){try{return yield qi.getAvatarUrl(e)}catch(t){return null}})}static removeDuplicateUsers(){return p(this,null,function*(){try{const e=localStorage.getItem("systemUsers");if(!e)return{status:"success",data:{removed:0,remaining:0}};let t=JSON.parse(e);const s=t.length,i=new Set,n=[];let r=0;t.sort((e,t)=>new Date(e.created_at||0).getTime()-new Date(t.created_at||0).getTime());for(const a of t){const e=a.email.toLowerCase();i.has(e)?r++:(i.add(e),n.push(a))}return localStorage.setItem("systemUsers",JSON.stringify(n)),yield W.logSecurityEvent("DUPLICATE_USERS_REMOVED","users",!0,{originalCount:s,removedCount:r,remainingCount:n.length}),{status:"success",data:{removed:r,remaining:n.length}}}catch(e){return yield W.logSecurityEvent("DUPLICATE_REMOVAL_FAILED","users",!1,{error:e.message}),{status:"error",error:e.message}}})}static clearCache(){this.cache.clear()}static updateUserSettings(e,t){return p(this,null,function*(){const s={updated_at:(new Date).toISOString()};t.theme&&(s.theme=t.theme),t.notifications&&(s.notifications=t.notifications),(t.retellApiKey||t.callAgentId||t.smsAgentId)&&(s.retell_config={api_key:t.retellApiKey?yield z.encrypt(t.retellApiKey):void 0,call_agent_id:t.callAgentId,sms_agent_id:t.smsAgentId});const{error:i}=yield Di.from("user_settings").upsert(d({user_id:e},s));if(i)throw new Error(`Failed to update settings: ${i.message}`)})}static fixProfileImagePersistence(e){return p(this,null,function*(){try{const s=yield qi.getAvatarUrl(e);if(s){(yield qi.syncAvatarAcrossDevices(e)).status;const i=localStorage.getItem(`userProfile_${e}`);if(i)try{const t=JSON.parse(i);t.avatar=s,t.updated_at=(new Date).toISOString(),localStorage.setItem(`userProfile_${e}`,JSON.stringify(t))}catch(t){}return window.dispatchEvent(new Event("userDataUpdated")),{status:"success",data:!0}}return{status:"success",data:!1}}catch(t){return{status:"error",error:t.message}}})}static getUserEmailFromStorage(e){return p(this,null,function*(){try{const s=localStorage.getItem("systemUsers");if(s){const t=JSON.parse(s).find(t=>t.id===e);if(null==t?void 0:t.email)return t.email}const i=localStorage.getItem(`userProfile_${e}`);if(i){const e=JSON.parse(i);if(null==e?void 0:e.email)return e.email}try{const{data:t}=yield Di.from("users").select("email").eq("id",e).single();return(null==t?void 0:t.email)||null}catch(t){return null}}catch(t){return null}})}static transformToUserProfileData(e){const{user:t,profile:s,settings:i}=e;let n={};if(null==i?void 0:i.retell_config){const e=i.retell_config;n={retellApiKey:e.api_key,callAgentId:e.call_agent_id,smsAgentId:e.sms_agent_id}}return{id:t.id,email:t.email,name:t.name,role:t.role,avatar:t.avatar_url||void 0,mfa_enabled:t.mfa_enabled,settings:d(d({theme:(null==i?void 0:i.theme)||"light",notifications:(null==i?void 0:i.notifications)||{}},n),(null==i?void 0:i.ui_preferences)||{})}}}f($i,"cache",new Map),f($i,"CACHE_TTL",3e5);const zi=$i;
//! otpauth 9.4.1 | (c) Héctor Molinero Fernández | MIT | https://github.com/hectorm/otpauth
//! noble-hashes 1.8.0 | (c) Paul Miller | MIT | https://github.com/paulmillr/noble-hashes
function Hi(e){if(!Number.isSafeInteger(e)||e<0)throw new Error("positive integer expected, got "+e)}function Vi(e,...t){if(!((s=e)instanceof Uint8Array||ArrayBuffer.isView(s)&&"Uint8Array"===s.constructor.name))throw new Error("Uint8Array expected");
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
var s;if(t.length>0&&!t.includes(e.length))throw new Error("Uint8Array expected of length "+t+", got length="+e.length)}function Gi(e,t=!0){if(e.destroyed)throw new Error("Hash instance has been destroyed");if(t&&e.finished)throw new Error("Hash#digest() has already been called")}function Ji(e,t){Vi(e);const s=t.outputLen;if(e.length<s)throw new Error("digestInto() expects output buffer of length at least "+s)}function Wi(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}function Ki(e){return new DataView(e.buffer,e.byteOffset,e.byteLength)}function Yi(e,t){return e<<32-t|e>>>t}function Xi(e,t){return e<<t|e>>>32-t>>>0}function Qi(e){return e<<24&4278190080|e<<8&16711680|e>>>8&65280|e>>>24&255}const Zi=(()=>68===new Uint8Array(new Uint32Array([287454020]).buffer)[0])()?e=>e:function(e){for(let t=0;t<e.length;t++)e[t]=Qi(e[t]);return e};function en(e){return"string"==typeof e&&(e=function(e){if("string"!=typeof e)throw new Error("string expected");return new Uint8Array((new TextEncoder).encode(e))}(e)),Vi(e),e}class tn{}function sn(e){const t=t=>e().update(en(t)).digest(),s=e();return t.outputLen=s.outputLen,t.blockLen=s.blockLen,t.create=()=>e(),t}class nn extends tn{update(e){return Gi(this),this.iHash.update(e),this}digestInto(e){Gi(this),Vi(e,this.outputLen),this.finished=!0,this.iHash.digestInto(e),this.oHash.update(e),this.oHash.digestInto(e),this.destroy()}digest(){const e=new Uint8Array(this.oHash.outputLen);return this.digestInto(e),e}_cloneInto(e){e||(e=Object.create(Object.getPrototypeOf(this),{}));const{oHash:t,iHash:s,finished:i,destroyed:n,blockLen:r,outputLen:a}=this;return e.finished=i,e.destroyed=n,e.blockLen=r,e.outputLen=a,e.oHash=t._cloneInto(e.oHash),e.iHash=s._cloneInto(e.iHash),e}clone(){return this._cloneInto()}destroy(){this.destroyed=!0,this.oHash.destroy(),this.iHash.destroy()}constructor(e,t){super(),this.finished=!1,this.destroyed=!1,function(e){if("function"!=typeof e||"function"!=typeof e.create)throw new Error("Hash should be wrapped by utils.createHasher");Hi(e.outputLen),Hi(e.blockLen)}(e);const s=en(t);if(this.iHash=e.create(),"function"!=typeof this.iHash.update)throw new Error("Expected instance of class which extends utils.Hash");this.blockLen=this.iHash.blockLen,this.outputLen=this.iHash.outputLen;const i=this.blockLen,n=new Uint8Array(i);n.set(s.length>i?e.create().update(s).digest():s);for(let r=0;r<n.length;r++)n[r]^=54;this.iHash.update(n),this.oHash=e.create();for(let r=0;r<n.length;r++)n[r]^=106;this.oHash.update(n),Wi(n)}}const rn=(e,t,s)=>new nn(e,t).update(s).digest();function an(e,t,s){return e&t^~e&s}function on(e,t,s){return e&t^e&s^t&s}rn.create=(e,t)=>new nn(e,t);class ln extends tn{update(e){Gi(this),Vi(e=en(e));const{view:t,buffer:s,blockLen:i}=this,n=e.length;for(let r=0;r<n;){const a=Math.min(i-this.pos,n-r);if(a===i){const t=Ki(e);for(;i<=n-r;r+=i)this.process(t,r);continue}s.set(e.subarray(r,r+a),this.pos),this.pos+=a,r+=a,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Gi(this),Ji(e,this),this.finished=!0;const{buffer:t,view:s,blockLen:i,isLE:n}=this;let{pos:r}=this;t[r++]=128,Wi(this.buffer.subarray(r)),this.padOffset>i-r&&(this.process(s,0),r=0);for(let d=r;d<i;d++)t[d]=0;!function(e,t,s,i){if("function"==typeof e.setBigUint64)return e.setBigUint64(t,s,i);const n=BigInt(32),r=BigInt(4294967295),a=Number(s>>n&r),o=Number(s&r),l=i?4:0,c=i?0:4;e.setUint32(t+l,a,i),e.setUint32(t+c,o,i)}(s,i-8,BigInt(8*this.length),n),this.process(s,0);const a=Ki(e),o=this.outputLen;if(o%4)throw new Error("_sha2: outputLen should be aligned to 32bit");const l=o/4,c=this.get();if(l>c.length)throw new Error("_sha2: outputLen bigger than state");for(let d=0;d<l;d++)a.setUint32(4*d,c[d],n)}digest(){const{buffer:e,outputLen:t}=this;this.digestInto(e);const s=e.slice(0,t);return this.destroy(),s}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());const{blockLen:t,buffer:s,length:i,finished:n,destroyed:r,pos:a}=this;return e.destroyed=r,e.finished=n,e.length=i,e.pos=a,i%t&&e.buffer.set(s),e}clone(){return this._cloneInto()}constructor(e,t,s,i){super(),this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.blockLen=e,this.outputLen=t,this.padOffset=s,this.isLE=i,this.buffer=new Uint8Array(e),this.view=Ki(this.buffer)}}const cn=Uint32Array.from([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),dn=Uint32Array.from([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428]),un=Uint32Array.from([3418070365,3238371032,1654270250,914150663,2438529370,812702999,355462360,4144912697,1731405415,4290775857,2394180231,1750603025,3675008525,1694076839,1203062813,3204075428]),hn=Uint32Array.from([1779033703,4089235720,3144134277,2227873595,1013904242,4271175723,2773480762,1595750129,1359893119,2917565137,2600822924,725511199,528734635,4215389547,1541459225,327033209]),fn=Uint32Array.from([1732584193,4023233417,2562383102,271733878,3285377520]),mn=new Uint32Array(80);class pn extends ln{get(){const{A:e,B:t,C:s,D:i,E:n}=this;return[e,t,s,i,n]}set(e,t,s,i,n){this.A=0|e,this.B=0|t,this.C=0|s,this.D=0|i,this.E=0|n}process(e,t){for(let o=0;o<16;o++,t+=4)mn[o]=e.getUint32(t,!1);for(let o=16;o<80;o++)mn[o]=Xi(mn[o-3]^mn[o-8]^mn[o-14]^mn[o-16],1);let{A:s,B:i,C:n,D:r,E:a}=this;for(let o=0;o<80;o++){let e,t;o<20?(e=an(i,n,r),t=1518500249):o<40?(e=i^n^r,t=1859775393):o<60?(e=on(i,n,r),t=2400959708):(e=i^n^r,t=3395469782);const l=Xi(s,5)+e+a+t+mn[o]|0;a=r,r=n,n=Xi(i,30),i=s,s=l}s=s+this.A|0,i=i+this.B|0,n=n+this.C|0,r=r+this.D|0,a=a+this.E|0,this.set(s,i,n,r,a)}roundClean(){Wi(mn)}destroy(){this.set(0,0,0,0,0),Wi(this.buffer)}constructor(){super(64,20,8,!1),this.A=0|fn[0],this.B=0|fn[1],this.C=0|fn[2],this.D=0|fn[3],this.E=0|fn[4]}}const gn=sn(()=>new pn),vn=BigInt(l(2,32)-1),yn=BigInt(32);function bn(e,t=!1){return t?{h:Number(e&vn),l:Number(e>>yn&vn)}:{h:0|Number(e>>yn&vn),l:0|Number(e&vn)}}function xn(e,t=!1){const s=e.length;let i=new Uint32Array(s),n=new Uint32Array(s);for(let r=0;r<s;r++){const{h:s,l:a}=bn(e[r],t);[i[r],n[r]]=[s,a]}return[i,n]}const wn=(e,t,s)=>e>>>s,Sn=(e,t,s)=>e<<32-s|t>>>s,kn=(e,t,s)=>e>>>s|t<<32-s,_n=(e,t,s)=>e<<32-s|t>>>s,Cn=(e,t,s)=>e<<64-s|t>>>s-32,Nn=(e,t,s)=>e>>>s-32|t<<64-s;function Tn(e,t,s,i){const n=(t>>>0)+(i>>>0);return{h:e+s+(n/l(2,32)|0)|0,l:0|n}}const An=(e,t,s)=>(e>>>0)+(t>>>0)+(s>>>0),En=(e,t,s,i)=>t+s+i+(e/l(2,32)|0)|0,jn=(e,t,s,i)=>(e>>>0)+(t>>>0)+(s>>>0)+(i>>>0),Pn=(e,t,s,i,n)=>t+s+i+n+(e/l(2,32)|0)|0,In=(e,t,s,i,n)=>(e>>>0)+(t>>>0)+(s>>>0)+(i>>>0)+(n>>>0),Ln=(e,t,s,i,n,r)=>t+s+i+n+r+(e/l(2,32)|0)|0,Rn=Uint32Array.from([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),On=new Uint32Array(64);class Dn extends ln{get(){const{A:e,B:t,C:s,D:i,E:n,F:r,G:a,H:o}=this;return[e,t,s,i,n,r,a,o]}set(e,t,s,i,n,r,a,o){this.A=0|e,this.B=0|t,this.C=0|s,this.D=0|i,this.E=0|n,this.F=0|r,this.G=0|a,this.H=0|o}process(e,t){for(let d=0;d<16;d++,t+=4)On[d]=e.getUint32(t,!1);for(let d=16;d<64;d++){const e=On[d-15],t=On[d-2],s=Yi(e,7)^Yi(e,18)^e>>>3,i=Yi(t,17)^Yi(t,19)^t>>>10;On[d]=i+On[d-7]+s+On[d-16]|0}let{A:s,B:i,C:n,D:r,E:a,F:o,G:l,H:c}=this;for(let d=0;d<64;d++){const e=c+(Yi(a,6)^Yi(a,11)^Yi(a,25))+an(a,o,l)+Rn[d]+On[d]|0,t=(Yi(s,2)^Yi(s,13)^Yi(s,22))+on(s,i,n)|0;c=l,l=o,o=a,a=r+e|0,r=n,n=i,i=s,s=e+t|0}s=s+this.A|0,i=i+this.B|0,n=n+this.C|0,r=r+this.D|0,a=a+this.E|0,o=o+this.F|0,l=l+this.G|0,c=c+this.H|0,this.set(s,i,n,r,a,o,l,c)}roundClean(){Wi(On)}destroy(){this.set(0,0,0,0,0,0,0,0),Wi(this.buffer)}constructor(e=32){super(64,e,8,!1),this.A=0|cn[0],this.B=0|cn[1],this.C=0|cn[2],this.D=0|cn[3],this.E=0|cn[4],this.F=0|cn[5],this.G=0|cn[6],this.H=0|cn[7]}}class Mn extends Dn{constructor(){super(28),this.A=0|dn[0],this.B=0|dn[1],this.C=0|dn[2],this.D=0|dn[3],this.E=0|dn[4],this.F=0|dn[5],this.G=0|dn[6],this.H=0|dn[7]}}const Un=(()=>xn(["0x428a2f98d728ae22","0x7137449123ef65cd","0xb5c0fbcfec4d3b2f","0xe9b5dba58189dbbc","0x3956c25bf348b538","0x59f111f1b605d019","0x923f82a4af194f9b","0xab1c5ed5da6d8118","0xd807aa98a3030242","0x12835b0145706fbe","0x243185be4ee4b28c","0x550c7dc3d5ffb4e2","0x72be5d74f27b896f","0x80deb1fe3b1696b1","0x9bdc06a725c71235","0xc19bf174cf692694","0xe49b69c19ef14ad2","0xefbe4786384f25e3","0x0fc19dc68b8cd5b5","0x240ca1cc77ac9c65","0x2de92c6f592b0275","0x4a7484aa6ea6e483","0x5cb0a9dcbd41fbd4","0x76f988da831153b5","0x983e5152ee66dfab","0xa831c66d2db43210","0xb00327c898fb213f","0xbf597fc7beef0ee4","0xc6e00bf33da88fc2","0xd5a79147930aa725","0x06ca6351e003826f","0x142929670a0e6e70","0x27b70a8546d22ffc","0x2e1b21385c26c926","0x4d2c6dfc5ac42aed","0x53380d139d95b3df","0x650a73548baf63de","0x766a0abb3c77b2a8","0x81c2c92e47edaee6","0x92722c851482353b","0xa2bfe8a14cf10364","0xa81a664bbc423001","0xc24b8b70d0f89791","0xc76c51a30654be30","0xd192e819d6ef5218","0xd69906245565a910","0xf40e35855771202a","0x106aa07032bbd1b8","0x19a4c116b8d2d0c8","0x1e376c085141ab53","0x2748774cdf8eeb99","0x34b0bcb5e19b48a8","0x391c0cb3c5c95a63","0x4ed8aa4ae3418acb","0x5b9cca4f7763e373","0x682e6ff3d6b2b8a3","0x748f82ee5defb2fc","0x78a5636f43172f60","0x84c87814a1f0ab72","0x8cc702081a6439ec","0x90befffa23631e28","0xa4506cebde82bde9","0xbef9a3f7b2c67915","0xc67178f2e372532b","0xca273eceea26619c","0xd186b8c721c0c207","0xeada7dd6cde0eb1e","0xf57d4f7fee6ed178","0x06f067aa72176fba","0x0a637dc5a2c898a6","0x113f9804bef90dae","0x1b710b35131c471b","0x28db77f523047d84","0x32caab7b40c72493","0x3c9ebe0a15c9bebc","0x431d67c49c100d4c","0x4cc5d4becb3e42b6","0x597f299cfc657e2a","0x5fcb6fab3ad6faec","0x6c44198c4a475817"].map(e=>BigInt(e))))(),Fn=(()=>Un[0])(),Bn=(()=>Un[1])(),qn=new Uint32Array(80),$n=new Uint32Array(80);class zn extends ln{get(){const{Ah:e,Al:t,Bh:s,Bl:i,Ch:n,Cl:r,Dh:a,Dl:o,Eh:l,El:c,Fh:d,Fl:u,Gh:h,Gl:f,Hh:m,Hl:p}=this;return[e,t,s,i,n,r,a,o,l,c,d,u,h,f,m,p]}set(e,t,s,i,n,r,a,o,l,c,d,u,h,f,m,p){this.Ah=0|e,this.Al=0|t,this.Bh=0|s,this.Bl=0|i,this.Ch=0|n,this.Cl=0|r,this.Dh=0|a,this.Dl=0|o,this.Eh=0|l,this.El=0|c,this.Fh=0|d,this.Fl=0|u,this.Gh=0|h,this.Gl=0|f,this.Hh=0|m,this.Hl=0|p}process(e,t){for(let y=0;y<16;y++,t+=4)qn[y]=e.getUint32(t),$n[y]=e.getUint32(t+=4);for(let y=16;y<80;y++){const e=0|qn[y-15],t=0|$n[y-15],s=kn(e,t,1)^kn(e,t,8)^wn(e,0,7),i=_n(e,t,1)^_n(e,t,8)^Sn(e,t,7),n=0|qn[y-2],r=0|$n[y-2],a=kn(n,r,19)^Cn(n,r,61)^wn(n,0,6),o=_n(n,r,19)^Nn(n,r,61)^Sn(n,r,6),l=jn(i,o,$n[y-7],$n[y-16]),c=Pn(l,s,a,qn[y-7],qn[y-16]);qn[y]=0|c,$n[y]=0|l}let{Ah:s,Al:i,Bh:n,Bl:r,Ch:a,Cl:o,Dh:l,Dl:c,Eh:d,El:u,Fh:h,Fl:f,Gh:m,Gl:p,Hh:g,Hl:v}=this;for(let y=0;y<80;y++){const e=kn(d,u,14)^kn(d,u,18)^Cn(d,u,41),t=_n(d,u,14)^_n(d,u,18)^Nn(d,u,41),b=d&h^~d&m,x=In(v,t,u&f^~u&p,Bn[y],$n[y]),w=Ln(x,g,e,b,Fn[y],qn[y]),S=0|x,k=kn(s,i,28)^Cn(s,i,34)^Cn(s,i,39),_=_n(s,i,28)^Nn(s,i,34)^Nn(s,i,39),C=s&n^s&a^n&a,N=i&r^i&o^r&o;g=0|m,v=0|p,m=0|h,p=0|f,h=0|d,f=0|u,({h:d,l:u}=Tn(0|l,0|c,0|w,0|S)),l=0|a,c=0|o,a=0|n,o=0|r,n=0|s,r=0|i;const T=An(S,_,N);s=En(T,w,k,C),i=0|T}({h:s,l:i}=Tn(0|this.Ah,0|this.Al,0|s,0|i)),({h:n,l:r}=Tn(0|this.Bh,0|this.Bl,0|n,0|r)),({h:a,l:o}=Tn(0|this.Ch,0|this.Cl,0|a,0|o)),({h:l,l:c}=Tn(0|this.Dh,0|this.Dl,0|l,0|c)),({h:d,l:u}=Tn(0|this.Eh,0|this.El,0|d,0|u)),({h:h,l:f}=Tn(0|this.Fh,0|this.Fl,0|h,0|f)),({h:m,l:p}=Tn(0|this.Gh,0|this.Gl,0|m,0|p)),({h:g,l:v}=Tn(0|this.Hh,0|this.Hl,0|g,0|v)),this.set(s,i,n,r,a,o,l,c,d,u,h,f,m,p,g,v)}roundClean(){Wi(qn,$n)}destroy(){Wi(this.buffer),this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}constructor(e=64){super(128,e,16,!1),this.Ah=0|hn[0],this.Al=0|hn[1],this.Bh=0|hn[2],this.Bl=0|hn[3],this.Ch=0|hn[4],this.Cl=0|hn[5],this.Dh=0|hn[6],this.Dl=0|hn[7],this.Eh=0|hn[8],this.El=0|hn[9],this.Fh=0|hn[10],this.Fl=0|hn[11],this.Gh=0|hn[12],this.Gl=0|hn[13],this.Hh=0|hn[14],this.Hl=0|hn[15]}}class Hn extends zn{constructor(){super(48),this.Ah=0|un[0],this.Al=0|un[1],this.Bh=0|un[2],this.Bl=0|un[3],this.Ch=0|un[4],this.Cl=0|un[5],this.Dh=0|un[6],this.Dl=0|un[7],this.Eh=0|un[8],this.El=0|un[9],this.Fh=0|un[10],this.Fl=0|un[11],this.Gh=0|un[12],this.Gl=0|un[13],this.Hh=0|un[14],this.Hl=0|un[15]}}const Vn=sn(()=>new Dn),Gn=sn(()=>new Mn),Jn=sn(()=>new zn),Wn=sn(()=>new Hn),Kn=BigInt(0),Yn=BigInt(1),Xn=BigInt(2),Qn=BigInt(7),Zn=BigInt(256),er=BigInt(113),tr=[],sr=[],ir=[];for(let Yw=0,Xw=Yn,Qw=1,Zw=0;Yw<24;Yw++){[Qw,Zw]=[Zw,(2*Qw+3*Zw)%5],tr.push(2*(5*Zw+Qw)),sr.push((Yw+1)*(Yw+2)/2%64);let e=Kn;for(let t=0;t<7;t++)Xw=(Xw<<Yn^(Xw>>Qn)*er)%Zn,Xw&Xn&&(e^=Yn<<(Yn<<BigInt(t))-Yn);ir.push(e)}const nr=xn(ir,!0),rr=nr[0],ar=nr[1],or=(e,t,s)=>s>32?((e,t,s)=>t<<s-32|e>>>64-s)(e,t,s):((e,t,s)=>e<<s|t>>>32-s)(e,t,s),lr=(e,t,s)=>s>32?((e,t,s)=>e<<s-32|t>>>64-s)(e,t,s):((e,t,s)=>t<<s|e>>>32-s)(e,t,s);class cr extends tn{clone(){return this._cloneInto()}keccak(){Zi(this.state32),function(e,t=24){const s=new Uint32Array(10);for(let i=24-t;i<24;i++){for(let i=0;i<10;i++)s[i]=e[i]^e[i+10]^e[i+20]^e[i+30]^e[i+40];for(let i=0;i<10;i+=2){const t=(i+8)%10,n=(i+2)%10,r=s[n],a=s[n+1],o=or(r,a,1)^s[t],l=lr(r,a,1)^s[t+1];for(let s=0;s<50;s+=10)e[i+s]^=o,e[i+s+1]^=l}let t=e[2],n=e[3];for(let s=0;s<24;s++){const i=sr[s],r=or(t,n,i),a=lr(t,n,i),o=tr[s];t=e[o],n=e[o+1],e[o]=r,e[o+1]=a}for(let i=0;i<50;i+=10){for(let t=0;t<10;t++)s[t]=e[i+t];for(let t=0;t<10;t++)e[i+t]^=~s[(t+2)%10]&s[(t+4)%10]}e[0]^=rr[i],e[1]^=ar[i]}Wi(s)}(this.state32,this.rounds),Zi(this.state32),this.posOut=0,this.pos=0}update(e){Gi(this),Vi(e=en(e));const{blockLen:t,state:s}=this,i=e.length;for(let n=0;n<i;){const r=Math.min(t-this.pos,i-n);for(let t=0;t<r;t++)s[this.pos++]^=e[n++];this.pos===t&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;const{state:e,suffix:t,pos:s,blockLen:i}=this;e[s]^=t,128&t&&s===i-1&&this.keccak(),e[i-1]^=128,this.keccak()}writeInto(e){Gi(this,!1),Vi(e),this.finish();const t=this.state,{blockLen:s}=this;for(let i=0,n=e.length;i<n;){this.posOut>=s&&this.keccak();const r=Math.min(s-this.posOut,n-i);e.set(t.subarray(this.posOut,this.posOut+r),i),this.posOut+=r,i+=r}return e}xofInto(e){if(!this.enableXOF)throw new Error("XOF is not possible for this instance");return this.writeInto(e)}xof(e){return Hi(e),this.xofInto(new Uint8Array(e))}digestInto(e){if(Ji(e,this),this.finished)throw new Error("digest() was already called");return this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,Wi(this.state)}_cloneInto(e){const{blockLen:t,suffix:s,outputLen:i,rounds:n,enableXOF:r}=this;return e||(e=new cr(t,s,i,r,n)),e.state32.set(this.state32),e.pos=this.pos,e.posOut=this.posOut,e.finished=this.finished,e.rounds=n,e.suffix=s,e.outputLen=i,e.enableXOF=r,e.destroyed=this.destroyed,e}constructor(e,t,s,i=!1,n=24){if(super(),this.pos=0,this.posOut=0,this.finished=!1,this.destroyed=!1,this.enableXOF=!1,this.blockLen=e,this.suffix=t,this.outputLen=s,this.enableXOF=i,this.rounds=n,Hi(s),!(0<e&&e<200))throw new Error("only keccak-f1600 function is supported");var r;this.state=new Uint8Array(200),this.state32=(r=this.state,new Uint32Array(r.buffer,r.byteOffset,Math.floor(r.byteLength/4)))}}const dr=(e,t,s)=>sn(()=>new cr(t,e,s)),ur=(()=>dr(6,144,28))(),hr=(()=>dr(6,136,32))(),fr=(()=>dr(6,104,48))(),mr=(()=>dr(6,72,64))(),pr=(()=>{if("object"==typeof globalThis)return globalThis;Object.defineProperty(Object.prototype,"__GLOBALTHIS__",{get(){return this},configurable:!0});try{if("undefined"!=typeof __GLOBALTHIS__)return __GLOBALTHIS__}finally{delete Object.prototype.__GLOBALTHIS__}return"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0})(),gr={SHA1:gn,SHA224:Gn,SHA256:Vn,SHA384:Wn,SHA512:Jn,"SHA3-224":ur,"SHA3-256":hr,"SHA3-384":fr,"SHA3-512":mr},vr=e=>{switch(!0){case/^(?:SHA-?1|SSL3-SHA1)$/i.test(e):return"SHA1";case/^SHA(?:2?-)?224$/i.test(e):return"SHA224";case/^SHA(?:2?-)?256$/i.test(e):return"SHA256";case/^SHA(?:2?-)?384$/i.test(e):return"SHA384";case/^SHA(?:2?-)?512$/i.test(e):return"SHA512";case/^SHA3-224$/i.test(e):return"SHA3-224";case/^SHA3-256$/i.test(e):return"SHA3-256";case/^SHA3-384$/i.test(e):return"SHA3-384";case/^SHA3-512$/i.test(e):return"SHA3-512";default:throw new TypeError(`Unknown hash algorithm: ${e}`)}},yr="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",br=e=>{let t=(e=e.replace(/ /g,"")).length;for(;"="===e[t-1];)--t;e=(t<e.length?e.substring(0,t):e).toUpperCase();const s=new ArrayBuffer(5*e.length/8|0),i=new Uint8Array(s);let n=0,r=0,a=0;for(let o=0;o<e.length;o++){const t=yr.indexOf(e[o]);if(-1===t)throw new TypeError(`Invalid character found: ${e[o]}`);r=r<<5|t,n+=5,n>=8&&(n-=8,i[a++]=r>>>n)}return i},xr=e=>{let t=0,s=0,i="";for(let n=0;n<e.length;n++)for(s=s<<8|e[n],t+=8;t>=5;)i+=yr[s>>>t-5&31],t-=5;return t>0&&(i+=yr[s<<5-t&31]),i},wr=e=>{e=e.replace(/ /g,"");const t=new ArrayBuffer(e.length/2),s=new Uint8Array(t);for(let i=0;i<e.length;i+=2)s[i/2]=parseInt(e.substring(i,i+2),16);return s},Sr=e=>{let t="";for(let s=0;s<e.length;s++){const i=e[s].toString(16);1===i.length&&(t+="0"),t+=i}return t.toUpperCase()},kr=e=>{const t=new ArrayBuffer(e.length),s=new Uint8Array(t);for(let i=0;i<e.length;i++)s[i]=255&e.charCodeAt(i);return s},_r=e=>{let t="";for(let s=0;s<e.length;s++)t+=String.fromCharCode(e[s]);return t},Cr=pr.TextEncoder?new pr.TextEncoder:null,Nr=pr.TextDecoder?new pr.TextDecoder:null,Tr=e=>{if(!Cr)throw new Error("Encoding API not available");return Cr.encode(e)},Ar=e=>{if(!Nr)throw new Error("Encoding API not available");return Nr.decode(e)};class Er{static fromLatin1(e){return new Er({buffer:kr(e).buffer})}static fromUTF8(e){return new Er({buffer:Tr(e).buffer})}static fromBase32(e){return new Er({buffer:br(e).buffer})}static fromHex(e){return new Er({buffer:wr(e).buffer})}get buffer(){return this.bytes.buffer}get latin1(){return Object.defineProperty(this,"latin1",{enumerable:!0,writable:!1,configurable:!1,value:_r(this.bytes)}),this.latin1}get utf8(){return Object.defineProperty(this,"utf8",{enumerable:!0,writable:!1,configurable:!1,value:Ar(this.bytes)}),this.utf8}get base32(){return Object.defineProperty(this,"base32",{enumerable:!0,writable:!1,configurable:!1,value:xr(this.bytes)}),this.base32}get hex(){return Object.defineProperty(this,"hex",{enumerable:!0,writable:!1,configurable:!1,value:Sr(this.bytes)}),this.hex}constructor({buffer:e,size:t=20}={}){this.bytes=void 0===e?(e=>{var t;if(null==(t=pr.crypto)?void 0:t.getRandomValues)return pr.crypto.getRandomValues(new Uint8Array(e));throw new Error("Cryptography API not available")})(t):new Uint8Array(e),Object.defineProperty(this,"bytes",{enumerable:!0,writable:!1,configurable:!1,value:this.bytes})}}class jr{static get defaults(){return{issuer:"",label:"OTPAuth",issuerInLabel:!0,algorithm:"SHA1",digits:6,counter:0,window:1}}static generate({secret:e,algorithm:t=jr.defaults.algorithm,digits:s=jr.defaults.digits,counter:i=jr.defaults.counter}){const n=((e,t,s)=>{var i;if(rn){const n=null!=(i=gr[e])?i:gr[vr(e)];return rn(n,t,s)}throw new Error("Missing HMAC function")})(t,e.bytes,(e=>{const t=new ArrayBuffer(8),s=new Uint8Array(t);let i=e;for(let n=7;n>=0&&0!==i;n--)s[n]=255&i,i-=s[n],i/=256;return s})(i)),r=15&n[n.byteLength-1];return(((127&n[r])<<24|(255&n[r+1])<<16|(255&n[r+2])<<8|255&n[r+3])%l(10,s)).toString().padStart(s,"0")}generate({counter:e=this.counter++}={}){return jr.generate({secret:this.secret,algorithm:this.algorithm,digits:this.digits,counter:e})}static validate({token:e,secret:t,algorithm:s,digits:i=jr.defaults.digits,counter:n=jr.defaults.counter,window:r=jr.defaults.window}){if(e.length!==i)return null;let a=null;const o=r=>{const o=jr.generate({secret:t,algorithm:s,digits:i,counter:r});((e,t)=>{{if(e.length!==t.length)throw new TypeError("Input strings must have the same length");let s=-1,i=0;for(;++s<e.length;)i|=e.charCodeAt(s)^t.charCodeAt(s);return 0===i}})(e,o)&&(a=r-n)};o(n);for(let l=1;l<=r&&null===a&&(o(n-l),null===a)&&(o(n+l),null===a);++l);return a}validate({token:e,counter:t=this.counter,window:s}){return jr.validate({token:e,secret:this.secret,algorithm:this.algorithm,digits:this.digits,counter:t,window:s})}toString(){const e=encodeURIComponent;return`otpauth://hotp/${this.issuer.length>0?this.issuerInLabel?`${e(this.issuer)}:${e(this.label)}?issuer=${e(this.issuer)}&`:`${e(this.label)}?issuer=${e(this.issuer)}&`:`${e(this.label)}?`}secret=${e(this.secret.base32)}&algorithm=${e(this.algorithm)}&digits=${e(this.digits)}&counter=${e(this.counter)}`}constructor({issuer:e=jr.defaults.issuer,label:t=jr.defaults.label,issuerInLabel:s=jr.defaults.issuerInLabel,secret:i=new Er,algorithm:n=jr.defaults.algorithm,digits:r=jr.defaults.digits,counter:a=jr.defaults.counter}={}){this.issuer=e,this.label=t,this.issuerInLabel=s,this.secret="string"==typeof i?Er.fromBase32(i):i,this.algorithm=vr(n),this.digits=r,this.counter=a}}class Pr{static get defaults(){return{issuer:"",label:"OTPAuth",issuerInLabel:!0,algorithm:"SHA1",digits:6,period:30,window:1}}static counter({period:e=Pr.defaults.period,timestamp:t=Date.now()}={}){return Math.floor(t/1e3/e)}counter({timestamp:e=Date.now()}={}){return Pr.counter({period:this.period,timestamp:e})}static remaining({period:e=Pr.defaults.period,timestamp:t=Date.now()}={}){return 1e3*e-t%(1e3*e)}remaining({timestamp:e=Date.now()}={}){return Pr.remaining({period:this.period,timestamp:e})}static generate({secret:e,algorithm:t,digits:s,period:i=Pr.defaults.period,timestamp:n=Date.now()}){return jr.generate({secret:e,algorithm:t,digits:s,counter:Pr.counter({period:i,timestamp:n})})}generate({timestamp:e=Date.now()}={}){return Pr.generate({secret:this.secret,algorithm:this.algorithm,digits:this.digits,period:this.period,timestamp:e})}static validate({token:e,secret:t,algorithm:s,digits:i,period:n=Pr.defaults.period,timestamp:r=Date.now(),window:a}){return jr.validate({token:e,secret:t,algorithm:s,digits:i,counter:Pr.counter({period:n,timestamp:r}),window:a})}validate({token:e,timestamp:t,window:s}){return Pr.validate({token:e,secret:this.secret,algorithm:this.algorithm,digits:this.digits,period:this.period,timestamp:t,window:s})}toString(){const e=encodeURIComponent;return`otpauth://totp/${this.issuer.length>0?this.issuerInLabel?`${e(this.issuer)}:${e(this.label)}?issuer=${e(this.issuer)}&`:`${e(this.label)}?issuer=${e(this.issuer)}&`:`${e(this.label)}?`}secret=${e(this.secret.base32)}&algorithm=${e(this.algorithm)}&digits=${e(this.digits)}&period=${e(this.period)}`}constructor({issuer:e=Pr.defaults.issuer,label:t=Pr.defaults.label,issuerInLabel:s=Pr.defaults.issuerInLabel,secret:i=new Er,algorithm:n=Pr.defaults.algorithm,digits:r=Pr.defaults.digits,period:a=Pr.defaults.period}={}){this.issuer=e,this.label=t,this.issuerInLabel=s,this.secret="string"==typeof i?Er.fromBase32(i):i,this.algorithm=vr(n),this.digits=r,this.period=a}}var Ir={},Lr={},Rr={};let Or;const Dr=[0,26,44,70,100,134,172,196,242,292,346,404,466,532,581,655,733,815,901,991,1085,1156,1258,1364,1474,1588,1706,1828,1921,2051,2185,2323,2465,2611,2761,2876,3034,3196,3362,3532,3706];Rr.getSymbolSize=function(e){if(!e)throw new Error('"version" cannot be null or undefined');if(e<1||e>40)throw new Error('"version" should be in range from 1 to 40');return 4*e+17},Rr.getSymbolTotalCodewords=function(e){return Dr[e]},Rr.getBCHDigit=function(e){let t=0;for(;0!==e;)t++,e>>>=1;return t},Rr.setToSJISFunction=function(e){if("function"!=typeof e)throw new Error('"toSJISFunc" is not a valid function.');Or=e},Rr.isKanjiModeEnabled=function(){return void 0!==Or},Rr.toSJIS=function(e){return Or(e)};var Mr,Ur={};function Fr(){this.buffer=[],this.length=0}(Mr=Ur).L={bit:1},Mr.M={bit:0},Mr.Q={bit:3},Mr.H={bit:2},Mr.isValid=function(e){return e&&void 0!==e.bit&&e.bit>=0&&e.bit<4},Mr.from=function(e,t){if(Mr.isValid(e))return e;try{return function(e){if("string"!=typeof e)throw new Error("Param is not a string");switch(e.toLowerCase()){case"l":case"low":return Mr.L;case"m":case"medium":return Mr.M;case"q":case"quartile":return Mr.Q;case"h":case"high":return Mr.H;default:throw new Error("Unknown EC Level: "+e)}}(e)}catch(Tx){return t}},Fr.prototype={get:function(e){const t=Math.floor(e/8);return 1==(this.buffer[t]>>>7-e%8&1)},put:function(e,t){for(let s=0;s<t;s++)this.putBit(1==(e>>>t-s-1&1))},getLengthInBits:function(){return this.length},putBit:function(e){const t=Math.floor(this.length/8);this.buffer.length<=t&&this.buffer.push(0),e&&(this.buffer[t]|=128>>>this.length%8),this.length++}};var Br=Fr;function qr(e){if(!e||e<1)throw new Error("BitMatrix size must be defined and greater than 0");this.size=e,this.data=new Uint8Array(e*e),this.reservedBit=new Uint8Array(e*e)}qr.prototype.set=function(e,t,s,i){const n=e*this.size+t;this.data[n]=s,i&&(this.reservedBit[n]=!0)},qr.prototype.get=function(e,t){return this.data[e*this.size+t]},qr.prototype.xor=function(e,t,s){this.data[e*this.size+t]^=s},qr.prototype.isReserved=function(e,t){return this.reservedBit[e*this.size+t]};var $r=qr,zr={};!function(e){const t=Rr.getSymbolSize;e.getRowColCoords=function(e){if(1===e)return[];const s=Math.floor(e/7)+2,i=t(e),n=145===i?26:2*Math.ceil((i-13)/(2*s-2)),r=[i-7];for(let t=1;t<s-1;t++)r[t]=r[t-1]-n;return r.push(6),r.reverse()},e.getPositions=function(t){const s=[],i=e.getRowColCoords(t),n=i.length;for(let e=0;e<n;e++)for(let t=0;t<n;t++)0===e&&0===t||0===e&&t===n-1||e===n-1&&0===t||s.push([i[e],i[t]]);return s}}(zr);var Hr={};const Vr=Rr.getSymbolSize;Hr.getPositions=function(e){const t=Vr(e);return[[0,0],[t-7,0],[0,t-7]]};var Gr={};!function(e){e.Patterns={PATTERN000:0,PATTERN001:1,PATTERN010:2,PATTERN011:3,PATTERN100:4,PATTERN101:5,PATTERN110:6,PATTERN111:7};const t=3,s=3,i=40,n=10;function r(t,s,i){switch(t){case e.Patterns.PATTERN000:return(s+i)%2==0;case e.Patterns.PATTERN001:return s%2==0;case e.Patterns.PATTERN010:return i%3==0;case e.Patterns.PATTERN011:return(s+i)%3==0;case e.Patterns.PATTERN100:return(Math.floor(s/2)+Math.floor(i/3))%2==0;case e.Patterns.PATTERN101:return s*i%2+s*i%3==0;case e.Patterns.PATTERN110:return(s*i%2+s*i%3)%2==0;case e.Patterns.PATTERN111:return(s*i%3+(s+i)%2)%2==0;default:throw new Error("bad maskPattern:"+t)}}e.isValid=function(e){return null!=e&&""!==e&&!isNaN(e)&&e>=0&&e<=7},e.from=function(t){return e.isValid(t)?parseInt(t,10):void 0},e.getPenaltyN1=function(e){const s=e.size;let i=0,n=0,r=0,a=null,o=null;for(let l=0;l<s;l++){n=r=0,a=o=null;for(let c=0;c<s;c++){let s=e.get(l,c);s===a?n++:(n>=5&&(i+=t+(n-5)),a=s,n=1),s=e.get(c,l),s===o?r++:(r>=5&&(i+=t+(r-5)),o=s,r=1)}n>=5&&(i+=t+(n-5)),r>=5&&(i+=t+(r-5))}return i},e.getPenaltyN2=function(e){const t=e.size;let i=0;for(let s=0;s<t-1;s++)for(let n=0;n<t-1;n++){const t=e.get(s,n)+e.get(s,n+1)+e.get(s+1,n)+e.get(s+1,n+1);4!==t&&0!==t||i++}return i*s},e.getPenaltyN3=function(e){const t=e.size;let s=0,n=0,r=0;for(let i=0;i<t;i++){n=r=0;for(let a=0;a<t;a++)n=n<<1&2047|e.get(i,a),a>=10&&(1488===n||93===n)&&s++,r=r<<1&2047|e.get(a,i),a>=10&&(1488===r||93===r)&&s++}return s*i},e.getPenaltyN4=function(e){let t=0;const s=e.data.length;for(let i=0;i<s;i++)t+=e.data[i];return Math.abs(Math.ceil(100*t/s/5)-10)*n},e.applyMask=function(e,t){const s=t.size;for(let i=0;i<s;i++)for(let n=0;n<s;n++)t.isReserved(n,i)||t.xor(n,i,r(e,n,i))},e.getBestMask=function(t,s){const i=Object.keys(e.Patterns).length;let n=0,r=1/0;for(let a=0;a<i;a++){s(a),e.applyMask(a,t);const i=e.getPenaltyN1(t)+e.getPenaltyN2(t)+e.getPenaltyN3(t)+e.getPenaltyN4(t);e.applyMask(a,t),i<r&&(r=i,n=a)}return n}}(Gr);var Jr={};const Wr=Ur,Kr=[1,1,1,1,1,1,1,1,1,1,2,2,1,2,2,4,1,2,4,4,2,4,4,4,2,4,6,5,2,4,6,6,2,5,8,8,4,5,8,8,4,5,8,11,4,8,10,11,4,9,12,16,4,9,16,16,6,10,12,18,6,10,17,16,6,11,16,19,6,13,18,21,7,14,21,25,8,16,20,25,8,17,23,25,9,17,23,34,9,18,25,30,10,20,27,32,12,21,29,35,12,23,34,37,12,25,34,40,13,26,35,42,14,28,38,45,15,29,40,48,16,31,43,51,17,33,45,54,18,35,48,57,19,37,51,60,19,38,53,63,20,40,56,66,21,43,59,70,22,45,62,74,24,47,65,77,25,49,68,81],Yr=[7,10,13,17,10,16,22,28,15,26,36,44,20,36,52,64,26,48,72,88,36,64,96,112,40,72,108,130,48,88,132,156,60,110,160,192,72,130,192,224,80,150,224,264,96,176,260,308,104,198,288,352,120,216,320,384,132,240,360,432,144,280,408,480,168,308,448,532,180,338,504,588,196,364,546,650,224,416,600,700,224,442,644,750,252,476,690,816,270,504,750,900,300,560,810,960,312,588,870,1050,336,644,952,1110,360,700,1020,1200,390,728,1050,1260,420,784,1140,1350,450,812,1200,1440,480,868,1290,1530,510,924,1350,1620,540,980,1440,1710,570,1036,1530,1800,570,1064,1590,1890,600,1120,1680,1980,630,1204,1770,2100,660,1260,1860,2220,720,1316,1950,2310,750,1372,2040,2430];Jr.getBlocksCount=function(e,t){switch(t){case Wr.L:return Kr[4*(e-1)+0];case Wr.M:return Kr[4*(e-1)+1];case Wr.Q:return Kr[4*(e-1)+2];case Wr.H:return Kr[4*(e-1)+3];default:return}},Jr.getTotalCodewordsCount=function(e,t){switch(t){case Wr.L:return Yr[4*(e-1)+0];case Wr.M:return Yr[4*(e-1)+1];case Wr.Q:return Yr[4*(e-1)+2];case Wr.H:return Yr[4*(e-1)+3];default:return}};var Xr={},Qr={};const Zr=new Uint8Array(512),ea=new Uint8Array(256);!function(){let e=1;for(let t=0;t<255;t++)Zr[t]=e,ea[e]=t,e<<=1,256&e&&(e^=285);for(let t=255;t<512;t++)Zr[t]=Zr[t-255]}(),Qr.log=function(e){if(e<1)throw new Error("log("+e+")");return ea[e]},Qr.exp=function(e){return Zr[e]},Qr.mul=function(e,t){return 0===e||0===t?0:Zr[ea[e]+ea[t]]},function(e){const t=Qr;e.mul=function(e,s){const i=new Uint8Array(e.length+s.length-1);for(let n=0;n<e.length;n++)for(let r=0;r<s.length;r++)i[n+r]^=t.mul(e[n],s[r]);return i},e.mod=function(e,s){let i=new Uint8Array(e);for(;i.length-s.length>=0;){const e=i[0];for(let r=0;r<s.length;r++)i[r]^=t.mul(s[r],e);let n=0;for(;n<i.length&&0===i[n];)n++;i=i.slice(n)}return i},e.generateECPolynomial=function(s){let i=new Uint8Array([1]);for(let n=0;n<s;n++)i=e.mul(i,new Uint8Array([1,t.exp(n)]));return i}}(Xr);const ta=Xr;function sa(e){this.genPoly=void 0,this.degree=e,this.degree&&this.initialize(this.degree)}sa.prototype.initialize=function(e){this.degree=e,this.genPoly=ta.generateECPolynomial(this.degree)},sa.prototype.encode=function(e){if(!this.genPoly)throw new Error("Encoder not initialized");const t=new Uint8Array(e.length+this.degree);t.set(e);const s=ta.mod(t,this.genPoly),i=this.degree-s.length;if(i>0){const e=new Uint8Array(this.degree);return e.set(s,i),e}return s};var ia=sa,na={},ra={},aa={isValid:function(e){return!isNaN(e)&&e>=1&&e<=40}},oa={};const la="[0-9]+";let ca="(?:[u3000-u303F]|[u3040-u309F]|[u30A0-u30FF]|[uFF00-uFFEF]|[u4E00-u9FAF]|[u2605-u2606]|[u2190-u2195]|u203B|[u2010u2015u2018u2019u2025u2026u201Cu201Du2225u2260]|[u0391-u0451]|[u00A7u00A8u00B1u00B4u00D7u00F7])+";ca=ca.replace(/u/g,"\\u");const da="(?:(?![A-Z0-9 $%*+\\-./:]|"+ca+")(?:.|[\r\n]))+";oa.KANJI=new RegExp(ca,"g"),oa.BYTE_KANJI=new RegExp("[^A-Z0-9 $%*+\\-./:]+","g"),oa.BYTE=new RegExp(da,"g"),oa.NUMERIC=new RegExp(la,"g"),oa.ALPHANUMERIC=new RegExp("[A-Z $%*+\\-./:]+","g");const ua=new RegExp("^"+ca+"$"),ha=new RegExp("^"+la+"$"),fa=new RegExp("^[A-Z0-9 $%*+\\-./:]+$");oa.testKanji=function(e){return ua.test(e)},oa.testNumeric=function(e){return ha.test(e)},oa.testAlphanumeric=function(e){return fa.test(e)},function(e){const t=aa,s=oa;e.NUMERIC={id:"Numeric",bit:1,ccBits:[10,12,14]},e.ALPHANUMERIC={id:"Alphanumeric",bit:2,ccBits:[9,11,13]},e.BYTE={id:"Byte",bit:4,ccBits:[8,16,16]},e.KANJI={id:"Kanji",bit:8,ccBits:[8,10,12]},e.MIXED={bit:-1},e.getCharCountIndicator=function(e,s){if(!e.ccBits)throw new Error("Invalid mode: "+e);if(!t.isValid(s))throw new Error("Invalid version: "+s);return s>=1&&s<10?e.ccBits[0]:s<27?e.ccBits[1]:e.ccBits[2]},e.getBestModeForData=function(t){return s.testNumeric(t)?e.NUMERIC:s.testAlphanumeric(t)?e.ALPHANUMERIC:s.testKanji(t)?e.KANJI:e.BYTE},e.toString=function(e){if(e&&e.id)return e.id;throw new Error("Invalid mode")},e.isValid=function(e){return e&&e.bit&&e.ccBits},e.from=function(t,s){if(e.isValid(t))return t;try{return function(t){if("string"!=typeof t)throw new Error("Param is not a string");switch(t.toLowerCase()){case"numeric":return e.NUMERIC;case"alphanumeric":return e.ALPHANUMERIC;case"kanji":return e.KANJI;case"byte":return e.BYTE;default:throw new Error("Unknown mode: "+t)}}(t)}catch(Tx){return s}}}(ra),function(e){const t=Rr,s=Jr,i=Ur,n=ra,r=aa,a=t.getBCHDigit(7973);function o(e,t){return n.getCharCountIndicator(e,t)+4}function l(e,t){let s=0;return e.forEach(function(e){const i=o(e.mode,t);s+=i+e.getBitsLength()}),s}e.from=function(e,t){return r.isValid(e)?parseInt(e,10):t},e.getCapacity=function(e,i,a){if(!r.isValid(e))throw new Error("Invalid QR Code version");void 0===a&&(a=n.BYTE);const l=8*(t.getSymbolTotalCodewords(e)-s.getTotalCodewordsCount(e,i));if(a===n.MIXED)return l;const c=l-o(a,e);switch(a){case n.NUMERIC:return Math.floor(c/10*3);case n.ALPHANUMERIC:return Math.floor(c/11*2);case n.KANJI:return Math.floor(c/13);case n.BYTE:default:return Math.floor(c/8)}},e.getBestVersionForData=function(t,s){let r;const a=i.from(s,i.M);if(Array.isArray(t)){if(t.length>1)return function(t,s){for(let i=1;i<=40;i++)if(l(t,i)<=e.getCapacity(i,s,n.MIXED))return i}(t,a);if(0===t.length)return 1;r=t[0]}else r=t;return function(t,s,i){for(let n=1;n<=40;n++)if(s<=e.getCapacity(n,i,t))return n}(r.mode,r.getLength(),a)},e.getEncodedBits=function(e){if(!r.isValid(e)||e<7)throw new Error("Invalid QR Code version");let s=e<<12;for(;t.getBCHDigit(s)-a>=0;)s^=7973<<t.getBCHDigit(s)-a;return e<<12|s}}(na);var ma={};const pa=Rr,ga=pa.getBCHDigit(1335);ma.getEncodedBits=function(e,t){const s=e.bit<<3|t;let i=s<<10;for(;pa.getBCHDigit(i)-ga>=0;)i^=1335<<pa.getBCHDigit(i)-ga;return 21522^(s<<10|i)};var va={};const ya=ra;function ba(e){this.mode=ya.NUMERIC,this.data=e.toString()}ba.getBitsLength=function(e){return 10*Math.floor(e/3)+(e%3?e%3*3+1:0)},ba.prototype.getLength=function(){return this.data.length},ba.prototype.getBitsLength=function(){return ba.getBitsLength(this.data.length)},ba.prototype.write=function(e){let t,s,i;for(t=0;t+3<=this.data.length;t+=3)s=this.data.substr(t,3),i=parseInt(s,10),e.put(i,10);const n=this.data.length-t;n>0&&(s=this.data.substr(t),i=parseInt(s,10),e.put(i,3*n+1))};var xa=ba;const wa=ra,Sa=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"," ","$","%","*","+","-",".","/",":"];function ka(e){this.mode=wa.ALPHANUMERIC,this.data=e}ka.getBitsLength=function(e){return 11*Math.floor(e/2)+e%2*6},ka.prototype.getLength=function(){return this.data.length},ka.prototype.getBitsLength=function(){return ka.getBitsLength(this.data.length)},ka.prototype.write=function(e){let t;for(t=0;t+2<=this.data.length;t+=2){let s=45*Sa.indexOf(this.data[t]);s+=Sa.indexOf(this.data[t+1]),e.put(s,11)}this.data.length%2&&e.put(Sa.indexOf(this.data[t]),6)};var _a=ka;const Ca=ra;function Na(e){this.mode=Ca.BYTE,this.data="string"==typeof e?(new TextEncoder).encode(e):new Uint8Array(e)}Na.getBitsLength=function(e){return 8*e},Na.prototype.getLength=function(){return this.data.length},Na.prototype.getBitsLength=function(){return Na.getBitsLength(this.data.length)},Na.prototype.write=function(e){for(let t=0,s=this.data.length;t<s;t++)e.put(this.data[t],8)};var Ta=Na;const Aa=ra,Ea=Rr;function ja(e){this.mode=Aa.KANJI,this.data=e}ja.getBitsLength=function(e){return 13*e},ja.prototype.getLength=function(){return this.data.length},ja.prototype.getBitsLength=function(){return ja.getBitsLength(this.data.length)},ja.prototype.write=function(e){let t;for(t=0;t<this.data.length;t++){let s=Ea.toSJIS(this.data[t]);if(s>=33088&&s<=40956)s-=33088;else{if(!(s>=57408&&s<=60351))throw new Error("Invalid SJIS character: "+this.data[t]+"\nMake sure your charset is UTF-8");s-=49472}s=192*(s>>>8&255)+(255&s),e.put(s,13)}};var Pa,Ia=ja,La={exports:{}};Pa={single_source_shortest_paths:function(e,t,s){var i={},n={};n[t]=0;var r,a,o,l,c,d,u,h=Pa.PriorityQueue.make();for(h.push(t,0);!h.empty();)for(o in a=(r=h.pop()).value,l=r.cost,c=e[a]||{})c.hasOwnProperty(o)&&(d=l+c[o],u=n[o],(void 0===n[o]||u>d)&&(n[o]=d,h.push(o,d),i[o]=a));if(void 0!==s&&void 0===n[s]){var f=["Could not find a path from ",t," to ",s,"."].join("");throw new Error(f)}return i},extract_shortest_path_from_predecessor_list:function(e,t){for(var s=[],i=t;i;)s.push(i),e[i],i=e[i];return s.reverse(),s},find_path:function(e,t,s){var i=Pa.single_source_shortest_paths(e,t,s);return Pa.extract_shortest_path_from_predecessor_list(i,s)},PriorityQueue:{make:function(e){var t,s=Pa.PriorityQueue,i={};for(t in e=e||{},s)s.hasOwnProperty(t)&&(i[t]=s[t]);return i.queue=[],i.sorter=e.sorter||s.default_sorter,i},default_sorter:function(e,t){return e.cost-t.cost},push:function(e,t){var s={value:e,cost:t};this.queue.push(s),this.queue.sort(this.sorter)},pop:function(){return this.queue.shift()},empty:function(){return 0===this.queue.length}}};var Ra=La.exports=Pa;!function(e){const t=ra,s=xa,i=_a,n=Ta,r=Ia,a=oa,o=Rr,l=Ra;function c(e){return unescape(encodeURIComponent(e)).length}function d(e,t,s){const i=[];let n;for(;null!==(n=e.exec(s));)i.push({data:n[0],index:n.index,mode:t,length:n[0].length});return i}function u(e){const s=d(a.NUMERIC,t.NUMERIC,e),i=d(a.ALPHANUMERIC,t.ALPHANUMERIC,e);let n,r;o.isKanjiModeEnabled()?(n=d(a.BYTE,t.BYTE,e),r=d(a.KANJI,t.KANJI,e)):(n=d(a.BYTE_KANJI,t.BYTE,e),r=[]);return s.concat(i,n,r).sort(function(e,t){return e.index-t.index}).map(function(e){return{data:e.data,mode:e.mode,length:e.length}})}function h(e,a){switch(a){case t.NUMERIC:return s.getBitsLength(e);case t.ALPHANUMERIC:return i.getBitsLength(e);case t.KANJI:return r.getBitsLength(e);case t.BYTE:return n.getBitsLength(e)}}function f(e,a){let l;const c=t.getBestModeForData(e);if(l=t.from(a,c),l!==t.BYTE&&l.bit<c.bit)throw new Error('"'+e+'" cannot be encoded with mode '+t.toString(l)+".\n Suggested mode is: "+t.toString(c));switch(l!==t.KANJI||o.isKanjiModeEnabled()||(l=t.BYTE),l){case t.NUMERIC:return new s(e);case t.ALPHANUMERIC:return new i(e);case t.KANJI:return new r(e);case t.BYTE:return new n(e)}}e.fromArray=function(e){return e.reduce(function(e,t){return"string"==typeof t?e.push(f(t,null)):t.data&&e.push(f(t.data,t.mode)),e},[])},e.fromString=function(s,i){const n=function(e){const s=[];for(let i=0;i<e.length;i++){const n=e[i];switch(n.mode){case t.NUMERIC:s.push([n,{data:n.data,mode:t.ALPHANUMERIC,length:n.length},{data:n.data,mode:t.BYTE,length:n.length}]);break;case t.ALPHANUMERIC:s.push([n,{data:n.data,mode:t.BYTE,length:n.length}]);break;case t.KANJI:s.push([n,{data:n.data,mode:t.BYTE,length:c(n.data)}]);break;case t.BYTE:s.push([{data:n.data,mode:t.BYTE,length:c(n.data)}])}}return s}(u(s,o.isKanjiModeEnabled())),r=function(e,s){const i={},n={start:{}};let r=["start"];for(let a=0;a<e.length;a++){const o=e[a],l=[];for(let e=0;e<o.length;e++){const c=o[e],d=""+a+e;l.push(d),i[d]={node:c,lastCount:0},n[d]={};for(let e=0;e<r.length;e++){const a=r[e];i[a]&&i[a].node.mode===c.mode?(n[a][d]=h(i[a].lastCount+c.length,c.mode)-h(i[a].lastCount,c.mode),i[a].lastCount+=c.length):(i[a]&&(i[a].lastCount=c.length),n[a][d]=h(c.length,c.mode)+4+t.getCharCountIndicator(c.mode,s))}}r=l}for(let t=0;t<r.length;t++)n[r[t]].end=0;return{map:n,table:i}}(n,i),a=l.find_path(r.map,"start","end"),d=[];for(let e=1;e<a.length-1;e++)d.push(r.table[a[e]].node);return e.fromArray(function(e){return e.reduce(function(e,t){const s=e.length-1>=0?e[e.length-1]:null;return s&&s.mode===t.mode?(e[e.length-1].data+=t.data,e):(e.push(t),e)},[])}(d))},e.rawSplit=function(t){return e.fromArray(u(t,o.isKanjiModeEnabled()))}}(va);const Oa=Rr,Da=Ur,Ma=Br,Ua=$r,Fa=zr,Ba=Hr,qa=Gr,$a=Jr,za=ia,Ha=na,Va=ma,Ga=ra,Ja=va;function Wa(e,t,s){const i=e.size,n=Va.getEncodedBits(t,s);let r,a;for(r=0;r<15;r++)a=1==(n>>r&1),r<6?e.set(r,8,a,!0):r<8?e.set(r+1,8,a,!0):e.set(i-15+r,8,a,!0),r<8?e.set(8,i-r-1,a,!0):r<9?e.set(8,15-r-1+1,a,!0):e.set(8,15-r-1,a,!0);e.set(i-8,8,1,!0)}function Ka(e,t,s){const i=new Ma;s.forEach(function(t){i.put(t.mode.bit,4),i.put(t.getLength(),Ga.getCharCountIndicator(t.mode,e)),t.write(i)});const n=8*(Oa.getSymbolTotalCodewords(e)-$a.getTotalCodewordsCount(e,t));for(i.getLengthInBits()+4<=n&&i.put(0,4);i.getLengthInBits()%8!=0;)i.putBit(0);const r=(n-i.getLengthInBits())/8;for(let a=0;a<r;a++)i.put(a%2?17:236,8);return function(e,t,s){const i=Oa.getSymbolTotalCodewords(t),n=$a.getTotalCodewordsCount(t,s),r=i-n,a=$a.getBlocksCount(t,s),o=i%a,l=a-o,c=Math.floor(i/a),d=Math.floor(r/a),u=d+1,h=c-d,f=new za(h);let m=0;const p=new Array(a),g=new Array(a);let v=0;const y=new Uint8Array(e.buffer);for(let k=0;k<a;k++){const e=k<l?d:u;p[k]=y.slice(m,m+e),g[k]=f.encode(p[k]),m+=e,v=Math.max(v,e)}const b=new Uint8Array(i);let x,w,S=0;for(x=0;x<v;x++)for(w=0;w<a;w++)x<p[w].length&&(b[S++]=p[w][x]);for(x=0;x<h;x++)for(w=0;w<a;w++)b[S++]=g[w][x];return b}(i,e,t)}function Ya(e,t,s,i){let n;if(Array.isArray(e))n=Ja.fromArray(e);else{if("string"!=typeof e)throw new Error("Invalid data");{let i=t;if(!i){const t=Ja.rawSplit(e);i=Ha.getBestVersionForData(t,s)}n=Ja.fromString(e,i||40)}}const r=Ha.getBestVersionForData(n,s);if(!r)throw new Error("The amount of data is too big to be stored in a QR Code");if(t){if(t<r)throw new Error("\nThe chosen QR Code version cannot contain this amount of data.\nMinimum version required to store current data is: "+r+".\n")}else t=r;const a=Ka(t,s,n),o=Oa.getSymbolSize(t),l=new Ua(o);return function(e,t){const s=e.size,i=Ba.getPositions(t);for(let n=0;n<i.length;n++){const t=i[n][0],r=i[n][1];for(let i=-1;i<=7;i++)if(!(t+i<=-1||s<=t+i))for(let n=-1;n<=7;n++)r+n<=-1||s<=r+n||(i>=0&&i<=6&&(0===n||6===n)||n>=0&&n<=6&&(0===i||6===i)||i>=2&&i<=4&&n>=2&&n<=4?e.set(t+i,r+n,!0,!0):e.set(t+i,r+n,!1,!0))}}(l,t),function(e){const t=e.size;for(let s=8;s<t-8;s++){const t=s%2==0;e.set(s,6,t,!0),e.set(6,s,t,!0)}}(l),function(e,t){const s=Fa.getPositions(t);for(let i=0;i<s.length;i++){const t=s[i][0],n=s[i][1];for(let s=-2;s<=2;s++)for(let i=-2;i<=2;i++)-2===s||2===s||-2===i||2===i||0===s&&0===i?e.set(t+s,n+i,!0,!0):e.set(t+s,n+i,!1,!0)}}(l,t),Wa(l,s,0),t>=7&&function(e,t){const s=e.size,i=Ha.getEncodedBits(t);let n,r,a;for(let o=0;o<18;o++)n=Math.floor(o/3),r=o%3+s-8-3,a=1==(i>>o&1),e.set(n,r,a,!0),e.set(r,n,a,!0)}(l,t),function(e,t){const s=e.size;let i=-1,n=s-1,r=7,a=0;for(let o=s-1;o>0;o-=2)for(6===o&&o--;;){for(let s=0;s<2;s++)if(!e.isReserved(n,o-s)){let i=!1;a<t.length&&(i=1==(t[a]>>>r&1)),e.set(n,o-s,i),r--,-1===r&&(a++,r=7)}if(n+=i,n<0||s<=n){n-=i,i=-i;break}}}(l,a),isNaN(i)&&(i=qa.getBestMask(l,Wa.bind(null,l,s))),qa.applyMask(i,l),Wa(l,s,i),{modules:l,version:t,errorCorrectionLevel:s,maskPattern:i,segments:n}}Lr.create=function(e,t){if(void 0===e||""===e)throw new Error("No input text");let s,i,n=Da.M;return void 0!==t&&(n=Da.from(t.errorCorrectionLevel,Da.M),s=Ha.from(t.version),i=qa.from(t.maskPattern),t.toSJISFunc&&Oa.setToSJISFunction(t.toSJISFunc)),Ya(e,s,n,i)};var Xa={},Qa={};!function(e){function t(e){if("number"==typeof e&&(e=e.toString()),"string"!=typeof e)throw new Error("Color should be defined as hex string");let t=e.slice().replace("#","").split("");if(t.length<3||5===t.length||t.length>8)throw new Error("Invalid hex color: "+e);3!==t.length&&4!==t.length||(t=Array.prototype.concat.apply([],t.map(function(e){return[e,e]}))),6===t.length&&t.push("F","F");const s=parseInt(t.join(""),16);return{r:s>>24&255,g:s>>16&255,b:s>>8&255,a:255&s,hex:"#"+t.slice(0,6).join("")}}e.getOptions=function(e){e||(e={}),e.color||(e.color={});const s=void 0===e.margin||null===e.margin||e.margin<0?4:e.margin,i=e.width&&e.width>=21?e.width:void 0,n=e.scale||4;return{width:i,scale:i?4:n,margin:s,color:{dark:t(e.color.dark||"#000000ff"),light:t(e.color.light||"#ffffffff")},type:e.type,rendererOpts:e.rendererOpts||{}}},e.getScale=function(e,t){return t.width&&t.width>=e+2*t.margin?t.width/(e+2*t.margin):t.scale},e.getImageWidth=function(t,s){const i=e.getScale(t,s);return Math.floor((t+2*s.margin)*i)},e.qrToImageData=function(t,s,i){const n=s.modules.size,r=s.modules.data,a=e.getScale(n,i),o=Math.floor((n+2*i.margin)*a),l=i.margin*a,c=[i.color.light,i.color.dark];for(let e=0;e<o;e++)for(let s=0;s<o;s++){let d=4*(e*o+s),u=i.color.light;if(e>=l&&s>=l&&e<o-l&&s<o-l){u=c[r[Math.floor((e-l)/a)*n+Math.floor((s-l)/a)]?1:0]}t[d++]=u.r,t[d++]=u.g,t[d++]=u.b,t[d]=u.a}}}(Qa),function(e){const t=Qa;e.render=function(e,s,i){let n=i,r=s;void 0!==n||s&&s.getContext||(n=s,s=void 0),s||(r=function(){try{return document.createElement("canvas")}catch(Tx){throw new Error("You need to specify a canvas element")}}()),n=t.getOptions(n);const a=t.getImageWidth(e.modules.size,n),o=r.getContext("2d"),l=o.createImageData(a,a);return t.qrToImageData(l.data,e,n),function(e,t,s){e.clearRect(0,0,t.width,t.height),t.style||(t.style={}),t.height=s,t.width=s,t.style.height=s+"px",t.style.width=s+"px"}(o,r,a),o.putImageData(l,0,0),r},e.renderToDataURL=function(t,s,i){let n=i;void 0!==n||s&&s.getContext||(n=s,s=void 0),n||(n={});const r=e.render(t,s,n),a=n.type||"image/png",o=n.rendererOpts||{};return r.toDataURL(a,o.quality)}}(Xa);var Za={};const eo=Qa;function to(e,t){const s=e.a/255,i=t+'="'+e.hex+'"';return s<1?i+" "+t+'-opacity="'+s.toFixed(2).slice(1)+'"':i}function so(e,t,s){let i=e+t;return void 0!==s&&(i+=" "+s),i}Za.render=function(e,t,s){const i=eo.getOptions(t),n=e.modules.size,r=e.modules.data,a=n+2*i.margin,o=i.color.light.a?"<path "+to(i.color.light,"fill")+' d="M0 0h'+a+"v"+a+'H0z"/>':"",l="<path "+to(i.color.dark,"stroke")+' d="'+function(e,t,s){let i="",n=0,r=!1,a=0;for(let o=0;o<e.length;o++){const l=Math.floor(o%t),c=Math.floor(o/t);l||r||(r=!0),e[o]?(a++,o>0&&l>0&&e[o-1]||(i+=r?so("M",l+s,.5+c+s):so("m",n,0),n=0,r=!1),l+1<t&&e[o+1]||(i+=so("h",a),a=0)):n++}return i}(r,n,i.margin)+'"/>',c='viewBox="0 0 '+a+" "+a+'"',d='<svg xmlns="http://www.w3.org/2000/svg" '+(i.width?'width="'+i.width+'" height="'+i.width+'" ':"")+c+' shape-rendering="crispEdges">'+o+l+"</svg>\n";return"function"==typeof s&&s(null,d),d};const io=function(){return"function"==typeof Promise&&Promise.prototype&&Promise.prototype.then},no=Lr,ro=Xa,ao=Za;function oo(e,t,s,i,n){const r=[].slice.call(arguments,1),a=r.length,o="function"==typeof r[a-1];if(!o&&!io())throw new Error("Callback required as last argument");if(!o){if(a<1)throw new Error("Too few arguments provided");return 1===a?(s=t,t=i=void 0):2!==a||t.getContext||(i=s,s=t,t=void 0),new Promise(function(n,r){try{const r=no.create(s,i);n(e(r,t,i))}catch(Tx){r(Tx)}})}if(a<2)throw new Error("Too few arguments provided");2===a?(n=s,s=t,t=i=void 0):3===a&&(t.getContext&&void 0===n?(n=i,i=void 0):(n=i,i=s,s=t,t=void 0));try{const r=no.create(s,i);n(null,e(r,t,i))}catch(Tx){n(Tx)}}Ir.create=no.create,Ir.toCanvas=oo.bind(null,ro.render),Ir.toDataURL=oo.bind(null,ro.renderToDataURL),Ir.toString=oo.bind(null,function(e,t,s){return ao.render(e,s)});class lo extends Error{constructor(e){super(e),this.name="EncryptionError"}}function co(e,t="phi"){try{if(!e)throw new lo("Cannot encrypt empty plaintext");const s="phi"===t?Ui.phiKey:Ui.auditKey,i=E.lib.WordArray.random(12),n=E.AES.encrypt(e,s,{iv:i,mode:E.mode.GCM,padding:E.pad.NoPadding});return i.concat(n.ciphertext).toString(E.enc.Base64)}catch(s){throw new lo(`Encryption failed: ${s instanceof Error?s.message:"Unknown error"}`)}}function uo(e,t="phi"){try{if(!e)throw new lo("Cannot decrypt empty ciphertext");const s="phi"===t?Ui.phiKey:Ui.auditKey,i=E.enc.Base64.parse(e),n=E.lib.WordArray.create(i.words.slice(0,3)),r=E.lib.WordArray.create(i.words.slice(3)),a=E.AES.decrypt({ciphertext:r},s,{iv:n,mode:E.mode.GCM,padding:E.pad.NoPadding}).toString(E.enc.Utf8);if(!a)throw new lo("Decryption failed - invalid ciphertext or key");return a}catch(s){throw new lo(`Decryption failed: ${s instanceof Error?s.message:"Unknown error"}`)}}const ho=new class{constructor(){f(this,"issuer","CareXPS Healthcare CRM"),f(this,"algorithm","SHA1"),f(this,"digits",6),f(this,"period",30),f(this,"window",2),f(this,"maxAttempts",3),f(this,"sessionDuration",9e5),f(this,"phiSessionDuration",3e5),f(this,"activeSessions",new Map),f(this,"failedAttempts",new Map),f(this,"SESSION_STORAGE_KEY","carexps_mfa_sessions"),this.loadSessionsFromStorage()}saveSessionsToStorage(){try{const e=Array.from(this.activeSessions.entries()).map(([e,t])=>({token:e,session:u(d({},t),{verifiedAt:t.verifiedAt.toISOString(),expiresAt:t.expiresAt.toISOString()})}));localStorage.setItem(this.SESSION_STORAGE_KEY,JSON.stringify(e))}catch(e){}}loadSessionsFromStorage(){try{const e=localStorage.getItem(this.SESSION_STORAGE_KEY);if(e){const t=JSON.parse(e),s=new Date;for(const{token:e,session:i}of t){const t=u(d({},i),{verifiedAt:new Date(i.verifiedAt),expiresAt:new Date(i.expiresAt)});t.expiresAt>s&&this.activeSessions.set(e,t)}this.saveSessionsToStorage()}}catch(e){localStorage.removeItem(this.SESSION_STORAGE_KEY)}}generateSecret(e,t){return p(this,null,function*(){try{try{yield W.logPHIAccess(V.CREATE,G.SYSTEM,`mfa-setup-${e}`,J.SUCCESS,{operation:"mfa_secret_generation",targetUser:e})}catch(s){}const i=new Er({size:20}),n=new Pr({issuer:this.issuer,label:t,algorithm:this.algorithm,digits:this.digits,period:this.period,secret:i}),r=this.generateBackupCodes(),a=n.toString(),o=yield Ir.toDataURL(a),l=i.base32,c=yield z.encrypt(l),d=yield Promise.all(r.map(e=>z.encrypt(e)));return yield this.storeMFAData(e,{encryptedSecret:c,encryptedBackupCodes:d,createdAt:(new Date).toISOString(),verified:!1}),{secret:l,backupCodes:r,qrCodeUrl:o,manualEntryKey:l}}catch(i){yield W.logPHIAccess(V.CREATE,G.SYSTEM,`mfa-setup-${e}`,J.FAILURE,{operation:"mfa_secret_generation_failed",error:i instanceof Error?i.message:"Unknown error"});const t=i instanceof Error?i.message:"Unknown error occurred";throw new Error(`Failed to generate MFA secret: ${t}`)}})}verifyTOTP(e,t,s=!1){return p(this,null,function*(){var i;try{const n=this.checkRateLimit(e);if(!n.allowed)return yield W.logPHIAccess(V.LOGIN_FAILURE,G.SYSTEM,`mfa-verification-${e}`,J.FAILURE,{operation:"mfa_rate_limited",remainingAttempts:n.remainingAttempts,phiAccess:s}),{success:!1,message:"Too many failed attempts. Please wait before trying again.",remainingAttempts:n.remainingAttempts};const r=yield this.getMFAData(e);if(!r)return yield W.logPHIAccess(V.LOGIN_FAILURE,G.SYSTEM,`mfa-verification-${e}`,J.FAILURE,{operation:"mfa_not_setup",phiAccess:s}),{success:!1,message:"MFA not set up for this user"};if(r.temporarilyDisabled)return{success:!1,message:"MFA is temporarily disabled. Please contact your administrator."};const a=yield z.decrypt(r.encryptedSecret),o=new Pr({issuer:this.issuer,algorithm:this.algorithm,digits:this.digits,period:this.period,secret:Er.fromBase32(a)});if(null!==o.validate({token:t,window:this.window})){this.failedAttempts.delete(e);const t=this.createMFASession(e,s);return this.activeSessions.set(t.sessionToken,t),this.saveSessionsToStorage(),r.verified=!0,yield this.storeMFAData(e,r),yield W.logPHIAccess(V.LOGIN,G.SYSTEM,`mfa-verification-${e}`,J.SUCCESS,{operation:"mfa_verification_success",phiAccess:s,sessionToken:t.sessionToken}),{success:!0,message:s?"PHI access granted":"MFA verification successful",session:t}}{if(yield this.verifyBackupCode(e,t)){const t=this.createMFASession(e,s);return this.activeSessions.set(t.sessionToken,t),this.saveSessionsToStorage(),yield W.logPHIAccess(V.LOGIN,G.SYSTEM,`mfa-verification-${e}`,J.SUCCESS,{operation:"backup_code_used",phiAccess:s}),{success:!0,message:"Backup code verification successful",session:t}}this.recordFailedAttempt(e);const n=this.maxAttempts-((null==(i=this.failedAttempts.get(e))?void 0:i.count)||0);return yield W.logPHIAccess(V.LOGIN_FAILURE,G.SYSTEM,`mfa-verification-${e}`,J.FAILURE,{operation:"invalid_mfa_token",remainingAttempts:n,phiAccess:s}),{success:!1,message:"Invalid verification code",remainingAttempts:n}}}catch(n){return yield W.logPHIAccess(V.LOGIN_FAILURE,G.SYSTEM,`mfa-verification-${e}`,J.FAILURE,{operation:"mfa_verification_error",error:n instanceof Error?n.message:"Unknown error"}),{success:!1,message:"Verification failed due to system error"}}})}verifyPHIAccess(e){return p(this,null,function*(){const t=this.activeSessions.get(e);return t?t.verified&&t.phiAccessEnabled?new Date>t.expiresAt?(this.activeSessions.delete(e),this.saveSessionsToStorage(),yield W.logPHIAccess(V.VIEW,G.SYSTEM,"phi-access-check",J.FAILURE,{operation:"expired_session",userId:t.userId}),!1):(yield W.logPHIAccess(V.VIEW,G.SYSTEM,"phi-access-check",J.SUCCESS,{operation:"phi_access_verified",userId:t.userId}),!0):(yield W.logPHIAccess(V.VIEW,G.SYSTEM,"phi-access-check",J.FAILURE,{operation:"insufficient_mfa_privileges",userId:t.userId}),!1):(yield W.logPHIAccess(V.VIEW,G.SYSTEM,"phi-access-check",J.FAILURE,{operation:"invalid_session_token",sessionToken:e}),!1)})}getMFASession(e){const t=this.activeSessions.get(e);return t&&new Date<=t.expiresAt?t:(t&&(this.activeSessions.delete(e),this.saveSessionsToStorage()),null)}getCurrentSession(e){let t=null,s=0,i=!1;for(const[n,r]of this.activeSessions.entries())if(r.userId===e){if(new Date>r.expiresAt){this.activeSessions.delete(n),i=!0;continue}const e=new Date(r.verifiedAt).getTime();e>s&&(s=e,t=r)}return i&&this.saveSessionsToStorage(),t}hasMFAEnabled(e){return p(this,null,function*(){const t=yield this.getMFAData(e);return null!==t&&null!==t.encryptedSecret&&!t.temporarilyDisabled&&t.verified})}hasMFASetup(e){return p(this,null,function*(){const t=yield this.getMFAData(e);return null!==t&&null!==t.encryptedSecret})}hasMFAEnabledSync(e){const t=this.getLocalMFAData(e);return null!==t&&null!==t.encryptedSecret&&!t.temporarilyDisabled&&t.verified}hasMFASetupSync(e){const t=this.getLocalMFAData(e);return null!==t&&null!==t.encryptedSecret}getMFAStatus(e){return p(this,null,function*(){var t;const s=yield this.getMFAData(e),i=this.generateUserAgentFingerprint();return s&&s.encryptedSecret?{hasSetup:!0,isEnabled:!s.temporarilyDisabled&&s.verified,isTemporarilyDisabled:s.temporarilyDisabled||!1,setupDate:s.createdAt||s.storedAt||null,disabledDate:s.disabledAt||null,deviceFingerprint:i,registeredDevices:s.registeredDevices||[i],lastSyncedAt:(null==(t=s.cloudMetadata)?void 0:t.lastSync)||s.storedAt||null,isAvailableOnThisDevice:!0}:{hasSetup:!1,isEnabled:!1,isTemporarilyDisabled:!1,setupDate:null,disabledDate:null,deviceFingerprint:null,registeredDevices:[],lastSyncedAt:null,isAvailableOnThisDevice:!1}})}forceSyncFromCloud(e){return p(this,null,function*(){try{return null!==(yield this.syncFromCloud(e))}catch(t){return!1}})}getRegisteredDevices(e){return p(this,null,function*(){try{const{data:t,error:s}=yield Di.from("user_mfa_configs").select("registered_devices").eq("user_id",e).eq("is_active",!0).single();return s||!t?[]:t.registered_devices||[]}catch(t){return[]}})}disableMFA(e){return p(this,null,function*(){yield W.logPHIAccess(V.UPDATE,G.SYSTEM,`mfa-disable-${e}`,J.SUCCESS,{operation:"mfa_disabled_temporarily"});const t=yield this.getMFAData(e);t&&(t.temporarilyDisabled=!0,t.disabledAt=(new Date).toISOString(),t.verified=!1,yield this.storeMFAData(e,t));let s=!1;for(const[i,n]of this.activeSessions.entries())n.userId===e&&(this.activeSessions.delete(i),s=!0);s&&this.saveSessionsToStorage()})}permanentlyRemoveMFA(e){return p(this,null,function*(){yield W.logPHIAccess(V.DELETE,G.SYSTEM,`mfa-remove-${e}`,J.SUCCESS,{operation:"mfa_permanently_removed"});[this.getMFAStorageKey(e),`mfa_simple_${e}`,`mfa_data_${e}`,`mfa_global_${e}`].forEach(e=>{localStorage.removeItem(e)});try{yield Di.from("user_mfa_configs").delete().eq("user_id",e)}catch(s){}let t=!1;for(const[i,n]of this.activeSessions.entries())n.userId===e&&(this.activeSessions.delete(i),t=!0);t&&this.saveSessionsToStorage()})}enableMFA(e){return p(this,null,function*(){const t=yield this.getMFAData(e);return!(!t||!t.encryptedSecret)&&(t.temporarilyDisabled=!1,t.enabledAt=(new Date).toISOString(),delete t.disabledAt,yield this.storeMFAData(e,t),yield W.logPHIAccess(V.UPDATE,G.SYSTEM,`mfa-enable-${e}`,J.SUCCESS,{operation:"mfa_re_enabled"}),!0)})}invalidateSession(e){return p(this,null,function*(){const t=this.activeSessions.get(e);t&&(yield W.logPHIAccess(V.LOGOUT,G.SYSTEM,`mfa-session-${t.userId}`,J.SUCCESS,{operation:"session_invalidated",sessionToken:e}),this.activeSessions.delete(e),this.saveSessionsToStorage())})}generateBackupCodes(){const e=[];for(let t=0;t<10;t++){const t=Math.random().toString(36).substr(2,8).toUpperCase();e.push(t)}return e}verifyBackupCode(e,t){return p(this,null,function*(){const s=yield this.getMFAData(e);if(!s||!s.encryptedBackupCodes)return!1;for(let n=0;n<s.encryptedBackupCodes.length;n++)try{if((yield z.decrypt(s.encryptedBackupCodes[n]))===t.toUpperCase())return s.encryptedBackupCodes.splice(n,1),yield this.storeMFAData(e,s),!0}catch(i){}return!1})}createMFASession(e,t){const s=this.generateSessionToken(),i=new Date,n=t?this.phiSessionDuration:this.sessionDuration;return{userId:e,verified:!0,verifiedAt:i,expiresAt:new Date(i.getTime()+n),sessionToken:s,phiAccessEnabled:t}}generateSessionToken(){const e=new Uint8Array(32);return crypto.getRandomValues(e),Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}checkRateLimit(e){const t=this.failedAttempts.get(e);if(!t)return{allowed:!0,remainingAttempts:this.maxAttempts};if((new Date).getTime()-t.lastAttempt.getTime()>9e5)return this.failedAttempts.delete(e),{allowed:!0,remainingAttempts:this.maxAttempts};const s=this.maxAttempts-t.count;return{allowed:s>0,remainingAttempts:s}}recordFailedAttempt(e){const t=this.failedAttempts.get(e);t?(t.count++,t.lastAttempt=new Date):this.failedAttempts.set(e,{count:1,lastAttempt:new Date})}generateUserAgentFingerprint(){const e=document.createElement("canvas"),t=e.getContext("2d");t.textBaseline="top",t.font="14px Arial",t.fillText("Device fingerprint",2,2);const s=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,(new Date).getTimezoneOffset(),e.toDataURL()].join("|");let i=0;for(let n=0;n<s.length;n++){i=(i<<5)-i+s.charCodeAt(n),i&=i}return Math.abs(i).toString(36)}getMFAStorageKey(e){return`mfa_persistent_${e}_${this.generateUserAgentFingerprint()}`}storeMFAData(e,t){return p(this,null,function*(){const s=(new Date).toISOString(),i=this.generateUserAgentFingerprint(),n=u(d({},t),{deviceFingerprint:i,userAgent:navigator.userAgent,storedAt:s,lastAccessedAt:s});this.storeLocalMFAData(e,n);try{yield this.storeCloudMFAData(e,n,i)}catch(r){}})}storeLocalMFAData(e,t){const s=this.getMFAStorageKey(e),i=`mfa_data_${e}`,n=`mfa_global_${e}`,r=`mfa_simple_${e}`;try{const e=JSON.stringify(t);localStorage.setItem(s,e),localStorage.setItem(i,e),localStorage.setItem(n,e),localStorage.setItem(r,e);if(!localStorage.getItem(r))throw new Error("Failed to verify MFA data storage")}catch(a){throw a}}storeCloudMFAData(e,t,s){return p(this,null,function*(){try{const i=t.encryptedSecret||(t.secret?co(t.secret):null),n=t.encryptedBackupCodes||(t.backupCodes?t.backupCodes.map(e=>co(e)):[]),{data:r}=yield Di.from("user_mfa_configs").select("registered_devices").eq("user_id",e).single();let a=[];(null==r?void 0:r.registered_devices)&&(a=r.registered_devices),a.includes(s)||a.push(s);const o={user_id:e,encrypted_secret:i,encrypted_backup_codes:n,is_active:!0,is_verified:t.verified||!1,temporarily_disabled:t.temporarilyDisabled||!1,registered_devices:a,verified_at:t.verified?(new Date).toISOString():null,disabled_at:t.disabledAt||null,last_used_at:(new Date).toISOString(),created_by_device_fingerprint:s,last_used_device_fingerprint:s,metadata:{userAgent:navigator.userAgent,localStorageData:t,createdAt:t.createdAt||t.storedAt,lastSync:(new Date).toISOString()}},{error:l}=yield Di.from("user_mfa_configs").upsert(o,{onConflict:"user_id"})}catch(i){}})}getMFAData(e){return p(this,null,function*(){try{const t=this.getLocalMFAData(e);if(t){return this.shouldSyncFromCloud(t)&&this.syncFromCloud(e).catch(e=>{}),t}const s=yield this.syncFromCloud(e);return s||null}catch(t){return null}})}getLocalMFAData(e){try{const s=[this.getMFAStorageKey(e),`mfa_simple_${e}`,`mfa_data_${e}`,`mfa_global_${e}`];for(const i of s){const s=localStorage.getItem(i);if(s)try{const t=JSON.parse(s);if(t&&t.encryptedSecret){t.lastAccessedAt=(new Date).toISOString();const s=this.getMFAStorageKey(e);return localStorage.setItem(s,JSON.stringify(t)),t}}catch(t){continue}}return null}catch(s){return null}}shouldSyncFromCloud(e){if(!e.lastAccessedAt)return!0;const t=new Date(e.lastAccessedAt);return((new Date).getTime()-t.getTime())/36e5>1}syncFromCloud(e){return p(this,null,function*(){try{const{data:t,error:s}=yield Di.from("user_mfa_configs").select("*").eq("user_id",e).eq("is_active",!0).single();if(s){if("PGRST116"===s.code)return null;throw s}if(!t)return null;const i={encryptedSecret:t.encrypted_secret,encryptedBackupCodes:t.encrypted_backup_codes,verified:t.is_verified,temporarilyDisabled:t.temporarily_disabled,createdAt:t.created_at,verifiedAt:t.verified_at,disabledAt:t.disabled_at,lastUsedAt:t.last_used_at,deviceFingerprint:this.generateUserAgentFingerprint(),userAgent:navigator.userAgent,storedAt:(new Date).toISOString(),lastAccessedAt:(new Date).toISOString(),registeredDevices:t.registered_devices,syncedFromCloud:!0,cloudMetadata:t.metadata};this.storeLocalMFAData(e,i);const n=this.generateUserAgentFingerprint();let r=t.registered_devices||[];return r.includes(n)||(r.push(n),yield Di.from("user_mfa_configs").update({registered_devices:r,last_used_at:(new Date).toISOString(),last_used_device_fingerprint:n,metadata:u(d({},t.metadata),{lastSync:(new Date).toISOString(),syncFromDevice:n})}).eq("user_id",e)),i}catch(t){return null}})}cleanupExpiredSessions(){const e=new Date;let t=!1;for(const[s,i]of this.activeSessions.entries())e>i.expiresAt&&(this.activeSessions.delete(s),t=!0);t&&this.saveSessionsToStorage()}};setInterval(()=>{ho.cleanupExpiredSessions()},6e4);
/**
 * @license lucide-react v0.439.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */
const fo=(...e)=>e.filter((e,t,s)=>Boolean(e)&&s.indexOf(e)===t).join(" ");
/**
 * @license lucide-react v0.439.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */
var mo={xmlns:"http://www.w3.org/2000/svg",width:24,height:24,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"};
/**
 * @license lucide-react v0.439.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const po=v.forwardRef((e,t)=>{var s=e,{color:i="currentColor",size:n=24,strokeWidth:r=2,absoluteStrokeWidth:a,className:o="",children:l,iconNode:c}=s,f=h(s,["color","size","strokeWidth","absoluteStrokeWidth","className","children","iconNode"]);return v.createElement("svg",d(u(d({ref:t},mo),{width:n,height:n,stroke:i,strokeWidth:a?24*Number(r)/Number(n):r,className:fo("lucide",o)}),f),[...c.map(([e,t])=>v.createElement(e,t)),...Array.isArray(l)?l:[l]])}),go=(e,t)=>{const s=v.forwardRef((s,i)=>{var n,r=s,{className:a}=r,o=h(r,["className"]);return v.createElement(po,d({ref:i,iconNode:t,className:fo(`lucide-${n=e,n.replace(/([a-z0-9])([A-Z])/g,"$1-$2").toLowerCase()}`,a)},o))});return s.displayName=`${e}`,s},vo=go("Activity",[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]]),yo=go("Bot",[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]]),bo=go("Calendar",[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]]),xo=go("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]),wo=go("ChartColumn",[["path",{d:"M3 3v16a2 2 0 0 0 2 2h16",key:"c24i48"}],["path",{d:"M18 17V9",key:"2bz60n"}],["path",{d:"M13 17V5",key:"1frdt8"}],["path",{d:"M8 17v-3",key:"17ska0"}]]),So=go("Check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]]),ko=go("ChevronDown",[["path",{d:"m6 9 6 6 6-6",key:"qrunsl"}]]),_o=go("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]),Co=go("CircleAlert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]]),No=go("CircleCheckBig",[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]]),To=go("CirclePlay",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polygon",{points:"10 8 16 12 10 16 10 8",key:"1cimsy"}]]),Ao=go("CircleStop",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["rect",{width:"6",height:"6",x:"9",y:"9",key:"1wrtvo"}]]),Eo=go("Clock",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["polyline",{points:"12 6 12 12 16 14",key:"68esgv"}]]),jo=go("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]),Po=go("DollarSign",[["line",{x1:"12",x2:"12",y1:"2",y2:"22",key:"7eqyqh"}],["path",{d:"M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6",key:"1b0p4s"}]]),Io=go("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]),Lo=go("EyeOff",[["path",{d:"M10.733 5.076a10.744 10.744 0 0 1 11.205 6.575 1 1 0 0 1 0 .696 10.747 10.747 0 0 1-1.444 2.49",key:"ct8e1f"}],["path",{d:"M14.084 14.158a3 3 0 0 1-4.242-4.242",key:"151rxh"}],["path",{d:"M17.479 17.499a10.75 10.75 0 0 1-15.417-5.151 1 1 0 0 1 0-.696 10.75 10.75 0 0 1 4.446-5.143",key:"13bj9a"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]),Ro=go("Eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),Oo=go("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]]),Do=go("House",[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8",key:"5wwlr5"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-5.999a2 2 0 0 1 2.582 0l7 5.999A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"1d0kgt"}]]),Mo=go("Key",[["path",{d:"m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 4",key:"g0fldk"}],["path",{d:"m21 2-9.6 9.6",key:"1j0ho8"}],["circle",{cx:"7.5",cy:"15.5",r:"5.5",key:"yqb3hr"}]]),Uo=go("Link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]),Fo=go("Loader",[["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m16.2 7.8 2.9-2.9",key:"r700ao"}],["path",{d:"M18 12h4",key:"wj9ykh"}],["path",{d:"m16.2 16.2 2.9 2.9",key:"1bxg5t"}],["path",{d:"M12 18v4",key:"jadmvz"}],["path",{d:"m4.9 19.1 2.9-2.9",key:"bwix9q"}],["path",{d:"M2 12h4",key:"j09sii"}],["path",{d:"m4.9 4.9 2.9 2.9",key:"giyufr"}]]),Bo=go("LockOpen",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 9.9-1",key:"1mm8w8"}]]),qo=go("Lock",[["rect",{width:"18",height:"11",x:"3",y:"11",rx:"2",ry:"2",key:"1w4ew1"}],["path",{d:"M7 11V7a5 5 0 0 1 10 0v4",key:"fwvmzm"}]]),$o=go("LogOut",[["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}],["polyline",{points:"16 17 21 12 16 7",key:"1gabdz"}],["line",{x1:"21",x2:"9",y1:"12",y2:"12",key:"1uyos4"}]]),zo=go("Mail",[["rect",{width:"20",height:"16",x:"2",y:"4",rx:"2",key:"18n3k1"}],["path",{d:"m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7",key:"1ocrg3"}]]),Ho=go("Menu",[["line",{x1:"4",x2:"20",y1:"12",y2:"12",key:"1e0a9i"}],["line",{x1:"4",x2:"20",y1:"6",y2:"6",key:"1owob3"}],["line",{x1:"4",x2:"20",y1:"18",y2:"18",key:"yk5zj1"}]]),Vo=go("MessageCircle",[["path",{d:"M7.9 20A9 9 0 1 0 4 16.1L2 22Z",key:"vv11sd"}]]),Go=go("MessageSquare",[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]]),Jo=go("MicOff",[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M18.89 13.23A7.12 7.12 0 0 0 19 12v-2",key:"80xlxr"}],["path",{d:"M5 10v2a7 7 0 0 0 12 5",key:"p2k8kg"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]),Wo=go("Mic",[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]),Ko=go("Monitor",[["rect",{width:"20",height:"14",x:"2",y:"3",rx:"2",key:"48i651"}],["line",{x1:"8",x2:"16",y1:"21",y2:"21",key:"1svkeh"}],["line",{x1:"12",x2:"12",y1:"17",y2:"21",key:"vw1qmm"}]]),Yo=go("Moon",[["path",{d:"M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z",key:"a7tn18"}]]),Xo=go("Palette",[["circle",{cx:"13.5",cy:"6.5",r:".5",fill:"currentColor",key:"1okk4w"}],["circle",{cx:"17.5",cy:"10.5",r:".5",fill:"currentColor",key:"f64h9f"}],["circle",{cx:"8.5",cy:"7.5",r:".5",fill:"currentColor",key:"fotxhn"}],["circle",{cx:"6.5",cy:"12.5",r:".5",fill:"currentColor",key:"qy21gx"}],["path",{d:"M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z",key:"12rzf8"}]]),Qo=go("PhoneCall",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}],["path",{d:"M14.05 2a9 9 0 0 1 8 7.94",key:"vmijpz"}],["path",{d:"M14.05 6A5 5 0 0 1 18 10",key:"13nbpp"}]]),Zo=go("PhoneOff",[["path",{d:"M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-3.33-2.67m-2.67-3.34a19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91",key:"z86iuo"}],["line",{x1:"22",x2:"2",y1:"2",y2:"22",key:"11kh81"}]]),el=go("Phone",[["path",{d:"M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z",key:"foiqr5"}]]),tl=go("Pin",[["path",{d:"M12 17v5",key:"bb1du9"}],["path",{d:"M9 10.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V16a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V7a1 1 0 0 1 1-1 2 2 0 0 0 0-4H8a2 2 0 0 0 0 4 1 1 0 0 1 1 1z",key:"1nkz8b"}]]),sl=go("Plus",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"M12 5v14",key:"s699le"}]]),il=go("QrCode",[["rect",{width:"5",height:"5",x:"3",y:"3",rx:"1",key:"1tu5fj"}],["rect",{width:"5",height:"5",x:"16",y:"3",rx:"1",key:"1v8r4q"}],["rect",{width:"5",height:"5",x:"3",y:"16",rx:"1",key:"1x03jg"}],["path",{d:"M21 16h-3a2 2 0 0 0-2 2v3",key:"177gqh"}],["path",{d:"M21 21v.01",key:"ents32"}],["path",{d:"M12 7v3a2 2 0 0 1-2 2H7",key:"8crl2c"}],["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M12 3h.01",key:"n36tog"}],["path",{d:"M12 16v.01",key:"133mhm"}],["path",{d:"M16 12h1",key:"1slzba"}],["path",{d:"M21 12v.01",key:"1lwtk9"}],["path",{d:"M12 21v-1",key:"1880an"}]]),nl=go("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]),rl=go("Save",[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]]),al=go("Search",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["path",{d:"m21 21-4.3-4.3",key:"1qie3q"}]]),ol=go("Settings",[["path",{d:"M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z",key:"1qme2f"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]]),ll=go("ShieldCheck",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),cl=go("Shield",[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}]]),dl=go("Smartphone",[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]]),ul=go("SquarePen",[["path",{d:"M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1m0v6g"}],["path",{d:"M18.375 2.625a1 1 0 0 1 3 3l-9.013 9.014a2 2 0 0 1-.853.505l-2.873.84a.5.5 0 0 1-.62-.62l.84-2.873a2 2 0 0 1 .506-.852z",key:"ohrbg2"}]]),hl=go("StickyNote",[["path",{d:"M16 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V8Z",key:"qazsjp"}],["path",{d:"M15 3v4a2 2 0 0 0 2 2h4",key:"40519r"}]]),fl=go("Sun",[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]]),ml=go("Tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]]),pl=go("ThumbsUp",[["path",{d:"M7 10v12",key:"1qc93n"}],["path",{d:"M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z",key:"emmmcr"}]]),gl=go("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]]),vl=go("Trash",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}]]),yl=go("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]),bl=go("TriangleAlert",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]),xl=go("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),wl=go("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),Sl=go("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]),kl=go("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]),_l=go("X",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]]),Cl=e=>{const t=(e=>{if(!(null==e?void 0:e.id))return!1;try{return!!ho.getCurrentSession(e.id)||"true"===localStorage.getItem("mfa_verified")}catch(t){return"true"===localStorage.getItem("mfa_verified")}})(e);return[{name:"Dashboard",href:"/dashboard",icon:Do,description:"Overview and system status"},...t?[{name:"Calls",href:"/calls",icon:el,description:"Call management and analytics",requiresMFA:!0},{name:"Call Analytics",href:"/call-analytics",icon:wo,description:"Call performance insights",requiresMFA:!0},{name:"SMS",href:"/sms",icon:Go,description:"SMS management and analytics",requiresMFA:!0},{name:"SMS Analytics",href:"/sms-analytics",icon:yl,description:"SMS performance insights",requiresMFA:!0}]:[],..."super_user"===(null==e?void 0:e.role)?[{name:"User Management",href:"/users",icon:Sl,description:"Manage system users"}]:[],{name:"Settings",href:"/settings",icon:ol,description:"System configuration"}]},Nl=({isOpen:e,onToggle:t,user:s})=>{const i=k();return F.jsxs(F.Fragment,{children:[e&&F.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden",onClick:t}),F.jsxs("div",{className:"fixed inset-y-0 left-0 z-50 w-64 bg-white border-r border-gray-200 transform transition-transform duration-300 ease-in-out lg:translate-x-0 lg:static lg:inset-0 "+(e?"translate-x-0":"-translate-x-full"),children:[F.jsxs("div",{className:"flex items-center justify-between h-16 px-6 border-b border-gray-200",children:[F.jsx("div",{className:"flex items-center gap-3",children:F.jsx(_,{to:"/dashboard",className:"hover:opacity-80 transition-opacity",children:F.jsx("img",{src:"https://carexps.nexasync.ca/images/Logo.png",alt:"CareXPS Logo",className:"h-10 w-auto object-contain cursor-pointer"})})}),F.jsx("button",{onClick:t,className:"p-1 rounded-md hover:bg-gray-100 lg:hidden",children:F.jsx(_o,{className:"w-5 h-5 text-gray-500"})})]}),F.jsx("nav",{className:"flex-1 p-4 space-y-2",children:Cl(s).map(e=>{const t=e.icon,s=i.pathname===e.href;return F.jsxs(_,{to:e.href,className:"group flex items-center gap-3 px-3 py-2 text-sm font-medium rounded-lg transition-all duration-200 "+(s?"bg-gray-100 text-gray-900":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"),children:[F.jsx(t,{className:"w-5 h-5 "+(s?"text-gray-700":"text-gray-400 group-hover:text-gray-600")}),F.jsxs("div",{className:"flex-1",children:[F.jsx("span",{children:e.name}),F.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:e.description})]}),s&&F.jsx("div",{className:"w-2 h-2 bg-gray-600 rounded-full"})]},e.name)})}),F.jsxs("div",{className:"p-4 border-t border-gray-200",children:[F.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[F.jsx(vo,{className:"w-4 h-4"}),F.jsx("span",{children:"All activities are logged"})]}),F.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 mt-1",children:[F.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full"}),F.jsx("span",{children:"System healthy"})]})]})]})]})},Tl=({getTimeRemaining:e,onExtendSession:t,className:s=""})=>{const[i,n]=v.useState(e()),[r,a]=v.useState(!1);v.useEffect(()=>{const t=()=>{n(e())},s=setInterval(t,1e3);return t(),()=>clearInterval(s)},[e]);const o=(e=>{const t=Math.floor(e/6e4);return t<=2?{color:"text-red-600",bgColor:"bg-red-50",borderColor:"border-red-200",iconColor:"text-red-500",pulse:!0,urgency:"critical"}:t<=5?{color:"text-orange-600",bgColor:"bg-orange-50",borderColor:"border-orange-200",iconColor:"text-orange-500",pulse:!1,urgency:"warning"}:{color:"text-green-600",bgColor:"bg-green-50",borderColor:"border-green-200",iconColor:"text-green-500",pulse:!1,urgency:"normal"}})(i);return F.jsxs("div",{className:`flex items-center gap-2 px-3 py-2 rounded-lg border transition-all duration-300 ${o.bgColor} ${o.borderColor} ${o.pulse?"animate-pulse":""} ${s}`,children:[F.jsxs("div",{className:"flex items-center gap-2",children:["critical"===o.urgency?F.jsx(bl,{className:`w-4 h-4 ${o.iconColor}`}):F.jsx(Eo,{className:`w-4 h-4 ${o.iconColor}`}),F.jsxs("div",{className:"flex flex-col",children:[F.jsx("span",{className:`text-sm font-medium ${o.color}`,children:(e=>{const t=Math.floor(e/1e3);return`${Math.floor(t/60)}:${(t%60).toString().padStart(2,"0")}`})(i)}),F.jsx("span",{className:"text-xs text-gray-500",children:"critical"===o.urgency?"Session expiring!":"warning"===o.urgency?"Session ending soon":"Session time"})]})]}),("critical"===o.urgency||"warning"===o.urgency)&&F.jsxs("button",{onClick:()=>p(void 0,null,function*(){a(!0),t(),setTimeout(()=>{a(!1)},1e3)}),disabled:r,className:"flex items-center gap-1 px-2 py-1 text-xs font-medium bg-white rounded border hover:bg-gray-50 transition-colors disabled:opacity-50",title:"Extend session",children:[F.jsx(nl,{className:"w-3 h-3 "+(r?"animate-spin":"")}),r?"Extending...":"Extend"]})]})},Al=({user:e,onMenuToggle:t,sidebarOpen:s,onLogout:i,pageTitle:n,getTimeRemaining:r,onExtendSession:a})=>{var o;return F.jsx("header",{className:"bg-white border-b border-gray-200 px-6 py-4",children:F.jsxs("div",{className:"flex items-center justify-between",children:[F.jsx("div",{className:"flex items-center gap-4",children:F.jsx("button",{onClick:t,className:"p-2 rounded-md hover:bg-gray-100 lg:hidden",children:F.jsx(Ho,{className:"w-5 h-5 text-gray-600"})})}),n&&F.jsx("div",{className:"absolute left-1/2 transform -translate-x-1/2",children:F.jsx("h1",{className:"text-4xl font-black bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent",children:n})}),F.jsxs("div",{className:"flex items-center gap-4",children:[r&&a&&F.jsx(Tl,{getTimeRemaining:r,onExtendSession:a,className:"hidden sm:flex"}),F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsx("div",{className:"w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center overflow-hidden",children:(null==e?void 0:e.avatar)?F.jsx("img",{src:e.avatar,alt:"Profile",className:"w-full h-full object-cover",style:{backgroundColor:"#ffffff"}}):F.jsx(Sl,{className:"w-4 h-4 text-blue-600"})}),F.jsxs("div",{className:"hidden md:block",children:[F.jsx("p",{className:"text-sm font-medium text-gray-900",children:(null==e?void 0:e.name)||"Healthcare User"}),F.jsx("p",{className:"text-xs text-gray-500 capitalize",children:(null==(o=null==e?void 0:e.role)?void 0:o.replace("_"," "))||"Staff"})]})]}),F.jsx("button",{onClick:()=>{i()},className:"p-2 rounded-md hover:bg-gray-100 text-gray-600 hover:text-gray-900",title:"Logout",children:F.jsx($o,{className:"w-5 h-5"})})]})]})})},El=({variant:e="default"})=>{const t=(new Date).getFullYear(),s="transparent"===e?"bg-transparent":"bg-white border-t border-gray-100";return F.jsx("footer",{className:`${s} py-4 px-6`,children:F.jsx("div",{className:"flex items-center justify-center",children:F.jsxs("div",{className:"flex items-center gap-3 text-gray-400",children:[F.jsx("img",{src:"https://nexasync.ca/images/NexaSync-logo.png",alt:"NexaSync Logo",className:"h-4 w-auto object-contain opacity-60"}),F.jsxs("span",{className:"text-xs",children:["© ",t," NexaSync. All rights reserved."]})]})})})},jl=({onSuccess:e,user:t})=>{const[s,i]=v.useState(""),[n,r]=v.useState(!1),[a,o]=v.useState("");return F.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center px-4",children:F.jsxs("div",{className:"max-w-md w-full space-y-8",children:[F.jsxs("div",{className:"text-center",children:[F.jsx("div",{className:"mx-auto w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center",children:F.jsx(ll,{className:"w-8 h-8 text-blue-600"})}),F.jsx("h2",{className:"mt-6 text-3xl font-bold text-gray-900",children:"Multi-Factor Authentication"}),F.jsxs("p",{className:"mt-2 text-sm text-gray-600",children:["HIPAA compliance requires additional verification for ",null==t?void 0:t.name]})]}),F.jsxs("form",{className:"mt-8 space-y-6",onSubmit:n=>p(void 0,null,function*(){n.preventDefault(),r(!0),o("");try{const i=yield ho.verifyTOTP(t.id,s,!1);return i.success?void e():void o(i.message||"Invalid MFA code. Please try again.")}catch(a){o("MFA verification failed. Please try again.")}finally{r(!1),i("")}}),children:[F.jsxs("div",{children:[F.jsx("label",{htmlFor:"mfa-code",className:"sr-only",children:"Verification Code"}),F.jsxs("div",{className:"relative",children:[F.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:F.jsx(Mo,{className:"h-5 w-5 text-gray-400"})}),F.jsx("input",{id:"mfa-code",name:"mfa-code",type:"text",maxLength:6,placeholder:"Enter 6-digit code",className:"appearance-none rounded-lg relative block w-full pl-10 pr-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm",value:s,onChange:e=>i(e.target.value.replace(/\D/g,"").slice(0,6)),required:!0})]})]}),a&&F.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[F.jsx(bl,{className:"w-4 h-4"}),F.jsx("span",{children:a})]}),F.jsxs("div",{className:"flex flex-col gap-3",children:[F.jsx("button",{type:"submit",disabled:n||6!==s.length,className:"group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed",children:n?F.jsxs(F.Fragment,{children:[F.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Verifying..."]}):"Verify Code"}),F.jsx("button",{type:"button",onClick:()=>{o(""),alert("Verification code sent to your registered device.")},className:"w-full text-sm text-blue-600 hover:text-blue-500 focus:outline-none focus:underline",children:"Didn't receive code? Resend"})]})]}),F.jsx("div",{className:"mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4",children:F.jsxs("div",{className:"flex",children:[F.jsx("div",{className:"flex-shrink-0",children:F.jsx(ll,{className:"h-5 w-5 text-blue-400"})}),F.jsxs("div",{className:"ml-3",children:[F.jsx("h3",{className:"text-sm font-medium text-blue-800",children:"HIPAA Compliance Notice"}),F.jsxs("div",{className:"mt-2 text-sm text-blue-700",children:[F.jsx("p",{children:"This additional authentication step is required to protect patient health information (PHI) in accordance with HIPAA security regulations."}),F.jsx("p",{className:"mt-2 text-xs",children:t&&localStorage.getItem(`mfa_secret_${t.id}`)?"Use your authenticator app or backup codes to generate the verification code.":"For demo: Use code 123456"})]})]})]})})]})})},Pl=({user:e,children:t,requiresMFA:s=!0})=>{if(!s)return F.jsx(F.Fragment,{children:t});const i=(e=>{if(!(null==e?void 0:e.id))return!1;try{return!!ho.getCurrentSession(e.id)||"true"===localStorage.getItem("mfa_verified")}catch(t){return"true"===localStorage.getItem("mfa_verified")}})(e);return i?F.jsx(F.Fragment,{children:t}):F.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center px-4",children:F.jsxs("div",{className:"max-w-md w-full space-y-8",children:[F.jsxs("div",{className:"text-center",children:[F.jsx("div",{className:"mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center",children:F.jsx(qo,{className:"w-8 h-8 text-red-600"})}),F.jsx("h2",{className:"mt-6 text-3xl font-bold text-gray-900",children:"Access Restricted"}),F.jsx("p",{className:"mt-2 text-sm text-gray-600",children:"Multi-Factor Authentication is required to access this page"})]}),F.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:F.jsxs("div",{className:"flex",children:[F.jsx("div",{className:"flex-shrink-0",children:F.jsx(bl,{className:"h-5 w-5 text-red-400"})}),F.jsxs("div",{className:"ml-3",children:[F.jsx("h3",{className:"text-sm font-medium text-red-800",children:"HIPAA Security Requirement"}),F.jsxs("div",{className:"mt-2 text-sm text-red-700",children:[F.jsx("p",{children:"This page contains Protected Health Information (PHI) and requires Multi-Factor Authentication for access in compliance with HIPAA regulations."}),(null==e?void 0:e.mfa_enabled)?localStorage.getItem(`mfa_secret_${e.id}`)?F.jsxs("div",{className:"mt-4",children:[F.jsx("p",{className:"font-medium",children:"MFA verification required:"}),F.jsx("p",{className:"mt-1",children:"You need to complete MFA verification to access this page. Navigate to a page that requires MFA to trigger the verification process."})]}):F.jsxs("div",{className:"mt-4",children:[F.jsx("p",{className:"font-medium",children:"Complete MFA setup:"}),F.jsx("p",{className:"mt-1",children:"MFA is enabled but setup is incomplete. Please complete the setup process in Settings."})]}):F.jsxs("div",{className:"mt-4",children:[F.jsx("p",{className:"font-medium",children:"Steps to gain access:"}),F.jsxs("ol",{className:"mt-2 list-decimal list-inside space-y-1",children:[F.jsx("li",{children:"Go to Settings → Security & Privacy"}),F.jsx("li",{children:"Enable Multi-Factor Authentication"}),F.jsx("li",{children:"Complete the MFA setup process"}),F.jsx("li",{children:"Return to this page and verify your identity"})]})]})]})]})]})}),F.jsx("div",{className:"text-center",children:F.jsxs("button",{onClick:()=>window.location.href="/settings",className:"inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[F.jsx(ll,{className:"w-4 h-4"}),"Go to Security Settings"]})}),F.jsx("div",{className:"text-center",children:F.jsx("button",{onClick:()=>window.location.href="/dashboard",className:"text-sm text-gray-600 hover:text-gray-900 focus:outline-none focus:underline",children:"Return to Dashboard"})})]})})},Il=({user:e})=>(v.useEffect(()=>{if(!e)return;const t=e=>p(void 0,null,function*(){try{yield W.logPHIAccess(V.VIEW,G.SYSTEM,`page:${e}`,J.SUCCESS,{page_path:e,session_id:localStorage.getItem("carexps-auth")||"demo-session"})}catch(t){}}),s=(e,...t)=>p(void 0,[e,...t],function*(e,t={}){try{const s="user_interaction"===e?V.VIEW:"form_submission"===e?V.CREATE:"session_heartbeat"===e?V.SYSTEM_ACCESS:V.VIEW;yield W.logPHIAccess(s,G.SYSTEM,`user_action:${e}`,J.SUCCESS,u(d({},t),{session_id:localStorage.getItem("carexps-auth")||"demo-session"}))}catch(s){}});t(window.location.pathname);const i=()=>{t(window.location.pathname)},n=e=>{var t;const i=e.target;"BUTTON"!==i.tagName&&"A"!==i.tagName||s("user_interaction",{element_type:i.tagName,element_text:null==(t=i.textContent)?void 0:t.slice(0,50),element_id:i.id,element_class:i.className})},r=e=>{const t=e.target;s("form_submission",{form_id:t.id,form_action:t.action,form_method:t.method})};window.addEventListener("popstate",i),document.addEventListener("click",n),document.addEventListener("submit",r);const a=setInterval(()=>{s("session_heartbeat",{active_time:Date.now()-(parseInt(localStorage.getItem("session_start")||"0")||Date.now())})},3e5);return localStorage.getItem("session_start")||localStorage.setItem("session_start",Date.now().toString()),()=>{window.removeEventListener("popstate",i),document.removeEventListener("click",n),document.removeEventListener("submit",r),clearInterval(a)}},[e]),null),Ll=({isVisible:e,timeRemaining:t,onExtendSession:s,onLogout:i,onDismiss:n})=>{const[r,a]=v.useState(t);v.useEffect(()=>{a(t)},[t]),v.useEffect(()=>{if(!e||r<=0)return;const t=setInterval(()=>{a(e=>{const t=e-1e3;return t<=0?(i(),0):t})},1e3);return()=>clearInterval(t)},[e,r,i]);return e?F.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:F.jsx("div",{className:"bg-white rounded-lg shadow-xl max-w-md w-full mx-4",children:F.jsxs("div",{className:"p-6",children:[F.jsxs("div",{className:"flex items-center justify-between mb-4",children:[F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsx("div",{className:"w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center",children:F.jsx(bl,{className:"w-5 h-5 text-orange-600"})}),F.jsxs("div",{children:[F.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Session Expiring Soon"}),F.jsx("p",{className:"text-sm text-gray-600",children:"Your session will expire due to inactivity"})]})]}),F.jsx("button",{onClick:n,className:"text-gray-400 hover:text-gray-600 p-1",children:F.jsx(_l,{className:"w-5 h-5"})})]}),F.jsxs("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6",children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(Eo,{className:"w-4 h-4 text-orange-600"}),F.jsx("span",{className:"text-sm font-medium text-orange-800",children:"Time Remaining"})]}),F.jsx("div",{className:"text-2xl font-bold text-orange-600",children:(o=r,`${Math.floor(o/6e4)}:${Math.floor(o%6e4/1e3).toString().padStart(2,"0")}`)}),F.jsx("p",{className:"text-xs text-orange-700 mt-1",children:"You will be automatically logged out when the timer reaches zero"})]}),F.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6",children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(bl,{className:"w-4 h-4 text-blue-600"}),F.jsx("span",{className:"text-sm font-medium text-blue-800",children:"HIPAA Security Notice"})]}),F.jsx("p",{className:"text-xs text-blue-700",children:"Automatic logout protects patient health information (PHI) in compliance with HIPAA security regulations. Any unsaved changes will be lost."})]}),F.jsxs("div",{className:"flex gap-3",children:[F.jsx("button",{onClick:i,className:"flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors",children:"Logout Now"}),F.jsx("button",{onClick:s,className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:"Extend Session"})]})]})})}):null;var o},Rl=(e={})=>{const{enabled:t=!0,interval:s=6e4,onRefresh:i}=e,[n,r]=v.useState(new Date),a=v.useCallback(()=>{r(new Date),i&&i()},[i]);v.useEffect(()=>{if(!t)return;const e=setInterval(()=>{a()},s);return()=>clearInterval(e)},[t,s,a]);const o=v.useCallback(()=>n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit"}),[n]);return{lastRefreshTime:n,formatLastRefreshTime:o,refresh:a}},Ol=({selectedRange:e,onRangeChange:t,className:s=""})=>{const[i,n]=v.useState(!1),[r,a]=v.useState(""),[o,l]=v.useState(""),[c,d]=v.useState(!1),u=[{value:"today",label:"Today"},{value:"thisWeek",label:"This Week"},{value:"thisMonth",label:"This Month"},{value:"thisYear",label:"This Year"},{value:"custom",label:"Custom"}];return F.jsxs("div",{className:`relative ${s}`,children:[F.jsxs("button",{onClick:()=>n(!i),className:"flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg bg-white hover:bg-gray-50 text-gray-700 font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[F.jsx(bo,{className:"w-4 h-4 text-gray-500"}),F.jsx("span",{children:(()=>{const t=u.find(t=>t.value===e);return(null==t?void 0:t.label)||"Select Range"})()}),F.jsx(ko,{className:"w-4 h-4 text-gray-500 transition-transform "+(i?"rotate-180":"")})]}),i&&F.jsx("div",{className:"absolute top-full left-0 mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-lg z-50",children:F.jsx("div",{className:"p-2",children:c?F.jsxs("div",{className:"space-y-4",children:[F.jsxs("div",{className:"flex items-center justify-between",children:[F.jsx("h3",{className:"text-sm font-medium text-gray-900",children:"Custom Date Range"}),F.jsx("button",{onClick:()=>{d(!1),n(!1)},className:"text-gray-400 hover:text-gray-600",children:"×"})]}),F.jsxs("div",{className:"space-y-3",children:[F.jsxs("div",{children:[F.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Start Date"}),F.jsx("input",{type:"date",value:r,onChange:e=>a(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),F.jsxs("div",{children:[F.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"End Date"}),F.jsx("input",{type:"date",value:o,onChange:e=>l(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]}),F.jsxs("div",{className:"flex gap-2 pt-2",children:[F.jsx("button",{onClick:()=>{d(!1),a(""),l("")},className:"flex-1 px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors",children:"Cancel"}),F.jsx("button",{onClick:()=>{if(r&&o){const e=new Date(r),s=new Date(o);t("custom",e,s),n(!1),d(!1)}},disabled:!r||!o,className:"flex-1 px-3 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:"Apply"})]})]}):F.jsx("div",{className:"space-y-1",children:u.map(s=>F.jsx("button",{onClick:()=>{var e;"custom"===(e=s.value)?d(!0):(d(!1),t(e),n(!1))},className:"w-full text-left px-3 py-2 rounded-md text-sm hover:bg-gray-100 transition-colors "+(e===s.value?"bg-blue-50 text-blue-700 font-medium":"text-gray-700"),children:s.label},s.value))})})}),i&&F.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>{n(!1),d(!1)}})]})},Dl=(e,t,s)=>{const i=new Date,n=new Date(i.getFullYear(),i.getMonth(),i.getDate());switch(e){case"today":return{start:n,end:new Date(n.getTime()+864e5-1)};case"thisWeek":const e=new Date(n);e.setDate(n.getDate()-n.getDay()),e.setHours(0,0,0,0);const i=new Date(e);return i.setDate(e.getDate()+6),i.setHours(23,59,59,999),{start:e,end:i};case"thisMonth":const r=new Date(n.getFullYear(),n.getMonth(),1),a=new Date(n.getFullYear(),n.getMonth()+1,0);return a.setHours(23,59,59,999),{start:r,end:a};case"thisYear":const o=new Date(n.getFullYear(),0,1),l=new Date(n.getFullYear(),11,31);return l.setHours(23,59,59,999),{start:o,end:l};case"custom":if(t&&s){const e=new Date(t),i=new Date(s);return i.setHours(23,59,59,999),{start:e,end:i}}return{start:n,end:n};default:return{start:n,end:n}}};
/**
 * @license lucide-react v0.439.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */class Ml{static getLocalStorageNotes(){try{const e=localStorage.getItem(this.STORAGE_KEY);return e?JSON.parse(e):[]}catch(e){return[]}}static saveLocalStorageNotes(e){try{localStorage.setItem(this.STORAGE_KEY,JSON.stringify(e))}catch(t){}}static generateId(){return"note_"+Math.random().toString(36).substr(2,9)+"_"+Date.now()}static handleError(e,t){return{status:"error",error:e.message||"An unexpected error occurred"}}static setCurrentUserId(e){this.currentUserId=e}static checkSupabaseAvailability(){return p(this,null,function*(){if(null!==this.isSupabaseAvailable)return this.isSupabaseAvailable;try{const{data:e,error:t}=yield Di.from("call_notes").select("count").limit(1);return this.isSupabaseAvailable=!t,this.isSupabaseAvailable}catch(e){return this.isSupabaseAvailable=!1,!1}})}static getCurrentUserId(){return p(this,null,function*(){try{if(this.currentUserId)return this.currentUserId;const e=localStorage.getItem("currentUser");if(e){const t=JSON.parse(e),s=(null==t?void 0:t.id)||(null==t?void 0:t.user_id)||(null==t?void 0:t.email);if(s)return this.currentUserId=s,s}if(!e){const e="anonymous_user";return this.currentUserId=e,e}const{data:{user:t}}=yield Di.auth.getUser();return t?t.id||"default-user":null}catch(e){return null}})}static logSecurityEvent(e,t,s){return p(this,arguments,function*(e,t,s,i={}){try{yield Di.from("security_events").insert({action:e,resource:t,success:s,details:i,ip_address:null,user_agent:navigator.userAgent})}catch(n){}})}static withAuditLog(e,t,s,i,n,r){return p(this,null,function*(){const a=yield this.getCurrentUserId(),o=Date.now();try{const c=yield s();if(a)try{yield Di.from("audit_logs").insert({user_id:a,action:e,table_name:t,record_id:i,old_values:n,new_values:r,ip_address:null,user_agent:navigator.userAgent,metadata:{duration_ms:Date.now()-o,success:!0}})}catch(l){}return c}catch(c){if(a)try{yield Di.from("audit_logs").insert({user_id:a,action:e,table_name:t,record_id:i,metadata:{duration_ms:Date.now()-o,success:!1,error:c instanceof Error?c.message:"Unknown error"}})}catch(l){}throw c}})}static getCallNotes(e){return p(this,null,function*(){try{const t=yield this.getCurrentUserId();if(!t)throw new Error("User not authenticated");if(yield this.checkSupabaseAvailability()){const{data:s,error:i}=yield Di.from("call_notes").select("*").eq("call_id",e).eq("user_id",t).order("updated_at",{ascending:!1});if(i)throw i;const n=s.map(e=>{try{return u(d({},e),{content:uo(e.encrypted_content),metadata:e.metadata||{}})}catch(t){return u(d({},e),{content:"[Decryption Error]",metadata:e.metadata||{}})}});return yield this.logSecurityEvent("CALL_NOTES_ACCESSED","call_notes",!0,{callId:e,noteCount:n.length}),{status:"success",data:n}}{const s=this.getLocalStorageNotes().filter(s=>s.call_id===e&&s.user_id===t);s.sort((e,t)=>new Date(t.updated_at).getTime()-new Date(e.updated_at).getTime());return{status:"success",data:s.map(e=>({id:e.id,call_id:e.call_id,user_id:e.user_id,content:e.content,is_pinned:e.is_pinned,tags:e.tags,metadata:e.metadata,created_at:e.created_at,updated_at:e.updated_at,encrypted_content:""}))}}}catch(t){return this.handleError(t,"getCallNotes")}})}static upsertCallNote(e,t){return p(this,arguments,function*(e,t,s={}){var i,n,r,a,o,l,c,h,f;try{const m=yield this.getCurrentUserId();if(!m)throw new Error("User not authenticated");if(!t.trim())throw new Error("Note content cannot be empty");if(yield this.checkSupabaseAvailability()){const a=co(t.trim()),{data:o}=yield Di.from("call_notes").select("id, encrypted_content").eq("call_id",e).eq("user_id",m).single();let l,c=!1;if(o){c=!0;const{data:t,error:i}=yield this.withAuditLog("UPDATE","call_notes",()=>p(this,null,function*(){var t,i,n;return yield Di.from("call_notes").update({encrypted_content:a,is_pinned:null!=(t=s.isPinned)&&t,tags:null!=(i=s.tags)?i:[],metadata:null!=(n=s.metadata)?n:{},updated_at:(new Date).toISOString()}).eq("call_id",e).eq("user_id",m).select("*").single()}),o.id,{encrypted_content:o.encrypted_content},{encrypted_content:a});if(i)throw i;l=t}else{const{data:t,error:i}=yield this.withAuditLog("INSERT","call_notes",()=>p(this,null,function*(){var t,i,n;return yield Di.from("call_notes").insert({call_id:e,user_id:m,encrypted_content:a,is_pinned:null!=(t=s.isPinned)&&t,tags:null!=(i=s.tags)?i:[],metadata:null!=(n=s.metadata)?n:{}}).select("*").single()}));if(i)throw i;l=t}const h=u(d({},l),{content:uo(l.encrypted_content),metadata:l.metadata||{}});return yield this.logSecurityEvent(c?"CALL_NOTE_UPDATED":"CALL_NOTE_CREATED","call_notes",!0,{callId:e,noteId:l.id,contentLength:t.length,hasTags:(null!=(n=null==(i=s.tags)?void 0:i.length)?n:0)>0,isPinned:null!=(r=s.isPinned)&&r}),{status:"success",data:h}}{const i=this.getLocalStorageNotes(),n=i.findIndex(t=>t.call_id===e&&t.user_id===m),r=(new Date).toISOString();let p;n>=0?(p=u(d({},i[n]),{content:t.trim(),is_pinned:null!=(a=s.isPinned)?a:i[n].is_pinned,tags:null!=(o=s.tags)?o:i[n].tags,metadata:null!=(l=s.metadata)?l:i[n].metadata,updated_at:r}),i[n]=p):(p={id:this.generateId(),call_id:e,user_id:m,content:t.trim(),is_pinned:null!=(c=s.isPinned)&&c,tags:null!=(h=s.tags)?h:[],metadata:null!=(f=s.metadata)?f:{},created_at:r,updated_at:r},i.push(p)),this.saveLocalStorageNotes(i);return{status:"success",data:u(d({},p),{encrypted_content:""})}}}catch(m){return this.handleError(m,"upsertCallNote")}})}static deleteCallNote(e){return p(this,null,function*(){try{const t=yield this.getCurrentUserId();if(!t)throw new Error("User not authenticated");if(yield this.checkSupabaseAvailability()){const{data:s}=yield Di.from("call_notes").select("id").eq("call_id",e).eq("user_id",t).single();if(!s)return{status:"error",error:"Note not found"};const{error:i}=yield this.withAuditLog("DELETE","call_notes",()=>p(this,null,function*(){return yield Di.from("call_notes").delete().eq("call_id",e).eq("user_id",t)}),s.id);if(i)throw i;return yield this.logSecurityEvent("CALL_NOTE_DELETED","call_notes",!0,{callId:e,noteId:s.id}),{status:"success"}}{const s=this.getLocalStorageNotes(),i=s.findIndex(s=>s.call_id===e&&s.user_id===t);return-1===i?{status:"error",error:"Note not found"}:(s.splice(i,1),this.saveLocalStorageNotes(s),{status:"success"})}}catch(t){return this.handleError(t,"deleteCallNote")}})}static togglePinNote(e){return p(this,null,function*(){try{const t=yield this.getCurrentUserId();if(!t)throw new Error("User not authenticated");if(yield this.checkSupabaseAvailability()){const{data:s}=yield Di.from("call_notes").select("*").eq("call_id",e).eq("user_id",t).single();if(!s)return{status:"error",error:"Note not found"};const i=!s.is_pinned,{data:n,error:r}=yield this.withAuditLog("UPDATE","call_notes",()=>p(this,null,function*(){return yield Di.from("call_notes").update({is_pinned:i,updated_at:(new Date).toISOString()}).eq("call_id",e).eq("user_id",t).select("*").single()}),s.id,{is_pinned:s.is_pinned},{is_pinned:i});if(r)throw r;const a=u(d({},n),{content:uo(n.encrypted_content),metadata:n.metadata||{}});return yield this.logSecurityEvent("CALL_NOTE_PIN_TOGGLED","call_notes",!0,{callId:e,noteId:n.id,isPinned:i}),{status:"success",data:a}}{const s=this.getLocalStorageNotes(),i=s.findIndex(s=>s.call_id===e&&s.user_id===t);if(-1===i)return{status:"error",error:"Note not found"};const n=s[i],r=!n.is_pinned,a=(new Date).toISOString(),o=u(d({},n),{is_pinned:r,updated_at:a});s[i]=o,this.saveLocalStorageNotes(s);return{status:"success",data:u(d({},o),{encrypted_content:""})}}}catch(t){return this.handleError(t,"togglePinNote")}})}static subscribeToCallNotes(e,t){return this.checkSupabaseAvailability().then(s=>{if(!s)return;const i=`call-notes-${e}-${this.currentUserId||"unknown"}`,n=Di.channel(i).on("postgres_changes",{event:"*",schema:"public",table:"call_notes",filter:`call_id=eq.${e}`},e=>p(this,null,function*(){try{const i=yield this.getCurrentUserId();if(!i)return;if(e.new&&e.new.user_id!==i)return;if(e.old&&e.old.user_id!==i)return;let n=null;if(e.new&&"DELETE"!==e.eventType){const t=e.new;try{n=u(d({},t),{content:uo(t.encrypted_content),metadata:t.metadata||{}})}catch(s){n=u(d({},t),{content:"[Decryption Error]",metadata:t.metadata||{}})}}t(n,e.eventType)}catch(i){}})).subscribe(e=>{});return()=>{Di.removeChannel(n)}}),()=>{}}static getNotesStats(){return p(this,null,function*(){try{const e=yield this.getCurrentUserId();if(!e)throw new Error("User not authenticated");if(yield this.checkSupabaseAvailability()){const t=new Date;t.setDate(t.getDate()-7);const[s,i,n]=yield Promise.all([Di.from("call_notes").select("id",{count:"exact",head:!0}).eq("user_id",e),Di.from("call_notes").select("id",{count:"exact",head:!0}).eq("user_id",e).eq("is_pinned",!0),Di.from("call_notes").select("id",{count:"exact",head:!0}).eq("user_id",e).gte("created_at",t.toISOString())]);return{status:"success",data:{totalNotes:s.count||0,pinnedNotes:i.count||0,recentNotesCount:n.count||0}}}{const t=this.getLocalStorageNotes().filter(t=>t.user_id===e),s=new Date;s.setDate(s.getDate()-7);return{status:"success",data:{totalNotes:t.length,pinnedNotes:t.filter(e=>e.is_pinned).length,recentNotesCount:t.filter(e=>new Date(e.created_at)>=s).length}}}}catch(e){return this.handleError(e,"getNotesStats")}})}}f(Ml,"STORAGE_KEY","carexps_call_notes"),f(Ml,"isSupabaseAvailable",null),f(Ml,"currentUserId",null);class Ul{static logSecurityEvent(e,t,s){return p(this,arguments,function*(e,t,s,i={},n="low"){try{yield Di.from("security_events").insert({action:e,resource:t,success:s,details:i,severity:n,ip_address:yield this.getClientIP(),user_agent:navigator.userAgent})}catch(r){}})}static getClientIP(){return p(this,null,function*(){try{return null}catch(Tx){return null}})}static getCurrentUserId(){return p(this,null,function*(){try{const{data:{user:e}}=yield Di.auth.getUser();if(!e)return null;const{data:t}=yield Di.from("users").select("id").eq("azure_ad_id",e.id).single();return(null==t?void 0:t.id)||null}catch(Tx){return null}})}static handleError(e,t){return this.logSecurityEvent(t,"database",!1,{error:e.message},"medium"),{status:"error",error:e.message||"An unexpected error occurred"}}static withAuditLog(e,t,s,i,n,r){return p(this,null,function*(){const a=yield this.getCurrentUserId(),o=Date.now();try{const c=yield s();if(a)try{yield Di.from("audit_logs").insert({user_id:a,action:e,table_name:t,record_id:i,old_values:n,new_values:r,ip_address:yield this.getClientIP(),user_agent:navigator.userAgent,metadata:{duration_ms:Date.now()-o,success:!0}})}catch(l){}return c}catch(c){if(a)try{yield Di.from("audit_logs").insert({user_id:a,action:e,table_name:t,record_id:i,metadata:{duration_ms:Date.now()-o,success:!1,error:c instanceof Error?c.message:"Unknown error"}})}catch(l){}throw c}})}}let Fl=class extends Ul{static getUserSettings(e){return p(this,null,function*(){try{const{data:t,error:s}=yield Di.from("user_settings").select("*").eq("user_id",e).single();if(s&&"PGRST116"!==s.code)throw s;return{status:"success",data:t||null}}catch(t){return this.handleError(t,"getUserSettings")}})}static updateUserSettings(e,t){return p(this,null,function*(){try{const{data:s}=yield this.getUserSettings(e),{data:i,error:n}=yield this.withAuditLog("UPDATE","user_settings",()=>p(this,null,function*(){return yield Di.from("user_settings").update(u(d({},t),{updated_at:(new Date).toISOString(),last_synced:(new Date).toISOString()})).eq("user_id",e).select().single()}),e,s,t);if(n)throw n;return yield this.logSecurityEvent("SETTINGS_UPDATED","user_settings",!0,{userId:e}),{status:"success",data:i}}catch(s){return this.handleError(s,"updateUserSettings")}})}static createDefaultSettings(e){return p(this,null,function*(){try{const{data:t,error:s}=yield Di.from("user_settings").insert({user_id:e,theme:"light",notifications:{email:!0,sms:!1,push:!0,in_app:!0,call_alerts:!0,sms_alerts:!0,security_alerts:!0},security_preferences:{session_timeout:Mi.sessionTimeoutMinutes,require_mfa:Mi.requireMFA,password_expiry_reminder:!0,login_notifications:!0},communication_preferences:{default_method:"phone",auto_reply_enabled:!1,business_hours:{enabled:!0,start:"09:00",end:"17:00",timezone:"UTC"}},accessibility_settings:{high_contrast:!1,large_text:!1,screen_reader:!1,keyboard_navigation:!1}}).select().single();if(s)throw s;return{status:"success",data:t}}catch(t){return this.handleError(t,"createDefaultSettings")}})}};const Bl=class e extends Fl{static initializeSync(){this.realtimeSubscription||(this.realtimeSubscription=Di.channel("user_settings_sync").on("postgres_changes",{event:"*",schema:"public",table:"user_settings"},e=>{this.handleRealtimeUpdate(e)}).subscribe())}static cleanupSync(){this.realtimeSubscription&&(Di.removeChannel(this.realtimeSubscription),this.realtimeSubscription=null),this.syncListeners.clear()}static encryptRetellConfig(e){return p(this,null,function*(){try{const t={call_agent_id:e.call_agent_id,sms_agent_id:e.sms_agent_id};if(e.api_key){const s=co(e.api_key);t.api_key=s}return t}catch(t){throw new Error("Failed to encrypt API configuration")}})}static decryptRetellConfig(e){return p(this,null,function*(){try{if(!e)return null;const s={call_agent_id:e.call_agent_id,sms_agent_id:e.sms_agent_id};if(e.api_key)try{s.api_key=uo(e.api_key)}catch(t){s.api_key=e.api_key}return s}catch(s){return null}})}static subscribeToUserSettings(e,t){return this.syncListeners.has(e)||this.syncListeners.set(e,[]),this.syncListeners.get(e).push(t),()=>{const s=this.syncListeners.get(e);if(s){const i=s.indexOf(t);i>-1&&s.splice(i,1),0===s.length&&this.syncListeners.delete(e)}}}static handleRealtimeUpdate(e){const{eventType:t,new:s,old:i}=e;let n,r=null;switch(t){case"INSERT":case"UPDATE":s&&(n=s.user_id,r=s);break;case"DELETE":i&&(n=i.user_id)}if(n&&r){const e=this.syncListeners.get(n);e&&e.forEach(e=>e(r))}}static getUserSettings(t){return p(this,null,function*(){try{const s=yield m(e,this,"getUserSettings").call(this,t);if("error"===s.status||!s.data)return s;const i=s.data;if(i.retell_config){const e=yield this.decryptRetellConfig(i.retell_config);i.retell_config=e}return{status:"success",data:i}}catch(s){return this.handleError(s,"getUserSettings")}})}static getUserSettingsWithCache(e){return p(this,null,function*(){try{const t=`user_settings_${e}`,s=localStorage.getItem(t);if(s){const{data:e,timestamp:t}=JSON.parse(s);if(Date.now()-t<3e5)return{status:"success",data:e}}const i=yield this.getUserSettings(e);return"success"===i.status&&i.data&&localStorage.setItem(t,JSON.stringify({data:i.data,timestamp:Date.now()})),i}catch(t){return this.handleError(t,"getUserSettingsWithCache")}})}static updateUserSettings(t,s){return p(this,null,function*(){try{const i=d({},s);if(i.retell_config){const e=yield this.encryptRetellConfig(i.retell_config);i.retell_config=e}const n=yield m(e,this,"updateUserSettings").call(this,t,i);if("error"===n.status)return n;const r=n.data;if(r.retell_config){const e=yield this.decryptRetellConfig(r.retell_config);r.retell_config=e}return{status:"success",data:r}}catch(i){return this.handleError(i,"updateUserSettings")}})}static updateUserSettingsSync(e,t,s=!0){return p(this,null,function*(){try{const i=yield this.getUserSettings(e);if("error"===i.status)return i;const n=i.data;if(s&&n){const s=d(d({},n),t),i=this.syncListeners.get(e);i&&i.forEach(e=>e(s));const r=`user_settings_${e}`;localStorage.setItem(r,JSON.stringify({data:s,timestamp:Date.now()}))}const r=this.mergeSettings(n||{},t),a=yield this.updateUserSettings(e,r);if("success"===a.status){const t=`user_settings_${e}`;localStorage.setItem(t,JSON.stringify({data:a.data,timestamp:Date.now()}))}return a}catch(i){return this.handleError(i,"updateUserSettingsSync")}})}static mergeSettings(e,t){const s=d(d({},e),t);return e.notifications&&t.notifications&&(s.notifications=d(d({},e.notifications),t.notifications)),e.security_preferences&&t.security_preferences&&(s.security_preferences=d(d({},e.security_preferences),t.security_preferences)),e.dashboard_layout&&t.dashboard_layout&&(s.dashboard_layout=d(d({},e.dashboard_layout),t.dashboard_layout)),e.communication_preferences&&t.communication_preferences&&(s.communication_preferences=d(d({},e.communication_preferences),t.communication_preferences)),e.accessibility_settings&&t.accessibility_settings&&(s.accessibility_settings=d(d({},e.accessibility_settings),t.accessibility_settings)),e.retell_config&&t.retell_config&&(s.retell_config=d(d({},e.retell_config),t.retell_config)),s}static syncAcrossDevices(e){return p(this,null,function*(){try{const t=yield this.getUserSettings(e);if("error"===t.status||!t.data)return t;const s=t.data,i=`user_settings_${e}`;localStorage.setItem(i,JSON.stringify({data:s,timestamp:Date.now()})),yield this.updateUserSettings(e,{last_synced:(new Date).toISOString()});const n=this.syncListeners.get(e);return n&&n.forEach(e=>e(s)),yield this.logSecurityEvent("SETTINGS_SYNCED","user_settings",!0,{userId:e}),{status:"success",data:s}}catch(t){return this.handleError(t,"syncAcrossDevices")}})}static getSyncStatus(e){return p(this,null,function*(){try{const t=yield this.getUserSettings(e);if("error"===t.status||!t.data)return{status:"error",error:"Could not retrieve settings"};const s=t.data,{data:i}=yield Di.from("user_sessions").select("device_info").eq("user_id",e).eq("is_active",!0),n=(null==i?void 0:i.length)||0,r=`user_settings_${e}`,a=localStorage.getItem(r);let o=!0;if(a){const{timestamp:e}=JSON.parse(a);o=e<(s.last_synced?new Date(s.last_synced).getTime():0)}return{status:"success",data:{lastSynced:s.last_synced,needsSync:o,deviceCount:n}}}catch(t){return this.handleError(t,"getSyncStatus")}})}static importSettings(e,t,s=!1){return p(this,null,function*(){try{let i=t;if(!s){const s=yield this.getUserSettings(e);"success"===s.status&&s.data&&(i=this.mergeSettings(s.data,t))}const n=yield this.updateUserSettings(e,i);return"success"===n.status&&(yield this.logSecurityEvent("SETTINGS_IMPORTED","user_settings",!0,{userId:e,overwrite:s,importedFields:Object.keys(t)})),n}catch(i){return this.handleError(i,"importSettings")}})}static exportSettings(e){return p(this,null,function*(){try{const t=yield this.getUserSettings(e);if("error"===t.status||!t.data)return{status:"error",error:"Could not retrieve settings for export"};const s={settings:t.data,exportDate:(new Date).toISOString(),version:"1.0.0"};return yield this.logSecurityEvent("SETTINGS_EXPORTED","user_settings",!0,{userId:e}),{status:"success",data:s}}catch(t){return this.handleError(t,"exportSettings")}})}static resetToDefaults(e){return p(this,null,function*(){try{const t=(yield this.getUserSettings(e)).data;yield Di.from("user_settings").delete().eq("user_id",e);const s=yield this.createDefaultSettings(e);if("success"===s.status){const s=`user_settings_${e}`;localStorage.removeItem(s),yield this.logSecurityEvent("SETTINGS_RESET","user_settings",!0,{userId:e,previousSettings:t?"[REDACTED]":null})}return s}catch(t){return this.handleError(t,"resetToDefaults")}})}static validateSettings(e){var t,s;const i=[];if(e.theme&&!["light","dark","auto"].includes(e.theme)&&i.push("Invalid theme value"),null==(t=e.security_preferences)?void 0:t.session_timeout){const t=e.security_preferences.session_timeout;(t<1||t>480)&&i.push("Session timeout must be between 1 and 480 minutes")}if(null==(s=e.communication_preferences)?void 0:s.business_hours){const{start:t,end:s}=e.communication_preferences.business_hours,n=/^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;t&&!n.test(t)&&i.push("Invalid business hours start time format"),s&&!n.test(s)&&i.push("Invalid business hours end time format")}return{isValid:0===i.length,errors:i}}};f(Bl,"syncListeners",new Map),f(Bl,"realtimeSubscription",null);let ql=Bl;const $l=new class{constructor(){f(this,"baseUrl","https://api.retellai.com"),f(this,"apiKey",""),f(this,"callAgentId",""),f(this,"smsAgentId",""),this.loadCredentials()}loadCredentials(){const e=JSON.parse(localStorage.getItem("currentUser")||"{}");if(e.id){const t=JSON.parse(localStorage.getItem(`settings_${e.id}`)||"{}");this.apiKey=t.retellApiKey||"",this.callAgentId=t.callAgentId||"",this.smsAgentId=t.smsAgentId||""}}getHeaders(){return this.apiKey||this.loadCredentials(),{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"}}isConfigured(){return!(!this.apiKey||!this.callAgentId&&!this.smsAgentId)}testConnection(){return p(this,null,function*(){try{if(!this.apiKey)return{success:!1,message:"API key not configured"};const e=yield fetch(`${this.baseUrl}/v2/list-calls`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({limit:1})});return e.ok?{success:!0,message:"Connection successful"}:401===e.status?{success:!1,message:"Invalid API key"}:{success:!1,message:`API error: ${e.status}`}}catch(e){return{success:!1,message:`Connection failed: ${e instanceof Error?e.message:"Unknown error"}`}}})}getAllCalls(){return p(this,null,function*(){const e=[];let t,s=!0,i=0;for(;s&&i<10;){i++;const n=yield this.getCallHistory({limit:1e3,pagination_key:t,filter_criteria:this.callAgentId?{agent_id:this.callAgentId}:void 0});e.push(...n.calls),t=n.pagination_key,s=n.has_more&&!!t,n.has_more&&t||(s=!1)}return e})}getCallHistory(){return p(this,arguments,function*(e={}){try{if(!this.apiKey)throw new Error("Retell API key not configured");const t={};if(e.filter_criteria){const{filter_criteria:s}=e;if(s.agent_id&&(t.agent_id=Array.isArray(s.agent_id)?s.agent_id:[s.agent_id]),s.call_status&&(t.call_status=Array.isArray(s.call_status)?s.call_status:[s.call_status]),s.call_type&&(t.call_type=Array.isArray(s.call_type)?s.call_type:[s.call_type]),s.direction&&(t.direction=Array.isArray(s.direction)?s.direction:[s.direction]),s.user_sentiment&&(t.user_sentiment=Array.isArray(s.user_sentiment)?s.user_sentiment:[s.user_sentiment]),void 0!==s.call_successful&&(t.call_successful=s.call_successful),s.start_timestamp){const e={};s.start_timestamp.gte&&(e.lower_threshold=1e3*s.start_timestamp.gte),s.start_timestamp.lte&&(e.upper_threshold=1e3*s.start_timestamp.lte),t.start_timestamp=e}}!this.callAgentId||t.agent_id||e.skipFilters||(t.agent_id=[this.callAgentId]);const s={sort_order:e.sort_order||"descending",limit:Math.min(e.limit||1e3,1e3)};Object.keys(t).length>0&&!e.skipFilters&&(s.filter_criteria=t),e.pagination_key&&(s.pagination_key=e.pagination_key);const i=yield fetch(`${this.baseUrl}/v2/list-calls`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(s)});if(!i.ok){yield i.text();throw new Error(`Failed to fetch calls: ${i.status} ${i.statusText}`)}const n=yield i.json();let r,a=[],o=!1;return Array.isArray(n)?(a=n,o=n.length>=(e.limit||200)):n&&"object"==typeof n&&(a=n.calls||n.data||[],r=n.pagination_key||n.next_page_token,o=n.has_more||!!r),a.length,{calls:a,pagination_key:r,has_more:o}}catch(t){throw t}})}getCall(e){return p(this,null,function*(){try{if(!this.apiKey)throw new Error("Retell API key not configured");const t=yield fetch(`${this.baseUrl}/v2/get-call/${e}`,{method:"GET",headers:this.getHeaders()});if(!t.ok)throw new Error(`Failed to fetch call: ${t.status} ${t.statusText}`);return yield t.json()}catch(t){throw t}})}getChatHistory(){return p(this,null,function*(){try{if(!this.apiKey)throw new Error("Retell API key not configured");const e=yield fetch(`${this.baseUrl}/list-chat`,{method:"GET",headers:this.getHeaders()});if(!e.ok){yield e.text();throw new Error(`Failed to fetch chats: ${e.status} ${e.statusText}`)}const t=yield e.json();let s=[];Array.isArray(t)?s=t:t&&t.chats&&Array.isArray(t.chats)?s=t.chats:t&&t.data&&Array.isArray(t.data)&&(s=t.data),s.length;let i=s;if(this.smsAgentId&&this.smsAgentId.trim()){s.length;i=s.filter(e=>e.agent_id===this.smsAgentId)}const n=new Date,r=new Date(n.getFullYear(),n.getMonth(),n.getDate()).getTime()/1e3,a=r+86400;i.filter(e=>e.start_timestamp>=r&&e.start_timestamp<a);return{chats:i,pagination_key:void 0,has_more:!1}}catch(e){throw e}})}getChat(e){return p(this,null,function*(){try{if(!this.apiKey)throw new Error("Retell API key not configured");const t=yield fetch(`${this.baseUrl}/get-chat/${e}`,{method:"GET",headers:this.getHeaders()});if(!t.ok)throw new Error(`Failed to fetch chat: ${t.status} ${t.statusText}`);return yield t.json()}catch(t){throw t}})}getCallHistoryByDateRange(e,t){return p(this,arguments,function*(e,t,s={}){const i={start_timestamp:{gte:Math.floor(e.getTime()/1e3),lte:Math.floor(t.getTime()/1e3)}};return this.getCallHistory(u(d({},s),{filter_criteria:i}))})}calculateCallMetrics(e){const t=e.length,s=e.filter(e=>"ended"===e.call_status),i=e.filter(e=>"error"===e.call_status),n=s.reduce((e,t)=>{if(void 0!==t.duration_ms&&null!==t.duration_ms){return e+t.duration_ms/1e3}if(t.start_timestamp&&t.end_timestamp){let s=t.start_timestamp,i=t.end_timestamp;t.start_timestamp.toString().length<=10&&(s=1e3*t.start_timestamp),t.end_timestamp.toString().length<=10&&(i=1e3*t.end_timestamp);return e+(i-s)/1e3}return e},0),r=s.length>0?n/s.length:0,a=e.reduce((e,t)=>{var s;return e+((null==(s=t.call_cost)?void 0:s.combined_cost)||0)/100},0),o=e.filter(e=>{var t;return null==(t=e.call_cost)?void 0:t.combined_cost}).map(e=>{var t;return null==(t=e.call_cost)?void 0:t.combined_cost});if(o.length>0){Math.min(...o),Math.max(...o)}const l=t>0?a/t:0,c=e.filter(e=>{var t;return!0===(null==(t=e.call_analysis)?void 0:t.call_successful)}),d=t>0?c.length/t*100:0,u=e.filter(e=>{var t;return"positive"===(null==(t=e.call_analysis)?void 0:t.user_sentiment)}).length,h=e.map(e=>{var t;return((null==(t=e.call_cost)?void 0:t.combined_cost)||0)/100}).filter(e=>e>0),f=h.length>0?Math.max(...h):0,m=h.length>0?Math.min(...h):0;h.length;const p=Math.round(n/60);return{totalCalls:t,avgDuration:this.formatDuration(r),avgCostPerCall:l,successRate:d,totalDuration:this.formatDuration(n),positiveSentiment:u,highestCostCall:f,lowestCostCall:m,failedCalls:i.length,totalCost:a,totalMinutes:p}}calculateChatMetrics(e){const t=e.length;e.filter(e=>"ended"===e.chat_status);const s=e.filter(e=>"error"===e.chat_status),i=e.reduce((e,t)=>{var s;return e+((null==(s=t.chat_cost)?void 0:s.combined_cost)||0)},0),n=t>0?i/t:0,r=e.filter(e=>"ended"===e.chat_status),a=t>0?r.length/t*100:0,o=e.filter(e=>{var t;return!0===(null==(t=e.chat_analysis)?void 0:t.chat_successful)}),l=t>0?o.length/t*100:0;return{totalMessages:t,avgResponseTime:"0m",avgCostPerMessage:n,deliveryRate:a,responseRate:l,totalCost:i,positiveSentiment:e.filter(e=>{var t;return"positive"===(null==(t=e.chat_analysis)?void 0:t.user_sentiment)}).length,highestEngagement:l,failedMessages:s.length}}formatDuration(e){if(!e||e<=0)return"0:00";const t=Math.floor(e/3600),s=Math.floor(e%3600/60),i=Math.floor(e%60);return t>0?`${t}:${s.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`:`${s}:${i.toString().padStart(2,"0")}`}calculateCostFromDuration(e){if(!e.start_timestamp||!e.end_timestamp)return 0;let t=e.start_timestamp,s=e.end_timestamp;e.start_timestamp.toString().length<=10&&(t=1e3*e.start_timestamp),e.end_timestamp.toString().length<=10&&(s=1e3*e.end_timestamp);const i=(s-t)/1e3/60,n=.1*Math.min(i,10),r=Math.min(n,.5);return Math.max(0,r)}updateCredentials(e,t,s){void 0!==e&&(this.apiKey=e),void 0!==t&&(this.callAgentId=t),void 0!==s&&(this.smsAgentId=s)}};const zl=new class{constructor(){f(this,"baseUrl","https://api.retellai.com"),f(this,"apiKey",""),f(this,"smsAgentId",""),f(this,"isDemoMode",!1),f(this,"lastRequestTime",0),f(this,"minRequestInterval",2e3),f(this,"chatCache",new Map),f(this,"cacheExpiry",3e4),this.loadCredentials()}loadCredentials(){if("undefined"!=typeof window&&"undefined"!=typeof localStorage)try{const e=JSON.parse(localStorage.getItem("currentUser")||"{}");if(e.id){const t=JSON.parse(localStorage.getItem(`settings_${e.id}`)||"{}");this.apiKey=t.retellApiKey||"",this.smsAgentId=t.smsAgentId||"",this.isDemoMode=!1}else this.isDemoMode=!1}catch(e){this.isDemoMode=!1}else this.isDemoMode=!0}getHeaders(){return this.apiKey||this.loadCredentials(),{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"}}respectRateLimit(){return p(this,null,function*(){const e=Date.now()-this.lastRequestTime;if(e<this.minRequestInterval){const t=this.minRequestInterval-e;yield new Promise(e=>setTimeout(e,t))}this.lastRequestTime=Date.now()})}getCachedData(e){const t=this.chatCache.get(e);return t&&Date.now()-t.timestamp<this.cacheExpiry?t.data:null}setCachedData(e,t){this.chatCache.set(e,{data:t,timestamp:Date.now()})}makeApiRequest(e){return p(this,arguments,function*(e,t={},s=3){yield this.respectRateLimit();for(let n=1;n<=s;n++)try{const i=yield fetch(e,t);if(429===i.status){const e=i.headers.get("Retry-After"),t=e?1e3*parseInt(e):1e3*Math.pow(2,n);if(n<s){yield new Promise(e=>setTimeout(e,t));continue}}return i}catch(i){if(n===s)throw i;const e=1e3*Math.pow(2,n);yield new Promise(t=>setTimeout(t,e))}throw new Error("Max retries exceeded")})}isConfigured(){return!!this.apiKey}testConnection(){return p(this,null,function*(){if(this.isDemoMode)return{success:!0,message:"Demo mode - using mock data"};try{if(!this.apiKey)return{success:!1,message:"API key not configured"};const e=yield this.makeApiRequest(`${this.baseUrl}/list-chat`,{method:"GET",headers:this.getHeaders()});return e.ok?{success:!0,message:"Connection successful"}:401===e.status?{success:!1,message:"Invalid API key"}:{success:!1,message:`API error: ${e.status}`}}catch(e){return{success:!1,message:`Connection failed: ${e instanceof Error?e.message:"Unknown error"}`}}})}getAllChats(e){return p(this,null,function*(){const t=[];let s,i=!0,n=0;for(;i&&n<10;){n++;const r=yield this.getChatHistory({limit:1e3,pagination_key:s,filter_criteria:e||(this.smsAgentId?{agent_id:this.smsAgentId}:void 0)});t.push(...r.chats),s=r.pagination_key,i=r.has_more&&!!s,r.has_more&&s||(i=!1)}return t})}getChatHistory(){return p(this,arguments,function*(e={}){const t=`chat_history_${JSON.stringify(e)}`,s=this.getCachedData(t);if(s)return s;try{if(!this.apiKey)throw new Error("Retell API key not configured - check Settings → API Configuration");const s=new URLSearchParams;if(e.limit&&s.append("limit",e.limit.toString()),e.pagination_key&&s.append("pagination_key",e.pagination_key),e.sort_order&&s.append("sort_order",e.sort_order),e.filter_criteria&&!e.skipFilters){const{filter_criteria:t}=e}const i=`${this.baseUrl}/list-chat${s.toString()?"?"+s.toString():""}`,n=yield this.makeApiRequest(i,{method:"GET",headers:this.getHeaders()});if(!n.ok){const e=yield n.text();throw 401===n.status?new Error("Invalid API key - check Settings → API Configuration"):403===n.status?new Error("API access forbidden - check your API key permissions"):404===n.status?new Error("API endpoint not found - check your Retell AI configuration"):new Error(`API error: ${n.status} ${n.statusText} - ${e}`)}const r=yield n.json();let a,o=[],l=!1;Array.isArray(r)?(o=r,l=r.length>=(e.limit||100)):r&&"object"==typeof r&&(o=r.chats||r.data||[],a=r.pagination_key||r.next_page_token,l=r.has_more||!!a);const c={chats:o,pagination_key:a,has_more:l};return this.setCachedData(t,c),c}catch(i){throw i}})}getChatById(e){return p(this,null,function*(){try{if(!this.apiKey)throw new Error("Retell API key not configured");const t=yield this.makeApiRequest(`${this.baseUrl}/get-chat/${e}`,{method:"GET",headers:this.getHeaders()});if(!t.ok)throw new Error(`Failed to fetch chat: ${t.status} ${t.statusText}`);return yield t.json()}catch(t){throw t}})}getChatsByDateRange(e,t){return p(this,arguments,function*(e,t,s={}){const i={start_timestamp:{gte:Math.floor(e.getTime()/1e3),lte:Math.floor(t.getTime()/1e3)}},n=d(d({},s.filter_criteria),i);return this.getChatHistory(u(d({},s),{filter_criteria:n}))})}createSMSChat(e){return p(this,null,function*(){if(this.isDemoMode)return{success:!0,chat_id:`chat_demo_${Date.now()}`,access_token:"demo_token_123"};try{if(!this.apiKey)throw new Error("Retell API key not configured");const t=yield fetch(`${this.baseUrl}/create-sms-chat`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(e)});if(!t.ok){const e=yield t.text();return{success:!1,error:`API error: ${t.status} ${t.statusText} - ${e}`}}const s=yield t.json();return{success:!0,chat_id:s.chat_id,access_token:s.access_token}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error"}}})}endChat(e){return p(this,null,function*(){if(this.isDemoMode)return{success:!0};try{if(!this.apiKey)throw new Error("Retell API key not configured");const t=yield fetch(`${this.baseUrl}/end-chat/${e}`,{method:"PUT",headers:this.getHeaders()});if(!t.ok){const e=yield t.text();return{success:!1,error:`API error: ${t.status} ${t.statusText} - ${e}`}}return{success:!0}}catch(t){return{success:!1,error:t instanceof Error?t.message:"Unknown error"}}})}getChatStats(e){const t=e.length,s=e.filter(e=>"ongoing"===e.chat_status),i=e.filter(e=>"ended"===e.chat_status),n=e.filter(e=>"error"===e.chat_status),r=i.reduce((e,t)=>t.start_timestamp&&t.end_timestamp?e+(t.end_timestamp-t.start_timestamp):e,0),a=i.length>0?r/i.length:0,o=e.reduce((e,t)=>{var s;return e+((null==(s=t.chat_cost)?void 0:s.total_cost)||0)},0),l=t>0?o:0,c=e.filter(e=>{var t;return!0===(null==(t=e.chat_analysis)?void 0:t.chat_successful)}),d=t>0?c.length/t*100:0,u=e.filter(e=>{var t;return"positive"===(null==(t=e.chat_analysis)?void 0:t.user_sentiment)}).length,h=e.reduce((e,t)=>{var s;return e+((null==(s=t.message_with_tool_calls)?void 0:s.length)||0)},0),f=t>0?h/t:0;return{totalChats:t,activeChats:s.length,completedChats:i.length,errorChats:n.length,avgDuration:this.formatDuration(a),totalCost:o,avgCostPerChat:l,successRate:d,positiveSentimentCount:u,totalMessages:h,avgMessagesPerChat:f}}getChatAnalytics(e){return p(this,null,function*(){const t=yield this.getAllChats(e),s=new Date,i=new Date(s.getFullYear(),s.getMonth(),s.getDate()),n=new Date(i.getTime()-6048e5),r=new Date(s.getFullYear(),s.getMonth(),1),a=t.filter(e=>new Date(1e3*e.start_timestamp)>=i),o=t.filter(e=>new Date(1e3*e.start_timestamp)>=n),l=t.filter(e=>new Date(1e3*e.start_timestamp)>=r),c={positive:0,negative:0,neutral:0};t.forEach(e=>{var t;const s=(null==(t=e.chat_analysis)?void 0:t.user_sentiment)||"neutral";s in c&&c[s]++});const d={};t.forEach(e=>{const t=new Date(1e3*e.start_timestamp).getHours();d[t]=(d[t]||0)+1});const u=Object.entries(d).map(([e,t])=>({hour:parseInt(e),chatCount:t})).sort((e,t)=>t.chatCount-e.chatCount).slice(0,5);return{today:this.getChatStats(a),thisWeek:this.getChatStats(o),thisMonth:this.getChatStats(l),trends:this.calculateTrends(t),sentimentDistribution:c,peakHours:u}})}updateCredentials(e,t){void 0!==e&&(this.apiKey=e,this.isDemoMode=!e),void 0!==t&&(this.smsAgentId=t)}getMockChats(e){return[]}formatDuration(e){if(!e||e<=0)return"0s";const t=Math.floor(e/3600),s=Math.floor(e%3600/60),i=Math.floor(e%60);return t>0?`${t}h ${s}m ${i}s`:s>0?`${s}m ${i}s`:`${i}s`}calculateTrends(e){const t={};return e.forEach(e=>{const s=new Date(1e3*e.start_timestamp).toISOString().split("T")[0];t[s]||(t[s]={chats:[],date:s}),t[s].chats.push(e)}),Object.values(t).map(({chats:e,date:t})=>{const s=this.getChatStats(e);return{date:t,chatCount:s.totalChats,avgDuration:parseFloat(s.avgDuration.replace(/[^\d.]/g,""))||0,totalCost:s.totalCost,successRate:s.successRate}}).sort((e,t)=>e.date.localeCompare(t.date))}},Hl=({user:e})=>{const[t,s]=v.useState(!1),[i,n]=v.useState("today"),[r,a]=v.useState(""),[o,l]=v.useState({totalCalls:0,avgCallDuration:"0:00",avgCostPerCall:0,callSuccessRate:0,totalCost:0,highestCostCall:0,lowestCostCall:0,totalCallDuration:"0:00",totalMessages:0,avgResponseTime:"0m",avgCostPerMessage:0,messageDeliveryRate:0}),[c,d]=v.useState("checking"),{formatLastRefreshTime:u}=Rl({enabled:!0,interval:6e4,onRefresh:()=>{h()}});v.useEffect(()=>{h()},[i]);const h=()=>p(void 0,null,function*(){s(!0),a("");try{const t=JSON.parse(localStorage.getItem("currentUser")||"{}");if(t.id){const e=JSON.parse(localStorage.getItem(`settings_${t.id}`)||"{}");$l.updateCredentials(e.retellApiKey,e.callAgentId,e.smsAgentId),e.smsAgentId||$l.updateCredentials(e.retellApiKey,e.callAgentId,"agent_643486efd4b5a0e9d7e094ab99")}if(!$l.isConfigured())return d("not-configured"),void s(!1);const n=yield $l.testConnection();if(!n.success)return d("error"),a(`API Connection Error: ${n.message}`),void s(!1);d("connected");const{start:r,end:o}=Dl(i);let c,u;try{const e=yield $l.getAllCalls();e.length;const t=r.getTime(),s=o.getTime();c={calls:e.filter(e=>{var i;let n;n=e.start_timestamp.toString().length<=10?1e3*e.start_timestamp:e.start_timestamp;const r=n>=t&&n<=s;null==(i=e.call_cost)||i.combined_cost;return r}),pagination_key:void 0,has_more:!1}}catch(e){c={calls:[],pagination_key:void 0,has_more:!1}}try{const e=yield $l.getChatHistory(),t=r.getTime(),s=o.getTime();u={chats:e.chats.filter(e=>{let i;i=e.start_timestamp.toString().length<=10?1e3*e.start_timestamp:e.start_timestamp;return i>=t&&i<=s}),pagination_key:void 0,has_more:!1}}catch(e){u={chats:[],pagination_key:void 0,has_more:!1}}const h=$l.calculateCallMetrics(c.calls),f=$l.calculateChatMetrics(u.chats);l({totalCalls:h.totalCalls,avgCallDuration:h.avgDuration,avgCostPerCall:h.avgCostPerCall,callSuccessRate:h.successRate,totalCost:h.totalCost,highestCostCall:h.highestCostCall,lowestCostCall:h.lowestCostCall,totalCallDuration:h.totalDuration,totalMessages:f.totalMessages,avgResponseTime:f.avgResponseTime,avgCostPerMessage:f.avgCostPerMessage,messageDeliveryRate:f.deliveryRate})}catch(e){a(e instanceof Error?e.message:"Failed to load dashboard data"),d("error")}finally{s(!1)}});return F.jsxs("div",{className:"p-6 space-y-6",children:[F.jsxs("div",{className:"flex items-center justify-between mb-4",children:[F.jsx(Ol,{selectedRange:i,onRangeChange:(e,t,s)=>{n(e);const{start:i,end:r}=Dl(e,t,s)}}),F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsxs("button",{onClick:h,disabled:t,className:"flex items-center gap-2 px-3 py-2 text-gray-600 hover:text-gray-900 transition-colors disabled:opacity-50",children:[F.jsx(nl,{className:"w-4 h-4 "+(t?"animate-spin":"")}),"Refresh"]}),F.jsxs("button",{className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[F.jsx(Io,{className:"w-4 h-4"}),"Export Dashboard Report"]})]})]}),F.jsxs("div",{className:"text-xs text-gray-500 mb-6",children:["Last refreshed: ",u()," (Auto-refresh every minute)"]}),r&&F.jsxs("div",{className:"mb-6 bg-red-50 border border-red-200 rounded-lg p-4 flex items-center gap-3",children:[F.jsx(Co,{className:"w-5 h-5 text-red-600 flex-shrink-0"}),F.jsx("span",{className:"text-red-700",children:r}),F.jsx("button",{onClick:()=>a(""),className:"ml-auto text-red-600 hover:text-red-800 text-xl",children:"×"})]}),"not-configured"===c&&F.jsxs("div",{className:"mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4 flex items-center gap-3",children:[F.jsx(Co,{className:"w-5 h-5 text-yellow-600 flex-shrink-0"}),F.jsxs("div",{children:[F.jsx("span",{className:"text-yellow-700 font-medium",children:"API not configured"}),F.jsx("p",{className:"text-yellow-600 text-sm mt-1",children:"Go to Settings → API Configuration to set up your API credentials."})]})]}),F.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Total Calls"}),F.jsx(el,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:t?"...":o.totalCalls}),F.jsx("div",{className:"text-xs text-gray-500",children:0===o.totalCalls?"No calls made":`${o.totalCalls} calls completed`})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Total Talk Time"}),F.jsx(Eo,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:t?"...":o.totalCallDuration}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Avg: ",o.avgCallDuration]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Avg Cost Per Call"}),F.jsx(Po,{className:"w-4 h-4 text-gray-400"})]}),F.jsxs("div",{className:"text-3xl font-black text-blue-600 mb-1",children:["$",t?"...":o.avgCostPerCall.toFixed(2)]}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Total: $",o.totalCost.toFixed(2)]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Highest Cost"}),F.jsx(yl,{className:"w-4 h-4 text-gray-400"})]}),F.jsxs("div",{className:"text-3xl font-black text-blue-600 mb-1",children:["$",t?"...":o.highestCostCall.toFixed(2)]}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Lowest: $",o.lowestCostCall.toFixed(2)]})]})]}),F.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Total Messages"}),F.jsx(Go,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:t?"...":o.totalMessages}),F.jsx("div",{className:"text-xs text-gray-500",children:"No messages sent"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Avg Response Time"}),F.jsx(Eo,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:t?"...":o.avgResponseTime}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Fastest: ",o.avgResponseTime]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Avg Cost Per Message"}),F.jsx(Po,{className:"w-4 h-4 text-gray-400"})]}),F.jsxs("div",{className:"text-3xl font-black text-blue-600 mb-1",children:["$",t?"...":o.avgCostPerMessage.toFixed(3)]}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Total cost: $",o.avgCostPerMessage.toFixed(2)]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Message Delivery Rate"}),F.jsx(yl,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:t?"...":`${o.messageDeliveryRate.toFixed(1)}%`}),F.jsx("div",{className:"text-xs text-gray-500",children:"0 delivered"})]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[F.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[F.jsx(ll,{className:"w-5 h-5 text-green-600"}),F.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"System Status"})]}),F.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[F.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsx(vo,{className:"w-4 h-4 "+("connected"===c?"text-green-500":"error"===c?"text-red-500":"not-configured"===c?"text-yellow-500":"text-gray-500")}),F.jsx("span",{className:"text-sm text-gray-900",children:"API Service"})]}),F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx("div",{className:"w-2 h-2 rounded-full "+("connected"===c?"bg-green-500":"error"===c?"bg-red-500":"not-configured"===c?"bg-yellow-500":"bg-gray-500")}),F.jsx("span",{className:"text-xs text-gray-600",children:"connected"===c?"Connected":"error"===c?"Error":"not-configured"===c?"Not Configured":"Checking..."})]})]}),F.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsx(vo,{className:"w-4 h-4 text-green-500"}),F.jsx("span",{className:"text-sm text-gray-900",children:"Database"})]}),F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),F.jsx("span",{className:"text-xs text-gray-600",children:"Connected"})]})]}),F.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsx(ll,{className:"w-4 h-4 text-green-500"}),F.jsx("span",{className:"text-sm text-gray-900",children:"Security"})]}),F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),F.jsx("span",{className:"text-xs text-gray-600",children:"Active"})]})]}),F.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsx(ll,{className:"w-4 h-4 text-green-500"}),F.jsx("span",{className:"text-sm text-gray-900",children:"HIPAA"})]}),F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),F.jsx("span",{className:"text-xs text-gray-600",children:"Compliant"})]})]})]})]})]})},Vl=({callId:e,isReadonly:t=!1})=>{const s=(()=>{try{const e=localStorage.getItem("currentUser");if(e){return JSON.parse(e)}return null}catch(e){return null}})(),i=(null==s?void 0:s.id)||(null==s?void 0:s.user_id)||(null==s?void 0:s.email)||"anonymous_user",n=!(!s||!s.id&&!s.user_id&&!s.email),[r,a]=v.useState(!0),[o,l]=v.useState(!1);v.useEffect(()=>{p(void 0,null,function*(){try{const e=yield Ml.getNotesStats();a("success"===e.status);const t=yield fetch("http://localhost:54321/rest/v1/call_notes",{method:"HEAD",headers:{apikey:"dummy"}}).catch(()=>null);l(!t)}catch(e){a(!1),l(!0)}})},[]);const c=n;v.useEffect(()=>{Ml.setCurrentUserId(i)},[i]);const[h,f]=v.useState(null),[m,g]=v.useState(!0),[y,b]=v.useState(!1),[x,w]=v.useState(!1),[S,k]=v.useState(null),[_,C]=v.useState(null),[N,T]=v.useState({content:"",isPinned:!1,tags:[],metadata:{}}),A=v.useRef(null),E=v.useRef(null),j=v.useCallback(()=>p(void 0,null,function*(){var t;try{if(g(!0),k(null),!r)return k("Notes service is currently unavailable"),void g(!1);if(!n||!i)return k("User not authenticated - please log in"),void g(!1);const s=yield Ml.getCallNotes(e);if("error"===s.status)throw new Error(s.error||"Failed to load notes");const a=(null==(t=s.data)?void 0:t[0])||null;f(a),a&&T({content:a.content,isPinned:a.is_pinned,tags:a.tags,metadata:a.metadata})}catch(s){let e=s instanceof Error?s.message:"Failed to load notes";e.includes("Failed to fetch")||e.includes("ERR_CONNECTION_REFUSED")?e="Notes service unavailable - database connection failed":e.includes("TypeError: Failed to fetch")&&(e="Notes service temporarily unavailable"),k(e)}finally{g(!1)}}),[e,r,i]),P=()=>{b(!0),k(null),setTimeout(()=>{var e;null==(e=A.current)||e.focus()},100)};if(v.useEffect(()=>(j(),r&&!o&&n&&(E.current=Ml.subscribeToCallNotes(e,(e,t)=>{"DELETE"===t?(f(null),T({content:"",isPinned:!1,tags:[],metadata:{}}),b(!1)):e&&(f(e),y||T({content:e.content,isPinned:e.is_pinned,tags:e.tags,metadata:e.metadata}))})),()=>{E.current&&E.current()}),[e,j,y,r,o,n]),v.useEffect(()=>{N.content!==(null==h?void 0:h.content)&&(k(null),C(null))},[N.content,null==h?void 0:h.content]),m)return F.jsx("div",{className:"bg-gray-50 rounded-lg p-4",children:F.jsxs("div",{className:"flex items-center justify-center py-8",children:[F.jsx(Fo,{className:"w-6 h-6 text-blue-600 animate-spin mr-2"}),F.jsx("span",{className:"text-gray-600",children:"Loading notes..."})]})});const I=e=>{const t=new Date(e);return{date:t.toLocaleDateString(),time:t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}},L=e=>{switch(e){case"high":return"text-red-600 bg-red-50 border-red-200";case"medium":return"text-yellow-600 bg-yellow-50 border-yellow-200";case"low":return"text-green-600 bg-green-50 border-green-200";default:return"text-gray-600 bg-gray-50 border-gray-200"}};return F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-4",children:[F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx(hl,{className:"w-5 h-5 text-blue-600"}),F.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Call Notes"}),(null==h?void 0:h.is_pinned)&&F.jsx(tl,{className:"w-4 h-4 text-orange-500 fill-current"}),o&&F.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 bg-blue-50 border border-blue-200 rounded-full",children:[F.jsx(kl,{className:"w-3 h-3 text-blue-600"}),F.jsx("span",{className:"text-xs text-blue-700",children:"Local Mode"})]}),!c&&F.jsxs("div",{className:"flex items-center gap-1 px-2 py-1 bg-red-50 border border-red-200 rounded-full",children:[F.jsx(Co,{className:"w-3 h-3 text-red-600"}),F.jsx("span",{className:"text-xs text-red-700",children:"Not Logged In"})]})]}),!t&&F.jsxs("div",{className:"flex items-center gap-2",children:[h&&!y&&F.jsxs(F.Fragment,{children:[F.jsx("button",{onClick:()=>p(void 0,null,function*(){if(h)try{k(null);const t=yield Ml.togglePinNote(e);if("error"===t.status)throw new Error(t.error||"Failed to toggle pin status");f(t.data),T(e=>u(d({},e),{isPinned:t.data.is_pinned})),C(`Note ${t.data.is_pinned?"pinned":"unpinned"} successfully`),setTimeout(()=>C(null),3e3)}catch(t){const e=t instanceof Error?t.message:"Failed to toggle pin status";k(e)}}),className:"p-2 rounded-lg transition-colors "+(h.is_pinned?"text-orange-600 bg-orange-50 hover:bg-orange-100":"text-gray-500 bg-gray-100 hover:bg-gray-200"),title:h.is_pinned?"Unpin note":"Pin note",children:F.jsx(tl,{className:"w-4 h-4 "+(h.is_pinned?"fill-current":"")})}),F.jsx("button",{onClick:P,className:"p-2 text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors",title:"Edit note",children:F.jsx(ul,{className:"w-4 h-4"})}),F.jsx("button",{onClick:()=>p(void 0,null,function*(){if(h&&window.confirm("Are you sure you want to delete this note? This action cannot be undone."))try{w(!0),k(null);const t=yield Ml.deleteCallNote(e);if("error"===t.status)throw new Error(t.error||"Failed to delete note");f(null),T({content:"",isPinned:!1,tags:[],metadata:{}}),b(!1),C("Note deleted successfully"),setTimeout(()=>C(null),3e3)}catch(t){const e=t instanceof Error?t.message:"Failed to delete note";k(e)}finally{w(!1)}}),className:"p-2 text-red-600 bg-red-50 rounded-lg hover:bg-red-100 transition-colors",title:"Delete note",children:F.jsx(vl,{className:"w-4 h-4"})})]}),!h&&!y&&F.jsxs("button",{onClick:P,className:"flex items-center gap-2 px-3 py-1 text-blue-600 bg-blue-50 rounded-lg hover:bg-blue-100 transition-colors",children:[F.jsx(sl,{className:"w-4 h-4"}),"Add Note"]})]})]}),S&&F.jsxs("div",{className:"mb-4 p-3 bg-red-50 border border-red-200 rounded-lg flex items-center gap-2",children:[F.jsx(Co,{className:"w-4 h-4 text-red-600 flex-shrink-0"}),F.jsx("span",{className:"text-red-700 text-sm",children:S})]}),o&&!S&&F.jsxs("div",{className:"mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg flex items-center gap-2",children:[F.jsx(kl,{className:"w-4 h-4 text-blue-600 flex-shrink-0"}),F.jsx("span",{className:"text-blue-700 text-sm",children:"Notes are stored locally. Data will be available only on this device."})]}),_&&F.jsxs("div",{className:"mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-center gap-2",children:[F.jsx(No,{className:"w-4 h-4 text-green-600 flex-shrink-0"}),F.jsx("span",{className:"text-green-700 text-sm",children:_})]}),h&&!y&&F.jsxs("div",{className:"space-y-3",children:[F.jsxs("div",{className:"bg-white rounded-lg border p-4",children:[F.jsx("div",{className:"whitespace-pre-wrap text-gray-800 leading-relaxed",children:h.content}),h.tags.length>0&&F.jsxs("div",{className:"flex items-center gap-2 mt-3 pt-3 border-t border-gray-100",children:[F.jsx(ml,{className:"w-4 h-4 text-gray-400"}),F.jsx("div",{className:"flex flex-wrap gap-1",children:h.tags.map((e,t)=>F.jsx("span",{className:"px-2 py-1 text-xs font-medium bg-blue-50 text-blue-700 rounded-full",children:e},t))})]}),h.metadata.priority&&F.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[F.jsx("span",{className:"text-xs text-gray-500",children:"Priority:"}),F.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full border ${L(h.metadata.priority)}`,children:h.metadata.priority})]})]}),F.jsxs("div",{className:"text-xs text-gray-500 space-y-1",children:[F.jsxs("div",{children:["Created: ",I(h.created_at).date," at ",I(h.created_at).time]}),h.updated_at!==h.created_at&&F.jsxs("div",{children:["Updated: ",I(h.updated_at).date," at ",I(h.updated_at).time]})]})]}),y&&F.jsxs("div",{className:"space-y-4",children:[F.jsx("div",{children:F.jsx("textarea",{ref:A,value:N.content,onChange:e=>{const t=e.target;T(e=>u(d({},e),{content:t.value})),t.style.height="auto",t.style.height=`${t.scrollHeight}px`},placeholder:"Add your notes about this call...",className:"w-full min-h-[120px] p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none",disabled:x})}),F.jsxs("div",{className:"flex items-center gap-4",children:[F.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Priority:"}),F.jsx("div",{className:"flex gap-2",children:["low","medium","high"].map(e=>F.jsx("button",{onClick:()=>T(t=>u(d({},t),{metadata:u(d({},t.metadata),{priority:e})})),className:`px-3 py-1 text-xs font-medium rounded-full border transition-colors ${N.metadata.priority===e?L(e):"text-gray-600 bg-gray-50 border-gray-200 hover:bg-gray-100"}`,disabled:x,children:e},e))})]}),F.jsxs("div",{className:"flex items-center justify-between",children:[F.jsx("div",{className:"flex items-center gap-2",children:F.jsxs("button",{onClick:()=>T(e=>u(d({},e),{isPinned:!e.isPinned})),className:"flex items-center gap-2 px-3 py-1 text-sm rounded-lg transition-colors "+(N.isPinned?"text-orange-600 bg-orange-50 border border-orange-200":"text-gray-600 bg-gray-50 border border-gray-200 hover:bg-gray-100"),disabled:x,children:[F.jsx(tl,{className:"w-4 h-4 "+(N.isPinned?"fill-current":"")}),N.isPinned?"Pinned":"Pin note"]})}),F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx("button",{onClick:()=>{T(h?{content:h.content,isPinned:h.is_pinned,tags:h.tags,metadata:h.metadata}:{content:"",isPinned:!1,tags:[],metadata:{}}),b(!1),k(null)},className:"px-4 py-2 text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors",disabled:x,children:F.jsx(_l,{className:"w-4 h-4"})}),F.jsxs("button",{onClick:()=>p(void 0,null,function*(){if(N.content.trim())if(r)if(n&&i)try{w(!0),k(null);const t=yield Ml.upsertCallNote(e,N.content,{isPinned:N.isPinned,tags:N.tags,metadata:N.metadata});if("error"===t.status)throw new Error(t.error||"Failed to save note");f(t.data),b(!1),C("Note saved successfully"),setTimeout(()=>C(null),3e3)}catch(t){let e=t instanceof Error?t.message:"Failed to save note";e.includes("Failed to fetch")||e.includes("ERR_CONNECTION_REFUSED")?e="Cannot save note - database connection failed":e.includes("TypeError: Failed to fetch")&&(e="Cannot save note - service temporarily unavailable"),k(e)}finally{w(!1)}else k("User not authenticated - cannot save note");else k("Notes service not available - cannot save note");else k("Note content cannot be empty")}),disabled:x||!N.content.trim(),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[x?F.jsx(Fo,{className:"w-4 h-4 animate-spin"}):F.jsx(rl,{className:"w-4 h-4"}),x?"Saving...":"Save Note"]})]})]})]}),!h&&!y&&F.jsxs("div",{className:"text-center py-8",children:[F.jsx(hl,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),F.jsx("p",{className:"text-gray-500 mb-4",children:"No notes for this call yet."}),!t&&F.jsxs("button",{onClick:P,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors mx-auto",children:[F.jsx(sl,{className:"w-4 h-4"}),"Add Your First Note"]})]})]})},Gl=({call:e,isOpen:t,onClose:s})=>{var i,n,r;if(!t)return null;const{date:a,time:o}=(e=>{const t=new Date(e);return{date:t.toLocaleDateString(),time:t.toLocaleTimeString()}})(e.start_timestamp);return F.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:F.jsxs("div",{className:"bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[F.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[F.jsxs("div",{className:"flex items-center gap-4",children:[F.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center",children:F.jsx(Qo,{className:"w-6 h-6 text-blue-600"})}),F.jsxs("div",{children:[F.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:(null==(i=e.metadata)?void 0:i.patient_name)||`Patient ${e.patient_id}`}),F.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[F.jsxs("span",{children:["ID: ",e.patient_id]}),F.jsxs("span",{className:"flex items-center gap-1",children:[F.jsx(bo,{className:"w-4 h-4"}),a," at ",o]})]})]})]}),F.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:F.jsx(_l,{className:"w-5 h-5 text-gray-500"})})]}),F.jsx("div",{className:"overflow-y-auto max-h-[calc(90vh-140px)]",children:F.jsxs("div",{className:"p-6 space-y-6",children:[F.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(Eo,{className:"w-4 h-4 text-blue-600"}),F.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Duration"})]}),F.jsx("div",{className:"text-2xl font-bold text-blue-600",children:(e=>{if(!e||e<=0)return"0:00";return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`})(e.call_length_seconds)})]}),F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(yl,{className:"w-4 h-4 text-green-600"}),F.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Status"})]}),F.jsx("span",{className:`inline-block px-3 py-1 rounded-full text-sm font-medium ${(e=>{switch(e){case"completed":return"text-green-600 bg-green-50";case"failed":return"text-red-600 bg-red-50";case"active":return"text-blue-600 bg-blue-50";default:return"text-gray-600 bg-gray-50"}})(e.call_status)}`,children:e.call_status})]}),e.cost&&F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(Po,{className:"w-4 h-4 text-purple-600"}),F.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Cost"})]}),F.jsxs("div",{className:"text-2xl font-bold text-purple-600",children:["$",e.cost.toFixed(3)]})]})]}),F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Contact Information"}),F.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[F.jsxs("div",{children:[F.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Patient Name"}),F.jsx("p",{className:"text-gray-900",children:(null==(n=e.metadata)?void 0:n.patient_name)||"N/A"})]}),F.jsxs("div",{children:[F.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Phone Number"}),F.jsx("p",{className:"text-gray-900",children:e.phone_number||"N/A"})]}),F.jsxs("div",{children:[F.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Call Type"}),F.jsx("p",{className:"text-gray-900",children:(null==(r=e.metadata)?void 0:r.call_type)||e.call_type||"N/A"})]}),F.jsxs("div",{children:[F.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Patient ID"}),F.jsx("p",{className:"text-gray-900",children:e.patient_id||"N/A"})]})]})]}),e.sentiment_analysis&&F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Sentiment Analysis"}),F.jsxs("div",{className:"flex items-center gap-4",children:[F.jsx("span",{className:`px-4 py-2 rounded-full text-sm font-medium border ${(e=>{switch(e){case"positive":return"text-green-600 bg-green-50 border-green-200";case"negative":return"text-red-600 bg-red-50 border-red-200";case"neutral":return"text-yellow-600 bg-yellow-50 border-yellow-200";default:return"text-gray-600 bg-gray-50 border-gray-200"}})(e.sentiment_analysis.overall_sentiment)}`,children:e.sentiment_analysis.overall_sentiment}),F.jsxs("span",{className:"text-sm text-gray-600",children:["Confidence: ",Math.round(100*e.sentiment_analysis.confidence_score),"%"]})]})]}),e.call_summary&&F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Call Summary"}),F.jsx("p",{className:"text-gray-700 leading-relaxed",children:e.call_summary})]}),e.transcript&&F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Full Transcript"}),F.jsx("div",{className:"bg-white rounded border p-4 max-h-64 overflow-y-auto",children:(()=>{const t=e.transcript.trim();t.includes("…");if(/\b(AI|Agent|Assistant|Patient|User|Human|Caller|Customer|Client|Bot|System):\s/i.test(t)||/^(AI|Agent|Assistant|Patient|User|Human|Caller|Customer|Client|Bot|System)\s*:/im.test(t)||/\[(AI|Agent|Assistant|Patient|User|Human|Caller|Customer|Client|Bot|System)\]/i.test(t)){const e=t.split("\n").filter(e=>e.trim());return F.jsx("div",{className:"space-y-3",children:e.map((e,t)=>{var s;const i=e.trim(),n=i.match(/^(\[?)?(AI|Agent|Assistant|Bot|System)(\]?)?:?\s*(.*)/i)||i.match(/^\[(AI|Agent|Assistant|Bot|System)\]\s*(.*)/i),r=i.match(/^(\[?)?(Patient|User|Human|Caller|Customer|Client)(\]?)?:?\s*(.*)/i)||i.match(/^\[(Patient|User|Human|Caller|Customer|Client)\]\s*(.*)/i),a=i.match(/User pressed keypad:\s*([0-9#*]+)\s*digit:\s*([0-9#*]+)/i)||i.match(/^(User pressed keypad|digit):\s*(.*)/i)||i.match(/keypad:\s*([0-9#*]+)/i)||i.match(/pressed\s+([0-9#*]+)/i)||i.match(/press\s+([0-9#*]+)/i)||i.match(/pound\s+sign/i);if(n){const e=n[4]||n[2]||i.replace(/^.*?:\s*/,"");return F.jsxs("div",{className:"flex items-start gap-3",children:[F.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center",children:F.jsx("div",{className:"w-3 h-3 bg-blue-500 rounded-full"})}),F.jsxs("div",{className:"flex-1",children:[F.jsx("div",{className:"text-xs font-medium text-blue-700 mb-1",children:"AI Assistant"}),F.jsx("p",{className:"text-gray-800 leading-relaxed",children:e.trim()})]})]},t)}if(a){let e="unknown input";if(a[1]&&a[2])e=a[1];else if(a[2])e=a[2];else if(a[1])e=a[1];else{const t=null==(s=i.match(/([0-9#*]+)/))?void 0:s[1];t&&(e=t)}return F.jsxs("div",{className:"flex items-start gap-3",children:[F.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center",children:F.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded-full"})}),F.jsxs("div",{className:"flex-1",children:[F.jsx("div",{className:"text-xs font-medium text-orange-700 mb-1",children:"📞 Keypad Input"}),F.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded px-3 py-1 inline-block",children:F.jsx("span",{className:"text-orange-800 font-mono text-sm font-bold",children:e.trim()})})]})]},t)}if(r){const e=r[4]||r[2]||i.replace(/^.*?:\s*/,"");return F.jsxs("div",{className:"flex items-start gap-3",children:[F.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-green-100 rounded-full flex items-center justify-center",children:F.jsx("div",{className:"w-3 h-3 bg-green-500 rounded-full"})}),F.jsxs("div",{className:"flex-1",children:[F.jsx("div",{className:"text-xs font-medium text-green-700 mb-1",children:"Caller"}),F.jsx("p",{className:"text-gray-800 leading-relaxed",children:e.trim()})]})]},t)}if(i.includes(":")&&i.length>5){const e=i.indexOf(":"),s=i.substring(0,e).trim(),n=i.substring(e+1).trim(),r=/keypad|digit|pressed/i.test(s)||/^[0-9#*]+$/.test(n.trim())||/User pressed keypad/i.test(i);let a,o,l,c;if(r)a="bg-orange-100",o="bg-orange-500",l="text-orange-700",c="📞 Keypad Input";else{const e=/^(ai|agent|assistant|bot|system)/i.test(s);a=e?"bg-blue-100":"bg-green-100",o=e?"bg-blue-500":"bg-green-500",l=e?"text-blue-700":"text-green-700",c=e?"AI Assistant":"Caller"}return F.jsxs("div",{className:"flex items-start gap-3",children:[F.jsx("div",{className:`flex-shrink-0 w-8 h-8 ${a} rounded-full flex items-center justify-center`,children:F.jsx("div",{className:`w-3 h-3 ${o} rounded-full`})}),F.jsxs("div",{className:"flex-1",children:[F.jsx("div",{className:`text-xs font-medium ${l} mb-1`,children:c}),r?F.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded px-3 py-1 inline-block",children:F.jsx("span",{className:"text-orange-800 font-mono text-sm font-bold",children:n})}):F.jsx("p",{className:"text-gray-800 leading-relaxed",children:n})]})]},t)}{const e=i.match(/^([0-9#*]+)$/)||i.match(/keypad.*?([0-9#*]+)/i)||i.match(/pressed.*?([0-9#*]+)/i)||i.match(/User pressed keypad:\s*([0-9#*]+)/i);if(e){const s=e[1]||i.trim();return F.jsxs("div",{className:"flex items-start gap-3",children:[F.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center",children:F.jsx("div",{className:"w-3 h-3 bg-orange-500 rounded-full"})}),F.jsxs("div",{className:"flex-1",children:[F.jsx("div",{className:"text-xs font-medium text-orange-700 mb-1",children:"📞 Keypad Input"}),F.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded px-3 py-1 inline-block",children:F.jsx("span",{className:"text-orange-800 font-mono text-sm font-bold",children:s})})]})]},t)}return F.jsx("div",{className:"pl-11",children:F.jsx("p",{className:"text-gray-700 leading-relaxed",children:i})},t)}})})}{const e=t.split("\n").filter(e=>e.trim().length>0);if(e.length>1&&e.some(e=>e.length>100)){const t=[];let s="";for(const i of e){(/^(Hello|Hi|Thank you|Thanks|Yes|No|Okay|Sure)\b/i.test(i.trim())||/^(How|What|When|Where|Why|Can|Could|Would|Are|Do|Did)\b/i.test(i.trim()))&&s.length>50?(t.push(s.trim()),s=i):s+=(s?" ":"")+i}if(s&&t.push(s.trim()),t.length>=2&&t.length<=4)return F.jsx("div",{className:"space-y-3",children:t.map((e,t)=>{const s=t%2==0,i=s?"bg-blue-100":"bg-green-100",n=s?"bg-blue-500":"bg-green-500",r=s?"text-blue-700":"text-green-700",a=s?"AI Assistant":"Caller";return F.jsxs("div",{className:"flex items-start gap-3",children:[F.jsx("div",{className:`flex-shrink-0 w-8 h-8 ${i} rounded-full flex items-center justify-center`,children:F.jsx("div",{className:`w-3 h-3 ${n} rounded-full`})}),F.jsxs("div",{className:"flex-1",children:[F.jsx("div",{className:`text-xs font-medium ${r} mb-1`,children:a}),F.jsx("p",{className:"text-gray-800 leading-relaxed",children:e})]})]},t)})})}return F.jsx("div",{className:"space-y-3",children:F.jsxs("div",{className:"flex items-start gap-3",children:[F.jsx("div",{className:"flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center",children:F.jsx("div",{className:"w-3 h-3 bg-blue-500 rounded-full"})}),F.jsxs("div",{className:"flex-1",children:[F.jsx("div",{className:"text-xs font-medium text-blue-700 mb-1",children:"AI Assistant"}),F.jsx("p",{className:"text-gray-800 leading-relaxed whitespace-pre-wrap",children:t})]})]})})}})()})]}),F.jsx(Vl,{callId:e.call_id}),F.jsxs("div",{className:"flex flex-wrap gap-3 pt-4 border-t border-gray-200",children:[F.jsxs("button",{className:"flex items-center gap-2 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:[F.jsx(Io,{className:"w-4 h-4"}),"Download"]}),F.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[F.jsx(No,{className:"w-4 h-4 text-green-500"}),F.jsx("span",{className:"text-sm text-green-600 font-medium",children:"HIPAA Compliant"})]})]})]})})]})})};var Jl={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,s="~";function i(){}function n(e,t,s){this.fn=e,this.context=t,this.once=s||!1}function r(e,t,i,r,a){if("function"!=typeof i)throw new TypeError("The listener must be a function");var o=new n(i,r||e,a),l=s?s+t:t;return e._events[l]?e._events[l].fn?e._events[l]=[e._events[l],o]:e._events[l].push(o):(e._events[l]=o,e._eventsCount++),e}function a(e,t){0===--e._eventsCount?e._events=new i:delete e._events[t]}function o(){this._events=new i,this._eventsCount=0}Object.create&&(i.prototype=Object.create(null),(new i).__proto__||(s=!1)),o.prototype.eventNames=function(){var e,i,n=[];if(0===this._eventsCount)return n;for(i in e=this._events)t.call(e,i)&&n.push(s?i.slice(1):i);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},o.prototype.listeners=function(e){var t=s?s+e:e,i=this._events[t];if(!i)return[];if(i.fn)return[i.fn];for(var n=0,r=i.length,a=new Array(r);n<r;n++)a[n]=i[n].fn;return a},o.prototype.listenerCount=function(e){var t=s?s+e:e,i=this._events[t];return i?i.fn?1:i.length:0},o.prototype.emit=function(e,t,i,n,r,a){var o=s?s+e:e;if(!this._events[o])return!1;var l,c,d=this._events[o],u=arguments.length;if(d.fn){switch(d.once&&this.removeListener(e,d.fn,void 0,!0),u){case 1:return d.fn.call(d.context),!0;case 2:return d.fn.call(d.context,t),!0;case 3:return d.fn.call(d.context,t,i),!0;case 4:return d.fn.call(d.context,t,i,n),!0;case 5:return d.fn.call(d.context,t,i,n,r),!0;case 6:return d.fn.call(d.context,t,i,n,r,a),!0}for(c=1,l=new Array(u-1);c<u;c++)l[c-1]=arguments[c];d.fn.apply(d.context,l)}else{var h,f=d.length;for(c=0;c<f;c++)switch(d[c].once&&this.removeListener(e,d[c].fn,void 0,!0),u){case 1:d[c].fn.call(d[c].context);break;case 2:d[c].fn.call(d[c].context,t);break;case 3:d[c].fn.call(d[c].context,t,i);break;case 4:d[c].fn.call(d[c].context,t,i,n);break;default:if(!l)for(h=1,l=new Array(u-1);h<u;h++)l[h-1]=arguments[h];d[c].fn.apply(d[c].context,l)}}return!0},o.prototype.on=function(e,t,s){return r(this,e,t,s,!1)},o.prototype.once=function(e,t,s){return r(this,e,t,s,!0)},o.prototype.removeListener=function(e,t,i,n){var r=s?s+e:e;if(!this._events[r])return this;if(!t)return a(this,r),this;var o=this._events[r];if(o.fn)o.fn!==t||n&&!o.once||i&&o.context!==i||a(this,r);else{for(var l=0,c=[],d=o.length;l<d;l++)(o[l].fn!==t||n&&!o[l].once||i&&o[l].context!==i)&&c.push(o[l]);c.length?this._events[r]=1===c.length?c[0]:c:a(this,r)}return this},o.prototype.removeAllListeners=function(e){var t;return e?(t=s?s+e:e,this._events[t]&&a(this,t)):(this._events=new i,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=s,o.EventEmitter=o,e.exports=o}(Jl);const Wl=w(Jl.exports);var Kl={};function Yl(e,t){return t.forEach(function(t){t&&"string"!=typeof t&&!Array.isArray(t)&&Object.keys(t).forEach(function(s){if("default"!==s&&!(s in e)){var i=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(e,s,i.get?i:{enumerable:!0,get:function(){return t[s]}})}})}),Object.freeze(e)}var Xl=Object.defineProperty,Ql=(e,t,s)=>((e,t,s)=>t in e?Xl(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);let Zl=class{constructor(){Ql(this,"_locking"),Ql(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){let e;this._locks+=1;const t=new Promise(t=>e=()=>{this._locks-=1,t()}),s=this._locking.then(()=>e);return this._locking=this._locking.then(()=>t),s}};function ec(e,t){if(!e)throw new Error(t)}function tc(e){if("number"!=typeof e)throw new Error("invalid int 32: "+typeof e);if(!Number.isInteger(e)||e>2147483647||e<-2147483648)throw new Error("invalid int 32: "+e)}function sc(e){if("number"!=typeof e)throw new Error("invalid uint 32: "+typeof e);if(!Number.isInteger(e)||e>4294967295||e<0)throw new Error("invalid uint 32: "+e)}function ic(e){if("number"!=typeof e)throw new Error("invalid float 32: "+typeof e);if(Number.isFinite(e)&&(e>34028234663852886e22||e<-34028234663852886e22))throw new Error("invalid float 32: "+e)}const nc=Symbol("@bufbuild/protobuf/enum-type");function rc(e){const t=e[nc];return ec(t,"missing enum type on enum object"),t}function ac(e,t,s,i){e[nc]=oc(t,s.map(t=>({no:t.no,name:t.name,localName:e[t.no]})))}function oc(e,t,s){const i=Object.create(null),n=Object.create(null),r=[];for(const a of t){const e=cc(a);r.push(e),i[a.name]=e,n[a.no]=e}return{typeName:e,values:r,findName:e=>i[e],findNumber:e=>n[e]}}function lc(e,t,s){const i={};for(const n of t){const e=cc(n);i[e.localName]=e.no,i[e.no]=e.localName}return ac(i,e,t),i}function cc(e){return"localName"in e?e:Object.assign(Object.assign({},e),{localName:e.name})}class dc{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){const s=this.getType().runtime.bin,i=s.makeReadOptions(t);return s.readMessage(this,i.readerFactory(e),e.byteLength,i),this}fromJson(e,t){const s=this.getType(),i=s.runtime.json,n=i.makeReadOptions(t);return i.readMessage(s,e,n,this),this}fromJsonString(e,t){let s;try{s=JSON.parse(e)}catch(Tx){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(Tx instanceof Error?Tx.message:String(Tx)))}return this.fromJson(s,t)}toBinary(e){const t=this.getType().runtime.bin,s=t.makeWriteOptions(e),i=s.writerFactory();return t.writeMessage(this,i,s),i.finish()}toJson(e){const t=this.getType().runtime.json,s=t.makeWriteOptions(e);return t.writeMessage(this,s)}toJsonString(e){var t;const s=this.toJson(e);return JSON.stringify(s,null,null!==(t=null==e?void 0:e.prettySpaces)&&void 0!==t?t:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function uc(){let e=0,t=0;for(let i=0;i<28;i+=7){let s=this.buf[this.pos++];if(e|=(127&s)<<i,!(128&s))return this.assertBounds(),[e,t]}let s=this.buf[this.pos++];if(e|=(15&s)<<28,t=(112&s)>>4,!(128&s))return this.assertBounds(),[e,t];for(let i=3;i<=31;i+=7){let s=this.buf[this.pos++];if(t|=(127&s)<<i,!(128&s))return this.assertBounds(),[e,t]}throw new Error("invalid varint")}function hc(e,t,s){for(let r=0;r<28;r+=7){const i=e>>>r,n=!(i>>>7==0&&0==t),a=255&(n?128|i:i);if(s.push(a),!n)return}const i=e>>>28&15|(7&t)<<4,n=!!(t>>3);if(s.push(255&(n?128|i:i)),n){for(let e=3;e<31;e+=7){const i=t>>>e,n=!(i>>>7==0),r=255&(n?128|i:i);if(s.push(r),!n)return}s.push(t>>>31&1)}}const fc=4294967296;function mc(e){const t="-"===e[0];t&&(e=e.slice(1));const s=1e6;let i=0,n=0;function r(t,r){const a=Number(e.slice(t,r));n*=s,i=i*s+a,i>=fc&&(n+=i/fc|0,i%=fc)}return r(-24,-18),r(-18,-12),r(-12,-6),r(-6),t?vc(i,n):gc(i,n)}function pc(e,t){if(({lo:e,hi:t}=function(e,t){return{lo:e>>>0,hi:t>>>0}}(e,t)),t<=2097151)return String(fc*t+e);const s=16777215&(e>>>24|t<<8),i=t>>16&65535;let n=(16777215&e)+6777216*s+6710656*i,r=s+8147497*i,a=2*i;const o=1e7;return n>=o&&(r+=Math.floor(n/o),n%=o),r>=o&&(a+=Math.floor(r/o),r%=o),a.toString()+yc(r)+yc(n)}function gc(e,t){return{lo:0|e,hi:0|t}}function vc(e,t){return t=~t,e?e=1+~e:t+=1,gc(e,t)}const yc=e=>{const t=String(e);return"0000000".slice(t.length)+t};function bc(e,t){if(e>=0){for(;e>127;)t.push(127&e|128),e>>>=7;t.push(e)}else{for(let s=0;s<9;s++)t.push(127&e|128),e>>=7;t.push(1)}}function xc(){let e=this.buf[this.pos++],t=127&e;if(!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<7,!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<14,!(128&e))return this.assertBounds(),t;if(e=this.buf[this.pos++],t|=(127&e)<<21,!(128&e))return this.assertBounds(),t;e=this.buf[this.pos++],t|=(15&e)<<28;for(let s=5;128&e&&s<10;s++)e=this.buf[this.pos++];if(128&e)throw new Error("invalid varint");return this.assertBounds(),t>>>0}const wc=function(){const e=new DataView(new ArrayBuffer(8));if("function"==typeof BigInt&&"function"==typeof e.getBigInt64&&"function"==typeof e.getBigUint64&&"function"==typeof e.setBigInt64&&"function"==typeof e.setBigUint64&&("object"!=typeof process||"1"!==Kl.BUF_BIGINT_DISABLE)){const t=BigInt("-9223372036854775808"),s=BigInt("9223372036854775807"),i=BigInt("0"),n=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(e){const i="bigint"==typeof e?e:BigInt(e);if(i>s||i<t)throw new Error("int64 invalid: ".concat(e));return i},uParse(e){const t="bigint"==typeof e?e:BigInt(e);if(t>n||t<i)throw new Error("uint64 invalid: ".concat(e));return t},enc(t){return e.setBigInt64(0,this.parse(t),!0),{lo:e.getInt32(0,!0),hi:e.getInt32(4,!0)}},uEnc(t){return e.setBigInt64(0,this.uParse(t),!0),{lo:e.getInt32(0,!0),hi:e.getInt32(4,!0)}},dec:(t,s)=>(e.setInt32(0,t,!0),e.setInt32(4,s,!0),e.getBigInt64(0,!0)),uDec:(t,s)=>(e.setInt32(0,t,!0),e.setInt32(4,s,!0),e.getBigUint64(0,!0))}}const t=e=>ec(/^-?[0-9]+$/.test(e),"int64 invalid: ".concat(e)),s=e=>ec(/^[0-9]+$/.test(e),"uint64 invalid: ".concat(e));return{zero:"0",supported:!1,parse:e=>("string"!=typeof e&&(e=e.toString()),t(e),e),uParse:e=>("string"!=typeof e&&(e=e.toString()),s(e),e),enc:e=>("string"!=typeof e&&(e=e.toString()),t(e),mc(e)),uEnc:e=>("string"!=typeof e&&(e=e.toString()),s(e),mc(e)),dec:(e,t)=>function(e,t){let s=gc(e,t);const i=2147483648&s.hi;i&&(s=vc(s.lo,s.hi));const n=pc(s.lo,s.hi);return i?"-"+n:n}(e,t),uDec:(e,t)=>pc(e,t)}}();var Sc,kc,_c,Cc,Nc,Tc;function Ac(e,t,s){if(t===s)return!0;if(e==Sc.BYTES){if(!(t instanceof Uint8Array&&s instanceof Uint8Array))return!1;if(t.length!==s.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==s[e])return!1;return!0}switch(e){case Sc.UINT64:case Sc.FIXED64:case Sc.INT64:case Sc.SFIXED64:case Sc.SINT64:return t==s}return!1}function Ec(e,t){switch(e){case Sc.BOOL:return!1;case Sc.UINT64:case Sc.FIXED64:case Sc.INT64:case Sc.SFIXED64:case Sc.SINT64:return 0==t?wc.zero:"0";case Sc.DOUBLE:case Sc.FLOAT:return 0;case Sc.BYTES:return new Uint8Array(0);case Sc.STRING:return"";default:return 0}}function jc(e,t){switch(e){case Sc.BOOL:return!1===t;case Sc.STRING:return""===t;case Sc.BYTES:return t instanceof Uint8Array&&!t.byteLength;default:return 0==t}}(kc=Sc||(Sc={}))[kc.DOUBLE=1]="DOUBLE",kc[kc.FLOAT=2]="FLOAT",kc[kc.INT64=3]="INT64",kc[kc.UINT64=4]="UINT64",kc[kc.INT32=5]="INT32",kc[kc.FIXED64=6]="FIXED64",kc[kc.FIXED32=7]="FIXED32",kc[kc.BOOL=8]="BOOL",kc[kc.STRING=9]="STRING",kc[kc.BYTES=12]="BYTES",kc[kc.UINT32=13]="UINT32",kc[kc.SFIXED32=15]="SFIXED32",kc[kc.SFIXED64=16]="SFIXED64",kc[kc.SINT32=17]="SINT32",kc[kc.SINT64=18]="SINT64",(Cc=_c||(_c={}))[Cc.BIGINT=0]="BIGINT",Cc[Cc.STRING=1]="STRING",(Tc=Nc||(Nc={}))[Tc.Varint=0]="Varint",Tc[Tc.Bit64=1]="Bit64",Tc[Tc.LengthDelimited=2]="LengthDelimited",Tc[Tc.StartGroup=3]="StartGroup",Tc[Tc.EndGroup=4]="EndGroup",Tc[Tc.Bit32=5]="Bit32";class Pc{constructor(e){this.stack=[],this.textEncoder=null!=e?e:new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let i=0;i<this.chunks.length;i++)e+=this.chunks[i].length;let t=new Uint8Array(e),s=0;for(let i=0;i<this.chunks.length;i++)t.set(this.chunks[i],s),s+=this.chunks[i].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(sc(e);e>127;)this.buf.push(127&e|128),e>>>=7;return this.buf.push(e),this}int32(e){return tc(e),bc(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){ic(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){sc(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){tc(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return tc(e),bc(e=(e<<1^e>>31)>>>0,this.buf),this}sfixed64(e){let t=new Uint8Array(8),s=new DataView(t.buffer),i=wc.enc(e);return s.setInt32(0,i.lo,!0),s.setInt32(4,i.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),s=new DataView(t.buffer),i=wc.uEnc(e);return s.setInt32(0,i.lo,!0),s.setInt32(4,i.hi,!0),this.raw(t)}int64(e){let t=wc.enc(e);return hc(t.lo,t.hi,this.buf),this}sint64(e){let t=wc.enc(e),s=t.hi>>31;return hc(t.lo<<1^s,(t.hi<<1|t.lo>>>31)^s,this.buf),this}uint64(e){let t=wc.uEnc(e);return hc(t.lo,t.hi,this.buf),this}}class Ic{constructor(e,t){this.varint64=uc,this.uint32=xc,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=null!=t?t:new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,s=7&e;if(t<=0||s<0||s>5)throw new Error("illegal tag: field no "+t+" wire type "+s);return[t,s]}skip(e,t){let s=this.pos;switch(e){case Nc.Varint:for(;128&this.buf[this.pos++];);break;case Nc.Bit64:this.pos+=4;case Nc.Bit32:this.pos+=4;break;case Nc.LengthDelimited:let s=this.uint32();this.pos+=s;break;case Nc.StartGroup:for(;;){const[e,s]=this.tag();if(s===Nc.EndGroup){if(void 0!==t&&e!==t)throw new Error("invalid end group tag");break}this.skip(s,e)}break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(s,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return 0|this.uint32()}sint32(){let e=this.uint32();return e>>>1^-(1&e)}int64(){return wc.dec(...this.varint64())}uint64(){return wc.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64(),s=-(1&e);return e=(e>>>1|(1&t)<<31)^s,t=t>>>1^s,wc.dec(e,t)}bool(){let[e,t]=this.varint64();return 0!==e||0!==t}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return wc.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return wc.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}function Lc(e){const t=e.field.localName,s=Object.create(null);return s[t]=function(e){const t=e.field;if(t.repeated)return[];if(void 0!==t.default)return t.default;switch(t.kind){case"enum":return t.T.values[0].no;case"scalar":return Ec(t.T,t.L);case"message":const e=t.T,s=new e;return e.fieldWrapper?e.fieldWrapper.unwrapField(s):s;case"map":throw"map fields are not allowed to be extensions"}}(e),[s,()=>s[t]]}let Rc="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),Oc=[];for(let Yw=0;Yw<Rc.length;Yw++)Oc[Rc[Yw].charCodeAt(0)]=Yw;Oc["-".charCodeAt(0)]=Rc.indexOf("+"),Oc["_".charCodeAt(0)]=Rc.indexOf("/");const Dc={dec(e){let t=3*e.length/4;"="==e[e.length-2]?t-=2:"="==e[e.length-1]&&(t-=1);let s,i=new Uint8Array(t),n=0,r=0,a=0;for(let o=0;o<e.length;o++){if(s=Oc[e.charCodeAt(o)],void 0===s)switch(e[o]){case"=":r=0;case"\n":case"\r":case"\t":case" ":continue;default:throw Error("invalid base64 string.")}switch(r){case 0:a=s,r=1;break;case 1:i[n++]=a<<2|(48&s)>>4,a=s,r=2;break;case 2:i[n++]=(15&a)<<4|(60&s)>>2,a=s,r=3;break;case 3:i[n++]=(3&a)<<6|s,r=0}}if(1==r)throw Error("invalid base64 string.");return i.subarray(0,n)},enc(e){let t,s="",i=0,n=0;for(let r=0;r<e.length;r++)switch(t=e[r],i){case 0:s+=Rc[t>>2],n=(3&t)<<4,i=1;break;case 1:s+=Rc[n|t>>4],n=(15&t)<<2,i=2;break;case 2:s+=Rc[n|t>>6],s+=Rc[63&t],i=0}return i&&(s+=Rc[n],s+="=",1==i&&(s+="=")),s}};function Mc(e,t,s){Bc(t,e);const i=t.runtime.bin.makeReadOptions(s),n=function(e,t){if(!t.repeated&&("enum"==t.kind||"scalar"==t.kind)){for(let s=e.length-1;s>=0;--s)if(e[s].no==t.no)return[e[s]];return[]}return e.filter(e=>e.no===t.no)}(e.getType().runtime.bin.listUnknownFields(e),t.field),[r,a]=Lc(t);for(const o of n)t.runtime.bin.readField(r,i.readerFactory(o.data),t.field,o.wireType,i);return a()}function Uc(e,t,s,i){Bc(t,e);const n=t.runtime.bin.makeReadOptions(i),r=t.runtime.bin.makeWriteOptions(i);if(Fc(e,t)){const s=e.getType().runtime.bin.listUnknownFields(e).filter(e=>e.no!=t.field.no);e.getType().runtime.bin.discardUnknownFields(e);for(const t of s)e.getType().runtime.bin.onUnknownField(e,t.no,t.wireType,t.data)}const a=r.writerFactory();let o=t.field;o.opt||o.repeated||"enum"!=o.kind&&"scalar"!=o.kind||(o=Object.assign(Object.assign({},t.field),{opt:!0})),t.runtime.bin.writeField(o,s,a,r);const l=n.readerFactory(a.finish());for(;l.pos<l.len;){const[t,s]=l.tag(),i=l.skip(s,t);e.getType().runtime.bin.onUnknownField(e,t,s,i)}}function Fc(e,t){const s=e.getType();return t.extendee.typeName===s.typeName&&!!s.runtime.bin.listUnknownFields(e).find(e=>e.no==t.field.no)}function Bc(e,t){ec(e.extendee.typeName==t.getType().typeName,"extension ".concat(e.typeName," can only be applied to message ").concat(e.extendee.typeName))}function qc(e,t){const s=e.localName;if(e.repeated)return t[s].length>0;if(e.oneof)return t[e.oneof.localName].case===s;switch(e.kind){case"enum":case"scalar":return e.opt||e.req?void 0!==t[s]:"enum"==e.kind?t[s]!==e.T.values[0].no:!jc(e.T,t[s]);case"message":return void 0!==t[s];case"map":return Object.keys(t[s]).length>0}}function $c(e,t){const s=e.localName,i=!e.opt&&!e.req;if(e.repeated)t[s]=[];else if(e.oneof)t[e.oneof.localName]={case:void 0};else switch(e.kind){case"map":t[s]={};break;case"enum":t[s]=i?e.T.values[0].no:void 0;break;case"scalar":t[s]=i?Ec(e.T,e.L):void 0;break;case"message":t[s]=void 0}}function zc(e,t){if(null===e||"object"!=typeof e)return!1;if(!Object.getOwnPropertyNames(dc.prototype).every(t=>t in e&&"function"==typeof e[t]))return!1;const s=e.getType();return null!==s&&"function"==typeof s&&"typeName"in s&&"string"==typeof s.typeName&&(void 0===t||s.typeName==t.typeName)}function Hc(e,t){return zc(t)||!e.fieldWrapper?t:e.fieldWrapper.wrapField(t)}Sc.DOUBLE,Sc.FLOAT,Sc.INT64,Sc.UINT64,Sc.INT32,Sc.UINT32,Sc.BOOL,Sc.STRING,Sc.BYTES;const Vc={ignoreUnknownFields:!1},Gc={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function Jc(e){return e?Object.assign(Object.assign({},Vc),e):Vc}function Wc(e){return e?Object.assign(Object.assign({},Gc),e):Gc}const Kc=Symbol(),Yc=Symbol();function Xc(e){if(null===e)return"null";switch(typeof e){case"object":return Array.isArray(e)?"array":"object";case"string":return e.length>100?"string":'"'.concat(e.split('"').join('\\"'),'"');default:return String(e)}}function Qc(e,t,s,i,n){let r=s.localName;if(s.repeated){if(ec("map"!=s.kind),null===t)return;if(!Array.isArray(t))throw new Error("cannot decode field ".concat(n.typeName,".").concat(s.name," from JSON: ").concat(Xc(t)));const a=e[r];for(const e of t){if(null===e)throw new Error("cannot decode field ".concat(n.typeName,".").concat(s.name," from JSON: ").concat(Xc(e)));switch(s.kind){case"message":a.push(s.T.fromJson(e,i));break;case"enum":const t=td(s.T,e,i.ignoreUnknownFields,!0);t!==Yc&&a.push(t);break;case"scalar":try{a.push(ed(s.T,e,s.L,!0))}catch(Tx){let i="cannot decode field ".concat(n.typeName,".").concat(s.name," from JSON: ").concat(Xc(e));throw Tx instanceof Error&&Tx.message.length>0&&(i+=": ".concat(Tx.message)),new Error(i)}}}}else if("map"==s.kind){if(null===t)return;if("object"!=typeof t||Array.isArray(t))throw new Error("cannot decode field ".concat(n.typeName,".").concat(s.name," from JSON: ").concat(Xc(t)));const a=e[r];for(const[e,r]of Object.entries(t)){if(null===r)throw new Error("cannot decode field ".concat(n.typeName,".").concat(s.name," from JSON: map value null"));let o;try{o=Zc(s.K,e)}catch(Tx){let i="cannot decode map key for field ".concat(n.typeName,".").concat(s.name," from JSON: ").concat(Xc(t));throw Tx instanceof Error&&Tx.message.length>0&&(i+=": ".concat(Tx.message)),new Error(i)}switch(s.V.kind){case"message":a[o]=s.V.T.fromJson(r,i);break;case"enum":const e=td(s.V.T,r,i.ignoreUnknownFields,!0);e!==Yc&&(a[o]=e);break;case"scalar":try{a[o]=ed(s.V.T,r,_c.BIGINT,!0)}catch(Tx){let i="cannot decode map value for field ".concat(n.typeName,".").concat(s.name," from JSON: ").concat(Xc(t));throw Tx instanceof Error&&Tx.message.length>0&&(i+=": ".concat(Tx.message)),new Error(i)}}}}else switch(s.oneof&&(e=e[s.oneof.localName]={case:r},r="value"),s.kind){case"message":const a=s.T;if(null===t&&"google.protobuf.Value"!=a.typeName)return;let o=e[r];zc(o)?o.fromJson(t,i):(e[r]=o=a.fromJson(t,i),a.fieldWrapper&&!s.oneof&&(e[r]=a.fieldWrapper.unwrapField(o)));break;case"enum":const l=td(s.T,t,i.ignoreUnknownFields,!1);switch(l){case Kc:$c(s,e);break;case Yc:break;default:e[r]=l}break;case"scalar":try{const i=ed(s.T,t,s.L,!1);if(i===Kc)$c(s,e);else e[r]=i}catch(Tx){let i="cannot decode field ".concat(n.typeName,".").concat(s.name," from JSON: ").concat(Xc(t));throw Tx instanceof Error&&Tx.message.length>0&&(i+=": ".concat(Tx.message)),new Error(i)}}}function Zc(e,t){if(e===Sc.BOOL)switch(t){case"true":t=!0;break;case"false":t=!1}return ed(e,t,_c.BIGINT,!0).toString()}function ed(e,t,s,i){if(null===t)return i?Ec(e,s):Kc;switch(e){case Sc.DOUBLE:case Sc.FLOAT:if("NaN"===t)return Number.NaN;if("Infinity"===t)return Number.POSITIVE_INFINITY;if("-Infinity"===t)return Number.NEGATIVE_INFINITY;if(""===t)break;if("string"==typeof t&&t.trim().length!==t.length)break;if("string"!=typeof t&&"number"!=typeof t)break;const i=Number(t);if(Number.isNaN(i))break;if(!Number.isFinite(i))break;return e==Sc.FLOAT&&ic(i),i;case Sc.INT32:case Sc.FIXED32:case Sc.SFIXED32:case Sc.SINT32:case Sc.UINT32:let n;if("number"==typeof t?n=t:"string"==typeof t&&t.length>0&&t.trim().length===t.length&&(n=Number(t)),void 0===n)break;return e==Sc.UINT32||e==Sc.FIXED32?sc(n):tc(n),n;case Sc.INT64:case Sc.SFIXED64:case Sc.SINT64:if("number"!=typeof t&&"string"!=typeof t)break;const r=wc.parse(t);return s?r.toString():r;case Sc.FIXED64:case Sc.UINT64:if("number"!=typeof t&&"string"!=typeof t)break;const a=wc.uParse(t);return s?a.toString():a;case Sc.BOOL:if("boolean"!=typeof t)break;return t;case Sc.STRING:if("string"!=typeof t)break;try{encodeURIComponent(t)}catch(Tx){throw new Error("invalid UTF8")}return t;case Sc.BYTES:if(""===t)return new Uint8Array(0);if("string"!=typeof t)break;return Dc.dec(t)}throw new Error}function td(e,t,s,i){if(null===t)return"google.protobuf.NullValue"==e.typeName?0:i?e.values[0].no:Kc;switch(typeof t){case"number":if(Number.isInteger(t))return t;break;case"string":const i=e.findName(t);if(void 0!==i)return i.no;if(s)return Yc}throw new Error("cannot decode enum ".concat(e.typeName," from JSON: ").concat(Xc(t)))}function sd(e){return!(!e.repeated&&"map"!=e.kind)||!e.oneof&&("message"!=e.kind&&(!e.opt&&!e.req))}function id(e,t,s){if("map"==e.kind){ec("object"==typeof t&&null!=t);const i={},n=Object.entries(t);switch(e.V.kind){case"scalar":for(const[s,r]of n)i[s.toString()]=rd(e.V.T,r);break;case"message":for(const[e,r]of n)i[e.toString()]=r.toJson(s);break;case"enum":const t=e.V.T;for(const[e,r]of n)i[e.toString()]=nd(t,r,s.enumAsInteger)}return s.emitDefaultValues||n.length>0?i:void 0}if(e.repeated){ec(Array.isArray(t));const i=[];switch(e.kind){case"scalar":for(let s=0;s<t.length;s++)i.push(rd(e.T,t[s]));break;case"enum":for(let n=0;n<t.length;n++)i.push(nd(e.T,t[n],s.enumAsInteger));break;case"message":for(let e=0;e<t.length;e++)i.push(t[e].toJson(s))}return s.emitDefaultValues||i.length>0?i:void 0}switch(e.kind){case"scalar":return rd(e.T,t);case"enum":return nd(e.T,t,s.enumAsInteger);case"message":return Hc(e.T,t).toJson(s)}}function nd(e,t,s){var i;if(ec("number"==typeof t),"google.protobuf.NullValue"==e.typeName)return null;if(s)return t;const n=e.findNumber(t);return null!==(i=null==n?void 0:n.name)&&void 0!==i?i:t}function rd(e,t){switch(e){case Sc.INT32:case Sc.SFIXED32:case Sc.SINT32:case Sc.FIXED32:case Sc.UINT32:return ec("number"==typeof t),t;case Sc.FLOAT:case Sc.DOUBLE:return ec("number"==typeof t),Number.isNaN(t)?"NaN":t===Number.POSITIVE_INFINITY?"Infinity":t===Number.NEGATIVE_INFINITY?"-Infinity":t;case Sc.STRING:return ec("string"==typeof t),t;case Sc.BOOL:return ec("boolean"==typeof t),t;case Sc.UINT64:case Sc.FIXED64:case Sc.INT64:case Sc.SFIXED64:case Sc.SINT64:return ec("bigint"==typeof t||"string"==typeof t||"number"==typeof t),t.toString();case Sc.BYTES:return ec(t instanceof Uint8Array),Dc.enc(t)}}const ad=Symbol("@bufbuild/protobuf/unknown-fields"),od={readUnknownFields:!0,readerFactory:e=>new Ic(e)},ld={writeUnknownFields:!0,writerFactory:()=>new Pc};function cd(e){return e?Object.assign(Object.assign({},od),e):od}function dd(e){return e?Object.assign(Object.assign({},ld),e):ld}function ud(e,t,s,i,n){let{repeated:r,localName:a}=s;switch(s.oneof&&((e=e[s.oneof.localName]).case!=a&&delete e.value,e.case=a,a="value"),s.kind){case"scalar":case"enum":const o="enum"==s.kind?Sc.INT32:s.T;let l=md;if("scalar"==s.kind&&s.L>0&&(l=fd),r){let s=e[a];if(i==Nc.LengthDelimited&&o!=Sc.STRING&&o!=Sc.BYTES){let e=t.uint32()+t.pos;for(;t.pos<e;)s.push(l(t,o))}else s.push(l(t,o))}else e[a]=l(t,o);break;case"message":const c=s.T;r?e[a].push(hd(t,new c,n,s)):zc(e[a])?hd(t,e[a],n,s):(e[a]=hd(t,new c,n,s),!c.fieldWrapper||s.oneof||s.repeated||(e[a]=c.fieldWrapper.unwrapField(e[a])));break;case"map":let[d,u]=function(e,t,s){const i=t.uint32(),n=t.pos+i;let r,a;for(;t.pos<n;){const[i]=t.tag();switch(i){case 1:r=md(t,e.K);break;case 2:switch(e.V.kind){case"scalar":a=md(t,e.V.T);break;case"enum":a=t.int32();break;case"message":a=hd(t,new e.V.T,s,void 0)}}}void 0===r&&(r=Ec(e.K,_c.BIGINT));"string"!=typeof r&&"number"!=typeof r&&(r=r.toString());if(void 0===a)switch(e.V.kind){case"scalar":a=Ec(e.V.T,_c.BIGINT);break;case"enum":a=e.V.T.values[0].no;break;case"message":a=new e.V.T}return[r,a]}(s,t,n);e[a][d]=u}}function hd(e,t,s,i){const n=t.getType().runtime.bin,r=null==i?void 0:i.delimited;return n.readMessage(t,e,r?i.no:e.uint32(),s,r),t}function fd(e,t){const s=md(e,t);return"bigint"==typeof s?s.toString():s}function md(e,t){switch(t){case Sc.STRING:return e.string();case Sc.BOOL:return e.bool();case Sc.DOUBLE:return e.double();case Sc.FLOAT:return e.float();case Sc.INT32:return e.int32();case Sc.INT64:return e.int64();case Sc.UINT64:return e.uint64();case Sc.FIXED64:return e.fixed64();case Sc.BYTES:return e.bytes();case Sc.FIXED32:return e.fixed32();case Sc.SFIXED32:return e.sfixed32();case Sc.SFIXED64:return e.sfixed64();case Sc.SINT64:return e.sint64();case Sc.UINT32:return e.uint32();case Sc.SINT32:return e.sint32()}}function pd(e,t,s,i){ec(void 0!==t);const n=e.repeated;switch(e.kind){case"scalar":case"enum":let r="enum"==e.kind?Sc.INT32:e.T;if(n)if(ec(Array.isArray(t)),e.packed)!function(e,t,s,i){if(!i.length)return;e.tag(s,Nc.LengthDelimited).fork();let[,n]=bd(t);for(let r=0;r<i.length;r++)e[n](i[r]);e.join()}(s,r,e.no,t);else for(const i of t)yd(s,r,e.no,i);else yd(s,r,e.no,t);break;case"message":if(n){ec(Array.isArray(t));for(const n of t)vd(s,i,e,n)}else vd(s,i,e,t);break;case"map":ec("object"==typeof t&&null!=t);for(const[n,a]of Object.entries(t))gd(s,i,e,n,a)}}function gd(e,t,s,i,n){e.tag(s.no,Nc.LengthDelimited),e.fork();let r=i;switch(s.K){case Sc.INT32:case Sc.FIXED32:case Sc.UINT32:case Sc.SFIXED32:case Sc.SINT32:r=Number.parseInt(i);break;case Sc.BOOL:ec("true"==i||"false"==i),r="true"==i}switch(yd(e,s.K,1,r),s.V.kind){case"scalar":yd(e,s.V.T,2,n);break;case"enum":yd(e,Sc.INT32,2,n);break;case"message":ec(void 0!==n),e.tag(2,Nc.LengthDelimited).bytes(n.toBinary(t))}e.join()}function vd(e,t,s,i){const n=Hc(s.T,i);s.delimited?e.tag(s.no,Nc.StartGroup).raw(n.toBinary(t)).tag(s.no,Nc.EndGroup):e.tag(s.no,Nc.LengthDelimited).bytes(n.toBinary(t))}function yd(e,t,s,i){ec(void 0!==i);let[n,r]=bd(t);e.tag(s,n)[r](i)}function bd(e){let t=Nc.Varint;switch(e){case Sc.BYTES:case Sc.STRING:t=Nc.LengthDelimited;break;case Sc.DOUBLE:case Sc.FIXED64:case Sc.SFIXED64:t=Nc.Bit64;break;case Sc.FIXED32:case Sc.SFIXED32:case Sc.FLOAT:t=Nc.Bit32}return[t,Sc[e].toLowerCase()]}function xd(e){if(void 0===e)return e;if(zc(e))return e.clone();if(e instanceof Uint8Array){const t=new Uint8Array(e.byteLength);return t.set(e),t}return e}function wd(e){return e instanceof Uint8Array?e:new Uint8Array(e)}class Sd{constructor(e,t){this._fields=e,this._normalizer=t}findJsonName(e){if(!this.jsonNames){const e={};for(const t of this.list())e[t.jsonName]=e[t.name]=t;this.jsonNames=e}return this.jsonNames[e]}find(e){if(!this.numbers){const e={};for(const t of this.list())e[t.no]=t;this.numbers=e}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((e,t)=>e.no-t.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let t;for(const s of this.list())s.oneof?s.oneof!==t&&(t=s.oneof,e.push(t)):e.push(s)}return this.members}}function kd(e,t){const s=Cd(e);return t?s:jd(Ed(s))}const _d=Cd;function Cd(e){let t=!1;const s=[];for(let i=0;i<e.length;i++){let n=e.charAt(i);switch(n){case"_":t=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":s.push(n),t=!1;break;default:t&&(t=!1,n=n.toUpperCase()),s.push(n)}}return s.join("")}const Nd=new Set(["constructor","toString","toJSON","valueOf"]),Td=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),Ad=e=>"".concat(e,"$"),Ed=e=>Td.has(e)?Ad(e):e,jd=e=>Nd.has(e)?Ad(e):e;class Pd{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=kd(e,!1)}addField(e){ec(e.oneof===this,"field ".concat(e.name," not one of ").concat(this.name)),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let e=0;e<this.fields.length;e++)this._lookup[this.fields[e].localName]=this.fields[e]}return this._lookup[e]}}const Id=(Ld=e=>new Sd(e,e=>function(e){var t,s,i,n,r,a;const o=[];let l;for(const c of"function"==typeof e?e():e){const e=c;if(e.localName=kd(c.name,void 0!==c.oneof),e.jsonName=null!==(t=c.jsonName)&&void 0!==t?t:_d(c.name),e.repeated=null!==(s=c.repeated)&&void 0!==s&&s,"scalar"==c.kind&&(e.L=null!==(i=c.L)&&void 0!==i?i:_c.BIGINT),e.delimited=null!==(n=c.delimited)&&void 0!==n&&n,e.req=null!==(r=c.req)&&void 0!==r&&r,e.opt=null!==(a=c.opt)&&void 0!==a&&a,void 0===c.packed&&(e.packed="enum"==c.kind||"scalar"==c.kind&&c.T!=Sc.BYTES&&c.T!=Sc.STRING),void 0!==c.oneof){const t="string"==typeof c.oneof?c.oneof:c.oneof.name;l&&l.name==t||(l=new Pd(t)),e.oneof=l,l.addField(e)}o.push(e)}return o}(e)),Rd=e=>{for(const t of e.getType().fields.byMember()){if(t.opt)continue;const s=t.localName,i=e;if(t.repeated)i[s]=[];else switch(t.kind){case"oneof":i[s]={case:void 0};break;case"enum":i[s]=0;break;case"map":i[s]={};break;case"scalar":i[s]=Ec(t.T,t.L)}}},{syntax:"proto3",json:{makeReadOptions:Jc,makeWriteOptions:Wc,readMessage(e,t,s,i){if(null==t||Array.isArray(t)||"object"!=typeof t)throw new Error("cannot decode message ".concat(e.typeName," from JSON: ").concat(Xc(t)));i=null!=i?i:new e;const n=new Map,r=s.typeRegistry;for(const[a,o]of Object.entries(t)){const t=e.fields.findJsonName(a);if(t){if(t.oneof){if(null===o&&"scalar"==t.kind)continue;const s=n.get(t.oneof);if(void 0!==s)throw new Error("cannot decode message ".concat(e.typeName,' from JSON: multiple keys for oneof "').concat(t.oneof.name,'" present: "').concat(s,'", "').concat(a,'"'));n.set(t.oneof,a)}Qc(i,o,t,s,e)}else{let t=!1;if((null==r?void 0:r.findExtension)&&a.startsWith("[")&&a.endsWith("]")){const n=r.findExtension(a.substring(1,a.length-1));if(n&&n.extendee.typeName==e.typeName){t=!0;const[e,r]=Lc(n);Qc(e,o,n.field,s,n),Uc(i,n,r(),s)}}if(!t&&!s.ignoreUnknownFields)throw new Error("cannot decode message ".concat(e.typeName,' from JSON: key "').concat(a,'" is unknown'))}}return i},writeMessage(e,t){const s=e.getType(),i={};let n;try{for(n of s.fields.byNumber()){if(!qc(n,e)){if(n.req)throw"required field not set";if(!t.emitDefaultValues)continue;if(!sd(n))continue}const s=id(n,n.oneof?e[n.oneof.localName].value:e[n.localName],t);void 0!==s&&(i[t.useProtoFieldName?n.name:n.jsonName]=s)}const r=t.typeRegistry;if(null==r?void 0:r.findExtensionFor)for(const n of s.runtime.bin.listUnknownFields(e)){const a=r.findExtensionFor(s.typeName,n.no);if(a&&Fc(e,a)){const s=Mc(e,a,t),n=id(a.field,s,t);void 0!==n&&(i[a.field.jsonName]=n)}}}catch(Tx){const t=n?"cannot encode field ".concat(s.typeName,".").concat(n.name," to JSON"):"cannot encode message ".concat(s.typeName," to JSON"),i=Tx instanceof Error?Tx.message:String(Tx);throw new Error(t+(i.length>0?": ".concat(i):""))}return i},readScalar:(e,t,s)=>ed(e,t,null!=s?s:_c.BIGINT,!0),writeScalar(e,t,s){if(void 0!==t)return s||jc(e,t)?rd(e,t):void 0},debug:Xc},bin:{makeReadOptions:cd,makeWriteOptions:dd,listUnknownFields(e){var t;return null!==(t=e[ad])&&void 0!==t?t:[]},discardUnknownFields(e){delete e[ad]},writeUnknownFields(e,t){const s=e[ad];if(s)for(const i of s)t.tag(i.no,i.wireType).raw(i.data)},onUnknownField(e,t,s,i){const n=e;Array.isArray(n[ad])||(n[ad]=[]),n[ad].push({no:t,wireType:s,data:i})},readMessage(e,t,s,i,n){const r=e.getType(),a=n?t.len:t.pos+s;let o,l;for(;t.pos<a&&([o,l]=t.tag(),!0!==n||l!=Nc.EndGroup);){const s=r.fields.find(o);if(!s){const s=t.skip(l,o);i.readUnknownFields&&this.onUnknownField(e,o,l,s);continue}ud(e,t,s,l,i)}if(n&&(l!=Nc.EndGroup||o!==s))throw new Error("invalid end group tag")},readField:ud,writeMessage(e,t,s){const i=e.getType();for(const n of i.fields.byNumber())if(qc(n,e))pd(n,n.oneof?e[n.oneof.localName].value:e[n.localName],t,s);else if(n.req)throw new Error("cannot encode field ".concat(i.typeName,".").concat(n.name," to binary: required field not set"));return s.writeUnknownFields&&this.writeUnknownFields(e,t),t},writeField(e,t,s,i){void 0!==t&&pd(e,t,s,i)}},util:Object.assign(Object.assign({},{setEnumType:ac,initPartial(e,t){if(void 0===e)return;const s=t.getType();for(const i of s.fields.byMember()){const s=i.localName,n=t,r=e;if(null!=r[s])switch(i.kind){case"oneof":const e=r[s].case;if(void 0===e)continue;const t=i.findField(e);let a=r[s].value;t&&"message"==t.kind&&!zc(a,t.T)?a=new t.T(a):t&&"scalar"===t.kind&&t.T===Sc.BYTES&&(a=wd(a)),n[s]={case:e,value:a};break;case"scalar":case"enum":let o=r[s];i.T===Sc.BYTES&&(o=i.repeated?o.map(wd):wd(o)),n[s]=o;break;case"map":switch(i.V.kind){case"scalar":case"enum":if(i.V.T===Sc.BYTES)for(const[t,i]of Object.entries(r[s]))n[s][t]=wd(i);else Object.assign(n[s],r[s]);break;case"message":const e=i.V.T;for(const t of Object.keys(r[s])){let i=r[s][t];e.fieldWrapper||(i=new e(i)),n[s][t]=i}}break;case"message":const l=i.T;if(i.repeated)n[s]=r[s].map(e=>zc(e,l)?e:new l(e));else{const e=r[s];l.fieldWrapper?"google.protobuf.BytesValue"===l.typeName?n[s]=wd(e):n[s]=e:n[s]=zc(e,l)?e:new l(e)}}}},equals:(e,t,s)=>t===s||!(!t||!s)&&e.fields.byMember().every(e=>{const i=t[e.localName],n=s[e.localName];if(e.repeated){if(i.length!==n.length)return!1;switch(e.kind){case"message":return i.every((t,s)=>e.T.equals(t,n[s]));case"scalar":return i.every((t,s)=>Ac(e.T,t,n[s]));case"enum":return i.every((e,t)=>Ac(Sc.INT32,e,n[t]))}throw new Error("repeated cannot contain ".concat(e.kind))}switch(e.kind){case"message":let t=i,s=n;return e.T.fieldWrapper&&(void 0===t||zc(t)||(t=e.T.fieldWrapper.wrapField(t)),void 0===s||zc(s)||(s=e.T.fieldWrapper.wrapField(s))),e.T.equals(t,s);case"enum":return Ac(Sc.INT32,i,n);case"scalar":return Ac(e.T,i,n);case"oneof":if(i.case!==n.case)return!1;const r=e.findField(i.case);if(void 0===r)return!0;switch(r.kind){case"message":return r.T.equals(i.value,n.value);case"enum":return Ac(Sc.INT32,i.value,n.value);case"scalar":return Ac(r.T,i.value,n.value)}throw new Error("oneof cannot contain ".concat(r.kind));case"map":const a=Object.keys(i).concat(Object.keys(n));switch(e.V.kind){case"message":const t=e.V.T;return a.every(e=>t.equals(i[e],n[e]));case"enum":return a.every(e=>Ac(Sc.INT32,i[e],n[e]));case"scalar":const s=e.V.T;return a.every(e=>Ac(s,i[e],n[e]))}}}),clone(e){const t=e.getType(),s=new t,i=s;for(const n of t.fields.byMember()){const t=e[n.localName];let s;if(n.repeated)s=t.map(xd);else if("map"==n.kind){s=i[n.localName];for(const[e,i]of Object.entries(t))s[e]=xd(i)}else s="oneof"==n.kind?n.findField(t.case)?{case:t.case,value:xd(t.value)}:{case:void 0}:xd(t);i[n.localName]=s}for(const n of t.runtime.bin.listUnknownFields(e))t.runtime.bin.onUnknownField(i,n.no,n.wireType,n.data);return s}}),{newFieldList:Ld,initFields:Rd}),makeMessageType(e,t,s){return function(e,t,s,i){var n;const r=null!==(n=null==i?void 0:i.localName)&&void 0!==n?n:t.substring(t.lastIndexOf(".")+1),a={[r]:function(t){e.util.initFields(this),e.util.initPartial(t,this)}}[r];return Object.setPrototypeOf(a.prototype,new dc),Object.assign(a,{runtime:e,typeName:t,fields:e.util.newFieldList(s),fromBinary:(e,t)=>(new a).fromBinary(e,t),fromJson:(e,t)=>(new a).fromJson(e,t),fromJsonString:(e,t)=>(new a).fromJsonString(e,t),equals:(t,s)=>e.util.equals(a,t,s)}),a}(this,e,t,s)},makeEnum:lc,makeEnumType:oc,getEnumType:rc,makeExtension(e,t,s){return function(e,t,s,i){let n;return{typeName:t,extendee:s,get field(){if(!n){const s="function"==typeof i?i():i;s.name=t.split(".").pop(),s.jsonName="[".concat(t,"]"),n=e.util.newFieldList([s]).list()[0]}return n},runtime:e}}(this,e,t,s)}});var Ld,Rd;class Od extends dc{constructor(e){super(),this.seconds=wc.zero,this.nanos=0,Id.util.initPartial(e,this)}fromJson(e,t){if("string"!=typeof e)throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(Id.json.debug(e)));const s=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!s)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const i=Date.parse(s[1]+"-"+s[2]+"-"+s[3]+"T"+s[4]+":"+s[5]+":"+s[6]+(s[8]?s[8]:"Z"));if(Number.isNaN(i))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(i<Date.parse("0001-01-01T00:00:00Z")||i>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=wc.parse(i/1e3),this.nanos=0,s[7]&&(this.nanos=parseInt("1"+s[7]+"0".repeat(9-s[7].length))-1e9),this}toJson(e){const t=1e3*Number(this.seconds);if(t<Date.parse("0001-01-01T00:00:00Z")||t>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let s="Z";if(this.nanos>0){const e=(this.nanos+1e9).toString().substring(1);s="000000"===e.substring(3)?"."+e.substring(0,3)+"Z":"000"===e.substring(6)?"."+e.substring(0,6)+"Z":"."+e+"Z"}return new Date(t).toISOString().replace(".000Z",s)}toDate(){return new Date(1e3*Number(this.seconds)+Math.ceil(this.nanos/1e6))}static now(){return Od.fromDate(new Date)}static fromDate(e){const t=e.getTime();return new Od({seconds:wc.parse(Math.floor(t/1e3)),nanos:t%1e3*1e6})}static fromBinary(e,t){return(new Od).fromBinary(e,t)}static fromJson(e,t){return(new Od).fromJson(e,t)}static fromJsonString(e,t){return(new Od).fromJsonString(e,t)}static equals(e,t){return Id.util.equals(Od,e,t)}}Od.runtime=Id,Od.typeName="google.protobuf.Timestamp",Od.fields=Id.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);const Dd=Id.makeMessageType("livekit.MetricsBatch",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Od},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:Md,repeated:!0},{no:5,name:"events",kind:"message",T:Fd,repeated:!0}]),Md=Id.makeMessageType("livekit.TimeSeriesMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:Ud,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}]),Ud=Id.makeMessageType("livekit.MetricSample",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Od},{no:3,name:"value",kind:"scalar",T:2}]),Fd=Id.makeMessageType("livekit.EventMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:Od},{no:7,name:"normalized_end_timestamp",kind:"message",T:Od,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]),Bd=Id.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"PREFER_REGRESSION"},{no:1,name:"SIMULCAST"},{no:2,name:"REGRESSION"}]),qd=Id.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),$d=Id.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),zd=Id.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),Hd=Id.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),Vd=Id.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),Gd=Id.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"},{no:14,name:"CONNECTION_TIMEOUT"},{no:15,name:"MEDIA_FAILURE"}]),Jd=Id.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),Wd=Id.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),Kd=Id.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"},{no:6,name:"TF_PRECONNECT_BUFFER"}]),Yd=Id.makeMessageType("livekit.Room",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:Xd,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:Au}]),Xd=Id.makeMessageType("livekit.Codec",()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]),Qd=Id.makeMessageType("livekit.ParticipantPermission",()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:Id.getEnumType($d),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]),Zd=Id.makeMessageType("livekit.ParticipantInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:Id.getEnumType(eu)},{no:4,name:"tracks",kind:"message",T:ru,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:Qd},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:Id.getEnumType(tu)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:Id.getEnumType(Gd)},{no:18,name:"kind_details",kind:"enum",T:Id.getEnumType(su),repeated:!0}]),eu=Id.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),tu=Id.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"}]),su=Id.makeEnum("livekit.ParticipantInfo.KindDetail",[{no:0,name:"CLOUD_AGENT"},{no:1,name:"FORWARDED"}]),iu=Id.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),nu=Id.makeMessageType("livekit.SimulcastCodecInfo",()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:au,repeated:!0}]),ru=Id.makeMessageType("livekit.TrackInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:Id.getEnumType(qd)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:Id.getEnumType($d)},{no:10,name:"layers",kind:"message",T:au,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:nu,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:Id.getEnumType(iu)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:Au},{no:19,name:"audio_features",kind:"enum",T:Id.getEnumType(Kd),repeated:!0},{no:20,name:"backup_codec_policy",kind:"enum",T:Id.getEnumType(Bd)}]),au=Id.makeMessageType("livekit.VideoLayer",()=>[{no:1,name:"quality",kind:"enum",T:Id.getEnumType(zd)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13},{no:6,name:"spatial_layer",kind:"scalar",T:5},{no:7,name:"rid",kind:"scalar",T:9}]),ou=Id.makeMessageType("livekit.DataPacket",()=>[{no:1,name:"kind",kind:"enum",T:Id.getEnumType(lu)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:uu,oneof:"value"},{no:3,name:"speaker",kind:"message",T:cu,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:hu,oneof:"value"},{no:7,name:"transcription",kind:"message",T:fu,oneof:"value"},{no:8,name:"metrics",kind:"message",T:Dd,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:pu,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:gu,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:vu,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:yu,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:Iu,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:Lu,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:Ru,oneof:"value"},{no:16,name:"sequence",kind:"scalar",T:13},{no:17,name:"participant_sid",kind:"scalar",T:9}]),lu=Id.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),cu=Id.makeMessageType("livekit.ActiveSpeakerUpdate",()=>[{no:1,name:"speakers",kind:"message",T:du,repeated:!0}]),du=Id.makeMessageType("livekit.SpeakerInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]),uu=Id.makeMessageType("livekit.UserPacket",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0},{no:11,name:"nonce",kind:"scalar",T:12}]),hu=Id.makeMessageType("livekit.SipDTMF",()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]),fu=Id.makeMessageType("livekit.Transcription",()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:mu,repeated:!0}]),mu=Id.makeMessageType("livekit.TranscriptionSegment",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]),pu=Id.makeMessageType("livekit.ChatMessage",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]),gu=Id.makeMessageType("livekit.RpcRequest",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]),vu=Id.makeMessageType("livekit.RpcAck",()=>[{no:1,name:"request_id",kind:"scalar",T:9}]),yu=Id.makeMessageType("livekit.RpcResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:bu,oneof:"value"}]),bu=Id.makeMessageType("livekit.RpcError",()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]),xu=Id.makeMessageType("livekit.ParticipantTracks",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]),wu=Id.makeMessageType("livekit.ServerInfo",()=>[{no:1,name:"edition",kind:"enum",T:Id.getEnumType(Su)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]),Su=Id.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),ku=Id.makeMessageType("livekit.ClientInfo",()=>[{no:1,name:"sdk",kind:"enum",T:Id.getEnumType(_u)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]),_u=Id.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"},{no:13,name:"UNREAL"},{no:14,name:"ESP32"}]),Cu=Id.makeMessageType("livekit.ClientConfiguration",()=>[{no:1,name:"video",kind:"message",T:Nu},{no:2,name:"screen",kind:"message",T:Nu},{no:3,name:"resume_connection",kind:"enum",T:Id.getEnumType(Vd)},{no:4,name:"disabled_codecs",kind:"message",T:Tu},{no:5,name:"force_relay",kind:"enum",T:Id.getEnumType(Vd)}]),Nu=Id.makeMessageType("livekit.VideoConfiguration",()=>[{no:1,name:"hardware_encoder",kind:"enum",T:Id.getEnumType(Vd)}]),Tu=Id.makeMessageType("livekit.DisabledCodecs",()=>[{no:1,name:"codecs",kind:"message",T:Xd,repeated:!0},{no:2,name:"publish",kind:"message",T:Xd,repeated:!0}]),Au=Id.makeMessageType("livekit.TimedVersion",()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]),Eu=Id.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]),ju=Id.makeMessageType("livekit.DataStream.TextHeader",()=>[{no:1,name:"operation_type",kind:"enum",T:Id.getEnumType(Eu)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:!0},{no:5,name:"generated",kind:"scalar",T:8}],{localName:"DataStream_TextHeader"}),Pu=Id.makeMessageType("livekit.DataStream.ByteHeader",()=>[{no:1,name:"name",kind:"scalar",T:9}],{localName:"DataStream_ByteHeader"}),Iu=Id.makeMessageType("livekit.DataStream.Header",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:!0},{no:7,name:"encryption_type",kind:"enum",T:Id.getEnumType(iu)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:ju,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:Pu,oneof:"content_header"}],{localName:"DataStream_Header"}),Lu=Id.makeMessageType("livekit.DataStream.Chunk",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:!0}],{localName:"DataStream_Chunk"}),Ru=Id.makeMessageType("livekit.DataStream.Trailer",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}],{localName:"DataStream_Trailer"}),Ou=Id.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),Du=Id.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),Mu=Id.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),Uu=Id.makeMessageType("livekit.SignalRequest",()=>[{no:1,name:"offer",kind:"message",T:Wu,oneof:"message"},{no:2,name:"answer",kind:"message",T:Wu,oneof:"message"},{no:3,name:"trickle",kind:"message",T:$u,oneof:"message"},{no:4,name:"add_track",kind:"message",T:qu,oneof:"message"},{no:5,name:"mute",kind:"message",T:zu,oneof:"message"},{no:6,name:"subscription",kind:"message",T:Yu,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:Xu,oneof:"message"},{no:8,name:"leave",kind:"message",T:eh,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:sh,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:ph,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:yh,oneof:"message"},{no:13,name:"simulate",kind:"message",T:wh,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:ih,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:Sh,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:Qu,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:Zu,oneof:"message"}]),Fu=Id.makeMessageType("livekit.SignalResponse",()=>[{no:1,name:"join",kind:"message",T:Hu,oneof:"message"},{no:2,name:"answer",kind:"message",T:Wu,oneof:"message"},{no:3,name:"offer",kind:"message",T:Wu,oneof:"message"},{no:4,name:"trickle",kind:"message",T:$u,oneof:"message"},{no:5,name:"update",kind:"message",T:Ku,oneof:"message"},{no:6,name:"track_published",kind:"message",T:Gu,oneof:"message"},{no:8,name:"leave",kind:"message",T:eh,oneof:"message"},{no:9,name:"mute",kind:"message",T:zu,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:rh,oneof:"message"},{no:11,name:"room_update",kind:"message",T:ah,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:lh,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:dh,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:fh,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:gh,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:Ju,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:Vu,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:kh,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:Nh,oneof:"message"},{no:22,name:"request_response",kind:"message",T:Th,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:Eh,oneof:"message"},{no:24,name:"room_moved",kind:"message",T:vh,oneof:"message"}]),Bu=Id.makeMessageType("livekit.SimulcastCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9}]),qu=Id.makeMessageType("livekit.AddTrackRequest",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:Id.getEnumType(qd)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:Id.getEnumType($d)},{no:9,name:"layers",kind:"message",T:au,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:Bu,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:Id.getEnumType(iu)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:Id.getEnumType(Bd)},{no:17,name:"audio_features",kind:"enum",T:Id.getEnumType(Kd),repeated:!0}]),$u=Id.makeMessageType("livekit.TrickleRequest",()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:Id.getEnumType(Ou)},{no:3,name:"final",kind:"scalar",T:8}]),zu=Id.makeMessageType("livekit.MuteTrackRequest",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]),Hu=Id.makeMessageType("livekit.JoinResponse",()=>[{no:1,name:"room",kind:"message",T:Yd},{no:2,name:"participant",kind:"message",T:Zd},{no:3,name:"other_participants",kind:"message",T:Zd,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:nh,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:Cu},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:wu},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:Xd,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}]),Vu=Id.makeMessageType("livekit.ReconnectResponse",()=>[{no:1,name:"ice_servers",kind:"message",T:nh,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:Cu},{no:3,name:"server_info",kind:"message",T:wu},{no:4,name:"last_message_seq",kind:"scalar",T:13}]),Gu=Id.makeMessageType("livekit.TrackPublishedResponse",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:ru}]),Ju=Id.makeMessageType("livekit.TrackUnpublishedResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),Wu=Id.makeMessageType("livekit.SessionDescription",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9},{no:3,name:"id",kind:"scalar",T:13}]),Ku=Id.makeMessageType("livekit.ParticipantUpdate",()=>[{no:1,name:"participants",kind:"message",T:Zd,repeated:!0}]),Yu=Id.makeMessageType("livekit.UpdateSubscription",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:xu,repeated:!0}]),Xu=Id.makeMessageType("livekit.UpdateTrackSettings",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:Id.getEnumType(zd)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]),Qu=Id.makeMessageType("livekit.UpdateLocalAudioTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:Id.getEnumType(Kd),repeated:!0}]),Zu=Id.makeMessageType("livekit.UpdateLocalVideoTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]),eh=Id.makeMessageType("livekit.LeaveRequest",()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:Id.getEnumType(Gd)},{no:3,name:"action",kind:"enum",T:Id.getEnumType(th)},{no:4,name:"regions",kind:"message",T:_h}]),th=Id.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),sh=Id.makeMessageType("livekit.UpdateVideoLayers",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:au,repeated:!0}]),ih=Id.makeMessageType("livekit.UpdateParticipantMetadata",()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]),nh=Id.makeMessageType("livekit.ICEServer",()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]),rh=Id.makeMessageType("livekit.SpeakersChanged",()=>[{no:1,name:"speakers",kind:"message",T:du,repeated:!0}]),ah=Id.makeMessageType("livekit.RoomUpdate",()=>[{no:1,name:"room",kind:"message",T:Yd}]),oh=Id.makeMessageType("livekit.ConnectionQualityInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:Id.getEnumType(Hd)},{no:3,name:"score",kind:"scalar",T:2}]),lh=Id.makeMessageType("livekit.ConnectionQualityUpdate",()=>[{no:1,name:"updates",kind:"message",T:oh,repeated:!0}]),ch=Id.makeMessageType("livekit.StreamStateInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:Id.getEnumType(Du)}]),dh=Id.makeMessageType("livekit.StreamStateUpdate",()=>[{no:1,name:"stream_states",kind:"message",T:ch,repeated:!0}]),uh=Id.makeMessageType("livekit.SubscribedQuality",()=>[{no:1,name:"quality",kind:"enum",T:Id.getEnumType(zd)},{no:2,name:"enabled",kind:"scalar",T:8}]),hh=Id.makeMessageType("livekit.SubscribedCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:uh,repeated:!0}]),fh=Id.makeMessageType("livekit.SubscribedQualityUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:uh,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:hh,repeated:!0}]),mh=Id.makeMessageType("livekit.TrackPermission",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]),ph=Id.makeMessageType("livekit.SubscriptionPermission",()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:mh,repeated:!0}]),gh=Id.makeMessageType("livekit.SubscriptionPermissionUpdate",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]),vh=Id.makeMessageType("livekit.RoomMovedResponse",()=>[{no:1,name:"room",kind:"message",T:Yd},{no:2,name:"token",kind:"scalar",T:9},{no:3,name:"participant",kind:"message",T:Zd},{no:4,name:"other_participants",kind:"message",T:Zd,repeated:!0}]),yh=Id.makeMessageType("livekit.SyncState",()=>[{no:1,name:"answer",kind:"message",T:Wu},{no:2,name:"subscription",kind:"message",T:Yu},{no:3,name:"publish_tracks",kind:"message",T:Gu,repeated:!0},{no:4,name:"data_channels",kind:"message",T:xh,repeated:!0},{no:5,name:"offer",kind:"message",T:Wu},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0},{no:7,name:"datachannel_receive_states",kind:"message",T:bh,repeated:!0}]),bh=Id.makeMessageType("livekit.DataChannelReceiveState",()=>[{no:1,name:"publisher_sid",kind:"scalar",T:9},{no:2,name:"last_seq",kind:"scalar",T:13}]),xh=Id.makeMessageType("livekit.DataChannelInfo",()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:Id.getEnumType(Ou)}]),wh=Id.makeMessageType("livekit.SimulateScenario",()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:Id.getEnumType(Mu),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]),Sh=Id.makeMessageType("livekit.Ping",()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]),kh=Id.makeMessageType("livekit.Pong",()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]),_h=Id.makeMessageType("livekit.RegionSettings",()=>[{no:1,name:"regions",kind:"message",T:Ch,repeated:!0}]),Ch=Id.makeMessageType("livekit.RegionInfo",()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]),Nh=Id.makeMessageType("livekit.SubscriptionResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:Id.getEnumType(Wd)}]),Th=Id.makeMessageType("livekit.RequestResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:Id.getEnumType(Ah)},{no:3,name:"message",kind:"scalar",T:9}]),Ah=Id.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"}]),Eh=Id.makeMessageType("livekit.TrackSubscribed",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]);function jh(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Ph,Ih={exports:{}};var Lh,Rh,Oh,Dh,Mh,Uh,Fh,Bh=(Ph||(Ph=1,Rh=Ih.exports,Oh=function(){var e=function(){},t="undefined",s=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"],n={},r=null;function a(e,t){var s=e[t];if("function"==typeof s.bind)return s.bind(e);try{return Function.prototype.bind.call(s,e)}catch(Tx){return function(){return Function.prototype.apply.apply(s,[e,arguments])}}}function o(){console.log&&(console.log.apply||Function.prototype.apply.apply(console.log,[console,arguments])),console.trace}function l(){for(var s=this.getLevel(),n=0;n<i.length;n++){var r=i[n];this[r]=n<s?e:this.methodFactory(r,s,this.name)}if(this.log=this.debug,typeof console===t&&s<this.levels.SILENT)return"No console available for logging"}function c(e){return function(){typeof console!==t&&(l.call(this),this[e].apply(this,arguments))}}function d(i,n,r){return function(i){return"debug"===i&&(i="log"),typeof console!==t&&("trace"===i&&s?o:void 0!==console[i]?a(console,i):void 0!==console.log?a(console,"log"):e)}(i)||c.apply(this,arguments)}function u(e,s){var a,o,c,u=this,h="loglevel";function f(){var e;if(typeof window!==t&&h){try{e=window.localStorage[h]}catch(r){}if(typeof e===t)try{var s=window.document.cookie,i=encodeURIComponent(h),n=s.indexOf(i+"=");-1!==n&&(e=/^([^;]+)/.exec(s.slice(n+i.length+1))[1])}catch(r){}return void 0===u.levels[e]&&(e=void 0),e}}function m(e){var t=e;if("string"==typeof t&&void 0!==u.levels[t.toUpperCase()]&&(t=u.levels[t.toUpperCase()]),"number"==typeof t&&t>=0&&t<=u.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"==typeof e?h+=":"+e:"symbol"==typeof e&&(h=void 0),u.name=e,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=s||d,u.getLevel=function(){return null!=c?c:null!=o?o:a},u.setLevel=function(e,s){return c=m(e),!1!==s&&function(e){var s=(i[e]||"silent").toUpperCase();if(typeof window!==t&&h){try{return void(window.localStorage[h]=s)}catch(n){}try{window.document.cookie=encodeURIComponent(h)+"="+s+";"}catch(n){}}}(c),l.call(u)},u.setDefaultLevel=function(e){o=m(e),f()||u.setLevel(e,!1)},u.resetLevel=function(){c=null,function(){if(typeof window!==t&&h){try{window.localStorage.removeItem(h)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}(),l.call(u)},u.enableAll=function(e){u.setLevel(u.levels.TRACE,e)},u.disableAll=function(e){u.setLevel(u.levels.SILENT,e)},u.rebuild=function(){if(r!==u&&(a=m(r.getLevel())),l.call(u),r===u)for(var e in n)n[e].rebuild()},a=m(r?r.getLevel():"WARN");var p=f();null!=p&&(c=m(p)),l.call(u)}(r=new u).getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=n[e];return t||(t=n[e]=new u(e,r.methodFactory)),t};var h=typeof window!==t?window.log:void 0;return r.noConflict=function(){return typeof window!==t&&window.log===r&&(window.log=h),r},r.getLoggers=function(){return n},r.default=r,r},(Lh=Ih).exports?Lh.exports=Oh():Rh.log=Oh()),Ih.exports);(Mh=Dh||(Dh={}))[Mh.trace=0]="trace",Mh[Mh.debug=1]="debug",Mh[Mh.info=2]="info",Mh[Mh.warn=3]="warn",Mh[Mh.error=4]="error",Mh[Mh.silent=5]="silent",(Fh=Uh||(Uh={})).Default="livekit",Fh.Room="livekit-room",Fh.Participant="livekit-participant",Fh.Track="livekit-track",Fh.Publication="livekit-track-publication",Fh.Engine="livekit-engine",Fh.Signal="livekit-signal",Fh.PCManager="livekit-pc-manager",Fh.PCTransport="livekit-pc-transport",Fh.E2EE="lk-e2ee";let qh=Bh.getLogger("livekit");function $h(e){const t=Bh.getLogger(e);return t.setDefaultLevel(qh.getLevel()),t}Object.values(Uh).map(e=>Bh.getLogger(e)),qh.setDefaultLevel(Dh.info);const zh=Bh.getLogger("lk-e2ee"),Hh=7e3,Vh=[0,300,1200,2700,4800,Hh,Hh,Hh,Hh,Hh];function Gh(e,t,s,i){return new(s||(s=Promise))(function(n,r){function a(e){try{l(i.next(e))}catch(Tx){r(Tx)}}function o(e){try{l(i.throw(e))}catch(Tx){r(Tx)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof s?t:new s(function(e){e(t)})).then(a,o)}l((i=i.apply(e,t||[])).next())})}function Jh(e){var t="function"==typeof Symbol&&Symbol.iterator,s=t&&e[t],i=0;if(s)return s.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&i>=e.length&&(e=void 0),{value:e&&e[i++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function Wh(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,s=e[Symbol.asyncIterator];return s?s.call(e):(e=Jh(e),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(s){t[s]=e[s]&&function(t){return new Promise(function(i,n){(function(e,t,s,i){Promise.resolve(i).then(function(t){e({value:t,done:s})},t)})(i,n,(t=e[s](t)).done,t.value)})}}}"function"==typeof SuppressedError&&SuppressedError;var Kh,Yh={exports:{}};var Xh=function(){if(Kh)return Yh.exports;Kh=1;var e,t="object"==typeof Reflect?Reflect:null,s=t&&"function"==typeof t.apply?t.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)};e=t&&"function"==typeof t.ownKeys?t.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function n(){n.init.call(this)}Yh.exports=n,Yh.exports.once=function(e,t){return new Promise(function(s,i){function n(s){e.removeListener(t,r),i(s)}function r(){"function"==typeof e.removeListener&&e.removeListener("error",n),s([].slice.call(arguments))}m(e,t,r,{once:!0}),"error"!==t&&function(e,t,s){"function"==typeof e.on&&m(e,"error",t,s)}(e,n,{once:!0})})},n.EventEmitter=n,n.prototype._events=void 0,n.prototype._eventsCount=0,n.prototype._maxListeners=void 0;var r=10;function a(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function o(e){return void 0===e._maxListeners?n.defaultMaxListeners:e._maxListeners}function l(e,t,s,i){var n,r,l;if(a(s),void 0===(r=e._events)?(r=e._events=Object.create(null),e._eventsCount=0):(void 0!==r.newListener&&(e.emit("newListener",t,s.listener?s.listener:s),r=e._events),l=r[t]),void 0===l)l=r[t]=s,++e._eventsCount;else if("function"==typeof l?l=r[t]=i?[s,l]:[l,s]:i?l.unshift(s):l.push(s),(n=o(e))>0&&l.length>n&&!l.warned){l.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+l.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=l.length,console&&console.warn}return e}function c(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function d(e,t,s){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:s},n=c.bind(i);return n.listener=s,i.wrapFn=n,n}function u(e,t,s){var i=e._events;if(void 0===i)return[];var n=i[t];return void 0===n?[]:"function"==typeof n?s?[n.listener||n]:[n]:s?function(e){for(var t=new Array(e.length),s=0;s<t.length;++s)t[s]=e[s].listener||e[s];return t}(n):f(n,n.length)}function h(e){var t=this._events;if(void 0!==t){var s=t[e];if("function"==typeof s)return 1;if(void 0!==s)return s.length}return 0}function f(e,t){for(var s=new Array(t),i=0;i<t;++i)s[i]=e[i];return s}function m(e,t,s,i){if("function"==typeof e.on)i.once?e.once(t,s):e.on(t,s);else{if("function"!=typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,function n(r){i.once&&e.removeEventListener(t,n),s(r)})}}return Object.defineProperty(n,"defaultMaxListeners",{enumerable:!0,get:function(){return r},set:function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");r=e}}),n.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},n.prototype.getMaxListeners=function(){return o(this)},n.prototype.emit=function(e){for(var t=[],i=1;i<arguments.length;i++)t.push(arguments[i]);var n="error"===e,r=this._events;if(void 0!==r)n=n&&void 0===r.error;else if(!n)return!1;if(n){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var l=r[e];if(void 0===l)return!1;if("function"==typeof l)s(l,this,t);else{var c=l.length,d=f(l,c);for(i=0;i<c;++i)s(d[i],this,t)}return!0},n.prototype.addListener=function(e,t){return l(this,e,t,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(e,t){return l(this,e,t,!0)},n.prototype.once=function(e,t){return a(t),this.on(e,d(this,e,t)),this},n.prototype.prependOnceListener=function(e,t){return a(t),this.prependListener(e,d(this,e,t)),this},n.prototype.removeListener=function(e,t){var s,i,n,r,o;if(a(t),void 0===(i=this._events))return this;if(void 0===(s=i[e]))return this;if(s===t||s.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,s.listener||t));else if("function"!=typeof s){for(n=-1,r=s.length-1;r>=0;r--)if(s[r]===t||s[r].listener===t){o=s[r].listener,n=r;break}if(n<0)return this;0===n?s.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(s,n),1===s.length&&(i[e]=s[0]),void 0!==i.removeListener&&this.emit("removeListener",e,o||t)}return this},n.prototype.off=n.prototype.removeListener,n.prototype.removeAllListeners=function(e){var t,s,i;if(void 0===(s=this._events))return this;if(void 0===s.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==s[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete s[e]),this;if(0===arguments.length){var n,r=Object.keys(s);for(i=0;i<r.length;++i)"removeListener"!==(n=r[i])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=s[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},n.prototype.listeners=function(e){return u(this,e,!0)},n.prototype.rawListeners=function(e){return u(this,e,!1)},n.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):h.call(e,t)},n.prototype.listenerCount=h,n.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]},Yh.exports}();let Qh=!0,Zh=!0;function ef(e,t,s){const i=e.match(t);return i&&i.length>=s&&parseFloat(i[s],10)}function tf(e,t,s){if(!e.RTCPeerConnection)return;const i=e.RTCPeerConnection.prototype,n=i.addEventListener;i.addEventListener=function(e,i){if(e!==t)return n.apply(this,arguments);const r=e=>{const t=s(e);t&&(i.handleEvent?i.handleEvent(t):i(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(i,r),n.apply(this,[e,r])};const r=i.removeEventListener;i.removeEventListener=function(e,s){if(e!==t||!this._eventMap||!this._eventMap[t])return r.apply(this,arguments);if(!this._eventMap[t].has(s))return r.apply(this,arguments);const i=this._eventMap[t].get(s);return this._eventMap[t].delete(s),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,r.apply(this,[e,i])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function sf(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(Qh=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function nf(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(Zh=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function rf(){if("object"==typeof window){if(Qh)return;"undefined"!=typeof console&&console.log}}function af(e,t){}function of(e){return"[object Object]"===Object.prototype.toString.call(e)}function lf(e){return of(e)?Object.keys(e).reduce(function(t,s){const i=of(e[s]),n=i?lf(e[s]):e[s],r=i&&!Object.keys(n).length;return void 0===n||r?t:Object.assign(t,{[s]:n})},{}):e}function cf(e,t,s){t&&!s.has(t.id)&&(s.set(t.id,t),Object.keys(t).forEach(i=>{i.endsWith("Id")?cf(e,e.get(t[i]),s):i.endsWith("Ids")&&t[i].forEach(t=>{cf(e,e.get(t),s)})}))}function df(e,t,s){const i=s?"outbound-rtp":"inbound-rtp",n=new Map;if(null===t)return n;const r=[];return e.forEach(e=>{"track"===e.type&&e.trackIdentifier===t.id&&r.push(e)}),r.forEach(t=>{e.forEach(s=>{s.type===i&&s.trackId===t.id&&cf(e,s,n)})}),n}const uf=rf;function hf(e,t){const s=e&&e.navigator;if(!s.mediaDevices)return;const i=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach(s=>{if("require"===s||"advanced"===s||"mediaSource"===s)return;const i="object"==typeof e[s]?e[s]:{ideal:e[s]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);const n=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];let e={};"number"==typeof i.ideal?(e[n("min",s)]=i.ideal,t.optional.push(e),e={},e[n("max",s)]=i.ideal,t.optional.push(e)):(e[n("",s)]=i.ideal,t.optional.push(e))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[n("",s)]=i.exact):["min","max"].forEach(e=>{void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[n(e,s)]=i[e])})}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},n=function(e,n){if(t.version>=61)return n(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,s){t in e&&!(s in e)&&(e[s]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=i(e.audio)}if(e&&"object"==typeof e.video){let r=e.video.facingMode;r=r&&("object"==typeof r?r:{ideal:r});const a=t.version<66;if(r&&("user"===r.exact||"environment"===r.exact||"user"===r.ideal||"environment"===r.ideal)&&(!s.mediaDevices.getSupportedConstraints||!s.mediaDevices.getSupportedConstraints().facingMode||a)){let t;if(delete e.video.facingMode,"environment"===r.exact||"environment"===r.ideal?t=["back","rear"]:"user"!==r.exact&&"user"!==r.ideal||(t=["front"]),t)return s.mediaDevices.enumerateDevices().then(s=>{let a=(s=s.filter(e=>"videoinput"===e.kind)).find(e=>t.some(t=>e.label.toLowerCase().includes(t)));return!a&&s.length&&t.includes("back")&&(a=s[s.length-1]),a&&(e.video.deviceId=r.exact?{exact:a.deviceId}:{ideal:a.deviceId}),e.video=i(e.video),uf("chrome: "+JSON.stringify(e)),n(e)})}e.video=i(e.video)}return uf("chrome: "+JSON.stringify(e)),n(e)},r=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(s.getUserMedia=function(e,t,i){n(e,e=>{s.webkitGetUserMedia(e,t,e=>{i&&i(r(e))})})}.bind(s),s.mediaDevices.getUserMedia){const e=s.mediaDevices.getUserMedia.bind(s.mediaDevices);s.mediaDevices.getUserMedia=function(t){return n(t,t=>e(t).then(e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(e=>{e.stop()}),new DOMException("","NotFoundError");return e},e=>Promise.reject(r(e))))}}}function ff(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function mf(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",s=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===s.track.id):{track:s.track};const n=new Event("track");n.track=s.track,n.receiver=i,n.transceiver={receiver:i},n.streams=[t.stream],this.dispatchEvent(n)}),t.stream.getTracks().forEach(s=>{let i;i=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===s.id):{track:s};const n=new Event("track");n.track=s,n.receiver=i,n.transceiver={receiver:i},n.streams=[t.stream],this.dispatchEvent(n)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else tf(e,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function pf(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const s=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){let n=s.apply(this,arguments);return n||(n=t(this,e),this._senders.push(n)),n};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){i.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const s=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],s.apply(this,[e]),e.getTracks().forEach(e=>{this._senders.push(t(this,e))})};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach(e=>{const t=this._senders.find(t=>t.track===e);t&&this._senders.splice(this._senders.indexOf(t),1)})}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function gf(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const s=e.RTCPeerConnection.prototype.addTrack;s&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=s.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>df(t,e.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),tf(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>df(t,e.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,s,i;return this.getSenders().forEach(s=>{s.track===e&&(t?i=!0:t=s)}),this.getReceivers().forEach(t=>(t.track===e&&(s?i=!0:s=t),t.track===e)),i||t&&s?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():s?s.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function vf(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(e=>this._shimmedLocalStreams[e][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,s){if(!s)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const i=t.apply(this,arguments);return this._shimmedLocalStreams[s.id]?-1===this._shimmedLocalStreams[s.id].indexOf(i)&&this._shimmedLocalStreams[s.id].push(i):this._shimmedLocalStreams[s.id]=[s,i],i};const s=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")});const t=this.getSenders();s.apply(this,arguments);const i=this.getSenders().filter(e=>-1===t.indexOf(e));this._shimmedLocalStreams[e.id]=[e].concat(i)};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],i.apply(this,arguments)};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(t=>{const s=this._shimmedLocalStreams[t].indexOf(e);-1!==s&&this._shimmedLocalStreams[t].splice(s,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]}),n.apply(this,arguments)}}function yf(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return vf(e);const s=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=s.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map(e=>this._reverseStreams[e.id])};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[t.id]){const s=new e.MediaStream(t.getTracks());this._streams[t.id]=s,this._reverseStreams[s.id]=t,t=s}i.apply(this,[t])};const n=e.RTCPeerConnection.prototype.removeStream;function r(e,t){let s=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const i=e._reverseStreams[t],n=e._streams[i.id];s=s.replace(new RegExp(n.id,"g"),i.id)}),new RTCSessionDescription({type:t.type,sdp:s})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,s){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find(e=>e===t))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(e=>e.track===t))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const n=this._streams[s.id];if(n)n.addTrack(t),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const i=new e.MediaStream([t]);this._streams[s.id]=i,this._reverseStreams[i.id]=s,this.addStream(i)}return this.getSenders().find(e=>e.track===t)},["createOffer","createAnswer"].forEach(function(t){const s=e.RTCPeerConnection.prototype[t],i={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?s.apply(this,[t=>{const s=r(this,t);e[0].apply(null,[s])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):s.apply(this,arguments).then(e=>r(this,e))}};e.RTCPeerConnection.prototype[t]=i[t]});const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let s=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const i=e._reverseStreams[t],n=e._streams[i.id];s=s.replace(new RegExp(i.id,"g"),n.id)}),new RTCSessionDescription({type:t.type,sdp:s})}(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const o=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=o.get.apply(this);return""===e.type?e:r(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach(s=>{this._streams[s].getTracks().find(t=>e.track===t)&&(t=this._streams[s])}),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function bf(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const s=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]})}function xf(e,t){tf(e,"negotiationneeded",e=>{const s=e.target;if(!(t.version<72||s.getConfiguration&&"plan-b"===s.getConfiguration().sdpSemantics)||"stable"===s.signalingState)return e})}var wf=Object.freeze({__proto__:null,fixNegotiationNeeded:xf,shimAddTrackRemoveTrack:yf,shimAddTrackRemoveTrackWithNative:vf,shimGetSendersWithDtmf:pf,shimGetUserMedia:hf,shimMediaStream:ff,shimOnTrack:mf,shimPeerConnection:bf,shimSenderReceiverGetStats:gf});function Sf(e,t){const s=e&&e.navigator,i=e&&e.MediaStreamTrack;if(s.getUserMedia=function(e,t,i){s.mediaDevices.getUserMedia(e).then(t,i)},!(t.version>55&&"autoGainControl"in s.mediaDevices.getSupportedConstraints())){const e=function(e,t,s){t in e&&!(s in e)&&(e[s]=e[t],delete e[t])},t=s.mediaDevices.getUserMedia.bind(s.mediaDevices);if(s.mediaDevices.getUserMedia=function(s){return"object"==typeof s&&"object"==typeof s.audio&&(s=JSON.parse(JSON.stringify(s)),e(s.audio,"autoGainControl","mozAutoGainControl"),e(s.audio,"noiseSuppression","mozNoiseSuppression")),t(s)},i&&i.prototype.getSettings){const t=i.prototype.getSettings;i.prototype.getSettings=function(){const s=t.apply(this,arguments);return e(s,"mozAutoGainControl","autoGainControl"),e(s,"mozNoiseSuppression","noiseSuppression"),s}}if(i&&i.prototype.applyConstraints){const t=i.prototype.applyConstraints;i.prototype.applyConstraints=function(s){return"audio"===this.kind&&"object"==typeof s&&(s=JSON.parse(JSON.stringify(s)),e(s,"autoGainControl","mozAutoGainControl"),e(s,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[s])}}}}function kf(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function _f(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const s=e.RTCPeerConnection.prototype[t],i={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=i[t]});const s={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,n,r]=arguments;return i.apply(this,[e||null]).then(e=>{if(t.version<53&&!n)try{e.forEach(e=>{e.type=s[e.type]||e.type})}catch(Tx){if("TypeError"!==Tx.name)throw Tx;e.forEach((t,i)=>{e.set(i,Object.assign({},t,{type:s[t.type]||t.type}))})}return e}).then(n,r)}}function Cf(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const s=e.RTCPeerConnection.prototype.addTrack;s&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=s.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Nf(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),tf(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Tf(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){this.getSenders().forEach(t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)})})}function Af(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function Ef(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let e=arguments[1]&&arguments[1].sendEncodings;void 0===e&&(e=[]),e=[...e];const s=e.length>0;s&&e.forEach(e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const i=t.apply(this,arguments);if(s){const{sender:t}=i,s=t.getParameters();(!("encodings"in s)||1===s.encodings.length&&0===Object.keys(s.encodings[0]).length)&&(s.encodings=e,t.sendEncodings=e,this.setParametersPromises.push(t.setParameters(s).then(()=>{delete t.sendEncodings}).catch(()=>{delete t.sendEncodings})))}return i})}function jf(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function Pf(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function If(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}var Lf=Object.freeze({__proto__:null,shimAddTransceiver:Ef,shimCreateAnswer:If,shimCreateOffer:Pf,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(s){if(!s||!s.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===s.video?s.video={mediaSource:t}:s.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(s)})},shimGetParameters:jf,shimGetUserMedia:Sf,shimOnTrack:kf,shimPeerConnection:_f,shimRTCDataChannel:Af,shimReceiverGetStats:Nf,shimRemoveStream:Tf,shimSenderGetStats:Cf});function Rf(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(s=>t.call(this,s,e)),e.getVideoTracks().forEach(s=>t.call(this,s,e))},e.RTCPeerConnection.prototype.addTrack=function(e){for(var s=arguments.length,i=new Array(s>1?s-1:0),n=1;n<s;n++)i[n-1]=arguments[n];return i&&i.forEach(e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]}),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const s=e.getTracks();this.getSenders().forEach(e=>{s.includes(e.track)&&this.removeTrack(e)})})}}function Of(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach(e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)})})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const s=new Event("addstream");s.stream=t,e.dispatchEvent(s)})}),t.apply(e,arguments)}}}function Df(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,s=t.createOffer,i=t.createAnswer,n=t.setLocalDescription,r=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],n=s.apply(this,[i]);return t?(n.then(e,t),Promise.resolve()):n},t.createAnswer=function(e,t){const s=arguments.length>=2?arguments[2]:arguments[0],n=i.apply(this,[s]);return t?(n.then(e,t),Promise.resolve()):n};let o=function(e,t,s){const i=n.apply(this,[e]);return s?(i.then(t,s),Promise.resolve()):i};t.setLocalDescription=o,o=function(e,t,s){const i=r.apply(this,[e]);return s?(i.then(t,s),Promise.resolve()):i},t.setRemoteDescription=o,o=function(e,t,s){const i=a.apply(this,[e]);return s?(i.then(t,s),Promise.resolve()):i},t.addIceCandidate=o}function Mf(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,s=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>s(Uf(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,s,i){t.mediaDevices.getUserMedia(e).then(s,i)}.bind(t))}function Uf(e){return e&&void 0!==e.video?Object.assign({},e,{video:lf(e.video)}):e}function Ff(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,s){if(e&&e.iceServers){const t=[];for(let s=0;s<e.iceServers.length;s++){let i=e.iceServers[s];void 0===i.urls&&i.url?(af(),i=JSON.parse(JSON.stringify(i)),i.urls=i.url,delete i.url,t.push(i)):t.push(e.iceServers[s])}e.iceServers=t}return new t(e,s)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function Bf(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function qf(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find(e=>"audio"===e.receiver.track.kind);!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio",{direction:"recvonly"}),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const s=this.getTransceivers().find(e=>"video"===e.receiver.track.kind);!1===e.offerToReceiveVideo&&s?"sendrecv"===s.direction?s.setDirection?s.setDirection("sendonly"):s.direction="sendonly":"recvonly"===s.direction&&(s.setDirection?s.setDirection("inactive"):s.direction="inactive"):!0!==e.offerToReceiveVideo||s||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function $f(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var zf,Hf=Object.freeze({__proto__:null,shimAudioContext:$f,shimCallbacksAPI:Df,shimConstraints:Uf,shimCreateOfferLegacy:qf,shimGetUserMedia:Mf,shimLocalStreamsAPI:Rf,shimRTCIceServerUrls:Ff,shimRemoteStreamsAPI:Of,shimTrackEventTransceiver:Bf}),Vf={exports:{}};var Gf=(zf||(zf=1,function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map(e=>e.trim())},t.splitSections=function(e){return e.split("\nm=").map((e,t)=>(t>0?"m="+e:e).trim()+"\r\n")},t.getDescription=function(e){const s=t.splitSections(e);return s&&s[0]},t.getMediaSections=function(e){const s=t.splitSections(e);return s.shift(),s},t.matchPrefix=function(e,s){return t.splitLines(e).filter(e=>0===e.indexOf(s))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const s={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let i=8;i<t.length;i+=2)switch(t[i]){case"raddr":s.relatedAddress=t[i+1];break;case"rport":s.relatedPort=parseInt(t[i+1],10);break;case"tcptype":s.tcpType=t[i+1];break;case"ufrag":s.ufrag=t[i+1],s.usernameFragment=t[i+1];break;default:void 0===s[t[i]]&&(s[t[i]]=t[i+1])}return s},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const s=e.component;"rtp"===s?t.push(1):"rtcp"===s?t.push(2):t.push(s),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substring(14).split(" ")},t.parseRtpMap=function(e){let t=e.substring(9).split(" ");const s={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),s.name=t[0],s.clockRate=parseInt(t[1],10),s.channels=3===t.length?parseInt(t[2],10):1,s.numChannels=s.channels,s},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const s=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==s?"/"+s:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substring(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1],attributes:t.slice(2).join(" ")}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+(e.attributes?" "+e.attributes:"")+"\r\n"},t.parseFmtp=function(e){const t={};let s;const i=e.substring(e.indexOf(" ")+1).split(";");for(let n=0;n<i.length;n++)s=i[n].trim().split("="),t[s[0].trim()]=s[1];return t},t.writeFmtp=function(e){let t="",s=e.payloadType;if(void 0!==e.preferredPayloadType&&(s=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const i=[];Object.keys(e.parameters).forEach(t=>{void 0!==e.parameters[t]?i.push(t+"="+e.parameters[t]):i.push(t)}),t+="a=fmtp:"+s+" "+i.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substring(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",s=e.payloadType;return void 0!==e.preferredPayloadType&&(s=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(e=>{t+="a=rtcp-fb:"+s+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),s={ssrc:parseInt(e.substring(7,t),10)},i=e.indexOf(":",t);return i>-1?(s.attribute=e.substring(t+1,i),s.value=e.substring(i+1)):s.attribute=e.substring(t+1),s},t.parseSsrcGroup=function(e){const t=e.substring(13).split(" ");return{semantics:t.shift(),ssrcs:t.map(e=>parseInt(e,10))}},t.getMid=function(e){const s=t.matchPrefix(e,"a=mid:")[0];if(s)return s.substring(6)},t.parseFingerprint=function(e){const t=e.substring(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,s){return{role:"auto",fingerprints:t.matchPrefix(e+s,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let s="a=setup:"+t+"\r\n";return e.fingerprints.forEach(e=>{s+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),s},t.parseCryptoLine=function(e){const t=e.substring(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substring(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,s){return t.matchPrefix(e+s,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,s){const i=t.matchPrefix(e+s,"a=ice-ufrag:")[0],n=t.matchPrefix(e+s,"a=ice-pwd:")[0];return i&&n?{usernameFragment:i.substring(12),password:n.substring(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const s={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},i=t.splitLines(e)[0].split(" ");s.profile=i[2];for(let r=3;r<i.length;r++){const n=i[r],a=t.matchPrefix(e,"a=rtpmap:"+n+" ")[0];if(a){const i=t.parseRtpMap(a),r=t.matchPrefix(e,"a=fmtp:"+n+" ");switch(i.parameters=r.length?t.parseFmtp(r[0]):{},i.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+n+" ").map(t.parseRtcpFb),s.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":s.fecMechanisms.push(i.name.toUpperCase())}}}t.matchPrefix(e,"a=extmap:").forEach(e=>{s.headerExtensions.push(t.parseExtmap(e))});const n=t.matchPrefix(e,"a=rtcp-fb:* ").map(t.parseRtcpFb);return s.codecs.forEach(e=>{n.forEach(t=>{e.rtcpFeedback.find(e=>e.type===t.type&&e.parameter===t.parameter)||e.rtcpFeedback.push(t)})}),s},t.writeRtpDescription=function(e,s){let i="";i+="m="+e+" ",i+=s.codecs.length>0?"9":"0",i+=" "+(s.profile||"UDP/TLS/RTP/SAVPF")+" ",i+=s.codecs.map(e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType).join(" ")+"\r\n",i+="c=IN IP4 0.0.0.0\r\n",i+="a=rtcp:9 IN IP4 0.0.0.0\r\n",s.codecs.forEach(e=>{i+=t.writeRtpMap(e),i+=t.writeFmtp(e),i+=t.writeRtcpFb(e)});let n=0;return s.codecs.forEach(e=>{e.maxptime>n&&(n=e.maxptime)}),n>0&&(i+="a=maxptime:"+n+"\r\n"),s.headerExtensions&&s.headerExtensions.forEach(e=>{i+=t.writeExtmap(e)}),i},t.parseRtpEncodingParameters=function(e){const s=[],i=t.parseRtpParameters(e),n=-1!==i.fecMechanisms.indexOf("RED"),r=-1!==i.fecMechanisms.indexOf("ULPFEC"),a=t.matchPrefix(e,"a=ssrc:").map(e=>t.parseSsrcMedia(e)).filter(e=>"cname"===e.attribute),o=a.length>0&&a[0].ssrc;let l;const c=t.matchPrefix(e,"a=ssrc-group:FID").map(e=>e.substring(17).split(" ").map(e=>parseInt(e,10)));c.length>0&&c[0].length>1&&c[0][0]===o&&(l=c[0][1]),i.codecs.forEach(e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:o,codecPayloadType:parseInt(e.parameters.apt,10)};o&&l&&(t.rtx={ssrc:l}),s.push(t),n&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:o,mechanism:r?"red+ulpfec":"red"},s.push(t))}}),0===s.length&&o&&s.push({ssrc:o});let d=t.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substring(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substring(5),10)*.95-16e3:void 0,s.forEach(e=>{e.maxBitrate=d})),s},t.parseRtcpParameters=function(e){const s={},i=t.matchPrefix(e,"a=ssrc:").map(e=>t.parseSsrcMedia(e)).filter(e=>"cname"===e.attribute)[0];i&&(s.cname=i.value,s.ssrc=i.ssrc);const n=t.matchPrefix(e,"a=rtcp-rsize");s.reducedSize=n.length>0,s.compound=0===n.length;const r=t.matchPrefix(e,"a=rtcp-mux");return s.mux=r.length>0,s},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let s;const i=t.matchPrefix(e,"a=msid:");if(1===i.length)return s=i[0].substring(7).split(" "),{stream:s[0],track:s[1]};const n=t.matchPrefix(e,"a=ssrc:").map(e=>t.parseSsrcMedia(e)).filter(e=>"msid"===e.attribute);return n.length>0?(s=n[0].value.split(" "),{stream:s[0],track:s[1]}):void 0},t.parseSctpDescription=function(e){const s=t.parseMLine(e),i=t.matchPrefix(e,"a=max-message-size:");let n;i.length>0&&(n=parseInt(i[0].substring(19),10)),isNaN(n)&&(n=65536);const r=t.matchPrefix(e,"a=sctp-port:");if(r.length>0)return{port:parseInt(r[0].substring(12),10),protocol:s.fmt,maxMessageSize:n};const a=t.matchPrefix(e,"a=sctpmap:");if(a.length>0){const e=a[0].substring(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:n}}},t.writeSctpDescription=function(e,t){let s=[];return s="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&s.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),s.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(e,s,i){let n;const r=void 0!==s?s:2;return n=e||t.generateSessionId(),"v=0\r\no="+(i||"thisisadapterortc")+" "+n+" "+r+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,s){const i=t.splitLines(e);for(let t=0;t<i.length;t++)switch(i[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return i[t].substring(2)}return s?t.getDirection(s):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substring(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const s=t.splitLines(e)[0].substring(2).split(" ");return{kind:s[0],port:parseInt(s[1],10),protocol:s[2],fmt:s.slice(3).join(" ")}},t.parseOLine=function(e){const s=t.matchPrefix(e,"o=")[0].substring(2).split(" ");return{username:s[0],sessionId:s[1],sessionVersion:parseInt(s[2],10),netType:s[3],addressType:s[4],address:s[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const s=t.splitLines(e);for(let t=0;t<s.length;t++)if(s[t].length<2||"="!==s[t].charAt(1))return!1;return!0},e.exports=t}(Vf)),Vf.exports),Jf=jh(Gf),Wf=Yl({__proto__:null,default:Jf},[Gf]);function Kf(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substring(2)),e.candidate&&e.candidate.length){const s=new t(e),i=Jf.parseCandidate(e.candidate);for(const e in i)e in s||Object.defineProperty(s,e,{value:i[e]});return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,tf(e,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t))}function Yf(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||tf(e,"icecandidate",e=>{if(e.candidate){const t=Jf.parseCandidate(e.candidate.candidate);"relay"===t.type&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e})}function Xf(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const s=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(function(e){if(!e||!e.sdp)return!1;const t=Jf.splitSections(e.sdp);return t.shift(),t.some(e=>{const t=Jf.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})}(arguments[0])){const e=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const s=parseInt(t[1],10);return s!=s?-1:s}(arguments[0]),s=function(e){let s=65536;return"firefox"===t.browser&&(s=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),s}(e),i=function(e,s){let i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);const n=Jf.matchPrefix(e.sdp,"a=max-message-size:");return n.length>0?i=parseInt(n[0].substring(19),10):"firefox"===t.browser&&-1!==s&&(i=2147483637),i}(arguments[0],e);let n;n=0===s&&0===i?Number.POSITIVE_INFINITY:0===s||0===i?Math.max(s,i):Math.min(s,i);const r={};Object.defineProperty(r,"maxMessageSize",{get:()=>n}),this._sctp=r}return s.apply(this,arguments)}}function Qf(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const s=e.send;e.send=function(){const i=arguments[0],n=i.length||i.size||i.byteLength;if("open"===e.readyState&&t.sctp&&n>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return s.apply(e,arguments)}}const s=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=s.apply(this,arguments);return t(e,this),e},tf(e,"datachannel",e=>(t(e.channel,e.target),e))}function Zf(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const s=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const s=new Event("connectionstatechange",e);t.dispatchEvent(s)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),s.apply(this,arguments)}})}function em(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t._safariVersion>=13.1)return;const s=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const s=t.sdp.split("\n").filter(e=>"a=extmap-allow-mixed"!==e.trim()).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:s}):t.sdp=s}return s.apply(this,arguments)}}function tm(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const s=e.RTCPeerConnection.prototype.addIceCandidate;s&&0!==s.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():s.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function sm(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const s=e.RTCPeerConnection.prototype.setLocalDescription;s&&0!==s.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return s.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}if(e.sdp||"offer"!==e.type&&"answer"!==e.type)return s.apply(this,[e]);return("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then(e=>s.apply(this,[e]))})}var im=Object.freeze({__proto__:null,removeExtmapAllowMixed:em,shimAddIceCandidateNullOrEmpty:tm,shimConnectionState:Zf,shimMaxMessageSize:Xf,shimParameterlessSetLocalDescription:sm,shimRTCIceCandidate:Kf,shimRTCIceCandidateRelayProtocol:Yf,shimSendThrowTypeError:Qf});!function(){let{window:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const s=rf,i=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator||!e.navigator.userAgent)return t.browser="Not a browser.",t;const{navigator:s}=e;if(s.userAgentData&&s.userAgentData.brands){const e=s.userAgentData.brands.find(e=>"Chromium"===e.brand);if(e)return{browser:"chrome",version:parseInt(e.version,10)}}if(s.mozGetUserMedia)t.browser="firefox",t.version=parseInt(ef(s.userAgent,/Firefox\/(\d+)\./,1));else if(s.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=parseInt(ef(s.userAgent,/Chrom(e|ium)\/(\d+)\./,2));else{if(!e.RTCPeerConnection||!s.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=parseInt(ef(s.userAgent,/AppleWebKit\/(\d+)\./,1)),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype,t._safariVersion=ef(s.userAgent,/Version\/(\d+(\.?\d+))/,1)}return t}(e),n={browserDetails:i,commonShim:im,extractVersion:ef,disableLog:sf,disableWarnings:nf,sdp:Wf};switch(i.browser){case"chrome":if(!wf||!bf||!t.shimChrome)return s("Chrome shim is not included in this adapter release."),n;if(null===i.version)return s("Chrome shim can not determine version, not shimming."),n;s("adapter.js shimming chrome."),n.browserShim=wf,tm(e,i),sm(e),hf(e,i),ff(e),bf(e,i),mf(e),yf(e,i),pf(e),gf(e),xf(e,i),Kf(e),Yf(e),Zf(e),Xf(e,i),Qf(e),em(e,i);break;case"firefox":if(!Lf||!_f||!t.shimFirefox)return s("Firefox shim is not included in this adapter release."),n;s("adapter.js shimming firefox."),n.browserShim=Lf,tm(e,i),sm(e),Sf(e,i),_f(e,i),kf(e),Tf(e),Cf(e),Nf(e),Af(e),Ef(e),jf(e),Pf(e),If(e),Kf(e),Zf(e),Xf(e,i),Qf(e);break;case"safari":if(!Hf||!t.shimSafari)return s("Safari shim is not included in this adapter release."),n;s("adapter.js shimming safari."),n.browserShim=Hf,tm(e,i),sm(e),Ff(e),qf(e),Df(e),Rf(e),Of(e),Bf(e),Mf(e),$f(e),Kf(e),Yf(e),Xf(e,i),Qf(e),em(e,i);break;default:s("Unsupported browser!")}}({window:"undefined"==typeof window?void 0:window});const nm="lk_e2ee";var rm,am,om,lm,cm,dm,um,hm,fm,mm,pm,gm,vm,ym,bm,xm,wm,Sm,km,_m,Cm,Nm;function Tm(){return void 0!==window.RTCRtpSender&&void 0!==window.RTCRtpSender.prototype.createEncodedStreams||Am()}function Am(){return void 0!==window.RTCRtpScriptTransform}(am=rm||(rm={})).SetKey="setKey",am.RatchetRequest="ratchetRequest",am.KeyRatcheted="keyRatcheted",(om||(om={})).KeyRatcheted="keyRatcheted",(cm=lm||(lm={})).ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",cm.EncryptionError="encryptionError",(dm||(dm={})).Error="cryptorError";Xh.EventEmitter;class Em extends Error{constructor(e,t){super(t||"an error has occured"),this.name="LiveKitError",this.code=e}}(hm=um||(um={}))[hm.NotAllowed=0]="NotAllowed",hm[hm.ServerUnreachable=1]="ServerUnreachable",hm[hm.InternalError=2]="InternalError",hm[hm.Cancelled=3]="Cancelled",hm[hm.LeaveRequest=4]="LeaveRequest",hm[hm.Timeout=5]="Timeout";class jm extends Em{constructor(e,t,s,i){super(1,e),this.name="ConnectionError",this.status=s,this.reason=t,this.context=i,this.reasonName=um[t]}}class Pm extends Em{constructor(e){super(21,null!=e?e:"device is unsupported"),this.name="DeviceUnsupportedError"}}class Im extends Em{constructor(e){super(20,null!=e?e:"track is invalid"),this.name="TrackInvalidError"}}class Lm extends Em{constructor(e){super(10,null!=e?e:"unsupported server"),this.name="UnsupportedServer"}}class Rm extends Em{constructor(e){super(12,null!=e?e:"unexpected connection state"),this.name="UnexpectedConnectionState"}}class Om extends Em{constructor(e){super(13,null!=e?e:"unable to negotiate"),this.name="NegotiationError"}}class Dm extends Em{constructor(e,t){super(15,e),this.name="PublishTrackError",this.status=t}}class Mm extends Em{constructor(e,t){super(15,e),this.reason=t,this.reasonName="string"==typeof t?t:Ah[t]}}(mm=fm||(fm={}))[mm.AlreadyOpened=0]="AlreadyOpened",mm[mm.AbnormalEnd=1]="AbnormalEnd",mm[mm.DecodeFailed=2]="DecodeFailed",mm[mm.LengthExceeded=3]="LengthExceeded",mm[mm.Incomplete=4]="Incomplete",mm[mm.HandlerAlreadyRegistered=7]="HandlerAlreadyRegistered";class Um extends Em{constructor(e,t){super(16,e),this.name="DataStreamError",this.reason=t,this.reasonName=fm[t]}}(gm=pm||(pm={})).PermissionDenied="PermissionDenied",gm.NotFound="NotFound",gm.DeviceInUse="DeviceInUse",gm.Other="Other",function(e){e.getFailure=function(t){if(t&&"name"in t)return"NotFoundError"===t.name||"DevicesNotFoundError"===t.name?e.NotFound:"NotAllowedError"===t.name||"PermissionDeniedError"===t.name?e.PermissionDenied:"NotReadableError"===t.name||"TrackStartError"===t.name?e.DeviceInUse:e.Other}}(pm||(pm={})),(ym=vm||(vm={}))[ym.InvalidKey=0]="InvalidKey",ym[ym.MissingKey=1]="MissingKey",ym[ym.InternalError=2]="InternalError",(xm=bm||(bm={})).Connected="connected",xm.Reconnecting="reconnecting",xm.SignalReconnecting="signalReconnecting",xm.Reconnected="reconnected",xm.Disconnected="disconnected",xm.ConnectionStateChanged="connectionStateChanged",xm.Moved="moved",xm.MediaDevicesChanged="mediaDevicesChanged",xm.ParticipantConnected="participantConnected",xm.ParticipantDisconnected="participantDisconnected",xm.TrackPublished="trackPublished",xm.TrackSubscribed="trackSubscribed",xm.TrackSubscriptionFailed="trackSubscriptionFailed",xm.TrackUnpublished="trackUnpublished",xm.TrackUnsubscribed="trackUnsubscribed",xm.TrackMuted="trackMuted",xm.TrackUnmuted="trackUnmuted",xm.LocalTrackPublished="localTrackPublished",xm.LocalTrackUnpublished="localTrackUnpublished",xm.LocalAudioSilenceDetected="localAudioSilenceDetected",xm.ActiveSpeakersChanged="activeSpeakersChanged",xm.ParticipantMetadataChanged="participantMetadataChanged",xm.ParticipantNameChanged="participantNameChanged",xm.ParticipantAttributesChanged="participantAttributesChanged",xm.ParticipantActive="participantActive",xm.RoomMetadataChanged="roomMetadataChanged",xm.DataReceived="dataReceived",xm.SipDTMFReceived="sipDTMFReceived",xm.TranscriptionReceived="transcriptionReceived",xm.ConnectionQualityChanged="connectionQualityChanged",xm.TrackStreamStateChanged="trackStreamStateChanged",xm.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",xm.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",xm.AudioPlaybackStatusChanged="audioPlaybackChanged",xm.VideoPlaybackStatusChanged="videoPlaybackChanged",xm.MediaDevicesError="mediaDevicesError",xm.ParticipantPermissionsChanged="participantPermissionsChanged",xm.SignalConnected="signalConnected",xm.RecordingStatusChanged="recordingStatusChanged",xm.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",xm.EncryptionError="encryptionError",xm.DCBufferStatusChanged="dcBufferStatusChanged",xm.ActiveDeviceChanged="activeDeviceChanged",xm.ChatMessage="chatMessage",xm.LocalTrackSubscribed="localTrackSubscribed",xm.MetricsReceived="metricsReceived",(Sm=wm||(wm={})).TrackPublished="trackPublished",Sm.TrackSubscribed="trackSubscribed",Sm.TrackSubscriptionFailed="trackSubscriptionFailed",Sm.TrackUnpublished="trackUnpublished",Sm.TrackUnsubscribed="trackUnsubscribed",Sm.TrackMuted="trackMuted",Sm.TrackUnmuted="trackUnmuted",Sm.LocalTrackPublished="localTrackPublished",Sm.LocalTrackUnpublished="localTrackUnpublished",Sm.LocalTrackCpuConstrained="localTrackCpuConstrained",Sm.LocalSenderCreated="localSenderCreated",Sm.ParticipantMetadataChanged="participantMetadataChanged",Sm.ParticipantNameChanged="participantNameChanged",Sm.DataReceived="dataReceived",Sm.SipDTMFReceived="sipDTMFReceived",Sm.TranscriptionReceived="transcriptionReceived",Sm.IsSpeakingChanged="isSpeakingChanged",Sm.ConnectionQualityChanged="connectionQualityChanged",Sm.TrackStreamStateChanged="trackStreamStateChanged",Sm.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",Sm.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",Sm.TrackCpuConstrained="trackCpuConstrained",Sm.MediaDevicesError="mediaDevicesError",Sm.AudioStreamAcquired="audioStreamAcquired",Sm.ParticipantPermissionsChanged="participantPermissionsChanged",Sm.PCTrackAdded="pcTrackAdded",Sm.AttributesChanged="attributesChanged",Sm.LocalTrackSubscribed="localTrackSubscribed",Sm.ChatMessage="chatMessage",Sm.Active="active",(_m=km||(km={})).TransportsCreated="transportsCreated",_m.Connected="connected",_m.Disconnected="disconnected",_m.Resuming="resuming",_m.Resumed="resumed",_m.Restarting="restarting",_m.Restarted="restarted",_m.SignalResumed="signalResumed",_m.SignalRestarted="signalRestarted",_m.Closing="closing",_m.MediaTrackAdded="mediaTrackAdded",_m.ActiveSpeakersUpdate="activeSpeakersUpdate",_m.DataPacketReceived="dataPacketReceived",_m.RTPVideoMapUpdate="rtpVideoMapUpdate",_m.DCBufferStatusChanged="dcBufferStatusChanged",_m.ParticipantUpdate="participantUpdate",_m.RoomUpdate="roomUpdate",_m.SpeakersChanged="speakersChanged",_m.StreamStateChanged="streamStateChanged",_m.ConnectionQualityUpdate="connectionQualityUpdate",_m.SubscriptionError="subscriptionError",_m.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",_m.RemoteMute="remoteMute",_m.SubscribedQualityUpdate="subscribedQualityUpdate",_m.LocalTrackUnpublished="localTrackUnpublished",_m.LocalTrackSubscribed="localTrackSubscribed",_m.Offline="offline",_m.SignalRequestResponse="signalRequestResponse",_m.SignalConnected="signalConnected",_m.RoomMoved="roomMoved",(Nm=Cm||(Cm={})).Message="message",Nm.Muted="muted",Nm.Unmuted="unmuted",Nm.Restarted="restarted",Nm.Ended="ended",Nm.Subscribed="subscribed",Nm.Unsubscribed="unsubscribed",Nm.CpuConstrained="cpuConstrained",Nm.UpdateSettings="updateSettings",Nm.UpdateSubscription="updateSubscription",Nm.AudioPlaybackStarted="audioPlaybackStarted",Nm.AudioPlaybackFailed="audioPlaybackFailed",Nm.AudioSilenceDetected="audioSilenceDetected",Nm.VisibilityChanged="visibilityChanged",Nm.VideoDimensionsChanged="videoDimensionsChanged",Nm.VideoPlaybackStarted="videoPlaybackStarted",Nm.VideoPlaybackFailed="videoPlaybackFailed",Nm.ElementAttached="elementAttached",Nm.ElementDetached="elementDetached",Nm.UpstreamPaused="upstreamPaused",Nm.UpstreamResumed="upstreamResumed",Nm.SubscriptionPermissionChanged="subscriptionPermissionChanged",Nm.SubscriptionStatusChanged="subscriptionStatusChanged",Nm.SubscriptionFailed="subscriptionFailed",Nm.TrackProcessorUpdate="trackProcessorUpdate",Nm.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",Nm.TranscriptionReceived="transcriptionReceived",Nm.TimeSyncUpdate="timeSyncUpdate",Nm.PreConnectBufferFlushed="preConnectBufferFlushed";const Fm=/version\/(\d+(\.?_?\d+)+)/i;let Bm;function qm(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if("undefined"==typeof navigator)return;const s=navigator.userAgent.toLowerCase();if(void 0===Bm||t){const e=$m.find(e=>{let{test:t}=e;return t.test(s)});Bm=null==e?void 0:e.describe(s)}return Bm}const $m=[{test:/firefox|iceweasel|fxios/i,describe:e=>({name:"Firefox",version:zm(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,e),os:e.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:Hm(e)})},{test:/chrom|crios|crmo/i,describe:e=>({name:"Chrome",version:zm(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,e),os:e.toLowerCase().includes("crios")?"iOS":void 0,osVersion:Hm(e)})},{test:/safari|applewebkit/i,describe:e=>({name:"Safari",version:zm(Fm,e),os:e.includes("mobile/")?"iOS":"macOS",osVersion:Hm(e)})}];function zm(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;const i=t.match(e);return i&&i.length>=s&&i[s]||""}function Hm(e){return e.includes("mac os")?zm(/\(.+?(\d+_\d+(:?_\d+)?)/,e,1).replace(/_/g,"."):void 0}class Vm{}Vm.setTimeout=function(){return setTimeout(...arguments)},Vm.setInterval=function(){return setInterval(...arguments)},Vm.clearTimeout=function(){return clearTimeout(...arguments)},Vm.clearInterval=function(){return clearInterval(...arguments)};const Gm=[];var Jm,Wm;(Wm=Jm||(Jm={}))[Wm.LOW=0]="LOW",Wm[Wm.MEDIUM=1]="MEDIUM",Wm[Wm.HIGH=2]="HIGH";class Km extends Xh.EventEmitter{get streamState(){return this._streamState}setStreamState(e){this._streamState=e}constructor(e,t){let s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};var i;super(),this.attachedElements=[],this.isMuted=!1,this._streamState=Km.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=qh,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),"hidden"===document.visibilityState?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),5e3):this.handleAppVisibilityChanged()},this.log=$h(null!==(i=s.loggerName)&&void 0!==i?i:Uh.Track),this.loggerContextCb=s.loggerContextCb,this.setMaxListeners(100),this.kind=t,this._mediaStreamTrack=e,this._mediaStreamID=e.id,this.source=Km.Source.Unknown}get logContext(){var e;return Object.assign(Object.assign({},null===(e=this.loggerContextCb)||void 0===e?void 0:e.call(this)),ng(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(e){let t="audio";this.kind===Km.Kind.Video&&(t="video"),0===this.attachedElements.length&&this.kind===Km.Kind.Video&&this.addAppVisibilityListener(),e||("audio"===t&&(Gm.forEach(t=>{null!==t.parentElement||e||(e=t)}),e&&Gm.splice(Gm.indexOf(e),1)),e||(e=document.createElement(t))),this.attachedElements.includes(e)||this.attachedElements.push(e),Ym(this.mediaStreamTrack,e);const s=e.srcObject.getTracks(),i=s.some(e=>"audio"===e.kind);return e.play().then(()=>{this.emit(i?Cm.AudioPlaybackStarted:Cm.VideoPlaybackStarted)}).catch(t=>{"NotAllowedError"===t.name?this.emit(i?Cm.AudioPlaybackFailed:Cm.VideoPlaybackFailed,t):"AbortError"===t.name?qh.debug("".concat(i?"audio":"video"," playback aborted, likely due to new play request")):qh.warn("could not playback ".concat(i?"audio":"video"),t),i&&e&&s.some(e=>"video"===e.kind)&&"NotAllowedError"===t.name&&(e.muted=!0,e.play().catch(()=>{}))}),this.emit(Cm.ElementAttached,e),e}detach(e){try{if(e){Xm(this.mediaStreamTrack,e);const t=this.attachedElements.indexOf(e);return t>=0&&(this.attachedElements.splice(t,1),this.recycleElement(e),this.emit(Cm.ElementDetached,e)),e}const t=[];return this.attachedElements.forEach(e=>{Xm(this.mediaStreamTrack,e),t.push(e),this.recycleElement(e),this.emit(Cm.ElementDetached,e)}),this.attachedElements=[],t}finally{0===this.attachedElements.length&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(e){e.loggerName&&(this.log=$h(e.loggerName)),e.loggerContextCb&&(this.loggerContextCb=e.loggerContextCb)}recycleElement(e){if(e instanceof HTMLAudioElement){let t=!0;e.pause(),Gm.forEach(e=>{e.parentElement||(t=!1)}),t&&Gm.push(e)}}handleAppVisibilityChanged(){return Gh(this,void 0,void 0,function*(){this.isInBackground="hidden"===document.visibilityState,this.isInBackground||this.kind!==Km.Kind.Video||setTimeout(()=>this.attachedElements.forEach(e=>e.play().catch(()=>{})),0)})}addAppVisibilityListener(){bp()?(this.isInBackground="hidden"===document.visibilityState,document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){bp()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function Ym(e,t){let s,i;s=t.srcObject instanceof MediaStream?t.srcObject:new MediaStream,i="audio"===e.kind?s.getAudioTracks():s.getVideoTracks(),i.includes(e)||(i.forEach(e=>{s.removeTrack(e)}),s.addTrack(e)),gp()&&t instanceof HTMLVideoElement||(t.autoplay=!0),t.muted=0===s.getAudioTracks().length,t instanceof HTMLVideoElement&&(t.playsInline=!0),t.srcObject!==s&&(t.srcObject=s,(gp()||pp())&&t instanceof HTMLVideoElement&&setTimeout(()=>{t.srcObject=s,t.play().catch(()=>{})},0))}function Xm(e,t){if(t.srcObject instanceof MediaStream){const s=t.srcObject;s.removeTrack(e),s.getTracks().length>0?t.srcObject=s:t.srcObject=null}}!function(e){let t;var s;let i;var n;let r;var a;(s=t=e.Kind||(e.Kind={})).Audio="audio",s.Video="video",s.Unknown="unknown",(n=i=e.Source||(e.Source={})).Camera="camera",n.Microphone="microphone",n.ScreenShare="screen_share",n.ScreenShareAudio="screen_share_audio",n.Unknown="unknown",(a=r=e.StreamState||(e.StreamState={})).Active="active",a.Paused="paused",a.Unknown="unknown",e.kindToProto=function(e){switch(e){case t.Audio:return qd.AUDIO;case t.Video:return qd.VIDEO;default:return qd.DATA}},e.kindFromProto=function(e){switch(e){case qd.AUDIO:return t.Audio;case qd.VIDEO:return t.Video;default:return t.Unknown}},e.sourceToProto=function(e){switch(e){case i.Camera:return $d.CAMERA;case i.Microphone:return $d.MICROPHONE;case i.ScreenShare:return $d.SCREEN_SHARE;case i.ScreenShareAudio:return $d.SCREEN_SHARE_AUDIO;default:return $d.UNKNOWN}},e.sourceFromProto=function(e){switch(e){case $d.CAMERA:return i.Camera;case $d.MICROPHONE:return i.Microphone;case $d.SCREEN_SHARE:return i.ScreenShare;case $d.SCREEN_SHARE_AUDIO:return i.ScreenShareAudio;default:return i.Unknown}},e.streamStateFromProto=function(e){switch(e){case Du.ACTIVE:return r.Active;case Du.PAUSED:return r.Paused;default:return r.Unknown}}}(Km||(Km={}));class Qm{constructor(e,t,s,i,n){if("object"==typeof e)this.width=e.width,this.height=e.height,this.aspectRatio=e.aspectRatio,this.encoding={maxBitrate:e.maxBitrate,maxFramerate:e.maxFramerate,priority:e.priority};else{if(void 0===t||void 0===s)throw new TypeError("Unsupported options: provide at least width, height and maxBitrate");this.width=e,this.height=t,this.aspectRatio=e/t,this.encoding={maxBitrate:s,maxFramerate:i,priority:n}}}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const Zm=["vp8","h264"],ep=["vp8","h264","vp9","av1","h265"];function tp(e){return!!Zm.find(t=>t===e)}var sp,ip,np,rp;(ip=sp||(sp={}))[ip.PREFER_REGRESSION=0]="PREFER_REGRESSION",ip[ip.SIMULCAST=1]="SIMULCAST",ip[ip.REGRESSION=2]="REGRESSION",(rp=np||(np={})).telephone={maxBitrate:12e3},rp.speech={maxBitrate:24e3},rp.music={maxBitrate:48e3},rp.musicStereo={maxBitrate:64e3},rp.musicHighQuality={maxBitrate:96e3},rp.musicHighQualityStereo={maxBitrate:128e3};const ap={h90:new Qm(160,90,9e4,20),h180:new Qm(320,180,16e4,20),h216:new Qm(384,216,18e4,20),h360:new Qm(640,360,45e4,20),h540:new Qm(960,540,8e5,25),h720:new Qm(1280,720,17e5,30),h1080:new Qm(1920,1080,3e6,30),h1440:new Qm(2560,1440,5e6,30),h2160:new Qm(3840,2160,8e6,30)},op={h120:new Qm(160,120,7e4,20),h180:new Qm(240,180,125e3,20),h240:new Qm(320,240,14e4,20),h360:new Qm(480,360,33e4,20),h480:new Qm(640,480,5e5,20),h540:new Qm(720,540,6e5,25),h720:new Qm(960,720,13e5,30),h1080:new Qm(1440,1080,23e5,30),h1440:new Qm(1920,1440,38e5,30)},lp={h360fps3:new Qm(640,360,2e5,3,"medium"),h360fps15:new Qm(640,360,4e5,15,"medium"),h720fps5:new Qm(1280,720,8e5,5,"medium"),h720fps15:new Qm(1280,720,15e5,15,"medium"),h720fps30:new Qm(1280,720,2e6,30,"medium"),h1080fps15:new Qm(1920,1080,25e5,15,"medium"),h1080fps30:new Qm(1920,1080,5e6,30,"medium"),original:new Qm(0,0,7e6,30,"medium")},cp="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function dp(e){return Gh(this,void 0,void 0,function*(){return new Promise(t=>Vm.setTimeout(t,e))})}function up(){return"addTransceiver"in RTCPeerConnection.prototype}function hp(){return"addTrack"in RTCPeerConnection.prototype}function fp(e){return"av1"===e||"vp9"===e}function mp(e){return!(!document||vp())&&(e||(e=document.createElement("audio")),"setSinkId"in e)}function pp(){var e;return"Firefox"===(null===(e=qm())||void 0===e?void 0:e.name)}function gp(){var e;return"Safari"===(null===(e=qm())||void 0===e?void 0:e.name)}function vp(){const e=qm();return"Safari"===(null==e?void 0:e.name)||"iOS"===(null==e?void 0:e.os)}function yp(){var e,t;return!!bp()&&(null!==(t=null===(e=navigator.userAgentData)||void 0===e?void 0:e.mobile)&&void 0!==t?t:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent))}function bp(){return"undefined"!=typeof document}function xp(){return"ReactNative"==navigator.product}function wp(e){return e.hostname.endsWith(".livekit.cloud")||e.hostname.endsWith(".livekit.run")}function Sp(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function kp(){if(!xp())return;let e=Sp();return e?e.platform:void 0}function _p(){if(bp())return window.devicePixelRatio;if(xp()){let e=Sp();if(e)return e.devicePixelRatio}return 1}function Cp(e,t){const s=e.split("."),i=t.split("."),n=Math.min(s.length,i.length);for(let r=0;r<n;++r){const e=parseInt(s[r],10),t=parseInt(i[r],10);if(e>t)return 1;if(e<t)return-1;if(r===n-1&&e===t)return 0}return""===e&&""!==t?-1:""===t?1:s.length==i.length?0:s.length<i.length?-1:1}function Np(e){for(const t of e)t.target.handleResize(t)}function Tp(e){for(const t of e)t.target.handleVisibilityChanged(t)}let Ap=null;const Ep=()=>(Ap||(Ap=new ResizeObserver(Np)),Ap);let jp=null;const Pp=()=>(jp||(jp=new IntersectionObserver(Tp,{root:null,rootMargin:"0px"})),jp);function Ip(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16,s=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];const n=document.createElement("canvas");n.width=e,n.height=t;const r=n.getContext("2d");null==r||r.fillRect(0,0,n.width,n.height),i&&r&&(r.beginPath(),r.arc(e/2,t/2,50,0,2*Math.PI,!0),r.closePath(),r.fillStyle="grey",r.fill());const a=n.captureStream(),[o]=a.getTracks();if(!o)throw Error("Could not get empty media stream video track");return o.enabled=s,o}let Lp;function Rp(){if(!Lp){const e=new AudioContext,t=e.createOscillator(),s=e.createGain();s.gain.setValueAtTime(0,0);const i=e.createMediaStreamDestination();if(t.connect(s),s.connect(i),t.start(),[Lp]=i.stream.getAudioTracks(),!Lp)throw Error("Could not get empty media stream audio track");Lp.enabled=!1}return Lp.clone()}class Op{get isResolved(){return this._isResolved}constructor(e,t){this._isResolved=!1,this.onFinally=t,this.promise=new Promise((t,s)=>Gh(this,void 0,void 0,function*(){this.resolve=t,this.reject=s,e&&(yield e(t,s))})).finally(()=>{var e;this._isResolved=!0,null===(e=this.onFinally)||void 0===e||e.call(this)})}}function Dp(e){if("string"==typeof e||"number"==typeof e)return e;if(Array.isArray(e))return e[0];if(void 0!==e.exact)return Array.isArray(e.exact)?e.exact[0]:e.exact;if(void 0!==e.ideal)return Array.isArray(e.ideal)?e.ideal[0]:e.ideal;throw Error("could not unwrap constraint")}function Mp(e){return e.startsWith("ws")?e.replace(/^(ws)/,"http"):e}function Up(e){switch(e.reason){case um.LeaveRequest:return e.context;case um.Cancelled:return Gd.CLIENT_INITIATED;case um.NotAllowed:return Gd.USER_REJECTED;case um.ServerUnreachable:return Gd.JOIN_FAILURE;default:return Gd.UNKNOWN_REASON}}function Fp(e){return void 0!==e?Number(e):void 0}function Bp(e){return void 0!==e?BigInt(e):void 0}function qp(e){return!!e&&!(e instanceof MediaStreamTrack)&&e.isLocal}function $p(e){return!!e&&e.kind==Km.Kind.Audio}function zp(e){return!!e&&e.kind==Km.Kind.Video}function Hp(e){return qp(e)&&zp(e)}function Vp(e){return qp(e)&&$p(e)}function Gp(e){return!!e&&!e.isLocal}function Jp(e){return!!e&&!e.isLocal}function Wp(e){return Gp(e)&&zp(e)}function Kp(e,t,s){var i,n,r,a;const{optionsWithoutProcessor:o,audioProcessor:l,videoProcessor:c}=rg(null!=e?e:{}),d=null==t?void 0:t.processor,u=null==s?void 0:s.processor,h=null!=o?o:{};return!0===h.audio&&(h.audio={}),!0===h.video&&(h.video={}),h.audio&&(Yp(h.audio,t),null!==(i=(r=h.audio).deviceId)&&void 0!==i||(r.deviceId={ideal:"default"}),(l||d)&&(h.audio.processor=null!=l?l:d)),h.video&&(Yp(h.video,s),null!==(n=(a=h.video).deviceId)&&void 0!==n||(a.deviceId={ideal:"default"}),(c||u)&&(h.video.processor=null!=c?c:u)),h}function Yp(e,t){return Object.keys(t).forEach(s=>{void 0===e[s]&&(e[s]=t[s])}),e}function Xp(e){var t,s,i,n;const r={};if(e.video)if("object"==typeof e.video){const s={},n=s,a=e.video;Object.keys(a).forEach(e=>{if("resolution"===e)Yp(n,a.resolution);else n[e]=a[e]}),r.video=s,null!==(t=(i=r.video).deviceId)&&void 0!==t||(i.deviceId={ideal:"default"})}else r.video=!!e.video&&{deviceId:{ideal:"default"}};else r.video=!1;return e.audio?"object"==typeof e.audio?(r.audio=e.audio,null!==(s=(n=r.audio).deviceId)&&void 0!==s||(n.deviceId={ideal:"default"})):r.audio={deviceId:{ideal:"default"}}:r.audio=!1,r}function Qp(e){return Gh(this,arguments,void 0,function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:200;return function*(){const s=Zp();if(s){const i=s.createAnalyser();i.fftSize=2048;const n=i.frequencyBinCount,r=new Uint8Array(n);s.createMediaStreamSource(new MediaStream([e.mediaStreamTrack])).connect(i),yield dp(t),i.getByteTimeDomainData(r);const a=r.some(e=>128!==e&&0!==e);return s.close(),!a}return!1}()})}function Zp(){var e;const t="undefined"!=typeof window&&(window.AudioContext||window.webkitAudioContext);if(t){const s=new t({latencyHint:"interactive"});if("suspended"===s.state&&"undefined"!=typeof window&&(null===(e=window.document)||void 0===e?void 0:e.body)){const e=()=>Gh(this,void 0,void 0,function*(){var t;try{"suspended"===s.state&&(yield s.resume())}catch(Tx){}null===(t=window.document.body)||void 0===t||t.removeEventListener("click",e)});window.document.body.addEventListener("click",e)}return s}}function eg(e){return"audioinput"===e?Km.Source.Microphone:"videoinput"===e?Km.Source.Camera:Km.Source.Unknown}function tg(e){return e===Km.Source.Microphone?"audioinput":e===Km.Source.Camera?"videoinput":void 0}function sg(e){return e.split("/")[1].toLowerCase()}function ig(e){const t=[];return e.forEach(e=>{void 0!==e.track&&t.push(new Gu({cid:e.track.mediaStreamID,track:e.trackInfo}))}),t}function ng(e){return"mediaStreamTrack"in e?{trackID:e.sid,source:e.source,muted:e.isMuted,enabled:e.mediaStreamTrack.enabled,kind:e.kind,streamID:e.mediaStreamID,streamTrackID:e.mediaStreamTrack.id}:{trackID:e.trackSid,enabled:e.isEnabled,muted:e.isMuted,trackInfo:Object.assign({mimeType:e.mimeType,name:e.trackName,encrypted:e.isEncrypted,kind:e.kind,source:e.source},e.track?ng(e.track):{})}}function rg(e){const t=Object.assign({},e);let s,i;return"object"==typeof t.audio&&t.audio.processor&&(s=t.audio.processor,t.audio=Object.assign(Object.assign({},t.audio),{processor:void 0})),"object"==typeof t.video&&t.video.processor&&(i=t.video.processor,t.video=Object.assign(Object.assign({},t.video),{processor:void 0})),{audioProcessor:s,videoProcessor:i,optionsWithoutProcessor:(n=t,void 0===n?n:"function"==typeof structuredClone?"object"==typeof n&&null!==n?structuredClone(Object.assign({},n)):structuredClone(n):JSON.parse(JSON.stringify(n)))};var n}function ag(e,t){return e.width*e.height<t.width*t.height}class og extends Xh.EventEmitter{constructor(e){super(),this.onWorkerMessage=e=>{var t,s;const{kind:i,data:n}=e.data;switch(i){case"error":qh.error(n.error.message),this.emit(lm.EncryptionError,n.error);break;case"initAck":n.enabled&&this.keyProvider.getKeys().forEach(e=>{this.postKey(e)});break;case"enable":if(n.enabled&&this.keyProvider.getKeys().forEach(e=>{this.postKey(e)}),this.encryptionEnabled!==n.enabled&&n.participantIdentity===(null===(t=this.room)||void 0===t?void 0:t.localParticipant.identity))this.emit(lm.ParticipantEncryptionStatusChanged,n.enabled,this.room.localParticipant),this.encryptionEnabled=n.enabled;else if(n.participantIdentity){const e=null===(s=this.room)||void 0===s?void 0:s.getParticipantByIdentity(n.participantIdentity);if(!e)throw TypeError("couldn't set encryption status, participant not found".concat(n.participantIdentity));this.emit(lm.ParticipantEncryptionStatusChanged,n.enabled,e)}break;case"ratchetKey":this.keyProvider.emit(rm.KeyRatcheted,n.ratchetResult,n.participantIdentity,n.keyIndex)}},this.onWorkerError=e=>{qh.error("e2ee worker encountered an error:",{error:e.error}),this.emit(lm.EncryptionError,e.error)},this.keyProvider=e.keyProvider,this.worker=e.worker,this.encryptionEnabled=!1}setup(e){if(!Tm())throw new Pm("tried to setup end-to-end encryption on an unsupported browser");if(qh.info("setting up e2ee"),e!==this.room){this.room=e,this.setupEventListeners(e,this.keyProvider);const t={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:zh.getLevel()}};this.worker&&(qh.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(t))}}setParticipantCryptorEnabled(e,t){qh.debug("set e2ee to ".concat(e," for participant ").concat(t)),this.postEnable(e,t)}setSifTrailer(e){e&&0!==e.length?this.postSifTrailer(e):qh.warn("ignoring server sent trailer as it's empty")}setupEngine(e){e.on(km.RTPVideoMapUpdate,e=>{this.postRTPMap(e)})}setupEventListeners(e,t){e.on(bm.TrackPublished,(e,t)=>this.setParticipantCryptorEnabled(e.trackInfo.encryption!==iu.NONE,t.identity)),e.on(bm.ConnectionStateChanged,t=>{t===Yv.Connected&&e.remoteParticipants.forEach(e=>{e.trackPublications.forEach(t=>{this.setParticipantCryptorEnabled(t.trackInfo.encryption!==iu.NONE,e.identity)})})}).on(bm.TrackUnsubscribed,(e,t,s)=>{var i;const n={kind:"removeTransform",data:{participantIdentity:s.identity,trackId:e.mediaStreamID}};null===(i=this.worker)||void 0===i||i.postMessage(n)}).on(bm.TrackSubscribed,(e,t,s)=>{this.setupE2EEReceiver(e,s.identity,t.trackInfo)}).on(bm.SignalConnected,()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");t.getKeys().forEach(e=>{this.postKey(e)}),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}),e.localParticipant.on(wm.LocalSenderCreated,(e,t)=>Gh(this,void 0,void 0,function*(){this.setupE2EESender(t,e)})),e.localParticipant.on(wm.LocalTrackPublished,e=>{if(!zp(e.track)||!vp())return;const t={kind:"updateCodec",data:{trackId:e.track.mediaStreamID,codec:sg(e.trackInfo.codecs[0].mimeType),participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(t)}),t.on(rm.SetKey,e=>this.postKey(e)).on(rm.RatchetRequest,(e,t)=>this.postRatchetRequest(e,t))}postRatchetRequest(e,t){if(!this.worker)throw Error("could not ratchet key, worker is missing");const s={kind:"ratchetRequest",data:{participantIdentity:e,keyIndex:t}};this.worker.postMessage(s)}postKey(e){let{key:t,participantIdentity:s,keyIndex:i}=e;var n;if(!this.worker)throw Error("could not set key, worker is missing");const r={kind:"setKey",data:{participantIdentity:s,isPublisher:s===(null===(n=this.room)||void 0===n?void 0:n.localParticipant.identity),key:t,keyIndex:i}};this.worker.postMessage(r)}postEnable(e,t){if(!this.worker)throw new ReferenceError("failed to enable e2ee, worker is not ready");{const s={kind:"enable",data:{enabled:e,participantIdentity:t}};this.worker.postMessage(s)}}postRTPMap(e){var t;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(null===(t=this.room)||void 0===t?void 0:t.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const s={kind:"setRTPMap",data:{map:e,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(s)}postSifTrailer(e){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const t={kind:"setSifTrailer",data:{trailer:e}};this.worker.postMessage(t)}setupE2EEReceiver(e,t,s){if(e.receiver){if(!(null==s?void 0:s.mimeType)||""===s.mimeType)throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(e.receiver,e.mediaStreamID,t,"video"===e.kind?sg(s.mimeType):void 0)}}setupE2EESender(e,t){qp(e)&&t?this.handleSender(t,e.mediaStreamID,void 0):t||qh.warn("early return because sender is not ready")}handleReceiver(e,t,s,i){return Gh(this,void 0,void 0,function*(){if(this.worker){if(Am()){const n={kind:"decode",participantIdentity:s,trackId:t,codec:i};e.transform=new RTCRtpScriptTransform(this.worker,n)}else{if(nm in e&&i){const e={kind:"updateCodec",data:{trackId:t,codec:i,participantIdentity:s}};return void this.worker.postMessage(e)}let n=e.writableStream,r=e.readableStream;if(!n||!r){const t=e.createEncodedStreams();e.writableStream=t.writable,n=t.writable,e.readableStream=t.readable,r=t.readable}const a={kind:"decode",data:{readableStream:r,writableStream:n,trackId:t,codec:i,participantIdentity:s,isReuse:nm in e}};this.worker.postMessage(a,[r,n])}e[nm]=!0}})}handleSender(e,t,s){var i;if(!(nm in e)&&this.worker){if(!(null===(i=this.room)||void 0===i?void 0:i.localParticipant.identity)||""===this.room.localParticipant.identity)throw TypeError("local identity needs to be known in order to set up encrypted sender");if(Am()){qh.info("initialize script transform");const i={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:t,codec:s};e.transform=new RTCRtpScriptTransform(this.worker,i)}else{qh.info("initialize encoded streams");const i=e.createEncodedStreams(),n={kind:"encode",data:{readableStream:i.readable,writableStream:i.writable,codec:s,trackId:t,participantIdentity:this.room.localParticipant.identity,isReuse:!1}};this.worker.postMessage(n,[i.readable,i.writable])}e[nm]=!0}}}const lg="default";class cg{constructor(){this._previousDevices=[]}static getInstance(){return void 0===this.instance&&(this.instance=new cg),this.instance}get previousDevices(){return this._previousDevices}getDevices(e){return Gh(this,arguments,void 0,function(e){var t=this;let s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function*(){var i;if((null===(i=cg.userMediaPromiseMap)||void 0===i?void 0:i.size)>0){qh.debug("awaiting getUserMedia promise");try{e?yield cg.userMediaPromiseMap.get(e):yield Promise.all(cg.userMediaPromiseMap.values())}catch(Tx){qh.warn("error waiting for media permissons")}}let n=yield navigator.mediaDevices.enumerateDevices();if(s&&(!gp()||!t.hasDeviceInUse(e))){if(0===n.filter(t=>t.kind===e).length||n.some(t=>{const s=""===t.label,i=!e||t.kind===e;return s&&i})){const t={video:"audioinput"!==e&&"audiooutput"!==e,audio:"videoinput"!==e&&{deviceId:{ideal:"default"}}},s=yield navigator.mediaDevices.getUserMedia(t);n=yield navigator.mediaDevices.enumerateDevices(),s.getTracks().forEach(e=>{e.stop()})}}return t._previousDevices=n,e&&(n=n.filter(t=>t.kind===e)),n}()})}normalizeDeviceId(e,t,s){return Gh(this,void 0,void 0,function*(){if(t!==lg)return t;const i=yield this.getDevices(e),n=i.find(e=>e.deviceId===lg);if(!n)return void qh.warn("could not reliably determine default device");const r=i.find(e=>e.deviceId!==lg&&e.groupId===(null!=s?s:n.groupId));if(r)return null==r?void 0:r.deviceId;qh.warn("could not reliably determine default device")})}hasDeviceInUse(e){return e?cg.userMediaPromiseMap.has(e):cg.userMediaPromiseMap.size>0}}var dg,ug;cg.mediaDeviceKinds=["audioinput","audiooutput","videoinput"],cg.userMediaPromiseMap=new Map,(ug=dg||(dg={}))[ug.WAITING=0]="WAITING",ug[ug.RUNNING=1]="RUNNING",ug[ug.COMPLETED=2]="COMPLETED";class hg{constructor(){this.pendingTasks=new Map,this.taskMutex=new Zl,this.nextTaskIndex=0}run(e){return Gh(this,void 0,void 0,function*(){const t={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:dg.WAITING};this.pendingTasks.set(t.id,t);const s=yield this.taskMutex.lock();try{return t.executedAt=Date.now(),t.status=dg.RUNNING,yield e()}finally{t.status=dg.COMPLETED,this.pendingTasks.delete(t.id),s()}})}flush(){return Gh(this,void 0,void 0,function*(){return this.run(()=>Gh(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}function fg(e,t){return e.pathname="".concat(function(e){return e.endsWith("/")?e:"".concat(e,"/")}(e.pathname)).concat(t),e.toString()}const mg=["syncState","trickle","offer","answer","simulate","leave"];var pg,gg;(gg=pg||(pg={}))[gg.CONNECTING=0]="CONNECTING",gg[gg.CONNECTED=1]="CONNECTED",gg[gg.RECONNECTING=2]="RECONNECTING",gg[gg.DISCONNECTING=3]="DISCONNECTING",gg[gg.DISCONNECTED=4]="DISCONNECTED";class vg{get currentState(){return this.state}get isDisconnected(){return this.state===pg.DISCONNECTING||this.state===pg.DISCONNECTED}get isEstablishingConnection(){return this.state===pg.CONNECTING||this.state===pg.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var s;this.rtt=0,this.state=pg.DISCONNECTED,this.log=qh,this._requestId=0,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0},this.log=$h(null!==(s=t.loggerName)&&void 0!==s?s:Uh.Signal),this.loggerContextCb=t.loggerContextCb,this.useJSON=e,this.requestQueue=new hg,this.queuedRequests=[],this.closingLock=new Zl,this.connectionLock=new Zl,this.state=pg.DISCONNECTED}get logContext(){var e,t;return null!==(t=null===(e=this.loggerContextCb)||void 0===e?void 0:e.call(this))&&void 0!==t?t:{}}join(e,t,s,i){return Gh(this,void 0,void 0,function*(){this.state=pg.CONNECTING,this.options=s;return yield this.connect(e,t,s,i)})}reconnect(e,t,s,i){return Gh(this,void 0,void 0,function*(){if(!this.options)return void this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);this.state=pg.RECONNECTING,this.clearPingInterval();return yield this.connect(e,t,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:s,reconnectReason:i}))})}connect(e,t,s,i){this.connectOptions=s;const n=function(e,t,s){var i;const n=new URLSearchParams;n.set("access_token",e),s.reconnect&&(n.set("reconnect","1"),s.sid&&n.set("sid",s.sid));n.set("auto_subscribe",s.autoSubscribe?"1":"0"),n.set("sdk",xp()?"reactnative":"js"),n.set("version",t.version),n.set("protocol",t.protocol.toString()),t.deviceModel&&n.set("device_model",t.deviceModel);t.os&&n.set("os",t.os);t.osVersion&&n.set("os_version",t.osVersion);t.browser&&n.set("browser",t.browser);t.browserVersion&&n.set("browser_version",t.browserVersion);s.adaptiveStream&&n.set("adaptive_stream","1");s.reconnectReason&&n.set("reconnect_reason",s.reconnectReason.toString());(null===(i=navigator.connection)||void 0===i?void 0:i.type)&&n.set("network",navigator.connection.type);return n}(t,function(){var e;const t=new ku({sdk:_u.JS,protocol:16,version:"2.15.7"});return xp()&&(t.os=null!==(e=kp())&&void 0!==e?e:""),t}(),s),r=function(e,t){const s=new URL(function(e){return e.startsWith("http")?e.replace(/^(http)/,"ws"):e}(e));return t.forEach((e,t)=>{s.searchParams.set(t,e)}),fg(s,"rtc")}(e,n),a=fg(new URL(Mp(r)),"validate");return new Promise((e,t)=>Gh(this,void 0,void 0,function*(){const n=yield this.connectionLock.lock();try{const n=()=>Gh(this,void 0,void 0,function*(){this.close(),clearTimeout(o),t(new jm("room connection has been cancelled (signal)",um.Cancelled))}),o=setTimeout(()=>{this.close(),t(new jm("room connection has timed out (signal)",um.ServerUnreachable))},s.websocketTimeout);(null==i?void 0:i.aborted)&&n(),null==i||i.addEventListener("abort",n);const l=new URL(r);l.searchParams.has("access_token")&&l.searchParams.set("access_token","<redacted>"),this.log.debug("connecting to ".concat(l),Object.assign({reconnect:s.reconnect,reconnectReason:s.reconnectReason},this.logContext)),this.ws&&(yield this.close(!1)),this.ws=new WebSocket(r),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{clearTimeout(o)},this.ws.onerror=e=>Gh(this,void 0,void 0,function*(){if(this.state===pg.CONNECTED)this.handleWSError(e);else{this.state=pg.DISCONNECTED,clearTimeout(o);try{const s=yield fetch(a);if(s.status.toFixed(0).startsWith("4")){const e=yield s.text();t(new jm(e,um.NotAllowed,s.status))}else t(new jm("Encountered unknown websocket error during connection: ".concat(e.toString()),um.InternalError,s.status))}catch(Tx){t(new jm(Tx instanceof Error?Tx.message:"server was not reachable",um.ServerUnreachable))}}}),this.ws.onmessage=r=>Gh(this,void 0,void 0,function*(){var a,o,l;let c;if("string"==typeof r.data){const e=JSON.parse(r.data);c=Fu.fromJson(e,{ignoreUnknownFields:!0})}else{if(!(r.data instanceof ArrayBuffer))return void this.log.error("could not decode websocket message: ".concat(typeof r.data),this.logContext);c=Fu.fromBinary(new Uint8Array(r.data))}if(this.state!==pg.CONNECTED){let r=!1;if("join"===(null===(a=c.message)||void 0===a?void 0:a.case)?(this.state=pg.CONNECTED,null==i||i.removeEventListener("abort",n),this.pingTimeoutDuration=c.message.value.pingTimeout,this.pingIntervalDuration=c.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&(this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})),this.startPingInterval()),e(c.message.value)):this.state===pg.RECONNECTING&&"leave"!==c.message.case?(this.state=pg.CONNECTED,null==i||i.removeEventListener("abort",n),this.startPingInterval(),"reconnect"===(null===(o=c.message)||void 0===o?void 0:o.case)?e(c.message.value):(this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),e(void 0),r=!0)):this.isEstablishingConnection&&"leave"===c.message.case?t(new jm("Received leave request while trying to (re)connect",um.LeaveRequest,void 0,c.message.value.reason)):s.reconnect||t(new jm("did not receive join response, got ".concat(null===(l=c.message)||void 0===l?void 0:l.case," instead"),um.InternalError)),!r)return}this.signalLatency&&(yield dp(this.signalLatency)),this.handleSignalResponse(c)}),this.ws.onclose=e=>{this.isEstablishingConnection&&t(new jm("Websocket got closed during a (re)connection attempt",um.InternalError)),this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:e.reason,code:e.code,wasClean:e.wasClean,state:this.state})),this.handleOnClose(e.reason)}}finally{n()}}))}close(){return Gh(this,arguments,void 0,function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return function*(){const s=yield e.closingLock.lock();try{if(e.clearPingInterval(),t&&(e.state=pg.DISCONNECTING),e.ws){e.ws.onmessage=null,e.ws.onopen=null,e.ws.onclose=null;const t=new Promise(t=>{e.ws?e.ws.onclose=()=>{t()}:t()});e.ws.readyState<e.ws.CLOSING&&(e.ws.close(),yield Promise.race([t,dp(250)])),e.ws=void 0}}finally{t&&(e.state=pg.DISCONNECTED),s()}}()})}sendOffer(e,t){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:e.sdp})),this.sendRequest({case:"offer",value:bg(e,t)})}sendAnswer(e,t){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:e.sdp})),this.sendRequest({case:"answer",value:bg(e,t)})}sendIceCandidate(e,t){return this.log.debug("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:e})),this.sendRequest({case:"trickle",value:new $u({candidateInit:JSON.stringify(e),target:t})})}sendMuteTrack(e,t){return this.sendRequest({case:"mute",value:new zu({sid:e,muted:t})})}sendAddTrack(e){return this.sendRequest({case:"addTrack",value:e})}sendUpdateLocalMetadata(e,t){return Gh(this,arguments,void 0,function(e,t){var s=this;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return function*(){const n=s.getNextRequestId();return yield s.sendRequest({case:"updateMetadata",value:new ih({requestId:n,metadata:e,name:t,attributes:i})}),n}()})}sendUpdateTrackSettings(e){this.sendRequest({case:"trackSetting",value:e})}sendUpdateSubscription(e){return this.sendRequest({case:"subscription",value:e})}sendSyncState(e){return this.sendRequest({case:"syncState",value:e})}sendUpdateVideoLayers(e,t){return this.sendRequest({case:"updateLayers",value:new sh({trackSid:e,layers:t})})}sendUpdateSubscriptionPermissions(e,t){return this.sendRequest({case:"subscriptionPermission",value:new ph({allParticipants:e,trackPermissions:t})})}sendSimulateScenario(e){return this.sendRequest({case:"simulate",value:e})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:wc.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new Sh({timestamp:wc.parse(Date.now()),rtt:wc.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(e,t){return this.sendRequest({case:"updateAudioTrack",value:new Qu({trackSid:e,features:t})})}sendLeave(){return this.sendRequest({case:"leave",value:new eh({reason:Gd.CLIENT_INITIATED,action:th.DISCONNECT})})}sendRequest(e){return Gh(this,arguments,void 0,function(e){var t=this;let s=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return function*(){const i=!s&&!function(e){const t=mg.indexOf(e.case)>=0;return qh.trace("request allowed to bypass queue:",{canPass:t,req:e}),t}(e);if(i&&t.state===pg.RECONNECTING)return void t.queuedRequests.push(()=>Gh(t,void 0,void 0,function*(){yield this.sendRequest(e,!0)}));if(s||(yield t.requestQueue.flush()),t.signalLatency&&(yield dp(t.signalLatency)),t.isDisconnected)return void t.log.debug("skipping signal request (type: ".concat(e.case,") - SignalClient disconnected"));if(!t.ws||t.ws.readyState!==t.ws.OPEN)return void t.log.error("cannot send signal request before connected, type: ".concat(null==e?void 0:e.case),t.logContext);const n=new Uu({message:e});try{t.useJSON?t.ws.send(n.toJsonString()):t.ws.send(n.toBinary())}catch(Tx){t.log.error("error sending signal message",Object.assign(Object.assign({},t.logContext),{error:Tx}))}}()})}handleSignalResponse(e){var t,s;const i=e.message;if(null==i)return void this.log.debug("received unsupported message",this.logContext);let n=!1;if("answer"===i.case){const e=yg(i.value);this.onAnswer&&this.onAnswer(e,i.value.id)}else if("offer"===i.case){const e=yg(i.value);this.onOffer&&this.onOffer(e,i.value.id)}else if("trickle"===i.case){const e=JSON.parse(i.value.candidateInit);this.onTrickle&&this.onTrickle(e,i.value.target)}else"update"===i.case?this.onParticipantUpdate&&this.onParticipantUpdate(null!==(t=i.value.participants)&&void 0!==t?t:[]):"trackPublished"===i.case?this.onLocalTrackPublished&&this.onLocalTrackPublished(i.value):"speakersChanged"===i.case?this.onSpeakersChanged&&this.onSpeakersChanged(null!==(s=i.value.speakers)&&void 0!==s?s:[]):"leave"===i.case?this.onLeave&&this.onLeave(i.value):"mute"===i.case?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(i.value.sid,i.value.muted):"roomUpdate"===i.case?this.onRoomUpdate&&i.value.room&&this.onRoomUpdate(i.value.room):"connectionQuality"===i.case?this.onConnectionQuality&&this.onConnectionQuality(i.value):"streamStateUpdate"===i.case?this.onStreamStateUpdate&&this.onStreamStateUpdate(i.value):"subscribedQualityUpdate"===i.case?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(i.value):"subscriptionPermissionUpdate"===i.case?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(i.value):"refreshToken"===i.case?this.onTokenRefresh&&this.onTokenRefresh(i.value):"trackUnpublished"===i.case?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(i.value):"subscriptionResponse"===i.case?this.onSubscriptionError&&this.onSubscriptionError(i.value):"pong"===i.case||("pongResp"===i.case?(this.rtt=Date.now()-Number.parseInt(i.value.lastPingTimestamp.toString()),this.resetPingTimeout(),n=!0):"requestResponse"===i.case?this.onRequestResponse&&this.onRequestResponse(i.value):"trackSubscribed"===i.case?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(i.value.trackSid):"roomMoved"===i.case?(this.onTokenRefresh&&this.onTokenRefresh(i.value.token),this.onRoomMoved&&this.onRoomMoved(i.value)):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:i.case})));n||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const e=this.queuedRequests.shift();e&&this.requestQueue.run(e)}}handleOnClose(e){return Gh(this,void 0,void 0,function*(){if(this.state===pg.DISCONNECTED)return;const t=this.onClose;yield this.close(),this.log.debug("websocket connection closed: ".concat(e),Object.assign(Object.assign({},this.logContext),{reason:e})),t&&t(e)})}handleWSError(e){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:e}))}resetPingTimeout(){this.clearPingTimeout(),this.pingTimeoutDuration?this.pingTimeout=Vm.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-1e3*this.pingTimeoutDuration).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},1e3*this.pingTimeoutDuration):this.log.warn("ping timeout duration not set",this.logContext)}clearPingTimeout(){this.pingTimeout&&Vm.clearTimeout(this.pingTimeout)}startPingInterval(){this.clearPingInterval(),this.resetPingTimeout(),this.pingIntervalDuration?(this.log.debug("start ping interval",this.logContext),this.pingInterval=Vm.setInterval(()=>{this.sendPing()},1e3*this.pingIntervalDuration)):this.log.warn("ping interval duration not set",this.logContext)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&Vm.clearInterval(this.pingInterval)}}function yg(e){const t={type:"offer",sdp:e.sdp};switch(e.type){case"answer":case"offer":case"pranswer":case"rollback":t.type=e.type}return t}function bg(e,t){return new Wu({sdp:e.sdp,type:e.type,id:t})}class xg{constructor(){this.buffer=[],this._totalSize=0}push(e){this.buffer.push(e),this._totalSize+=e.data.byteLength}pop(){const e=this.buffer.shift();return e&&(this._totalSize-=e.data.byteLength),e}getAll(){return this.buffer.slice()}popToSequence(e){for(;this.buffer.length>0;){if(!(this.buffer[0].sequence<=e))break;this.pop()}}alignBufferedAmount(e){for(;this.buffer.length>0;){const t=this.buffer[0];if(this._totalSize-t.data.byteLength<=e)break;this.pop()}}get length(){return this.buffer.length}}class wg{constructor(e){this._map=new Map,this._lastCleanup=0,this.ttl=e}set(e,t){const s=Date.now();s-this._lastCleanup>this.ttl/2&&this.cleanup();const i=s+this.ttl;return this._map.set(e,{value:t,expiresAt:i}),this}get(e){const t=this._map.get(e);if(t){if(!(t.expiresAt<Date.now()))return t.value;this._map.delete(e)}}has(e){const t=this._map.get(e);return!!t&&(!(t.expiresAt<Date.now())||(this._map.delete(e),!1))}delete(e){return this._map.delete(e)}clear(){this._map.clear()}cleanup(){const e=Date.now();for(const[t,s]of this._map.entries())s.expiresAt<e&&this._map.delete(t);this._lastCleanup=e}get size(){return this.cleanup(),this._map.size}forEach(e){this.cleanup();for(const[t,s]of this._map.entries())s.expiresAt>=Date.now()&&e(s.value,t,this.asValueMap())}map(e){this.cleanup();const t=[],s=this.asValueMap();for(const[i,n]of s.entries())t.push(e(n,i,s));return t}asValueMap(){const e=new Map;for(const[t,s]of this._map.entries())s.expiresAt>=Date.now()&&e.set(t,s.value);return e}}var Sg,kg,_g,Cg,Ng,Tg={},Ag={},Eg={exports:{}};function jg(){if(Sg)return Eg.exports;Sg=1;var e=Eg.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v"}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":""}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(e).forEach(function(t){e[t].forEach(function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")})}),Eg.exports}function Pg(){return kg||(kg=1,function(e){var t=function(e){return String(Number(e))===e?Number(e):e},s=function(e,s,i){var n=e.name&&e.names;e.push&&!s[e.push]?s[e.push]=[]:n&&!s[e.name]&&(s[e.name]={});var r=e.push?{}:n?s[e.name]:s;!function(e,s,i,n){if(n&&!i)s[n]=t(e[1]);else for(var r=0;r<i.length;r+=1)null!=e[r+1]&&(s[i[r]]=t(e[r+1]))}(i.match(e.reg),r,e.names,e.name),e.push&&s[e.push].push(r)},i=jg(),n=RegExp.prototype.test.bind(/^([a-z])=(.*)/);e.parse=function(e){var t={},r=[],a=t;return e.split(/(\r\n|\r|\n)/).filter(n).forEach(function(e){var t=e[0],n=e.slice(2);"m"===t&&(r.push({rtp:[],fmtp:[]}),a=r[r.length-1]);for(var o=0;o<(i[t]||[]).length;o+=1){var l=i[t][o];if(l.reg.test(n))return s(l,a,n)}}),t.media=r,t};var r=function(e,s){var i=s.split(/=(.+)/,2);return 2===i.length?e[i[0]]=t(i[1]):1===i.length&&s.length>1&&(e[i[0]]=void 0),e};e.parseParams=function(e){return e.split(/;\s?/).reduce(r,{})},e.parseFmtpConfig=e.parseParams,e.parsePayloads=function(e){return e.toString().split(" ").map(Number)},e.parseRemoteCandidates=function(e){for(var s=[],i=e.split(" ").map(t),n=0;n<i.length;n+=3)s.push({component:i[n],ip:i[n+1],port:i[n+2]});return s},e.parseImageAttributes=function(e){return e.split(" ").map(function(e){return e.substring(1,e.length-1).split(",").reduce(r,{})})},e.parseSimulcastStreamList=function(e){return e.split(";").map(function(e){return e.split(",").map(function(e){var s,i=!1;return"~"!==e[0]?s=t(e):(s=t(e.substring(1,e.length)),i=!0),{scid:s,paused:i}})})}}(Ag)),Ag}function Ig(){if(Cg)return _g;Cg=1;var e=jg(),t=/%[sdv%]/g,s=function(e){var s=1,i=arguments,n=i.length;return e.replace(t,function(e){if(s>=n)return e;var t=i[s];switch(s+=1,e){case"%%":return"%";case"%s":return String(t);case"%d":return Number(t);case"%v":return""}})},i=function(e,t,i){var n=[e+"="+(t.format instanceof Function?t.format(t.push?i:i[t.name]):t.format)];if(t.names)for(var r=0;r<t.names.length;r+=1){var a=t.names[r];t.name?n.push(i[t.name][a]):n.push(i[t.names[r]])}else n.push(i[t.name]);return s.apply(null,n)},n=["v","o","s","i","u","e","p","c","b","t","r","z","a"],r=["i","c","b","a"];return _g=function(t,s){s=s||{},null==t.version&&(t.version=0),null==t.name&&(t.name=" "),t.media.forEach(function(e){null==e.payloads&&(e.payloads="")});var a=s.outerOrder||n,o=s.innerOrder||r,l=[];return a.forEach(function(s){e[s].forEach(function(e){e.name in t&&null!=t[e.name]?l.push(i(s,e,t)):e.push in t&&null!=t[e.push]&&t[e.push].forEach(function(t){l.push(i(s,e,t))})})}),t.media.forEach(function(t){l.push(i("m",e.m[0],t)),o.forEach(function(s){e[s].forEach(function(e){e.name in t&&null!=t[e.name]?l.push(i(s,e,t)):e.push in t&&null!=t[e.push]&&t[e.push].forEach(function(t){l.push(i(s,e,t))})})})}),l.join("\r\n")+"\r\n"}}var Lg=function(){if(Ng)return Tg;Ng=1;var e=Pg(),t=Ig(),s=jg();return Tg.grammar=s,Tg.write=t,Tg.parse=e.parse,Tg.parseParams=e.parseParams,Tg.parseFmtpConfig=e.parseFmtpConfig,Tg.parsePayloads=e.parsePayloads,Tg.parseRemoteCandidates=e.parseRemoteCandidates,Tg.parseImageAttributes=e.parseImageAttributes,Tg.parseSimulcastStreamList=e.parseSimulcastStreamList,Tg}();function Rg(e,t,s){var i,n,r;void 0===t&&(t=50),void 0===s&&(s={});var a=null!=(i=s.isImmediate)&&i,o=null!=(n=s.callback)&&n,l=s.maxWait,c=Date.now(),d=[];var u=function(){var s=[].slice.call(arguments),i=this;return new Promise(function(n,u){var h=a&&void 0===r;if(void 0!==r&&clearTimeout(r),r=setTimeout(function(){if(r=void 0,c=Date.now(),!a){var t=e.apply(i,s);o&&o(t),d.forEach(function(e){return(0,e.resolve)(t)}),d=[]}},function(){if(void 0!==l){var e=Date.now()-c;if(e+t>=l)return l-e}return t}()),h){var f=e.apply(i,s);return o&&o(f),n(f)}d.push({resolve:n,reject:u})})};return u.cancel=function(e){void 0!==r&&clearTimeout(r),d.forEach(function(t){return(0,t.reject)(e)}),d=[]},u}const Og="negotiationStarted",Dg="negotiationComplete",Mg="rtpVideoPayloadTypes";class Ug extends Xh.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var s;super(),this.log=qh,this.ddExtID=0,this.latestOfferId=0,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=Rg(e=>Gh(this,void 0,void 0,function*(){this.emit(Og);try{yield this.createAndSendOffer()}catch(Tx){if(!e)throw Tx;e(Tx)}}),20),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=$h(null!==(s=t.loggerName)&&void 0!==s?s:Uh.PCTransport),this.loggerOptions=t,this.config=e,this._pc=this.createPC(),this.offerLock=new Zl}createPC(){const e=new RTCPeerConnection(this.config);return e.onicecandidate=e=>{var t;e.candidate&&(null===(t=this.onIceCandidate)||void 0===t||t.call(this,e.candidate))},e.onicecandidateerror=e=>{var t;null===(t=this.onIceCandidateError)||void 0===t||t.call(this,e)},e.oniceconnectionstatechange=()=>{var t;null===(t=this.onIceConnectionStateChange)||void 0===t||t.call(this,e.iceConnectionState)},e.onsignalingstatechange=()=>{var t;null===(t=this.onSignalingStatechange)||void 0===t||t.call(this,e.signalingState)},e.onconnectionstatechange=()=>{var t;null===(t=this.onConnectionStateChange)||void 0===t||t.call(this,e.connectionState)},e.ondatachannel=e=>{var t;null===(t=this.onDataChannel)||void 0===t||t.call(this,e)},e.ontrack=e=>{var t;null===(t=this.onTrack)||void 0===t||t.call(this,e)},e}get logContext(){var e,t;return Object.assign({},null===(t=(e=this.loggerOptions).loggerContextCb)||void 0===t?void 0:t.call(e))}get isICEConnected(){return null!==this._pc&&("connected"===this.pc.iceConnectionState||"completed"===this.pc.iceConnectionState)}addIceCandidate(e){return Gh(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(e);this.pendingCandidates.push(e)})}setRemoteDescription(e,t){return Gh(this,void 0,void 0,function*(){var s;if("answer"===e.type&&this.latestOfferId>0&&t>0&&t!==this.latestOfferId)return this.log.warn("ignoring answer for old offer",Object.assign(Object.assign({},this.logContext),{offerId:t,latestOfferId:this.latestOfferId})),!1;let i;if("offer"===e.type){let{stereoMids:t,nackMids:s}=function(e){var t;const s=[],i=[],n=Lg.parse(null!==(t=e.sdp)&&void 0!==t?t:"");let r=0;return n.media.forEach(e=>{var t;const n=qg(e.mid);"audio"===e.type&&(e.rtp.some(e=>"opus"===e.codec&&(r=e.payload,!0)),(null===(t=e.rtcpFb)||void 0===t?void 0:t.some(e=>e.payload===r&&"nack"===e.type))&&i.push(n),e.fmtp.some(e=>e.payload===r&&(e.config.includes("sprop-stereo=1")&&s.push(n),!0)))}),{stereoMids:s,nackMids:i}}(e);this.remoteStereoMids=t,this.remoteNackMids=s}else if("answer"===e.type){const t=Lg.parse(null!==(s=e.sdp)&&void 0!==s?s:"");t.media.forEach(e=>{const t=qg(e.mid);"audio"===e.type&&this.trackBitrates.some(s=>{if(!s.transceiver||t!=s.transceiver.mid)return!1;let i=0;if(e.rtp.some(e=>e.codec.toUpperCase()===s.codec.toUpperCase()&&(i=e.payload,!0)),0===i)return!0;let n=!1;for(const t of e.fmtp)if(t.payload===i){t.config=t.config.split(";").filter(e=>!e.includes("maxaveragebitrate")).join(";"),s.maxbr>0&&(t.config+=";maxaveragebitrate=".concat(1e3*s.maxbr)),n=!0;break}return n||s.maxbr>0&&e.fmtp.push({payload:i,config:"maxaveragebitrate=".concat(1e3*s.maxbr)}),!0})}),i=Lg.write(t)}if(yield this.setMungedSDP(e,i,!0),this.pendingCandidates.forEach(e=>{this.pc.addIceCandidate(e)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate)this.renegotiate=!1,yield this.createAndSendOffer();else if("answer"===e.type&&(this.emit(Dg),e.sdp)){Lg.parse(e.sdp).media.forEach(e=>{"video"===e.type&&this.emit(Mg,e.rtp)})}return!0})}createAndSendOffer(e){return Gh(this,void 0,void 0,function*(){var t;const s=yield this.offerLock.lock();try{if(void 0===this.onOffer)return;if((null==e?void 0:e.iceRestart)&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&"have-local-offer"===this._pc.signalingState){const t=this._pc.remoteDescription;if(!(null==e?void 0:e.iceRestart)||!t)return void(this.renegotiate=!0);yield this._pc.setRemoteDescription(t)}else if(!this._pc||"closed"===this._pc.signalingState)return void this.log.warn("could not createOffer with closed peer connection",this.logContext);this.log.debug("starting to negotiate",this.logContext);const s=this.latestOfferId+1;this.latestOfferId=s;const i=yield this.pc.createOffer(e);this.log.debug("original offer",Object.assign({sdp:i.sdp},this.logContext));const n=Lg.parse(null!==(t=i.sdp)&&void 0!==t?t:"");if(n.media.forEach(e=>{Bg(e),"audio"===e.type?Fg(e,[],[]):"video"===e.type&&this.trackBitrates.some(t=>{if(!e.msid||!t.cid||!e.msid.includes(t.cid))return!1;let s=0;if(e.rtp.some(e=>e.codec.toUpperCase()===t.codec.toUpperCase()&&(s=e.payload,!0)),0===s)return!0;if(fp(t.codec)&&!gp()&&this.ensureVideoDDExtensionForSVC(e,n),"av1"!==t.codec)return!0;const i=Math.round(.7*t.maxbr);for(const n of e.fmtp)if(n.payload===s){n.config.includes("x-google-start-bitrate")||(n.config+=";x-google-start-bitrate=".concat(i));break}return!0})}),this.latestOfferId>s)return void this.log.warn("latestOfferId mismatch",Object.assign(Object.assign({},this.logContext),{latestOfferId:this.latestOfferId,offerId:s}));yield this.setMungedSDP(i,Lg.write(n)),this.onOffer(i,this.latestOfferId)}finally{s()}})}createAndSetAnswer(){return Gh(this,void 0,void 0,function*(){var e;const t=yield this.pc.createAnswer(),s=Lg.parse(null!==(e=t.sdp)&&void 0!==e?e:"");return s.media.forEach(e=>{Bg(e),"audio"===e.type&&Fg(e,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(t,Lg.write(s)),t})}createDataChannel(e,t){return this.pc.createDataChannel(e,t)}addTransceiver(e,t){return this.pc.addTransceiver(e,t)}addTrack(e){if(!this._pc)throw new Rm("PC closed, cannot add track");return this._pc.addTrack(e)}setTrackCodecBitrate(e){this.trackBitrates.push(e)}setConfiguration(e){var t;if(!this._pc)throw new Rm("PC closed, cannot configure");return null===(t=this._pc)||void 0===t?void 0:t.setConfiguration(e)}canRemoveTrack(){var e;return!!(null===(e=this._pc)||void 0===e?void 0:e.removeTrack)}removeTrack(e){var t;return null===(t=this._pc)||void 0===t?void 0:t.removeTrack(e)}getConnectionState(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.connectionState)&&void 0!==t?t:"closed"}getICEConnectionState(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.iceConnectionState)&&void 0!==t?t:"closed"}getSignallingState(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.signalingState)&&void 0!==t?t:"closed"}getTransceivers(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.getTransceivers())&&void 0!==t?t:[]}getSenders(){var e,t;return null!==(t=null===(e=this._pc)||void 0===e?void 0:e.getSenders())&&void 0!==t?t:[]}getLocalDescription(){var e;return null===(e=this._pc)||void 0===e?void 0:e.localDescription}getRemoteDescription(){var e;return null===(e=this.pc)||void 0===e?void 0:e.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return Gh(this,void 0,void 0,function*(){var e;if(!this._pc)return;let t="";const s=new Map,i=new Map;if((yield this._pc.getStats()).forEach(e=>{switch(e.type){case"transport":t=e.selectedCandidatePairId;break;case"candidate-pair":""===t&&e.selected&&(t=e.id),s.set(e.id,e);break;case"remote-candidate":i.set(e.id,"".concat(e.address,":").concat(e.port))}}),""===t)return;const n=null===(e=s.get(t))||void 0===e?void 0:e.remoteCandidateId;return void 0!==n?i.get(n):void 0})}setMungedSDP(e,t,s){return Gh(this,void 0,void 0,function*(){if(t){const i=e.sdp;e.sdp=t;try{return this.log.debug("setting munged ".concat(s?"remote":"local"," description"),this.logContext),void(s?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e))}catch(Tx){this.log.warn("not able to set ".concat(e.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:Tx,sdp:t})),e.sdp=i}}try{s?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e)}catch(Tx){let i="unknown error";Tx instanceof Error?i=Tx.message:"string"==typeof Tx&&(i=Tx);const n={error:i,sdp:e.sdp};throw!s&&this.pc.remoteDescription&&(n.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat(e.type),Object.assign(Object.assign({},this.logContext),{fields:n})),new Om(i)}})}ensureVideoDDExtensionForSVC(e,t){var s,i;if(!(null===(s=e.ext)||void 0===s?void 0:s.some(e=>e.uri===cp))){if(0===this.ddExtID){let e=0;t.media.forEach(t=>{var s;"video"===t.type&&(null===(s=t.ext)||void 0===s||s.forEach(t=>{t.value>e&&(e=t.value)}))}),this.ddExtID=e+1}null===(i=e.ext)||void 0===i||i.push({value:this.ddExtID,uri:cp})}}}function Fg(e,t,s){const i=qg(e.mid);let n=0;e.rtp.some(e=>"opus"===e.codec&&(n=e.payload,!0)),n>0&&(e.rtcpFb||(e.rtcpFb=[]),s.includes(i)&&!e.rtcpFb.some(e=>e.payload===n&&"nack"===e.type)&&e.rtcpFb.push({payload:n,type:"nack"}),t.includes(i)&&e.fmtp.some(e=>e.payload===n&&(e.config.includes("stereo=1")||(e.config+=";stereo=1"),!0)))}function Bg(e){if(e.connection){const t=e.connection.ip.indexOf(":")>=0;(4===e.connection.version&&t||6===e.connection.version&&!t)&&(e.connection.ip="0.0.0.0",e.connection.version=4)}}function qg(e){return"number"==typeof e?e.toFixed(0):e}const $g="vp8",zg={audioPreset:np.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:lp.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:$g,backupCodec:!0,preConnectBuffer:!1},Hg={deviceId:{ideal:"default"},autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,voiceIsolation:!0},Vg={deviceId:{ideal:"default"},resolution:ap.h720.resolution},Gg={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new class{constructor(e){this._retryDelays=void 0!==e?[...e]:Vh}nextRetryDelayInMs(e){if(e.retryCount>=this._retryDelays.length)return null;const t=this._retryDelays[e.retryCount];return e.retryCount<=1?t:t+1e3*Math.random()}},disconnectOnPageLeave:!0,webAudioMix:!1},Jg={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var Wg,Kg;(Kg=Wg||(Wg={}))[Kg.NEW=0]="NEW",Kg[Kg.CONNECTING=1]="CONNECTING",Kg[Kg.CONNECTED=2]="CONNECTED",Kg[Kg.FAILED=3]="FAILED",Kg[Kg.CLOSING=4]="CLOSING",Kg[Kg.CLOSED=5]="CLOSED";class Yg{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(e,t,s){var i;this.peerConnectionTimeout=Jg.peerConnectionTimeout,this.log=qh,this.updateState=()=>{var e;const t=this.state,s=this.requiredTransports.map(e=>e.getConnectionState());s.every(e=>"connected"===e)?this.state=Wg.CONNECTED:s.some(e=>"failed"===e)?this.state=Wg.FAILED:s.some(e=>"connecting"===e)?this.state=Wg.CONNECTING:s.every(e=>"closed"===e)?this.state=Wg.CLOSED:s.some(e=>"closed"===e)?this.state=Wg.CLOSING:s.every(e=>"new"===e)&&(this.state=Wg.NEW),t!==this.state&&(this.log.debug("pc state change: from ".concat(Wg[t]," to ").concat(Wg[this.state]),this.logContext),null===(e=this.onStateChange)||void 0===e||e.call(this,this.state,this.publisher.getConnectionState(),this.subscriber.getConnectionState()))},this.log=$h(null!==(i=s.loggerName)&&void 0!==i?i:Uh.PCManager),this.loggerOptions=s,this.isPublisherConnectionRequired=!t,this.isSubscriberConnectionRequired=t,this.publisher=new Ug(e,s),this.subscriber=new Ug(e,s),this.publisher.onConnectionStateChange=this.updateState,this.subscriber.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=e=>{var t;null===(t=this.onIceCandidate)||void 0===t||t.call(this,e,Ou.PUBLISHER)},this.subscriber.onIceCandidate=e=>{var t;null===(t=this.onIceCandidate)||void 0===t||t.call(this,e,Ou.SUBSCRIBER)},this.subscriber.onDataChannel=e=>{var t;null===(t=this.onDataChannel)||void 0===t||t.call(this,e)},this.subscriber.onTrack=e=>{var t;null===(t=this.onTrack)||void 0===t||t.call(this,e)},this.publisher.onOffer=(e,t)=>{var s;null===(s=this.onPublisherOffer)||void 0===s||s.call(this,e,t)},this.state=Wg.NEW,this.connectionLock=new Zl,this.remoteOfferLock=new Zl}get logContext(){var e,t;return Object.assign({},null===(t=(e=this.loggerOptions).loggerContextCb)||void 0===t?void 0:t.call(e))}requirePublisher(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.isPublisherConnectionRequired=e,this.updateState()}requireSubscriber(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.isSubscriberConnectionRequired=e,this.updateState()}createAndSendPublisherOffer(e){return this.publisher.createAndSendOffer(e)}setPublisherAnswer(e,t){return this.publisher.setRemoteDescription(e,t)}removeTrack(e){return this.publisher.removeTrack(e)}close(){return Gh(this,void 0,void 0,function*(){if(this.publisher&&"closed"!==this.publisher.getSignallingState()){const e=this.publisher;for(const t of e.getSenders())try{e.canRemoveTrack()&&e.removeTrack(t)}catch(Tx){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:Tx}))}}yield Promise.all([this.publisher.close(),this.subscriber.close()]),this.updateState()})}triggerIceRestart(){return Gh(this,void 0,void 0,function*(){this.subscriber.restartingIce=!0,this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate(e,t){return Gh(this,void 0,void 0,function*(){t===Ou.PUBLISHER?yield this.publisher.addIceCandidate(e):yield this.subscriber.addIceCandidate(e)})}createSubscriberAnswerFromOffer(e,t){return Gh(this,void 0,void 0,function*(){this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,signalingState:this.subscriber.getSignallingState().toString()}));const s=yield this.remoteOfferLock.lock();try{if(!(yield this.subscriber.setRemoteDescription(e,t)))return;return yield this.subscriber.createAndSetAnswer()}finally{s()}})}updateConfiguration(e,t){this.publisher.setConfiguration(e),this.subscriber.setConfiguration(e),t&&this.triggerIceRestart()}ensurePCTransportConnection(e,t){return Gh(this,void 0,void 0,function*(){var s;const i=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&"connected"!==this.publisher.getConnectionState()&&"connecting"!==this.publisher.getConnectionState()&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all(null===(s=this.requiredTransports)||void 0===s?void 0:s.map(s=>this.ensureTransportConnected(s,e,t)))}finally{i()}})}negotiate(e){return Gh(this,void 0,void 0,function*(){return new Promise((t,s)=>Gh(this,void 0,void 0,function*(){const i=setTimeout(()=>{s("negotiation timed out")},this.peerConnectionTimeout);e.signal.addEventListener("abort",()=>{clearTimeout(i),s("negotiation aborted")}),this.publisher.once(Og,()=>{e.signal.aborted||this.publisher.once(Dg,()=>{clearTimeout(i),t()})}),yield this.publisher.negotiate(e=>{clearTimeout(i),s(e)})}))})}addPublisherTransceiver(e,t){return this.publisher.addTransceiver(e,t)}addPublisherTrack(e){return this.publisher.addTrack(e)}createPublisherDataChannel(e,t){return this.publisher.createDataChannel(e,t)}getConnectedAddress(e){return e===Ou.PUBLISHER||e===Ou.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const e=[];return this.isPublisherConnectionRequired&&e.push(this.publisher),this.isSubscriberConnectionRequired&&e.push(this.subscriber),e}ensureTransportConnected(e,t){return Gh(this,arguments,void 0,function(e,t){var s=this;let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.peerConnectionTimeout;return function*(){if("connected"!==e.getConnectionState())return new Promise((e,n)=>Gh(s,void 0,void 0,function*(){const s=()=>{this.log.warn("abort transport connection",this.logContext),Vm.clearTimeout(r),n(new jm("room connection has been cancelled",um.Cancelled))};(null==t?void 0:t.signal.aborted)&&s(),null==t||t.signal.addEventListener("abort",s);const r=Vm.setTimeout(()=>{null==t||t.signal.removeEventListener("abort",s),n(new jm("could not establish pc connection",um.InternalError))},i);for(;this.state!==Wg.CONNECTED;)if(yield dp(50),null==t?void 0:t.signal.aborted)return void n(new jm("room connection has been cancelled",um.Cancelled));Vm.clearTimeout(r),null==t||t.signal.removeEventListener("abort",s),e()}))}()})}}class Xg extends Error{constructor(e,t,s){super(t),this.code=e,this.message=Zg(t,Xg.MAX_MESSAGE_BYTES),this.data=s?Zg(s,Xg.MAX_DATA_BYTES):void 0}static fromProto(e){return new Xg(e.code,e.message,e.data)}toProto(){return new bu({code:this.code,message:this.message,data:this.data})}static builtIn(e,t){return new Xg(Xg.ErrorCode[e],Xg.ErrorMessage[e],t)}}Xg.MAX_MESSAGE_BYTES=256,Xg.MAX_DATA_BYTES=15360,Xg.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404},Xg.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};function Qg(e){return(new TextEncoder).encode(e).length}function Zg(e,t){if(Qg(e)<=t)return e;let s=0,i=e.length;const n=new TextEncoder;for(;s<i;){const r=Math.floor((s+i+1)/2);n.encode(e.slice(0,r)).length<=t?s=r:i=r-1}return e.slice(0,s)}const ev=2e3;function tv(e,t){if(!t)return 0;let s,i;return"bytesReceived"in e?(s=e.bytesReceived,i=t.bytesReceived):"bytesSent"in e&&(s=e.bytesSent,i=t.bytesSent),void 0===s||void 0===i||void 0===e.timestamp||void 0===t.timestamp?0:8*(s-i)*1e3/(e.timestamp-t.timestamp)}const sv="undefined"!=typeof MediaRecorder;const iv=sv?MediaRecorder:class{constructor(){throw new Error("MediaRecorder is not available in this environment")}};class nv extends iv{constructor(e,t){if(!sv)throw new Error("MediaRecorder is not available in this environment");let s,i;super(new MediaStream([e.mediaStreamTrack]),t);const n=()=>{this.removeEventListener("dataavailable",s),this.removeEventListener("stop",n),this.removeEventListener("error",r),null==i||i.close(),i=void 0},r=e=>{null==i||i.error(e),this.removeEventListener("dataavailable",s),this.removeEventListener("stop",n),this.removeEventListener("error",r),i=void 0};this.byteStream=new ReadableStream({start:e=>{i=e,s=t=>Gh(this,void 0,void 0,function*(){let s;if(t.data.arrayBuffer){const e=yield t.data.arrayBuffer();s=new Uint8Array(e)}else{if(!t.data.byteArray)throw new Error("no data available!");s=t.data.byteArray}void 0!==i&&e.enqueue(s)}),this.addEventListener("dataavailable",s)},cancel:()=>{n()}}),this.addEventListener("stop",n),this.addEventListener("error",r)}}class rv extends Km{get sender(){return this._sender}set sender(e){this._sender=e}get constraints(){return this._constraints}get hasPreConnectBuffer(){return!!this.localTrackRecorder}constructor(e,t,s){let i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];super(e,t,arguments.length>4?arguments[4]:void 0),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=Rg(()=>Gh(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>Gh(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(Cm.Ended,this)},this.reacquireTrack=!1,this.providedByUser=i,this.muteLock=new Zl,this.pauseUpstreamLock=new Zl,this.trackChangeLock=new Zl,this.trackChangeLock.lock().then(t=>Gh(this,void 0,void 0,function*(){try{yield this.setMediaStreamTrack(e,!0)}finally{t()}})),this._constraints=e.getConstraints(),s&&(this._constraints=s)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==Km.Kind.Video)return;const{width:e,height:t}=this._mediaStreamTrack.getSettings();return e&&t?{width:e,height:t}:void 0}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var e,t;return null!==(t=null===(e=this.processor)||void 0===e?void 0:e.processedTrack)&&void 0!==t?t:this._mediaStreamTrack}get isLocal(){return!0}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack(e,t){return Gh(this,void 0,void 0,function*(){var s;if(e===this._mediaStreamTrack&&!t)return;let i;if(this._mediaStreamTrack&&(this.attachedElements.forEach(e=>{Xm(this._mediaStreamTrack,e)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([e]),e&&(e.addEventListener("ended",this.handleEnded),e.addEventListener("mute",this.handleTrackMuteEvent),e.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=e.getConstraints()),this.processor&&e){if(this.log.debug("restarting processor",this.logContext),"unknown"===this.kind)throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&(Ym(e,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:e,kind:this.kind,element:this.processorElement}),i=this.processor.processedTrack}this.sender&&"closed"!==(null===(s=this.sender.transport)||void 0===s?void 0:s.state)&&(yield this.sender.replaceTrack(null!=i?i:e)),this.providedByUser||this._mediaStreamTrack===e||this._mediaStreamTrack.stop(),this._mediaStreamTrack=e,e&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(t=>{Ym(null!=i?i:e,t)}))})}waitForDimensions(){return Gh(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;return function*(){var s;if(e.kind===Km.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");"iOS"===(null===(s=qm())||void 0===s?void 0:s.os)&&(yield dp(10));const i=Date.now();for(;Date.now()-i<t;){const t=e.dimensions;if(t)return t;yield dp(50)}throw new Im("unable to get track dimensions after timeout")}()})}setDeviceId(e){return Gh(this,void 0,void 0,function*(){return this._constraints.deviceId===e&&this._mediaStreamTrack.getSettings().deviceId===Dp(e)||(this._constraints.deviceId=e,!!this.isMuted||(yield this.restartTrack(),Dp(e)===this._mediaStreamTrack.getSettings().deviceId))})}getDeviceId(){return Gh(this,arguments,void 0,function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return function*(){if(e.source===Km.Source.ScreenShare)return;const{deviceId:s,groupId:i}=e._mediaStreamTrack.getSettings(),n=e.kind===Km.Kind.Audio?"audioinput":"videoinput";return t?cg.getInstance().normalizeDeviceId(n,s,i):s}()})}mute(){return Gh(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return Gh(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack(e,t){return Gh(this,void 0,void 0,function*(){const s=yield this.trackChangeLock.lock();try{if(!this.sender)throw new Im("unable to replace an unpublished track");let s,i;return"boolean"==typeof t?s=t:void 0!==t&&(s=t.userProvidedTrack,i=t.stopProcessor),this.providedByUser=null==s||s,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(e),i&&this.processor&&(yield this.internalStopProcessor()),this}finally{s()}})}restart(e){return Gh(this,void 0,void 0,function*(){this.manuallyStopped=!1;const t=yield this.trackChangeLock.lock();try{e||(e=this._constraints);const{deviceId:t,facingMode:s}=e,i=function(e,t){var s={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(s[i]=e[i]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var n=0;for(i=Object.getOwnPropertySymbols(e);n<i.length;n++)t.indexOf(i[n])<0&&Object.prototype.propertyIsEnumerable.call(e,i[n])&&(s[i[n]]=e[i[n]])}return s}(e,["deviceId","facingMode"]);this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:e}));const n={audio:!1,video:!1};this.kind===Km.Kind.Video?n.video=!t&&!s||{deviceId:t,facingMode:s}:n.audio=!t||Object.assign({deviceId:t},i),this.attachedElements.forEach(e=>{Xm(this.mediaStreamTrack,e)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const r=(yield navigator.mediaDevices.getUserMedia(n)).getTracks()[0];return this.kind===Km.Kind.Video&&(yield r.applyConstraints(i)),r.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(r),this._constraints=e,this.emit(Cm.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{t()}})}setTrackMuted(e){this.log.debug("setting ".concat(this.kind," track ").concat(e?"muted":"unmuted"),this.logContext),this.isMuted===e&&this._mediaStreamTrack.enabled!==e||(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?Cm.Muted:Cm.Unmuted,this))}get needsReAcquisition(){return"live"!==this._mediaStreamTrack.readyState||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return Gh(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),yp()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),this.isInBackground||!this.needsReAcquisition||this.isUserProvided||this.isMuted||(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var e;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),null===(e=this.processor)||void 0===e||e.destroy(),this.processor=void 0}pauseUpstream(){return Gh(this,void 0,void 0,function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(!0===this._isUpstreamPaused)return;if(!this.sender)return void this.log.warn("unable to pause upstream for an unpublished track",this.logContext);this._isUpstreamPaused=!0,this.emit(Cm.UpstreamPaused,this);const t=qm();if("Safari"===(null==t?void 0:t.name)&&Cp(t.version,"12.0")<0)throw new Pm("pauseUpstream is not supported on Safari < 12.");"closed"!==(null===(e=this.sender.transport)||void 0===e?void 0:e.state)&&(yield this.sender.replaceTrack(null))}finally{t()}})}resumeUpstream(){return Gh(this,void 0,void 0,function*(){var e;const t=yield this.pauseUpstreamLock.lock();try{if(!1===this._isUpstreamPaused)return;if(!this.sender)return void this.log.warn("unable to resume upstream for an unpublished track",this.logContext);this._isUpstreamPaused=!1,this.emit(Cm.UpstreamResumed,this),"closed"!==(null===(e=this.sender.transport)||void 0===e?void 0:e.state)&&(yield this.sender.replaceTrack(this.mediaStreamTrack))}finally{t()}})}getRTCStatsReport(){return Gh(this,void 0,void 0,function*(){var e;if(!(null===(e=this.sender)||void 0===e?void 0:e.getStats))return;return yield this.sender.getStats()})}setProcessor(e){return Gh(this,arguments,void 0,function(e){var t=this;let s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function*(){var i;const n=yield t.trackChangeLock.lock();try{t.log.debug("setting up processor",t.logContext);const n=document.createElement(t.kind),r={kind:t.kind,track:t._mediaStreamTrack,element:n,audioContext:t.audioContext};if(yield e.init(r),t.log.debug("processor initialized",t.logContext),t.processor&&(yield t.internalStopProcessor()),"unknown"===t.kind)throw TypeError("cannot set processor on track of unknown kind");if(Ym(t._mediaStreamTrack,n),n.muted=!0,n.play().catch(e=>{e instanceof DOMException&&"AbortError"===e.name?(t.log.warn("failed to play processor element, retrying",Object.assign(Object.assign({},t.logContext),{error:e})),setTimeout(()=>{n.play().catch(e=>{t.log.error("failed to play processor element",Object.assign(Object.assign({},t.logContext),{err:e}))})},100)):t.log.error("failed to play processor element",Object.assign(Object.assign({},t.logContext),{error:e}))}),t.processor=e,t.processorElement=n,t.processor.processedTrack){for(const e of t.attachedElements)e!==t.processorElement&&s&&(Xm(t._mediaStreamTrack,e),Ym(t.processor.processedTrack,e));yield null===(i=t.sender)||void 0===i?void 0:i.replaceTrack(t.processor.processedTrack)}t.emit(Cm.TrackProcessorUpdate,t.processor)}finally{n()}}()})}getProcessor(){return this.processor}stopProcessor(){return Gh(this,arguments,void 0,function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return function*(){const s=yield e.trackChangeLock.lock();try{yield e.internalStopProcessor(t)}finally{s()}}()})}internalStopProcessor(){return Gh(this,arguments,void 0,function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return function*(){var s,i;e.processor&&(e.log.debug("stopping processor",e.logContext),null===(s=e.processor.processedTrack)||void 0===s||s.stop(),yield e.processor.destroy(),e.processor=void 0,t||(null===(i=e.processorElement)||void 0===i||i.remove(),e.processorElement=void 0),yield e._mediaStreamTrack.applyConstraints(e._constraints),yield e.setMediaStreamTrack(e._mediaStreamTrack,!0),e.emit(Cm.TrackProcessorUpdate))}()})}startPreConnectBuffer(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100;if(sv)if(this.localTrackRecorder)this.log.warn("preconnect buffer already started");else{{let e="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(e)||(e="video/mp4"),this.localTrackRecorder=new nv(this,{mimeType:e})}this.localTrackRecorder.start(e),this.autoStopPreConnectBuffer=setTimeout(()=>{this.log.warn("preconnect buffer timed out, stopping recording automatically",this.logContext),this.stopPreConnectBuffer()},1e4)}else this.log.warn("MediaRecorder is not available, cannot start preconnect buffer",this.logContext)}stopPreConnectBuffer(){clearTimeout(this.autoStopPreConnectBuffer),this.localTrackRecorder&&(this.localTrackRecorder.stop(),this.localTrackRecorder=void 0)}getPreConnectBuffer(){var e;return null===(e=this.localTrackRecorder)||void 0===e?void 0:e.byteStream}getPreConnectBufferMimeType(){var e;return null===(e=this.localTrackRecorder)||void 0===e?void 0:e.mimeType}}class av extends rv{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor(e,t){let s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3?arguments[3]:void 0,n=arguments.length>4?arguments[4]:void 0;super(e,Km.Kind.Audio,t,s,n),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>Gh(this,void 0,void 0,function*(){if(!this.sender)return void(this._currentBitrate=0);let e;try{e=yield this.getSenderStats()}catch(Tx){return void this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:Tx}))}e&&this.prevStats&&(this._currentBitrate=tv(e,this.prevStats)),this.prevStats=e}),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(Cm.AudioTrackFeatureUpdate,this,Kd.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(Cm.AudioTrackFeatureUpdate,this,Kd.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=i,this.checkForSilence()}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return Gh(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===Km.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return Gh(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;const t=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==Dp(this._constraints.deviceId);return this.source!==Km.Source.Microphone||!this.stopOnMute&&"ended"!==this._mediaStreamTrack.readyState&&!t||this.isUserProvided||(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this}finally{t()}})}restartTrack(e){return Gh(this,void 0,void 0,function*(){let t;if(e){const s=Xp({audio:e});"boolean"!=typeof s.audio&&(t=s.audio)}yield this.restart(t)})}restart(e){const t=Object.create(null,{restart:{get:()=>super.restart}});return Gh(this,void 0,void 0,function*(){const s=yield t.restart.call(this,e);return this.checkForSilence(),s})}startMonitor(){bp()&&(this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},ev)))}setProcessor(e){return Gh(this,void 0,void 0,function*(){var t;const s=yield this.trackChangeLock.lock();try{if(!xp()&&!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.internalStopProcessor());const s={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(e.name),this.logContext),yield e.init(s),this.processor=e,this.processor.processedTrack&&(yield null===(t=this.sender)||void 0===t?void 0:t.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(Cm.TrackProcessorUpdate,this.processor)}finally{s()}})}setAudioContext(e){this.audioContext=e}getSenderStats(){return Gh(this,void 0,void 0,function*(){var e;if(!(null===(e=this.sender)||void 0===e?void 0:e.getStats))return;let t;return(yield this.sender.getStats()).forEach(e=>{"outbound-rtp"===e.type&&(t={type:"audio",streamId:e.id,packetsSent:e.packetsSent,packetsLost:e.packetsLost,bytesSent:e.bytesSent,timestamp:e.timestamp,roundTripTime:e.roundTripTime,jitter:e.jitter})}),t})}checkForSilence(){return Gh(this,void 0,void 0,function*(){const e=yield Qp(this);return e&&(this.isMuted||this.log.warn("silence detected on local audio track",this.logContext),this.emit(Cm.AudioSilenceDetected)),e})}}const ov=Object.values(ap),lv=Object.values(op),cv=Object.values(lp),dv=[ap.h180,ap.h360],uv=[op.h180,op.h360],hv=["q","h","f"];function fv(e,t,s,i){var n,r;let a=null==i?void 0:i.videoEncoding;e&&(a=null==i?void 0:i.screenShareEncoding);const o=null==i?void 0:i.simulcast,l=null==i?void 0:i.scalabilityMode,c=null==i?void 0:i.videoCodec;if(!a&&!o&&!l||!t||!s)return[{}];a||(a=function(e,t,s,i){const n=function(e,t,s){if(e)return cv;const i=t>s?t/s:s/t;if(Math.abs(i-16/9)<Math.abs(i-4/3))return ov;return lv}(e,t,s);let{encoding:r}=n[0];const a=Math.max(t,s);for(let o=0;o<n.length;o+=1){const e=n[o];if(r=e.encoding,e.width>=a)break}if(i)switch(i){case"av1":case"h265":r=Object.assign({},r),r.maxBitrate=.7*r.maxBitrate;break;case"vp9":r=Object.assign({},r),r.maxBitrate=.85*r.maxBitrate}return r}(e,t,s,c),qh.debug("using video encoding",a));const d=a.maxFramerate,u=new Qm(t,s,a.maxBitrate,a.maxFramerate,a.priority);if(l&&fp(c)){const e=new vv(l),t=[];if(e.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(l));const s=qm();if(vp()||xp()||"Chrome"===(null==s?void 0:s.name)&&Cp(null==s?void 0:s.version,"113")<0){const i="h"==e.suffix?2:3,n=function(e){return e||(e=qm()),"Safari"===(null==e?void 0:e.name)&&Cp(e.version,"18.3")>0||"iOS"===(null==e?void 0:e.os)&&!!(null==e?void 0:e.osVersion)&&Cp(e.osVersion,"18.3")>0}(s);for(let s=0;s<e.spatial;s+=1)t.push({rid:hv[2-s],maxBitrate:a.maxBitrate/Math.pow(i,s),maxFramerate:u.encoding.maxFramerate,scaleResolutionDownBy:n?Math.pow(2,s):void 0});t[0].scalabilityMode=l}else t.push({maxBitrate:a.maxBitrate,maxFramerate:u.encoding.maxFramerate,scalabilityMode:l});return u.encoding.priority&&(t[0].priority=u.encoding.priority,t[0].networkPriority=u.encoding.priority),qh.debug("using svc encoding",{encodings:t}),t}if(!o)return[a];let h,f=[];if(f=e?null!==(n=gv(null==i?void 0:i.screenShareSimulcastLayers))&&void 0!==n?n:mv(e,u):null!==(r=gv(null==i?void 0:i.videoSimulcastLayers))&&void 0!==r?r:mv(e,u),f.length>0){const e=f[0];f.length>1&&([,h]=f);const i=Math.max(t,s);if(i>=960&&h)return pv(t,s,[e,h,u],d);if(i>=480)return pv(t,s,[e,u],d)}return pv(t,s,[u])}function mv(e,t){if(e)return[{scaleResolutionDownBy:2,fps:(s=t).encoding.maxFramerate}].map(e=>{var t,i;return new Qm(Math.floor(s.width/e.scaleResolutionDownBy),Math.floor(s.height/e.scaleResolutionDownBy),Math.max(15e4,Math.floor(s.encoding.maxBitrate/(Math.pow(e.scaleResolutionDownBy,2)*((null!==(t=s.encoding.maxFramerate)&&void 0!==t?t:30)/(null!==(i=e.fps)&&void 0!==i?i:30))))),e.fps,s.encoding.priority)});var s;const{width:i,height:n}=t,r=i>n?i/n:n/i;return Math.abs(r-16/9)<Math.abs(r-4/3)?dv:uv}function pv(e,t,s,i){const n=[];if(s.forEach((s,r)=>{if(r>=hv.length)return;const a=Math.min(e,t),o={rid:hv[r],scaleResolutionDownBy:Math.max(1,a/Math.min(s.width,s.height)),maxBitrate:s.encoding.maxBitrate},l=i&&s.encoding.maxFramerate?Math.min(i,s.encoding.maxFramerate):s.encoding.maxFramerate;l&&(o.maxFramerate=l);const c=pp()||0===r;s.encoding.priority&&c&&(o.priority=s.encoding.priority,o.networkPriority=s.encoding.priority),n.push(o)}),xp()&&"ios"===kp()){let e;n.forEach(t=>{e?t.maxFramerate&&t.maxFramerate>e&&(e=t.maxFramerate):e=t.maxFramerate});let t=!0;n.forEach(s=>{var i;s.maxFramerate!=e&&(t&&(t=!1,qh.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),qh.info('Setting framerate of encoding "'.concat(null!==(i=s.rid)&&void 0!==i?i:"",'" to ').concat(e)),s.maxFramerate=e)})}return n}function gv(e){if(e)return e.sort((e,t)=>{const{encoding:s}=e,{encoding:i}=t;return s.maxBitrate>i.maxBitrate?1:s.maxBitrate<i.maxBitrate?-1:s.maxBitrate===i.maxBitrate&&s.maxFramerate&&i.maxFramerate?s.maxFramerate>i.maxFramerate?1:-1:0})}class vv{constructor(e){const t=e.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!t)throw new Error("invalid scalability mode");if(this.spatial=parseInt(t[1]),this.temporal=parseInt(t[2]),t.length>3)switch(t[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=t[3]}}toString(){var e;return"L".concat(this.spatial,"T").concat(this.temporal).concat(null!==(e=this.suffix)&&void 0!==e?e:"")}}class yv extends rv{get sender(){return this._sender}set sender(e){this._sender=e,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor(e,t){let s=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=arguments.length>3?arguments[3]:void 0;super(e,Km.Kind.Video,t,s,i),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.isCpuConstrained=!1,this.optimizeForPerformance=!1,this.monitorSender=()=>Gh(this,void 0,void 0,function*(){if(!this.sender)return void(this._currentBitrate=0);let e;try{e=yield this.getSenderStats()}catch(Tx){return void this.log.error("could not get video sender stats",Object.assign(Object.assign({},this.logContext),{error:Tx}))}const t=new Map(e.map(e=>[e.rid,e])),s=e.some(e=>"cpu"===e.qualityLimitationReason);if(s!==this.isCpuConstrained&&(this.isCpuConstrained=s,this.isCpuConstrained&&this.emit(Cm.CpuConstrained)),this.prevStats){let e=0;t.forEach((t,s)=>{var i;const n=null===(i=this.prevStats)||void 0===i?void 0:i.get(s);e+=tv(t,n)}),this._currentBitrate=e}this.prevStats=t}),this.senderLock=new Zl}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(e){var t;if(this.signalClient=e,!bp())return;const s=null===(t=this.sender)||void 0===t?void 0:t.getParameters();s&&(this.encodings=s.encodings),this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},ev))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach(e=>{e.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){const e=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return Gh(this,void 0,void 0,function*(){var t,s,i,n,r;yield e.pauseUpstream.call(this);try{for(var a,o=!0,l=Wh(this.simulcastCodecs.values());!(t=(a=yield l.next()).done);o=!0){n=a.value,o=!1;const e=n;yield null===(r=e.sender)||void 0===r?void 0:r.replaceTrack(null)}}catch(c){s={error:c}}finally{try{o||t||!(i=l.return)||(yield i.call(l))}finally{if(s)throw s.error}}})}resumeUpstream(){const e=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return Gh(this,void 0,void 0,function*(){var t,s,i,n,r;yield e.resumeUpstream.call(this);try{for(var a,o=!0,l=Wh(this.simulcastCodecs.values());!(t=(a=yield l.next()).done);o=!0){n=a.value,o=!1;const e=n;yield null===(r=e.sender)||void 0===r?void 0:r.replaceTrack(e.mediaStreamTrack)}}catch(c){s={error:c}}finally{try{o||t||!(i=l.return)||(yield i.call(l))}finally{if(s)throw s.error}}})}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return Gh(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source!==Km.Source.Camera||this.isUserProvided||(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return Gh(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.source!==Km.Source.Camera||this.isUserProvided||(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this):(this.log.debug("Track already unmuted",this.logContext),this)}finally{t()}})}setTrackMuted(e){super.setTrackMuted(e);for(const t of this.simulcastCodecs.values())t.mediaStreamTrack.enabled=!e}getSenderStats(){return Gh(this,void 0,void 0,function*(){var e;if(!(null===(e=this.sender)||void 0===e?void 0:e.getStats))return[];const t=[],s=yield this.sender.getStats();return s.forEach(e=>{var i;if("outbound-rtp"===e.type){const n={type:"video",streamId:e.id,frameHeight:e.frameHeight,frameWidth:e.frameWidth,framesPerSecond:e.framesPerSecond,framesSent:e.framesSent,firCount:e.firCount,pliCount:e.pliCount,nackCount:e.nackCount,packetsSent:e.packetsSent,bytesSent:e.bytesSent,qualityLimitationReason:e.qualityLimitationReason,qualityLimitationDurations:e.qualityLimitationDurations,qualityLimitationResolutionChanges:e.qualityLimitationResolutionChanges,rid:null!==(i=e.rid)&&void 0!==i?i:e.id,retransmittedPacketsSent:e.retransmittedPacketsSent,targetBitrate:e.targetBitrate,timestamp:e.timestamp},r=s.get(e.remoteId);r&&(n.jitter=r.jitter,n.packetsLost=r.packetsLost,n.roundTripTime=r.roundTripTime),t.push(n)}}),t.sort((e,t)=>{var s,i;return(null!==(s=t.frameWidth)&&void 0!==s?s:0)-(null!==(i=e.frameWidth)&&void 0!==i?i:0)}),t})}setPublishingQuality(e){const t=[];for(let s=Jm.LOW;s<=Jm.HIGH;s+=1)t.push(new uh({quality:s,enabled:s<=e}));this.log.debug("setting publishing quality. max quality ".concat(e),this.logContext),this.setPublishingLayers(fp(this.codec),t)}restartTrack(e){return Gh(this,void 0,void 0,function*(){var t,s,i,n,r;let a;if(e){const t=Xp({video:e});"boolean"!=typeof t.video&&(a=t.video)}yield this.restart(a),this.isCpuConstrained=!1;try{for(var o,l=!0,c=Wh(this.simulcastCodecs.values());!(t=(o=yield c.next()).done);l=!0){n=o.value,l=!1;const e=n;e.sender&&"closed"!==(null===(r=e.sender.transport)||void 0===r?void 0:r.state)&&(e.mediaStreamTrack=this.mediaStreamTrack.clone(),yield e.sender.replaceTrack(e.mediaStreamTrack))}}catch(d){s={error:d}}finally{try{l||t||!(i=c.return)||(yield i.call(c))}finally{if(s)throw s.error}}})}setProcessor(e){const t=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return Gh(this,arguments,void 0,function(e){var s=this;let i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function*(){var n,r,a,o,l,c;if(yield t.setProcessor.call(s,e,i),null===(l=s.processor)||void 0===l?void 0:l.processedTrack)try{for(var d,u=!0,h=Wh(s.simulcastCodecs.values());!(n=(d=yield h.next()).done);u=!0){o=d.value,u=!1;const e=o;yield null===(c=e.sender)||void 0===c?void 0:c.replaceTrack(s.processor.processedTrack)}}catch(f){r={error:f}}finally{try{u||n||!(a=h.return)||(yield a.call(h))}finally{if(r)throw r.error}}}()})}setDegradationPreference(e){return Gh(this,void 0,void 0,function*(){if(this.degradationPreference=e,this.sender)try{this.log.debug("setting degradationPreference to ".concat(e),this.logContext);const t=this.sender.getParameters();t.degradationPreference=e,this.sender.setParameters(t)}catch(Tx){this.log.warn("failed to set degradationPreference",Object.assign({error:Tx},this.logContext))}})}addSimulcastTrack(e,t){if(this.simulcastCodecs.has(e))return void this.log.error("".concat(e," already added, skipping adding simulcast codec"),this.logContext);const s={codec:e,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:t};return this.simulcastCodecs.set(e,s),s}setSimulcastTrackSender(e,t){const s=this.simulcastCodecs.get(e);s&&(s.sender=t,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},5e3))}setPublishingCodecs(e){return Gh(this,void 0,void 0,function*(){var t,s,i,n,r,a,o;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:e,currentCodec:this.codec})),!this.codec&&e.length>0)return yield this.setPublishingLayers(fp(e[0].codec),e[0].qualities),[];this.subscribedCodecs=e;const l=[];try{for(t=!0,s=Wh(e);!(n=(i=yield s.next()).done);t=!0){o=i.value,t=!1;const e=o;if(this.codec&&this.codec!==e.codec){const t=this.simulcastCodecs.get(e.codec);if(this.log.debug("try setPublishingCodec for ".concat(e.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:t})),t&&t.sender)t.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(e.codec),this.logContext),yield bv(t.sender,t.encodings,e.qualities,this.senderLock,fp(e.codec),this.log,this.logContext));else for(const s of e.qualities)if(s.enabled){l.push(e.codec);break}}else yield this.setPublishingLayers(fp(e.codec),e.qualities)}}catch(c){r={error:c}}finally{try{t||n||!(a=s.return)||(yield a.call(s))}finally{if(r)throw r.error}}return l})}setPublishingLayers(e,t){return Gh(this,void 0,void 0,function*(){this.optimizeForPerformance?this.log.info("skipping setPublishingLayers due to optimized publishing performance",Object.assign(Object.assign({},this.logContext),{qualities:t})):(this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:t})),this.sender&&this.encodings&&(yield bv(this.sender,this.encodings,t,this.senderLock,e,this.log,this.logContext)))})}prioritizePerformance(){return Gh(this,void 0,void 0,function*(){if(!this.sender)throw new Error("sender not found");const e=yield this.senderLock.lock();try{this.optimizeForPerformance=!0;const e=this.sender.getParameters();e.encodings=e.encodings.map((e,t)=>{var s;return Object.assign(Object.assign({},e),{active:0===t,scaleResolutionDownBy:Math.max(1,Math.ceil((null!==(s=this.mediaStreamTrack.getSettings().height)&&void 0!==s?s:360)/360)),scalabilityMode:0===t&&fp(this.codec)?"L1T3":void 0,maxFramerate:0===t?15:0,maxBitrate:0===t?e.maxBitrate:0})}),this.log.debug("setting performance optimised encodings",Object.assign(Object.assign({},this.logContext),{encodings:e.encodings})),this.encodings=e.encodings,yield this.sender.setParameters(e)}catch(Tx){this.log.error("failed to set performance optimised encodings",Object.assign(Object.assign({},this.logContext),{error:Tx})),this.optimizeForPerformance=!1}finally{e()}})}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return Gh(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),yp()&&this.isInBackground&&this.source===Km.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}}function bv(e,t,s,i,n,r,a){return Gh(this,void 0,void 0,function*(){const o=yield i.lock();r.debug("setPublishingLayersForSender",Object.assign(Object.assign({},a),{sender:e,qualities:s,senderEncodings:t}));try{const i=e.getParameters(),{encodings:o}=i;if(!o)return;if(o.length!==t.length)return void r.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},a),{encodings:o,senderEncodings:t}));let l=!1;if(!1&&o[0].scalabilityMode);else{if(n){s.some(e=>e.enabled)&&s.forEach(e=>e.enabled=!0)}o.forEach((e,i)=>{var n;let o=null!==(n=e.rid)&&void 0!==n?n:"";""===o&&(o="q");const c=xv(o),d=s.find(e=>e.quality===c);d&&e.active!==d.enabled&&(l=!0,e.active=d.enabled,r.debug("setting layer ".concat(d.quality," to ").concat(e.active?"enabled":"disabled"),a),pp()&&(d.enabled?(e.scaleResolutionDownBy=t[i].scaleResolutionDownBy,e.maxBitrate=t[i].maxBitrate,e.maxFrameRate=t[i].maxFrameRate):(e.scaleResolutionDownBy=4,e.maxBitrate=10,e.maxFrameRate=2)))})}l&&(i.encodings=o,r.debug("setting encodings",Object.assign(Object.assign({},a),{encodings:i.encodings})),yield e.setParameters(i))}finally{o()}})}function xv(e){switch(e){case"f":default:return Jm.HIGH;case"h":return Jm.MEDIUM;case"q":return Jm.LOW}}function wv(e,t,s,i){if(!s)return[new au({quality:Jm.HIGH,width:e,height:t,bitrate:0,ssrc:0})];if(i){const i=s[0].scalabilityMode,n=new vv(i),r=[],a="h"==n.suffix?1.5:2,o="h"==n.suffix?2:3;for(let l=0;l<n.spatial;l+=1)r.push(new au({quality:Math.min(Jm.HIGH,n.spatial-1)-l,width:Math.ceil(e/Math.pow(a,l)),height:Math.ceil(t/Math.pow(a,l)),bitrate:s[0].maxBitrate?Math.ceil(s[0].maxBitrate/Math.pow(o,l)):0,ssrc:0}));return r}return s.map(s=>{var i,n,r;const a=null!==(i=s.scaleResolutionDownBy)&&void 0!==i?i:1;let o=xv(null!==(n=s.rid)&&void 0!==n?n:"");return new au({quality:o,width:Math.ceil(e/a),height:Math.ceil(t/a),bitrate:null!==(r=s.maxBitrate)&&void 0!==r?r:0,ssrc:0})})}const Sv="_lossy",kv="_reliable",_v="leave-reconnect";var Cv,Nv;(Nv=Cv||(Cv={}))[Nv.New=0]="New",Nv[Nv.Connected=1]="Connected",Nv[Nv.Disconnected=2]="Disconnected",Nv[Nv.Reconnecting=3]="Reconnecting",Nv[Nv.Closed=4]="Closed";class Tv extends Xh.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(e){var t;super(),this.options=e,this.rtcConfig={},this.peerConnectionTimeout=Jg.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.latestRemoteOfferId=0,this.subscriberPrimary=!1,this.pcState=Cv.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=qh,this.reliableDataSequence=1,this.reliableMessageBuffer=new xg,this.reliableReceivedState=new wg(3e4),this.handleDataChannel=e=>Gh(this,[e],void 0,function(e){var t=this;let{channel:s}=e;return function*(){if(s){if(s.label===kv)t.reliableDCSub=s;else{if(s.label!==Sv)return;t.lossyDCSub=s}t.log.debug("on data channel ".concat(s.id,", ").concat(s.label),t.logContext),s.onmessage=t.handleDataMessage}}()}),this.handleDataMessage=e=>Gh(this,void 0,void 0,function*(){var t,s;const i=yield this.dataProcessLock.lock();try{let i;if(e.data instanceof ArrayBuffer)i=e.data;else{if(!(e.data instanceof Blob))return void this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:e.data}));i=yield e.data.arrayBuffer()}const n=ou.fromBinary(new Uint8Array(i));if(n.sequence>0&&""!==n.participantSid){const e=this.reliableReceivedState.get(n.participantSid);if(e&&n.sequence<=e)return;this.reliableReceivedState.set(n.participantSid,n.sequence)}"speaker"===(null===(t=n.value)||void 0===t?void 0:t.case)?this.emit(km.ActiveSpeakersUpdate,n.value.value.speakers):("user"===(null===(s=n.value)||void 0===s?void 0:s.case)&&function(e,t){const s=e.participantIdentity?e.participantIdentity:t.participantIdentity;e.participantIdentity=s,t.participantIdentity=s;const i=0!==e.destinationIdentities.length?e.destinationIdentities:t.destinationIdentities;e.destinationIdentities=i,t.destinationIdentities=i}(n,n.value.value),this.emit(km.DataPacketReceived,n))}finally{i()}}),this.handleDataError=e=>{const t=0===e.currentTarget.maxRetransmits?"lossy":"reliable";if(e instanceof ErrorEvent&&e.error){const{error:s}=e.error;this.log.error("DataChannel error on ".concat(t,": ").concat(e.message),Object.assign(Object.assign({},this.logContext),{error:s}))}else this.log.error("Unknown DataChannel error on ".concat(t),Object.assign(Object.assign({},this.logContext),{event:e}))},this.handleBufferedAmountLow=e=>{const t=0===e.currentTarget.maxRetransmits?lu.LOSSY:lu.RELIABLE;this.updateAndEmitDCBufferStatus(t)},this.handleDisconnect=(e,t)=>{if(this._isClosed)return;this.log.warn("".concat(e," disconnected"),this.logContext),0===this.reconnectAttempts&&(this.reconnectStart=Date.now());const s=e=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(e,"ms. giving up"),this.logContext),this.emit(km.Disconnected),this.close()},i=Date.now()-this.reconnectStart;let n=this.getNextRetryDelay({elapsedMs:i,retryCount:this.reconnectAttempts});null!==n?(e===_v&&(n=0),this.log.debug("reconnecting in ".concat(n,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=Vm.setTimeout(()=>this.attemptReconnect(t).finally(()=>this.reconnectTimeout=void 0),n)):s(i)},this.waitForRestarted=()=>new Promise((e,t)=>{this.pcState===Cv.Connected&&e();const s=()=>{this.off(km.Disconnected,i),e()},i=()=>{this.off(km.Restarted,s),t()};this.once(km.Restarted,s),this.once(km.Disconnected,i)}),this.updateAndEmitDCBufferStatus=e=>{const t=this.isBufferStatusLow(e);void 0!==t&&t!==this.dcBufferStatus.get(e)&&(this.dcBufferStatus.set(e,t),this.emit(km.DCBufferStatusChanged,t,e))},this.isBufferStatusLow=e=>{const t=this.dataChannelForKind(e);if(t)return e===lu.RELIABLE&&this.reliableMessageBuffer.alignBufferedAmount(t.bufferedAmount),t.bufferedAmount<=t.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>{this.client.currentState===pg.RECONNECTING&&(this.clearReconnectTimeout(),this.attemptReconnect(Jd.RR_SIGNAL_DISCONNECTED))},this.log=$h(null!==(t=e.loggerName)&&void 0!==t?t:Uh.Engine),this.loggerOptions={loggerName:e.loggerName,loggerContextCb:()=>this.logContext},this.client=new vg(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.registerOnLineListener(),this.closingLock=new Zl,this.dataProcessLock=new Zl,this.dcBufferStatus=new Map([[lu.LOSSY,!0],[lu.RELIABLE,!0]]),this.client.onParticipantUpdate=e=>this.emit(km.ParticipantUpdate,e),this.client.onConnectionQuality=e=>this.emit(km.ConnectionQualityUpdate,e),this.client.onRoomUpdate=e=>this.emit(km.RoomUpdate,e),this.client.onSubscriptionError=e=>this.emit(km.SubscriptionError,e),this.client.onSubscriptionPermissionUpdate=e=>this.emit(km.SubscriptionPermissionUpdate,e),this.client.onSpeakersChanged=e=>this.emit(km.SpeakersChanged,e),this.client.onStreamStateUpdate=e=>this.emit(km.StreamStateChanged,e),this.client.onRequestResponse=e=>this.emit(km.SignalRequestResponse,e)}get logContext(){var e,t,s,i,n,r;return{room:null===(t=null===(e=this.latestJoinResponse)||void 0===e?void 0:e.room)||void 0===t?void 0:t.name,roomID:null===(i=null===(s=this.latestJoinResponse)||void 0===s?void 0:s.room)||void 0===i?void 0:i.sid,participant:null===(r=null===(n=this.latestJoinResponse)||void 0===n?void 0:n.participant)||void 0===r?void 0:r.identity,pID:this.participantSid}}join(e,t,s,i){return Gh(this,void 0,void 0,function*(){this.url=e,this.token=t,this.signalOpts=s,this.maxJoinAttempts=s.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();const n=yield this.client.join(e,t,s,i);return this._isClosed=!1,this.latestJoinResponse=n,this.subscriberPrimary=n.subscriberPrimary,this.pcManager||(yield this.configure(n)),this.subscriberPrimary&&!n.fastPublish||this.negotiate(),this.clientConfiguration=n.clientConfiguration,this.emit(km.SignalConnected,n),n}catch(Tx){if(Tx instanceof jm&&Tx.reason===um.ServerUnreachable&&(this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext),this.joinAttempts<this.maxJoinAttempts))return this.join(e,t,s,i);throw Tx}})}close(){return Gh(this,void 0,void 0,function*(){const e=yield this.closingLock.lock();if(this.isClosed)e();else try{this._isClosed=!0,this.joinAttempts=0,this.emit(km.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{e()}})}cleanupPeerConnections(){return Gh(this,void 0,void 0,function*(){var e;yield null===(e=this.pcManager)||void 0===e?void 0:e.close(),this.pcManager=void 0;const t=e=>{e&&(e.close(),e.onbufferedamountlow=null,e.onclose=null,e.onclosing=null,e.onerror=null,e.onmessage=null,e.onopen=null)};t(this.lossyDC),t(this.lossyDCSub),t(this.reliableDC),t(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0,this.reliableMessageBuffer=new xg,this.reliableDataSequence=1,this.reliableReceivedState.clear()})}cleanupClient(){return Gh(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack(e){if(this.pendingTrackResolvers[e.cid])throw new Im("a track with the same ID has already been published");return new Promise((t,s)=>{const i=setTimeout(()=>{delete this.pendingTrackResolvers[e.cid],s(new jm("publication of local track timed out, no response from server",um.Timeout))},1e4);this.pendingTrackResolvers[e.cid]={resolve:e=>{clearTimeout(i),t(e)},reject:()=>{clearTimeout(i),s(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(e)})}removeTrack(e){if(e.track&&this.pendingTrackResolvers[e.track.id]){const{reject:t}=this.pendingTrackResolvers[e.track.id];t&&t(),delete this.pendingTrackResolvers[e.track.id]}try{return this.pcManager.removeTrack(e),!0}catch(Tx){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:Tx}))}return!1}updateMuteStatus(e,t){this.client.sendMuteTrack(e,t)}get dataSubscriberReadyState(){var e;return null===(e=this.reliableDCSub)||void 0===e?void 0:e.readyState}getConnectedServerAddress(){return Gh(this,void 0,void 0,function*(){var e;return null===(e=this.pcManager)||void 0===e?void 0:e.getConnectedAddress()})}setRegionUrlProvider(e){this.regionUrlProvider=e}configure(e){return Gh(this,void 0,void 0,function*(){var t,s;if(this.pcManager&&this.pcManager.currentState!==Wg.NEW)return;this.participantSid=null===(t=e.participant)||void 0===t?void 0:t.sid;const i=this.makeRTCConfiguration(e);var n;this.pcManager=new Yg(i,e.subscriberPrimary,this.loggerOptions),this.emit(km.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(e,t)=>{this.client.sendIceCandidate(e,t)},this.pcManager.onPublisherOffer=(e,t)=>{this.client.sendOffer(e,t)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(t,s,i)=>Gh(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(t),this.logContext),["closed","disconnected","failed"].includes(s)&&(this.publisherConnectionPromise=void 0),t===Wg.CONNECTED){const t=this.pcState===Cv.New;this.pcState=Cv.Connected,t&&this.emit(km.Connected,e)}else t===Wg.FAILED&&this.pcState===Cv.Connected&&(this.pcState=Cv.Disconnected,this.handleDisconnect("peerconnection failed","failed"===i?Jd.RR_SUBSCRIBER_FAILED:Jd.RR_PUBLISHER_FAILED));const n=this.client.isDisconnected||this.client.currentState===pg.RECONNECTING,r=[Wg.FAILED,Wg.CLOSING,Wg.CLOSED].includes(t);n&&r&&!this._isClosed&&this.emit(km.Offline)}),this.pcManager.onTrack=e=>{this.emit(km.MediaTrackAdded,e.track,e.streams[0],e.receiver)},void 0!==(n=null===(s=e.serverInfo)||void 0===s?void 0:s.protocol)&&n>13||this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=(e,t)=>Gh(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type})),yield this.pcManager.setPublisherAnswer(e,t))}),this.client.onTrickle=(e,t)=>{this.pcManager&&(this.log.debug("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:e,target:t})),this.pcManager.addIceCandidate(e,t))},this.client.onOffer=(e,t)=>Gh(this,void 0,void 0,function*(){if(this.latestRemoteOfferId=t,!this.pcManager)return;const s=yield this.pcManager.createSubscriberAnswerFromOffer(e,t);s&&this.client.sendAnswer(s,t)}),this.client.onLocalTrackPublished=e=>{var t;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:e.cid,track:null===(t=e.track)||void 0===t?void 0:t.sid})),!this.pendingTrackResolvers[e.cid])return void this.log.error("missing track resolver for ".concat(e.cid),Object.assign(Object.assign({},this.logContext),{cid:e.cid}));const{resolve:s}=this.pendingTrackResolvers[e.cid];delete this.pendingTrackResolvers[e.cid],s(e.track)},this.client.onLocalTrackUnpublished=e=>{this.emit(km.LocalTrackUnpublished,e)},this.client.onLocalTrackSubscribed=e=>{this.emit(km.LocalTrackSubscribed,e)},this.client.onTokenRefresh=e=>{this.token=e},this.client.onRemoteMuteChanged=(e,t)=>{this.emit(km.RemoteMute,e,t)},this.client.onSubscribedQualityUpdate=e=>{this.emit(km.SubscribedQualityUpdate,e)},this.client.onRoomMoved=e=>{var t;this.participantSid=null===(t=e.participant)||void 0===t?void 0:t.sid,this.latestJoinResponse&&(this.latestJoinResponse.room=e.room),this.emit(km.RoomMoved,e)},this.client.onClose=()=>{this.handleDisconnect("signal",Jd.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=e=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:null==e?void 0:e.reason})),e.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions(e.regions)),e.action){case th.DISCONNECT:this.emit(km.Disconnected,null==e?void 0:e.reason),this.close();break;case th.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(_v);break;case th.RESUME:this.handleDisconnect(_v)}}}makeRTCConfiguration(e){var t;const s=Object.assign({},this.rtcConfig);if((null===(t=this.signalOpts)||void 0===t?void 0:t.e2eeEnabled)&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),s.encodedInsertableStreams=!0),e.iceServers&&!s.iceServers){const t=[];e.iceServers.forEach(e=>{const s={urls:e.urls};e.username&&(s.username=e.username),e.credential&&(s.credential=e.credential),t.push(s)}),s.iceServers=t}return e.clientConfiguration&&e.clientConfiguration.forceRelay===Vd.ENABLED&&(s.iceTransportPolicy="relay"),s.sdpSemantics="unified-plan",s.continualGatheringPolicy="gather_continually",s}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(Sv,{ordered:!1,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(kv,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow)}createSender(e,t,s){return Gh(this,void 0,void 0,function*(){if(up()){return yield this.createTransceiverRTCRtpSender(e,t,s)}if(hp()){this.log.warn("using add-track fallback",this.logContext);return yield this.createRTCRtpSender(e.mediaStreamTrack)}throw new Rm("Required webRTC APIs not supported on this device")})}createSimulcastSender(e,t,s,i){return Gh(this,void 0,void 0,function*(){if(up())return this.createSimulcastTransceiverSender(e,t,s,i);if(hp())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender(e.mediaStreamTrack);throw new Rm("Cannot stream on this device")})}createTransceiverRTCRtpSender(e,t,s){return Gh(this,void 0,void 0,function*(){if(!this.pcManager)throw new Rm("publisher is closed");const i=[];e.mediaStream&&i.push(e.mediaStream),zp(e)&&(e.codec=t.videoCodec);const n={direction:"sendonly",streams:i};s&&(n.sendEncodings=s);return(yield this.pcManager.addPublisherTransceiver(e.mediaStreamTrack,n)).sender})}createSimulcastTransceiverSender(e,t,s,i){return Gh(this,void 0,void 0,function*(){if(!this.pcManager)throw new Rm("publisher is closed");const n={direction:"sendonly"};i&&(n.sendEncodings=i);const r=yield this.pcManager.addPublisherTransceiver(t.mediaStreamTrack,n);if(s.videoCodec)return e.setSimulcastTrackSender(s.videoCodec,r.sender),r.sender})}createRTCRtpSender(e){return Gh(this,void 0,void 0,function*(){if(!this.pcManager)throw new Rm("publisher is closed");return this.pcManager.addPublisherTrack(e)})}attemptReconnect(e){return Gh(this,void 0,void 0,function*(){var t,s,i;if(!this._isClosed)if(this.attemptingReconnect)qh.warn("already attempting reconnect, returning early",this.logContext);else{(null===(t=this.clientConfiguration)||void 0===t?void 0:t.resumeConnection)!==Vd.DISABLED&&(null!==(i=null===(s=this.pcManager)||void 0===s?void 0:s.currentState)&&void 0!==i?i:Wg.NEW)!==Wg.NEW||(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(e),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(Tx){this.reconnectAttempts+=1;let t=!0;Tx instanceof Rm?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:Tx})),t=!1):Tx instanceof Av||(this.fullReconnectOnNext=!0),t?this.handleDisconnect("reconnect",Jd.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(km.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay(e){try{return this.reconnectPolicy.nextRetryDelayInMs(e)}catch(Tx){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:Tx}))}return null}restartConnection(e){return Gh(this,void 0,void 0,function*(){var t,s,i;try{if(!this.url||!this.token)throw new Rm("could not reconnect, url or token not saved");let s;this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(km.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new Av;s=yield this.join(null!=e?e:this.url,this.token,this.signalOpts)}catch(Tx){if(Tx instanceof jm&&Tx.reason===um.NotAllowed)throw new Rm("could not reconnect, token might be expired");throw new Av}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(km.SignalRestarted,s),yield this.waitForPCReconnected(),this.client.currentState!==pg.CONNECTED)throw new Av("Signal connection got severed during reconnect");null===(t=this.regionUrlProvider)||void 0===t||t.resetAttempts(),this.emit(km.Restarted)}catch(n){const e=yield null===(s=this.regionUrlProvider)||void 0===s?void 0:s.getNextBestRegionUrl();if(e)return void(yield this.restartConnection(e));throw null===(i=this.regionUrlProvider)||void 0===i||i.resetAttempts(),n}})}resumeConnection(e){return Gh(this,void 0,void 0,function*(){var t;if(!this.url||!this.token)throw new Rm("could not reconnect, url or token not saved");if(!this.pcManager)throw new Rm("publisher and subscriber connections unset");let s;this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(km.Resuming);try{this.setupSignalClientCallbacks(),s=yield this.client.reconnect(this.url,this.token,this.participantSid,e)}catch(i){let e="";if(i instanceof Error&&(e=i.message,this.log.error(i.message,Object.assign(Object.assign({},this.logContext),{error:i}))),i instanceof jm&&i.reason===um.NotAllowed)throw new Rm("could not reconnect, token might be expired");if(i instanceof jm&&i.reason===um.LeaveRequest)throw i;throw new Av(e)}if(this.emit(km.SignalResumed),s){const e=this.makeRTCConfiguration(s);this.pcManager.updateConfiguration(e),this.latestJoinResponse&&(this.latestJoinResponse.serverInfo=s.serverInfo)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==pg.CONNECTED)throw new Av("Signal connection got severed during reconnect");this.client.setReconnected(),"open"===(null===(t=this.reliableDC)||void 0===t?void 0:t.readyState)&&null===this.reliableDC.id&&this.createDataChannels(),(null==s?void 0:s.lastMessageSeq)&&this.resendReliableMessagesForResume(s.lastMessageSeq),this.emit(km.Resumed)})}waitForPCInitialConnection(e,t){return Gh(this,void 0,void 0,function*(){if(!this.pcManager)throw new Rm("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(t,e)})}waitForPCReconnected(){return Gh(this,void 0,void 0,function*(){this.pcState=Cv.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield dp(2e3),!this.pcManager)throw new Rm("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=Cv.Connected}catch(Tx){throw this.pcState=Cv.Disconnected,new jm("could not establish PC connection, ".concat(Tx.message),um.InternalError)}})}publishRpcResponse(e,t,s,i){return Gh(this,void 0,void 0,function*(){const n=new ou({destinationIdentities:[e],kind:lu.RELIABLE,value:{case:"rpcResponse",value:new yu({requestId:t,value:i?{case:"error",value:i.toProto()}:{case:"payload",value:null!=s?s:""}})}});yield this.sendDataPacket(n,lu.RELIABLE)})}publishRpcAck(e,t){return Gh(this,void 0,void 0,function*(){const s=new ou({destinationIdentities:[e],kind:lu.RELIABLE,value:{case:"rpcAck",value:new vu({requestId:t})}});yield this.sendDataPacket(s,lu.RELIABLE)})}sendDataPacket(e,t){return Gh(this,void 0,void 0,function*(){yield this.ensurePublisherConnected(t),t===lu.RELIABLE&&(e.sequence=this.reliableDataSequence,this.reliableDataSequence+=1);const s=e.toBinary(),i=this.dataChannelForKind(t);if(i){if(t===lu.RELIABLE&&this.reliableMessageBuffer.push({data:s,sequence:e.sequence}),this.attemptingReconnect)return;i.send(s)}this.updateAndEmitDCBufferStatus(t)})}resendReliableMessagesForResume(e){return Gh(this,void 0,void 0,function*(){yield this.ensurePublisherConnected(lu.RELIABLE);const t=this.dataChannelForKind(lu.RELIABLE);t&&(this.reliableMessageBuffer.popToSequence(e),this.reliableMessageBuffer.getAll().forEach(e=>{t.send(e.data)})),this.updateAndEmitDCBufferStatus(lu.RELIABLE)})}waitForBufferStatusLow(e){return new Promise((t,s)=>Gh(this,void 0,void 0,function*(){if(this.isBufferStatusLow(e))t();else{const i=()=>s("Engine closed");for(this.once(km.Closing,i);!this.dcBufferStatus.get(e);)yield dp(10);this.off(km.Closing,i),t()}}))}ensureDataTransportConnected(e){return Gh(this,arguments,void 0,function(e){var t=this;let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.subscriberPrimary;return function*(){var i;if(!t.pcManager)throw new Rm("PC manager is closed");const n=s?t.pcManager.subscriber:t.pcManager.publisher,r=s?"Subscriber":"Publisher";if(!n)throw new jm("".concat(r," connection not set"),um.InternalError);let a=!1;s||t.dataChannelForKind(e,s)||(t.createDataChannels(),a=!0),a||s||t.pcManager.publisher.isICEConnected||"checking"===t.pcManager.publisher.getICEConnectionState()||(a=!0),a&&t.negotiate();const o=t.dataChannelForKind(e,s);if("open"===(null==o?void 0:o.readyState))return;const l=(new Date).getTime()+t.peerConnectionTimeout;for(;(new Date).getTime()<l;){if(n.isICEConnected&&"open"===(null===(i=t.dataChannelForKind(e,s))||void 0===i?void 0:i.readyState))return;yield dp(50)}throw new jm("could not establish ".concat(r," connection, state: ").concat(n.getICEConnectionState()),um.InternalError)}()})}ensurePublisherConnected(e){return Gh(this,void 0,void 0,function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected(e,!1)),yield this.publisherConnectionPromise})}verifyTransport(){return!!this.pcManager&&(this.pcManager.currentState===Wg.CONNECTED&&!(!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED))}negotiate(){return Gh(this,void 0,void 0,function*(){return new Promise((e,t)=>Gh(this,void 0,void 0,function*(){if(!this.pcManager)return void t(new Om("PC manager is closed"));this.pcManager.requirePublisher(),0!=this.pcManager.publisher.getTransceivers().length||this.lossyDC||this.reliableDC||this.createDataChannels();const s=new AbortController,i=()=>{s.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),e()};this.isClosed&&t("cannot negotiate on closed engine"),this.on(km.Closing,i),this.pcManager.publisher.once(Mg,e=>{const t=new Map;e.forEach(e=>{const s=e.codec.toLowerCase();var i;i=s,ep.includes(i)&&t.set(e.payload,s)}),this.emit(km.RTPVideoMapUpdate,t)});try{yield this.pcManager.negotiate(s),e()}catch(Tx){Tx instanceof Om&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",Jd.RR_UNKNOWN),t(Tx)}finally{this.off(km.Closing,i)}}))})}dataChannelForKind(e,t){if(t){if(e===lu.LOSSY)return this.lossyDCSub;if(e===lu.RELIABLE)return this.reliableDCSub}else{if(e===lu.LOSSY)return this.lossyDC;if(e===lu.RELIABLE)return this.reliableDC}}sendSyncState(e,t){var s,i;if(!this.pcManager)return void this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);const n=this.pcManager.subscriber.getLocalDescription(),r=this.pcManager.subscriber.getRemoteDescription(),a=null===(i=null===(s=this.signalOpts)||void 0===s?void 0:s.autoSubscribe)||void 0===i||i,o=new Array,l=new Array;e.forEach(e=>{e.isDesired!==a&&o.push(e.trackSid),e.isEnabled||l.push(e.trackSid)}),this.client.sendSyncState(new yh({answer:n?bg({sdp:n.sdp,type:n.type}):void 0,offer:r?bg({sdp:r.sdp,type:r.type}):void 0,subscription:new Yu({trackSids:o,subscribe:!a,participantTracks:[]}),publishTracks:ig(t),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:l,datachannelReceiveStates:this.reliableReceivedState.map((e,t)=>new bh({publisherSid:t,lastSeq:e}))}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const e=[],t=(t,s)=>{void 0!==(null==t?void 0:t.id)&&null!==t.id&&e.push(new xh({label:t.label,id:t.id,target:s}))};return t(this.dataChannelForKind(lu.LOSSY),Ou.PUBLISHER),t(this.dataChannelForKind(lu.RELIABLE),Ou.PUBLISHER),t(this.dataChannelForKind(lu.LOSSY,!0),Ou.SUBSCRIBER),t(this.dataChannelForKind(lu.RELIABLE,!0),Ou.SUBSCRIBER),e}clearReconnectTimeout(){this.reconnectTimeout&&Vm.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){bp()&&window.addEventListener("online",this.handleBrowserOnLine)}deregisterOnLineListener(){bp()&&window.removeEventListener("online",this.handleBrowserOnLine)}}class Av extends Error{}class Ev{constructor(e,t){this.lastUpdateAt=0,this.settingsCacheTime=3e3,this.attemptedRegions=[],this.serverUrl=new URL(e),this.token=t}updateToken(e){this.token=e}isCloud(){return wp(this.serverUrl)}getServerUrl(){return this.serverUrl}getNextBestRegionUrl(e){return Gh(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");(!this.regionSettings||Date.now()-this.lastUpdateAt>this.settingsCacheTime)&&(this.regionSettings=yield this.fetchRegionSettings(e));const t=this.regionSettings.regions.filter(e=>!this.attemptedRegions.find(t=>t.url===e.url));if(t.length>0){const e=t[0];return this.attemptedRegions.push(e),qh.debug("next region: ".concat(e.region)),e.url}return null})}resetAttempts(){this.attemptedRegions=[]}fetchRegionSettings(e){return Gh(this,void 0,void 0,function*(){const t=yield fetch("".concat((s=this.serverUrl,"".concat(s.protocol.replace("ws","http"),"//").concat(s.host,"/settings")),"/regions"),{headers:{authorization:"Bearer ".concat(this.token)},signal:e});var s;if(t.ok){const e=yield t.json();return this.lastUpdateAt=Date.now(),e}throw new jm("Could not fetch region settings: ".concat(t.statusText),401===t.status?um.NotAllowed:um.InternalError,t.status)})}setServerReportedRegions(e){this.regionSettings=e,this.lastUpdateAt=Date.now()}}class jv{get info(){return this._info}validateBytesReceived(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if("number"==typeof this.totalByteSize&&0!==this.totalByteSize){if(e&&this.bytesReceived<this.totalByteSize)throw new Um("Not enough chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, only received ").concat(this.bytesReceived," bytes"),fm.Incomplete);if(this.bytesReceived>this.totalByteSize)throw new Um("Extra chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, received ").concat(this.bytesReceived," bytes"),fm.LengthExceeded)}}constructor(e,t,s,i){this.reader=t,this.totalByteSize=s,this._info=e,this.bytesReceived=0,this.outOfBandFailureRejectingFuture=i}}class Pv extends jv{handleChunkReceived(e){var t;this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const s=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;null===(t=this.onProgress)||void 0===t||t.call(this,s)}[Symbol.asyncIterator](){const e=this.reader.getReader();let t=new Op,s=null,i=null;if(this.signal){const e=this.signal;i=()=>{var s;null===(s=t.reject)||void 0===s||s.call(t,e.reason)},e.addEventListener("abort",i),s=e}const n=()=>{e.releaseLock(),s&&i&&s.removeEventListener("abort",i),this.signal=void 0};return{next:()=>Gh(this,void 0,void 0,function*(){var s,i;try{const{done:n,value:r}=yield Promise.race([e.read(),t.promise,null!==(i=null===(s=this.outOfBandFailureRejectingFuture)||void 0===s?void 0:s.promise)&&void 0!==i?i:new Promise(()=>{})]);return n?(this.validateBytesReceived(!0),{done:!0,value:void 0}):(this.handleChunkReceived(r),{done:!1,value:r.content})}catch(r){throw n(),r}}),return(){return Gh(this,void 0,void 0,function*(){return n(),{done:!0,value:void 0}})}}}withAbortSignal(e){return this.signal=e,this}readAll(){return Gh(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function*(){var s,i,n,r;let a=new Set;const o=t.signal?e.withAbortSignal(t.signal):e;try{for(var l,c=!0,d=Wh(o);!(s=(l=yield d.next()).done);c=!0){r=l.value,c=!1;const e=r;a.add(e)}}catch(u){i={error:u}}finally{try{c||s||!(n=d.return)||(yield n.call(d))}finally{if(i)throw i.error}}return Array.from(a)}()})}}class Iv extends jv{constructor(e,t,s,i){super(e,t,s,i),this.receivedChunks=new Map}handleChunkReceived(e){var t;const s=Fp(e.chunkIndex),i=this.receivedChunks.get(s);if(i&&i.version>e.version)return;this.receivedChunks.set(s,e),this.bytesReceived+=e.content.byteLength,this.validateBytesReceived();const n=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;null===(t=this.onProgress)||void 0===t||t.call(this,n)}[Symbol.asyncIterator](){const e=this.reader.getReader(),t=new TextDecoder("utf-8",{fatal:!0});let s=new Op,i=null,n=null;if(this.signal){const e=this.signal;n=()=>{var t;null===(t=s.reject)||void 0===t||t.call(s,e.reason)},e.addEventListener("abort",n),i=e}const r=()=>{e.releaseLock(),i&&n&&i.removeEventListener("abort",n),this.signal=void 0};return{next:()=>Gh(this,void 0,void 0,function*(){var i,n;try{const{done:r,value:o}=yield Promise.race([e.read(),s.promise,null!==(n=null===(i=this.outOfBandFailureRejectingFuture)||void 0===i?void 0:i.promise)&&void 0!==n?n:new Promise(()=>{})]);if(r)return this.validateBytesReceived(!0),{done:!0,value:void 0};{let e;this.handleChunkReceived(o);try{e=t.decode(o.content)}catch(a){throw new Um("Cannot decode datastream chunk ".concat(o.chunkIndex," as text: ").concat(a),fm.DecodeFailed)}return{done:!1,value:e}}}catch(a){throw r(),a}}),return(){return Gh(this,void 0,void 0,function*(){return r(),{done:!0,value:void 0}})}}}withAbortSignal(e){return this.signal=e,this}readAll(){return Gh(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return function*(){var s,i,n,r;let a="";const o=t.signal?e.withAbortSignal(t.signal):e;try{for(var l,c=!0,d=Wh(o);!(s=(l=yield d.next()).done);c=!0){r=l.value,c=!1;a+=r}}catch(u){i={error:u}}finally{try{c||s||!(n=d.return)||(yield n.call(d))}finally{if(i)throw i.error}}return a}()})}}class Lv{constructor(){this.log=qh,this.byteStreamControllers=new Map,this.textStreamControllers=new Map,this.byteStreamHandlers=new Map,this.textStreamHandlers=new Map}registerTextStreamHandler(e,t){if(this.textStreamHandlers.has(e))throw new Um('A text stream handler for topic "'.concat(e,'" has already been set.'),fm.HandlerAlreadyRegistered);this.textStreamHandlers.set(e,t)}unregisterTextStreamHandler(e){this.textStreamHandlers.delete(e)}registerByteStreamHandler(e,t){if(this.byteStreamHandlers.has(e))throw new Um('A byte stream handler for topic "'.concat(e,'" has already been set.'),fm.HandlerAlreadyRegistered);this.byteStreamHandlers.set(e,t)}unregisterByteStreamHandler(e){this.byteStreamHandlers.delete(e)}clearHandlersAndControllers(){this.byteStreamControllers.clear(),this.textStreamControllers.clear(),this.byteStreamHandlers.clear(),this.textStreamHandlers.clear()}validateParticipantHasNoActiveDataStreams(e){var t,s,i,n;const r=Array.from(this.textStreamControllers.entries()).filter(t=>t[1].sendingParticipantIdentity===e),a=Array.from(this.byteStreamControllers.entries()).filter(t=>t[1].sendingParticipantIdentity===e);if(r.length>0||a.length>0){const o=new Um("Participant ".concat(e," unexpectedly disconnected in the middle of sending data"),fm.AbnormalEnd);for(const[e,i]of a)null===(s=(t=i.outOfBandFailureRejectingFuture).reject)||void 0===s||s.call(t,o),this.byteStreamControllers.delete(e);for(const[e,t]of r)null===(n=(i=t.outOfBandFailureRejectingFuture).reject)||void 0===n||n.call(i,o),this.textStreamControllers.delete(e)}}handleDataStreamPacket(e){return Gh(this,void 0,void 0,function*(){switch(e.value.case){case"streamHeader":return this.handleStreamHeader(e.value.value,e.participantIdentity);case"streamChunk":return this.handleStreamChunk(e.value.value);case"streamTrailer":return this.handleStreamTrailer(e.value.value);default:throw new Error('DataPacket of value "'.concat(e.value.case,'" is not data stream related!'))}})}handleStreamHeader(e,t){return Gh(this,void 0,void 0,function*(){var s;if("byteHeader"===e.contentHeader.case){const i=this.byteStreamHandlers.get(e.topic);if(!i)return void this.log.debug("ignoring incoming byte stream due to no handler for topic",e.topic);let n;const r=new Op,a={id:e.streamId,name:null!==(s=e.contentHeader.value.name)&&void 0!==s?s:"unknown",mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:Fp(e.timestamp),attributes:e.attributes},o=new ReadableStream({start:s=>{if(n=s,this.textStreamControllers.has(e.streamId))throw new Um("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),fm.AlreadyOpened);this.byteStreamControllers.set(e.streamId,{info:a,controller:n,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:r})}});i(new Pv(a,o,Fp(e.totalLength),r),{identity:t})}else if("textHeader"===e.contentHeader.case){const s=this.textStreamHandlers.get(e.topic);if(!s)return void this.log.debug("ignoring incoming text stream due to no handler for topic",e.topic);let i;const n=new Op,r={id:e.streamId,mimeType:e.mimeType,size:e.totalLength?Number(e.totalLength):void 0,topic:e.topic,timestamp:Number(e.timestamp),attributes:e.attributes},a=new ReadableStream({start:s=>{if(i=s,this.textStreamControllers.has(e.streamId))throw new Um("A data stream read is already in progress for a stream with id ".concat(e.streamId,"."),fm.AlreadyOpened);this.textStreamControllers.set(e.streamId,{info:r,controller:i,startTime:Date.now(),sendingParticipantIdentity:t,outOfBandFailureRejectingFuture:n})}});s(new Iv(r,a,Fp(e.totalLength),n),{identity:t})}})}handleStreamChunk(e){const t=this.byteStreamControllers.get(e.streamId);t&&e.content.length>0&&t.controller.enqueue(e);const s=this.textStreamControllers.get(e.streamId);s&&e.content.length>0&&s.controller.enqueue(e)}handleStreamTrailer(e){const t=this.textStreamControllers.get(e.streamId);t&&(t.info.attributes=Object.assign(Object.assign({},t.info.attributes),e.attributes),t.controller.close(),this.textStreamControllers.delete(e.streamId));const s=this.byteStreamControllers.get(e.streamId);s&&(s.info.attributes=Object.assign(Object.assign({},s.info.attributes),e.attributes),s.controller.close(),this.byteStreamControllers.delete(e.streamId))}}class Rv{constructor(e,t,s){this.writableStream=e,this.defaultWriter=e.getWriter(),this.onClose=s,this.info=t}write(e){return this.defaultWriter.write(e)}close(){return Gh(this,void 0,void 0,function*(){var e;yield this.defaultWriter.close(),this.defaultWriter.releaseLock(),null===(e=this.onClose)||void 0===e||e.call(this)})}}class Ov extends Rv{}class Dv extends Rv{}class Mv{constructor(e,t){this.engine=e,this.log=t}setupEngine(e){this.engine=e}sendText(e,t){return Gh(this,void 0,void 0,function*(){var s;const i=crypto.randomUUID(),n=(new TextEncoder).encode(e).byteLength,r=null===(s=null==t?void 0:t.attachments)||void 0===s?void 0:s.map(()=>crypto.randomUUID()),a=new Array(r?r.length+1:1).fill(0),o=(e,s)=>{var i;a[s]=e;const n=a.reduce((e,t)=>e+t,0);null===(i=null==t?void 0:t.onProgress)||void 0===i||i.call(t,n)},l=yield this.streamText({streamId:i,totalSize:n,destinationIdentities:null==t?void 0:t.destinationIdentities,topic:null==t?void 0:t.topic,attachedStreamIds:r,attributes:null==t?void 0:t.attributes});return yield l.write(e),o(1,0),yield l.close(),(null==t?void 0:t.attachments)&&r&&(yield Promise.all(t.attachments.map((e,s)=>Gh(this,void 0,void 0,function*(){return this._sendFile(r[s],e,{topic:t.topic,mimeType:e.type,onProgress:e=>{o(e,s+1)}})})))),l.info})}streamText(e){return Gh(this,void 0,void 0,function*(){var t,s;const i=null!==(t=null==e?void 0:e.streamId)&&void 0!==t?t:crypto.randomUUID(),n={id:i,mimeType:"text/plain",timestamp:Date.now(),topic:null!==(s=null==e?void 0:e.topic)&&void 0!==s?s:"",size:null==e?void 0:e.totalSize,attributes:null==e?void 0:e.attributes},r=new Iu({streamId:i,mimeType:n.mimeType,topic:n.topic,timestamp:Bp(n.timestamp),totalLength:Bp(null==e?void 0:e.totalSize),attributes:n.attributes,contentHeader:{case:"textHeader",value:new ju({version:null==e?void 0:e.version,attachedStreamIds:null==e?void 0:e.attachedStreamIds,replyToStreamId:null==e?void 0:e.replyToStreamId,operationType:"update"===(null==e?void 0:e.type)?Eu.UPDATE:Eu.CREATE})}}),a=null==e?void 0:e.destinationIdentities,o=new ou({destinationIdentities:a,value:{case:"streamHeader",value:r}});yield this.engine.sendDataPacket(o,lu.RELIABLE);let l=0;const c=this.engine,d=new WritableStream({write(e){return Gh(this,void 0,void 0,function*(){for(const t of function(e,t){const s=[];let i=(new TextEncoder).encode(e);for(;i.length>t;){let e=t;for(;e>0;){const t=i[e];if(void 0!==t&&128!=(192&t))break;e--}s.push(i.slice(0,e)),i=i.slice(e)}return i.length>0&&s.push(i),s}(e,15e3)){yield c.waitForBufferStatusLow(lu.RELIABLE);const e=new Lu({content:t,streamId:i,chunkIndex:Bp(l)}),s=new ou({destinationIdentities:a,value:{case:"streamChunk",value:e}});yield c.sendDataPacket(s,lu.RELIABLE),l+=1}})},close(){return Gh(this,void 0,void 0,function*(){const e=new Ru({streamId:i}),t=new ou({destinationIdentities:a,value:{case:"streamTrailer",value:e}});yield c.sendDataPacket(t,lu.RELIABLE)})},abort(e){}});let u=()=>Gh(this,void 0,void 0,function*(){yield h.close()});c.once(km.Closing,u);const h=new Ov(d,n,()=>this.engine.off(km.Closing,u));return h})}sendFile(e,t){return Gh(this,void 0,void 0,function*(){const s=crypto.randomUUID();return yield this._sendFile(s,e,t),{id:s}})}_sendFile(e,t,s){return Gh(this,void 0,void 0,function*(){var i;const n=yield this.streamBytes({streamId:e,totalSize:t.size,name:t.name,mimeType:null!==(i=null==s?void 0:s.mimeType)&&void 0!==i?i:t.type,topic:null==s?void 0:s.topic,destinationIdentities:null==s?void 0:s.destinationIdentities}),r=t.stream().getReader();for(;;){const{done:e,value:t}=yield r.read();if(e)break;yield n.write(t)}return yield n.close(),n.info})}streamBytes(e){return Gh(this,void 0,void 0,function*(){var t,s,i,n,r;const a=null!==(t=null==e?void 0:e.streamId)&&void 0!==t?t:crypto.randomUUID(),o=null==e?void 0:e.destinationIdentities,l={id:a,mimeType:null!==(s=null==e?void 0:e.mimeType)&&void 0!==s?s:"application/octet-stream",topic:null!==(i=null==e?void 0:e.topic)&&void 0!==i?i:"",timestamp:Date.now(),attributes:null==e?void 0:e.attributes,size:null==e?void 0:e.totalSize,name:null!==(n=null==e?void 0:e.name)&&void 0!==n?n:"unknown"},c=new Iu({totalLength:Bp(null!==(r=l.size)&&void 0!==r?r:0),mimeType:l.mimeType,streamId:a,topic:l.topic,timestamp:Bp(Date.now()),attributes:l.attributes,contentHeader:{case:"byteHeader",value:new Pu({name:l.name})}}),d=new ou({destinationIdentities:o,value:{case:"streamHeader",value:c}});yield this.engine.sendDataPacket(d,lu.RELIABLE);let u=0;const h=new Zl,f=this.engine,m=this.log,p=new WritableStream({write(e){return Gh(this,void 0,void 0,function*(){const t=yield h.lock();let s=0;try{for(;s<e.byteLength;){const t=e.slice(s,s+15e3);yield f.waitForBufferStatusLow(lu.RELIABLE);const i=new ou({destinationIdentities:o,value:{case:"streamChunk",value:new Lu({content:t,streamId:a,chunkIndex:Bp(u)})}});yield f.sendDataPacket(i,lu.RELIABLE),u+=1,s+=t.byteLength}}finally{t()}})},close(){return Gh(this,void 0,void 0,function*(){const e=new Ru({streamId:a}),t=new ou({destinationIdentities:o,value:{case:"streamTrailer",value:e}});yield f.sendDataPacket(t,lu.RELIABLE)})},abort(e){m.error("Sink error:",e)}});return new Dv(p,l)})}}class Uv extends Km{constructor(e,t,s,i,n){super(e,s,n),this.sid=t,this.receiver=i}get isLocal(){return!1}setMuted(e){this.isMuted!==e&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?Cm.Muted:Cm.Unmuted,this))}setMediaStream(e){this.mediaStream=e;const t=s=>{s.track===this._mediaStreamTrack&&(e.removeEventListener("removetrack",t),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(Cm.Ended,this))};e.addEventListener("removetrack",t)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return Gh(this,void 0,void 0,function*(){var e;if(!(null===(e=this.receiver)||void 0===e?void 0:e.getStats))return;return yield this.receiver.getStats()})}setPlayoutDelay(e){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=e:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),ev)),"undefined"!=typeof RTCRtpReceiver&&"getSynchronizationSources"in RTCRtpReceiver&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const e=()=>{var t;this.timeSyncHandle=requestAnimationFrame(()=>e());const s=null===(t=this.receiver)||void 0===t?void 0:t.getSynchronizationSources()[0];if(s){const{timestamp:e,rtpTimestamp:t}=s;t&&this.rtpTimestamp!==t&&(this.emit(Cm.TimeSyncUpdate,{timestamp:e,rtpTimestamp:t}),this.rtpTimestamp=t)}};e()}}class Fv extends Uv{constructor(e,t,s,i,n,r){super(e,t,Km.Kind.Audio,s,r),this.monitorReceiver=()=>Gh(this,void 0,void 0,function*(){if(!this.receiver)return void(this._currentBitrate=0);const e=yield this.getReceiverStats();e&&this.prevStats&&this.receiver&&(this._currentBitrate=tv(e,this.prevStats)),this.prevStats=e}),this.audioContext=i,this.webAudioPluginNodes=[],n&&(this.sinkId=n.deviceId)}setVolume(e){var t;for(const s of this.attachedElements)this.audioContext?null===(t=this.gainNode)||void 0===t||t.gain.setTargetAtTime(e,0,.1):s.volume=e;xp()&&this._mediaStreamTrack._setVolume(e),this.elementVolume=e}getVolume(){if(this.elementVolume)return this.elementVolume;if(xp())return 1;let e=0;return this.attachedElements.forEach(t=>{t.volume>e&&(e=t.volume)}),e}setSinkId(e){return Gh(this,void 0,void 0,function*(){this.sinkId=e,yield Promise.all(this.attachedElements.map(t=>{if(mp(t))return t.setSinkId(e)}))})}attach(e){const t=0===this.attachedElements.length;return e?super.attach(e):e=super.attach(),this.sinkId&&mp(e)&&e.setSinkId(this.sinkId).catch(e=>{this.log.error("Failed to set sink id on remote audio track",e,this.logContext)}),this.audioContext&&t&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,e),e.volume=0,e.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),e}detach(e){let t;return e?(t=super.detach(e),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(t=super.detach(),this.disconnectWebAudio()),t}setAudioContext(e){this.audioContext=e,e&&this.attachedElements.length>0?this.connectWebAudio(e,this.attachedElements[0]):e||this.disconnectWebAudio()}setWebAudioPlugins(e){this.webAudioPluginNodes=e,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(e,t){this.disconnectWebAudio(),this.sourceNode=e.createMediaStreamSource(t.srcObject);let s=this.sourceNode;this.webAudioPluginNodes.forEach(e=>{s.connect(e),s=e}),this.gainNode=e.createGain(),s.connect(this.gainNode),this.gainNode.connect(e.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),"running"!==e.state&&e.resume().then(()=>{"running"!==e.state&&this.emit(Cm.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}).catch(e=>{this.emit(Cm.AudioPlaybackFailed,e)})}disconnectWebAudio(){var e,t;null===(e=this.gainNode)||void 0===e||e.disconnect(),null===(t=this.sourceNode)||void 0===t||t.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return Gh(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;let e;return(yield this.receiver.getStats()).forEach(t=>{"inbound-rtp"===t.type&&(e={type:"audio",streamId:t.id,timestamp:t.timestamp,jitter:t.jitter,bytesReceived:t.bytesReceived,concealedSamples:t.concealedSamples,concealmentEvents:t.concealmentEvents,silentConcealedSamples:t.silentConcealedSamples,silentConcealmentEvents:t.silentConcealmentEvents,totalAudioEnergy:t.totalAudioEnergy,totalSamplesDuration:t.totalSamplesDuration})}),e})}}class Bv extends Uv{constructor(e,t,s,i,n){super(e,t,Km.Kind.Video,s,n),this.elementInfos=[],this.monitorReceiver=()=>Gh(this,void 0,void 0,function*(){if(!this.receiver)return void(this._currentBitrate=0);const e=yield this.getReceiverStats();e&&this.prevStats&&this.receiver&&(this._currentBitrate=tv(e,this.prevStats)),this.prevStats=e}),this.debouncedHandleResize=Rg(()=>{this.updateDimensions()},100),this.adaptiveStreamSettings=i}get isAdaptiveStream(){return void 0!==this.adaptiveStreamSettings}setStreamState(e){super.setStreamState(e),e===Km.StreamState.Active&&this.updateVisibility()}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(e){super.setMuted(e),this.attachedElements.forEach(t=>{e?Xm(this._mediaStreamTrack,t):Ym(this._mediaStreamTrack,t)})}attach(e){if(e?super.attach(e):e=super.attach(),this.adaptiveStreamSettings&&void 0===this.elementInfos.find(t=>t.element===e)){const t=new qv(e);this.observeElementInfo(t)}return e}observeElementInfo(e){this.adaptiveStreamSettings&&void 0===this.elementInfos.find(t=>t===e)?(e.handleResize=()=>{this.debouncedHandleResize()},e.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(e),e.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo(e){if(!this.isAdaptiveStream)return void this.log.warn("stopObservingElementInfo ignored",this.logContext);const t=this.elementInfos.filter(t=>t===e);for(const s of t)s.stopObserving();this.elementInfos=this.elementInfos.filter(t=>t!==e),this.updateVisibility(),this.debouncedHandleResize()}detach(e){let t=[];if(e)return this.stopObservingElement(e),super.detach(e);t=super.detach();for(const s of t)this.stopObservingElement(s);return t}getDecoderImplementation(){var e;return null===(e=this.prevStats)||void 0===e?void 0:e.decoderImplementation}getReceiverStats(){return Gh(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t,s="",i=new Map;return e.forEach(e=>{"inbound-rtp"===e.type?(s=e.codecId,t={type:"video",streamId:e.id,framesDecoded:e.framesDecoded,framesDropped:e.framesDropped,framesReceived:e.framesReceived,packetsReceived:e.packetsReceived,packetsLost:e.packetsLost,frameWidth:e.frameWidth,frameHeight:e.frameHeight,pliCount:e.pliCount,firCount:e.firCount,nackCount:e.nackCount,jitter:e.jitter,timestamp:e.timestamp,bytesReceived:e.bytesReceived,decoderImplementation:e.decoderImplementation}):"codec"===e.type&&i.set(e.id,e)}),t&&""!==s&&i.get(s)&&(t.mimeType=i.get(s).mimeType),t})}stopObservingElement(e){const t=this.elementInfos.filter(t=>t.element===e);for(const s of t)this.stopObservingElementInfo(s)}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return Gh(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility(e){var t,s;const i=this.elementInfos.reduce((e,t)=>Math.max(e,t.visibilityChangedAt||0),0),n=!(null!==(s=null===(t=this.adaptiveStreamSettings)||void 0===t?void 0:t.pauseVideoInBackground)&&void 0!==s&&!s)&&this.isInBackground,r=this.elementInfos.some(e=>e.pictureInPicture),a=this.elementInfos.some(e=>e.visible)&&!n||r;(this.lastVisible!==a||e)&&(!a&&Date.now()-i<100?Vm.setTimeout(()=>{this.updateVisibility()},100):(this.lastVisible=a,this.emit(Cm.VisibilityChanged,a,this)))}updateDimensions(){var e,t;let s=0,i=0;const n=this.getPixelDensity();for(const r of this.elementInfos){const e=r.width()*n,t=r.height()*n;e+t>s+i&&(s=e,i=t)}(null===(e=this.lastDimensions)||void 0===e?void 0:e.width)===s&&(null===(t=this.lastDimensions)||void 0===t?void 0:t.height)===i||(this.lastDimensions={width:s,height:i},this.emit(Cm.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var e;const t=null===(e=this.adaptiveStreamSettings)||void 0===e?void 0:e.pixelDensity;if("screen"===t)return _p();if(!t){return _p()>2?2:1}return t}}class qv{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(e,t){this.onVisibilityChanged=e=>{var t;const{target:s,isIntersecting:i}=e;s===this.element&&(this.isIntersecting=i,this.isPiP=$v(this.element),this.visibilityChangedAt=Date.now(),null===(t=this.handleVisibilityChanged)||void 0===t||t.call(this))},this.onEnterPiP=()=>{var e,t,s;null===(t=null===(e=window.documentPictureInPicture)||void 0===e?void 0:e.window)||void 0===t||t.addEventListener("pagehide",this.onLeavePiP),this.isPiP=$v(this.element),null===(s=this.handleVisibilityChanged)||void 0===s||s.call(this)},this.onLeavePiP=()=>{var e;this.isPiP=$v(this.element),null===(e=this.handleVisibilityChanged)||void 0===e||e.call(this)},this.element=e,this.isIntersecting=null!=t?t:zv(e),this.isPiP=bp()&&$v(e),this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var e,t,s;this.isIntersecting=zv(this.element),this.isPiP=$v(this.element),this.element.handleResize=()=>{var e;null===(e=this.handleResize)||void 0===e||e.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,Pp().observe(this.element),Ep().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP),null===(e=window.documentPictureInPicture)||void 0===e||e.addEventListener("enter",this.onEnterPiP),null===(s=null===(t=window.documentPictureInPicture)||void 0===t?void 0:t.window)||void 0===s||s.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var e,t,s,i,n;null===(e=Pp())||void 0===e||e.unobserve(this.element),null===(t=Ep())||void 0===t||t.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP),null===(s=window.documentPictureInPicture)||void 0===s||s.removeEventListener("enter",this.onEnterPiP),null===(n=null===(i=window.documentPictureInPicture)||void 0===i?void 0:i.window)||void 0===n||n.removeEventListener("pagehide",this.onLeavePiP)}}function $v(e){var t,s;return document.pictureInPictureElement===e||!!(null===(t=window.documentPictureInPicture)||void 0===t?void 0:t.window)&&zv(e,null===(s=window.documentPictureInPicture)||void 0===s?void 0:s.window)}function zv(e,t){const s=t||window;let i=e.offsetTop,n=e.offsetLeft;const r=e.offsetWidth,a=e.offsetHeight,{hidden:o}=e,{display:l}=getComputedStyle(e);for(;e.offsetParent;)i+=(e=e.offsetParent).offsetTop,n+=e.offsetLeft;return i<s.pageYOffset+s.innerHeight&&n<s.pageXOffset+s.innerWidth&&i+a>s.pageYOffset&&n+r>s.pageXOffset&&!o&&"none"!==l}class Hv extends Xh.EventEmitter{constructor(e,t,s,i){var n;super(),this.metadataMuted=!1,this.encryption=iu.NONE,this.log=qh,this.handleMuted=()=>{this.emit(Cm.Muted)},this.handleUnmuted=()=>{this.emit(Cm.Unmuted)},this.log=$h(null!==(n=null==i?void 0:i.loggerName)&&void 0!==n?n:Uh.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=e,this.trackSid=t,this.trackName=s,this.source=Km.Source.Unknown}setTrack(e){this.track&&(this.track.off(Cm.Muted,this.handleMuted),this.track.off(Cm.Unmuted,this.handleUnmuted)),this.track=e,e&&(e.on(Cm.Muted,this.handleMuted),e.on(Cm.Unmuted,this.handleUnmuted))}get logContext(){var e;return Object.assign(Object.assign({},null===(e=this.loggerContextCb)||void 0===e?void 0:e.call(this)),ng(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return void 0!==this.track}get isEncrypted(){return this.encryption!==iu.NONE}get audioTrack(){if($p(this.track))return this.track}get videoTrack(){if(zp(this.track))return this.track}updateInfo(e){this.trackSid=e.sid,this.trackName=e.name,this.source=Km.sourceFromProto(e.source),this.mimeType=e.mimeType,this.kind===Km.Kind.Video&&e.width>0&&(this.dimensions={width:e.width,height:e.height},this.simulcasted=e.simulcast),this.encryption=e.encryption,this.trackInfo=e,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:e}))}}var Vv,Gv,Jv,Wv,Kv,Yv,Xv;Vv=Hv||(Hv={}),(Gv=Vv.SubscriptionStatus||(Vv.SubscriptionStatus={})).Desired="desired",Gv.Subscribed="subscribed",Gv.Unsubscribed="unsubscribed",(Jv=Vv.PermissionStatus||(Vv.PermissionStatus={})).Allowed="allowed",Jv.NotAllowed="not_allowed";class Qv extends Hv{get isUpstreamPaused(){var e;return null===(e=this.track)||void 0===e?void 0:e.isUpstreamPaused}constructor(e,t,s,i){super(e,t.sid,t.name,i),this.track=void 0,this.handleTrackEnded=()=>{this.emit(Cm.Ended)},this.handleCpuConstrained=()=>{this.track&&zp(this.track)&&this.emit(Cm.CpuConstrained,this.track)},this.updateInfo(t),this.setTrack(s)}setTrack(e){this.track&&(this.track.off(Cm.Ended,this.handleTrackEnded),this.track.off(Cm.CpuConstrained,this.handleCpuConstrained)),super.setTrack(e),e&&(e.on(Cm.Ended,this.handleTrackEnded),e.on(Cm.CpuConstrained,this.handleCpuConstrained))}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return!0}mute(){return Gh(this,void 0,void 0,function*(){var e;return null===(e=this.track)||void 0===e?void 0:e.mute()})}unmute(){return Gh(this,void 0,void 0,function*(){var e;return null===(e=this.track)||void 0===e?void 0:e.unmute()})}pauseUpstream(){return Gh(this,void 0,void 0,function*(){var e;yield null===(e=this.track)||void 0===e?void 0:e.pauseUpstream()})}resumeUpstream(){return Gh(this,void 0,void 0,function*(){var e;yield null===(e=this.track)||void 0===e?void 0:e.resumeUpstream()})}getTrackFeatures(){var e;if($p(this.track)){const t=this.track.getSourceTrackSettings(),s=new Set;return t.autoGainControl&&s.add(Kd.TF_AUTO_GAIN_CONTROL),t.echoCancellation&&s.add(Kd.TF_ECHO_CANCELLATION),t.noiseSuppression&&s.add(Kd.TF_NOISE_SUPPRESSION),t.channelCount&&t.channelCount>1&&s.add(Kd.TF_STEREO),(null===(e=this.options)||void 0===e?void 0:e.dtx)||s.add(Kd.TF_NO_DTX),this.track.enhancedNoiseCancellation&&s.add(Kd.TF_ENHANCED_NOISE_CANCELLATION),Array.from(s.values())}return[]}}function Zv(e,t){return Gh(this,void 0,void 0,function*(){null!=e||(e={});let s=!1;const{audioProcessor:i,videoProcessor:n,optionsWithoutProcessor:r}=rg(e);let a=r.audio,o=r.video;if(i&&"object"==typeof r.audio&&(r.audio.processor=i),n&&"object"==typeof r.video&&(r.video.processor=n),e.audio&&"object"==typeof r.audio&&"string"==typeof r.audio.deviceId){const e=r.audio.deviceId;r.audio.deviceId={exact:e},s=!0,a=Object.assign(Object.assign({},r.audio),{deviceId:{ideal:e}})}if(r.video&&"object"==typeof r.video&&"string"==typeof r.video.deviceId){const e=r.video.deviceId;r.video.deviceId={exact:e},s=!0,o=Object.assign(Object.assign({},r.video),{deviceId:{ideal:e}})}(!0===r.audio||"object"==typeof r.audio&&!r.audio.deviceId)&&(r.audio={deviceId:"default"}),!0===r.video?r.video={deviceId:"default"}:"object"!=typeof r.video||r.video.deviceId||(r.video.deviceId="default");const l=Kp(r,Hg,Vg),c=Xp(l),d=navigator.mediaDevices.getUserMedia(c);r.audio&&(cg.userMediaPromiseMap.set("audioinput",d),d.catch(()=>cg.userMediaPromiseMap.delete("audioinput"))),r.video&&(cg.userMediaPromiseMap.set("videoinput",d),d.catch(()=>cg.userMediaPromiseMap.delete("videoinput")));try{const e=yield d;return yield Promise.all(e.getTracks().map(s=>Gh(this,void 0,void 0,function*(){const r="audio"===s.kind;let a,o=r?l.audio:l.video;"boolean"!=typeof o&&o||(o={});const d=r?c.audio:c.video;"boolean"!=typeof d&&(a=d);const u=s.getSettings().deviceId;(null==a?void 0:a.deviceId)&&Dp(a.deviceId)!==u?a.deviceId=u:a||(a={deviceId:u});const h=function(e,t,s){switch(e.kind){case"audio":return new av(e,t,!1,void 0,s);case"video":return new yv(e,t,!1,s);default:throw new Im("unsupported track type: ".concat(e.kind))}}(s,a,t);return h.kind===Km.Kind.Video?h.source=Km.Source.Camera:h.kind===Km.Kind.Audio&&(h.source=Km.Source.Microphone),h.mediaStream=e,$p(h)&&i?yield h.setProcessor(i):zp(h)&&n&&(yield h.setProcessor(n)),h})))}catch(Tx){if(!s)throw Tx;return Zv(Object.assign(Object.assign({},e),{audio:a,video:o}),t)}})}(Kv=Wv||(Wv={})).Excellent="excellent",Kv.Good="good",Kv.Poor="poor",Kv.Lost="lost",Kv.Unknown="unknown";class ey extends Xh.EventEmitter{get logContext(){var e,t;return Object.assign({},null===(t=null===(e=this.loggerOptions)||void 0===e?void 0:e.loggerContextCb)||void 0===t?void 0:t.call(e))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every(e=>e.isEncrypted)}get isAgent(){var e;return(null===(e=this.permissions)||void 0===e?void 0:e.agent)||this.kind===tu.AGENT}get isActive(){var e;return(null===(e=this.participantInfo)||void 0===e?void 0:e.state)===eu.ACTIVE}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(e,t,s,i,n,r){let a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:tu.STANDARD;var o;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=Wv.Unknown,this.log=qh,this.log=$h(null!==(o=null==r?void 0:r.loggerName)&&void 0!==o?o:Uh.Participant),this.loggerOptions=r,this.setMaxListeners(100),this.sid=e,this.identity=t,this.name=s,this.metadata=i,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=a,this._attributes=null!=n?n:{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(e){for(const[,t]of this.trackPublications)if(t.source===e)return t}getTrackPublicationByName(e){for(const[,t]of this.trackPublications)if(t.trackName===e)return t}waitUntilActive(){return this.isActive?Promise.resolve():(this.activeFuture||(this.activeFuture=new Op,this.once(wm.Active,()=>{var e,t;null===(t=null===(e=this.activeFuture)||void 0===e?void 0:e.resolve)||void 0===t||t.call(e),this.activeFuture=void 0})),this.activeFuture.promise)}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var e;const t=this.getTrackPublication(Km.Source.Camera);return!(null===(e=null==t?void 0:t.isMuted)||void 0===e||e)}get isMicrophoneEnabled(){var e;const t=this.getTrackPublication(Km.Source.Microphone);return!(null===(e=null==t?void 0:t.isMuted)||void 0===e||e)}get isScreenShareEnabled(){return!!this.getTrackPublication(Km.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(1e3*Number.parseInt(this.participantInfo.joinedAt.toString())):new Date}updateInfo(e){var t;return!(this.participantInfo&&this.participantInfo.sid===e.sid&&this.participantInfo.version>e.version)&&(this.identity=e.identity,this.sid=e.sid,this._setName(e.name),this._setMetadata(e.metadata),this._setAttributes(e.attributes),e.state===eu.ACTIVE&&(null===(t=this.participantInfo)||void 0===t?void 0:t.state)!==eu.ACTIVE&&this.emit(wm.Active),e.permission&&this.setPermissions(e.permission),this.participantInfo=e,!0)}_setMetadata(e){const t=this.metadata!==e,s=this.metadata;this.metadata=e,t&&this.emit(wm.ParticipantMetadataChanged,s)}_setName(e){const t=this.name!==e;this.name=e,t&&this.emit(wm.ParticipantNameChanged,e)}_setAttributes(e){const t=function(e,t){var s;void 0===e&&(e={}),void 0===t&&(t={});const i=[...Object.keys(t),...Object.keys(e)],n={};for(const r of i)e[r]!==t[r]&&(n[r]=null!==(s=t[r])&&void 0!==s?s:"");return n}(this.attributes,e);this._attributes=e,Object.keys(t).length>0&&this.emit(wm.AttributesChanged,t)}setPermissions(e){var t,s,i,n,r,a;const o=this.permissions,l=e.canPublish!==(null===(t=this.permissions)||void 0===t?void 0:t.canPublish)||e.canSubscribe!==(null===(s=this.permissions)||void 0===s?void 0:s.canSubscribe)||e.canPublishData!==(null===(i=this.permissions)||void 0===i?void 0:i.canPublishData)||e.hidden!==(null===(n=this.permissions)||void 0===n?void 0:n.hidden)||e.recorder!==(null===(r=this.permissions)||void 0===r?void 0:r.recorder)||e.canPublishSources.length!==this.permissions.canPublishSources.length||e.canPublishSources.some((e,t)=>{var s;return e!==(null===(s=this.permissions)||void 0===s?void 0:s.canPublishSources[t])})||e.canSubscribeMetrics!==(null===(a=this.permissions)||void 0===a?void 0:a.canSubscribeMetrics);return this.permissions=e,l&&this.emit(wm.ParticipantPermissionsChanged,o),l}setIsSpeaking(e){e!==this.isSpeaking&&(this.isSpeaking=e,e&&(this.lastSpokeAt=new Date),this.emit(wm.IsSpeakingChanged,e))}setConnectionQuality(e){const t=this._connectionQuality;this._connectionQuality=function(e){switch(e){case Hd.EXCELLENT:return Wv.Excellent;case Hd.GOOD:return Wv.Good;case Hd.POOR:return Wv.Poor;case Hd.LOST:return Wv.Lost;default:return Wv.Unknown}}(e),t!==this._connectionQuality&&this.emit(wm.ConnectionQualityChanged,this._connectionQuality)}setDisconnected(){var e,t;this.activeFuture&&(null===(t=(e=this.activeFuture).reject)||void 0===t||t.call(e,new Error("Participant disconnected")),this.activeFuture=void 0)}setAudioContext(e){this.audioContext=e,this.audioTrackPublications.forEach(t=>$p(t.track)&&t.track.setAudioContext(e))}addTrackPublication(e){e.on(Cm.Muted,()=>{this.emit(wm.TrackMuted,e)}),e.on(Cm.Unmuted,()=>{this.emit(wm.TrackUnmuted,e)});const t=e;switch(t.track&&(t.track.sid=e.trackSid),this.trackPublications.set(e.trackSid,e),e.kind){case Km.Kind.Audio:this.audioTrackPublications.set(e.trackSid,e);break;case Km.Kind.Video:this.videoTrackPublications.set(e.trackSid,e)}}}class ty extends ey{constructor(e,t,s,i,n,r){super(e,t,void 0,void 0,void 0,{loggerName:i.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=iu.NONE,this.enabledPublishVideoCodecs=[],this.pendingAcks=new Map,this.pendingResponses=new Map,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new Op)},this.handleReconnected=()=>{var e,t;null===(t=null===(e=this.reconnectFuture)||void 0===e?void 0:e.resolve)||void 0===t||t.call(e),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleClosing=()=>{var e,t,s,i,n,r;this.reconnectFuture&&(this.reconnectFuture.promise.catch(e=>this.log.warn(e.message,this.logContext)),null===(t=null===(e=this.reconnectFuture)||void 0===e?void 0:e.reject)||void 0===t||t.call(e,"Got disconnected during reconnection attempt"),this.reconnectFuture=void 0),this.signalConnectedFuture&&(null===(i=(s=this.signalConnectedFuture).reject)||void 0===i||i.call(s,"Got disconnected without signal connected"),this.signalConnectedFuture=void 0),null===(r=null===(n=this.activeAgentFuture)||void 0===n?void 0:n.reject)||void 0===r||r.call(n,"Got disconnected without active agent present"),this.activeAgentFuture=void 0,this.firstActiveAgent=void 0},this.handleSignalConnected=e=>{var t,s;e.participant&&this.updateInfo(e.participant),this.signalConnectedFuture||(this.signalConnectedFuture=new Op),null===(s=(t=this.signalConnectedFuture).resolve)||void 0===s||s.call(t)},this.handleSignalRequestResponse=e=>{const{requestId:t,reason:s,message:i}=e,n=this.pendingSignalRequests.get(t);n&&(s!==Ah.OK&&n.reject(new Mm(i,s)),this.pendingSignalRequests.delete(t))},this.handleDataPacket=e=>{switch(e.value.case){case"rpcResponse":let t=e.value.value,s=null,i=null;"payload"===t.value.case?s=t.value.value:"error"===t.value.case&&(i=Xg.fromProto(t.value.value)),this.handleIncomingRpcResponse(t.requestId,s,i);break;case"rpcAck":let n=e.value.value;this.handleIncomingRpcAck(n.requestId)}},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map(e=>function(e){var t,s,i;if(!e.participantSid&&!e.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new mh({participantIdentity:null!==(t=e.participantIdentity)&&void 0!==t?t:"",participantSid:null!==(s=e.participantSid)&&void 0!==s?s:"",allTracks:null!==(i=e.allowAll)&&void 0!==i&&i,trackSids:e.allowedTrackSids||[]})}(e)))},this.onTrackUnmuted=e=>{this.onTrackMuted(e,e.isUpstreamPaused)},this.onTrackMuted=(e,t)=>{void 0===t&&(t=!0),e.sid?this.engine.updateMuteStatus(e.sid,t):this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),ng(e)))},this.onTrackUpstreamPaused=e=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),ng(e))),this.onTrackMuted(e,!0)},this.onTrackUpstreamResumed=e=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),ng(e))),this.onTrackMuted(e,e.isMuted)},this.onTrackFeatureUpdate=e=>{const t=this.audioTrackPublications.get(e.sid);t?this.engine.client.sendUpdateLocalAudioTrack(t.trackSid,t.getTrackFeatures()):this.log.warn("Could not update local audio track settings, missing publication for track ".concat(e.sid),this.logContext)},this.onTrackCpuConstrained=(e,t)=>{this.log.debug("track cpu constrained",Object.assign(Object.assign({},this.logContext),ng(t))),this.emit(wm.LocalTrackCpuConstrained,e,t)},this.handleSubscribedQualityUpdate=e=>Gh(this,void 0,void 0,function*(){var t,s,i,n,r;if(!(null===(r=this.roomOptions)||void 0===r?void 0:r.dynacast))return;const a=this.videoTrackPublications.get(e.trackSid);if(!a)return void this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:e.trackSid}));if(!a.videoTrack)return;const o=yield a.videoTrack.setPublishingCodecs(e.subscribedCodecs);try{for(var l,c=!0,d=Wh(o);!(t=(l=yield d.next()).done);c=!0){n=l.value,c=!1;const e=n;tp(e)&&(this.log.debug("publish ".concat(e," for ").concat(a.videoTrack.sid),Object.assign(Object.assign({},this.logContext),ng(a))),yield this.publishAdditionalCodecForTrack(a.videoTrack,e,a.options))}}catch(u){s={error:u}}finally{try{c||t||!(i=d.return)||(yield i.call(d))}finally{if(s)throw s.error}}}),this.handleLocalTrackUnpublished=e=>{const t=this.trackPublications.get(e.trackSid);t?this.unpublishTrack(t.track):this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:e.trackSid}))},this.handleTrackEnded=e=>Gh(this,void 0,void 0,function*(){if(e.source===Km.Source.ScreenShare||e.source===Km.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),ng(e))),this.unpublishTrack(e);else if(e.isUserProvided)yield e.mute();else if(Vp(e)||Hp(e))try{if(bp())try{const t=yield null===navigator||void 0===navigator?void 0:navigator.permissions.query({name:e.source===Km.Source.Camera?"camera":"microphone"});if(t&&"denied"===t.state)throw this.log.warn("user has revoked access to ".concat(e.source),Object.assign(Object.assign({},this.logContext),ng(e))),t.onchange=()=>{"denied"!==t.state&&(e.isMuted||e.restartTrack(),t.onchange=null)},new Error("GetUserMedia Permission denied")}catch(Tx){}e.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),ng(e))),Vp(e)?yield e.restartTrack({deviceId:"default"}):yield e.restartTrack())}catch(Tx){this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),ng(e))),yield e.mute()}}),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=s,this.roomOptions=i,this.setupEngine(s),this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]),this.pendingSignalRequests=new Map,this.rpcHandlers=n,this.roomOutgoingDataStreamManager=r}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==iu.NONE}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setupEngine(e){var t;this.engine=e,this.engine.on(km.RemoteMute,(e,t)=>{const s=this.trackPublications.get(e);s&&s.track&&(t?s.mute():s.unmute())}),(null===(t=this.signalConnectedFuture)||void 0===t?void 0:t.isResolved)&&(this.signalConnectedFuture=void 0),this.engine.on(km.Connected,this.handleReconnected).on(km.SignalConnected,this.handleSignalConnected).on(km.SignalRestarted,this.handleReconnected).on(km.SignalResumed,this.handleReconnected).on(km.Restarting,this.handleReconnecting).on(km.Resuming,this.handleReconnecting).on(km.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(km.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(km.Closing,this.handleClosing).on(km.SignalRequestResponse,this.handleSignalRequestResponse).on(km.DataPacketReceived,this.handleDataPacket)}setMetadata(e){return Gh(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({metadata:e})})}setName(e){return Gh(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({name:e})})}setAttributes(e){return Gh(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({attributes:e})})}requestMetadataUpdate(e){return Gh(this,arguments,void 0,function(e){var t=this;let{metadata:s,name:i,attributes:n}=e;return function*(){return new Promise((e,r)=>Gh(t,void 0,void 0,function*(){var t,a;try{let o=!1;const l=yield this.engine.client.sendUpdateLocalMetadata(null!==(t=null!=s?s:this.metadata)&&void 0!==t?t:"",null!==(a=null!=i?i:this.name)&&void 0!==a?a:"",n),c=performance.now();for(this.pendingSignalRequests.set(l,{resolve:e,reject:e=>{r(e),o=!0},values:{name:i,metadata:s,attributes:n}});performance.now()-c<5e3&&!o;){if((!i||this.name===i)&&(!s||this.metadata===s)&&(!n||Object.entries(n).every(e=>{let[t,s]=e;return this.attributes[t]===s||""===s&&!this.attributes[t]})))return this.pendingSignalRequests.delete(l),void e();yield dp(50)}r(new Mm("Request to update local metadata timed out","TimeoutError"))}catch(Tx){Tx instanceof Error&&r(Tx)}}))}()})}setCameraEnabled(e,t,s){return this.setTrackEnabled(Km.Source.Camera,e,t,s)}setMicrophoneEnabled(e,t,s){return this.setTrackEnabled(Km.Source.Microphone,e,t,s)}setScreenShareEnabled(e,t,s){return this.setTrackEnabled(Km.Source.ScreenShare,e,t,s)}setE2EEEnabled(e){return Gh(this,void 0,void 0,function*(){this.encryptionType=e?iu.GCM:iu.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled(e,t,s,i){return Gh(this,void 0,void 0,function*(){var n,r;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:e,enabled:t})),this.republishPromise&&(yield this.republishPromise);let a=this.getTrackPublication(e);if(t)if(a)yield a.unmute();else{let t;if(this.pendingPublishing.has(e)){const t=yield this.waitForPendingPublicationOfSource(e);return t||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e})),yield null==t?void 0:t.unmute(),t}this.pendingPublishing.add(e);try{switch(e){case Km.Source.Camera:t=yield this.createTracks({video:null===(n=s)||void 0===n||n});break;case Km.Source.Microphone:t=yield this.createTracks({audio:null===(r=s)||void 0===r||r});break;case Km.Source.ScreenShare:t=yield this.createScreenTracks(Object.assign({},s));break;default:throw new Im(e)}}catch(Tx){throw null==t||t.forEach(e=>{e.stop()}),Tx instanceof Error&&this.emit(wm.MediaDevicesError,Tx,tg(e)),this.pendingPublishing.delete(e),Tx}for(const i of t){const t=Object.assign(Object.assign({},this.roomOptions.publishDefaults),s);e===Km.Source.Microphone&&$p(i)&&t.preConnectBuffer&&(this.log.info("starting preconnect buffer for microphone",Object.assign({},this.logContext)),i.startPreConnectBuffer())}try{const e=[];for(const n of t)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),ng(n))),e.push(this.publishTrack(n,i));const s=yield Promise.all(e);[a]=s}catch(Tx){throw null==t||t.forEach(e=>{e.stop()}),Tx}finally{this.pendingPublishing.delete(e)}}else if(!(null==a?void 0:a.track)&&this.pendingPublishing.has(e)&&(a=yield this.waitForPendingPublicationOfSource(e),a||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:e}))),a&&a.track)if(e===Km.Source.ScreenShare){a=yield this.unpublishTrack(a.track);const e=this.getTrackPublication(Km.Source.ScreenShareAudio);e&&e.track&&this.unpublishTrack(e.track)}else yield a.mute();return a})}enableCameraAndMicrophone(){return Gh(this,void 0,void 0,function*(){if(!this.pendingPublishing.has(Km.Source.Camera)&&!this.pendingPublishing.has(Km.Source.Microphone)){this.pendingPublishing.add(Km.Source.Camera),this.pendingPublishing.add(Km.Source.Microphone);try{const e=yield this.createTracks({audio:!0,video:!0});yield Promise.all(e.map(e=>this.publishTrack(e)))}finally{this.pendingPublishing.delete(Km.Source.Camera),this.pendingPublishing.delete(Km.Source.Microphone)}}})}createTracks(e){return Gh(this,void 0,void 0,function*(){var t,s;null!=e||(e={});const i=Kp(e,null===(t=this.roomOptions)||void 0===t?void 0:t.audioCaptureDefaults,null===(s=this.roomOptions)||void 0===s?void 0:s.videoCaptureDefaults);try{const e=yield Zv(i,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});return e.map(e=>($p(e)&&(this.microphoneError=void 0,e.setAudioContext(this.audioContext),e.source=Km.Source.Microphone,this.emit(wm.AudioStreamAcquired)),zp(e)&&(this.cameraError=void 0,e.source=Km.Source.Camera),e))}catch(n){throw n instanceof Error&&(e.audio&&(this.microphoneError=n),e.video&&(this.cameraError=n)),n}})}createScreenTracks(e){return Gh(this,void 0,void 0,function*(){if(void 0===e&&(e={}),void 0===navigator.mediaDevices.getDisplayMedia)throw new Pm("getDisplayMedia not supported");void 0!==e.resolution||function(){const e=qm();return"Safari"===(null==e?void 0:e.name)&&e.version.startsWith("17.")||"iOS"===(null==e?void 0:e.os)&&!!(null==e?void 0:e.osVersion)&&Cp(e.osVersion,"17")>=0}()||(e.resolution=lp.h1080fps30.resolution);const t=function(e){var t,s;let i=null===(t=e.video)||void 0===t||t;return e.resolution&&e.resolution.width>0&&e.resolution.height>0&&(i="boolean"==typeof i?{}:i,i=gp()?Object.assign(Object.assign({},i),{width:{max:e.resolution.width},height:{max:e.resolution.height},frameRate:e.resolution.frameRate}):Object.assign(Object.assign({},i),{width:{ideal:e.resolution.width},height:{ideal:e.resolution.height},frameRate:e.resolution.frameRate})),{audio:null!==(s=e.audio)&&void 0!==s&&s,video:i,controller:e.controller,selfBrowserSurface:e.selfBrowserSurface,surfaceSwitching:e.surfaceSwitching,systemAudio:e.systemAudio,preferCurrentTab:e.preferCurrentTab}}(e),s=yield navigator.mediaDevices.getDisplayMedia(t),i=s.getVideoTracks();if(0===i.length)throw new Im("no video track found");const n=new yv(i[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});n.source=Km.Source.ScreenShare,e.contentHint&&(n.mediaStreamTrack.contentHint=e.contentHint);const r=[n];if(s.getAudioTracks().length>0){this.emit(wm.AudioStreamAcquired);const e=new av(s.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});e.source=Km.Source.ScreenShareAudio,r.push(e)}return r})}publishTrack(e,t){return Gh(this,void 0,void 0,function*(){return this.publishOrRepublishTrack(e,t)})}publishOrRepublishTrack(e,t){return Gh(this,arguments,void 0,function(e,t){var s=this;let i=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return function*(){var n,r,a,o;let l,c;if(Vp(e)&&e.setAudioContext(s.audioContext),yield null===(n=s.reconnectFuture)||void 0===n?void 0:n.promise,s.republishPromise&&!i&&(yield s.republishPromise),qp(e)&&s.pendingPublishPromises.has(e)&&(yield s.pendingPublishPromises.get(e)),e instanceof MediaStreamTrack)l=e.getConstraints();else{let t;switch(l=e.constraints,e.source){case Km.Source.Microphone:t="audioinput";break;case Km.Source.Camera:t="videoinput"}t&&s.activeDeviceMap.has(t)&&(l=Object.assign(Object.assign({},l),{deviceId:s.activeDeviceMap.get(t)}))}if(e instanceof MediaStreamTrack)switch(e.kind){case"audio":e=new av(e,l,!0,s.audioContext,{loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});break;case"video":e=new yv(e,l,!0,{loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});break;default:throw new Im("unsupported MediaStreamTrack kind ".concat(e.kind))}else e.updateLoggerOptions({loggerName:s.roomOptions.loggerName,loggerContextCb:()=>s.logContext});if(s.trackPublications.forEach(t=>{t.track&&t.track===e&&(c=t)}),c)return s.log.warn("track has already been published, skipping",Object.assign(Object.assign({},s.logContext),ng(c))),c;const d=Object.assign(Object.assign({},s.roomOptions.publishDefaults),t),u="channelCount"in e.mediaStreamTrack.getSettings()&&2===e.mediaStreamTrack.getSettings().channelCount||2===e.mediaStreamTrack.getConstraints().channelCount,h=null!==(r=d.forceStereo)&&void 0!==r?r:u;h&&(void 0===d.dtx&&s.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},s.logContext),ng(e))),void 0===d.red&&s.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),null!==(a=d.dtx)&&void 0!==a||(d.dtx=!1),null!==(o=d.red)&&void 0!==o||(d.red=!1)),!function(){const e=qm(),t="17.2";if(e)return"Safari"!==e.name&&"iOS"!==e.os||!!("iOS"===e.os&&e.osVersion&&Cp(e.osVersion,t)>=0)||"Safari"===e.name&&Cp(e.version,t)>=0}()&&s.roomOptions.e2ee&&(s.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},s.logContext)),d.simulcast=!1),d.source&&(e.source=d.source);const f=new Promise((t,i)=>Gh(s,void 0,void 0,function*(){try{if(this.engine.client.currentState!==pg.CONNECTED){this.log.debug("deferring track publication until signal is connected",Object.assign(Object.assign({},this.logContext),{track:ng(e)}));const s=setTimeout(()=>{i(new Dm("publishing rejected as engine not connected within timeout",408))},15e3);yield this.waitUntilEngineConnected(),clearTimeout(s);const n=yield this.publish(e,d,h);t(n)}else try{const s=yield this.publish(e,d,h);t(s)}catch(Tx){i(Tx)}}catch(Tx){i(Tx)}}));s.pendingPublishPromises.set(e,f);try{return yield f}catch(Tx){throw Tx}finally{s.pendingPublishPromises.delete(e)}}()})}waitUntilEngineConnected(){return this.signalConnectedFuture||(this.signalConnectedFuture=new Op),this.signalConnectedFuture.promise}hasPermissionsToPublish(e){if(!this.permissions)return this.log.warn("no permissions present for publishing track",Object.assign(Object.assign({},this.logContext),ng(e))),!1;const{canPublish:t,canPublishSources:s}=this.permissions;return!(!t||0!==s.length&&!s.map(e=>function(e){switch(e){case $d.CAMERA:return Km.Source.Camera;case $d.MICROPHONE:return Km.Source.Microphone;case $d.SCREEN_SHARE:return Km.Source.ScreenShare;case $d.SCREEN_SHARE_AUDIO:return Km.Source.ScreenShareAudio;default:return Km.Source.Unknown}}(e)).includes(e.source))||(this.log.warn("insufficient permissions to publish",Object.assign(Object.assign({},this.logContext),ng(e))),!1)}publish(e,t,s){return Gh(this,void 0,void 0,function*(){var i,n,r,a,o,l,c,d,u,h;if(!this.hasPermissionsToPublish(e))throw new Dm("failed to publish track, insufficient permissions",403);Array.from(this.trackPublications.values()).find(t=>qp(e)&&t.source===e.source)&&e.source!==Km.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(e.source),Object.assign(Object.assign({},this.logContext),ng(e))),t.stopMicTrackOnMute&&$p(e)&&(e.stopOnMute=!0),e.source===Km.Source.ScreenShare&&pp()&&(t.simulcast=!1),"av1"!==t.videoCodec||function(){if(!("getCapabilities"in RTCRtpSender))return!1;if(gp()||pp())return!1;const e=RTCRtpSender.getCapabilities("video");let t=!1;if(e)for(const s of e.codecs)if("video/AV1"===s.mimeType){t=!0;break}return t}()||(t.videoCodec=void 0),"vp9"!==t.videoCodec||function(){if(!("getCapabilities"in RTCRtpSender))return!1;if(pp())return!1;if(gp()){const e=qm();if((null==e?void 0:e.version)&&Cp(e.version,"16")<0)return!1;if("iOS"===(null==e?void 0:e.os)&&(null==e?void 0:e.osVersion)&&Cp(e.osVersion,"16")<0)return!1}const e=RTCRtpSender.getCapabilities("video");let t=!1;if(e)for(const s of e.codecs)if("video/VP9"===s.mimeType){t=!0;break}return t}()||(t.videoCodec=void 0),void 0===t.videoCodec&&(t.videoCodec=$g),this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some(e=>t.videoCodec===sg(e.mime))||(t.videoCodec=sg(this.enabledPublishVideoCodecs[0].mime)));const f=t.videoCodec;e.on(Cm.Muted,this.onTrackMuted),e.on(Cm.Unmuted,this.onTrackUnmuted),e.on(Cm.Ended,this.handleTrackEnded),e.on(Cm.UpstreamPaused,this.onTrackUpstreamPaused),e.on(Cm.UpstreamResumed,this.onTrackUpstreamResumed),e.on(Cm.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const m=[],p=!(null===(i=t.dtx)||void 0===i||i),g=e.getSourceTrackSettings();g.autoGainControl&&m.push(Kd.TF_AUTO_GAIN_CONTROL),g.echoCancellation&&m.push(Kd.TF_ECHO_CANCELLATION),g.noiseSuppression&&m.push(Kd.TF_NOISE_SUPPRESSION),g.channelCount&&g.channelCount>1&&m.push(Kd.TF_STEREO),p&&m.push(Kd.TF_NO_DTX),Vp(e)&&e.hasPreConnectBuffer&&m.push(Kd.TF_PRECONNECT_BUFFER);const v=new qu({cid:e.mediaStreamTrack.id,name:t.name,type:Km.kindToProto(e.kind),muted:e.isMuted,source:Km.sourceToProto(e.source),disableDtx:p,encryption:this.encryptionType,stereo:s,disableRed:this.isE2EEEnabled||!(null===(n=t.red)||void 0===n||n),stream:null==t?void 0:t.stream,backupCodecPolicy:null==t?void 0:t.backupCodecPolicy,audioFeatures:m});let y;if(e.kind===Km.Kind.Video){let s={width:0,height:0};try{s=yield e.waitForDimensions()}catch(Tx){const i=null!==(a=null===(r=this.roomOptions.videoCaptureDefaults)||void 0===r?void 0:r.resolution)&&void 0!==a?a:ap.h720.resolution;s={width:i.width,height:i.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),ng(e)),{dims:s}))}v.width=s.width,v.height=s.height,Hp(e)&&(fp(f)&&(e.source===Km.Source.ScreenShare&&(t.scalabilityMode="L1T3","contentHint"in e.mediaStreamTrack&&(e.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),ng(e))))),t.scalabilityMode=null!==(o=t.scalabilityMode)&&void 0!==o?o:"L3T3_KEY"),v.simulcastCodecs=[new Bu({codec:f,cid:e.mediaStreamTrack.id})],!0===t.backupCodec&&(t.backupCodec={codec:$g}),t.backupCodec&&f!==t.backupCodec.codec&&v.encryption===iu.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),v.simulcastCodecs.push(new Bu({codec:t.backupCodec.codec,cid:""})))),y=fv(e.source===Km.Source.ScreenShare,v.width,v.height,t),v.layers=wv(v.width,v.height,y,fp(t.videoCodec))}else e.kind===Km.Kind.Audio&&(y=[{maxBitrate:null===(l=t.audioPreset)||void 0===l?void 0:l.maxBitrate,priority:null!==(d=null===(c=t.audioPreset)||void 0===c?void 0:c.priority)&&void 0!==d?d:"high",networkPriority:null!==(h=null===(u=t.audioPreset)||void 0===u?void 0:u.priority)&&void 0!==h?h:"high"}]);if(!this.engine||this.engine.isClosed)throw new Rm("cannot publish track when not connected");const b=()=>Gh(this,void 0,void 0,function*(){var s,i,n;if(!this.engine.pcManager)throw new Rm("pcManager is not ready");if(e.sender=yield this.engine.createSender(e,t,y),this.emit(wm.LocalSenderCreated,e.sender,e),Hp(e)&&(null!==(s=t.degradationPreference)&&void 0!==s||(t.degradationPreference=function(e){return e.source===Km.Source.ScreenShare||e.constraints.height&&Dp(e.constraints.height)>=1080?"maintain-resolution":"balanced"}(e)),e.setDegradationPreference(t.degradationPreference)),y)if(pp()&&e.kind===Km.Kind.Audio){let t;for(const s of this.engine.pcManager.publisher.getTransceivers())if(s.sender===e.sender){t=s;break}t&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:t,codec:"opus",maxbr:(null===(i=y[0])||void 0===i?void 0:i.maxBitrate)?y[0].maxBitrate/1e3:0})}else e.codec&&fp(e.codec)&&(null===(n=y[0])||void 0===n?void 0:n.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:v.cid,codec:e.codec,maxbr:y[0].maxBitrate/1e3});yield this.engine.negotiate()});let x;const w=new Promise((t,s)=>Gh(this,void 0,void 0,function*(){var i;try{x=yield this.engine.addTrack(v),t(x)}catch(n){e.sender&&(null===(i=this.engine.pcManager)||void 0===i?void 0:i.publisher)&&(this.engine.pcManager.publisher.removeTrack(e.sender),yield this.engine.negotiate().catch(t=>{this.log.error("failed to negotiate after removing track due to failed add track request",Object.assign(Object.assign(Object.assign({},this.logContext),ng(e)),{error:t}))})),s(n)}}));if(this.enabledPublishVideoCodecs.length>0){const e=yield Promise.all([w,b()]);x=e[0]}else{let s;if(x=yield w,x.codecs.forEach(e=>{void 0===s&&(s=e.mimeType)}),s&&e.kind===Km.Kind.Video){const i=sg(s);i!==f&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),ng(e)),{codec:i})),t.videoCodec=i,y=fv(e.source===Km.Source.ScreenShare,v.width,v.height,t))}yield b()}const S=new Qv(e.kind,x,e,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});if(S.on(Cm.CpuConstrained,e=>this.onTrackCpuConstrained(e,S)),S.options=t,e.sid=x.sid,this.log.debug("publishing ".concat(e.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:y,trackInfo:x})),Hp(e)?e.startMonitor(this.engine.client):Vp(e)&&e.startMonitor(),this.addTrackPublication(S),this.emit(wm.LocalTrackPublished,S),Vp(e)&&x.audioFeatures.includes(Kd.TF_PRECONNECT_BUFFER)){const t=e.getPreConnectBuffer(),s=e.getPreConnectBufferMimeType();if(this.on(wm.LocalTrackSubscribed,t=>{if(t.trackSid===x.sid){if(!e.hasPreConnectBuffer)return void this.log.warn("subscribe event came to late, buffer already closed",this.logContext);this.log.debug("finished recording preconnect buffer",Object.assign(Object.assign({},this.logContext),ng(e))),e.stopPreConnectBuffer()}}),t){new Promise((i,n)=>Gh(this,void 0,void 0,function*(){var r,a,o,l,c,d;try{this.log.debug("waiting for agent",Object.assign(Object.assign({},this.logContext),ng(e)));const p=setTimeout(()=>{n(new Error("agent not active within 10 seconds"))},1e4),v=yield this.waitUntilActiveAgentPresent();clearTimeout(p),this.log.debug("sending preconnect buffer",Object.assign(Object.assign({},this.logContext),ng(e)));const y=yield this.streamBytes({name:"preconnect-buffer",mimeType:s,topic:"lk.agent.pre-connect-audio-buffer",destinationIdentities:[v.identity],attributes:{trackId:S.trackSid,sampleRate:String(null!==(c=g.sampleRate)&&void 0!==c?c:"48000"),channels:String(null!==(d=g.channelCount)&&void 0!==d?d:"1")}});try{for(var u,h=!0,f=Wh(t);!(r=(u=yield f.next()).done);h=!0){l=u.value,h=!1;const e=l;yield y.write(e)}}catch(m){a={error:m}}finally{try{h||r||!(o=f.return)||(yield o.call(f))}finally{if(a)throw a.error}}yield y.close(),i()}catch(Tx){n(Tx)}})).then(()=>{this.log.debug("preconnect buffer sent successfully",Object.assign(Object.assign({},this.logContext),ng(e)))}).catch(t=>{this.log.error("error sending preconnect buffer",Object.assign(Object.assign(Object.assign({},this.logContext),ng(e)),{error:t}))})}}return S})}get isLocal(){return!0}publishAdditionalCodecForTrack(e,t,s){return Gh(this,void 0,void 0,function*(){var i;if(this.encryptionType!==iu.NONE)return;let n;if(this.trackPublications.forEach(t=>{t.track&&t.track===e&&(n=t)}),!n)throw new Im("track is not published");if(!Hp(e))throw new Im("track is not a video track");const r=Object.assign(Object.assign({},null===(i=this.roomOptions)||void 0===i?void 0:i.publishDefaults),s),a=function(e,t,s){var i,n,r,a;if(!s.backupCodec||!0===s.backupCodec||s.backupCodec.codec===s.videoCodec)return;t!==s.backupCodec.codec&&qh.warn("requested a different codec than specified as backup",{serverRequested:t,backup:s.backupCodec.codec}),s.videoCodec=t,s.videoEncoding=s.backupCodec.encoding;const o=e.mediaStreamTrack.getSettings(),l=null!==(i=o.width)&&void 0!==i?i:null===(n=e.dimensions)||void 0===n?void 0:n.width,c=null!==(r=o.height)&&void 0!==r?r:null===(a=e.dimensions)||void 0===a?void 0:a.height;return e.source===Km.Source.ScreenShare&&s.simulcast&&(s.simulcast=!1),fv(e.source===Km.Source.ScreenShare,l,c,s)}(e,t,r);if(!a)return void this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),ng(e)));const o=e.addSimulcastTrack(t,a);if(!o)return;const l=new qu({cid:o.mediaStreamTrack.id,type:Km.kindToProto(e.kind),muted:e.isMuted,source:Km.sourceToProto(e.source),sid:e.sid,simulcastCodecs:[{codec:r.videoCodec,cid:o.mediaStreamTrack.id}]});if(l.layers=wv(l.width,l.height,a),!this.engine||this.engine.isClosed)throw new Rm("cannot publish track when not connected");const c=(yield Promise.all([this.engine.addTrack(l),(()=>Gh(this,void 0,void 0,function*(){yield this.engine.createSimulcastSender(e,o,r,a),yield this.engine.negotiate()}))()]))[0];this.log.debug("published ".concat(t," for track ").concat(e.sid),Object.assign(Object.assign({},this.logContext),{encodings:a,trackInfo:c}))})}unpublishTrack(e,t){return Gh(this,void 0,void 0,function*(){var s,i;if(qp(e)){const t=this.pendingPublishPromises.get(e);t&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),ng(e))),yield t)}const n=this.getPublicationForTrack(e),r=n?ng(n):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),r)),!n||!n.track)return void this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),r));(e=n.track).off(Cm.Muted,this.onTrackMuted),e.off(Cm.Unmuted,this.onTrackUnmuted),e.off(Cm.Ended,this.handleTrackEnded),e.off(Cm.UpstreamPaused,this.onTrackUpstreamPaused),e.off(Cm.UpstreamResumed,this.onTrackUpstreamResumed),e.off(Cm.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),void 0===t&&(t=null===(i=null===(s=this.roomOptions)||void 0===s?void 0:s.stopLocalTrackOnUnpublish)||void 0===i||i),t?e.stop():e.stopMonitor();let a=!1;const o=e.sender;if(e.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<Wg.FAILED&&o)try{for(const e of this.engine.pcManager.publisher.getTransceivers())e.sender===o&&(e.direction="inactive",a=!0);if(this.engine.removeTrack(o)&&(a=!0),Hp(e)){for(const[,t]of e.simulcastCodecs)t.sender&&(this.engine.removeTrack(t.sender)&&(a=!0),t.sender=void 0);e.simulcastCodecs.clear()}}catch(Tx){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),r),{error:Tx}))}switch(this.trackPublications.delete(n.trackSid),n.kind){case Km.Kind.Audio:this.audioTrackPublications.delete(n.trackSid);break;case Km.Kind.Video:this.videoTrackPublications.delete(n.trackSid)}return this.emit(wm.LocalTrackUnpublished,n),n.setTrack(void 0),a&&(yield this.engine.negotiate()),n})}unpublishTracks(e){return Gh(this,void 0,void 0,function*(){return(yield Promise.all(e.map(e=>this.unpublishTrack(e)))).filter(e=>!!e)})}republishAllTracks(e){return Gh(this,arguments,void 0,function(e){var t=this;let s=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return function*(){t.republishPromise&&(yield t.republishPromise),t.republishPromise=new Promise((i,n)=>Gh(t,void 0,void 0,function*(){try{const t=[];this.trackPublications.forEach(s=>{s.track&&(e&&(s.options=Object.assign(Object.assign({},s.options),e)),t.push(s))}),yield Promise.all(t.map(e=>Gh(this,void 0,void 0,function*(){const t=e.track;yield this.unpublishTrack(t,!1),!s||t.isMuted||t.source===Km.Source.ScreenShare||t.source===Km.Source.ScreenShareAudio||!Vp(t)&&!Hp(t)||t.isUserProvided||(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:e.trackSid})),yield t.restartTrack()),yield this.publishOrRepublishTrack(t,e.options,!0)}))),i()}catch(t){n(t)}finally{this.republishPromise=void 0}})),yield t.republishPromise}()})}publishData(e){return Gh(this,arguments,void 0,function(e){var t=this;let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return function*(){const i=s.reliable?lu.RELIABLE:lu.LOSSY,n=s.destinationIdentities,r=s.topic,a=new ou({kind:i,value:{case:"user",value:new uu({participantIdentity:t.identity,payload:e,destinationIdentities:n,topic:r})}});yield t.engine.sendDataPacket(a,i)}()})}publishDtmf(e,t){return Gh(this,void 0,void 0,function*(){const s=new ou({kind:lu.RELIABLE,value:{case:"sipDtmf",value:new hu({code:e,digit:t})}});yield this.engine.sendDataPacket(s,lu.RELIABLE)})}sendChatMessage(e,t){return Gh(this,void 0,void 0,function*(){const s={id:crypto.randomUUID(),message:e,timestamp:Date.now(),attachedFiles:null==t?void 0:t.attachments},i=new ou({value:{case:"chatMessage",value:new pu(Object.assign(Object.assign({},s),{timestamp:wc.parse(s.timestamp)}))}});return yield this.engine.sendDataPacket(i,lu.RELIABLE),this.emit(wm.ChatMessage,s),s})}editChatMessage(e,t){return Gh(this,void 0,void 0,function*(){const s=Object.assign(Object.assign({},t),{message:e,editTimestamp:Date.now()}),i=new ou({value:{case:"chatMessage",value:new pu(Object.assign(Object.assign({},s),{timestamp:wc.parse(s.timestamp),editTimestamp:wc.parse(s.editTimestamp)}))}});return yield this.engine.sendDataPacket(i,lu.RELIABLE),this.emit(wm.ChatMessage,s),s})}sendText(e,t){return Gh(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendText(e,t)})}streamText(e){return Gh(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamText(e)})}sendFile(e,t){return Gh(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendFile(e,t)})}streamBytes(e){return Gh(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamBytes(e)})}performRpc(e){return Gh(this,arguments,void 0,function(e){var t=this;let{destinationIdentity:s,method:i,payload:n,responseTimeout:r=1e4}=e;return function*(){return new Promise((e,a)=>Gh(t,void 0,void 0,function*(){var t,o,l,c;if(Qg(n)>15360)return void a(Xg.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));if((null===(o=null===(t=this.engine.latestJoinResponse)||void 0===t?void 0:t.serverInfo)||void 0===o?void 0:o.version)&&Cp(null===(c=null===(l=this.engine.latestJoinResponse)||void 0===l?void 0:l.serverInfo)||void 0===c?void 0:c.version,"1.8.0")<0)return void a(Xg.builtIn("UNSUPPORTED_SERVER"));const d=crypto.randomUUID();yield this.publishRpcRequest(s,d,i,n,r-2e3);const u=setTimeout(()=>{this.pendingAcks.delete(d),a(Xg.builtIn("CONNECTION_TIMEOUT")),this.pendingResponses.delete(d),clearTimeout(h)},2e3);this.pendingAcks.set(d,{resolve:()=>{clearTimeout(u)},participantIdentity:s});const h=setTimeout(()=>{this.pendingResponses.delete(d),a(Xg.builtIn("RESPONSE_TIMEOUT"))},r);this.pendingResponses.set(d,{resolve:(t,s)=>{clearTimeout(h),this.pendingAcks.has(d)&&(this.pendingAcks.delete(d),clearTimeout(u)),s?a(s):e(null!=t?t:"")},participantIdentity:s})}))}()})}registerRpcMethod(e,t){this.rpcHandlers.has(e)&&this.log.warn("you're overriding the RPC handler for method ".concat(e,", in the future this will throw an error")),this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setTrackSubscriptionPermissions(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];this.participantTrackPermissions=t,this.allParticipantsAllowedToSubscribe=e,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck(e){const t=this.pendingAcks.get(e);t&&(t.resolve(),this.pendingAcks.delete(e))}handleIncomingRpcResponse(e,t,s){const i=this.pendingResponses.get(e);i&&(i.resolve(t,s),this.pendingResponses.delete(e))}publishRpcRequest(e,t,s,i,n){return Gh(this,void 0,void 0,function*(){const r=new ou({destinationIdentities:[e],kind:lu.RELIABLE,value:{case:"rpcRequest",value:new gu({id:t,method:s,payload:i,responseTimeoutMs:n,version:1})}});yield this.engine.sendDataPacket(r,lu.RELIABLE)})}handleParticipantDisconnected(e){for(const[t,{participantIdentity:s}]of this.pendingAcks)s===e&&this.pendingAcks.delete(t);for(const[t,{participantIdentity:s,resolve:i}]of this.pendingResponses)s===e&&(i(null,Xg.builtIn("RECIPIENT_DISCONNECTED")),this.pendingResponses.delete(t))}setEnabledPublishCodecs(e){this.enabledPublishVideoCodecs=e.filter(e=>"video"===e.mime.split("/")[0].toLowerCase())}updateInfo(e){return!!super.updateInfo(e)&&(e.tracks.forEach(e=>{var t,s;const i=this.trackPublications.get(e.sid);if(i){const n=i.isMuted||null!==(s=null===(t=i.track)||void 0===t?void 0:t.isUpstreamPaused)&&void 0!==s&&s;n!==e.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),ng(i)),{mutedOnServer:n})),this.engine.client.sendMuteTrack(e.sid,n))}}),!0)}setActiveAgent(e){var t,s,i,n;this.firstActiveAgent=e,e&&!this.firstActiveAgent&&(this.firstActiveAgent=e),e?null===(s=null===(t=this.activeAgentFuture)||void 0===t?void 0:t.resolve)||void 0===s||s.call(t,e):null===(n=null===(i=this.activeAgentFuture)||void 0===i?void 0:i.reject)||void 0===n||n.call(i,"Agent disconnected"),this.activeAgentFuture=void 0}waitUntilActiveAgentPresent(){return this.firstActiveAgent?Promise.resolve(this.firstActiveAgent):(this.activeAgentFuture||(this.activeAgentFuture=new Op),this.activeAgentFuture.promise)}getPublicationForTrack(e){let t;return this.trackPublications.forEach(s=>{const i=s.track;i&&(e instanceof MediaStreamTrack?(Vp(i)||Hp(i))&&i.mediaStreamTrack===e&&(t=s):e===i&&(t=s))}),t}waitForPendingPublicationOfSource(e){return Gh(this,void 0,void 0,function*(){const t=Date.now();for(;Date.now()<t+1e4;){const t=Array.from(this.pendingPublishPromises.entries()).find(t=>{let[s]=t;return s.source===e});if(t)return t[1];yield dp(20)}})}}class sy extends Hv{constructor(e,t,s,i){super(e,t.sid,t.name,i),this.track=void 0,this.allowed=!0,this.requestedDisabled=void 0,this.visible=!0,this.handleEnded=e=>{this.setTrack(void 0),this.emit(Cm.Ended,e)},this.handleVisibilityChange=e=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(e),this.logContext),this.visible=e,this.emitTrackUpdate()},this.handleVideoDimensionsChange=e=>{this.log.debug("adaptivestream video dimensions ".concat(e.width,"x").concat(e.height),this.logContext),this.videoDimensionsAdaptiveStream=e,this.emitTrackUpdate()},this.subscribed=s,this.updateInfo(t)}setSubscribed(e){const t=this.subscriptionStatus,s=this.permissionStatus;this.subscribed=e,e&&(this.allowed=!0);const i=new Yu({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new xu({participantSid:"",trackSids:[this.trackSid]})]});this.emit(Cm.UpdateSubscription,i),this.emitSubscriptionUpdateIfChanged(t),this.emitPermissionUpdateIfChanged(s)}get subscriptionStatus(){return!1===this.subscribed?Hv.SubscriptionStatus.Unsubscribed:super.isSubscribed?Hv.SubscriptionStatus.Subscribed:Hv.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?Hv.PermissionStatus.Allowed:Hv.PermissionStatus.NotAllowed}get isSubscribed(){return!1!==this.subscribed&&super.isSubscribed}get isDesired(){return!1!==this.subscribed}get isEnabled(){return void 0!==this.requestedDisabled?!this.requestedDisabled:!this.isAdaptiveStream||this.visible}get isLocal(){return!1}setEnabled(e){this.isManualOperationAllowed()&&this.requestedDisabled!==!e&&(this.requestedDisabled=!e,this.emitTrackUpdate())}setVideoQuality(e){this.isManualOperationAllowed()&&this.requestedMaxQuality!==e&&(this.requestedMaxQuality=e,this.requestedVideoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(e){var t,s;this.isManualOperationAllowed()&&((null===(t=this.requestedVideoDimensions)||void 0===t?void 0:t.width)===e.width&&(null===(s=this.requestedVideoDimensions)||void 0===s?void 0:s.height)===e.height||(Wp(this.track)&&(this.requestedVideoDimensions=e),this.requestedMaxQuality=void 0,this.emitTrackUpdate()))}setVideoFPS(e){this.isManualOperationAllowed()&&Wp(this.track)&&this.fps!==e&&(this.fps=e,this.emitTrackUpdate())}get videoQuality(){var e;return null!==(e=this.requestedMaxQuality)&&void 0!==e?e:Jm.HIGH}setTrack(e){const t=this.subscriptionStatus,s=this.permissionStatus,i=this.track;i!==e&&(i&&(i.off(Cm.VideoDimensionsChanged,this.handleVideoDimensionsChange),i.off(Cm.VisibilityChanged,this.handleVisibilityChange),i.off(Cm.Ended,this.handleEnded),i.detach(),i.stopMonitor(),this.emit(Cm.Unsubscribed,i)),super.setTrack(e),e&&(e.sid=this.trackSid,e.on(Cm.VideoDimensionsChanged,this.handleVideoDimensionsChange),e.on(Cm.VisibilityChanged,this.handleVisibilityChange),e.on(Cm.Ended,this.handleEnded),this.emit(Cm.Subscribed,e)),this.emitPermissionUpdateIfChanged(s),this.emitSubscriptionUpdateIfChanged(t))}setAllowed(e){const t=this.subscriptionStatus,s=this.permissionStatus;this.allowed=e,this.emitPermissionUpdateIfChanged(s),this.emitSubscriptionUpdateIfChanged(t)}setSubscriptionError(e){this.emit(Cm.SubscriptionFailed,e)}updateInfo(e){super.updateInfo(e);const t=this.metadataMuted;this.metadataMuted=e.muted,this.track?this.track.setMuted(e.muted):t!==e.muted&&this.emit(e.muted?Cm.Muted:Cm.Unmuted)}emitSubscriptionUpdateIfChanged(e){const t=this.subscriptionStatus;e!==t&&this.emit(Cm.SubscriptionStatusChanged,t,e)}emitPermissionUpdateIfChanged(e){this.permissionStatus!==e&&this.emit(Cm.SubscriptionPermissionChanged,this.permissionStatus,e)}isManualOperationAllowed(){return!!this.isDesired||(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return Wp(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){const e=new Xu({trackSids:[this.trackSid],disabled:!this.isEnabled,fps:this.fps});if(this.kind===Km.Kind.Video){let n=this.requestedVideoDimensions;if(void 0!==this.videoDimensionsAdaptiveStream)if(n){ag(this.videoDimensionsAdaptiveStream,n)&&(this.log.debug("using adaptive stream dimensions instead of requested",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),n=this.videoDimensionsAdaptiveStream)}else if(void 0!==this.requestedMaxQuality&&this.trackInfo){const e=(t=this.trackInfo,s=this.requestedMaxQuality,null===(i=t.layers)||void 0===i?void 0:i.find(e=>e.quality===s));e&&ag(this.videoDimensionsAdaptiveStream,e)&&(this.log.debug("using adaptive stream dimensions instead of max quality layer",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),n=this.videoDimensionsAdaptiveStream)}else this.log.debug("using adaptive stream dimensions",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),n=this.videoDimensionsAdaptiveStream;n?(e.width=Math.ceil(n.width),e.height=Math.ceil(n.height)):void 0!==this.requestedMaxQuality?(this.log.debug("using requested max quality",Object.assign(Object.assign({},this.logContext),{quality:this.requestedMaxQuality})),e.quality=this.requestedMaxQuality):(this.log.debug("using default quality",Object.assign(Object.assign({},this.logContext),{quality:Jm.HIGH})),e.quality=Jm.HIGH)}var t,s,i;this.emit(Cm.UpdateSettings,e)}}class iy extends ey{static fromParticipantInfo(e,t,s){return new iy(e,t.sid,t.identity,t.name,t.metadata,t.attributes,s,t.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(e,t,s,i,n,r,a){super(t,s||"",i,n,r,a,arguments.length>7&&void 0!==arguments[7]?arguments[7]:tu.STANDARD),this.signalClient=e,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication(e){super.addTrackPublication(e),e.on(Cm.UpdateSettings,t=>{this.log.debug("send update settings",Object.assign(Object.assign(Object.assign({},this.logContext),ng(e)),{settings:t})),this.signalClient.sendUpdateTrackSettings(t)}),e.on(Cm.UpdateSubscription,e=>{e.participantTracks.forEach(e=>{e.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(e)}),e.on(Cm.SubscriptionPermissionChanged,t=>{this.emit(wm.TrackSubscriptionPermissionChanged,e,t)}),e.on(Cm.SubscriptionStatusChanged,t=>{this.emit(wm.TrackSubscriptionStatusChanged,e,t)}),e.on(Cm.Subscribed,t=>{this.emit(wm.TrackSubscribed,t,e)}),e.on(Cm.Unsubscribed,t=>{this.emit(wm.TrackUnsubscribed,t,e)}),e.on(Cm.SubscriptionFailed,t=>{this.emit(wm.TrackSubscriptionFailed,e.trackSid,t)})}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setVolume(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Km.Source.Microphone;this.volumeMap.set(t,e);const s=this.getTrackPublication(t);s&&s.track&&s.track.setVolume(e)}getVolume(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Km.Source.Microphone;const t=this.getTrackPublication(e);return t&&t.track?t.track.getVolume():this.volumeMap.get(e)}addSubscribedMediaTrack(e,t,s,i,n,r){let a=this.getTrackPublicationBySid(t);if(a||t.startsWith("TR")||this.trackPublications.forEach(t=>{a||e.kind!==t.kind.toString()||(a=t)}),!a)return 0===r?(this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:t})),void this.emit(wm.TrackSubscriptionFailed,t)):(void 0===r&&(r=20),void setTimeout(()=>{this.addSubscribedMediaTrack(e,t,s,i,n,r-1)},150));if("ended"===e.readyState)return this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),ng(a))),void this.emit(wm.TrackSubscriptionFailed,t);let o;return o="video"===e.kind?new Bv(e,t,i,n):new Fv(e,t,i,this.audioContext,this.audioOutput),o.source=a.source,o.isMuted=a.isMuted,o.setMediaStream(s),o.start(),a.setTrack(o),this.volumeMap.has(a.source)&&Gp(o)&&$p(o)&&o.setVolume(this.volumeMap.get(a.source)),a}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(e){return this.trackPublications.get(e)}updateInfo(e){if(!super.updateInfo(e))return!1;const t=new Map,s=new Map;return e.tracks.forEach(e=>{var i,n;let r=this.getTrackPublicationBySid(e.sid);if(r)r.updateInfo(e);else{const t=Km.kindFromProto(e.type);if(!t)return;r=new sy(t,e,null===(i=this.signalClient.connectOptions)||void 0===i?void 0:i.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:null===(n=this.loggerOptions)||void 0===n?void 0:n.loggerName}),r.updateInfo(e),s.set(e.sid,r);const a=Array.from(this.trackPublications.values()).find(e=>e.source===(null==r?void 0:r.source));a&&r.source!==Km.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(r.source),Object.assign(Object.assign({},this.logContext),{oldTrack:ng(a),newTrack:ng(r)})),this.addTrackPublication(r)}t.set(e.sid,r)}),this.trackPublications.forEach(e=>{t.has(e.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),ng(e))),this.unpublishTrack(e.trackSid,!0))}),s.forEach(e=>{this.emit(wm.TrackPublished,e)}),!0}unpublishTrack(e,t){const s=this.trackPublications.get(e);if(!s)return;const{track:i}=s;switch(i&&(i.stop(),s.setTrack(void 0)),this.trackPublications.delete(e),s.kind){case Km.Kind.Audio:this.audioTrackPublications.delete(e);break;case Km.Kind.Video:this.videoTrackPublications.delete(e)}t&&this.emit(wm.TrackUnpublished,s)}setAudioOutput(e){return Gh(this,void 0,void 0,function*(){this.audioOutput=e;const t=[];this.audioTrackPublications.forEach(s=>{var i;$p(s.track)&&Gp(s.track)&&t.push(s.track.setSinkId(null!==(i=e.deviceId)&&void 0!==i?i:"default"))}),yield Promise.all(t)})}emit(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:e,args:s})),super.emit(e,...s)}}(Xv=Yv||(Yv={})).Disconnected="disconnected",Xv.Connecting="connecting",Xv.Connected="connected",Xv.Reconnecting="reconnecting",Xv.SignalReconnecting="signalReconnecting";class ny extends Xh.EventEmitter{constructor(e){var t,s,i,n;if(super(),t=this,this.state=Yv.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=qh,this.bufferedEvents=[],this.isResuming=!1,this.rpcHandlers=new Map,this.connect=(e,t,s)=>Gh(this,void 0,void 0,function*(){var i;if("undefined"==typeof RTCPeerConnection||!up()&&!hp())throw xp()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const n=yield this.disconnectLock.lock();if(this.state===Yv.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),n(),Promise.resolve();if(this.connectFuture)return n(),this.connectFuture.promise;this.setAndEmitConnectionState(Yv.Connecting),(null===(i=this.regionUrlProvider)||void 0===i?void 0:i.getServerUrl().toString())!==e&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),wp(new URL(e))&&(void 0===this.regionUrlProvider?this.regionUrlProvider=new Ev(e,t):this.regionUrlProvider.updateToken(t),this.regionUrlProvider.fetchRegionSettings().then(e=>{var t;null===(t=this.regionUrlProvider)||void 0===t||t.setServerReportedRegions(e)}).catch(e=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:e}))}));const r=(i,a,o)=>Gh(this,void 0,void 0,function*(){var l,c;this.abortController&&this.abortController.abort();const d=new AbortController;this.abortController=d,null==n||n();try{yield this.attemptConnection(null!=o?o:e,t,s,d),this.abortController=void 0,i()}catch(Tx){if(this.regionUrlProvider&&Tx instanceof jm&&Tx.reason!==um.Cancelled&&Tx.reason!==um.NotAllowed){let t=null;try{t=yield this.regionUrlProvider.getNextBestRegionUrl(null===(l=this.abortController)||void 0===l?void 0:l.signal)}catch(u){if(u instanceof jm&&(401===u.status||u.reason===um.Cancelled))return this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),void a(u)}t&&!(null===(c=this.abortController)||void 0===c?void 0:c.signal.aborted)?(this.log.info("Initial connection failed with ConnectionError: ".concat(Tx.message,". Retrying with another region: ").concat(t),this.logContext),this.recreateEngine(),yield r(i,a,t)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,Up(Tx)),a(Tx))}else{let t=Gd.UNKNOWN_REASON;Tx instanceof jm&&(t=Up(Tx)),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,t),a(Tx)}}}),a=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new Op((e,t)=>{r(e,t,a)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=(e,t,s,i,n,r)=>Gh(this,void 0,void 0,function*(){var a,o,l;const c=yield s.join(e,t,{autoSubscribe:i.autoSubscribe,adaptiveStream:"object"==typeof n.adaptiveStream||n.adaptiveStream,maxRetries:i.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:i.websocketTimeout},r.signal);let d=c.serverInfo;if(d||(d={version:c.serverVersion,region:c.serverRegion}),this.serverInfo=d,this.log.debug("connected to Livekit Server ".concat(Object.entries(d).map(e=>{let[t,s]=e;return"".concat(t,": ").concat(s)}).join(", ")),{room:null===(a=c.room)||void 0===a?void 0:a.name,roomSid:null===(o=c.room)||void 0===o?void 0:o.sid,identity:null===(l=c.participant)||void 0===l?void 0:l.identity}),!d.version)throw new Lm("unknown server version");return"0.15.1"===d.version&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),n.dynacast=!1),c}),this.applyJoinResponse=e=>{const t=e.participant;if(this.localParticipant.sid=t.sid,this.localParticipant.identity=t.identity,this.localParticipant.setEnabledPublishCodecs(e.enabledPublishCodecs),this.options.e2ee&&this.e2eeManager)try{this.e2eeManager.setSifTrailer(e.sifTrailer)}catch(Tx){this.log.error(Tx instanceof Error?Tx.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:Tx}))}this.handleParticipantUpdates([t,...e.otherParticipants]),e.room&&this.handleRoomUpdate(e.room)},this.attemptConnection=(e,t,s,i)=>Gh(this,void 0,void 0,function*(){var n,r;this.state===Yv.Reconnecting||this.isResuming||(null===(n=this.engine)||void 0===n?void 0:n.pendingReconnect)?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),(null===(r=this.regionUrlProvider)||void 0===r?void 0:r.isCloud())&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},Jg),s),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const s=yield this.connectSignal(e,t,this.engine,this.connOptions,this.options,i);this.applyJoinResponse(s),this.setupLocalParticipantEvents(),this.emit(bm.SignalConnected)}catch(a){yield this.engine.close(),this.recreateEngine();const e=new jm("could not establish signal connection",um.ServerUnreachable);throw a instanceof Error&&(e.message="".concat(e.message,": ").concat(a.message)),a instanceof jm&&(e.reason=a.reason,e.status=a.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:a})),e}if(i.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),new jm("Connection attempt aborted",um.Cancelled);try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,i)}catch(Tx){throw yield this.engine.close(),this.recreateEngine(),Tx}bp()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),bp()&&document.addEventListener("freeze",this.onPageLeave),this.setAndEmitConnectionState(Yv.Connected),this.emit(bm.Connected),this.registerConnectionReconcile()}),this.disconnect=function(){for(var e=arguments.length,s=new Array(e),i=0;i<e;i++)s[i]=arguments[i];return Gh(t,[...s],void 0,function(){var e=this;let t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return function*(){var s,i,n,r;const a=yield e.disconnectLock.lock();try{if(e.state===Yv.Disconnected)return void e.log.debug("already disconnected",e.logContext);e.log.info("disconnect from room",Object.assign({},e.logContext)),(e.state===Yv.Connecting||e.state===Yv.Reconnecting||e.isResuming)&&(e.log.warn("abort connection attempt",e.logContext),null===(s=e.abortController)||void 0===s||s.abort(),null===(n=null===(i=e.connectFuture)||void 0===i?void 0:i.reject)||void 0===n||n.call(i,new jm("Client initiated disconnect",um.Cancelled)),e.connectFuture=void 0),(null===(r=e.engine)||void 0===r?void 0:r.client.isDisconnected)||(yield e.engine.client.sendLeave()),e.engine&&(yield e.engine.close()),e.handleDisconnect(t,Gd.CLIENT_INITIATED),e.engine=void 0}finally{a()}}()})},this.onPageLeave=()=>Gh(this,void 0,void 0,function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()}),this.startAudio=()=>Gh(this,void 0,void 0,function*(){const e=[],t=qm();if(t&&"iOS"===t.os){const t="livekit-dummy-audio-el";let s=document.getElementById(t);if(!s){s=document.createElement("audio"),s.id=t,s.autoplay=!0,s.hidden=!0;const e=Rp();e.enabled=!0;const i=new MediaStream([e]);s.srcObject=i,document.addEventListener("visibilitychange",()=>{s&&(s.srcObject=document.hidden?null:i,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(s),this.once(bm.Disconnected,()=>{null==s||s.remove(),s=null})}e.push(s)}this.remoteParticipants.forEach(t=>{t.audioTrackPublications.forEach(t=>{t.track&&t.track.attachedElements.forEach(t=>{e.push(t)})})});try{yield Promise.all([this.acquireAudioContext(),...e.map(e=>(e.muted=!1,e.play()))]),this.handleAudioPlaybackStarted()}catch(s){throw this.handleAudioPlaybackFailed(s),s}}),this.startVideo=()=>Gh(this,void 0,void 0,function*(){const e=[];for(const t of this.remoteParticipants.values())t.videoTrackPublications.forEach(t=>{var s;null===(s=t.track)||void 0===s||s.attachedElements.forEach(t=>{e.includes(t)||e.push(t)})});yield Promise.all(e.map(e=>e.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(e=>{"NotAllowedError"===e.name?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{this.clearConnectionReconcile(),this.isResuming=!1;for(const e of this.remoteParticipants.values())this.handleParticipantDisconnected(e.identity,e);this.setAndEmitConnectionState(Yv.Reconnecting)&&this.emit(bm.Reconnecting)},this.handleSignalRestarted=e=>Gh(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat(e.serverRegion),Object.assign(Object.assign({},this.logContext),{region:e.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(e);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(t){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:t}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:e.serverRegion}))}catch(s){return}this.setAndEmitConnectionState(Yv.Connected),this.emit(bm.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=e=>{e.forEach(e=>{var t;if(e.identity===this.localParticipant.identity)return void this.localParticipant.updateInfo(e);""===e.identity&&(e.identity=null!==(t=this.sidToIdentity.get(e.sid))&&void 0!==t?t:"");let s=this.remoteParticipants.get(e.identity);e.state===eu.DISCONNECTED?this.handleParticipantDisconnected(e.identity,s):s=this.getOrCreateParticipant(e.identity,e)})},this.handleActiveSpeakersUpdate=e=>{const t=[],s={};e.forEach(e=>{if(s[e.sid]=!0,e.sid===this.localParticipant.sid)this.localParticipant.audioLevel=e.level,this.localParticipant.setIsSpeaking(!0),t.push(this.localParticipant);else{const s=this.getRemoteParticipantBySid(e.sid);s&&(s.audioLevel=e.level,s.setIsSpeaking(!0),t.push(s))}}),s[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach(e=>{s[e.sid]||(e.audioLevel=0,e.setIsSpeaking(!1))}),this.activeSpeakers=t,this.emitWhenConnected(bm.ActiveSpeakersChanged,t)},this.handleSpeakersChanged=e=>{const t=new Map;this.activeSpeakers.forEach(e=>{const s=this.remoteParticipants.get(e.identity);s&&s.sid!==e.sid||t.set(e.sid,e)}),e.forEach(e=>{let s=this.getRemoteParticipantBySid(e.sid);e.sid===this.localParticipant.sid&&(s=this.localParticipant),s&&(s.audioLevel=e.level,s.setIsSpeaking(e.active),e.active?t.set(e.sid,s):t.delete(e.sid))});const s=Array.from(t.values());s.sort((e,t)=>t.audioLevel-e.audioLevel),this.activeSpeakers=s,this.emitWhenConnected(bm.ActiveSpeakersChanged,s)},this.handleStreamStateUpdate=e=>{e.streamStates.forEach(e=>{const t=this.getRemoteParticipantBySid(e.participantSid);if(!t)return;const s=t.getTrackPublicationBySid(e.trackSid);if(!s||!s.track)return;const i=Km.streamStateFromProto(e.state);s.track.setStreamState(i),i!==s.track.streamState&&(t.emit(wm.TrackStreamStateChanged,s,s.track.streamState),this.emitWhenConnected(bm.TrackStreamStateChanged,s,s.track.streamState,t))})},this.handleSubscriptionPermissionUpdate=e=>{const t=this.getRemoteParticipantBySid(e.participantSid);if(!t)return;const s=t.getTrackPublicationBySid(e.trackSid);s&&s.setAllowed(e.allowed)},this.handleSubscriptionError=e=>{const t=Array.from(this.remoteParticipants.values()).find(t=>t.trackPublications.has(e.trackSid));if(!t)return;const s=t.getTrackPublicationBySid(e.trackSid);s&&s.setSubscriptionError(e.err)},this.handleDataPacket=e=>{const t=this.remoteParticipants.get(e.participantIdentity);if("user"===e.value.case)this.handleUserPacket(t,e.value.value,e.kind);else if("transcription"===e.value.case)this.handleTranscription(t,e.value.value);else if("sipDtmf"===e.value.case)this.handleSipDtmf(t,e.value.value);else if("chatMessage"===e.value.case)this.handleChatMessage(t,e.value.value);else if("metrics"===e.value.case)this.handleMetrics(e.value.value,t);else if("streamHeader"===e.value.case||"streamChunk"===e.value.case||"streamTrailer"===e.value.case)this.handleDataStream(e);else if("rpcRequest"===e.value.case){const t=e.value.value;this.handleIncomingRpcRequest(e.participantIdentity,t.id,t.method,t.payload,t.responseTimeoutMs,t.version)}},this.handleUserPacket=(e,t,s)=>{this.emit(bm.DataReceived,t.payload,e,s,t.topic),null==e||e.emit(wm.DataReceived,t.payload,s)},this.handleSipDtmf=(e,t)=>{this.emit(bm.SipDTMFReceived,t,e),null==e||e.emit(wm.SipDTMFReceived,t)},this.handleTranscription=(e,t)=>{const s=t.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(t.transcribedParticipantIdentity),i=null==s?void 0:s.trackPublications.get(t.trackId),n=function(e,t){return e.segments.map(e=>{let{id:s,text:i,language:n,startTime:r,endTime:a,final:o}=e;var l;const c=null!==(l=t.get(s))&&void 0!==l?l:Date.now(),d=Date.now();return o?t.delete(s):t.set(s,c),{id:s,text:i,startTime:Number.parseInt(r.toString()),endTime:Number.parseInt(a.toString()),final:o,language:n,firstReceivedTime:c,lastReceivedTime:d}})}(t,this.transcriptionReceivedTimes);null==i||i.emit(Cm.TranscriptionReceived,n),null==s||s.emit(wm.TranscriptionReceived,n,i),this.emit(bm.TranscriptionReceived,n,s,i)},this.handleChatMessage=(e,t)=>{const s=function(e){const{id:t,timestamp:s,message:i,editTimestamp:n}=e;return{id:t,timestamp:Number.parseInt(s.toString()),editTimestamp:n?Number.parseInt(n.toString()):void 0,message:i}}(t);this.emit(bm.ChatMessage,s,e)},this.handleMetrics=(e,t)=>{this.emit(bm.MetricsReceived,e,t)},this.handleDataStream=e=>{this.incomingDataStreamManager.handleDataStreamPacket(e)},this.bufferedSegments=new Map,this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(bm.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=e=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:e})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(bm.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(bm.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(bm.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>Gh(this,void 0,void 0,function*(){var e;"iOS"!==(null===(e=qm())||void 0===e?void 0:e.os)&&(yield this.selectDefaultDevices()),this.emit(bm.MediaDevicesChanged)}),this.handleRoomUpdate=e=>{const t=this.roomInfo;this.roomInfo=e,t&&t.metadata!==e.metadata&&this.emitWhenConnected(bm.RoomMetadataChanged,e.metadata),(null==t?void 0:t.activeRecording)!==e.activeRecording&&this.emitWhenConnected(bm.RecordingStatusChanged,e.activeRecording)},this.handleConnectionQualityUpdate=e=>{e.updates.forEach(e=>{if(e.participantSid===this.localParticipant.sid)return void this.localParticipant.setConnectionQuality(e.quality);const t=this.getRemoteParticipantBySid(e.participantSid);t&&t.setConnectionQuality(e.quality)})},this.onLocalParticipantMetadataChanged=e=>{this.emit(bm.ParticipantMetadataChanged,e,this.localParticipant)},this.onLocalParticipantNameChanged=e=>{this.emit(bm.ParticipantNameChanged,e,this.localParticipant)},this.onLocalAttributesChanged=e=>{this.emit(bm.ParticipantAttributesChanged,e,this.localParticipant)},this.onLocalTrackMuted=e=>{this.emit(bm.TrackMuted,e,this.localParticipant)},this.onLocalTrackUnmuted=e=>{this.emit(bm.TrackUnmuted,e,this.localParticipant)},this.onTrackProcessorUpdate=e=>{var t;null===(t=null==e?void 0:e.onPublish)||void 0===t||t.call(e,this)},this.onLocalTrackPublished=e=>Gh(this,void 0,void 0,function*(){var t,s,i,n,r,a;if(null===(t=e.track)||void 0===t||t.on(Cm.TrackProcessorUpdate,this.onTrackProcessorUpdate),null===(s=e.track)||void 0===s||s.on(Cm.Restarted,this.onLocalTrackRestarted),null===(r=null===(n=null===(i=e.track)||void 0===i?void 0:i.getProcessor())||void 0===n?void 0:n.onPublish)||void 0===r||r.call(n,this),this.emit(bm.LocalTrackPublished,e,this.localParticipant),Vp(e.track)){(yield e.track.checkForSilence())&&this.emit(bm.LocalAudioSilenceDetected,e)}const o=yield null===(a=e.track)||void 0===a?void 0:a.getDeviceId(!1),l=tg(e.source);l&&o&&o!==this.localParticipant.activeDeviceMap.get(l)&&(this.localParticipant.activeDeviceMap.set(l,o),this.emit(bm.ActiveDeviceChanged,l,o))}),this.onLocalTrackUnpublished=e=>{var t,s;null===(t=e.track)||void 0===t||t.off(Cm.TrackProcessorUpdate,this.onTrackProcessorUpdate),null===(s=e.track)||void 0===s||s.off(Cm.Restarted,this.onLocalTrackRestarted),this.emit(bm.LocalTrackUnpublished,e,this.localParticipant)},this.onLocalTrackRestarted=e=>Gh(this,void 0,void 0,function*(){const t=yield e.getDeviceId(!1),s=tg(e.source);s&&t&&t!==this.localParticipant.activeDeviceMap.get(s)&&(this.log.debug("local track restarted, setting ".concat(s," ").concat(t," active"),this.logContext),this.localParticipant.activeDeviceMap.set(s,t),this.emit(bm.ActiveDeviceChanged,s,t))}),this.onLocalConnectionQualityChanged=e=>{this.emit(bm.ConnectionQualityChanged,e,this.localParticipant)},this.onMediaDevicesError=(e,t)=>{this.emit(bm.MediaDevicesError,e,t)},this.onLocalParticipantPermissionsChanged=e=>{this.emit(bm.ParticipantPermissionsChanged,e,this.localParticipant)},this.onLocalChatMessageSent=e=>{this.emit(bm.ChatMessage,e,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},Gg),e),this.log=$h(null!==(s=this.options.loggerName)&&void 0!==s?s:Uh.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},Hg),null==e?void 0:e.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},Vg),null==e?void 0:e.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},zg),null==e?void 0:e.publishDefaults),this.maybeCreateEngine(),this.incomingDataStreamManager=new Lv,this.outgoingDataStreamManager=new Mv(this.engine,this.log),this.disconnectLock=new Zl,this.localParticipant=new ty("","",this.engine,this.options,this.rpcHandlers,this.outgoingDataStreamManager),this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",Dp(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",Dp(this.options.audioCaptureDefaults.deviceId)),(null===(i=this.options.audioOutput)||void 0===i?void 0:i.deviceId)&&this.switchActiveDevice("audiooutput",Dp(this.options.audioOutput.deviceId)).catch(e=>this.log.warn("Could not set audio output: ".concat(e.message),this.logContext)),this.options.e2ee&&this.setupE2EE(),bp()){const e=new AbortController;null===(n=navigator.mediaDevices)||void 0===n||n.addEventListener("devicechange",this.handleDeviceChange,{signal:e.signal}),ny.cleanupRegistry&&ny.cleanupRegistry.register(this,()=>{e.abort()})}}registerTextStreamHandler(e,t){return this.incomingDataStreamManager.registerTextStreamHandler(e,t)}unregisterTextStreamHandler(e){return this.incomingDataStreamManager.unregisterTextStreamHandler(e)}registerByteStreamHandler(e,t){return this.incomingDataStreamManager.registerByteStreamHandler(e,t)}unregisterByteStreamHandler(e){return this.incomingDataStreamManager.unregisterByteStreamHandler(e)}registerRpcMethod(e,t){if(this.rpcHandlers.has(e))throw Error("RPC handler already registered for method ".concat(e,", unregisterRpcMethod before trying to register again"));this.rpcHandlers.set(e,t)}unregisterRpcMethod(e){this.rpcHandlers.delete(e)}setE2EEEnabled(e){return Gh(this,void 0,void 0,function*(){if(!this.e2eeManager)throw Error("e2ee not configured, please set e2ee settings within the room options");yield Promise.all([this.localParticipant.setE2EEEnabled(e)]),""!==this.localParticipant.identity&&this.e2eeManager.setParticipantCryptorEnabled(e,this.localParticipant.identity)})}setupE2EE(){var e;this.options.e2ee&&("e2eeManager"in this.options.e2ee?this.e2eeManager=this.options.e2ee.e2eeManager:this.e2eeManager=new og(this.options.e2ee),this.e2eeManager.on(lm.ParticipantEncryptionStatusChanged,(e,t)=>{t.isLocal&&(this.isE2EEEnabled=e),this.emit(bm.ParticipantEncryptionStatusChanged,e,t)}),this.e2eeManager.on(lm.EncryptionError,e=>this.emit(bm.EncryptionError,e)),null===(e=this.e2eeManager)||void 0===e||e.setup(this))}get logContext(){var e;return{room:this.name,roomID:null===(e=this.roomInfo)||void 0===e?void 0:e.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var e,t;return null!==(t=null===(e=this.roomInfo)||void 0===e?void 0:e.activeRecording)&&void 0!==t&&t}getSid(){return Gh(this,void 0,void 0,function*(){return this.state===Yv.Disconnected?"":this.roomInfo&&""!==this.roomInfo.sid?this.roomInfo.sid:new Promise((e,t)=>{const s=t=>{""!==t.sid&&(this.engine.off(km.RoomUpdate,s),e(t.sid))};this.engine.on(km.RoomUpdate,s),this.once(bm.Disconnected,()=>{this.engine.off(km.RoomUpdate,s),t("Room disconnected before room server id was available")})})})}get name(){var e,t;return null!==(t=null===(e=this.roomInfo)||void 0===e?void 0:e.name)&&void 0!==t?t:""}get metadata(){var e;return null===(e=this.roomInfo)||void 0===e?void 0:e.metadata}get numParticipants(){var e,t;return null!==(t=null===(e=this.roomInfo)||void 0===e?void 0:e.numParticipants)&&void 0!==t?t:0}get numPublishers(){var e,t;return null!==(t=null===(e=this.roomInfo)||void 0===e?void 0:e.numPublishers)&&void 0!==t?t:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new Tv(this.options),this.engine.on(km.ParticipantUpdate,this.handleParticipantUpdates).on(km.RoomUpdate,this.handleRoomUpdate).on(km.SpeakersChanged,this.handleSpeakersChanged).on(km.StreamStateChanged,this.handleStreamStateUpdate).on(km.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(km.SubscriptionError,this.handleSubscriptionError).on(km.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(km.MediaTrackAdded,(e,t,s)=>{this.onTrackAdded(e,t,s)}).on(km.Disconnected,e=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,e)}).on(km.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(km.DataPacketReceived,this.handleDataPacket).on(km.Resuming,()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(Yv.SignalReconnecting)&&this.emit(bm.SignalReconnecting)}).on(km.Resumed,()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(Yv.Connected)&&this.emit(bm.Reconnected)}).on(km.SignalResumed,()=>{this.bufferedEvents=[],(this.state===Yv.Reconnecting||this.isResuming)&&this.sendSyncState()}).on(km.Restarting,this.handleRestarting).on(km.SignalRestarted,this.handleSignalRestarted).on(km.Offline,()=>{this.setAndEmitConnectionState(Yv.Reconnecting)&&this.emit(bm.Reconnecting)}).on(km.DCBufferStatusChanged,(e,t)=>{this.emit(bm.DCBufferStatusChanged,e,t)}).on(km.LocalTrackSubscribed,e=>{const t=this.localParticipant.getTrackPublications().find(t=>{let{trackSid:s}=t;return s===e});t?(this.localParticipant.emit(wm.LocalTrackSubscribed,t),this.emitWhenConnected(bm.LocalTrackSubscribed,t,this.localParticipant)):this.log.warn("could not find local track subscription for subscribed event",this.logContext)}).on(km.RoomMoved,e=>{this.log.debug("room moved",e),e.room&&this.handleRoomUpdate(e.room),this.remoteParticipants.forEach((e,t)=>{this.handleParticipantDisconnected(t,e)}),this.emit(bm.Moved,e.room.name),e.participant?this.handleParticipantUpdates([e.participant,...e.otherParticipants]):this.handleParticipantUpdates(e.otherParticipants)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine),this.outgoingDataStreamManager&&this.outgoingDataStreamManager.setupEngine(this.engine))}static getLocalDevices(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return cg.getInstance().getDevices(e,t)}prepareConnection(e,t){return Gh(this,void 0,void 0,function*(){if(this.state===Yv.Disconnected){this.log.debug("prepareConnection to ".concat(e),this.logContext);try{if(wp(new URL(e))&&t){this.regionUrlProvider=new Ev(e,t);const s=yield this.regionUrlProvider.getNextBestRegionUrl();s&&this.state===Yv.Disconnected&&(this.regionUrl=s,yield fetch(Mp(s),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(s),this.logContext))}else yield fetch(Mp(e),{method:"HEAD"})}catch(Tx){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:Tx}))}}})}getParticipantByIdentity(e){return this.localParticipant.identity===e?this.localParticipant:this.remoteParticipants.get(e)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(e,t){return Gh(this,void 0,void 0,function*(){let s,i=()=>Gh(this,void 0,void 0,function*(){});switch(e){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":s=new wh({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":s=new wh({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":s=new wh({scenario:{case:"serverLeave",value:!0}});break;case"migration":s=new wh({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":i=()=>Gh(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),s=new wh({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":i=()=>Gh(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),s=new wh({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":s=new wh({scenario:{case:"switchCandidateProtocol",value:"force-tls"===e?2:1}}),i=()=>Gh(this,void 0,void 0,function*(){const e=this.engine.client.onLeave;e&&e(new eh({reason:Gd.CLIENT_INITIATED,action:th.RECONNECT}))});break;case"subscriber-bandwidth":if(void 0===t||"number"!=typeof t)throw new Error("subscriber-bandwidth requires a number as argument");s=new wh({scenario:{case:"subscriberBandwidth",value:Bp(t)}});break;case"leave-full-reconnect":s=new wh({scenario:{case:"leaveRequestFullReconnect",value:!0}})}s&&(yield this.engine.client.sendSimulateScenario(s),yield i())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(e){return this.localParticipant.activeDeviceMap.get(e)}switchActiveDevice(e,t){return Gh(this,arguments,void 0,function(e,t){var s=this;let i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return function*(){var n,r,a,o,l,c,d;let u=!0,h=!1;const f=i?{exact:t}:t;if("audioinput"===e){h=0===s.localParticipant.audioTrackPublications.size;const t=null!==(n=s.getActiveDevice(e))&&void 0!==n?n:s.options.audioCaptureDefaults.deviceId;s.options.audioCaptureDefaults.deviceId=f;const i=Array.from(s.localParticipant.audioTrackPublications.values()).filter(e=>e.source===Km.Source.Microphone);try{u=(yield Promise.all(i.map(e=>{var t;return null===(t=e.audioTrack)||void 0===t?void 0:t.setDeviceId(f)}))).every(e=>!0===e)}catch(Tx){throw s.options.audioCaptureDefaults.deviceId=t,Tx}const r=i.some(e=>{var t,s;return null!==(s=null===(t=e.track)||void 0===t?void 0:t.isMuted)&&void 0!==s&&s});u&&r&&(h=!0)}else if("videoinput"===e){h=0===s.localParticipant.videoTrackPublications.size;const t=null!==(r=s.getActiveDevice(e))&&void 0!==r?r:s.options.videoCaptureDefaults.deviceId;s.options.videoCaptureDefaults.deviceId=f;const i=Array.from(s.localParticipant.videoTrackPublications.values()).filter(e=>e.source===Km.Source.Camera);try{u=(yield Promise.all(i.map(e=>{var t;return null===(t=e.videoTrack)||void 0===t?void 0:t.setDeviceId(f)}))).every(e=>!0===e)}catch(Tx){throw s.options.videoCaptureDefaults.deviceId=t,Tx}const n=i.some(e=>{var t,s;return null!==(s=null===(t=e.track)||void 0===t?void 0:t.isMuted)&&void 0!==s&&s});u&&n&&(h=!0)}else if("audiooutput"===e){if(h=!0,!mp()&&!s.options.webAudioMix||s.options.webAudioMix&&s.audioContext&&!("setSinkId"in s.audioContext))throw new Error("cannot switch audio output, the current browser does not support it");s.options.webAudioMix&&(t=null!==(a=yield cg.getInstance().normalizeDeviceId("audiooutput",t))&&void 0!==a?a:""),null!==(o=(d=s.options).audioOutput)&&void 0!==o||(d.audioOutput={});const i=null!==(l=s.getActiveDevice(e))&&void 0!==l?l:s.options.audioOutput.deviceId;s.options.audioOutput.deviceId=t;try{s.options.webAudioMix&&(null===(c=s.audioContext)||void 0===c||c.setSinkId(t)),yield Promise.all(Array.from(s.remoteParticipants.values()).map(e=>e.setAudioOutput({deviceId:t})))}catch(Tx){throw s.options.audioOutput.deviceId=i,Tx}}return h&&(s.localParticipant.activeDeviceMap.set(e,t),s.emit(bm.ActiveDeviceChanged,e,t)),u}()})}setupLocalParticipantEvents(){this.localParticipant.on(wm.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(wm.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(wm.AttributesChanged,this.onLocalAttributesChanged).on(wm.TrackMuted,this.onLocalTrackMuted).on(wm.TrackUnmuted,this.onLocalTrackUnmuted).on(wm.LocalTrackPublished,this.onLocalTrackPublished).on(wm.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(wm.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(wm.MediaDevicesError,this.onMediaDevicesError).on(wm.AudioStreamAcquired,this.startAudio).on(wm.ChatMessage,this.onLocalChatMessageSent).on(wm.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var e;null===(e=this.engine)||void 0===e||e.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded(e,t,s){if(this.state===Yv.Connecting||this.state===Yv.Reconnecting){const i=()=>{this.onTrackAdded(e,t,s),n()},n=()=>{this.off(bm.Reconnected,i),this.off(bm.Connected,i),this.off(bm.Disconnected,n)};return this.once(bm.Reconnected,i),this.once(bm.Connected,i),void this.once(bm.Disconnected,n)}if(this.state===Yv.Disconnected)return void this.log.warn("skipping incoming track after Room disconnected",this.logContext);if("ended"===e.readyState)return void this.log.info("skipping incoming track as it already ended",this.logContext);const i=function(e){const t=e.split("|");return t.length>1?[t[0],e.substr(t[0].length+1)]:[e,""]}(t.id),n=i[0];let r=i[1],a=e.id;if(r&&r.startsWith("TR")&&(a=r),n===this.localParticipant.sid)return void this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);const o=Array.from(this.remoteParticipants.values()).find(e=>e.sid===n);if(!o)return void this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(n),this.logContext);let l;this.options.adaptiveStream&&(l="object"==typeof this.options.adaptiveStream?this.options.adaptiveStream:{});const c=o.addSubscribedMediaTrack(e,a,t,s,l);(null==c?void 0:c.isEncrypted)&&!this.e2eeManager&&this.emit(bm.EncryptionError,new Error("Encrypted ".concat(c.source," track received from participant ").concat(o.sid,", but room does not have encryption enabled!")))}handleDisconnect(){let e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=arguments.length>1?arguments[1]:void 0;var s;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.incomingDataStreamManager.clearHandlersAndControllers(),this.state!==Yv.Disconnected){this.regionUrl=void 0;try{this.remoteParticipants.forEach(e=>{e.trackPublications.forEach(t=>{e.unpublishTrack(t.trackSid)})}),this.localParticipant.trackPublications.forEach(t=>{var s,i,n;t.track&&this.localParticipant.unpublishTrack(t.track,e),e?(null===(s=t.track)||void 0===s||s.detach(),null===(i=t.track)||void 0===i||i.stop()):null===(n=t.track)||void 0===n||n.stopMonitor()}),this.localParticipant.off(wm.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(wm.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(wm.AttributesChanged,this.onLocalAttributesChanged).off(wm.TrackMuted,this.onLocalTrackMuted).off(wm.TrackUnmuted,this.onLocalTrackUnmuted).off(wm.LocalTrackPublished,this.onLocalTrackPublished).off(wm.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(wm.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(wm.MediaDevicesError,this.onMediaDevicesError).off(wm.AudioStreamAcquired,this.startAudio).off(wm.ChatMessage,this.onLocalChatMessageSent).off(wm.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&"boolean"==typeof this.options.webAudioMix&&(this.audioContext.close(),this.audioContext=void 0),bp()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),null===(s=navigator.mediaDevices)||void 0===s||s.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(Yv.Disconnected),this.emit(bm.Disconnected,t)}}}handleParticipantDisconnected(e,t){var s;this.remoteParticipants.delete(e),t&&(this.incomingDataStreamManager.validateParticipantHasNoActiveDataStreams(e),t.trackPublications.forEach(e=>{t.unpublishTrack(e.trackSid,!0)}),this.emit(bm.ParticipantDisconnected,t),t.setDisconnected(),null===(s=this.localParticipant)||void 0===s||s.handleParticipantDisconnected(t.identity))}handleIncomingRpcRequest(e,t,s,i,n,r){return Gh(this,void 0,void 0,function*(){if(yield this.engine.publishRpcAck(e,t),1!==r)return void(yield this.engine.publishRpcResponse(e,t,null,Xg.builtIn("UNSUPPORTED_VERSION")));const a=this.rpcHandlers.get(s);if(!a)return void(yield this.engine.publishRpcResponse(e,t,null,Xg.builtIn("UNSUPPORTED_METHOD")));let o=null,l=null;try{const s=yield a({requestId:t,callerIdentity:e,payload:i,responseTimeout:n});Qg(s)>15360?o=Xg.builtIn("RESPONSE_PAYLOAD_TOO_LARGE"):l=s}catch(c){o=c instanceof Xg?c:Xg.builtIn("APPLICATION_ERROR")}yield this.engine.publishRpcResponse(e,t,l,o)})}selectDefaultDevices(){return Gh(this,void 0,void 0,function*(){var e,t,s;const i=cg.getInstance().previousDevices,n=yield cg.getInstance().getDevices(void 0,!1),r=qm();if("Chrome"===(null==r?void 0:r.name)&&"iOS"!==r.os)for(let o of n){const e=i.find(e=>e.deviceId===o.deviceId);e&&""!==e.label&&e.kind===o.kind&&e.label!==o.label&&"default"===this.getActiveDevice(o.kind)&&this.emit(bm.ActiveDeviceChanged,o.kind,o.deviceId)}const a=["audiooutput","audioinput","videoinput"];for(let o of a){const r=eg(o),a=this.localParticipant.getTrackPublication(r);if(a&&(null===(e=a.track)||void 0===e?void 0:e.isUserProvided))continue;const l=n.filter(e=>e.kind===o),c=this.getActiveDevice(o);c===(null===(t=i.filter(e=>e.kind===o)[0])||void 0===t?void 0:t.deviceId)&&l.length>0&&(null===(s=l[0])||void 0===s?void 0:s.deviceId)!==c?yield this.switchActiveDevice(o,l[0].deviceId):"audioinput"===o&&!vp()||"videoinput"===o||!(l.length>0)||l.find(e=>e.deviceId===this.getActiveDevice(o))||"audiooutput"===o&&vp()||(yield this.switchActiveDevice(o,l[0].deviceId))}})}acquireAudioContext(){return Gh(this,void 0,void 0,function*(){var e,t;if("boolean"!=typeof this.options.webAudioMix&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:this.audioContext&&"closed"!==this.audioContext.state||(this.audioContext=null!==(e=Zp())&&void 0!==e?e:void 0),this.options.webAudioMix&&this.remoteParticipants.forEach(e=>e.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext),this.audioContext&&"suspended"===this.audioContext.state)try{yield Promise.race([this.audioContext.resume(),dp(200)])}catch(Tx){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:Tx}))}const s="running"===(null===(t=this.audioContext)||void 0===t?void 0:t.state);s!==this.canPlaybackAudio&&(this.audioEnabled=s,this.emit(bm.AudioPlaybackStatusChanged,s))})}createParticipant(e,t){var s;let i;return i=t?iy.fromParticipantInfo(this.engine.client,t,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):new iy(this.engine.client,"",e,void 0,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&i.setAudioContext(this.audioContext),(null===(s=this.options.audioOutput)||void 0===s?void 0:s.deviceId)&&i.setAudioOutput(this.options.audioOutput).catch(e=>this.log.warn("Could not set audio output: ".concat(e.message),this.logContext)),i}getOrCreateParticipant(e,t){if(this.remoteParticipants.has(e)){const s=this.remoteParticipants.get(e);if(t){s.updateInfo(t)&&this.sidToIdentity.set(t.sid,t.identity)}return s}const s=this.createParticipant(e,t);return this.remoteParticipants.set(e,s),this.sidToIdentity.set(t.sid,t.identity),this.emitWhenConnected(bm.ParticipantConnected,s),s.on(wm.TrackPublished,e=>{this.emitWhenConnected(bm.TrackPublished,e,s)}).on(wm.TrackSubscribed,(e,t)=>{e.kind===Km.Kind.Audio?(e.on(Cm.AudioPlaybackStarted,this.handleAudioPlaybackStarted),e.on(Cm.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):e.kind===Km.Kind.Video&&(e.on(Cm.VideoPlaybackFailed,this.handleVideoPlaybackFailed),e.on(Cm.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(bm.TrackSubscribed,e,t,s)}).on(wm.TrackUnpublished,e=>{this.emit(bm.TrackUnpublished,e,s)}).on(wm.TrackUnsubscribed,(e,t)=>{this.emit(bm.TrackUnsubscribed,e,t,s)}).on(wm.TrackMuted,e=>{this.emitWhenConnected(bm.TrackMuted,e,s)}).on(wm.TrackUnmuted,e=>{this.emitWhenConnected(bm.TrackUnmuted,e,s)}).on(wm.ParticipantMetadataChanged,e=>{this.emitWhenConnected(bm.ParticipantMetadataChanged,e,s)}).on(wm.ParticipantNameChanged,e=>{this.emitWhenConnected(bm.ParticipantNameChanged,e,s)}).on(wm.AttributesChanged,e=>{this.emitWhenConnected(bm.ParticipantAttributesChanged,e,s)}).on(wm.ConnectionQualityChanged,e=>{this.emitWhenConnected(bm.ConnectionQualityChanged,e,s)}).on(wm.ParticipantPermissionsChanged,e=>{this.emitWhenConnected(bm.ParticipantPermissionsChanged,e,s)}).on(wm.TrackSubscriptionStatusChanged,(e,t)=>{this.emitWhenConnected(bm.TrackSubscriptionStatusChanged,e,t,s)}).on(wm.TrackSubscriptionFailed,(e,t)=>{this.emit(bm.TrackSubscriptionFailed,e,s,t)}).on(wm.TrackSubscriptionPermissionChanged,(e,t)=>{this.emitWhenConnected(bm.TrackSubscriptionPermissionChanged,e,t,s)}).on(wm.Active,()=>{this.emitWhenConnected(bm.ParticipantActive,s),s.kind===tu.AGENT&&this.localParticipant.setActiveAgent(s)}),t&&s.updateInfo(t),s}sendSyncState(){const e=Array.from(this.remoteParticipants.values()).reduce((e,t)=>(e.push(...t.getTrackPublications()),e),[]),t=this.localParticipant.getTrackPublications();this.engine.sendSyncState(e,t)}updateSubscriptions(){for(const e of this.remoteParticipants.values())for(const t of e.videoTrackPublications.values())t.isSubscribed&&Jp(t)&&t.emitTrackUpdate()}getRemoteParticipantBySid(e){const t=this.sidToIdentity.get(e);if(t)return this.remoteParticipants.get(t)}registerConnectionReconcile(){this.clearConnectionReconcile();let e=0;this.connectionReconcileInterval=Vm.setInterval(()=>{this.engine&&!this.engine.isClosed&&this.engine.verifyTransport()?e=0:(e++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:e,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:void 0})),e>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,Gd.STATE_MISMATCH)))},4e3)}clearConnectionReconcile(){this.connectionReconcileInterval&&Vm.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(e){return e!==this.state&&(this.state=e,this.emit(bm.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach(e=>{let[t,s]=e;this.emit(t,...s)}),this.bufferedEvents=[]}emitWhenConnected(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];if(this.state===Yv.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([e,s]);else if(this.state===Yv.Connected)return this.emit(e,...s);return!1}simulateParticipants(e){return Gh(this,void 0,void 0,function*(){var t,s;const i=Object.assign({audio:!0,video:!0,useRealTracks:!1},e.publish),n=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},e.participants);if(this.handleDisconnect(),this.roomInfo=new Yd({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:wc.parse((new Date).getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new Zd({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(bm.SignalConnected),this.emit(bm.Connected),this.setAndEmitConnectionState(Yv.Connected),i.video){const e=new Qv(Km.Kind.Video,new ru({source:$d.CAMERA,sid:Math.floor(1e4*Math.random()).toString(),type:qd.AUDIO,name:"video-dummy"}),new yv(i.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:Ip(160*(null!==(t=n.aspectRatios[0])&&void 0!==t?t:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(e),this.localParticipant.emit(wm.LocalTrackPublished,e)}if(i.audio){const e=new Qv(Km.Kind.Audio,new ru({source:$d.MICROPHONE,sid:Math.floor(1e4*Math.random()).toString(),type:qd.AUDIO}),new av(i.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:Rp(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(e),this.localParticipant.emit(wm.LocalTrackPublished,e)}for(let e=0;e<n.count-1;e+=1){let t=new Zd({sid:Math.floor(1e4*Math.random()).toString(),identity:"simulated-".concat(e),state:eu.ACTIVE,tracks:[],joinedAt:wc.parse(Date.now())});const i=this.getOrCreateParticipant(t.identity,t);if(n.video){const r=Ip(160*(null!==(s=n.aspectRatios[e%n.aspectRatios.length])&&void 0!==s?s:1),160,!1,!0),a=new ru({source:$d.CAMERA,sid:Math.floor(1e4*Math.random()).toString(),type:qd.AUDIO});i.addSubscribedMediaTrack(r,a.sid,new MediaStream([r]),new RTCRtpReceiver),t.tracks=[...t.tracks,a]}if(n.audio){const e=Rp(),s=new ru({source:$d.MICROPHONE,sid:Math.floor(1e4*Math.random()).toString(),type:qd.AUDIO});i.addSubscribedMediaTrack(e,s.sid,new MediaStream([e]),new RTCRtpReceiver),t.tracks=[...t.tracks,s]}i.updateInfo(t)}})}emit(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),i=1;i<t;i++)s[i-1]=arguments[i];if(e!==bm.ActiveSpeakersChanged&&e!==bm.TranscriptionReceived){const t=ry(s).filter(e=>void 0!==e);this.log.debug("room event ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:t}))}return super.emit(e,...s)}}function ry(e){return e.map(e=>{if(e)return Array.isArray(e)?ry(e):"object"==typeof e?"logContext"in e?e.logContext:void 0:e})}var ay,oy;ny.cleanupRegistry="undefined"!=typeof FinalizationRegistry&&new FinalizationRegistry(e=>{e()}),(oy=ay||(ay={}))[oy.IDLE=0]="IDLE",oy[oy.RUNNING=1]="RUNNING",oy[oy.SKIPPED=2]="SKIPPED",oy[oy.SUCCESS=3]="SUCCESS",oy[oy.FAILED=4]="FAILED";Xh.EventEmitter;Xh.EventEmitter;function ly(e,t){return(ly=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}var cy=new TextDecoder,dy=function(e){var t,s;function i(){var t;return(t=e.call(this)||this).room=void 0,t.connected=!1,t.isAgentTalking=!1,t.analyzerComponent=void 0,t.captureAudioFrame=void 0,t}s=e,(t=i).prototype=Object.create(s.prototype),t.prototype.constructor=t,ly(t,s);var n=i.prototype;return n.startCall=function(e){try{var t=this,s=function(s,i){try{var n=(t.room=new ny({audioCaptureDefaults:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,channelCount:1,deviceId:e.captureDeviceId,sampleRate:e.sampleRate},audioOutput:{deviceId:e.playbackDeviceId}}),t.handleRoomEvents(),t.handleAudioEvents(e),t.handleDataEvents(),Promise.resolve(t.room.connect("wss://retell-ai-4ihahnq7.livekit.cloud",e.accessToken)).then(function(){t.room.localParticipant.setMicrophoneEnabled(!0),t.connected=!0,t.emit("call_started")}))}catch(r){return i(r)}return n&&n.then?n.then(void 0,i):n}(0,function(e){t.emit("error","Error starting call"),t.stopCall()});return Promise.resolve(s&&s.then?s.then(function(){}):void 0)}catch(i){return Promise.reject(i)}},n.startAudioPlayback=function(){try{return Promise.resolve(this.room.startAudio()).then(function(){})}catch(e){return Promise.reject(e)}},n.stopCall=function(){var e;this.connected&&(this.connected=!1,this.emit("call_ended"),null==(e=this.room)||e.disconnect(),this.isAgentTalking=!1,delete this.room,this.analyzerComponent&&(this.analyzerComponent.cleanup(),delete this.analyzerComponent),this.captureAudioFrame&&(window.cancelAnimationFrame(this.captureAudioFrame),delete this.captureAudioFrame))},n.mute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!1)},n.unmute=function(){this.connected&&this.room.localParticipant.setMicrophoneEnabled(!0)},n.captureAudioSamples=function(){var e=this;if(this.connected&&this.analyzerComponent){var t=new Float32Array(this.analyzerComponent.analyser.fftSize);this.analyzerComponent.analyser.getFloatTimeDomainData(t),this.emit("audio",t),this.captureAudioFrame=window.requestAnimationFrame(function(){return e.captureAudioSamples()})}},n.handleRoomEvents=function(){var e=this;this.room.on(bm.ParticipantDisconnected,function(t){"server"===(null==t?void 0:t.identity)&&setTimeout(function(){e.stopCall()},500)}),this.room.on(bm.Disconnected,function(){e.stopCall()})},n.handleAudioEvents=function(e){var t=this;this.room.on(bm.TrackSubscribed,function(s,i,n){s.kind===Km.Kind.Audio&&s instanceof Fv&&("agent_audio"===i.trackName&&(t.emit("call_ready"),e.emitRawAudioSamples&&(t.analyzerComponent=function(e,t){const s=Object.assign({cloneTrack:!1,fftSize:2048,smoothingTimeConstant:.8,minDecibels:-100,maxDecibels:-80},t),i=Zp();if(!i)throw new Error("Audio Context not supported on this browser");const n=s.cloneTrack?e.mediaStreamTrack.clone():e.mediaStreamTrack,r=i.createMediaStreamSource(new MediaStream([n])),a=i.createAnalyser();a.minDecibels=s.minDecibels,a.maxDecibels=s.maxDecibels,a.fftSize=s.fftSize,a.smoothingTimeConstant=s.smoothingTimeConstant,r.connect(a);const o=new Uint8Array(a.frequencyBinCount);return{calculateVolume:()=>{a.getByteFrequencyData(o);let e=0;for(const t of o)e+=Math.pow(t/255,2);return Math.sqrt(e/o.length)},analyser:a,cleanup:()=>Gh(this,void 0,void 0,function*(){yield i.close(),s.cloneTrack&&n.stop()})}}(s),t.captureAudioFrame=window.requestAnimationFrame(function(){return t.captureAudioSamples()}))),s.attach())})},n.handleDataEvents=function(){var e=this;this.room.on(bm.DataReceived,function(t,s,i,n){try{if("server"!==(null==s?void 0:s.identity))return;var r=cy.decode(t),a=JSON.parse(r);"update"===a.event_type?e.emit("update",a):"metadata"===a.event_type?e.emit("metadata",a):"agent_start_talking"===a.event_type?(e.isAgentTalking=!0,e.emit("agent_start_talking")):"agent_stop_talking"===a.event_type?(e.isAgentTalking=!1,e.emit("agent_stop_talking")):"node_transition"===a.event_type&&e.emit("node_transition",a)}catch(o){}})},i}(Wl);const uy=({user:e})=>{const[t]=v.useState(()=>new dy),[s,i]=v.useState(!1),[n,r]=v.useState(!1),[a,o]=v.useState([]),[l,c]=v.useState(""),[h,f]=v.useState("idle"),[m,g]=v.useState(!1),[y,b]=v.useState(""),[x,w]=v.useState(""),[S,k]=v.useState("all"),[_,C]=v.useState("all"),[N,T]=v.useState("today"),[A,E]=v.useState({totalCalls:0,avgDuration:"0:00",avgCostPerCall:0,successRate:0,totalDuration:"0:00",positiveSentiment:0,highestCostCall:0,failedCalls:0,totalCost:0,totalMinutes:0}),[j,P]=v.useState(null),[I,L]=v.useState(!1),[R,O]=v.useState(1),[D,M]=v.useState(0),U=50,{formatLastRefreshTime:B}=Rl({enabled:!0,interval:12e4,onRefresh:()=>{q()}});v.useEffect(()=>(t.on("call_started",()=>{i(!0),f("active"),c("")}),t.on("call_ended",()=>{i(!1),f("completed"),q()}),t.on("update",e=>{e.transcript&&c(e.transcript)}),t.on("error",e=>{b(`Call error: ${e.message}`),i(!1),f("failed")}),()=>{s&&t.stopCall()}),[t]),v.useEffect(()=>{O(1),q()},[N]),v.useEffect(()=>{q()},[R]);const q=(t=0)=>p(void 0,null,function*(){var s;g(!0),b("");try{if(!$l.isConfigured()){const e=JSON.parse(localStorage.getItem("currentUser")||"{}");if(e.id){const t=JSON.parse(localStorage.getItem(`settings_${e.id}`)||"{}");$l.updateCredentials(t.retellApiKey,t.callAgentId,t.smsAgentId)}if(!$l.isConfigured())return b("API not configured. Go to Settings → API Configuration to set up your credentials."),void g(!1)}if(!$l.isConfigured()){const e=yield $l.testConnection();if(!e.success)return b(`API Connection Error: ${e.message}`),void g(!1)}const{start:n,end:r}=Dl(N);let a;try{if(t>0){const e=Math.min(1e3*Math.pow(2,t),8e3);yield new Promise(t=>setTimeout(t,e))}a=yield $l.getCallHistoryByDateRange(n,r,{limit:300})}catch(i){if((null==(s=i.message)?void 0:s.includes("429"))||429===i.status){if(t<3)return q(t+1);throw new Error("Rate limit exceeded. Please wait a moment and try again.")}throw i}const l=a.calls;M(l.length);const c=(R-1)*U,h=c+U,f=l.slice(c,h).map(e=>{var t,s,i,n,r;let a;if(void 0!==e.duration_ms&&null!==e.duration_ms)a=e.duration_ms/1e3;else if(e.start_timestamp&&e.end_timestamp){let t=e.start_timestamp,s=e.end_timestamp;e.start_timestamp.toString().length<=10&&(t=1e3*e.start_timestamp),e.end_timestamp.toString().length<=10&&(s=1e3*e.end_timestamp),a=(s-t)/1e3}return u(d({},e),{patient_id:(null==(t=e.metadata)?void 0:t.patient_id)||`patient_${Math.random().toString(36).substr(2,9)}`,call_length_seconds:a,call_summary:(null==(s=e.call_analysis)?void 0:s.call_summary)||void 0,sentiment_analysis:(null==(i=e.call_analysis)?void 0:i.user_sentiment)?{overall_sentiment:e.call_analysis.user_sentiment,confidence_score:.8}:void 0,metadata:d({patient_name:(null==(n=e.metadata)?void 0:n.patient_name)||`Patient ${(null==(r=e.metadata)?void 0:r.patient_id)||"Unknown"}`,call_type:"phone_call"===e.call_type?"Phone Call":"Web Call"},e.metadata)})});o(f);const m=$l.calculateCallMetrics(l);E(m),yield W.logPHIAccess(V.VIEW,G.CALL,"call-list-access",J.SUCCESS,{calls_count:f.length,date_range:N,user_id:e.id})}catch(i){b(i instanceof Error?i.message:"Failed to fetch call data")}finally{g(!1)}}),$=e=>{if(!e||e<=0)return"0s";if(e<1)return`${e.toFixed(3)}s`;if(e<60)return`${e.toFixed(2)}s`;const t=e/60;if(t<60)return`${t.toFixed(3)} min`;return`${(e/3600).toFixed(3)}h`},z=e=>{var t;return(((null==(t=e.call_cost)?void 0:t.combined_cost)||0)/100).toFixed(3)},H=e=>{switch(e){case"positive":return"text-green-600 bg-green-50 border-green-200";case"negative":return"text-red-600 bg-red-50 border-red-200";case"neutral":return"text-yellow-600 bg-yellow-50 border-yellow-200";default:return"text-gray-600 bg-gray-50 border-gray-200"}},K=e=>{switch(e){case"completed":return"text-green-600 bg-green-50";case"failed":return"text-red-600 bg-red-50";case"active":return"text-blue-600 bg-blue-50";default:return"text-gray-600 bg-gray-50"}},Y=a.filter(e=>{var t,s,i,n,r;const a=!x||(null==(t=e.patient_id)?void 0:t.toLowerCase().includes(x.toLowerCase()))||(null==(i=null==(s=e.metadata)?void 0:s.patient_name)?void 0:i.toLowerCase().includes(x.toLowerCase()))||(null==(n=e.transcript)?void 0:n.toLowerCase().includes(x.toLowerCase())),o="all"===S||e.call_status===S,l="all"===_||(null==(r=e.sentiment_analysis)?void 0:r.overall_sentiment)===_;return a&&o&&l});return F.jsxs("div",{className:"p-6 space-y-6",children:[F.jsxs("div",{className:"flex items-center justify-between mb-4",children:[F.jsx(Ol,{selectedRange:N,onRangeChange:(e,t,s)=>{T(e);const{start:i,end:n}=Dl(e,t,s)}}),F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsxs("button",{onClick:q,className:"flex items-center gap-2 px-3 py-2 text-gray-600 hover:text-gray-900 transition-colors",children:[F.jsx(nl,{className:"w-4 h-4"}),"Refresh"]}),F.jsxs("button",{className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[F.jsx(Io,{className:"w-4 h-4"}),"Export Call Report"]})]})]}),F.jsxs("div",{className:"text-xs text-gray-500 mb-6",children:["Last refreshed: ",B()," (Auto-refresh every 2 minutes)"]}),F.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Total Calls"}),F.jsx(el,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:m?"...":A.totalCalls}),F.jsx("div",{className:"text-xs text-gray-500",children:A.totalCalls>0?`${A.totalCalls-A.failedCalls} completed, ${A.failedCalls} failed`:"No calls made"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Avg Call Duration"}),F.jsx(Eo,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:m?"...":A.avgDuration}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Longest: ",A.avgDuration]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Avg Cost Per Call"}),F.jsx(Po,{className:"w-4 h-4 text-gray-400"})]}),F.jsxs("div",{className:"text-3xl font-black text-blue-600 mb-1",children:["$",m?"...":A.avgCostPerCall.toFixed(2)]}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Total cost: $",(A.totalCost||0).toFixed(2)]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Success Rate"}),F.jsx(yl,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:m?"...":`${A.successRate.toFixed(1)}%`}),F.jsx("div",{className:"text-xs text-gray-500",children:A.totalCalls>0?A.totalCalls-A.failedCalls+" goals achieved":"0 goals achieved"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Total Duration"}),F.jsx(Eo,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:m?"...":A.totalDuration}),F.jsx("div",{className:"text-xs text-gray-500",children:"0 calls analyzed"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Total Minutes"}),F.jsx(Eo,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:m?"...":A.totalMinutes||0}),F.jsxs("div",{className:"text-xs text-gray-500",children:[A.totalCalls," calls"]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Highest Cost Call"}),F.jsx(yl,{className:"w-4 h-4 text-gray-400"})]}),F.jsxs("div",{className:"text-3xl font-black text-blue-600 mb-1",children:["$",m?"...":A.highestCostCall.toFixed(2)]}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Lowest: $",A.highestCostCall.toFixed(2)]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Failed Calls"}),F.jsx(Co,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:m?"...":A.failedCalls}),F.jsx("div",{className:"text-xs text-gray-500",children:"0% failure rate"})]})]}),F.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:F.jsxs("div",{className:"flex items-center justify-between mb-4",children:[F.jsxs("div",{children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(Po,{className:"w-5 h-5 text-green-600"}),F.jsx("span",{className:"text-lg font-semibold text-gray-900",children:"Total Call Costs"})]}),F.jsx("p",{className:"text-sm text-gray-500",children:"Complete cost breakdown for selected date range"})]}),F.jsxs("div",{className:"text-right",children:[F.jsxs("div",{className:"text-3xl font-black text-green-600",children:["$",m?"...":(A.totalCost||0).toFixed(2)]}),F.jsxs("div",{className:"text-sm text-gray-500",children:[A.totalCalls," calls"]})]})]})}),y&&F.jsxs("div",{className:"mb-6 bg-red-50 border border-red-200 rounded-lg p-4 flex items-center gap-3",children:[F.jsx(Co,{className:"w-5 h-5 text-red-600 flex-shrink-0"}),F.jsx("span",{className:"text-red-700",children:y}),F.jsx("button",{onClick:()=>b(""),className:"ml-auto text-red-600 hover:text-red-800 text-xl",children:"×"})]}),s&&F.jsxs("div",{className:"mb-8 bg-white border border-blue-200 rounded-xl p-6 shadow-sm",children:[F.jsxs("div",{className:"flex justify-between items-center mb-6",children:[F.jsxs("div",{className:"flex items-center gap-4",children:[F.jsx("div",{className:"w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center",children:F.jsx(Qo,{className:"w-6 h-6 text-white"})}),F.jsxs("div",{children:[F.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Active Call"}),F.jsxs("p",{className:"text-gray-600",children:["Status: ",h]})]})]}),F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsx("button",{onClick:()=>{s&&r(!n)},className:"p-3 rounded-lg transition-colors "+(n?"bg-red-100 text-red-600 hover:bg-red-200":"bg-gray-100 text-gray-600 hover:bg-gray-200"),children:n?F.jsx(Jo,{className:"w-5 h-5"}):F.jsx(Wo,{className:"w-5 h-5"})}),F.jsx("button",{onClick:()=>{t.stopCall(),i(!1),f("completed")},className:"bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg transition-colors",children:F.jsx(Zo,{className:"w-5 h-5"})})]})]}),F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsx("h4",{className:"font-medium text-gray-900 mb-3",children:"Live Transcript"}),F.jsx("div",{className:"h-32 overflow-y-auto bg-white p-4 rounded border text-sm",children:l||"Listening..."})]})]}),F.jsx("div",{className:"mb-6 bg-white rounded-xl shadow-sm border border-gray-200 p-6",children:F.jsxs("div",{className:"flex flex-col lg:flex-row gap-4",children:[F.jsxs("div",{className:"flex-1 relative",children:[F.jsx(al,{className:"w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"}),F.jsx("input",{type:"search",placeholder:"Search calls by patient name, ID, or content...",value:x,onChange:e=>w(e.target.value),className:"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),F.jsxs("div",{className:"flex gap-3",children:[F.jsxs("select",{value:S,onChange:e=>k(e.target.value),className:"px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[120px]",children:[F.jsx("option",{value:"all",children:"All Status"}),F.jsx("option",{value:"active",children:"Active"}),F.jsx("option",{value:"completed",children:"Completed"}),F.jsx("option",{value:"failed",children:"Failed"})]}),F.jsxs("select",{value:_,onChange:e=>C(e.target.value),className:"px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[130px]",children:[F.jsx("option",{value:"all",children:"All Sentiment"}),F.jsx("option",{value:"positive",children:"Positive"}),F.jsx("option",{value:"neutral",children:"Neutral"}),F.jsx("option",{value:"negative",children:"Negative"})]})]})]})}),F.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:m?F.jsxs("div",{className:"text-center py-12",children:[F.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"}),F.jsx("p",{className:"text-gray-600 mt-4",children:"Loading calls..."})]}):Y.length>0?F.jsxs("div",{className:"overflow-x-auto",children:[F.jsx("div",{className:"bg-gray-50 border-b border-gray-200 px-6 py-3 hidden md:block",children:F.jsxs("div",{className:"grid grid-cols-12 gap-4 text-sm font-medium text-gray-700",children:[F.jsx("div",{className:"col-span-1",children:"#"}),F.jsx("div",{className:"col-span-3",children:"Patient"}),F.jsx("div",{className:"col-span-2",children:"Date & Time"}),F.jsx("div",{className:"col-span-2",children:"Duration"}),F.jsx("div",{className:"col-span-2",children:"Status"}),F.jsx("div",{className:"col-span-2",children:"Cost"})]})}),F.jsx("div",{className:"divide-y divide-gray-200",children:Y.map((e,t)=>{var s,i;const n=(R-1)*U+t+1,r=t%2==0?"bg-white":"bg-gray-25";return F.jsxs("div",{className:`px-6 py-4 hover:bg-blue-50 cursor-pointer transition-colors ${r}`,onClick:()=>{P(e),L(!0)},children:[F.jsxs("div",{className:"hidden md:grid grid-cols-12 gap-4 items-center",children:[F.jsx("div",{className:"col-span-1",children:F.jsxs("span",{className:"text-sm font-medium text-gray-500",children:["#",n]})}),F.jsx("div",{className:"col-span-3",children:F.jsx("div",{className:"flex items-center",children:F.jsxs("div",{children:[F.jsx("div",{className:"font-medium text-gray-900",children:(null==(s=e.metadata)?void 0:s.patient_name)||`Patient ${e.patient_id}`}),F.jsx("div",{className:"text-sm text-gray-500",children:e.from_number||e.to_number||"No phone number"})]})})}),F.jsxs("div",{className:"col-span-2",children:[F.jsx("div",{className:"text-sm text-gray-900",children:new Date(e.start_timestamp).toLocaleDateString()}),F.jsx("div",{className:"text-sm text-gray-500",children:new Date(e.start_timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),F.jsx("div",{className:"col-span-2",children:F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx(Eo,{className:"w-4 h-4 text-gray-400"}),F.jsx("span",{className:"text-sm font-medium text-gray-900",children:$(e.call_length_seconds)})]})}),F.jsx("div",{className:"col-span-2",children:F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${K(e.call_status)}`,children:e.call_status}),e.sentiment_analysis&&F.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium border ${H(e.sentiment_analysis.overall_sentiment)}`,children:e.sentiment_analysis.overall_sentiment})]})}),F.jsx("div",{className:"col-span-2",children:F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx(Po,{className:"w-4 h-4 text-gray-400"}),F.jsxs("span",{className:"text-sm font-medium text-gray-900",children:["$",z(e)]})]})})]}),F.jsxs("div",{className:"md:hidden space-y-3",children:[F.jsx("div",{className:"flex items-start justify-between",children:F.jsx("div",{className:"flex items-center",children:F.jsxs("div",{children:[F.jsx("div",{className:"font-semibold text-gray-900",children:(null==(i=e.metadata)?void 0:i.patient_name)||`Patient ${e.patient_id}`}),F.jsx("div",{className:"text-sm text-gray-500",children:e.from_number||e.to_number||"No phone number"})]})})}),F.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-sm",children:[F.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${K(e.call_status)}`,children:e.call_status}),F.jsxs("span",{className:"flex items-center gap-1 text-gray-600",children:[F.jsx(Eo,{className:"w-3 h-3"}),$(e.call_length_seconds)]}),F.jsxs("span",{className:"flex items-center gap-1 text-gray-600",children:[F.jsx(Po,{className:"w-3 h-3"}),"$",z(e)]}),e.sentiment_analysis&&F.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium border ${H(e.sentiment_analysis.overall_sentiment)}`,children:e.sentiment_analysis.overall_sentiment})]}),F.jsxs("div",{className:"text-sm text-gray-500",children:[new Date(e.start_timestamp).toLocaleDateString()," at ",new Date(e.start_timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]})]})]},e.call_id)})})]}):F.jsxs("div",{className:"text-center py-16",children:[F.jsx(el,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),F.jsx("h3",{className:"text-xl font-medium text-gray-900 mb-2",children:"No calls found"}),F.jsx("p",{className:"text-gray-600",children:"No calls have been made yet."})]})}),D>U&&F.jsxs("div",{className:"flex items-center justify-between mt-8 bg-white rounded-lg border border-gray-200 px-6 py-4",children:[F.jsx("div",{className:"flex items-center text-sm text-gray-700",children:F.jsxs("span",{children:["Showing ",(R-1)*U+1," to ",Math.min(R*U,D)," of ",D," calls"]})}),F.jsxs("div",{className:"flex items-center space-x-2",children:[F.jsx("button",{onClick:()=>O(e=>Math.max(e-1,1)),disabled:1===R,className:"px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"Previous"}),F.jsx("div",{className:"flex items-center space-x-1",children:(()=>{const e=Math.ceil(D/U),t=[],s=Math.max(1,R-2),i=Math.min(e,R+2);s>1&&(t.push(F.jsx("button",{onClick:()=>O(1),className:"px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50",children:"1"},1)),s>2&&t.push(F.jsx("span",{className:"px-2 text-gray-500",children:"..."},"ellipsis1")));for(let n=s;n<=i;n++)t.push(F.jsx("button",{onClick:()=>O(n),className:"px-3 py-2 text-sm font-medium rounded-lg "+(n===R?"text-blue-600 bg-blue-50 border border-blue-200":"text-gray-700 bg-white border border-gray-300 hover:bg-gray-50"),children:n},n));return i<e&&(i<e-1&&t.push(F.jsx("span",{className:"px-2 text-gray-500",children:"..."},"ellipsis2")),t.push(F.jsx("button",{onClick:()=>O(e),className:"px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50",children:e},e))),t})()}),F.jsx("button",{onClick:()=>O(e=>Math.min(e+1,Math.ceil(D/U))),disabled:R>=Math.ceil(D/U),className:"px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"Next"})]})]}),j&&F.jsx(Gl,{call:j,isOpen:I,onClose:()=>{L(!1),P(null)}})]})},hy=()=>{const[e,t]=v.useState({totalCalls:0,avgDuration:"0:00",avgCostPerCall:0,successRate:0,totalDuration:"0:00",positiveSentiment:0,highestCostCall:0,failedCalls:0}),[s,i]=v.useState([]),[n,r]=v.useState("today"),[a,o]=v.useState(!0),[l,c]=v.useState(""),[d,u]=v.useState("checking"),{formatLastRefreshTime:h}=Rl({enabled:!0,interval:6e4,onRefresh:()=>{f()}});v.useEffect(()=>{f()},[n]);const f=()=>p(void 0,null,function*(){o(!0),c("");try{const s=JSON.parse(localStorage.getItem("currentUser")||"{}");if(s.id){const e=JSON.parse(localStorage.getItem(`settings_${s.id}`)||"{}");$l.updateCredentials(e.retellApiKey,e.callAgentId,e.smsAgentId)}if(!$l.isConfigured())return u("not-configured"),void o(!1);const r=yield $l.testConnection();if(!r.success)return u("error"),c(`API Connection Error: ${r.message}`),void o(!1);u("connected");const{start:a,end:l}=Dl(n);let d;try{d={calls:(yield $l.getCallHistoryByDateRange(a,l,{limit:300})).calls,pagination_key:void 0,has_more:!1}}catch(e){d={calls:[],pagination_key:void 0,has_more:!1}}const h=$l.calculateCallMetrics(d.calls);t({totalCalls:h.totalCalls,avgDuration:h.avgCallDuration,avgCostPerCall:h.avgCostPerCall,successRate:h.callSuccessRate,totalDuration:h.totalCallDuration,positiveSentiment:85,highestCostCall:h.highestCostCall,failedCalls:d.calls.filter(e=>"error"===e.call_status).length});const f=m(d.calls);i(f)}catch(e){c(e instanceof Error?e.message:"Failed to load dashboard data"),u("error"),t({totalCalls:0,avgDuration:"0:00",avgCostPerCall:0,successRate:0,totalDuration:"0:00",positiveSentiment:0,highestCostCall:0,failedCalls:0}),i([])}finally{o(!1)}}),m=e=>{const t={};return e.forEach(e=>{const s=new Date(e.start_timestamp).toISOString().split("T")[0];t[s]||(t[s]={calls:0,duration:0,success:0}),t[s].calls++,t[s].duration+=e.call_length_seconds||0,"completed"===e.call_status&&t[s].success++}),Object.entries(t).map(([e,t])=>({date:e,calls:t.calls,duration:t.duration,success:t.success/t.calls*100})).sort((e,t)=>e.date.localeCompare(t.date))};return s.length>0&&Math.max(...s.map(e=>e.calls)),F.jsxs("div",{className:"p-6 space-y-6",children:[F.jsxs("div",{className:"flex items-center justify-between mb-4",children:[F.jsx(Ol,{selectedRange:n,onRangeChange:(e,t,s)=>{r(e);const{start:i,end:n}=Dl(e,t,s);f()}}),F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsxs("button",{onClick:f,className:"flex items-center gap-2 px-3 py-2 text-gray-600 hover:text-gray-900 transition-colors",children:[F.jsx(nl,{className:"w-4 h-4"}),"Refresh"]}),F.jsxs("button",{className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[F.jsx(Io,{className:"w-4 h-4"}),"Export Analytics Report"]})]})]}),F.jsxs("div",{className:"text-xs text-gray-500 mb-6",children:["Last refreshed: ",h()," (Auto-refresh every minute)"]}),"not-configured"===d&&F.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[F.jsxs("div",{className:"flex items-center gap-2 text-yellow-800",children:[F.jsx(bl,{className:"w-5 h-5"}),F.jsx("p",{className:"font-medium",children:"Retell API Not Configured"})]}),F.jsx("p",{className:"text-sm text-yellow-700 mt-1",children:"Please configure your Retell API credentials in Settings to view call analytics."})]}),"error"===d&&l&&F.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:[F.jsxs("div",{className:"flex items-center gap-2 text-red-800",children:[F.jsx(bl,{className:"w-5 h-5"}),F.jsx("p",{className:"font-medium",children:"API Connection Error"})]}),F.jsx("p",{className:"text-sm text-red-700 mt-1",children:l})]}),F.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Total Calls"}),F.jsx(el,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:a?"...":e.totalCalls}),F.jsx("div",{className:"text-xs text-gray-500",children:e.totalCalls>0?`${e.totalCalls-(e.failedCalls||0)} completed, ${e.failedCalls||0} failed`:"No calls made"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Avg Call Duration"}),F.jsx(Eo,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:a?"...":e.avgDuration}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Longest: ",e.avgDuration]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Avg Cost Per Call"}),F.jsx(Po,{className:"w-4 h-4 text-gray-400"})]}),F.jsxs("div",{className:"text-3xl font-black text-blue-600 mb-1",children:["$",a?"...":(e.avgCostPerCall||0).toFixed(2)]}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Total cost: $",(e.avgCostPerCall||0).toFixed(2)]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Success Rate"}),F.jsx(yl,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:a?"...":`${(e.successRate||0).toFixed(1)}%`}),F.jsx("div",{className:"text-xs text-gray-500",children:e.totalCalls>0?e.totalCalls-(e.failedCalls||0)+" goals achieved":"0 goals achieved"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Total Duration"}),F.jsx(Eo,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:a?"...":e.totalDuration}),F.jsx("div",{className:"text-xs text-gray-500",children:"0 calls analyzed"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Positive Sentiment"}),F.jsx(pl,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:a?"...":`${e.positiveSentiment}/0`}),F.jsx("div",{className:"text-xs text-gray-500",children:"0% positive"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Highest Cost Call"}),F.jsx(yl,{className:"w-4 h-4 text-gray-400"})]}),F.jsxs("div",{className:"text-3xl font-black text-blue-600 mb-1",children:["$",a?"...":(e.highestCostCall||0).toFixed(2)]}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Lowest: $",(e.highestCostCall||0).toFixed(2)]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Failed Calls"}),F.jsx(bl,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:a?"...":e.failedCalls}),F.jsx("div",{className:"text-xs text-gray-500",children:"0% failure rate"})]})]}),F.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:F.jsxs("div",{className:"flex items-center justify-between mb-4",children:[F.jsxs("div",{children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(Po,{className:"w-5 h-5 text-green-600"}),F.jsx("span",{className:"text-lg font-semibold text-gray-900",children:"Total Call Costs"})]}),F.jsx("p",{className:"text-sm text-gray-500",children:"Complete cost breakdown for selected date range"})]}),F.jsxs("div",{className:"text-right",children:[F.jsxs("div",{className:"text-3xl font-black text-green-600",children:["$",(e.avgCostPerCall||0).toFixed(2)]}),F.jsxs("div",{className:"text-sm text-gray-500",children:[e.totalCalls," calls"]})]})]})})]})};function fy(e){return(fy="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var my=Uint8Array,py=Uint16Array,gy=Int32Array,vy=new my([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),yy=new my([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),by=new my([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),xy=function(e,t){for(var s=new py(31),i=0;i<31;++i)s[i]=t+=1<<e[i-1];var n=new gy(s[30]);for(i=1;i<30;++i)for(var r=s[i];r<s[i+1];++r)n[r]=r-s[i]<<5|i;return{b:s,r:n}},wy=xy(vy,2),Sy=wy.b,ky=wy.r;Sy[28]=258,ky[258]=28;for(var _y=xy(yy,0),Cy=_y.b,Ny=_y.r,Ty=new py(32768),Ay=0;Ay<32768;++Ay){var Ey=(43690&Ay)>>1|(21845&Ay)<<1;Ey=(61680&(Ey=(52428&Ey)>>2|(13107&Ey)<<2))>>4|(3855&Ey)<<4,Ty[Ay]=((65280&Ey)>>8|(255&Ey)<<8)>>1}var jy=function(e,t,s){for(var i=e.length,n=0,r=new py(t);n<i;++n)e[n]&&++r[e[n]-1];var a,o=new py(t);for(n=1;n<t;++n)o[n]=o[n-1]+r[n-1]<<1;if(s){a=new py(1<<t);var l=15-t;for(n=0;n<i;++n)if(e[n])for(var c=n<<4|e[n],d=t-e[n],u=o[e[n]-1]++<<d,h=u|(1<<d)-1;u<=h;++u)a[Ty[u]>>l]=c}else for(a=new py(i),n=0;n<i;++n)e[n]&&(a[n]=Ty[o[e[n]-1]++]>>15-e[n]);return a},Py=new my(288);for(Ay=0;Ay<144;++Ay)Py[Ay]=8;for(Ay=144;Ay<256;++Ay)Py[Ay]=9;for(Ay=256;Ay<280;++Ay)Py[Ay]=7;for(Ay=280;Ay<288;++Ay)Py[Ay]=8;var Iy=new my(32);for(Ay=0;Ay<32;++Ay)Iy[Ay]=5;var Ly=jy(Py,9,0),Ry=jy(Py,9,1),Oy=jy(Iy,5,0),Dy=jy(Iy,5,1),My=function(e){for(var t=e[0],s=1;s<e.length;++s)e[s]>t&&(t=e[s]);return t},Uy=function(e,t,s){var i=t/8|0;return(e[i]|e[i+1]<<8)>>(7&t)&s},Fy=function(e,t){var s=t/8|0;return(e[s]|e[s+1]<<8|e[s+2]<<16)>>(7&t)},By=function(e){return(e+7)/8|0},qy=function(e,t,s){return(null==s||s>e.length)&&(s=e.length),new my(e.subarray(t,s))},$y=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],zy=function(e,t,s){var i=new Error(t||$y[e]);if(i.code=e,Error.captureStackTrace&&Error.captureStackTrace(i,zy),!s)throw i;return i},Hy=function(e,t,s){s<<=7&t;var i=t/8|0;e[i]|=s,e[i+1]|=s>>8},Vy=function(e,t,s){s<<=7&t;var i=t/8|0;e[i]|=s,e[i+1]|=s>>8,e[i+2]|=s>>16},Gy=function(e,t){for(var s=[],i=0;i<e.length;++i)e[i]&&s.push({s:i,f:e[i]});var n=s.length,r=s.slice();if(!n)return{t:Zy,l:0};if(1==n){var a=new my(s[0].s+1);return a[s[0].s]=1,{t:a,l:1}}s.sort(function(e,t){return e.f-t.f}),s.push({s:-1,f:25001});var o=s[0],l=s[1],c=0,d=1,u=2;for(s[0]={s:-1,f:o.f+l.f,l:o,r:l};d!=n-1;)o=s[s[c].f<s[u].f?c++:u++],l=s[c!=d&&s[c].f<s[u].f?c++:u++],s[d++]={s:-1,f:o.f+l.f,l:o,r:l};var h=r[0].s;for(i=1;i<n;++i)r[i].s>h&&(h=r[i].s);var f=new py(h+1),m=Jy(s[d-1],f,0);if(m>t){i=0;var p=0,g=m-t,v=1<<g;for(r.sort(function(e,t){return f[t.s]-f[e.s]||e.f-t.f});i<n;++i){var y=r[i].s;if(!(f[y]>t))break;p+=v-(1<<m-f[y]),f[y]=t}for(p>>=g;p>0;){var b=r[i].s;f[b]<t?p-=1<<t-f[b]++-1:++i}for(;i>=0&&p;--i){var x=r[i].s;f[x]==t&&(--f[x],++p)}m=t}return{t:new my(f),l:m}},Jy=function(e,t,s){return-1==e.s?Math.max(Jy(e.l,t,s+1),Jy(e.r,t,s+1)):t[e.s]=s},Wy=function(e){for(var t=e.length;t&&!e[--t];);for(var s=new py(++t),i=0,n=e[0],r=1,a=function(e){s[i++]=e},o=1;o<=t;++o)if(e[o]==n&&o!=t)++r;else{if(!n&&r>2){for(;r>138;r-=138)a(32754);r>2&&(a(r>10?r-11<<5|28690:r-3<<5|12305),r=0)}else if(r>3){for(a(n),--r;r>6;r-=6)a(8304);r>2&&(a(r-3<<5|8208),r=0)}for(;r--;)a(n);r=1,n=e[o]}return{c:s.subarray(0,i),n:t}},Ky=function(e,t){for(var s=0,i=0;i<t.length;++i)s+=e[i]*t[i];return s},Yy=function(e,t,s){var i=s.length,n=By(t+2);e[n]=255&i,e[n+1]=i>>8,e[n+2]=255^e[n],e[n+3]=255^e[n+1];for(var r=0;r<i;++r)e[n+r+4]=s[r];return 8*(n+4+i)},Xy=function(e,t,s,i,n,r,a,o,l,c,d){Hy(t,d++,s),++n[256];for(var u=Gy(n,15),h=u.t,f=u.l,m=Gy(r,15),p=m.t,g=m.l,v=Wy(h),y=v.c,b=v.n,x=Wy(p),w=x.c,S=x.n,k=new py(19),_=0;_<y.length;++_)++k[31&y[_]];for(_=0;_<w.length;++_)++k[31&w[_]];for(var C=Gy(k,7),N=C.t,T=C.l,A=19;A>4&&!N[by[A-1]];--A);var E,j,P,I,L=c+5<<3,R=Ky(n,Py)+Ky(r,Iy)+a,O=Ky(n,h)+Ky(r,p)+a+14+3*A+Ky(k,N)+2*k[16]+3*k[17]+7*k[18];if(l>=0&&L<=R&&L<=O)return Yy(t,d,e.subarray(l,l+c));if(Hy(t,d,1+(O<R)),d+=2,O<R){E=jy(h,f,0),j=h,P=jy(p,g,0),I=p;var D=jy(N,T,0);Hy(t,d,b-257),Hy(t,d+5,S-1),Hy(t,d+10,A-4),d+=14;for(_=0;_<A;++_)Hy(t,d+3*_,N[by[_]]);d+=3*A;for(var M=[y,w],U=0;U<2;++U){var F=M[U];for(_=0;_<F.length;++_){var B=31&F[_];Hy(t,d,D[B]),d+=N[B],B>15&&(Hy(t,d,F[_]>>5&127),d+=F[_]>>12)}}}else E=Ly,j=Py,P=Oy,I=Iy;for(_=0;_<o;++_){var q=i[_];if(q>255){Vy(t,d,E[(B=q>>18&31)+257]),d+=j[B+257],B>7&&(Hy(t,d,q>>23&31),d+=vy[B]);var $=31&q;Vy(t,d,P[$]),d+=I[$],$>3&&(Vy(t,d,q>>5&8191),d+=yy[$])}else Vy(t,d,E[q]),d+=j[q]}return Vy(t,d,E[256]),d+j[256]},Qy=new gy([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),Zy=new my(0),eb=function(){var e=1,t=0;return{p:function(s){for(var i=e,n=t,r=0|s.length,a=0;a!=r;){for(var o=Math.min(a+2655,r);a<o;++a)n+=i+=s[a];i=(65535&i)+15*(i>>16),n=(65535&n)+15*(n>>16)}e=i,t=n},d:function(){return(255&(e%=65521))<<24|(65280&e)<<8|(255&(t%=65521))<<8|t>>8}}},tb=function(e,t,s,i,n){if(!n&&(n={l:1},t.dictionary)){var r=t.dictionary.subarray(-32768),a=new my(r.length+e.length);a.set(r),a.set(e,r.length),e=a,n.w=r.length}return function(e,t,s,i,n,r){var a=r.z||e.length,o=new my(i+a+5*(1+Math.ceil(a/7e3))+n),l=o.subarray(i,o.length-n),c=r.l,d=7&(r.r||0);if(t){d&&(l[0]=r.r>>3);for(var u=Qy[t-1],h=u>>13,f=8191&u,m=(1<<s)-1,p=r.p||new py(32768),g=r.h||new py(m+1),v=Math.ceil(s/3),y=2*v,b=function(t){return(e[t]^e[t+1]<<v^e[t+2]<<y)&m},x=new gy(25e3),w=new py(288),S=new py(32),k=0,_=0,C=r.i||0,N=0,T=r.w||0,A=0;C+2<a;++C){var E=b(C),j=32767&C,P=g[E];if(p[j]=P,g[E]=j,T<=C){var I=a-C;if((k>7e3||N>24576)&&(I>423||!c)){d=Xy(e,l,0,x,w,S,_,N,A,C-A,d),N=k=_=0,A=C;for(var L=0;L<286;++L)w[L]=0;for(L=0;L<30;++L)S[L]=0}var R=2,O=0,D=f,M=j-P&32767;if(I>2&&E==b(C-M))for(var U=Math.min(h,I)-1,F=Math.min(32767,C),B=Math.min(258,I);M<=F&&--D&&j!=P;){if(e[C+R]==e[C+R-M]){for(var q=0;q<B&&e[C+q]==e[C+q-M];++q);if(q>R){if(R=q,O=M,q>U)break;var $=Math.min(M,q-2),z=0;for(L=0;L<$;++L){var H=C-M+L&32767,V=H-p[H]&32767;V>z&&(z=V,P=H)}}}M+=(j=P)-(P=p[j])&32767}if(O){x[N++]=268435456|ky[R]<<18|Ny[O];var G=31&ky[R],J=31&Ny[O];_+=vy[G]+yy[J],++w[257+G],++S[J],T=C+R,++k}else x[N++]=e[C],++w[e[C]]}}for(C=Math.max(C,T);C<a;++C)x[N++]=e[C],++w[e[C]];d=Xy(e,l,c,x,w,S,_,N,A,C-A,d),c||(r.r=7&d|l[d/8|0]<<3,d-=7,r.h=g,r.p=p,r.i=C,r.w=T)}else{for(C=r.w||0;C<a+c;C+=65535){var W=C+65535;W>=a&&(l[d/8|0]=c,W=a),d=Yy(l,d+1,e.subarray(C,W))}r.i=a}return qy(o,0,i+By(d)+n)}(e,null==t.level?6:t.level,null==t.mem?n.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):20:12+t.mem,s,i,n)},sb=function(e,t,s){for(;s;++t)e[t]=s,s>>>=8};function ib(e,t){t||(t={});var s=eb();s.p(e);var i=tb(e,t,t.dictionary?6:2,4);return function(e,t){var s=t.level,i=0==s?0:s<6?1:9==s?3:2;if(e[0]=120,e[1]=i<<6|(t.dictionary&&32),e[1]|=31-(e[0]<<8|e[1])%31,t.dictionary){var n=eb();n.p(t.dictionary),sb(e,2,n.d())}}(i,t),sb(i,i.length-4,s.d()),i}function nb(e,t){return function(e,t,s,i){var n=e.length;if(!n||t.f&&!t.l)return s||new my(0);var r=!s,a=r||2!=t.i,o=t.i;r&&(s=new my(3*n));var l=function(e){var t=s.length;if(e>t){var i=new my(Math.max(2*t,e));i.set(s),s=i}},c=t.f||0,d=t.p||0,u=t.b||0,h=t.l,f=t.d,m=t.m,p=t.n,g=8*n;do{if(!h){c=Uy(e,d,1);var v=Uy(e,d+1,3);if(d+=3,!v){var y=e[(E=By(d)+4)-4]|e[E-3]<<8,b=E+y;if(b>n){o&&zy(0);break}a&&l(u+y),s.set(e.subarray(E,b),u),t.b=u+=y,t.p=d=8*b,t.f=c;continue}if(1==v)h=Ry,f=Dy,m=9,p=5;else if(2==v){var x=Uy(e,d,31)+257,w=Uy(e,d+10,15)+4,S=x+Uy(e,d+5,31)+1;d+=14;for(var k=new my(S),_=new my(19),C=0;C<w;++C)_[by[C]]=Uy(e,d+3*C,7);d+=3*w;var N=My(_),T=(1<<N)-1,A=jy(_,N,1);for(C=0;C<S;){var E,j=A[Uy(e,d,T)];if(d+=15&j,(E=j>>4)<16)k[C++]=E;else{var P=0,I=0;for(16==E?(I=3+Uy(e,d,3),d+=2,P=k[C-1]):17==E?(I=3+Uy(e,d,7),d+=3):18==E&&(I=11+Uy(e,d,127),d+=7);I--;)k[C++]=P}}var L=k.subarray(0,x),R=k.subarray(x);m=My(L),p=My(R),h=jy(L,m,1),f=jy(R,p,1)}else zy(1);if(d>g){o&&zy(0);break}}a&&l(u+131072);for(var O=(1<<m)-1,D=(1<<p)-1,M=d;;M=d){var U=(P=h[Fy(e,d)&O])>>4;if((d+=15&P)>g){o&&zy(0);break}if(P||zy(2),U<256)s[u++]=U;else{if(256==U){M=d,h=null;break}var F=U-254;if(U>264){var B=vy[C=U-257];F=Uy(e,d,(1<<B)-1)+Sy[C],d+=B}var q=f[Fy(e,d)&D],$=q>>4;if(q||zy(3),d+=15&q,R=Cy[$],$>3&&(B=yy[$],R+=Fy(e,d)&(1<<B)-1,d+=B),d>g){o&&zy(0);break}a&&l(u+131072);var z=u+F;if(u<R){var H=0-R,V=Math.min(R,z);for(H+u<0&&zy(3);u<V;++u)s[u]=i[H+u]}for(;u<z;++u)s[u]=s[u-R]}}t.l=h,t.p=M,t.b=u,t.f=c,h&&(c=1,t.m=m,t.d=f,t.n=p)}while(!c);return u!=s.length&&r?qy(s,0,u):s.subarray(0,u)}(e.subarray(((8!=(15&(s=e)[0])||s[0]>>4>7||(s[0]<<8|s[1])%31)&&zy(6,"invalid zlib data"),1==(s[1]>>5&1)&&zy(6,"invalid zlib data: "+(32&s[1]?"need":"unexpected")+" dictionary"),2+(s[1]>>3&4)),-4),{i:2},t,t);var s}var rb="undefined"!=typeof TextDecoder&&new TextDecoder;try{rb.decode(Zy,{stream:!0})}catch(Tx){}var ab=function(){return"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this}();function ob(){ab.console&&"function"==typeof ab.console.log&&ab.console.log.apply(ab.console,arguments)}var lb={log:ob,warn:function(e){ab.console&&("function"==typeof ab.console.warn?ab.console.warn.apply(ab.console,arguments):ob.call(null,arguments))},error:function(e){ab.console&&("function"==typeof ab.console.error?ab.console.error.apply(ab.console,arguments):ob(e))}};function cb(e,t,s){var i=new XMLHttpRequest;i.open("GET",e),i.responseType="blob",i.onload=function(){mb(i.response,t,s)},i.onerror=function(){lb.error("could not download file")},i.send()}function db(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch(s){}return t.status>=200&&t.status<=299}function ub(e){try{e.dispatchEvent(new MouseEvent("click"))}catch(s){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}}var hb,fb,mb=ab.saveAs||("object"!==("undefined"==typeof window?"undefined":fy(window))||window!==ab?function(){}:"undefined"!=typeof HTMLAnchorElement&&"download"in HTMLAnchorElement.prototype?function(e,t,s){var i=ab.URL||ab.webkitURL,n=document.createElement("a");t=t||e.name||"download",n.download=t,n.rel="noopener","string"==typeof e?(n.href=e,n.origin!==location.origin?db(n.href)?cb(e,t,s):ub(n,n.target="_blank"):ub(n)):(n.href=i.createObjectURL(e),setTimeout(function(){i.revokeObjectURL(n.href)},4e4),setTimeout(function(){ub(n)},0))}:"msSaveOrOpenBlob"in navigator?function(e,t,s){if(t=t||e.name||"download","string"==typeof e)if(db(e))cb(e,t,s);else{var i=document.createElement("a");i.href=e,i.target="_blank",setTimeout(function(){ub(i)})}else navigator.msSaveOrOpenBlob((n=e,void 0===(r=s)?r={autoBom:!1}:"object"!==fy(r)&&(lb.warn("Deprecated: Expected third argument to be a object"),r={autoBom:!r}),r.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(n.type)?new Blob([String.fromCharCode(65279),n],{type:n.type}):n),t);var n,r}:function(e,t,s,i){if((i=i||open("","_blank"))&&(i.document.title=i.document.body.innerText="downloading..."),"string"==typeof e)return cb(e,t,s);var n="application/octet-stream"===e.type,r=/constructor/i.test(ab.HTMLElement)||ab.safari,a=/CriOS\/[\d]+/.test(navigator.userAgent);if((a||n&&r)&&"object"===("undefined"==typeof FileReader?"undefined":fy(FileReader))){var o=new FileReader;o.onloadend=function(){var e=o.result;e=a?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"),i?i.location.href=e:location=e,i=null},o.readAsDataURL(e)}else{var l=ab.URL||ab.webkitURL,c=l.createObjectURL(e);i?i.location=c:location.href=c,i=null,setTimeout(function(){l.revokeObjectURL(c)},4e4)}});
/**
 * A class to parse color values
 * @author Stoyan Stefanov <sstoo@gmail.com>
 * {@link   http://www.phpied.com/rgb-color-parser-in-javascript/}
 * @license Use it if you like it
 */function pb(e){var t;e=e||"",this.ok=!1,"#"==e.charAt(0)&&(e=e.substr(1,6)),e={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dodgerblue:"1e90ff",feldspar:"d19275",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgrey:"d3d3d3",lightgreen:"90ee90",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslateblue:"8470ff",lightslategray:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370d8",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"d87093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",violetred:"d02090",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"}[e=(e=e.replace(/ /g,"")).toLowerCase()]||e;for(var s=[{re:/^rgb\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})\)$/,example:["rgb(123, 234, 45)","rgb(255,234,245)"],process:function(e){return[parseInt(e[1]),parseInt(e[2]),parseInt(e[3])]}},{re:/^(\w{2})(\w{2})(\w{2})$/,example:["#00ff00","336699"],process:function(e){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]}},{re:/^(\w{1})(\w{1})(\w{1})$/,example:["#fb0","f0f"],process:function(e){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]}}],i=0;i<s.length;i++){var n=s[i].re,r=s[i].process,a=n.exec(e);a&&(t=r(a),this.r=t[0],this.g=t[1],this.b=t[2],this.ok=!0)}this.r=this.r<0||isNaN(this.r)?0:this.r>255?255:this.r,this.g=this.g<0||isNaN(this.g)?0:this.g>255?255:this.g,this.b=this.b<0||isNaN(this.b)?0:this.b>255?255:this.b,this.toRGB=function(){return"rgb("+this.r+", "+this.g+", "+this.b+")"},this.toHex=function(){var e=this.r.toString(16),t=this.g.toString(16),s=this.b.toString(16);return 1==e.length&&(e="0"+e),1==t.length&&(t="0"+t),1==s.length&&(s="0"+s),"#"+e+t+s}}
/**
 * @license
 * Joseph Myers does not specify a particular license for his work.
 *
 * Author: Joseph Myers
 * Accessed from: http://www.myersdaily.org/joseph/javascript/md5.js
 *
 * Modified by: Owen Leong
 */function gb(e,t){var s=e[0],i=e[1],n=e[2],r=e[3];s=yb(s,i,n,r,t[0],7,-680876936),r=yb(r,s,i,n,t[1],12,-389564586),n=yb(n,r,s,i,t[2],17,606105819),i=yb(i,n,r,s,t[3],22,-1044525330),s=yb(s,i,n,r,t[4],7,-176418897),r=yb(r,s,i,n,t[5],12,1200080426),n=yb(n,r,s,i,t[6],17,-1473231341),i=yb(i,n,r,s,t[7],22,-45705983),s=yb(s,i,n,r,t[8],7,1770035416),r=yb(r,s,i,n,t[9],12,-1958414417),n=yb(n,r,s,i,t[10],17,-42063),i=yb(i,n,r,s,t[11],22,-1990404162),s=yb(s,i,n,r,t[12],7,1804603682),r=yb(r,s,i,n,t[13],12,-40341101),n=yb(n,r,s,i,t[14],17,-1502002290),s=bb(s,i=yb(i,n,r,s,t[15],22,1236535329),n,r,t[1],5,-165796510),r=bb(r,s,i,n,t[6],9,-1069501632),n=bb(n,r,s,i,t[11],14,643717713),i=bb(i,n,r,s,t[0],20,-373897302),s=bb(s,i,n,r,t[5],5,-701558691),r=bb(r,s,i,n,t[10],9,38016083),n=bb(n,r,s,i,t[15],14,-660478335),i=bb(i,n,r,s,t[4],20,-405537848),s=bb(s,i,n,r,t[9],5,568446438),r=bb(r,s,i,n,t[14],9,-1019803690),n=bb(n,r,s,i,t[3],14,-187363961),i=bb(i,n,r,s,t[8],20,1163531501),s=bb(s,i,n,r,t[13],5,-1444681467),r=bb(r,s,i,n,t[2],9,-51403784),n=bb(n,r,s,i,t[7],14,1735328473),s=xb(s,i=bb(i,n,r,s,t[12],20,-1926607734),n,r,t[5],4,-378558),r=xb(r,s,i,n,t[8],11,-2022574463),n=xb(n,r,s,i,t[11],16,1839030562),i=xb(i,n,r,s,t[14],23,-35309556),s=xb(s,i,n,r,t[1],4,-1530992060),r=xb(r,s,i,n,t[4],11,1272893353),n=xb(n,r,s,i,t[7],16,-155497632),i=xb(i,n,r,s,t[10],23,-1094730640),s=xb(s,i,n,r,t[13],4,681279174),r=xb(r,s,i,n,t[0],11,-358537222),n=xb(n,r,s,i,t[3],16,-722521979),i=xb(i,n,r,s,t[6],23,76029189),s=xb(s,i,n,r,t[9],4,-640364487),r=xb(r,s,i,n,t[12],11,-421815835),n=xb(n,r,s,i,t[15],16,530742520),s=wb(s,i=xb(i,n,r,s,t[2],23,-995338651),n,r,t[0],6,-198630844),r=wb(r,s,i,n,t[7],10,1126891415),n=wb(n,r,s,i,t[14],15,-1416354905),i=wb(i,n,r,s,t[5],21,-57434055),s=wb(s,i,n,r,t[12],6,1700485571),r=wb(r,s,i,n,t[3],10,-1894986606),n=wb(n,r,s,i,t[10],15,-1051523),i=wb(i,n,r,s,t[1],21,-2054922799),s=wb(s,i,n,r,t[8],6,1873313359),r=wb(r,s,i,n,t[15],10,-30611744),n=wb(n,r,s,i,t[6],15,-1560198380),i=wb(i,n,r,s,t[13],21,1309151649),s=wb(s,i,n,r,t[4],6,-145523070),r=wb(r,s,i,n,t[11],10,-1120210379),n=wb(n,r,s,i,t[2],15,718787259),i=wb(i,n,r,s,t[9],21,-343485551),e[0]=Eb(s,e[0]),e[1]=Eb(i,e[1]),e[2]=Eb(n,e[2]),e[3]=Eb(r,e[3])}function vb(e,t,s,i,n,r){return t=Eb(Eb(t,e),Eb(i,r)),Eb(t<<n|t>>>32-n,s)}function yb(e,t,s,i,n,r,a){return vb(t&s|~t&i,e,t,n,r,a)}function bb(e,t,s,i,n,r,a){return vb(t&i|s&~i,e,t,n,r,a)}function xb(e,t,s,i,n,r,a){return vb(t^s^i,e,t,n,r,a)}function wb(e,t,s,i,n,r,a){return vb(s^(t|~i),e,t,n,r,a)}function Sb(e){var t,s=e.length,i=[1732584193,-271733879,-1732584194,271733878];for(t=64;t<=e.length;t+=64)gb(i,kb(e.substring(t-64,t)));e=e.substring(t-64);var n=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<e.length;t++)n[t>>2]|=e.charCodeAt(t)<<(t%4<<3);if(n[t>>2]|=128<<(t%4<<3),t>55)for(gb(i,n),t=0;t<16;t++)n[t]=0;return n[14]=8*s,gb(i,n),i}function kb(e){var t,s=[];for(t=0;t<64;t+=4)s[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return s}hb=ab.atob.bind(ab),fb=ab.btoa.bind(ab);var _b="0123456789abcdef".split("");function Cb(e){for(var t="",s=0;s<4;s++)t+=_b[e>>8*s+4&15]+_b[e>>8*s&15];return t}function Nb(e){return String.fromCharCode(255&e,(65280&e)>>8,(16711680&e)>>16,(4278190080&e)>>24)}function Tb(e){return Sb(e).map(Nb).join("")}var Ab="5d41402abc4b2a76b9719d911017c592"!=function(e){for(var t=0;t<e.length;t++)e[t]=Cb(e[t]);return e.join("")}(Sb("hello"));function Eb(e,t){if(Ab){var s=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(s>>16)<<16|65535&s}return e+t&4294967295}
/**
 * @license
 * FPDF is released under a permissive license: there is no usage restriction.
 * You may embed it freely in your application (commercial or not), with or
 * without modifications.
 *
 * Reference: http://www.fpdf.org/en/script/script37.php
 */function jb(e,t){var s,i,n,r;if(e!==s){for(var a=(n=e,r=1+(256/e.length|0),new Array(r+1).join(n)),o=[],l=0;l<256;l++)o[l]=l;var c=0;for(l=0;l<256;l++){var d=o[l];c=(c+d+a.charCodeAt(l))%256,o[l]=o[c],o[c]=d}s=e,i=o}else o=i;var u=t.length,h=0,f=0,m="";for(l=0;l<u;l++)f=(f+(d=o[h=(h+1)%256]))%256,o[h]=o[f],o[f]=d,a=o[(o[h]+o[f])%256],m+=String.fromCharCode(t.charCodeAt(l)^a);return m}
/**
 * @license
 * Licensed under the MIT License.
 * http://opensource.org/licenses/mit-license
 * Author: Owen Leong (@owenl131)
 * Date: 15 Oct 2020
 * References:
 * https://www.cs.cmu.edu/~dst/Adobe/Gallery/anon21jul01-pdf-encryption.txt
 * https://github.com/foliojs/pdfkit/blob/master/lib/security.js
 * http://www.fpdf.org/en/script/script37.php
 */var Pb={print:4,modify:8,copy:16,"annot-forms":32};function Ib(e,t,s,i){this.v=1,this.r=2;var n=192;e.forEach(function(e){if(void 0!==Pb.perm)throw new Error("Invalid permission: "+e);n+=Pb[e]}),this.padding="(¿N^NuAd\0NVÿú\b..\0¶Ðh>/\f©þdSiz";var r=(t+this.padding).substr(0,32),a=(s+this.padding).substr(0,32);this.O=this.processOwnerPassword(r,a),this.P=-(1+(255^n)),this.encryptionKey=Tb(r+this.O+this.lsbFirstWord(this.P)+this.hexToBytes(i)).substr(0,5),this.U=jb(this.encryptionKey,this.padding)}function Lb(e){if(/[^\u0000-\u00ff]/.test(e))throw new Error("Invalid PDF Name Object: "+e+", Only accept ASCII characters.");for(var t="",s=e.length,i=0;i<s;i++){var n=e.charCodeAt(i);t+=n<33||35===n||37===n||40===n||41===n||47===n||60===n||62===n||91===n||93===n||123===n||125===n||n>126?"#"+("0"+n.toString(16)).slice(-2):e[i]}return t}function Rb(e){if("object"!==fy(e))throw new Error("Invalid Context passed to initialize PubSub (jsPDF-module)");var t={};this.subscribe=function(e,s,i){if(i=i||!1,"string"!=typeof e||"function"!=typeof s||"boolean"!=typeof i)throw new Error("Invalid arguments passed to PubSub.subscribe (jsPDF-module)");t.hasOwnProperty(e)||(t[e]={});var n=Math.random().toString(35);return t[e][n]=[s,!!i],n},this.unsubscribe=function(e){for(var s in t)if(t[s][e])return delete t[s][e],0===Object.keys(t[s]).length&&delete t[s],!0;return!1},this.publish=function(s){if(t.hasOwnProperty(s)){var i=Array.prototype.slice.call(arguments,1),n=[];for(var r in t[s]){var a=t[s][r];try{a[0].apply(e,i)}catch(o){ab.console&&lb.error("jsPDF PubSub Error",o.message,o)}a[1]&&n.push(r)}n.length&&n.forEach(this.unsubscribe)}},this.getTopics=function(){return t}}function Ob(e){if(!(this instanceof Ob))return new Ob(e);var t="opacity,stroke-opacity".split(",");for(var s in e)e.hasOwnProperty(s)&&t.indexOf(s)>=0&&(this[s]=e[s]);this.id="",this.objectNumber=-1}function Db(e,t){this.gState=e,this.matrix=t,this.id="",this.objectNumber=-1}function Mb(e,t,s,i,n){if(!(this instanceof Mb))return new Mb(e,t,s,i,n);this.type="axial"===e?2:3,this.coords=t,this.colors=s,Db.call(this,i,n)}function Ub(e,t,s,i,n){if(!(this instanceof Ub))return new Ub(e,t,s,i,n);this.boundingBox=e,this.xStep=t,this.yStep=s,this.stream="",this.cloneIndex=0,Db.call(this,i,n)}function Fb(e){var t,s="string"==typeof arguments[0]?arguments[0]:"p",i=arguments[1],n=arguments[2],r=arguments[3],a=[],o=1,l=16,c="S",d=null;"object"===fy(e=e||{})&&(s=e.orientation,i=e.unit||i,n=e.format||n,r=e.compress||e.compressPdf||r,null!==(d=e.encryption||null)&&(d.userPassword=d.userPassword||"",d.ownerPassword=d.ownerPassword||"",d.userPermissions=d.userPermissions||[]),o="number"==typeof e.userUnit?Math.abs(e.userUnit):1,void 0!==e.precision&&(t=e.precision),void 0!==e.floatPrecision&&(l=e.floatPrecision),c=e.defaultPathOperation||"S"),a=e.filters||(!0===r?["FlateEncode"]:a),i=i||"mm",s=(""+(s||"P")).toLowerCase();var u=e.putOnlyUsedFonts||!1,h={},f={internal:{},__private__:{}};f.__private__.PubSub=Rb;var m="1.3",p=f.__private__.getPdfVersion=function(){return m};f.__private__.setPdfVersion=function(e){m=e};var g={a0:[2383.94,3370.39],a1:[1683.78,2383.94],a2:[1190.55,1683.78],a3:[841.89,1190.55],a4:[595.28,841.89],a5:[419.53,595.28],a6:[297.64,419.53],a7:[209.76,297.64],a8:[147.4,209.76],a9:[104.88,147.4],a10:[73.7,104.88],b0:[2834.65,4008.19],b1:[2004.09,2834.65],b2:[1417.32,2004.09],b3:[1000.63,1417.32],b4:[708.66,1000.63],b5:[498.9,708.66],b6:[354.33,498.9],b7:[249.45,354.33],b8:[175.75,249.45],b9:[124.72,175.75],b10:[87.87,124.72],c0:[2599.37,3676.54],c1:[1836.85,2599.37],c2:[1298.27,1836.85],c3:[918.43,1298.27],c4:[649.13,918.43],c5:[459.21,649.13],c6:[323.15,459.21],c7:[229.61,323.15],c8:[161.57,229.61],c9:[113.39,161.57],c10:[79.37,113.39],dl:[311.81,623.62],letter:[612,792],"government-letter":[576,756],legal:[612,1008],"junior-legal":[576,360],ledger:[1224,792],tabloid:[792,1224],"credit-card":[153,243]};f.__private__.getPageFormats=function(){return g};var v=f.__private__.getPageFormat=function(e){return g[e]};n=n||"a4";var y="compat",b="advanced",x=y;function w(){this.saveGraphicsState(),X(new Pe(he,0,0,-he,0,cs()*he).toString()+" cm"),this.setFontSize(this.getFontSize()/he),c="n",x=b}function S(){this.restoreGraphicsState(),c="S",x=y}var k=f.__private__.combineFontStyleAndFontWeight=function(e,t){if("bold"==e&&"normal"==t||"bold"==e&&400==t||"normal"==e&&"italic"==t||"bold"==e&&"italic"==t)throw new Error("Invalid Combination of fontweight and fontstyle");return t&&(e=400==t||"normal"===t?"italic"===e?"italic":"normal":700!=t&&"bold"!==t||"normal"!==e?(700==t?"bold":t)+""+e:"bold"),e};f.advancedAPI=function(e){var t=x===y;return t&&w.call(this),"function"!=typeof e||(e(this),t&&S.call(this)),this},f.compatAPI=function(e){var t=x===b;return t&&S.call(this),"function"!=typeof e||(e(this),t&&w.call(this)),this},f.isAdvancedAPI=function(){return x===b};var _,C=function(e){if(x!==b)throw new Error(e+" is only available in 'advanced' API mode. You need to call advancedAPI() first.")},N=f.roundToPrecision=f.__private__.roundToPrecision=function(e,s){var i=t||s;if(isNaN(e)||isNaN(i))throw new Error("Invalid argument passed to jsPDF.roundToPrecision");return e.toFixed(i).replace(/0+$/,"")};_=f.hpf=f.__private__.hpf="number"==typeof l?function(e){if(isNaN(e))throw new Error("Invalid argument passed to jsPDF.hpf");return N(e,l)}:"smart"===l?function(e){if(isNaN(e))throw new Error("Invalid argument passed to jsPDF.hpf");return N(e,e>-1&&e<1?16:5)}:function(e){if(isNaN(e))throw new Error("Invalid argument passed to jsPDF.hpf");return N(e,16)};var T=f.f2=f.__private__.f2=function(e){if(isNaN(e))throw new Error("Invalid argument passed to jsPDF.f2");return N(e,2)},A=f.__private__.f3=function(e){if(isNaN(e))throw new Error("Invalid argument passed to jsPDF.f3");return N(e,3)},E=f.scale=f.__private__.scale=function(e){if(isNaN(e))throw new Error("Invalid argument passed to jsPDF.scale");return x===y?e*he:x===b?e:void 0},j=function(e){return E(function(e){return x===y?cs()-e:x===b?e:void 0}(e))};f.__private__.setPrecision=f.setPrecision=function(e){"number"==typeof parseInt(e,10)&&(t=parseInt(e,10))};var P,I="00000000000000000000000000000000",L=f.__private__.getFileId=function(){return I},R=f.__private__.setFileId=function(e){return I=void 0!==e&&/^[a-fA-F0-9]{32}$/.test(e)?e.toUpperCase():I.split("").map(function(){return"ABCDEF0123456789".charAt(Math.floor(16*Math.random()))}).join(""),null!==d&&(bt=new Ib(d.userPermissions,d.userPassword,d.ownerPassword,I)),I};f.setFileId=function(e){return R(e),this},f.getFileId=function(){return L()};var O=f.__private__.convertDateToPDFDate=function(e){var t=e.getTimezoneOffset(),s=t<0?"+":"-",i=Math.floor(Math.abs(t/60)),n=Math.abs(t%60),r=[s,B(i),"'",B(n),"'"].join("");return["D:",e.getFullYear(),B(e.getMonth()+1),B(e.getDate()),B(e.getHours()),B(e.getMinutes()),B(e.getSeconds()),r].join("")},D=f.__private__.convertPDFDateToDate=function(e){var t=parseInt(e.substr(2,4),10),s=parseInt(e.substr(6,2),10)-1,i=parseInt(e.substr(8,2),10),n=parseInt(e.substr(10,2),10),r=parseInt(e.substr(12,2),10),a=parseInt(e.substr(14,2),10);return new Date(t,s,i,n,r,a,0)},M=f.__private__.setCreationDate=function(e){var t;if(void 0===e&&(e=new Date),e instanceof Date)t=O(e);else{if(!/^D:(20[0-2][0-9]|203[0-7]|19[7-9][0-9])(0[0-9]|1[0-2])([0-2][0-9]|3[0-1])(0[0-9]|1[0-9]|2[0-3])(0[0-9]|[1-5][0-9])(0[0-9]|[1-5][0-9])(\+0[0-9]|\+1[0-4]|-0[0-9]|-1[0-1])'(0[0-9]|[1-5][0-9])'?$/.test(e))throw new Error("Invalid argument passed to jsPDF.setCreationDate");t=e}return P=t},U=f.__private__.getCreationDate=function(e){var t=P;return"jsDate"===e&&(t=D(P)),t};f.setCreationDate=function(e){return M(e),this},f.getCreationDate=function(e){return U(e)};var F,B=f.__private__.padd2=function(e){return("0"+parseInt(e)).slice(-2)},q=f.__private__.padd2Hex=function(e){return("00"+(e=e.toString())).substr(e.length)},$=0,z=[],H=[],V=0,G=[],J=[],W=!1,K=H;f.__private__.setCustomOutputDestination=function(e){W=!0,K=e};var Y=function(e){W||(K=e)};f.__private__.resetCustomOutputDestination=function(){W=!1,K=H};var X=f.__private__.out=function(e){return e=e.toString(),V+=e.length+1,K.push(e),K},Q=f.__private__.write=function(e){return X(1===arguments.length?e.toString():Array.prototype.join.call(arguments," "))},Z=f.__private__.getArrayBuffer=function(e){for(var t=e.length,s=new ArrayBuffer(t),i=new Uint8Array(s);t--;)i[t]=e.charCodeAt(t);return s},ee=[["Helvetica","helvetica","normal","WinAnsiEncoding"],["Helvetica-Bold","helvetica","bold","WinAnsiEncoding"],["Helvetica-Oblique","helvetica","italic","WinAnsiEncoding"],["Helvetica-BoldOblique","helvetica","bolditalic","WinAnsiEncoding"],["Courier","courier","normal","WinAnsiEncoding"],["Courier-Bold","courier","bold","WinAnsiEncoding"],["Courier-Oblique","courier","italic","WinAnsiEncoding"],["Courier-BoldOblique","courier","bolditalic","WinAnsiEncoding"],["Times-Roman","times","normal","WinAnsiEncoding"],["Times-Bold","times","bold","WinAnsiEncoding"],["Times-Italic","times","italic","WinAnsiEncoding"],["Times-BoldItalic","times","bolditalic","WinAnsiEncoding"],["ZapfDingbats","zapfdingbats","normal",null],["Symbol","symbol","normal",null]];f.__private__.getStandardFonts=function(){return ee};var te=e.fontSize||16;f.__private__.setFontSize=f.setFontSize=function(e){return te=x===b?e/he:e,this};var se,ie=f.__private__.getFontSize=f.getFontSize=function(){return x===y?te:te*he},ne=e.R2L||!1;f.__private__.setR2L=f.setR2L=function(e){return ne=e,this},f.__private__.getR2L=f.getR2L=function(){return ne};var re,ae=f.__private__.setZoomMode=function(e){if(/^(?:\d+\.\d*|\d*\.\d+|\d+)%$/.test(e))se=e;else if(isNaN(e)){if(-1===[void 0,null,"fullwidth","fullheight","fullpage","original"].indexOf(e))throw new Error('zoom must be Integer (e.g. 2), a percentage Value (e.g. 300%) or fullwidth, fullheight, fullpage, original. "'+e+'" is not recognized.');se=e}else se=parseInt(e,10)};f.__private__.getZoomMode=function(){return se};var oe,le=f.__private__.setPageMode=function(e){if(-1==[void 0,null,"UseNone","UseOutlines","UseThumbs","FullScreen"].indexOf(e))throw new Error('Page mode must be one of UseNone, UseOutlines, UseThumbs, or FullScreen. "'+e+'" is not recognized.');re=e};f.__private__.getPageMode=function(){return re};var ce=f.__private__.setLayoutMode=function(e){if(-1==[void 0,null,"continuous","single","twoleft","tworight","two"].indexOf(e))throw new Error('Layout mode must be one of continuous, single, twoleft, tworight. "'+e+'" is not recognized.');oe=e};f.__private__.getLayoutMode=function(){return oe},f.__private__.setDisplayMode=f.setDisplayMode=function(e,t,s){return ae(e),ce(t),le(s),this};var de={title:"",subject:"",author:"",keywords:"",creator:""};f.__private__.getDocumentProperty=function(e){if(-1===Object.keys(de).indexOf(e))throw new Error("Invalid argument passed to jsPDF.getDocumentProperty");return de[e]},f.__private__.getDocumentProperties=function(){return de},f.__private__.setDocumentProperties=f.setProperties=f.setDocumentProperties=function(e){for(var t in de)de.hasOwnProperty(t)&&e[t]&&(de[t]=e[t]);return this},f.__private__.setDocumentProperty=function(e,t){if(-1===Object.keys(de).indexOf(e))throw new Error("Invalid arguments passed to jsPDF.setDocumentProperty");return de[e]=t};var ue,he,fe,me,pe,ge={},ve={},ye=[],be={},xe={},we={},Se={},ke=null,_e=0,Ce=[],Ne=new Rb(f),Te=e.hotfixes||[],Ae={},Ee={},je=[],Pe=function e(t,s,i,n,r,a){if(!(this instanceof e))return new e(t,s,i,n,r,a);isNaN(t)&&(t=1),isNaN(s)&&(s=0),isNaN(i)&&(i=0),isNaN(n)&&(n=1),isNaN(r)&&(r=0),isNaN(a)&&(a=0),this._matrix=[t,s,i,n,r,a]};Object.defineProperty(Pe.prototype,"sx",{get:function(){return this._matrix[0]},set:function(e){this._matrix[0]=e}}),Object.defineProperty(Pe.prototype,"shy",{get:function(){return this._matrix[1]},set:function(e){this._matrix[1]=e}}),Object.defineProperty(Pe.prototype,"shx",{get:function(){return this._matrix[2]},set:function(e){this._matrix[2]=e}}),Object.defineProperty(Pe.prototype,"sy",{get:function(){return this._matrix[3]},set:function(e){this._matrix[3]=e}}),Object.defineProperty(Pe.prototype,"tx",{get:function(){return this._matrix[4]},set:function(e){this._matrix[4]=e}}),Object.defineProperty(Pe.prototype,"ty",{get:function(){return this._matrix[5]},set:function(e){this._matrix[5]=e}}),Object.defineProperty(Pe.prototype,"a",{get:function(){return this._matrix[0]},set:function(e){this._matrix[0]=e}}),Object.defineProperty(Pe.prototype,"b",{get:function(){return this._matrix[1]},set:function(e){this._matrix[1]=e}}),Object.defineProperty(Pe.prototype,"c",{get:function(){return this._matrix[2]},set:function(e){this._matrix[2]=e}}),Object.defineProperty(Pe.prototype,"d",{get:function(){return this._matrix[3]},set:function(e){this._matrix[3]=e}}),Object.defineProperty(Pe.prototype,"e",{get:function(){return this._matrix[4]},set:function(e){this._matrix[4]=e}}),Object.defineProperty(Pe.prototype,"f",{get:function(){return this._matrix[5]},set:function(e){this._matrix[5]=e}}),Object.defineProperty(Pe.prototype,"rotation",{get:function(){return Math.atan2(this.shx,this.sx)}}),Object.defineProperty(Pe.prototype,"scaleX",{get:function(){return this.decompose().scale.sx}}),Object.defineProperty(Pe.prototype,"scaleY",{get:function(){return this.decompose().scale.sy}}),Object.defineProperty(Pe.prototype,"isIdentity",{get:function(){return 1===this.sx&&0===this.shy&&0===this.shx&&1===this.sy&&0===this.tx&&0===this.ty}}),Pe.prototype.join=function(e){return[this.sx,this.shy,this.shx,this.sy,this.tx,this.ty].map(_).join(e)},Pe.prototype.multiply=function(e){var t=e.sx*this.sx+e.shy*this.shx,s=e.sx*this.shy+e.shy*this.sy,i=e.shx*this.sx+e.sy*this.shx,n=e.shx*this.shy+e.sy*this.sy,r=e.tx*this.sx+e.ty*this.shx+this.tx,a=e.tx*this.shy+e.ty*this.sy+this.ty;return new Pe(t,s,i,n,r,a)},Pe.prototype.decompose=function(){var e=this.sx,t=this.shy,s=this.shx,i=this.sy,n=this.tx,r=this.ty,a=Math.sqrt(e*e+t*t),o=(e/=a)*s+(t/=a)*i;s-=e*o,i-=t*o;var l=Math.sqrt(s*s+i*i);return o/=l,e*(i/=l)<t*(s/=l)&&(e=-e,t=-t,o=-o,a=-a),{scale:new Pe(a,0,0,l,0,0),translate:new Pe(1,0,0,1,n,r),rotate:new Pe(e,t,-t,e,0,0),skew:new Pe(1,0,o,1,0,0)}},Pe.prototype.toString=function(e){return this.join(" ")},Pe.prototype.inversed=function(){var e=this.sx,t=this.shy,s=this.shx,i=this.sy,n=this.tx,r=this.ty,a=1/(e*i-t*s),o=i*a,l=-t*a,c=-s*a,d=e*a;return new Pe(o,l,c,d,-o*n-c*r,-l*n-d*r)},Pe.prototype.applyToPoint=function(e){var t=e.x*this.sx+e.y*this.shx+this.tx,s=e.x*this.shy+e.y*this.sy+this.ty;return new ss(t,s)},Pe.prototype.applyToRectangle=function(e){var t=this.applyToPoint(e),s=this.applyToPoint(new ss(e.x+e.w,e.y+e.h));return new is(t.x,t.y,s.x-t.x,s.y-t.y)},Pe.prototype.clone=function(){var e=this.sx,t=this.shy,s=this.shx,i=this.sy,n=this.tx,r=this.ty;return new Pe(e,t,s,i,n,r)},f.Matrix=Pe;var Ie=f.matrixMult=function(e,t){return t.multiply(e)},Le=new Pe(1,0,0,1,0,0);f.unitMatrix=f.identityMatrix=Le;var Re=function(e,t){if(!xe[e]){var s=(t instanceof Mb?"Sh":"P")+(Object.keys(be).length+1).toString(10);t.id=s,xe[e]=s,be[s]=t,Ne.publish("addPattern",t)}};f.ShadingPattern=Mb,f.TilingPattern=Ub,f.addShadingPattern=function(e,t){return C("addShadingPattern()"),Re(e,t),this},f.beginTilingPattern=function(e){C("beginTilingPattern()"),rs(e.boundingBox[0],e.boundingBox[1],e.boundingBox[2]-e.boundingBox[0],e.boundingBox[3]-e.boundingBox[1],e.matrix)},f.endTilingPattern=function(e,t){C("endTilingPattern()"),t.stream=J[F].join("\n"),Re(e,t),Ne.publish("endTilingPattern",t),je.pop().restore()};var Oe,De=f.__private__.newObject=function(){var e=Me();return Ue(e,!0),e},Me=f.__private__.newObjectDeferred=function(){return $++,z[$]=function(){return V},$},Ue=function(e,t){return t="boolean"==typeof t&&t,z[e]=V,t&&X(e+" 0 obj"),e},Fe=f.__private__.newAdditionalObject=function(){var e={objId:Me(),content:""};return G.push(e),e},Be=Me(),qe=Me(),$e=f.__private__.decodeColorString=function(e){var t=e.split(" ");if(2!==t.length||"g"!==t[1]&&"G"!==t[1])5!==t.length||"k"!==t[4]&&"K"!==t[4]||(t=[(1-t[0])*(1-t[3]),(1-t[1])*(1-t[3]),(1-t[2])*(1-t[3]),"r"]);else{var s=parseFloat(t[0]);t=[s,s,s,"r"]}for(var i="#",n=0;n<3;n++)i+=("0"+Math.floor(255*parseFloat(t[n])).toString(16)).slice(-2);return i},ze=f.__private__.encodeColorString=function(e){var t;"string"==typeof e&&(e={ch1:e});var s=e.ch1,i=e.ch2,n=e.ch3,r=e.ch4,a="draw"===e.pdfColorType?["G","RG","K"]:["g","rg","k"];if("string"==typeof s&&"#"!==s.charAt(0)){var o=new pb(s);if(o.ok)s=o.toHex();else if(!/^\d*\.?\d*$/.test(s))throw new Error('Invalid color "'+s+'" passed to jsPDF.encodeColorString.')}if("string"==typeof s&&/^#[0-9A-Fa-f]{3}$/.test(s)&&(s="#"+s[1]+s[1]+s[2]+s[2]+s[3]+s[3]),"string"==typeof s&&/^#[0-9A-Fa-f]{6}$/.test(s)){var l=parseInt(s.substr(1),16);s=l>>16&255,i=l>>8&255,n=255&l}if(void 0===i||void 0===r&&s===i&&i===n)if("string"==typeof s)t=s+" "+a[0];else if(2===e.precision)t=T(s/255)+" "+a[0];else t=A(s/255)+" "+a[0];else if(void 0===r||"object"===fy(r)){if(r&&!isNaN(r.a)&&0===r.a)return["1.","1.","1.",a[1]].join(" ");if("string"==typeof s)t=[s,i,n,a[1]].join(" ");else if(2===e.precision)t=[T(s/255),T(i/255),T(n/255),a[1]].join(" ");else t=[A(s/255),A(i/255),A(n/255),a[1]].join(" ")}else if("string"==typeof s)t=[s,i,n,r,a[2]].join(" ");else if(2===e.precision)t=[T(s),T(i),T(n),T(r),a[2]].join(" ");else t=[A(s),A(i),A(n),A(r),a[2]].join(" ");return t},He=f.__private__.getFilters=function(){return a},Ve=f.__private__.putStream=function(e){var t=(e=e||{}).data||"",s=e.filters||He(),i=e.alreadyAppliedFilters||[],n=e.addLength1||!1,r=t.length,a=e.objectId,o=function(e){return e};if(null!==d&&void 0===a)throw new Error("ObjectId must be passed to putStream for file encryption");null!==d&&(o=bt.encryptor(a,0));var l={};!0===s&&(s=["FlateEncode"]);var c=e.additionalKeyValues||[],u=(l=void 0!==Fb.API.processDataByFilters?Fb.API.processDataByFilters(t,s):{data:t,reverseChain:[]}).reverseChain+(Array.isArray(i)?i.join(" "):i.toString());if(0!==l.data.length&&(c.push({key:"Length",value:l.data.length}),!0===n&&c.push({key:"Length1",value:r})),0!=u.length)if(u.split("/").length-1==1)c.push({key:"Filter",value:u});else{c.push({key:"Filter",value:"["+u+"]"});for(var h=0;h<c.length;h+=1)if("DecodeParms"===c[h].key){for(var f=[],m=0;m<l.reverseChain.split("/").length-1;m+=1)f.push("null");f.push(c[h].value),c[h].value="["+f.join(" ")+"]"}}X("<<");for(var p=0;p<c.length;p++)X("/"+c[p].key+" "+c[p].value);X(">>"),0!==l.data.length&&(X("stream"),X(o(l.data)),X("endstream"))},Ge=f.__private__.putPage=function(e){var t=e.number,s=e.data,i=e.objId,n=e.contentsObjId;Ue(i,!0),X("<</Type /Page"),X("/Parent "+e.rootDictionaryObjId+" 0 R"),X("/Resources "+e.resourceDictionaryObjId+" 0 R"),X("/MediaBox ["+parseFloat(_(e.mediaBox.bottomLeftX))+" "+parseFloat(_(e.mediaBox.bottomLeftY))+" "+_(e.mediaBox.topRightX)+" "+_(e.mediaBox.topRightY)+"]"),null!==e.cropBox&&X("/CropBox ["+_(e.cropBox.bottomLeftX)+" "+_(e.cropBox.bottomLeftY)+" "+_(e.cropBox.topRightX)+" "+_(e.cropBox.topRightY)+"]"),null!==e.bleedBox&&X("/BleedBox ["+_(e.bleedBox.bottomLeftX)+" "+_(e.bleedBox.bottomLeftY)+" "+_(e.bleedBox.topRightX)+" "+_(e.bleedBox.topRightY)+"]"),null!==e.trimBox&&X("/TrimBox ["+_(e.trimBox.bottomLeftX)+" "+_(e.trimBox.bottomLeftY)+" "+_(e.trimBox.topRightX)+" "+_(e.trimBox.topRightY)+"]"),null!==e.artBox&&X("/ArtBox ["+_(e.artBox.bottomLeftX)+" "+_(e.artBox.bottomLeftY)+" "+_(e.artBox.topRightX)+" "+_(e.artBox.topRightY)+"]"),"number"==typeof e.userUnit&&1!==e.userUnit&&X("/UserUnit "+e.userUnit),Ne.publish("putPage",{objId:i,pageContext:Ce[t],pageNumber:t,page:s}),X("/Contents "+n+" 0 R"),X(">>"),X("endobj");var r=s.join("\n");return x===b&&(r+="\nQ"),Ue(n,!0),Ve({data:r,filters:He(),objectId:n}),X("endobj"),i},Je=f.__private__.putPages=function(){var e,t,s=[];for(e=1;e<=_e;e++)Ce[e].objId=Me(),Ce[e].contentsObjId=Me();for(e=1;e<=_e;e++)s.push(Ge({number:e,data:J[e],objId:Ce[e].objId,contentsObjId:Ce[e].contentsObjId,mediaBox:Ce[e].mediaBox,cropBox:Ce[e].cropBox,bleedBox:Ce[e].bleedBox,trimBox:Ce[e].trimBox,artBox:Ce[e].artBox,userUnit:Ce[e].userUnit,rootDictionaryObjId:Be,resourceDictionaryObjId:qe}));Ue(Be,!0),X("<</Type /Pages");var i="/Kids [";for(t=0;t<_e;t++)i+=s[t]+" 0 R ";X(i+"]"),X("/Count "+_e),X(">>"),X("endobj"),Ne.publish("postPutPages")},We=function(e){Ne.publish("putFont",{font:e,out:X,newObject:De,putStream:Ve}),!0!==e.isAlreadyPutted&&(e.objectNumber=De(),X("<<"),X("/Type /Font"),X("/BaseFont /"+Lb(e.postScriptName)),X("/Subtype /Type1"),"string"==typeof e.encoding&&X("/Encoding /"+e.encoding),X("/FirstChar 32"),X("/LastChar 255"),X(">>"),X("endobj"))},Ke=function(e){e.objectNumber=De();var t=[];t.push({key:"Type",value:"/XObject"}),t.push({key:"Subtype",value:"/Form"}),t.push({key:"BBox",value:"["+[_(e.x),_(e.y),_(e.x+e.width),_(e.y+e.height)].join(" ")+"]"}),t.push({key:"Matrix",value:"["+e.matrix.toString()+"]"});var s=e.pages[1].join("\n");Ve({data:s,additionalKeyValues:t,objectId:e.objectNumber}),X("endobj")},Ye=function(e,t){t||(t=21);var s=De(),i=function(e,t){var s,i=[],n=1/(t-1);for(s=0;s<1;s+=n)i.push(s);if(i.push(1),0!=e[0].offset){var r={offset:0,color:e[0].color};e.unshift(r)}if(1!=e[e.length-1].offset){var a={offset:1,color:e[e.length-1].color};e.push(a)}for(var o="",l=0,c=0;c<i.length;c++){for(s=i[c];s>e[l+1].offset;)l++;var d=e[l].offset,u=(s-d)/(e[l+1].offset-d),h=e[l].color,f=e[l+1].color;o+=q(Math.round((1-u)*h[0]+u*f[0]).toString(16))+q(Math.round((1-u)*h[1]+u*f[1]).toString(16))+q(Math.round((1-u)*h[2]+u*f[2]).toString(16))}return o.trim()}(e.colors,t),n=[];n.push({key:"FunctionType",value:"0"}),n.push({key:"Domain",value:"[0.0 1.0]"}),n.push({key:"Size",value:"["+t+"]"}),n.push({key:"BitsPerSample",value:"8"}),n.push({key:"Range",value:"[0.0 1.0 0.0 1.0 0.0 1.0]"}),n.push({key:"Decode",value:"[0.0 1.0 0.0 1.0 0.0 1.0]"}),Ve({data:i,additionalKeyValues:n,alreadyAppliedFilters:["/ASCIIHexDecode"],objectId:s}),X("endobj"),e.objectNumber=De(),X("<< /ShadingType "+e.type),X("/ColorSpace /DeviceRGB");var r="/Coords ["+_(parseFloat(e.coords[0]))+" "+_(parseFloat(e.coords[1]))+" ";2===e.type?r+=_(parseFloat(e.coords[2]))+" "+_(parseFloat(e.coords[3])):r+=_(parseFloat(e.coords[2]))+" "+_(parseFloat(e.coords[3]))+" "+_(parseFloat(e.coords[4]))+" "+_(parseFloat(e.coords[5])),X(r+="]"),e.matrix&&X("/Matrix ["+e.matrix.toString()+"]"),X("/Function "+s+" 0 R"),X("/Extend [true true]"),X(">>"),X("endobj")},Xe=function(e,t){var s=Me(),i=De();t.push({resourcesOid:s,objectOid:i}),e.objectNumber=i;var n=[];n.push({key:"Type",value:"/Pattern"}),n.push({key:"PatternType",value:"1"}),n.push({key:"PaintType",value:"1"}),n.push({key:"TilingType",value:"1"}),n.push({key:"BBox",value:"["+e.boundingBox.map(_).join(" ")+"]"}),n.push({key:"XStep",value:_(e.xStep)}),n.push({key:"YStep",value:_(e.yStep)}),n.push({key:"Resources",value:s+" 0 R"}),e.matrix&&n.push({key:"Matrix",value:"["+e.matrix.toString()+"]"}),Ve({data:e.stream,additionalKeyValues:n,objectId:e.objectNumber}),X("endobj")},Qe=function(e){for(var t in e.objectNumber=De(),X("<<"),e)switch(t){case"opacity":X("/ca "+T(e[t]));break;case"stroke-opacity":X("/CA "+T(e[t]))}X(">>"),X("endobj")},Ze=function(e){Ue(e.resourcesOid,!0),X("<<"),X("/ProcSet [/PDF /Text /ImageB /ImageC /ImageI]"),function(){for(var e in X("/Font <<"),ge)ge.hasOwnProperty(e)&&(!1===u||!0===u&&h.hasOwnProperty(e))&&X("/"+e+" "+ge[e].objectNumber+" 0 R");X(">>")}(),function(){if(Object.keys(be).length>0){for(var e in X("/Shading <<"),be)be.hasOwnProperty(e)&&be[e]instanceof Mb&&be[e].objectNumber>=0&&X("/"+e+" "+be[e].objectNumber+" 0 R");Ne.publish("putShadingPatternDict"),X(">>")}}(),function(e){if(Object.keys(be).length>0){for(var t in X("/Pattern <<"),be)be.hasOwnProperty(t)&&be[t]instanceof f.TilingPattern&&be[t].objectNumber>=0&&be[t].objectNumber<e&&X("/"+t+" "+be[t].objectNumber+" 0 R");Ne.publish("putTilingPatternDict"),X(">>")}}(e.objectOid),function(){if(Object.keys(we).length>0){var e;for(e in X("/ExtGState <<"),we)we.hasOwnProperty(e)&&we[e].objectNumber>=0&&X("/"+e+" "+we[e].objectNumber+" 0 R");Ne.publish("putGStateDict"),X(">>")}}(),function(){for(var e in X("/XObject <<"),Ae)Ae.hasOwnProperty(e)&&Ae[e].objectNumber>=0&&X("/"+e+" "+Ae[e].objectNumber+" 0 R");Ne.publish("putXobjectDict"),X(">>")}(),X(">>"),X("endobj")},et=function(){var e=[];(function(){for(var e in ge)ge.hasOwnProperty(e)&&(!1===u||!0===u&&h.hasOwnProperty(e))&&We(ge[e])})(),function(){var e;for(e in we)we.hasOwnProperty(e)&&Qe(we[e])}(),function(){for(var e in Ae)Ae.hasOwnProperty(e)&&Ke(Ae[e])}(),function(e){var t;for(t in be)be.hasOwnProperty(t)&&(be[t]instanceof Mb?Ye(be[t]):be[t]instanceof Ub&&Xe(be[t],e))}(e),Ne.publish("putResources"),e.forEach(Ze),Ze({resourcesOid:qe,objectOid:Number.MAX_SAFE_INTEGER}),Ne.publish("postPutResources")},tt=function(e){ve[e.fontName]=ve[e.fontName]||{},ve[e.fontName][e.fontStyle]=e.id},st=function(e,t,s,i,n){var r={id:"F"+(Object.keys(ge).length+1).toString(10),postScriptName:e,fontName:t,fontStyle:s,encoding:i,isStandardFont:n||!1,metadata:{}};return Ne.publish("addFont",{font:r,instance:this}),ge[r.id]=r,tt(r),r.id},it=f.__private__.pdfEscape=f.pdfEscape=function(e,t){return function(e,t){var s,i,n,r,a,o,l,c,d;if(n=(t=t||{}).sourceEncoding||"Unicode",a=t.outputEncoding,(t.autoencode||a)&&ge[ue].metadata&&ge[ue].metadata[n]&&ge[ue].metadata[n].encoding&&(r=ge[ue].metadata[n].encoding,!a&&ge[ue].encoding&&(a=ge[ue].encoding),!a&&r.codePages&&(a=r.codePages[0]),"string"==typeof a&&(a=r[a]),a)){for(l=!1,o=[],s=0,i=e.length;s<i;s++)(c=a[e.charCodeAt(s)])?o.push(String.fromCharCode(c)):o.push(e[s]),o[s].charCodeAt(0)>>8&&(l=!0);e=o.join("")}for(s=e.length;void 0===l&&0!==s;)e.charCodeAt(s-1)>>8&&(l=!0),s--;if(!l)return e;for(o=t.noBOM?[]:[254,255],s=0,i=e.length;s<i;s++){if((d=(c=e.charCodeAt(s))>>8)>>8)throw new Error("Character at position "+s+" of string '"+e+"' exceeds 16bits. Cannot be encoded into UCS-2 BE");o.push(d),o.push(c-(d<<8))}return String.fromCharCode.apply(void 0,o)}(e,t).replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)")},nt=f.__private__.beginPage=function(e){J[++_e]=[],Ce[_e]={objId:0,contentsObjId:0,userUnit:Number(o),artBox:null,bleedBox:null,cropBox:null,trimBox:null,mediaBox:{bottomLeftX:0,bottomLeftY:0,topRightX:Number(e[0]),topRightY:Number(e[1])}},ot(_e),Y(J[F])},rt=function(e,t){var i,r,a;switch(s=t||s,"string"==typeof e&&(i=v(e.toLowerCase()),Array.isArray(i)&&(r=i[0],a=i[1])),Array.isArray(e)&&(r=e[0]*he,a=e[1]*he),isNaN(r)&&(r=n[0],a=n[1]),(r>14400||a>14400)&&(lb.warn("A page in a PDF can not be wider or taller than 14400 userUnit. jsPDF limits the width/height to 14400"),r=Math.min(14400,r),a=Math.min(14400,a)),n=[r,a],s.substr(0,1)){case"l":a>r&&(n=[a,r]);break;case"p":r>a&&(n=[a,r])}nt(n),Ft(Mt),X(Jt),0!==Zt&&X(Zt+" J"),0!==es&&X(es+" j"),Ne.publish("addPage",{pageNumber:_e})},at=function(e){e>0&&e<=_e&&(J.splice(e,1),Ce.splice(e,1),_e--,F>_e&&(F=_e),this.setPage(F))},ot=function(e){e>0&&e<=_e&&(F=e)},lt=f.__private__.getNumberOfPages=f.getNumberOfPages=function(){return J.length-1},ct=function(e,t,s){var i,n=void 0;return s=s||{},e=void 0!==e?e:ge[ue].fontName,t=void 0!==t?t:ge[ue].fontStyle,i=e.toLowerCase(),void 0!==ve[i]&&void 0!==ve[i][t]?n=ve[i][t]:void 0!==ve[e]&&void 0!==ve[e][t]?n=ve[e][t]:!1===s.disableWarning&&lb.warn("Unable to look up font label for font '"+e+"', '"+t+"'. Refer to getFontList() for available fonts."),n||s.noFallback||null==(n=ve.times[t])&&(n=ve.times.normal),n},dt=f.__private__.putInfo=function(){var e=De(),t=function(e){return e};for(var s in null!==d&&(t=bt.encryptor(e,0)),X("<<"),X("/Producer ("+it(t("jsPDF "+Fb.version))+")"),de)de.hasOwnProperty(s)&&de[s]&&X("/"+s.substr(0,1).toUpperCase()+s.substr(1)+" ("+it(t(de[s]))+")");X("/CreationDate ("+it(t(P))+")"),X(">>"),X("endobj")},ut=f.__private__.putCatalog=function(e){var t=(e=e||{}).rootDictionaryObjId||Be;switch(De(),X("<<"),X("/Type /Catalog"),X("/Pages "+t+" 0 R"),se||(se="fullwidth"),se){case"fullwidth":X("/OpenAction [3 0 R /FitH null]");break;case"fullheight":X("/OpenAction [3 0 R /FitV null]");break;case"fullpage":X("/OpenAction [3 0 R /Fit]");break;case"original":X("/OpenAction [3 0 R /XYZ null null 1]");break;default:var s=""+se;"%"===s.substr(s.length-1)&&(se=parseInt(se)/100),"number"==typeof se&&X("/OpenAction [3 0 R /XYZ null null "+T(se)+"]")}switch(oe||(oe="continuous"),oe){case"continuous":X("/PageLayout /OneColumn");break;case"single":X("/PageLayout /SinglePage");break;case"two":case"twoleft":X("/PageLayout /TwoColumnLeft");break;case"tworight":X("/PageLayout /TwoColumnRight")}re&&X("/PageMode /"+re),Ne.publish("putCatalog"),X(">>"),X("endobj")},ht=f.__private__.putTrailer=function(){X("trailer"),X("<<"),X("/Size "+($+1)),X("/Root "+$+" 0 R"),X("/Info "+($-1)+" 0 R"),null!==d&&X("/Encrypt "+bt.oid+" 0 R"),X("/ID [ <"+I+"> <"+I+"> ]"),X(">>")},ft=f.__private__.putHeader=function(){X("%PDF-"+m),X("%ºß¬à")},mt=f.__private__.putXRef=function(){var e="0000000000";X("xref"),X("0 "+($+1)),X("0000000000 65535 f ");for(var t=1;t<=$;t++)"function"==typeof z[t]?X((e+z[t]()).slice(-10)+" 00000 n "):void 0!==z[t]?X((e+z[t]).slice(-10)+" 00000 n "):X("0000000000 00000 n ")},pt=f.__private__.buildDocument=function(){$=0,V=0,H=[],z=[],G=[],Be=Me(),qe=Me(),Y(H),Ne.publish("buildDocument"),ft(),Je(),function(){Ne.publish("putAdditionalObjects");for(var e=0;e<G.length;e++){var t=G[e];Ue(t.objId,!0),X(t.content),X("endobj")}Ne.publish("postPutAdditionalObjects")}(),et(),null!==d&&(bt.oid=De(),X("<<"),X("/Filter /Standard"),X("/V "+bt.v),X("/R "+bt.r),X("/U <"+bt.toHexString(bt.U)+">"),X("/O <"+bt.toHexString(bt.O)+">"),X("/P "+bt.P),X(">>"),X("endobj")),dt(),ut();var e=V;return mt(),ht(),X("startxref"),X(""+e),X("%%EOF"),Y(J[F]),H.join("\n")},gt=f.__private__.getBlob=function(e){return new Blob([Z(e)],{type:"application/pdf"})},vt=f.output=f.__private__.output=((Oe=function(e,t){switch("string"==typeof(t=t||{})?t={filename:t}:t.filename=t.filename||"generated.pdf",e){case void 0:return pt();case"save":f.save(t.filename);break;case"arraybuffer":return Z(pt());case"blob":return gt(pt());case"bloburi":case"bloburl":if(void 0!==ab.URL&&"function"==typeof ab.URL.createObjectURL)return ab.URL&&ab.URL.createObjectURL(gt(pt()))||void 0;lb.warn("bloburl is not supported by your system, because URL.createObjectURL is not supported by your browser.");break;case"datauristring":case"dataurlstring":var s="",i=pt();try{s=fb(i)}catch(m){s=fb(unescape(encodeURIComponent(i)))}return"data:application/pdf;filename="+t.filename+";base64,"+s;case"pdfobjectnewwindow":if("[object Window]"===Object.prototype.toString.call(ab)){var n="https://cdnjs.cloudflare.com/ajax/libs/pdfobject/2.1.1/pdfobject.min.js",r=' integrity="sha512-4ze/a9/4jqu+tX9dfOqJYSvyYd5M6qum/3HpCLr+/Jqf0whc37VUbkpNGHR7/8pSnCFw47T1fmIpwBV7UySh3g==" crossorigin="anonymous"';t.pdfObjectUrl&&(n=t.pdfObjectUrl,r="");var a='<html><style>html, body { padding: 0; margin: 0; } iframe { width: 100%; height: 100%; border: 0;}  </style><body><script src="'+n+'"'+r+'><\/script><script >PDFObject.embed("'+this.output("dataurlstring")+'", '+JSON.stringify(t)+");<\/script></body></html>",o=ab.open();return null!==o&&o.document.write(a),o}throw new Error("The option pdfobjectnewwindow just works in a browser-environment.");case"pdfjsnewwindow":if("[object Window]"===Object.prototype.toString.call(ab)){var l='<html><style>html, body { padding: 0; margin: 0; } iframe { width: 100%; height: 100%; border: 0;}  </style><body><iframe id="pdfViewer" src="'+(t.pdfJsUrl||"examples/PDF.js/web/viewer.html")+"?file=&downloadName="+t.filename+'" width="500px" height="400px" /></body></html>',c=ab.open();if(null!==c){c.document.write(l);var d=this;c.document.documentElement.querySelector("#pdfViewer").onload=function(){c.document.title=t.filename,c.document.documentElement.querySelector("#pdfViewer").contentWindow.PDFViewerApplication.open(d.output("bloburl"))}}return c}throw new Error("The option pdfjsnewwindow just works in a browser-environment.");case"dataurlnewwindow":if("[object Window]"!==Object.prototype.toString.call(ab))throw new Error("The option dataurlnewwindow just works in a browser-environment.");var u='<html><style>html, body { padding: 0; margin: 0; } iframe { width: 100%; height: 100%; border: 0;}  </style><body><iframe src="'+this.output("datauristring",t)+'"></iframe></body></html>',h=ab.open();if(null!==h&&(h.document.write(u),h.document.title=t.filename),h||"undefined"==typeof safari)return h;break;case"datauri":case"dataurl":return ab.document.location.href=this.output("datauristring",t);default:return null}}).foo=function(){try{return Oe.apply(this,arguments)}catch(s){var e=s.stack||"";~e.indexOf(" at ")&&(e=e.split(" at ")[1]);var t="Error in function "+e.split("\n")[0].split("<")[0]+": "+s.message;if(!ab.console)throw new Error(t);ab.console.error(t,s),ab.alert&&alert(t)}},Oe.foo.bar=Oe,Oe.foo),yt=function(e){return!0===Array.isArray(Te)&&Te.indexOf(e)>-1};switch(i){case"pt":he=1;break;case"mm":he=72/25.4;break;case"cm":he=72/2.54;break;case"in":he=72;break;case"px":he=1==yt("px_scaling")?.75:96/72;break;case"pc":case"em":he=12;break;case"ex":he=6;break;default:if("number"!=typeof i)throw new Error("Invalid unit: "+i);he=i}var bt=null;M(),R();var xt=f.__private__.getPageInfo=f.getPageInfo=function(e){if(isNaN(e)||e%1!=0)throw new Error("Invalid argument passed to jsPDF.getPageInfo");return{objId:Ce[e].objId,pageNumber:e,pageContext:Ce[e]}},wt=f.__private__.getPageInfoByObjId=function(e){if(isNaN(e)||e%1!=0)throw new Error("Invalid argument passed to jsPDF.getPageInfoByObjId");for(var t in Ce)if(Ce[t].objId===e)break;return xt(t)},St=f.__private__.getCurrentPageInfo=f.getCurrentPageInfo=function(){return{objId:Ce[F].objId,pageNumber:F,pageContext:Ce[F]}};f.addPage=function(){return rt.apply(this,arguments),this},f.setPage=function(){return ot.apply(this,arguments),Y.call(this,J[F]),this},f.insertPage=function(e){return this.addPage(),this.movePage(F,e),this},f.movePage=function(e,t){var s,i;if(e>t){s=J[e],i=Ce[e];for(var n=e;n>t;n--)J[n]=J[n-1],Ce[n]=Ce[n-1];J[t]=s,Ce[t]=i,this.setPage(t)}else if(e<t){s=J[e],i=Ce[e];for(var r=e;r<t;r++)J[r]=J[r+1],Ce[r]=Ce[r+1];J[t]=s,Ce[t]=i,this.setPage(t)}return this},f.deletePage=function(){return at.apply(this,arguments),this},f.__private__.text=f.text=function(e,t,s,i,n){var r,a,o,l,c,d,u,f,m,p=(i=i||{}).scope||this;if("number"==typeof e&&"number"==typeof t&&("string"==typeof s||Array.isArray(s))){var g=s;s=t,t=e,e=g}if(arguments[3]instanceof Pe==0?(o=arguments[4],l=arguments[5],"object"===fy(u=arguments[3])&&null!==u||("string"==typeof o&&(l=o,o=null),"string"==typeof u&&(l=u,u=null),"number"==typeof u&&(o=u,u=null),i={flags:u,angle:o,align:l})):(C("The transform parameter of text() with a Matrix value"),m=n),isNaN(t)||isNaN(s)||null==e)throw new Error("Invalid arguments passed to jsPDF.text");if(0===e.length)return p;var v,y="",w="number"==typeof i.lineHeightFactor?i.lineHeightFactor:Dt,S=p.internal.scaleFactor;function k(e){return e=e.split("\t").join(Array(i.TabLen||9).join(" ")),it(e,u)}function N(e){for(var t,s=e.concat(),i=[],n=s.length;n--;)"string"==typeof(t=s.shift())?i.push(t):Array.isArray(e)&&(1===t.length||void 0===t[1]&&void 0===t[2])?i.push(t[0]):i.push([t[0],t[1],t[2]]);return i}function T(e,t){var s;if("string"==typeof e)s=t(e)[0];else if(Array.isArray(e)){for(var i,n,r=e.concat(),a=[],o=r.length;o--;)"string"==typeof(i=r.shift())?a.push(t(i)[0]):Array.isArray(i)&&"string"==typeof i[0]&&(n=t(i[0],i[1],i[2]),a.push([n[0],n[1],n[2]]));s=a}return s}var A=!1,j=!0;if("string"==typeof e)A=!0;else if(Array.isArray(e)){var P=e.concat();a=[];for(var I,L=P.length;L--;)("string"!=typeof(I=P.shift())||Array.isArray(I)&&"string"!=typeof I[0])&&(j=!1);A=j}if(!1===A)throw new Error('Type of text must be string or Array. "'+e+'" is not recognized.');"string"==typeof e&&(e=e.match(/[\r?\n]/)?e.split(/\r\n|\r|\n/g):[e]);var R=te/p.internal.scaleFactor,O=R*(w-1);switch(i.baseline){case"bottom":s-=O;break;case"top":s+=R-O;break;case"hanging":s+=R-2*O;break;case"middle":s+=R/2-O}if((d=i.maxWidth||0)>0&&("string"==typeof e?e=p.splitTextToSize(e,d):"[object Array]"===Object.prototype.toString.call(e)&&(e=e.reduce(function(e,t){return e.concat(p.splitTextToSize(t,d))},[]))),r={text:e,x:t,y:s,options:i,mutex:{pdfEscape:it,activeFontKey:ue,fonts:ge,activeFontSize:te}},Ne.publish("preProcessText",r),e=r.text,o=(i=r.options).angle,m instanceof Pe==0&&o&&"number"==typeof o){o*=Math.PI/180,0===i.rotationDirection&&(o=-o),x===b&&(o=-o);var D=Math.cos(o),M=Math.sin(o);m=new Pe(D,M,-M,D,0,0)}else o&&o instanceof Pe&&(m=o);x!==b||m||(m=Le),void 0!==(c=i.charSpace||Xt)&&(y+=_(E(c))+" Tc\n",this.setCharSpace(this.getCharSpace()||0)),void 0!==(f=i.horizontalScale)&&(y+=_(100*f)+" Tz\n"),i.lang;var U=-1,F=void 0!==i.renderingMode?i.renderingMode:i.stroke,B=p.internal.getCurrentPageInfo().pageContext;switch(F){case 0:case!1:case"fill":U=0;break;case 1:case!0:case"stroke":U=1;break;case 2:case"fillThenStroke":U=2;break;case 3:case"invisible":U=3;break;case 4:case"fillAndAddForClipping":U=4;break;case 5:case"strokeAndAddPathForClipping":U=5;break;case 6:case"fillThenStrokeAndAddToPathForClipping":U=6;break;case 7:case"addToPathForClipping":U=7}var q=void 0!==B.usedRenderingMode?B.usedRenderingMode:-1;-1!==U?y+=U+" Tr\n":-1!==q&&(y+="0 Tr\n"),-1!==U&&(B.usedRenderingMode=U),l=i.align||"left";var $,z=te*w,H=p.internal.pageSize.getWidth(),V=ge[ue];c=i.charSpace||Xt,d=i.maxWidth||0,u=Object.assign({autoencode:!0,noBOM:!0},i.flags);var G=[],J=function(e){return p.getStringUnitWidth(e,{font:V,charSpace:c,fontSize:te,doKerning:!1})*te/S};if("[object Array]"===Object.prototype.toString.call(e)){var W;a=N(e),"left"!==l&&($=a.map(J));var K,Y=0;if("right"===l){t-=$[0],e=[],L=a.length;for(var Q=0;Q<L;Q++)0===Q?(K=zt(t),W=Ht(s)):(K=E(Y-$[Q]),W=-z),e.push([a[Q],K,W]),Y=$[Q]}else if("center"===l){t-=$[0]/2,e=[],L=a.length;for(var Z=0;Z<L;Z++)0===Z?(K=zt(t),W=Ht(s)):(K=E((Y-$[Z])/2),W=-z),e.push([a[Z],K,W]),Y=$[Z]}else if("left"===l){e=[],L=a.length;for(var ee=0;ee<L;ee++)e.push(a[ee])}else if("justify"===l&&"Identity-H"===V.encoding){e=[],L=a.length,d=0!==d?d:H;for(var se=0,ie=0;ie<L;ie++)if(W=0===ie?Ht(s):-z,K=0===ie?zt(t):se,ie<L-1){var re=E((d-$[ie])/(a[ie].split(" ").length-1)),ae=a[ie].split(" ");e.push([ae[0]+" ",K,W]),se=0;for(var oe=1;oe<ae.length;oe++){var le=(J(ae[oe-1]+" "+ae[oe])-J(ae[oe]))*S+re;oe==ae.length-1?e.push([ae[oe],le,0]):e.push([ae[oe]+" ",le,0]),se-=le}}else e.push([a[ie],K,W]);e.push(["",se,0])}else{if("justify"!==l)throw new Error('Unrecognized alignment option, use "left", "center", "right" or "justify".');for(e=[],L=a.length,d=0!==d?d:H,ie=0;ie<L;ie++)W=0===ie?Ht(s):-z,K=0===ie?zt(t):0,ie<L-1?G.push(_(E((d-$[ie])/(a[ie].split(" ").length-1)))):G.push(0),e.push([a[ie],K,W])}}!0===("boolean"==typeof i.R2L?i.R2L:ne)&&(e=T(e,function(e,t,s){return[e.split("").reverse().join(""),t,s]})),r={text:e,x:t,y:s,options:i,mutex:{pdfEscape:it,activeFontKey:ue,fonts:ge,activeFontSize:te}},Ne.publish("postProcessText",r),e=r.text,v=r.mutex.isHex||!1;var ce=ge[ue].encoding;"WinAnsiEncoding"!==ce&&"StandardEncoding"!==ce||(e=T(e,function(e,t,s){return[k(e),t,s]})),a=N(e),e=[];for(var de,he,fe,me=Array.isArray(a[0])?1:0,pe="",ve=function(e,t,s){var n="";return s instanceof Pe?(s="number"==typeof i.angle?Ie(s,new Pe(1,0,0,1,e,t)):Ie(new Pe(1,0,0,1,e,t),s),x===b&&(s=Ie(new Pe(1,0,0,-1,0,0),s)),n=s.join(" ")+" Tm\n"):n=_(e)+" "+_(t)+" Td\n",n},ye=0;ye<a.length;ye++){switch(pe="",me){case 1:fe=(v?"<":"(")+a[ye][0]+(v?">":")"),de=parseFloat(a[ye][1]),he=parseFloat(a[ye][2]);break;case 0:fe=(v?"<":"(")+a[ye]+(v?">":")"),de=zt(t),he=Ht(s)}void 0!==G&&void 0!==G[ye]&&(pe=G[ye]+" Tw\n"),0===ye?e.push(pe+ve(de,he,m)+fe):0===me?e.push(pe+fe):1===me&&e.push(pe+ve(de,he,m)+fe)}e=0===me?e.join(" Tj\nT* "):e.join(" Tj\n"),e+=" Tj\n";var be="BT\n/";return be+=ue+" "+te+" Tf\n",be+=_(te*w)+" TL\n",be+=Kt+"\n",be+=y,be+=e,X(be+="ET"),h[ue]=!0,p};var kt=f.__private__.clip=f.clip=function(e){return X("evenodd"===e?"W*":"W"),this};f.clipEvenOdd=function(){return kt("evenodd")},f.__private__.discardPath=f.discardPath=function(){return X("n"),this};var _t=f.__private__.isValidStyle=function(e){var t=!1;return-1!==[void 0,null,"S","D","F","DF","FD","f","f*","B","B*","n"].indexOf(e)&&(t=!0),t};f.__private__.setDefaultPathOperation=f.setDefaultPathOperation=function(e){return _t(e)&&(c=e),this};var Ct=f.__private__.getStyle=f.getStyle=function(e){var t=c;switch(e){case"D":case"S":t="S";break;case"F":t="f";break;case"FD":case"DF":t="B";break;case"f":case"f*":case"B":case"B*":t=e}return t},Nt=f.close=function(){return X("h"),this};f.stroke=function(){return X("S"),this},f.fill=function(e){return Tt("f",e),this},f.fillEvenOdd=function(e){return Tt("f*",e),this},f.fillStroke=function(e){return Tt("B",e),this},f.fillStrokeEvenOdd=function(e){return Tt("B*",e),this};var Tt=function(e,t){"object"===fy(t)?jt(t,e):X(e)},At=function(e){null===e||x===b&&void 0===e||(e=Ct(e),X(e))};function Et(e,t,s,i,n){var r=new Ub(t||this.boundingBox,s||this.xStep,i||this.yStep,this.gState,n||this.matrix);r.stream=this.stream;var a=e+"$$"+this.cloneIndex+++"$$";return Re(a,r),r}var jt=function(e,t){var s=xe[e.key],i=be[s];if(i instanceof Mb)X("q"),X(Pt(t)),i.gState&&f.setGState(i.gState),X(e.matrix.toString()+" cm"),X("/"+s+" sh"),X("Q");else if(i instanceof Ub){var n=new Pe(1,0,0,-1,0,cs());e.matrix&&(n=n.multiply(e.matrix||Le),s=Et.call(i,e.key,e.boundingBox,e.xStep,e.yStep,n).id),X("q"),X("/Pattern cs"),X("/"+s+" scn"),i.gState&&f.setGState(i.gState),X(t),X("Q")}},Pt=function(e){switch(e){case"f":case"F":case"n":return"W n";case"f*":return"W* n";case"B":case"S":return"W S";case"B*":return"W* S"}},It=f.moveTo=function(e,t){return X(_(E(e))+" "+_(j(t))+" m"),this},Lt=f.lineTo=function(e,t){return X(_(E(e))+" "+_(j(t))+" l"),this},Rt=f.curveTo=function(e,t,s,i,n,r){return X([_(E(e)),_(j(t)),_(E(s)),_(j(i)),_(E(n)),_(j(r)),"c"].join(" ")),this};f.__private__.line=f.line=function(e,t,s,i,n){if(isNaN(e)||isNaN(t)||isNaN(s)||isNaN(i)||!_t(n))throw new Error("Invalid arguments passed to jsPDF.line");return x===y?this.lines([[s-e,i-t]],e,t,[1,1],n||"S"):this.lines([[s-e,i-t]],e,t,[1,1]).stroke()},f.__private__.lines=f.lines=function(e,t,s,i,n,r){var a,o,l,c,d,u,h,f,m,p,g,v;if("number"==typeof e&&(v=s,s=t,t=e,e=v),i=i||[1,1],r=r||!1,isNaN(t)||isNaN(s)||!Array.isArray(e)||!Array.isArray(i)||!_t(n)||"boolean"!=typeof r)throw new Error("Invalid arguments passed to jsPDF.lines");for(It(t,s),a=i[0],o=i[1],c=e.length,p=t,g=s,l=0;l<c;l++)2===(d=e[l]).length?(p=d[0]*a+p,g=d[1]*o+g,Lt(p,g)):(u=d[0]*a+p,h=d[1]*o+g,f=d[2]*a+p,m=d[3]*o+g,p=d[4]*a+p,g=d[5]*o+g,Rt(u,h,f,m,p,g));return r&&Nt(),At(n),this},f.path=function(e){for(var t=0;t<e.length;t++){var s=e[t],i=s.c;switch(s.op){case"m":It(i[0],i[1]);break;case"l":Lt(i[0],i[1]);break;case"c":Rt.apply(this,i);break;case"h":Nt()}}return this},f.__private__.rect=f.rect=function(e,t,s,i,n){if(isNaN(e)||isNaN(t)||isNaN(s)||isNaN(i)||!_t(n))throw new Error("Invalid arguments passed to jsPDF.rect");return x===y&&(i=-i),X([_(E(e)),_(j(t)),_(E(s)),_(E(i)),"re"].join(" ")),At(n),this},f.__private__.triangle=f.triangle=function(e,t,s,i,n,r,a){if(isNaN(e)||isNaN(t)||isNaN(s)||isNaN(i)||isNaN(n)||isNaN(r)||!_t(a))throw new Error("Invalid arguments passed to jsPDF.triangle");return this.lines([[s-e,i-t],[n-s,r-i],[e-n,t-r]],e,t,[1,1],a,!0),this},f.__private__.roundedRect=f.roundedRect=function(e,t,s,i,n,r,a){if(isNaN(e)||isNaN(t)||isNaN(s)||isNaN(i)||isNaN(n)||isNaN(r)||!_t(a))throw new Error("Invalid arguments passed to jsPDF.roundedRect");var o=4/3*(Math.SQRT2-1);return n=Math.min(n,.5*s),r=Math.min(r,.5*i),this.lines([[s-2*n,0],[n*o,0,n,r-r*o,n,r],[0,i-2*r],[0,r*o,-n*o,r,-n,r],[2*n-s,0],[-n*o,0,-n,-r*o,-n,-r],[0,2*r-i],[0,-r*o,n*o,-r,n,-r]],e+n,t,[1,1],a,!0),this},f.__private__.ellipse=f.ellipse=function(e,t,s,i,n){if(isNaN(e)||isNaN(t)||isNaN(s)||isNaN(i)||!_t(n))throw new Error("Invalid arguments passed to jsPDF.ellipse");var r=4/3*(Math.SQRT2-1)*s,a=4/3*(Math.SQRT2-1)*i;return It(e+s,t),Rt(e+s,t-a,e+r,t-i,e,t-i),Rt(e-r,t-i,e-s,t-a,e-s,t),Rt(e-s,t+a,e-r,t+i,e,t+i),Rt(e+r,t+i,e+s,t+a,e+s,t),At(n),this},f.__private__.circle=f.circle=function(e,t,s,i){if(isNaN(e)||isNaN(t)||isNaN(s)||!_t(i))throw new Error("Invalid arguments passed to jsPDF.circle");return this.ellipse(e,t,s,s,i)},f.setFont=function(e,t,s){return s&&(t=k(t,s)),ue=ct(e,t,{disableWarning:!1}),this};var Ot=f.__private__.getFont=f.getFont=function(){return ge[ct.apply(f,arguments)]};f.__private__.getFontList=f.getFontList=function(){var e,t,s={};for(e in ve)if(ve.hasOwnProperty(e))for(t in s[e]=[],ve[e])ve[e].hasOwnProperty(t)&&s[e].push(t);return s},f.addFont=function(e,t,s,i,n){var r=["StandardEncoding","MacRomanEncoding","Identity-H","WinAnsiEncoding"];return arguments[3]&&-1!==r.indexOf(arguments[3])?n=arguments[3]:arguments[3]&&-1==r.indexOf(arguments[3])&&(s=k(s,i)),st.call(this,e,t,s,n=n||"Identity-H")};var Dt,Mt=e.lineWidth||.200025,Ut=f.__private__.getLineWidth=f.getLineWidth=function(){return Mt},Ft=f.__private__.setLineWidth=f.setLineWidth=function(e){return Mt=e,X(_(E(e))+" w"),this};f.__private__.setLineDash=Fb.API.setLineDash=Fb.API.setLineDashPattern=function(e,t){if(e=e||[],t=t||0,isNaN(t)||!Array.isArray(e))throw new Error("Invalid arguments passed to jsPDF.setLineDash");return e=e.map(function(e){return _(E(e))}).join(" "),t=_(E(t)),X("["+e+"] "+t+" d"),this};var Bt=f.__private__.getLineHeight=f.getLineHeight=function(){return te*Dt};f.__private__.getLineHeight=f.getLineHeight=function(){return te*Dt};var qt=f.__private__.setLineHeightFactor=f.setLineHeightFactor=function(e){return"number"==typeof(e=e||1.15)&&(Dt=e),this},$t=f.__private__.getLineHeightFactor=f.getLineHeightFactor=function(){return Dt};qt(e.lineHeight);var zt=f.__private__.getHorizontalCoordinate=function(e){return E(e)},Ht=f.__private__.getVerticalCoordinate=function(e){return x===b?e:Ce[F].mediaBox.topRightY-Ce[F].mediaBox.bottomLeftY-E(e)},Vt=f.__private__.getHorizontalCoordinateString=f.getHorizontalCoordinateString=function(e){return _(zt(e))},Gt=f.__private__.getVerticalCoordinateString=f.getVerticalCoordinateString=function(e){return _(Ht(e))},Jt=e.strokeColor||"0 G";f.__private__.getStrokeColor=f.getDrawColor=function(){return $e(Jt)},f.__private__.setStrokeColor=f.setDrawColor=function(e,t,s,i){return Jt=ze({ch1:e,ch2:t,ch3:s,ch4:i,pdfColorType:"draw",precision:2}),X(Jt),this};var Wt=e.fillColor||"0 g";f.__private__.getFillColor=f.getFillColor=function(){return $e(Wt)},f.__private__.setFillColor=f.setFillColor=function(e,t,s,i){return Wt=ze({ch1:e,ch2:t,ch3:s,ch4:i,pdfColorType:"fill",precision:2}),X(Wt),this};var Kt=e.textColor||"0 g",Yt=f.__private__.getTextColor=f.getTextColor=function(){return $e(Kt)};f.__private__.setTextColor=f.setTextColor=function(e,t,s,i){return Kt=ze({ch1:e,ch2:t,ch3:s,ch4:i,pdfColorType:"text",precision:3}),this};var Xt=e.charSpace,Qt=f.__private__.getCharSpace=f.getCharSpace=function(){return parseFloat(Xt||0)};f.__private__.setCharSpace=f.setCharSpace=function(e){if(isNaN(e))throw new Error("Invalid argument passed to jsPDF.setCharSpace");return Xt=e,this};var Zt=0;f.CapJoinStyles={0:0,butt:0,but:0,miter:0,1:1,round:1,rounded:1,circle:1,2:2,projecting:2,project:2,square:2,bevel:2},f.__private__.setLineCap=f.setLineCap=function(e){var t=f.CapJoinStyles[e];if(void 0===t)throw new Error("Line cap style of '"+e+"' is not recognized. See or extend .CapJoinStyles property for valid styles");return Zt=t,X(t+" J"),this};var es=0;f.__private__.setLineJoin=f.setLineJoin=function(e){var t=f.CapJoinStyles[e];if(void 0===t)throw new Error("Line join style of '"+e+"' is not recognized. See or extend .CapJoinStyles property for valid styles");return es=t,X(t+" j"),this},f.__private__.setLineMiterLimit=f.__private__.setMiterLimit=f.setLineMiterLimit=f.setMiterLimit=function(e){if(e=e||0,isNaN(e))throw new Error("Invalid argument passed to jsPDF.setLineMiterLimit");return X(_(E(e))+" M"),this},f.GState=Ob,f.setGState=function(e){(e="string"==typeof e?we[Se[e]]:ts(null,e)).equals(ke)||(X("/"+e.id+" gs"),ke=e)};var ts=function(e,t){if(!e||!Se[e]){var s=!1;for(var i in we)if(we.hasOwnProperty(i)&&we[i].equals(t)){s=!0;break}if(s)t=we[i];else{var n="GS"+(Object.keys(we).length+1).toString(10);we[n]=t,t.id=n}return e&&(Se[e]=t.id),Ne.publish("addGState",t),t}};f.addGState=function(e,t){return ts(e,t),this},f.saveGraphicsState=function(){return X("q"),ye.push({key:ue,size:te,color:Kt}),this},f.restoreGraphicsState=function(){X("Q");var e=ye.pop();return ue=e.key,te=e.size,Kt=e.color,ke=null,this},f.setCurrentTransformationMatrix=function(e){return X(e.toString()+" cm"),this},f.comment=function(e){return X("#"+e),this};var ss=function(e,t){var s=e||0;Object.defineProperty(this,"x",{enumerable:!0,get:function(){return s},set:function(e){isNaN(e)||(s=parseFloat(e))}});var i=t||0;Object.defineProperty(this,"y",{enumerable:!0,get:function(){return i},set:function(e){isNaN(e)||(i=parseFloat(e))}});var n="pt";return Object.defineProperty(this,"type",{enumerable:!0,get:function(){return n},set:function(e){n=e.toString()}}),this},is=function(e,t,s,i){ss.call(this,e,t),this.type="rect";var n=s||0;Object.defineProperty(this,"w",{enumerable:!0,get:function(){return n},set:function(e){isNaN(e)||(n=parseFloat(e))}});var r=i||0;return Object.defineProperty(this,"h",{enumerable:!0,get:function(){return r},set:function(e){isNaN(e)||(r=parseFloat(e))}}),this},ns=function(){this.page=_e,this.currentPage=F,this.pages=J.slice(0),this.pagesContext=Ce.slice(0),this.x=fe,this.y=me,this.matrix=pe,this.width=os(F),this.height=cs(F),this.outputDestination=K,this.id="",this.objectNumber=-1};ns.prototype.restore=function(){_e=this.page,F=this.currentPage,Ce=this.pagesContext,J=this.pages,fe=this.x,me=this.y,pe=this.matrix,ls(F,this.width),ds(F,this.height),K=this.outputDestination};var rs=function(e,t,s,i,n){je.push(new ns),_e=F=0,J=[],fe=e,me=t,pe=n,nt([s,i])};for(var as in f.beginFormObject=function(e,t,s,i,n){return rs(e,t,s,i,n),this},f.endFormObject=function(e){return function(e){if(Ee[e])je.pop().restore();else{var t=new ns,s="Xo"+(Object.keys(Ae).length+1).toString(10);t.id=s,Ee[e]=s,Ae[s]=t,Ne.publish("addFormObject",t),je.pop().restore()}}(e),this},f.doFormObject=function(e,t){var s=Ae[Ee[e]];return X("q"),X(t.toString()+" cm"),X("/"+s.id+" Do"),X("Q"),this},f.getFormObject=function(e){var t=Ae[Ee[e]];return{x:t.x,y:t.y,width:t.width,height:t.height,matrix:t.matrix}},f.save=function(e,t){return e=e||"generated.pdf",(t=t||{}).returnPromise=t.returnPromise||!1,!1===t.returnPromise?(mb(gt(pt()),e),"function"==typeof mb.unload&&ab.setTimeout&&setTimeout(mb.unload,911),this):new Promise(function(t,s){try{var i=mb(gt(pt()),e);"function"==typeof mb.unload&&ab.setTimeout&&setTimeout(mb.unload,911),t(i)}catch(n){s(n.message)}})},Fb.API)Fb.API.hasOwnProperty(as)&&("events"===as&&Fb.API.events.length?function(e,t){var s,i,n;for(n=t.length-1;-1!==n;n--)s=t[n][0],i=t[n][1],e.subscribe.apply(e,[s].concat("function"==typeof i?[i]:i))}(Ne,Fb.API.events):f[as]=Fb.API[as]);var os=f.getPageWidth=function(e){return(Ce[e=e||F].mediaBox.topRightX-Ce[e].mediaBox.bottomLeftX)/he},ls=f.setPageWidth=function(e,t){Ce[e].mediaBox.topRightX=t*he+Ce[e].mediaBox.bottomLeftX},cs=f.getPageHeight=function(e){return(Ce[e=e||F].mediaBox.topRightY-Ce[e].mediaBox.bottomLeftY)/he},ds=f.setPageHeight=function(e,t){Ce[e].mediaBox.topRightY=t*he+Ce[e].mediaBox.bottomLeftY};return f.internal={pdfEscape:it,getStyle:Ct,getFont:Ot,getFontSize:ie,getCharSpace:Qt,getTextColor:Yt,getLineHeight:Bt,getLineHeightFactor:$t,getLineWidth:Ut,write:Q,getHorizontalCoordinate:zt,getVerticalCoordinate:Ht,getCoordinateString:Vt,getVerticalCoordinateString:Gt,collections:{},newObject:De,newAdditionalObject:Fe,newObjectDeferred:Me,newObjectDeferredBegin:Ue,getFilters:He,putStream:Ve,events:Ne,scaleFactor:he,pageSize:{getWidth:function(){return os(F)},setWidth:function(e){ls(F,e)},getHeight:function(){return cs(F)},setHeight:function(e){ds(F,e)}},encryptionOptions:d,encryption:bt,getEncryptor:function(e){return null!==d?bt.encryptor(e,0):function(e){return e}},output:vt,getNumberOfPages:lt,pages:J,out:X,f2:T,f3:A,getPageInfo:xt,getPageInfoByObjId:wt,getCurrentPageInfo:St,getPDFVersion:p,Point:ss,Rectangle:is,Matrix:Pe,hasHotfix:yt},Object.defineProperty(f.internal.pageSize,"width",{get:function(){return os(F)},set:function(e){ls(F,e)},enumerable:!0,configurable:!0}),Object.defineProperty(f.internal.pageSize,"height",{get:function(){return cs(F)},set:function(e){ds(F,e)},enumerable:!0,configurable:!0}),function(e){for(var t=0,s=ee.length;t<s;t++){var i=st.call(this,e[t][0],e[t][1],e[t][2],ee[t][3],!0);!1===u&&(h[i]=!0);var n=e[t][0].split("-");tt({id:i,fontName:n[0],fontStyle:n[1]||""})}Ne.publish("addFonts",{fonts:ge,dictionary:ve})}.call(f,ee),ue="F1",rt(n,s),Ne.publish("initialized"),f}Ib.prototype.lsbFirstWord=function(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)},Ib.prototype.toHexString=function(e){return e.split("").map(function(e){return("0"+(255&e.charCodeAt(0)).toString(16)).slice(-2)}).join("")},Ib.prototype.hexToBytes=function(e){for(var t=[],s=0;s<e.length;s+=2)t.push(String.fromCharCode(parseInt(e.substr(s,2),16)));return t.join("")},Ib.prototype.processOwnerPassword=function(e,t){return jb(Tb(t).substr(0,5),e)},Ib.prototype.encryptor=function(e,t){var s=Tb(this.encryptionKey+String.fromCharCode(255&e,e>>8&255,e>>16&255,255&t,t>>8&255)).substr(0,10);return function(e){return jb(s,e)}},Ob.prototype.equals=function(e){var t,s="id,objectNumber,equals";if(!e||fy(e)!==fy(this))return!1;var i=0;for(t in this)if(!(s.indexOf(t)>=0)){if(this.hasOwnProperty(t)&&!e.hasOwnProperty(t))return!1;if(this[t]!==e[t])return!1;i++}for(t in e)e.hasOwnProperty(t)&&s.indexOf(t)<0&&i--;return 0===i},Fb.API={events:[]},Fb.version="2.5.2";var Bb=Fb.API,qb=1,$b=function(e){return e.replace(/\\/g,"\\\\").replace(/\(/g,"\\(").replace(/\)/g,"\\)")},zb=function(e){return e.replace(/\\\\/g,"\\").replace(/\\\(/g,"(").replace(/\\\)/g,")")},Hb=function(e){return e.toFixed(2)},Vb=function(e){return e.toFixed(5)};Bb.__acroform__={};var Gb=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e},Jb=function(e){return e*qb},Wb=function(e){var t=new ux,s=Cx.internal.getHeight(e)||0,i=Cx.internal.getWidth(e)||0;return t.BBox=[0,0,Number(Hb(i)),Number(Hb(s))],t},Kb=Bb.__acroform__.setBit=function(e,t){if(e=e||0,t=t||0,isNaN(e)||isNaN(t))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.setBit");return e|1<<t},Yb=Bb.__acroform__.clearBit=function(e,t){if(e=e||0,t=t||0,isNaN(e)||isNaN(t))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.clearBit");return e&~(1<<t)},Xb=Bb.__acroform__.getBit=function(e,t){if(isNaN(e)||isNaN(t))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.getBit");return e&1<<t?1:0},Qb=Bb.__acroform__.getBitForPdf=function(e,t){if(isNaN(e)||isNaN(t))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.getBitForPdf");return Xb(e,t-1)},Zb=Bb.__acroform__.setBitForPdf=function(e,t){if(isNaN(e)||isNaN(t))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.setBitForPdf");return Kb(e,t-1)},ex=Bb.__acroform__.clearBitForPdf=function(e,t){if(isNaN(e)||isNaN(t))throw new Error("Invalid arguments passed to jsPDF.API.__acroform__.clearBitForPdf");return Yb(e,t-1)},tx=Bb.__acroform__.calculateCoordinates=function(e,t){var s=t.internal.getHorizontalCoordinate,i=t.internal.getVerticalCoordinate,n=e[0],r=e[1],a=e[2],o=e[3],l={};return l.lowerLeft_X=s(n)||0,l.lowerLeft_Y=i(r+o)||0,l.upperRight_X=s(n+a)||0,l.upperRight_Y=i(r)||0,[Number(Hb(l.lowerLeft_X)),Number(Hb(l.lowerLeft_Y)),Number(Hb(l.upperRight_X)),Number(Hb(l.upperRight_Y))]},sx=function(e){if(e.appearanceStreamContent)return e.appearanceStreamContent;if(e.V||e.DV){var t=[],s=e._V||e.DV,i=ix(e,s),n=e.scope.internal.getFont(e.fontName,e.fontStyle).id;t.push("/Tx BMC"),t.push("q"),t.push("BT"),t.push(e.scope.__private__.encodeColorString(e.color)),t.push("/"+n+" "+Hb(i.fontSize)+" Tf"),t.push("1 0 0 1 0 0 Tm"),t.push(i.text),t.push("ET"),t.push("Q"),t.push("EMC");var r=Wb(e);return r.scope=e.scope,r.stream=t.join("\n"),r}},ix=function(e,t){var s=0===e.fontSize?e.maxFontSize:e.fontSize,i={text:"",fontSize:""},n=(t=")"==(t="("==t.substr(0,1)?t.substr(1):t).substr(t.length-1)?t.substr(0,t.length-1):t).split(" ");n=e.multiline?n.map(function(e){return e.split("\n")}):n.map(function(e){return[e]});var r=s,a=Cx.internal.getHeight(e)||0;a=a<0?-a:a;var o=Cx.internal.getWidth(e)||0;o=o<0?-o:o;var l=function(t,s,i){if(t+1<n.length){var r=s+" "+n[t+1][0];return nx(r,e,i).width<=o-4}return!1};r++;e:for(;r>0;){t="",r--;var c,d,u=nx("3",e,r).height,h=e.multiline?a-r:(a-u)/2,f=h+=2,m=0,p=0,g=0;if(r<=0){t="(...) Tj\n",t+="% Width of Text: "+nx(t,e,r=12).width+", FieldWidth:"+o+"\n";break}for(var v="",y=0,b=0;b<n.length;b++)if(n.hasOwnProperty(b)){var x=!1;if(1!==n[b].length&&g!==n[b].length-1){if((u+2)*(y+2)+2>a)continue e;v+=n[b][g],x=!0,p=b,b--}else{v=" "==(v+=n[b][g]+" ").substr(v.length-1)?v.substr(0,v.length-1):v;var w=parseInt(b),S=l(w,v,r),k=b>=n.length-1;if(S&&!k){v+=" ",g=0;continue}if(S||k){if(k)p=w;else if(e.multiline&&(u+2)*(y+2)+2>a)continue e}else{if(!e.multiline)continue e;if((u+2)*(y+2)+2>a)continue e;p=w}}for(var _="",C=m;C<=p;C++){var N=n[C];if(e.multiline){if(C===p){_+=N[g]+" ",g=(g+1)%N.length;continue}if(C===m){_+=N[N.length-1]+" ";continue}}_+=N[0]+" "}switch(_=" "==_.substr(_.length-1)?_.substr(0,_.length-1):_,d=nx(_,e,r).width,e.textAlign){case"right":c=o-d-2;break;case"center":c=(o-d)/2;break;default:c=2}t+=Hb(c)+" "+Hb(f)+" Td\n",t+="("+$b(_)+") Tj\n",t+=-Hb(c)+" 0 Td\n",f=-(r+2),d=0,m=x?p:p+1,y++,v=""}break}return i.text=t,i.fontSize=r,i},nx=function(e,t,s){var i=t.scope.internal.getFont(t.fontName,t.fontStyle),n=t.scope.getStringUnitWidth(e,{font:i,fontSize:parseFloat(s),charSpace:0})*parseFloat(s);return{height:t.scope.getStringUnitWidth("3",{font:i,fontSize:parseFloat(s),charSpace:0})*parseFloat(s)*1.5,width:n}},rx={fields:[],xForms:[],acroFormDictionaryRoot:null,printedOut:!1,internal:null,isInitialized:!1},ax=function(e,t){var s={type:"reference",object:e};void 0===t.internal.getPageInfo(e.page).pageContext.annotations.find(function(e){return e.type===s.type&&e.object===s.object})&&t.internal.getPageInfo(e.page).pageContext.annotations.push(s)},ox=function(e,t){if(t.scope=e,void 0!==e.internal&&(void 0===e.internal.acroformPlugin||!1===e.internal.acroformPlugin.isInitialized)){if(fx.FieldNum=0,e.internal.acroformPlugin=JSON.parse(JSON.stringify(rx)),e.internal.acroformPlugin.acroFormDictionaryRoot)throw new Error("Exception while creating AcroformDictionary");qb=e.internal.scaleFactor,e.internal.acroformPlugin.acroFormDictionaryRoot=new hx,e.internal.acroformPlugin.acroFormDictionaryRoot.scope=e,e.internal.acroformPlugin.acroFormDictionaryRoot._eventID=e.internal.events.subscribe("postPutResources",function(){var t;(t=e).internal.events.unsubscribe(t.internal.acroformPlugin.acroFormDictionaryRoot._eventID),delete t.internal.acroformPlugin.acroFormDictionaryRoot._eventID,t.internal.acroformPlugin.printedOut=!0}),e.internal.events.subscribe("buildDocument",function(){!function(e){e.internal.acroformPlugin.acroFormDictionaryRoot.objId=void 0;var t=e.internal.acroformPlugin.acroFormDictionaryRoot.Fields;for(var s in t)if(t.hasOwnProperty(s)){var i=t[s];i.objId=void 0,i.hasAnnotation&&ax(i,e)}}(e)}),e.internal.events.subscribe("putCatalog",function(){!function(e){if(void 0===e.internal.acroformPlugin.acroFormDictionaryRoot)throw new Error("putCatalogCallback: Root missing.");e.internal.write("/AcroForm "+e.internal.acroformPlugin.acroFormDictionaryRoot.objId+" 0 R")}(e)}),e.internal.events.subscribe("postPutPages",function(t){!function(e,t){var s=!e;for(var i in e||(t.internal.newObjectDeferredBegin(t.internal.acroformPlugin.acroFormDictionaryRoot.objId,!0),t.internal.acroformPlugin.acroFormDictionaryRoot.putStream()),e=e||t.internal.acroformPlugin.acroFormDictionaryRoot.Kids)if(e.hasOwnProperty(i)){var n=e[i],r=[],a=n.Rect;if(n.Rect&&(n.Rect=tx(n.Rect,t)),t.internal.newObjectDeferredBegin(n.objId,!0),n.DA=Cx.createDefaultAppearanceStream(n),"object"===fy(n)&&"function"==typeof n.getKeyValueListForStream&&(r=n.getKeyValueListForStream()),n.Rect=a,n.hasAppearanceStream&&!n.appearanceStreamContent){var o=sx(n);r.push({key:"AP",value:"<</N "+o+">>"}),t.internal.acroformPlugin.xForms.push(o)}if(n.appearanceStreamContent){var l="";for(var c in n.appearanceStreamContent)if(n.appearanceStreamContent.hasOwnProperty(c)){var d=n.appearanceStreamContent[c];if(l+="/"+c+" ",l+="<<",Object.keys(d).length>=1||Array.isArray(d)){for(var i in d)if(d.hasOwnProperty(i)){var u=d[i];"function"==typeof u&&(u=u.call(t,n)),l+="/"+i+" "+u+" ",t.internal.acroformPlugin.xForms.indexOf(u)>=0||t.internal.acroformPlugin.xForms.push(u)}}else"function"==typeof(u=d)&&(u=u.call(t,n)),l+="/"+i+" "+u,t.internal.acroformPlugin.xForms.indexOf(u)>=0||t.internal.acroformPlugin.xForms.push(u);l+=">>"}r.push({key:"AP",value:"<<\n"+l+">>"})}t.internal.putStream({additionalKeyValues:r,objectId:n.objId}),t.internal.out("endobj")}s&&function(e,t){for(var s in e)if(e.hasOwnProperty(s)){var i=s,n=e[s];t.internal.newObjectDeferredBegin(n.objId,!0),"object"===fy(n)&&"function"==typeof n.putStream&&n.putStream(),delete e[i]}}(t.internal.acroformPlugin.xForms,t)}(t,e)}),e.internal.acroformPlugin.isInitialized=!0}},lx=Bb.__acroform__.arrayToPdfArray=function(e,t,s){var i=function(e){return e};if(Array.isArray(e)){for(var n="[",r=0;r<e.length;r++)switch(0!==r&&(n+=" "),fy(e[r])){case"boolean":case"number":case"object":n+=e[r].toString();break;case"string":"/"!==e[r].substr(0,1)?(void 0!==t&&s&&(i=s.internal.getEncryptor(t)),n+="("+$b(i(e[r].toString()))+")"):n+=e[r].toString()}return n+"]"}throw new Error("Invalid argument passed to jsPDF.__acroform__.arrayToPdfArray")},cx=function(e,t,s){var i=function(e){return e};return void 0!==t&&s&&(i=s.internal.getEncryptor(t)),(e=e||"").toString(),"("+$b(i(e))+")"},dx=function(){this._objId=void 0,this._scope=void 0,Object.defineProperty(this,"objId",{get:function(){if(void 0===this._objId){if(void 0===this.scope)return;this._objId=this.scope.internal.newObjectDeferred()}return this._objId},set:function(e){this._objId=e}}),Object.defineProperty(this,"scope",{value:this._scope,writable:!0})};dx.prototype.toString=function(){return this.objId+" 0 R"},dx.prototype.putStream=function(){var e=this.getKeyValueListForStream();this.scope.internal.putStream({data:this.stream,additionalKeyValues:e,objectId:this.objId}),this.scope.internal.out("endobj")},dx.prototype.getKeyValueListForStream=function(){var e=[],t=Object.getOwnPropertyNames(this).filter(function(e){return"content"!=e&&"appearanceStreamContent"!=e&&"scope"!=e&&"objId"!=e&&"_"!=e.substring(0,1)});for(var s in t)if(!1===Object.getOwnPropertyDescriptor(this,t[s]).configurable){var i=t[s],n=this[i];n&&(Array.isArray(n)?e.push({key:i,value:lx(n,this.objId,this.scope)}):n instanceof dx?(n.scope=this.scope,e.push({key:i,value:n.objId+" 0 R"})):"function"!=typeof n&&e.push({key:i,value:n}))}return e};var ux=function(){dx.call(this),Object.defineProperty(this,"Type",{value:"/XObject",configurable:!1,writable:!0}),Object.defineProperty(this,"Subtype",{value:"/Form",configurable:!1,writable:!0}),Object.defineProperty(this,"FormType",{value:1,configurable:!1,writable:!0});var e,t=[];Object.defineProperty(this,"BBox",{configurable:!1,get:function(){return t},set:function(e){t=e}}),Object.defineProperty(this,"Resources",{value:"2 0 R",configurable:!1,writable:!0}),Object.defineProperty(this,"stream",{enumerable:!1,configurable:!0,set:function(t){e=t.trim()},get:function(){return e||null}})};Gb(ux,dx);var hx=function(){dx.call(this);var e,t=[];Object.defineProperty(this,"Kids",{enumerable:!1,configurable:!0,get:function(){return t.length>0?t:void 0}}),Object.defineProperty(this,"Fields",{enumerable:!1,configurable:!1,get:function(){return t}}),Object.defineProperty(this,"DA",{enumerable:!1,configurable:!1,get:function(){if(e){var t=function(e){return e};return this.scope&&(t=this.scope.internal.getEncryptor(this.objId)),"("+$b(t(e))+")"}},set:function(t){e=t}})};Gb(hx,dx);var fx=function e(){dx.call(this);var t=4;Object.defineProperty(this,"F",{enumerable:!1,configurable:!1,get:function(){return t},set:function(e){if(isNaN(e))throw new Error('Invalid value "'+e+'" for attribute F supplied.');t=e}}),Object.defineProperty(this,"showWhenPrinted",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(t,3))},set:function(e){!0===Boolean(e)?this.F=Zb(t,3):this.F=ex(t,3)}});var s=0;Object.defineProperty(this,"Ff",{enumerable:!1,configurable:!1,get:function(){return s},set:function(e){if(isNaN(e))throw new Error('Invalid value "'+e+'" for attribute Ff supplied.');s=e}});var i=[];Object.defineProperty(this,"Rect",{enumerable:!1,configurable:!1,get:function(){if(0!==i.length)return i},set:function(e){i=void 0!==e?e:[]}}),Object.defineProperty(this,"x",{enumerable:!0,configurable:!0,get:function(){return!i||isNaN(i[0])?0:i[0]},set:function(e){i[0]=e}}),Object.defineProperty(this,"y",{enumerable:!0,configurable:!0,get:function(){return!i||isNaN(i[1])?0:i[1]},set:function(e){i[1]=e}}),Object.defineProperty(this,"width",{enumerable:!0,configurable:!0,get:function(){return!i||isNaN(i[2])?0:i[2]},set:function(e){i[2]=e}}),Object.defineProperty(this,"height",{enumerable:!0,configurable:!0,get:function(){return!i||isNaN(i[3])?0:i[3]},set:function(e){i[3]=e}});var n="";Object.defineProperty(this,"FT",{enumerable:!0,configurable:!1,get:function(){return n},set:function(e){switch(e){case"/Btn":case"/Tx":case"/Ch":case"/Sig":n=e;break;default:throw new Error('Invalid value "'+e+'" for attribute FT supplied.')}}});var r=null;Object.defineProperty(this,"T",{enumerable:!0,configurable:!1,get:function(){if(!r||r.length<1){if(this instanceof wx)return;r="FieldObject"+e.FieldNum++}var t=function(e){return e};return this.scope&&(t=this.scope.internal.getEncryptor(this.objId)),"("+$b(t(r))+")"},set:function(e){r=e.toString()}}),Object.defineProperty(this,"fieldName",{configurable:!0,enumerable:!0,get:function(){return r},set:function(e){r=e}});var a="helvetica";Object.defineProperty(this,"fontName",{enumerable:!0,configurable:!0,get:function(){return a},set:function(e){a=e}});var o="normal";Object.defineProperty(this,"fontStyle",{enumerable:!0,configurable:!0,get:function(){return o},set:function(e){o=e}});var l=0;Object.defineProperty(this,"fontSize",{enumerable:!0,configurable:!0,get:function(){return l},set:function(e){l=e}});var c=void 0;Object.defineProperty(this,"maxFontSize",{enumerable:!0,configurable:!0,get:function(){return void 0===c?50/qb:c},set:function(e){c=e}});var d="black";Object.defineProperty(this,"color",{enumerable:!0,configurable:!0,get:function(){return d},set:function(e){d=e}});var u="/F1 0 Tf 0 g";Object.defineProperty(this,"DA",{enumerable:!0,configurable:!1,get:function(){if(!(!u||this instanceof wx||this instanceof kx))return cx(u,this.objId,this.scope)},set:function(e){e=e.toString(),u=e}});var h=null;Object.defineProperty(this,"DV",{enumerable:!1,configurable:!1,get:function(){if(h)return this instanceof yx==0?cx(h,this.objId,this.scope):h},set:function(e){e=e.toString(),h=this instanceof yx==0?"("===e.substr(0,1)?zb(e.substr(1,e.length-2)):zb(e):e}}),Object.defineProperty(this,"defaultValue",{enumerable:!0,configurable:!0,get:function(){return this instanceof yx==1?zb(h.substr(1,h.length-1)):h},set:function(e){e=e.toString(),h=this instanceof yx==1?"/"+e:e}});var f=null;Object.defineProperty(this,"_V",{enumerable:!1,configurable:!1,get:function(){if(f)return f},set:function(e){this.V=e}}),Object.defineProperty(this,"V",{enumerable:!1,configurable:!1,get:function(){if(f)return this instanceof yx==0?cx(f,this.objId,this.scope):f},set:function(e){e=e.toString(),f=this instanceof yx==0?"("===e.substr(0,1)?zb(e.substr(1,e.length-2)):zb(e):e}}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,get:function(){return this instanceof yx==1?zb(f.substr(1,f.length-1)):f},set:function(e){e=e.toString(),f=this instanceof yx==1?"/"+e:e}}),Object.defineProperty(this,"hasAnnotation",{enumerable:!0,configurable:!0,get:function(){return this.Rect}}),Object.defineProperty(this,"Type",{enumerable:!0,configurable:!1,get:function(){return this.hasAnnotation?"/Annot":null}}),Object.defineProperty(this,"Subtype",{enumerable:!0,configurable:!1,get:function(){return this.hasAnnotation?"/Widget":null}});var m,p=!1;Object.defineProperty(this,"hasAppearanceStream",{enumerable:!0,configurable:!0,get:function(){return p},set:function(e){e=Boolean(e),p=e}}),Object.defineProperty(this,"page",{enumerable:!0,configurable:!0,get:function(){if(m)return m},set:function(e){m=e}}),Object.defineProperty(this,"readOnly",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,1))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,1):this.Ff=ex(this.Ff,1)}}),Object.defineProperty(this,"required",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,2))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,2):this.Ff=ex(this.Ff,2)}}),Object.defineProperty(this,"noExport",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,3))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,3):this.Ff=ex(this.Ff,3)}});var g=null;Object.defineProperty(this,"Q",{enumerable:!0,configurable:!1,get:function(){if(null!==g)return g},set:function(e){if(-1===[0,1,2].indexOf(e))throw new Error('Invalid value "'+e+'" for attribute Q supplied.');g=e}}),Object.defineProperty(this,"textAlign",{get:function(){var e;switch(g){case 0:default:e="left";break;case 1:e="center";break;case 2:e="right"}return e},configurable:!0,enumerable:!0,set:function(e){switch(e){case"right":case 2:g=2;break;case"center":case 1:g=1;break;default:g=0}}})};Gb(fx,dx);var mx=function(){fx.call(this),this.FT="/Ch",this.V="()",this.fontName="zapfdingbats";var e=0;Object.defineProperty(this,"TI",{enumerable:!0,configurable:!1,get:function(){return e},set:function(t){e=t}}),Object.defineProperty(this,"topIndex",{enumerable:!0,configurable:!0,get:function(){return e},set:function(t){e=t}});var t=[];Object.defineProperty(this,"Opt",{enumerable:!0,configurable:!1,get:function(){return lx(t,this.objId,this.scope)},set:function(e){var s,i;i=[],"string"==typeof(s=e)&&(i=function(e,t,s){s||(s=1);for(var i,n=[];i=t.exec(e);)n.push(i[s]);return n}(s,/\((.*?)\)/g)),t=i}}),this.getOptions=function(){return t},this.setOptions=function(e){t=e,this.sort&&t.sort()},this.addOption=function(e){e=(e=e||"").toString(),t.push(e),this.sort&&t.sort()},this.removeOption=function(e,s){for(s=s||!1,e=(e=e||"").toString();-1!==t.indexOf(e)&&(t.splice(t.indexOf(e),1),!1!==s););},Object.defineProperty(this,"combo",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,18))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,18):this.Ff=ex(this.Ff,18)}}),Object.defineProperty(this,"edit",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,19))},set:function(e){!0===this.combo&&(!0===Boolean(e)?this.Ff=Zb(this.Ff,19):this.Ff=ex(this.Ff,19))}}),Object.defineProperty(this,"sort",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,20))},set:function(e){!0===Boolean(e)?(this.Ff=Zb(this.Ff,20),t.sort()):this.Ff=ex(this.Ff,20)}}),Object.defineProperty(this,"multiSelect",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,22))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,22):this.Ff=ex(this.Ff,22)}}),Object.defineProperty(this,"doNotSpellCheck",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,23))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,23):this.Ff=ex(this.Ff,23)}}),Object.defineProperty(this,"commitOnSelChange",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,27))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,27):this.Ff=ex(this.Ff,27)}}),this.hasAppearanceStream=!1};Gb(mx,fx);var px=function(){mx.call(this),this.fontName="helvetica",this.combo=!1};Gb(px,mx);var gx=function(){px.call(this),this.combo=!0};Gb(gx,px);var vx=function(){gx.call(this),this.edit=!0};Gb(vx,gx);var yx=function(){fx.call(this),this.FT="/Btn",Object.defineProperty(this,"noToggleToOff",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,15))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,15):this.Ff=ex(this.Ff,15)}}),Object.defineProperty(this,"radio",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,16))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,16):this.Ff=ex(this.Ff,16)}}),Object.defineProperty(this,"pushButton",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,17))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,17):this.Ff=ex(this.Ff,17)}}),Object.defineProperty(this,"radioIsUnison",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,26))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,26):this.Ff=ex(this.Ff,26)}});var e,t={};Object.defineProperty(this,"MK",{enumerable:!1,configurable:!1,get:function(){var e=function(e){return e};if(this.scope&&(e=this.scope.internal.getEncryptor(this.objId)),0!==Object.keys(t).length){var s,i=[];for(s in i.push("<<"),t)i.push("/"+s+" ("+$b(e(t[s]))+")");return i.push(">>"),i.join("\n")}},set:function(e){"object"===fy(e)&&(t=e)}}),Object.defineProperty(this,"caption",{enumerable:!0,configurable:!0,get:function(){return t.CA||""},set:function(e){"string"==typeof e&&(t.CA=e)}}),Object.defineProperty(this,"AS",{enumerable:!1,configurable:!1,get:function(){return e},set:function(t){e=t}}),Object.defineProperty(this,"appearanceState",{enumerable:!0,configurable:!0,get:function(){return e.substr(1,e.length-1)},set:function(t){e="/"+t}})};Gb(yx,fx);var bx=function(){yx.call(this),this.pushButton=!0};Gb(bx,yx);var xx=function(){yx.call(this),this.radio=!0,this.pushButton=!1;var e=[];Object.defineProperty(this,"Kids",{enumerable:!0,configurable:!1,get:function(){return e},set:function(t){e=void 0!==t?t:[]}})};Gb(xx,yx);var wx=function(){var e,t;fx.call(this),Object.defineProperty(this,"Parent",{enumerable:!1,configurable:!1,get:function(){return e},set:function(t){e=t}}),Object.defineProperty(this,"optionName",{enumerable:!1,configurable:!0,get:function(){return t},set:function(e){t=e}});var s,i={};Object.defineProperty(this,"MK",{enumerable:!1,configurable:!1,get:function(){var e=function(e){return e};this.scope&&(e=this.scope.internal.getEncryptor(this.objId));var t,s=[];for(t in s.push("<<"),i)s.push("/"+t+" ("+$b(e(i[t]))+")");return s.push(">>"),s.join("\n")},set:function(e){"object"===fy(e)&&(i=e)}}),Object.defineProperty(this,"caption",{enumerable:!0,configurable:!0,get:function(){return i.CA||""},set:function(e){"string"==typeof e&&(i.CA=e)}}),Object.defineProperty(this,"AS",{enumerable:!1,configurable:!1,get:function(){return s},set:function(e){s=e}}),Object.defineProperty(this,"appearanceState",{enumerable:!0,configurable:!0,get:function(){return s.substr(1,s.length-1)},set:function(e){s="/"+e}}),this.caption="l",this.appearanceState="Off",this._AppearanceType=Cx.RadioButton.Circle,this.appearanceStreamContent=this._AppearanceType.createAppearanceStream(this.optionName)};Gb(wx,fx),xx.prototype.setAppearance=function(e){if(!("createAppearanceStream"in e)||!("getCA"in e))throw new Error("Couldn't assign Appearance to RadioButton. Appearance was Invalid!");for(var t in this.Kids)if(this.Kids.hasOwnProperty(t)){var s=this.Kids[t];s.appearanceStreamContent=e.createAppearanceStream(s.optionName),s.caption=e.getCA()}},xx.prototype.createOption=function(e){var t=new wx;return t.Parent=this,t.optionName=e,this.Kids.push(t),Ax.call(this.scope,t),t};var Sx=function(){yx.call(this),this.fontName="zapfdingbats",this.caption="3",this.appearanceState="On",this.value="On",this.textAlign="center",this.appearanceStreamContent=Cx.CheckBox.createAppearanceStream()};Gb(Sx,yx);var kx=function(){fx.call(this),this.FT="/Tx",Object.defineProperty(this,"multiline",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,13))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,13):this.Ff=ex(this.Ff,13)}}),Object.defineProperty(this,"fileSelect",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,21))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,21):this.Ff=ex(this.Ff,21)}}),Object.defineProperty(this,"doNotSpellCheck",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,23))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,23):this.Ff=ex(this.Ff,23)}}),Object.defineProperty(this,"doNotScroll",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,24))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,24):this.Ff=ex(this.Ff,24)}}),Object.defineProperty(this,"comb",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,25))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,25):this.Ff=ex(this.Ff,25)}}),Object.defineProperty(this,"richText",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,26))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,26):this.Ff=ex(this.Ff,26)}});var e=null;Object.defineProperty(this,"MaxLen",{enumerable:!0,configurable:!1,get:function(){return e},set:function(t){e=t}}),Object.defineProperty(this,"maxLength",{enumerable:!0,configurable:!0,get:function(){return e},set:function(t){Number.isInteger(t)&&(e=t)}}),Object.defineProperty(this,"hasAppearanceStream",{enumerable:!0,configurable:!0,get:function(){return this.V||this.DV}})};Gb(kx,fx);var _x=function(){kx.call(this),Object.defineProperty(this,"password",{enumerable:!0,configurable:!0,get:function(){return Boolean(Qb(this.Ff,14))},set:function(e){!0===Boolean(e)?this.Ff=Zb(this.Ff,14):this.Ff=ex(this.Ff,14)}}),this.password=!0};Gb(_x,kx);var Cx={CheckBox:{createAppearanceStream:function(){return{N:{On:Cx.CheckBox.YesNormal},D:{On:Cx.CheckBox.YesPushDown,Off:Cx.CheckBox.OffPushDown}}},YesPushDown:function(e){var t=Wb(e);t.scope=e.scope;var s=[],i=e.scope.internal.getFont(e.fontName,e.fontStyle).id,n=e.scope.__private__.encodeColorString(e.color),r=ix(e,e.caption);return s.push("0.749023 g"),s.push("0 0 "+Hb(Cx.internal.getWidth(e))+" "+Hb(Cx.internal.getHeight(e))+" re"),s.push("f"),s.push("BMC"),s.push("q"),s.push("0 0 1 rg"),s.push("/"+i+" "+Hb(r.fontSize)+" Tf "+n),s.push("BT"),s.push(r.text),s.push("ET"),s.push("Q"),s.push("EMC"),t.stream=s.join("\n"),t},YesNormal:function(e){var t=Wb(e);t.scope=e.scope;var s=e.scope.internal.getFont(e.fontName,e.fontStyle).id,i=e.scope.__private__.encodeColorString(e.color),n=[],r=Cx.internal.getHeight(e),a=Cx.internal.getWidth(e),o=ix(e,e.caption);return n.push("1 g"),n.push("0 0 "+Hb(a)+" "+Hb(r)+" re"),n.push("f"),n.push("q"),n.push("0 0 1 rg"),n.push("0 0 "+Hb(a-1)+" "+Hb(r-1)+" re"),n.push("W"),n.push("n"),n.push("0 g"),n.push("BT"),n.push("/"+s+" "+Hb(o.fontSize)+" Tf "+i),n.push(o.text),n.push("ET"),n.push("Q"),t.stream=n.join("\n"),t},OffPushDown:function(e){var t=Wb(e);t.scope=e.scope;var s=[];return s.push("0.749023 g"),s.push("0 0 "+Hb(Cx.internal.getWidth(e))+" "+Hb(Cx.internal.getHeight(e))+" re"),s.push("f"),t.stream=s.join("\n"),t}},RadioButton:{Circle:{createAppearanceStream:function(e){var t={D:{Off:Cx.RadioButton.Circle.OffPushDown},N:{}};return t.N[e]=Cx.RadioButton.Circle.YesNormal,t.D[e]=Cx.RadioButton.Circle.YesPushDown,t},getCA:function(){return"l"},YesNormal:function(e){var t=Wb(e);t.scope=e.scope;var s=[],i=Cx.internal.getWidth(e)<=Cx.internal.getHeight(e)?Cx.internal.getWidth(e)/4:Cx.internal.getHeight(e)/4;i=Number((.9*i).toFixed(5));var n=Cx.internal.Bezier_C,r=Number((i*n).toFixed(5));return s.push("q"),s.push("1 0 0 1 "+Vb(Cx.internal.getWidth(e)/2)+" "+Vb(Cx.internal.getHeight(e)/2)+" cm"),s.push(i+" 0 m"),s.push(i+" "+r+" "+r+" "+i+" 0 "+i+" c"),s.push("-"+r+" "+i+" -"+i+" "+r+" -"+i+" 0 c"),s.push("-"+i+" -"+r+" -"+r+" -"+i+" 0 -"+i+" c"),s.push(r+" -"+i+" "+i+" -"+r+" "+i+" 0 c"),s.push("f"),s.push("Q"),t.stream=s.join("\n"),t},YesPushDown:function(e){var t=Wb(e);t.scope=e.scope;var s=[],i=Cx.internal.getWidth(e)<=Cx.internal.getHeight(e)?Cx.internal.getWidth(e)/4:Cx.internal.getHeight(e)/4;i=Number((.9*i).toFixed(5));var n=Number((2*i).toFixed(5)),r=Number((n*Cx.internal.Bezier_C).toFixed(5)),a=Number((i*Cx.internal.Bezier_C).toFixed(5));return s.push("0.749023 g"),s.push("q"),s.push("1 0 0 1 "+Vb(Cx.internal.getWidth(e)/2)+" "+Vb(Cx.internal.getHeight(e)/2)+" cm"),s.push(n+" 0 m"),s.push(n+" "+r+" "+r+" "+n+" 0 "+n+" c"),s.push("-"+r+" "+n+" -"+n+" "+r+" -"+n+" 0 c"),s.push("-"+n+" -"+r+" -"+r+" -"+n+" 0 -"+n+" c"),s.push(r+" -"+n+" "+n+" -"+r+" "+n+" 0 c"),s.push("f"),s.push("Q"),s.push("0 g"),s.push("q"),s.push("1 0 0 1 "+Vb(Cx.internal.getWidth(e)/2)+" "+Vb(Cx.internal.getHeight(e)/2)+" cm"),s.push(i+" 0 m"),s.push(i+" "+a+" "+a+" "+i+" 0 "+i+" c"),s.push("-"+a+" "+i+" -"+i+" "+a+" -"+i+" 0 c"),s.push("-"+i+" -"+a+" -"+a+" -"+i+" 0 -"+i+" c"),s.push(a+" -"+i+" "+i+" -"+a+" "+i+" 0 c"),s.push("f"),s.push("Q"),t.stream=s.join("\n"),t},OffPushDown:function(e){var t=Wb(e);t.scope=e.scope;var s=[],i=Cx.internal.getWidth(e)<=Cx.internal.getHeight(e)?Cx.internal.getWidth(e)/4:Cx.internal.getHeight(e)/4;i=Number((.9*i).toFixed(5));var n=Number((2*i).toFixed(5)),r=Number((n*Cx.internal.Bezier_C).toFixed(5));return s.push("0.749023 g"),s.push("q"),s.push("1 0 0 1 "+Vb(Cx.internal.getWidth(e)/2)+" "+Vb(Cx.internal.getHeight(e)/2)+" cm"),s.push(n+" 0 m"),s.push(n+" "+r+" "+r+" "+n+" 0 "+n+" c"),s.push("-"+r+" "+n+" -"+n+" "+r+" -"+n+" 0 c"),s.push("-"+n+" -"+r+" -"+r+" -"+n+" 0 -"+n+" c"),s.push(r+" -"+n+" "+n+" -"+r+" "+n+" 0 c"),s.push("f"),s.push("Q"),t.stream=s.join("\n"),t}},Cross:{createAppearanceStream:function(e){var t={D:{Off:Cx.RadioButton.Cross.OffPushDown},N:{}};return t.N[e]=Cx.RadioButton.Cross.YesNormal,t.D[e]=Cx.RadioButton.Cross.YesPushDown,t},getCA:function(){return"8"},YesNormal:function(e){var t=Wb(e);t.scope=e.scope;var s=[],i=Cx.internal.calculateCross(e);return s.push("q"),s.push("1 1 "+Hb(Cx.internal.getWidth(e)-2)+" "+Hb(Cx.internal.getHeight(e)-2)+" re"),s.push("W"),s.push("n"),s.push(Hb(i.x1.x)+" "+Hb(i.x1.y)+" m"),s.push(Hb(i.x2.x)+" "+Hb(i.x2.y)+" l"),s.push(Hb(i.x4.x)+" "+Hb(i.x4.y)+" m"),s.push(Hb(i.x3.x)+" "+Hb(i.x3.y)+" l"),s.push("s"),s.push("Q"),t.stream=s.join("\n"),t},YesPushDown:function(e){var t=Wb(e);t.scope=e.scope;var s=Cx.internal.calculateCross(e),i=[];return i.push("0.749023 g"),i.push("0 0 "+Hb(Cx.internal.getWidth(e))+" "+Hb(Cx.internal.getHeight(e))+" re"),i.push("f"),i.push("q"),i.push("1 1 "+Hb(Cx.internal.getWidth(e)-2)+" "+Hb(Cx.internal.getHeight(e)-2)+" re"),i.push("W"),i.push("n"),i.push(Hb(s.x1.x)+" "+Hb(s.x1.y)+" m"),i.push(Hb(s.x2.x)+" "+Hb(s.x2.y)+" l"),i.push(Hb(s.x4.x)+" "+Hb(s.x4.y)+" m"),i.push(Hb(s.x3.x)+" "+Hb(s.x3.y)+" l"),i.push("s"),i.push("Q"),t.stream=i.join("\n"),t},OffPushDown:function(e){var t=Wb(e);t.scope=e.scope;var s=[];return s.push("0.749023 g"),s.push("0 0 "+Hb(Cx.internal.getWidth(e))+" "+Hb(Cx.internal.getHeight(e))+" re"),s.push("f"),t.stream=s.join("\n"),t}}},createDefaultAppearanceStream:function(e){var t=e.scope.internal.getFont(e.fontName,e.fontStyle).id,s=e.scope.__private__.encodeColorString(e.color);return"/"+t+" "+e.fontSize+" Tf "+s}};Cx.internal={Bezier_C:.551915024494,calculateCross:function(e){var t=Cx.internal.getWidth(e),s=Cx.internal.getHeight(e),i=Math.min(t,s);return{x1:{x:(t-i)/2,y:(s-i)/2+i},x2:{x:(t-i)/2+i,y:(s-i)/2},x3:{x:(t-i)/2,y:(s-i)/2},x4:{x:(t-i)/2+i,y:(s-i)/2+i}}}},Cx.internal.getWidth=function(e){var t=0;return"object"===fy(e)&&(t=Jb(e.Rect[2])),t},Cx.internal.getHeight=function(e){var t=0;return"object"===fy(e)&&(t=Jb(e.Rect[3])),t};var Nx,Tx,Ax=Bb.addField=function(e){if(ox(this,e),!(e instanceof fx))throw new Error("Invalid argument passed to jsPDF.addField.");var t;return(t=e).scope.internal.acroformPlugin.printedOut&&(t.scope.internal.acroformPlugin.printedOut=!1,t.scope.internal.acroformPlugin.acroFormDictionaryRoot=null),t.scope.internal.acroformPlugin.acroFormDictionaryRoot.Fields.push(t),e.page=e.scope.internal.getCurrentPageInfo().pageNumber,this};function Ex(e){return e.reduce(function(e,t,s){return e[t]=s,e},{})}Bb.AcroFormChoiceField=mx,Bb.AcroFormListBox=px,Bb.AcroFormComboBox=gx,Bb.AcroFormEditBox=vx,Bb.AcroFormButton=yx,Bb.AcroFormPushButton=bx,Bb.AcroFormRadioButton=xx,Bb.AcroFormCheckBox=Sx,Bb.AcroFormTextField=kx,Bb.AcroFormPasswordField=_x,Bb.AcroFormAppearance=Cx,Bb.AcroForm={ChoiceField:mx,ListBox:px,ComboBox:gx,EditBox:vx,Button:yx,PushButton:bx,RadioButton:xx,CheckBox:Sx,TextField:kx,PasswordField:_x,Appearance:Cx},Fb.AcroForm={ChoiceField:mx,ListBox:px,ComboBox:gx,EditBox:vx,Button:yx,PushButton:bx,RadioButton:xx,CheckBox:Sx,TextField:kx,PasswordField:_x,Appearance:Cx},Fb.AcroForm,function(e){e.__addimage__={};var t="UNKNOWN",s={PNG:[[137,80,78,71]],TIFF:[[77,77,0,42],[73,73,42,0]],JPEG:[[255,216,255,224,void 0,void 0,74,70,73,70,0],[255,216,255,225,void 0,void 0,69,120,105,102,0,0],[255,216,255,219],[255,216,255,238]],JPEG2000:[[0,0,0,12,106,80,32,32]],GIF87a:[[71,73,70,56,55,97]],GIF89a:[[71,73,70,56,57,97]],WEBP:[[82,73,70,70,void 0,void 0,void 0,void 0,87,69,66,80]],BMP:[[66,77],[66,65],[67,73],[67,80],[73,67],[80,84]]},i=e.__addimage__.getImageFileTypeByImageData=function(e,i){var n,r,a,o,l,c=t;if("RGBA"===(i=i||t)||void 0!==e.data&&e.data instanceof Uint8ClampedArray&&"height"in e&&"width"in e)return"RGBA";if(S(e))for(l in s)for(a=s[l],n=0;n<a.length;n+=1){for(o=!0,r=0;r<a[n].length;r+=1)if(void 0!==a[n][r]&&a[n][r]!==e[r]){o=!1;break}if(!0===o){c=l;break}}else for(l in s)for(a=s[l],n=0;n<a.length;n+=1){for(o=!0,r=0;r<a[n].length;r+=1)if(void 0!==a[n][r]&&a[n][r]!==e.charCodeAt(r)){o=!1;break}if(!0===o){c=l;break}}return c===t&&i!==t&&(c=i),c},n=function e(t){for(var s=this.internal.write,i=this.internal.putStream,n=(0,this.internal.getFilters)();-1!==n.indexOf("FlateEncode");)n.splice(n.indexOf("FlateEncode"),1);t.objectId=this.internal.newObject();var r=[];if(r.push({key:"Type",value:"/XObject"}),r.push({key:"Subtype",value:"/Image"}),r.push({key:"Width",value:t.width}),r.push({key:"Height",value:t.height}),t.colorSpace===g.INDEXED?r.push({key:"ColorSpace",value:"[/Indexed /DeviceRGB "+(t.palette.length/3-1)+" "+("sMask"in t&&void 0!==t.sMask?t.objectId+2:t.objectId+1)+" 0 R]"}):(r.push({key:"ColorSpace",value:"/"+t.colorSpace}),t.colorSpace===g.DEVICE_CMYK&&r.push({key:"Decode",value:"[1 0 1 0 1 0 1 0]"})),r.push({key:"BitsPerComponent",value:t.bitsPerComponent}),"decodeParameters"in t&&void 0!==t.decodeParameters&&r.push({key:"DecodeParms",value:"<<"+t.decodeParameters+">>"}),"transparency"in t&&Array.isArray(t.transparency)){for(var a="",o=0,l=t.transparency.length;o<l;o++)a+=t.transparency[o]+" "+t.transparency[o]+" ";r.push({key:"Mask",value:"["+a+"]"})}void 0!==t.sMask&&r.push({key:"SMask",value:t.objectId+1+" 0 R"});var c=void 0!==t.filter?["/"+t.filter]:void 0;if(i({data:t.data,additionalKeyValues:r,alreadyAppliedFilters:c,objectId:t.objectId}),s("endobj"),"sMask"in t&&void 0!==t.sMask){var d="/Predictor "+t.predictor+" /Colors 1 /BitsPerComponent "+t.bitsPerComponent+" /Columns "+t.width,u={width:t.width,height:t.height,colorSpace:"DeviceGray",bitsPerComponent:t.bitsPerComponent,decodeParameters:d,data:t.sMask};"filter"in t&&(u.filter=t.filter),e.call(this,u)}if(t.colorSpace===g.INDEXED){var h=this.internal.newObject();i({data:_(new Uint8Array(t.palette)),objectId:h}),s("endobj")}},r=function(){var e=this.internal.collections.addImage_images;for(var t in e)n.call(this,e[t])},a=function(){var e,t=this.internal.collections.addImage_images,s=this.internal.write;for(var i in t)s("/I"+(e=t[i]).index,e.objectId,"0","R")},o=function(){this.internal.collections.addImage_images||(this.internal.collections.addImage_images={},this.internal.events.subscribe("putResources",r),this.internal.events.subscribe("putXobjectDict",a))},l=function(){var e=this.internal.collections.addImage_images;return o.call(this),e},c=function(){return Object.keys(this.internal.collections.addImage_images).length},d=function(t){return"function"==typeof e["process"+t.toUpperCase()]},u=function(e){return"object"===fy(e)&&1===e.nodeType},h=function(t,s){if("IMG"===t.nodeName&&t.hasAttribute("src")){var i=""+t.getAttribute("src");if(0===i.indexOf("data:image/"))return hb(unescape(i).split("base64,").pop());var n=e.loadFile(i,!0);if(void 0!==n)return n}if("CANVAS"===t.nodeName){if(0===t.width||0===t.height)throw new Error("Given canvas must have data. Canvas width: "+t.width+", height: "+t.height);var r;switch(s){case"PNG":r="image/png";break;case"WEBP":r="image/webp";break;default:r="image/jpeg"}return hb(t.toDataURL(r,1).split("base64,").pop())}},f=function(e){var t=this.internal.collections.addImage_images;if(t)for(var s in t)if(e===t[s].alias)return t[s]},m=function(e,t,s){return e||t||(e=-96,t=-96),e<0&&(e=-1*s.width*72/e/this.internal.scaleFactor),t<0&&(t=-1*s.height*72/t/this.internal.scaleFactor),0===e&&(e=t*s.width/s.height),0===t&&(t=e*s.height/s.width),[e,t]},p=function(e,t,s,i,n,r){var a=m.call(this,s,i,n),o=this.internal.getCoordinateString,c=this.internal.getVerticalCoordinateString,d=l.call(this);if(s=a[0],i=a[1],d[n.index]=n,r){r*=Math.PI/180;var u=Math.cos(r),h=Math.sin(r),f=function(e){return e.toFixed(4)},p=[f(u),f(h),f(-1*h),f(u),0,0,"cm"]}this.internal.write("q"),r?(this.internal.write([1,"0","0",1,o(e),c(t+i),"cm"].join(" ")),this.internal.write(p.join(" ")),this.internal.write([o(s),"0","0",o(i),"0","0","cm"].join(" "))):this.internal.write([o(s),"0","0",o(i),o(e),c(t+i),"cm"].join(" ")),this.isAdvancedAPI()&&this.internal.write([1,0,0,-1,0,0,"cm"].join(" ")),this.internal.write("/I"+n.index+" Do"),this.internal.write("Q")},g=e.color_spaces={DEVICE_RGB:"DeviceRGB",DEVICE_GRAY:"DeviceGray",DEVICE_CMYK:"DeviceCMYK",CAL_GREY:"CalGray",CAL_RGB:"CalRGB",LAB:"Lab",ICC_BASED:"ICCBased",INDEXED:"Indexed",PATTERN:"Pattern",SEPARATION:"Separation",DEVICE_N:"DeviceN"};e.decode={DCT_DECODE:"DCTDecode",FLATE_DECODE:"FlateDecode",LZW_DECODE:"LZWDecode",JPX_DECODE:"JPXDecode",JBIG2_DECODE:"JBIG2Decode",ASCII85_DECODE:"ASCII85Decode",ASCII_HEX_DECODE:"ASCIIHexDecode",RUN_LENGTH_DECODE:"RunLengthDecode",CCITT_FAX_DECODE:"CCITTFaxDecode"};var v=e.image_compression={NONE:"NONE",FAST:"FAST",MEDIUM:"MEDIUM",SLOW:"SLOW"},y=e.__addimage__.sHashCode=function(e){var t,s,i=0;if("string"==typeof e)for(s=e.length,t=0;t<s;t++)i=(i<<5)-i+e.charCodeAt(t),i|=0;else if(S(e))for(s=e.byteLength/2,t=0;t<s;t++)i=(i<<5)-i+e[t],i|=0;return i},b=e.__addimage__.validateStringAsBase64=function(e){(e=e||"").toString().trim();var t=!0;return 0===e.length&&(t=!1),e.length%4!=0&&(t=!1),!1===/^[A-Za-z0-9+/]+$/.test(e.substr(0,e.length-2))&&(t=!1),!1===/^[A-Za-z0-9/][A-Za-z0-9+/]|[A-Za-z0-9+/]=|==$/.test(e.substr(-2))&&(t=!1),t},x=e.__addimage__.extractImageFromDataUrl=function(e){var t=(e=e||"").split("base64,"),s=null;if(2===t.length){var i=/^data:(\w*\/\w*);*(charset=(?!charset=)[\w=-]*)*;*$/.exec(t[0]);Array.isArray(i)&&(s={mimeType:i[1],charset:i[2],data:t[1]})}return s},w=e.__addimage__.supportsArrayBuffer=function(){return"undefined"!=typeof ArrayBuffer&&"undefined"!=typeof Uint8Array};e.__addimage__.isArrayBuffer=function(e){return w()&&e instanceof ArrayBuffer};var S=e.__addimage__.isArrayBufferView=function(e){return w()&&"undefined"!=typeof Uint32Array&&(e instanceof Int8Array||e instanceof Uint8Array||"undefined"!=typeof Uint8ClampedArray&&e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array)},k=e.__addimage__.binaryStringToUint8Array=function(e){for(var t=e.length,s=new Uint8Array(t),i=0;i<t;i++)s[i]=e.charCodeAt(i);return s},_=e.__addimage__.arrayBufferToBinaryString=function(e){for(var t="",s=S(e)?e:new Uint8Array(e),i=0;i<s.length;i+=8192)t+=String.fromCharCode.apply(null,s.subarray(i,i+8192));return t};e.addImage=function(){var e,s,i,n,r,a,l,c,d;if("number"==typeof arguments[1]?(s=t,i=arguments[1],n=arguments[2],r=arguments[3],a=arguments[4],l=arguments[5],c=arguments[6],d=arguments[7]):(s=arguments[1],i=arguments[2],n=arguments[3],r=arguments[4],a=arguments[5],l=arguments[6],c=arguments[7],d=arguments[8]),"object"===fy(e=arguments[0])&&!u(e)&&"imageData"in e){var h=e;e=h.imageData,s=h.format||s||t,i=h.x||i||0,n=h.y||n||0,r=h.w||h.width||r,a=h.h||h.height||a,l=h.alias||l,c=h.compression||c,d=h.rotation||h.angle||d}var f=this.internal.getFilters();if(void 0===c&&-1!==f.indexOf("FlateEncode")&&(c="SLOW"),isNaN(i)||isNaN(n))throw new Error("Invalid coordinates passed to jsPDF.addImage");o.call(this);var m=C.call(this,e,s,l,c);return p.call(this,i,n,r,a,m,d),this};var C=function(s,n,r,a){var o,l,m,p;if("string"==typeof s&&i(s)===t){s=unescape(s);var g=N(s,!1);(""!==g||void 0!==(g=e.loadFile(s,!0)))&&(s=g)}if(u(s)&&(s=h(s,n)),n=i(s,n),!d(n))throw new Error("addImage does not support files of type '"+n+"', please ensure that a plugin for '"+n+"' support is added.");if((null==(m=r)||0===m.length)&&(r="string"==typeof(p=s)||S(p)?y(p):S(p.data)?y(p.data):null),(o=f.call(this,r))||(w()&&(s instanceof Uint8Array||"RGBA"===n||(l=s,s=k(s))),o=this["process"+n.toUpperCase()](s,c.call(this),r,function(t){return t&&"string"==typeof t&&(t=t.toUpperCase()),t in e.image_compression?t:v.NONE}(a),l)),!o)throw new Error("An unknown error occurred whilst processing the image.");return o},N=e.__addimage__.convertBase64ToBinaryString=function(e,t){var s;t="boolean"!=typeof t||t;var i,n="";if("string"==typeof e){i=null!==(s=x(e))?s.data:e;try{n=hb(i)}catch(r){if(t)throw b(i)?new Error("atob-Error in jsPDF.convertBase64ToBinaryString "+r.message):new Error("Supplied Data is not a valid base64-String jsPDF.convertBase64ToBinaryString ")}}return n};e.getImageProperties=function(s){var n,r,a="";if(u(s)&&(s=h(s)),"string"==typeof s&&i(s)===t&&(""===(a=N(s,!1))&&(a=e.loadFile(s)||""),s=a),r=i(s),!d(r))throw new Error("addImage does not support files of type '"+r+"', please ensure that a plugin for '"+r+"' support is added.");if(!w()||s instanceof Uint8Array||(s=k(s)),!(n=this["process"+r.toUpperCase()](s)))throw new Error("An unknown error occurred whilst processing the image");return n.fileType=r,n}}(Fb.API),
/**
 * @license
 * Copyright (c) 2014 Steven Spungin (TwelveTone LLC)  steven@twelvetone.tv
 *
 * Licensed under the MIT License.
 * http://opensource.org/licenses/mit-license
 */
Nx=Fb.API,Tx=function(e){if(void 0!==e&&""!=e)return!0},Fb.API.events.push(["addPage",function(e){this.internal.getPageInfo(e.pageNumber).pageContext.annotations=[]}]),Nx.events.push(["putPage",function(e){for(var t,s,i,n=this.internal.getCoordinateString,r=this.internal.getVerticalCoordinateString,a=this.internal.getPageInfoByObjId(e.objId),o=e.pageContext.annotations,l=!1,c=0;c<o.length&&!l;c++)switch((t=o[c]).type){case"link":(Tx(t.options.url)||Tx(t.options.pageNumber))&&(l=!0);break;case"reference":case"text":case"freetext":l=!0}if(0!=l){this.internal.write("/Annots [");for(var d=0;d<o.length;d++){t=o[d];var u=this.internal.pdfEscape,h=this.internal.getEncryptor(e.objId);switch(t.type){case"reference":this.internal.write(" "+t.object.objId+" 0 R ");break;case"text":var f=this.internal.newAdditionalObject(),m=this.internal.newAdditionalObject(),p=this.internal.getEncryptor(f.objId),g=t.title||"Note";i="<</Type /Annot /Subtype /Text "+(s="/Rect ["+n(t.bounds.x)+" "+r(t.bounds.y+t.bounds.h)+" "+n(t.bounds.x+t.bounds.w)+" "+r(t.bounds.y)+"] ")+"/Contents ("+u(p(t.contents))+")",i+=" /Popup "+m.objId+" 0 R",i+=" /P "+a.objId+" 0 R",i+=" /T ("+u(p(g))+") >>",f.content=i;var v=f.objId+" 0 R";i="<</Type /Annot /Subtype /Popup "+(s="/Rect ["+n(t.bounds.x+30)+" "+r(t.bounds.y+t.bounds.h)+" "+n(t.bounds.x+t.bounds.w+30)+" "+r(t.bounds.y)+"] ")+" /Parent "+v,t.open&&(i+=" /Open true"),i+=" >>",m.content=i,this.internal.write(f.objId,"0 R",m.objId,"0 R");break;case"freetext":s="/Rect ["+n(t.bounds.x)+" "+r(t.bounds.y)+" "+n(t.bounds.x+t.bounds.w)+" "+r(t.bounds.y+t.bounds.h)+"] ";var y=t.color||"#000000";i="<</Type /Annot /Subtype /FreeText "+s+"/Contents ("+u(h(t.contents))+")",i+=" /DS(font: Helvetica,sans-serif 12.0pt; text-align:left; color:#"+y+")",i+=" /Border [0 0 0]",i+=" >>",this.internal.write(i);break;case"link":if(t.options.name){var b=this.annotations._nameMap[t.options.name];t.options.pageNumber=b.page,t.options.top=b.y}else t.options.top||(t.options.top=0);if(s="/Rect ["+t.finalBounds.x+" "+t.finalBounds.y+" "+t.finalBounds.w+" "+t.finalBounds.h+"] ",i="",t.options.url)i="<</Type /Annot /Subtype /Link "+s+"/Border [0 0 0] /A <</S /URI /URI ("+u(h(t.options.url))+") >>";else if(t.options.pageNumber)switch(i="<</Type /Annot /Subtype /Link "+s+"/Border [0 0 0] /Dest ["+this.internal.getPageInfo(t.options.pageNumber).objId+" 0 R",t.options.magFactor=t.options.magFactor||"XYZ",t.options.magFactor){case"Fit":i+=" /Fit]";break;case"FitH":i+=" /FitH "+t.options.top+"]";break;case"FitV":t.options.left=t.options.left||0,i+=" /FitV "+t.options.left+"]";break;default:var x=r(t.options.top);t.options.left=t.options.left||0,void 0===t.options.zoom&&(t.options.zoom=0),i+=" /XYZ "+t.options.left+" "+x+" "+t.options.zoom+"]"}""!=i&&(i+=" >>",this.internal.write(i))}}this.internal.write("]")}}]),Nx.createAnnotation=function(e){var t=this.internal.getCurrentPageInfo();switch(e.type){case"link":this.link(e.bounds.x,e.bounds.y,e.bounds.w,e.bounds.h,e);break;case"text":case"freetext":t.pageContext.annotations.push(e)}},Nx.link=function(e,t,s,i,n){var r=this.internal.getCurrentPageInfo(),a=this.internal.getCoordinateString,o=this.internal.getVerticalCoordinateString;r.pageContext.annotations.push({finalBounds:{x:a(e),y:o(t),w:a(e+s),h:o(t+i)},options:n,type:"link"})},Nx.textWithLink=function(e,t,s,i){var n,r,a=this.getTextWidth(e),o=this.internal.getLineHeight()/this.internal.scaleFactor;if(void 0!==i.maxWidth){r=i.maxWidth;var l=this.splitTextToSize(e,r).length;n=Math.ceil(o*l)}else r=a,n=o;return this.text(e,t,s,i),s+=.2*o,"center"===i.align&&(t-=a/2),"right"===i.align&&(t-=a),this.link(t,s-o,r,n,i),a},Nx.getTextWidth=function(e){var t=this.internal.getFontSize();return this.getStringUnitWidth(e)*t/this.internal.scaleFactor},
/**
 * @license
 * Copyright (c) 2017 Aras Abbasi
 *
 * Licensed under the MIT License.
 * http://opensource.org/licenses/mit-license
 */
function(e){var t={1569:[65152],1570:[65153,65154],1571:[65155,65156],1572:[65157,65158],1573:[65159,65160],1574:[65161,65162,65163,65164],1575:[65165,65166],1576:[65167,65168,65169,65170],1577:[65171,65172],1578:[65173,65174,65175,65176],1579:[65177,65178,65179,65180],1580:[65181,65182,65183,65184],1581:[65185,65186,65187,65188],1582:[65189,65190,65191,65192],1583:[65193,65194],1584:[65195,65196],1585:[65197,65198],1586:[65199,65200],1587:[65201,65202,65203,65204],1588:[65205,65206,65207,65208],1589:[65209,65210,65211,65212],1590:[65213,65214,65215,65216],1591:[65217,65218,65219,65220],1592:[65221,65222,65223,65224],1593:[65225,65226,65227,65228],1594:[65229,65230,65231,65232],1601:[65233,65234,65235,65236],1602:[65237,65238,65239,65240],1603:[65241,65242,65243,65244],1604:[65245,65246,65247,65248],1605:[65249,65250,65251,65252],1606:[65253,65254,65255,65256],1607:[65257,65258,65259,65260],1608:[65261,65262],1609:[65263,65264,64488,64489],1610:[65265,65266,65267,65268],1649:[64336,64337],1655:[64477],1657:[64358,64359,64360,64361],1658:[64350,64351,64352,64353],1659:[64338,64339,64340,64341],1662:[64342,64343,64344,64345],1663:[64354,64355,64356,64357],1664:[64346,64347,64348,64349],1667:[64374,64375,64376,64377],1668:[64370,64371,64372,64373],1670:[64378,64379,64380,64381],1671:[64382,64383,64384,64385],1672:[64392,64393],1676:[64388,64389],1677:[64386,64387],1678:[64390,64391],1681:[64396,64397],1688:[64394,64395],1700:[64362,64363,64364,64365],1702:[64366,64367,64368,64369],1705:[64398,64399,64400,64401],1709:[64467,64468,64469,64470],1711:[64402,64403,64404,64405],1713:[64410,64411,64412,64413],1715:[64406,64407,64408,64409],1722:[64414,64415],1723:[64416,64417,64418,64419],1726:[64426,64427,64428,64429],1728:[64420,64421],1729:[64422,64423,64424,64425],1733:[64480,64481],1734:[64473,64474],1735:[64471,64472],1736:[64475,64476],1737:[64482,64483],1739:[64478,64479],1740:[64508,64509,64510,64511],1744:[64484,64485,64486,64487],1746:[64430,64431],1747:[64432,64433]},s={65247:{65154:65269,65156:65271,65160:65273,65166:65275},65248:{65154:65270,65156:65272,65160:65274,65166:65276},65165:{65247:{65248:{65258:65010}}},1617:{1612:64606,1613:64607,1614:64608,1615:64609,1616:64610}},i={1612:64606,1613:64607,1614:64608,1615:64609,1616:64610},n=[1570,1571,1573,1575];e.__arabicParser__={};var r=e.__arabicParser__.isInArabicSubstitutionA=function(e){return void 0!==t[e.charCodeAt(0)]},a=e.__arabicParser__.isArabicLetter=function(e){return"string"==typeof e&&/^[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]+$/.test(e)},o=e.__arabicParser__.isArabicEndLetter=function(e){return a(e)&&r(e)&&t[e.charCodeAt(0)].length<=2},l=e.__arabicParser__.isArabicAlfLetter=function(e){return a(e)&&n.indexOf(e.charCodeAt(0))>=0};e.__arabicParser__.arabicLetterHasIsolatedForm=function(e){return a(e)&&r(e)&&t[e.charCodeAt(0)].length>=1};var c=e.__arabicParser__.arabicLetterHasFinalForm=function(e){return a(e)&&r(e)&&t[e.charCodeAt(0)].length>=2};e.__arabicParser__.arabicLetterHasInitialForm=function(e){return a(e)&&r(e)&&t[e.charCodeAt(0)].length>=3};var d=e.__arabicParser__.arabicLetterHasMedialForm=function(e){return a(e)&&r(e)&&4==t[e.charCodeAt(0)].length},u=e.__arabicParser__.resolveLigatures=function(e){var t=0,i=s,n="",r=0;for(t=0;t<e.length;t+=1)void 0!==i[e.charCodeAt(t)]?(r++,"number"==typeof(i=i[e.charCodeAt(t)])&&(n+=String.fromCharCode(i),i=s,r=0),t===e.length-1&&(i=s,n+=e.charAt(t-(r-1)),t-=r-1,r=0)):(i=s,n+=e.charAt(t-r),t-=r,r=0);return n};e.__arabicParser__.isArabicDiacritic=function(e){return void 0!==e&&void 0!==i[e.charCodeAt(0)]};var h=e.__arabicParser__.getCorrectForm=function(e,t,s){return a(e)?!1===r(e)?-1:!c(e)||!a(t)&&!a(s)||!a(s)&&o(t)||o(e)&&!a(t)||o(e)&&l(t)||o(e)&&o(t)?0:d(e)&&a(t)&&!o(t)&&a(s)&&c(s)?3:o(e)||!a(s)?1:2:-1},f=function(e){var s=0,i=0,n=0,r="",o="",l="",c=(e=e||"").split("\\s+"),d=[];for(s=0;s<c.length;s+=1){for(d.push(""),i=0;i<c[s].length;i+=1)r=c[s][i],o=c[s][i-1],l=c[s][i+1],a(r)?(n=h(r,o,l),d[s]+=-1!==n?String.fromCharCode(t[r.charCodeAt(0)][n]):r):d[s]+=r;d[s]=u(d[s])}return d.join(" ")},m=e.__arabicParser__.processArabic=e.processArabic=function(){var e,t="string"==typeof arguments[0]?arguments[0]:arguments[0].text,s=[];if(Array.isArray(t)){var i=0;for(s=[],i=0;i<t.length;i+=1)Array.isArray(t[i])?s.push([f(t[i][0]),t[i][1],t[i][2]]):s.push([f(t[i])]);e=s}else e=f(t);return"string"==typeof arguments[0]?e:(arguments[0].text=e,arguments[0])};e.events.push(["preProcessText",m])}(Fb.API),Fb.API.autoPrint=function(e){var t;if("javascript"===((e=e||{}).variant=e.variant||"non-conform",e.variant))this.addJS("print({});");else this.internal.events.subscribe("postPutResources",function(){t=this.internal.newObject(),this.internal.out("<<"),this.internal.out("/S /Named"),this.internal.out("/Type /Action"),this.internal.out("/N /Print"),this.internal.out(">>"),this.internal.out("endobj")}),this.internal.events.subscribe("putCatalog",function(){this.internal.out("/OpenAction "+t+" 0 R")});return this},
/**
 * @license
 * Copyright (c) 2014 Steven Spungin (TwelveTone LLC)  steven@twelvetone.tv
 *
 * Licensed under the MIT License.
 * http://opensource.org/licenses/mit-license
 */
function(e){var t=function(){var e=void 0;Object.defineProperty(this,"pdf",{get:function(){return e},set:function(t){e=t}});var t=150;Object.defineProperty(this,"width",{get:function(){return t},set:function(e){t=isNaN(e)||!1===Number.isInteger(e)||e<0?150:e,this.getContext("2d").pageWrapXEnabled&&(this.getContext("2d").pageWrapX=t+1)}});var s=300;Object.defineProperty(this,"height",{get:function(){return s},set:function(e){s=isNaN(e)||!1===Number.isInteger(e)||e<0?300:e,this.getContext("2d").pageWrapYEnabled&&(this.getContext("2d").pageWrapY=s+1)}});var i=[];Object.defineProperty(this,"childNodes",{get:function(){return i},set:function(e){i=e}});var n={};Object.defineProperty(this,"style",{get:function(){return n},set:function(e){n=e}}),Object.defineProperty(this,"parentNode",{})};t.prototype.getContext=function(e,t){var s;if("2d"!==(e=e||"2d"))return null;for(s in t)this.pdf.context2d.hasOwnProperty(s)&&(this.pdf.context2d[s]=t[s]);return this.pdf.context2d._canvas=this,this.pdf.context2d},t.prototype.toDataURL=function(){throw new Error("toDataURL is not implemented.")},e.events.push(["initialized",function(){this.canvas=new t,this.canvas.pdf=this}])}(Fb.API),function(e){var t={left:0,top:0,bottom:0,right:0},s=!1,i=function(){void 0===this.internal.__cell__&&(this.internal.__cell__={},this.internal.__cell__.padding=3,this.internal.__cell__.headerFunction=void 0,this.internal.__cell__.margins=Object.assign({},t),this.internal.__cell__.margins.width=this.getPageWidth(),n.call(this))},n=function(){this.internal.__cell__.lastCell=new r,this.internal.__cell__.pages=1},r=function(){var e=arguments[0];Object.defineProperty(this,"x",{enumerable:!0,get:function(){return e},set:function(t){e=t}});var t=arguments[1];Object.defineProperty(this,"y",{enumerable:!0,get:function(){return t},set:function(e){t=e}});var s=arguments[2];Object.defineProperty(this,"width",{enumerable:!0,get:function(){return s},set:function(e){s=e}});var i=arguments[3];Object.defineProperty(this,"height",{enumerable:!0,get:function(){return i},set:function(e){i=e}});var n=arguments[4];Object.defineProperty(this,"text",{enumerable:!0,get:function(){return n},set:function(e){n=e}});var r=arguments[5];Object.defineProperty(this,"lineNumber",{enumerable:!0,get:function(){return r},set:function(e){r=e}});var a=arguments[6];return Object.defineProperty(this,"align",{enumerable:!0,get:function(){return a},set:function(e){a=e}}),this};r.prototype.clone=function(){return new r(this.x,this.y,this.width,this.height,this.text,this.lineNumber,this.align)},r.prototype.toArray=function(){return[this.x,this.y,this.width,this.height,this.text,this.lineNumber,this.align]},e.setHeaderFunction=function(e){return i.call(this),this.internal.__cell__.headerFunction="function"==typeof e?e:void 0,this},e.getTextDimensions=function(e,t){i.call(this);var s=(t=t||{}).fontSize||this.getFontSize(),n=t.font||this.getFont(),r=t.scaleFactor||this.internal.scaleFactor,a=0,o=0,l=0,c=this;if(!Array.isArray(e)&&"string"!=typeof e){if("number"!=typeof e)throw new Error("getTextDimensions expects text-parameter to be of type String or type Number or an Array of Strings.");e=String(e)}var d=t.maxWidth;d>0?"string"==typeof e?e=this.splitTextToSize(e,d):"[object Array]"===Object.prototype.toString.call(e)&&(e=e.reduce(function(e,t){return e.concat(c.splitTextToSize(t,d))},[])):e=Array.isArray(e)?e:[e];for(var u=0;u<e.length;u++)a<(l=this.getStringUnitWidth(e[u],{font:n})*s)&&(a=l);return 0!==a&&(o=e.length),{w:a/=r,h:Math.max((o*s*this.getLineHeightFactor()-s*(this.getLineHeightFactor()-1))/r,0)}},e.cellAddPage=function(){i.call(this),this.addPage();var e=this.internal.__cell__.margins||t;return this.internal.__cell__.lastCell=new r(e.left,e.top,void 0,void 0),this.internal.__cell__.pages+=1,this};var a=e.cell=function(){var e;e=arguments[0]instanceof r?arguments[0]:new r(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5]),i.call(this);var n=this.internal.__cell__.lastCell,a=this.internal.__cell__.padding,o=this.internal.__cell__.margins||t,l=this.internal.__cell__.tableHeaderRow,c=this.internal.__cell__.printHeaders;return void 0!==n.lineNumber&&(n.lineNumber===e.lineNumber?(e.x=(n.x||0)+(n.width||0),e.y=n.y||0):n.y+n.height+e.height+o.bottom>this.getPageHeight()?(this.cellAddPage(),e.y=o.top,c&&l&&(this.printHeaderRow(e.lineNumber,!0),e.y+=l[0].height)):e.y=n.y+n.height||e.y),void 0!==e.text[0]&&(this.rect(e.x,e.y,e.width,e.height,!0===s?"FD":void 0),"right"===e.align?this.text(e.text,e.x+e.width-a,e.y+a,{align:"right",baseline:"top"}):"center"===e.align?this.text(e.text,e.x+e.width/2,e.y+a,{align:"center",baseline:"top",maxWidth:e.width-a-a}):this.text(e.text,e.x+a,e.y+a,{align:"left",baseline:"top",maxWidth:e.width-a-a})),this.internal.__cell__.lastCell=e,this};e.table=function(e,s,l,c,d){if(i.call(this),!l)throw new Error("No data for PDF table.");var u,h,f,m,p=[],g=[],v=[],y={},b={},x=[],w=[],S=(d=d||{}).autoSize||!1,k=!1!==d.printHeaders,_=d.css&&void 0!==d.css["font-size"]?16*d.css["font-size"]:d.fontSize||12,C=d.margins||Object.assign({width:this.getPageWidth()},t),N="number"==typeof d.padding?d.padding:3,T=d.headerBackgroundColor||"#c8c8c8",A=d.headerTextColor||"#000";if(n.call(this),this.internal.__cell__.printHeaders=k,this.internal.__cell__.margins=C,this.internal.__cell__.table_font_size=_,this.internal.__cell__.padding=N,this.internal.__cell__.headerBackgroundColor=T,this.internal.__cell__.headerTextColor=A,this.setFontSize(_),null==c)g=p=Object.keys(l[0]),v=p.map(function(){return"left"});else if(Array.isArray(c)&&"object"===fy(c[0]))for(p=c.map(function(e){return e.name}),g=c.map(function(e){return e.prompt||e.name||""}),v=c.map(function(e){return e.align||"left"}),u=0;u<c.length;u+=1)b[c[u].name]=c[u].width*(19.049976/25.4);else Array.isArray(c)&&"string"==typeof c[0]&&(g=p=c,v=p.map(function(){return"left"}));if(S||Array.isArray(c)&&"string"==typeof c[0])for(u=0;u<p.length;u+=1){for(y[m=p[u]]=l.map(function(e){return e[m]}),this.setFont(void 0,"bold"),x.push(this.getTextDimensions(g[u],{fontSize:this.internal.__cell__.table_font_size,scaleFactor:this.internal.scaleFactor}).w),h=y[m],this.setFont(void 0,"normal"),f=0;f<h.length;f+=1)x.push(this.getTextDimensions(h[f],{fontSize:this.internal.__cell__.table_font_size,scaleFactor:this.internal.scaleFactor}).w);b[m]=Math.max.apply(null,x)+N+N,x=[]}if(k){var E={};for(u=0;u<p.length;u+=1)E[p[u]]={},E[p[u]].text=g[u],E[p[u]].align=v[u];var j=o.call(this,E,b);w=p.map(function(t){return new r(e,s,b[t],j,E[t].text,void 0,E[t].align)}),this.setTableHeaderRow(w),this.printHeaderRow(1,!1)}var P=c.reduce(function(e,t){return e[t.name]=t.align,e},{});for(u=0;u<l.length;u+=1){"rowStart"in d&&d.rowStart instanceof Function&&d.rowStart({row:u,data:l[u]},this);var I=o.call(this,l[u],b);for(f=0;f<p.length;f+=1){var L=l[u][p[f]];"cellStart"in d&&d.cellStart instanceof Function&&d.cellStart({row:u,col:f,data:L},this),a.call(this,new r(e,s,b[p[f]],I,L,u+2,P[p[f]]))}}return this.internal.__cell__.table_x=e,this.internal.__cell__.table_y=s,this};var o=function(e,t){var s=this.internal.__cell__.padding,i=this.internal.__cell__.table_font_size,n=this.internal.scaleFactor;return Object.keys(e).map(function(i){var n=e[i];return this.splitTextToSize(n.hasOwnProperty("text")?n.text:n,t[i]-s-s)},this).map(function(e){return this.getLineHeightFactor()*e.length*i/n+s+s},this).reduce(function(e,t){return Math.max(e,t)},0)};e.setTableHeaderRow=function(e){i.call(this),this.internal.__cell__.tableHeaderRow=e},e.printHeaderRow=function(e,t){if(i.call(this),!this.internal.__cell__.tableHeaderRow)throw new Error("Property tableHeaderRow does not exist.");var n;if(s=!0,"function"==typeof this.internal.__cell__.headerFunction){var o=this.internal.__cell__.headerFunction(this,this.internal.__cell__.pages);this.internal.__cell__.lastCell=new r(o[0],o[1],o[2],o[3],void 0,-1)}this.setFont(void 0,"bold");for(var l=[],c=0;c<this.internal.__cell__.tableHeaderRow.length;c+=1){n=this.internal.__cell__.tableHeaderRow[c].clone(),t&&(n.y=this.internal.__cell__.margins.top||0,l.push(n)),n.lineNumber=e;var d=this.getTextColor();this.setTextColor(this.internal.__cell__.headerTextColor),this.setFillColor(this.internal.__cell__.headerBackgroundColor),a.call(this,n),this.setTextColor(d)}l.length>0&&this.setTableHeaderRow(l),this.setFont(void 0,"normal"),s=!1}}(Fb.API);var jx={italic:["italic","oblique","normal"],oblique:["oblique","italic","normal"],normal:["normal","oblique","italic"]},Px=["ultra-condensed","extra-condensed","condensed","semi-condensed","normal","semi-expanded","expanded","extra-expanded","ultra-expanded"],Ix=Ex(Px),Lx=[100,200,300,400,500,600,700,800,900],Rx=Ex(Lx);function Ox(e){var t,s=e.family.replace(/"|'/g,"").toLowerCase(),i=(t=e.style,jx[t=t||"normal"]?t:"normal"),n=function(e){return e?"number"==typeof e?e>=100&&e<=900&&e%100==0?e:400:/^\d00$/.test(e)?parseInt(e):"bold"===e?700:400:400}(e.weight),r=function(e){return"number"==typeof Ix[e=e||"normal"]?e:"normal"}(e.stretch);return{family:s,style:i,weight:n,stretch:r,src:e.src||[],ref:e.ref||{name:s,style:[r,i,n].join(" ")}}}function Dx(e,t,s,i){var n;for(n=s;n>=0&&n<t.length;n+=i)if(e[t[n]])return e[t[n]];for(n=s;n>=0&&n<t.length;n-=i)if(e[t[n]])return e[t[n]]}var Mx={"sans-serif":"helvetica",fixed:"courier",monospace:"courier",terminal:"courier",cursive:"times",fantasy:"times",serif:"times"},Ux={caption:"times",icon:"times",menu:"times","message-box":"times","small-caption":"times","status-bar":"times"};function Fx(e){return[e.stretch,e.style,e.weight,e.family].join(" ")}function Bx(e){return e.trimLeft()}function qx(e,t){for(var s=0;s<e.length;){if(e.charAt(s)===t)return[e.substring(0,s),e.substring(s+1)];s+=1}return null}function $x(e){var t=e.match(/^(-[a-z_]|[a-z_])[a-z0-9_-]*/i);return null===t?null:[t[0],e.substring(t[0].length)]}var zx,Hx,Vx,Gx=["times"];!function(e){var t,s,i,n,r,a,o,l,c,d=function(e){return e=e||{},this.isStrokeTransparent=e.isStrokeTransparent||!1,this.strokeOpacity=e.strokeOpacity||1,this.strokeStyle=e.strokeStyle||"#000000",this.fillStyle=e.fillStyle||"#000000",this.isFillTransparent=e.isFillTransparent||!1,this.fillOpacity=e.fillOpacity||1,this.font=e.font||"10px sans-serif",this.textBaseline=e.textBaseline||"alphabetic",this.textAlign=e.textAlign||"left",this.lineWidth=e.lineWidth||1,this.lineJoin=e.lineJoin||"miter",this.lineCap=e.lineCap||"butt",this.path=e.path||[],this.transform=void 0!==e.transform?e.transform.clone():new l,this.globalCompositeOperation=e.globalCompositeOperation||"normal",this.globalAlpha=e.globalAlpha||1,this.clip_path=e.clip_path||[],this.currentPoint=e.currentPoint||new a,this.miterLimit=e.miterLimit||10,this.lastPoint=e.lastPoint||new a,this.lineDashOffset=e.lineDashOffset||0,this.lineDash=e.lineDash||[],this.margin=e.margin||[0,0,0,0],this.prevPageLastElemOffset=e.prevPageLastElemOffset||0,this.ignoreClearRect="boolean"!=typeof e.ignoreClearRect||e.ignoreClearRect,this};e.events.push(["initialized",function(){this.context2d=new u(this),t=this.internal.f2,s=this.internal.getCoordinateString,i=this.internal.getVerticalCoordinateString,n=this.internal.getHorizontalCoordinate,r=this.internal.getVerticalCoordinate,a=this.internal.Point,o=this.internal.Rectangle,l=this.internal.Matrix,c=new d}]);var u=function(e){Object.defineProperty(this,"canvas",{get:function(){return{parentNode:!1,style:!1}}});var t=e;Object.defineProperty(this,"pdf",{get:function(){return t}});var s=!1;Object.defineProperty(this,"pageWrapXEnabled",{get:function(){return s},set:function(e){s=Boolean(e)}});var i=!1;Object.defineProperty(this,"pageWrapYEnabled",{get:function(){return i},set:function(e){i=Boolean(e)}});var n=0;Object.defineProperty(this,"posX",{get:function(){return n},set:function(e){isNaN(e)||(n=e)}});var r=0;Object.defineProperty(this,"posY",{get:function(){return r},set:function(e){isNaN(e)||(r=e)}}),Object.defineProperty(this,"margin",{get:function(){return c.margin},set:function(e){var t;"number"==typeof e?t=[e,e,e,e]:((t=new Array(4))[0]=e[0],t[1]=e.length>=2?e[1]:t[0],t[2]=e.length>=3?e[2]:t[0],t[3]=e.length>=4?e[3]:t[1]),c.margin=t}});var a=!1;Object.defineProperty(this,"autoPaging",{get:function(){return a},set:function(e){a=e}});var o=0;Object.defineProperty(this,"lastBreak",{get:function(){return o},set:function(e){o=e}});var l=[];Object.defineProperty(this,"pageBreaks",{get:function(){return l},set:function(e){l=e}}),Object.defineProperty(this,"ctx",{get:function(){return c},set:function(e){e instanceof d&&(c=e)}}),Object.defineProperty(this,"path",{get:function(){return c.path},set:function(e){c.path=e}});var u=[];Object.defineProperty(this,"ctxStack",{get:function(){return u},set:function(e){u=e}}),Object.defineProperty(this,"fillStyle",{get:function(){return this.ctx.fillStyle},set:function(e){var t;t=h(e),this.ctx.fillStyle=t.style,this.ctx.isFillTransparent=0===t.a,this.ctx.fillOpacity=t.a,this.pdf.setFillColor(t.r,t.g,t.b,{a:t.a}),this.pdf.setTextColor(t.r,t.g,t.b,{a:t.a})}}),Object.defineProperty(this,"strokeStyle",{get:function(){return this.ctx.strokeStyle},set:function(e){var t=h(e);this.ctx.strokeStyle=t.style,this.ctx.isStrokeTransparent=0===t.a,this.ctx.strokeOpacity=t.a,0===t.a?this.pdf.setDrawColor(255,255,255):(t.a,this.pdf.setDrawColor(t.r,t.g,t.b))}}),Object.defineProperty(this,"lineCap",{get:function(){return this.ctx.lineCap},set:function(e){-1!==["butt","round","square"].indexOf(e)&&(this.ctx.lineCap=e,this.pdf.setLineCap(e))}}),Object.defineProperty(this,"lineWidth",{get:function(){return this.ctx.lineWidth},set:function(e){isNaN(e)||(this.ctx.lineWidth=e,this.pdf.setLineWidth(e))}}),Object.defineProperty(this,"lineJoin",{get:function(){return this.ctx.lineJoin},set:function(e){-1!==["bevel","round","miter"].indexOf(e)&&(this.ctx.lineJoin=e,this.pdf.setLineJoin(e))}}),Object.defineProperty(this,"miterLimit",{get:function(){return this.ctx.miterLimit},set:function(e){isNaN(e)||(this.ctx.miterLimit=e,this.pdf.setMiterLimit(e))}}),Object.defineProperty(this,"textBaseline",{get:function(){return this.ctx.textBaseline},set:function(e){this.ctx.textBaseline=e}}),Object.defineProperty(this,"textAlign",{get:function(){return this.ctx.textAlign},set:function(e){-1!==["right","end","center","left","start"].indexOf(e)&&(this.ctx.textAlign=e)}});var f=null;var m=null;Object.defineProperty(this,"fontFaces",{get:function(){return m},set:function(e){f=null,m=e}}),Object.defineProperty(this,"font",{get:function(){return this.ctx.font},set:function(e){var t;if(this.ctx.font=e,null!==(t=/^\s*(?=(?:(?:[-a-z]+\s*){0,2}(italic|oblique))?)(?=(?:(?:[-a-z]+\s*){0,2}(small-caps))?)(?=(?:(?:[-a-z]+\s*){0,2}(bold(?:er)?|lighter|[1-9]00))?)(?:(?:normal|\1|\2|\3)\s*){0,3}((?:xx?-)?(?:small|large)|medium|smaller|larger|[.\d]+(?:\%|in|[cem]m|ex|p[ctx]))(?:\s*\/\s*(normal|[.\d]+(?:\%|in|[cem]m|ex|p[ctx])))?\s*([-_,\"\'\sa-z]+?)\s*$/i.exec(e))){var s=t[1],i=(t[2],t[3]),n=t[4],r=(t[5],t[6]),a=/^([.\d]+)((?:%|in|[cem]m|ex|p[ctx]))$/i.exec(n)[2];n="px"===a?Math.floor(parseFloat(n)*this.pdf.internal.scaleFactor):"em"===a?Math.floor(parseFloat(n)*this.pdf.getFontSize()):Math.floor(parseFloat(n)*this.pdf.internal.scaleFactor),this.pdf.setFontSize(n);var o=function(e){var t,s,i=[],n=e.trim();if(""===n)return Gx;if(n in Ux)return[Ux[n]];for(;""!==n;){switch(s=null,t=(n=Bx(n)).charAt(0)){case'"':case"'":s=qx(n.substring(1),t);break;default:s=$x(n)}if(null===s)return Gx;if(i.push(s[0]),""!==(n=Bx(s[1]))&&","!==n.charAt(0))return Gx;n=n.replace(/^,/,"")}return i}(r);if(this.fontFaces){var l=function(e,t,s){for(var i=(s=s||{}).defaultFontFamily||"times",n=Object.assign({},Mx,s.genericFontFamilies||{}),r=null,a=null,o=0;o<t.length;++o)if(n[(r=Ox(t[o])).family]&&(r.family=n[r.family]),e.hasOwnProperty(r.family)){a=e[r.family];break}if(!(a=a||e[i]))throw new Error("Could not find a font-family for the rule '"+Fx(r)+"' and default family '"+i+"'.");if(a=function(e,t){if(t[e])return t[e];var s=Ix[e],i=s<=Ix.normal?-1:1,n=Dx(t,Px,s,i);if(!n)throw new Error("Could not find a matching font-stretch value for "+e);return n}(r.stretch,a),a=function(e,t){if(t[e])return t[e];for(var s=jx[e],i=0;i<s.length;++i)if(t[s[i]])return t[s[i]];throw new Error("Could not find a matching font-style for "+e)}(r.style,a),!(a=function(e,t){if(t[e])return t[e];if(400===e&&t[500])return t[500];if(500===e&&t[400])return t[400];var s=Rx[e],i=Dx(t,Lx,s,e<400?-1:1);if(!i)throw new Error("Could not find a matching font-weight for value "+e);return i}(r.weight,a)))throw new Error("Failed to resolve a font for the rule '"+Fx(r)+"'.");return a}(function(e,t){if(null===f){var s=(i=e.getFontList(),n=[],Object.keys(i).forEach(function(e){i[e].forEach(function(t){var s=null;switch(t){case"bold":s={family:e,weight:"bold"};break;case"italic":s={family:e,style:"italic"};break;case"bolditalic":s={family:e,weight:"bold",style:"italic"};break;case"":case"normal":s={family:e}}null!==s&&(s.ref={name:e,style:t},n.push(s))})}),n);f=function(e){for(var t={},s=0;s<e.length;++s){var i=Ox(e[s]),n=i.family,r=i.stretch,a=i.style,o=i.weight;t[n]=t[n]||{},t[n][r]=t[n][r]||{},t[n][r][a]=t[n][r][a]||{},t[n][r][a][o]=i}return t}(s.concat(t))}var i,n;return f}(this.pdf,this.fontFaces),o.map(function(e){return{family:e,stretch:"normal",weight:i,style:s}}));this.pdf.setFont(l.ref.name,l.ref.style)}else{var c="";("bold"===i||parseInt(i,10)>=700||"bold"===s)&&(c="bold"),"italic"===s&&(c+="italic"),0===c.length&&(c="normal");for(var d="",u={arial:"Helvetica",Arial:"Helvetica",verdana:"Helvetica",Verdana:"Helvetica",helvetica:"Helvetica",Helvetica:"Helvetica","sans-serif":"Helvetica",fixed:"Courier",monospace:"Courier",terminal:"Courier",cursive:"Times",fantasy:"Times",serif:"Times"},h=0;h<o.length;h++){if(void 0!==this.pdf.internal.getFont(o[h],c,{noFallback:!0,disableWarning:!0})){d=o[h];break}if("bolditalic"===c&&void 0!==this.pdf.internal.getFont(o[h],"bold",{noFallback:!0,disableWarning:!0}))d=o[h],c="bold";else if(void 0!==this.pdf.internal.getFont(o[h],"normal",{noFallback:!0,disableWarning:!0})){d=o[h],c="normal";break}}if(""===d)for(var m=0;m<o.length;m++)if(u[o[m]]){d=u[o[m]];break}d=""===d?"Times":d,this.pdf.setFont(d,c)}}}}),Object.defineProperty(this,"globalCompositeOperation",{get:function(){return this.ctx.globalCompositeOperation},set:function(e){this.ctx.globalCompositeOperation=e}}),Object.defineProperty(this,"globalAlpha",{get:function(){return this.ctx.globalAlpha},set:function(e){this.ctx.globalAlpha=e}}),Object.defineProperty(this,"lineDashOffset",{get:function(){return this.ctx.lineDashOffset},set:function(e){this.ctx.lineDashOffset=e,M.call(this)}}),Object.defineProperty(this,"lineDash",{get:function(){return this.ctx.lineDash},set:function(e){this.ctx.lineDash=e,M.call(this)}}),Object.defineProperty(this,"ignoreClearRect",{get:function(){return this.ctx.ignoreClearRect},set:function(e){this.ctx.ignoreClearRect=Boolean(e)}})};u.prototype.setLineDash=function(e){this.lineDash=e},u.prototype.getLineDash=function(){return this.lineDash.length%2?this.lineDash.concat(this.lineDash):this.lineDash.slice()},u.prototype.fill=function(){x.call(this,"fill",!1)},u.prototype.stroke=function(){x.call(this,"stroke",!1)},u.prototype.beginPath=function(){this.path=[{type:"begin"}]},u.prototype.moveTo=function(e,t){if(isNaN(e)||isNaN(t))throw lb.error("jsPDF.context2d.moveTo: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.moveTo");var s=this.ctx.transform.applyToPoint(new a(e,t));this.path.push({type:"mt",x:s.x,y:s.y}),this.ctx.lastPoint=new a(e,t)},u.prototype.closePath=function(){var e=new a(0,0),t=0;for(t=this.path.length-1;-1!==t;t--)if("begin"===this.path[t].type&&"object"===fy(this.path[t+1])&&"number"==typeof this.path[t+1].x){e=new a(this.path[t+1].x,this.path[t+1].y);break}this.path.push({type:"close"}),this.ctx.lastPoint=new a(e.x,e.y)},u.prototype.lineTo=function(e,t){if(isNaN(e)||isNaN(t))throw lb.error("jsPDF.context2d.lineTo: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.lineTo");var s=this.ctx.transform.applyToPoint(new a(e,t));this.path.push({type:"lt",x:s.x,y:s.y}),this.ctx.lastPoint=new a(s.x,s.y)},u.prototype.clip=function(){this.ctx.clip_path=JSON.parse(JSON.stringify(this.path)),x.call(this,null,!0)},u.prototype.quadraticCurveTo=function(e,t,s,i){if(isNaN(s)||isNaN(i)||isNaN(e)||isNaN(t))throw lb.error("jsPDF.context2d.quadraticCurveTo: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.quadraticCurveTo");var n=this.ctx.transform.applyToPoint(new a(s,i)),r=this.ctx.transform.applyToPoint(new a(e,t));this.path.push({type:"qct",x1:r.x,y1:r.y,x:n.x,y:n.y}),this.ctx.lastPoint=new a(n.x,n.y)},u.prototype.bezierCurveTo=function(e,t,s,i,n,r){if(isNaN(n)||isNaN(r)||isNaN(e)||isNaN(t)||isNaN(s)||isNaN(i))throw lb.error("jsPDF.context2d.bezierCurveTo: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.bezierCurveTo");var o=this.ctx.transform.applyToPoint(new a(n,r)),l=this.ctx.transform.applyToPoint(new a(e,t)),c=this.ctx.transform.applyToPoint(new a(s,i));this.path.push({type:"bct",x1:l.x,y1:l.y,x2:c.x,y2:c.y,x:o.x,y:o.y}),this.ctx.lastPoint=new a(o.x,o.y)},u.prototype.arc=function(e,t,s,i,n,r){if(isNaN(e)||isNaN(t)||isNaN(s)||isNaN(i)||isNaN(n))throw lb.error("jsPDF.context2d.arc: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.arc");if(r=Boolean(r),!this.ctx.transform.isIdentity){var o=this.ctx.transform.applyToPoint(new a(e,t));e=o.x,t=o.y;var l=this.ctx.transform.applyToPoint(new a(0,s)),c=this.ctx.transform.applyToPoint(new a(0,0));s=Math.sqrt(Math.pow(l.x-c.x,2)+Math.pow(l.y-c.y,2))}Math.abs(n-i)>=2*Math.PI&&(i=0,n=2*Math.PI),this.path.push({type:"arc",x:e,y:t,radius:s,startAngle:i,endAngle:n,counterclockwise:r})},u.prototype.arcTo=function(e,t,s,i,n){throw new Error("arcTo not implemented.")},u.prototype.rect=function(e,t,s,i){if(isNaN(e)||isNaN(t)||isNaN(s)||isNaN(i))throw lb.error("jsPDF.context2d.rect: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.rect");this.moveTo(e,t),this.lineTo(e+s,t),this.lineTo(e+s,t+i),this.lineTo(e,t+i),this.lineTo(e,t),this.lineTo(e+s,t),this.lineTo(e,t)},u.prototype.fillRect=function(e,t,s,i){if(isNaN(e)||isNaN(t)||isNaN(s)||isNaN(i))throw lb.error("jsPDF.context2d.fillRect: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.fillRect");if(!f.call(this)){var n={};"butt"!==this.lineCap&&(n.lineCap=this.lineCap,this.lineCap="butt"),"miter"!==this.lineJoin&&(n.lineJoin=this.lineJoin,this.lineJoin="miter"),this.beginPath(),this.rect(e,t,s,i),this.fill(),n.hasOwnProperty("lineCap")&&(this.lineCap=n.lineCap),n.hasOwnProperty("lineJoin")&&(this.lineJoin=n.lineJoin)}},u.prototype.strokeRect=function(e,t,s,i){if(isNaN(e)||isNaN(t)||isNaN(s)||isNaN(i))throw lb.error("jsPDF.context2d.strokeRect: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.strokeRect");m.call(this)||(this.beginPath(),this.rect(e,t,s,i),this.stroke())},u.prototype.clearRect=function(e,t,s,i){if(isNaN(e)||isNaN(t)||isNaN(s)||isNaN(i))throw lb.error("jsPDF.context2d.clearRect: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.clearRect");this.ignoreClearRect||(this.fillStyle="#ffffff",this.fillRect(e,t,s,i))},u.prototype.save=function(e){e="boolean"!=typeof e||e;for(var t=this.pdf.internal.getCurrentPageInfo().pageNumber,s=0;s<this.pdf.internal.getNumberOfPages();s++)this.pdf.setPage(s+1),this.pdf.internal.out("q");if(this.pdf.setPage(t),e){this.ctx.fontSize=this.pdf.internal.getFontSize();var i=new d(this.ctx);this.ctxStack.push(this.ctx),this.ctx=i}},u.prototype.restore=function(e){e="boolean"!=typeof e||e;for(var t=this.pdf.internal.getCurrentPageInfo().pageNumber,s=0;s<this.pdf.internal.getNumberOfPages();s++)this.pdf.setPage(s+1),this.pdf.internal.out("Q");this.pdf.setPage(t),e&&0!==this.ctxStack.length&&(this.ctx=this.ctxStack.pop(),this.fillStyle=this.ctx.fillStyle,this.strokeStyle=this.ctx.strokeStyle,this.font=this.ctx.font,this.lineCap=this.ctx.lineCap,this.lineWidth=this.ctx.lineWidth,this.lineJoin=this.ctx.lineJoin,this.lineDash=this.ctx.lineDash,this.lineDashOffset=this.ctx.lineDashOffset)},u.prototype.toDataURL=function(){throw new Error("toDataUrl not implemented.")};var h=function(e){var t,s,i,n;if(!0===e.isCanvasGradient&&(e=e.getColor()),!e)return{r:0,g:0,b:0,a:0,style:e};if(/transparent|rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*0+\s*\)/.test(e))t=0,s=0,i=0,n=0;else{var r=/rgb\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*\)/.exec(e);if(null!==r)t=parseInt(r[1]),s=parseInt(r[2]),i=parseInt(r[3]),n=1;else if(null!==(r=/rgba\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*,\s*([\d.]+)\s*\)/.exec(e)))t=parseInt(r[1]),s=parseInt(r[2]),i=parseInt(r[3]),n=parseFloat(r[4]);else{if(n=1,"string"==typeof e&&"#"!==e.charAt(0)){var a=new pb(e);e=a.ok?a.toHex():"#000000"}4===e.length?(t=e.substring(1,2),t+=t,s=e.substring(2,3),s+=s,i=e.substring(3,4),i+=i):(t=e.substring(1,3),s=e.substring(3,5),i=e.substring(5,7)),t=parseInt(t,16),s=parseInt(s,16),i=parseInt(i,16)}}return{r:t,g:s,b:i,a:n,style:e}},f=function(){return this.ctx.isFillTransparent||0==this.globalAlpha},m=function(){return Boolean(this.ctx.isStrokeTransparent||0==this.globalAlpha)};u.prototype.fillText=function(e,t,s,i){if(isNaN(t)||isNaN(s)||"string"!=typeof e)throw lb.error("jsPDF.context2d.fillText: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.fillText");if(i=isNaN(i)?void 0:i,!f.call(this)){var n=R(this.ctx.transform.rotation),r=this.ctx.transform.scaleX;A.call(this,{text:e,x:t,y:s,scale:r,angle:n,align:this.textAlign,maxWidth:i})}},u.prototype.strokeText=function(e,t,s,i){if(isNaN(t)||isNaN(s)||"string"!=typeof e)throw lb.error("jsPDF.context2d.strokeText: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.strokeText");if(!m.call(this)){i=isNaN(i)?void 0:i;var n=R(this.ctx.transform.rotation),r=this.ctx.transform.scaleX;A.call(this,{text:e,x:t,y:s,scale:r,renderingMode:"stroke",angle:n,align:this.textAlign,maxWidth:i})}},u.prototype.measureText=function(e){if("string"!=typeof e)throw lb.error("jsPDF.context2d.measureText: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.measureText");var t=this.pdf,s=this.pdf.internal.scaleFactor,i=t.internal.getFontSize(),n=t.getStringUnitWidth(e)*i/t.internal.scaleFactor;return new function(e){var t=(e=e||{}).width||0;return Object.defineProperty(this,"width",{get:function(){return t}}),this}({width:n*=Math.round(96*s/72*1e4)/1e4})},u.prototype.scale=function(e,t){if(isNaN(e)||isNaN(t))throw lb.error("jsPDF.context2d.scale: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.scale");var s=new l(e,0,0,t,0,0);this.ctx.transform=this.ctx.transform.multiply(s)},u.prototype.rotate=function(e){if(isNaN(e))throw lb.error("jsPDF.context2d.rotate: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.rotate");var t=new l(Math.cos(e),Math.sin(e),-Math.sin(e),Math.cos(e),0,0);this.ctx.transform=this.ctx.transform.multiply(t)},u.prototype.translate=function(e,t){if(isNaN(e)||isNaN(t))throw lb.error("jsPDF.context2d.translate: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.translate");var s=new l(1,0,0,1,e,t);this.ctx.transform=this.ctx.transform.multiply(s)},u.prototype.transform=function(e,t,s,i,n,r){if(isNaN(e)||isNaN(t)||isNaN(s)||isNaN(i)||isNaN(n)||isNaN(r))throw lb.error("jsPDF.context2d.transform: Invalid arguments",arguments),new Error("Invalid arguments passed to jsPDF.context2d.transform");var a=new l(e,t,s,i,n,r);this.ctx.transform=this.ctx.transform.multiply(a)},u.prototype.setTransform=function(e,t,s,i,n,r){e=isNaN(e)?1:e,t=isNaN(t)?0:t,s=isNaN(s)?0:s,i=isNaN(i)?1:i,n=isNaN(n)?0:n,r=isNaN(r)?0:r,this.ctx.transform=new l(e,t,s,i,n,r)};var p=function(){return this.margin[0]>0||this.margin[1]>0||this.margin[2]>0||this.margin[3]>0};u.prototype.drawImage=function(e,t,s,i,n,r,a,c,d){var u=this.pdf.getImageProperties(e),h=1,f=1,m=1,v=1;void 0!==i&&void 0!==c&&(m=c/i,v=d/n,h=u.width/i*c/i,f=u.height/n*d/n),void 0===r&&(r=t,a=s,t=0,s=0),void 0!==i&&void 0===c&&(c=i,d=n),void 0===i&&void 0===c&&(c=u.width,d=u.height);for(var x,S=this.ctx.transform.decompose(),k=R(S.rotate.shx),_=new l,C=(_=(_=(_=_.multiply(S.translate)).multiply(S.skew)).multiply(S.scale)).applyToRectangle(new o(r-t*m,a-s*v,i*h,n*f)),N=g.call(this,C),T=[],A=0;A<N.length;A+=1)-1===T.indexOf(N[A])&&T.push(N[A]);if(b(T),this.autoPaging)for(var E=T[0],j=T[T.length-1],P=E;P<j+1;P++){this.pdf.setPage(P);var I=this.pdf.internal.pageSize.width-this.margin[3]-this.margin[1],L=1===P?this.posY+this.margin[0]:this.margin[0],O=this.pdf.internal.pageSize.height-this.posY-this.margin[0]-this.margin[2],D=this.pdf.internal.pageSize.height-this.margin[0]-this.margin[2],M=1===P?0:O+(P-2)*D;if(0!==this.ctx.clip_path.length){var U=this.path;x=JSON.parse(JSON.stringify(this.ctx.clip_path)),this.path=y(x,this.posX+this.margin[3],-M+L+this.ctx.prevPageLastElemOffset),w.call(this,"fill",!0),this.path=U}var F=JSON.parse(JSON.stringify(C));F=y([F],this.posX+this.margin[3],-M+L+this.ctx.prevPageLastElemOffset)[0];var B=(P>E||P<j)&&p.call(this);B&&(this.pdf.saveGraphicsState(),this.pdf.rect(this.margin[3],this.margin[0],I,D,null).clip().discardPath()),this.pdf.addImage(e,"JPEG",F.x,F.y,F.w,F.h,null,null,k),B&&this.pdf.restoreGraphicsState()}else this.pdf.addImage(e,"JPEG",C.x,C.y,C.w,C.h,null,null,k)};var g=function(e,t,s){var i=[];t=t||this.pdf.internal.pageSize.width,s=s||this.pdf.internal.pageSize.height-this.margin[0]-this.margin[2];var n=this.posY+this.ctx.prevPageLastElemOffset;switch(e.type){default:case"mt":case"lt":i.push(Math.floor((e.y+n)/s)+1);break;case"arc":i.push(Math.floor((e.y+n-e.radius)/s)+1),i.push(Math.floor((e.y+n+e.radius)/s)+1);break;case"qct":var r=O(this.ctx.lastPoint.x,this.ctx.lastPoint.y,e.x1,e.y1,e.x,e.y);i.push(Math.floor((r.y+n)/s)+1),i.push(Math.floor((r.y+r.h+n)/s)+1);break;case"bct":var a=D(this.ctx.lastPoint.x,this.ctx.lastPoint.y,e.x1,e.y1,e.x2,e.y2,e.x,e.y);i.push(Math.floor((a.y+n)/s)+1),i.push(Math.floor((a.y+a.h+n)/s)+1);break;case"rect":i.push(Math.floor((e.y+n)/s)+1),i.push(Math.floor((e.y+e.h+n)/s)+1)}for(var o=0;o<i.length;o+=1)for(;this.pdf.internal.getNumberOfPages()<i[o];)v.call(this);return i},v=function(){var e=this.fillStyle,t=this.strokeStyle,s=this.font,i=this.lineCap,n=this.lineWidth,r=this.lineJoin;this.pdf.addPage(),this.fillStyle=e,this.strokeStyle=t,this.font=s,this.lineCap=i,this.lineWidth=n,this.lineJoin=r},y=function(e,t,s){for(var i=0;i<e.length;i++)switch(e[i].type){case"bct":e[i].x2+=t,e[i].y2+=s;case"qct":e[i].x1+=t,e[i].y1+=s;default:e[i].x+=t,e[i].y+=s}return e},b=function(e){return e.sort(function(e,t){return e-t})},x=function(e,t){for(var s,i,n=this.fillStyle,r=this.strokeStyle,a=this.lineCap,o=this.lineWidth,l=Math.abs(o*this.ctx.transform.scaleX),c=this.lineJoin,d=JSON.parse(JSON.stringify(this.path)),u=JSON.parse(JSON.stringify(this.path)),h=[],f=0;f<u.length;f++)if(void 0!==u[f].x)for(var m=g.call(this,u[f]),x=0;x<m.length;x+=1)-1===h.indexOf(m[x])&&h.push(m[x]);for(var S=0;S<h.length;S++)for(;this.pdf.internal.getNumberOfPages()<h[S];)v.call(this);if(b(h),this.autoPaging)for(var k=h[0],_=h[h.length-1],C=k;C<_+1;C++){this.pdf.setPage(C),this.fillStyle=n,this.strokeStyle=r,this.lineCap=a,this.lineWidth=l,this.lineJoin=c;var N=this.pdf.internal.pageSize.width-this.margin[3]-this.margin[1],T=1===C?this.posY+this.margin[0]:this.margin[0],A=this.pdf.internal.pageSize.height-this.posY-this.margin[0]-this.margin[2],E=this.pdf.internal.pageSize.height-this.margin[0]-this.margin[2],j=1===C?0:A+(C-2)*E;if(0!==this.ctx.clip_path.length){var P=this.path;s=JSON.parse(JSON.stringify(this.ctx.clip_path)),this.path=y(s,this.posX+this.margin[3],-j+T+this.ctx.prevPageLastElemOffset),w.call(this,e,!0),this.path=P}if(i=JSON.parse(JSON.stringify(d)),this.path=y(i,this.posX+this.margin[3],-j+T+this.ctx.prevPageLastElemOffset),!1===t||0===C){var I=(C>k||C<_)&&p.call(this);I&&(this.pdf.saveGraphicsState(),this.pdf.rect(this.margin[3],this.margin[0],N,E,null).clip().discardPath()),w.call(this,e,t),I&&this.pdf.restoreGraphicsState()}this.lineWidth=o}else this.lineWidth=l,w.call(this,e,t),this.lineWidth=o;this.path=d},w=function(e,t){if(("stroke"!==e||t||!m.call(this))&&("stroke"===e||t||!f.call(this))){for(var s,i,n=[],r=this.path,a=0;a<r.length;a++){var o=r[a];switch(o.type){case"begin":n.push({begin:!0});break;case"close":n.push({close:!0});break;case"mt":n.push({start:o,deltas:[],abs:[]});break;case"lt":var l=n.length;if(r[a-1]&&!isNaN(r[a-1].x)&&(s=[o.x-r[a-1].x,o.y-r[a-1].y],l>0))for(;l>=0;l--)if(!0!==n[l-1].close&&!0!==n[l-1].begin){n[l-1].deltas.push(s),n[l-1].abs.push(o);break}break;case"bct":s=[o.x1-r[a-1].x,o.y1-r[a-1].y,o.x2-r[a-1].x,o.y2-r[a-1].y,o.x-r[a-1].x,o.y-r[a-1].y],n[n.length-1].deltas.push(s);break;case"qct":var c=r[a-1].x+2/3*(o.x1-r[a-1].x),d=r[a-1].y+2/3*(o.y1-r[a-1].y),u=o.x+2/3*(o.x1-o.x),h=o.y+2/3*(o.y1-o.y),p=o.x,g=o.y;s=[c-r[a-1].x,d-r[a-1].y,u-r[a-1].x,h-r[a-1].y,p-r[a-1].x,g-r[a-1].y],n[n.length-1].deltas.push(s);break;case"arc":n.push({deltas:[],abs:[],arc:!0}),Array.isArray(n[n.length-1].abs)&&n[n.length-1].abs.push(o)}}i=t?null:"stroke"===e?"stroke":"fill";for(var v=!1,y=0;y<n.length;y++)if(n[y].arc)for(var b=n[y].abs,x=0;x<b.length;x++){var w=b[x];"arc"===w.type?_.call(this,w.x,w.y,w.radius,w.startAngle,w.endAngle,w.counterclockwise,void 0,t,!v):E.call(this,w.x,w.y),v=!0}else if(!0===n[y].close)this.pdf.internal.out("h"),v=!1;else if(!0!==n[y].begin){var S=n[y].start.x,k=n[y].start.y;j.call(this,n[y].deltas,S,k),v=!0}i&&C.call(this,i),t&&N.call(this)}},S=function(e){var t=this.pdf.internal.getFontSize()/this.pdf.internal.scaleFactor,s=t*(this.pdf.internal.getLineHeightFactor()-1);switch(this.ctx.textBaseline){case"bottom":return e-s;case"top":return e+t-s;case"hanging":return e+t-2*s;case"middle":return e+t/2-s;default:return e}},k=function(e){return e+this.pdf.internal.getFontSize()/this.pdf.internal.scaleFactor*(this.pdf.internal.getLineHeightFactor()-1)};u.prototype.createLinearGradient=function(){var e=function(){};return e.colorStops=[],e.addColorStop=function(e,t){this.colorStops.push([e,t])},e.getColor=function(){return 0===this.colorStops.length?"#000000":this.colorStops[0][1]},e.isCanvasGradient=!0,e},u.prototype.createPattern=function(){return this.createLinearGradient()},u.prototype.createRadialGradient=function(){return this.createLinearGradient()};var _=function(e,t,s,i,n,r,a,o,l){for(var c=I.call(this,s,i,n,r),d=0;d<c.length;d++){var u=c[d];0===d&&(l?T.call(this,u.x1+e,u.y1+t):E.call(this,u.x1+e,u.y1+t)),P.call(this,e,t,u.x2,u.y2,u.x3,u.y3,u.x4,u.y4)}o?N.call(this):C.call(this,a)},C=function(e){switch(e){case"stroke":this.pdf.internal.out("S");break;case"fill":this.pdf.internal.out("f")}},N=function(){this.pdf.clip(),this.pdf.discardPath()},T=function(e,t){this.pdf.internal.out(s(e)+" "+i(t)+" m")},A=function(e){var t;switch(e.align){case"right":case"end":t="right";break;case"center":t="center";break;default:t="left"}var s=this.pdf.getTextDimensions(e.text),i=S.call(this,e.y),n=k.call(this,i)-s.h,r=this.ctx.transform.applyToPoint(new a(e.x,i)),c=this.ctx.transform.decompose(),d=new l;d=(d=(d=d.multiply(c.translate)).multiply(c.skew)).multiply(c.scale);for(var u,h,f,m=this.ctx.transform.applyToRectangle(new o(e.x,i,s.w,s.h)),v=d.applyToRectangle(new o(e.x,n,s.w,s.h)),x=g.call(this,v),_=[],C=0;C<x.length;C+=1)-1===_.indexOf(x[C])&&_.push(x[C]);if(b(_),this.autoPaging)for(var N=_[0],T=_[_.length-1],A=N;A<T+1;A++){this.pdf.setPage(A);var E=1===A?this.posY+this.margin[0]:this.margin[0],j=this.pdf.internal.pageSize.height-this.posY-this.margin[0]-this.margin[2],P=this.pdf.internal.pageSize.height-this.margin[2],I=P-this.margin[0],L=this.pdf.internal.pageSize.width-this.margin[1],R=L-this.margin[3],O=1===A?0:j+(A-2)*I;if(0!==this.ctx.clip_path.length){var D=this.path;u=JSON.parse(JSON.stringify(this.ctx.clip_path)),this.path=y(u,this.posX+this.margin[3],-1*O+E),w.call(this,"fill",!0),this.path=D}var M=y([JSON.parse(JSON.stringify(v))],this.posX+this.margin[3],-O+E+this.ctx.prevPageLastElemOffset)[0];e.scale>=.01&&(h=this.pdf.internal.getFontSize(),this.pdf.setFontSize(h*e.scale),f=this.lineWidth,this.lineWidth=f*e.scale);var U="text"!==this.autoPaging;if(U||M.y+M.h<=P){if(U||M.y>=E&&M.x<=L){var F=U?e.text:this.pdf.splitTextToSize(e.text,e.maxWidth||L-M.x)[0],B=y([JSON.parse(JSON.stringify(m))],this.posX+this.margin[3],-O+E+this.ctx.prevPageLastElemOffset)[0],q=U&&(A>N||A<T)&&p.call(this);q&&(this.pdf.saveGraphicsState(),this.pdf.rect(this.margin[3],this.margin[0],R,I,null).clip().discardPath()),this.pdf.text(F,B.x,B.y,{angle:e.angle,align:t,renderingMode:e.renderingMode}),q&&this.pdf.restoreGraphicsState()}}else M.y<P&&(this.ctx.prevPageLastElemOffset+=P-M.y);e.scale>=.01&&(this.pdf.setFontSize(h),this.lineWidth=f)}else e.scale>=.01&&(h=this.pdf.internal.getFontSize(),this.pdf.setFontSize(h*e.scale),f=this.lineWidth,this.lineWidth=f*e.scale),this.pdf.text(e.text,r.x+this.posX,r.y+this.posY,{angle:e.angle,align:t,renderingMode:e.renderingMode,maxWidth:e.maxWidth}),e.scale>=.01&&(this.pdf.setFontSize(h),this.lineWidth=f)},E=function(e,t,n,r){n=n||0,r=r||0,this.pdf.internal.out(s(e+n)+" "+i(t+r)+" l")},j=function(e,t,s){return this.pdf.lines(e,t,s,null,null)},P=function(e,s,i,a,o,l,c,d){this.pdf.internal.out([t(n(i+e)),t(r(a+s)),t(n(o+e)),t(r(l+s)),t(n(c+e)),t(r(d+s)),"c"].join(" "))},I=function(e,t,s,i){for(var n=2*Math.PI,r=Math.PI/2;t>s;)t-=n;var a=Math.abs(s-t);a<n&&i&&(a=n-a);for(var o=[],l=i?-1:1,c=t;a>1e-5;){var d=c+l*Math.min(a,r);o.push(L.call(this,e,c,d)),a-=Math.abs(d-c),c=d}return o},L=function(e,t,s){var i=(s-t)/2,n=e*Math.cos(i),r=e*Math.sin(i),a=n,o=-r,l=a*a+o*o,c=l+a*n+o*r,d=4/3*(Math.sqrt(2*l*c)-c)/(a*r-o*n),u=a-d*o,h=o+d*a,f=u,m=-h,p=i+t,g=Math.cos(p),v=Math.sin(p);return{x1:e*Math.cos(t),y1:e*Math.sin(t),x2:u*g-h*v,y2:u*v+h*g,x3:f*g-m*v,y3:f*v+m*g,x4:e*Math.cos(s),y4:e*Math.sin(s)}},R=function(e){return 180*e/Math.PI},O=function(e,t,s,i,n,r){var a=e+.5*(s-e),l=t+.5*(i-t),c=n+.5*(s-n),d=r+.5*(i-r),u=Math.min(e,n,a,c),h=Math.max(e,n,a,c),f=Math.min(t,r,l,d),m=Math.max(t,r,l,d);return new o(u,f,h-u,m-f)},D=function(e,t,s,i,n,r,a,l){var c,d,u,h,f,m,p,g,v,y,b,x,w,S,k=s-e,_=i-t,C=n-s,N=r-i,T=a-n,A=l-r;for(d=0;d<41;d++)v=(p=(u=e+(c=d/40)*k)+c*((f=s+c*C)-u))+c*(f+c*(n+c*T-f)-p),y=(g=(h=t+c*_)+c*((m=i+c*N)-h))+c*(m+c*(r+c*A-m)-g),0==d?(b=v,x=y,w=v,S=y):(b=Math.min(b,v),x=Math.min(x,y),w=Math.max(w,v),S=Math.max(S,y));return new o(Math.round(b),Math.round(x),Math.round(w-b),Math.round(S-x))},M=function(){if(this.prevLineDash||this.ctx.lineDash.length||this.ctx.lineDashOffset){var e,t,s=(e=this.ctx.lineDash,t=this.ctx.lineDashOffset,JSON.stringify({lineDash:e,lineDashOffset:t}));this.prevLineDash!==s&&(this.pdf.setLineDash(this.ctx.lineDash,this.ctx.lineDashOffset),this.prevLineDash=s)}}}(Fb.API),
/**
 * @license
 * jsPDF filters PlugIn
 * Copyright (c) 2014 Aras Abbasi
 *
 * Licensed under the MIT License.
 * http://opensource.org/licenses/mit-license
 */
function(e){var t=function(e){var t,s,i,n,r,a,o,l,c,d;for(s=[],i=0,n=(e+=t="\0\0\0\0".slice(e.length%4||4)).length;n>i;i+=4)0!==(r=(e.charCodeAt(i)<<24)+(e.charCodeAt(i+1)<<16)+(e.charCodeAt(i+2)<<8)+e.charCodeAt(i+3))?(a=(r=((r=((r=((r=(r-(d=r%85))/85)-(c=r%85))/85)-(l=r%85))/85)-(o=r%85))/85)%85,s.push(a+33,o+33,l+33,c+33,d+33)):s.push(122);return function(e,t){for(var s=t;s>0;s--)e.pop()}(s,t.length),String.fromCharCode.apply(String,s)+"~>"},s=function(e){var t,s,i,n,r,a=String,o="length",l=255,c="charCodeAt",d="slice",u="replace";for(e[d](-2),e=e[d](0,-2)[u](/\s/g,"")[u]("z","!!!!!"),i=[],n=0,r=(e+=t="uuuuu"[d](e[o]%5||5))[o];r>n;n+=5)s=52200625*(e[c](n)-33)+614125*(e[c](n+1)-33)+7225*(e[c](n+2)-33)+85*(e[c](n+3)-33)+(e[c](n+4)-33),i.push(l&s>>24,l&s>>16,l&s>>8,l&s);return function(e,t){for(var s=t;s>0;s--)e.pop()}(i,t[o]),a.fromCharCode.apply(a,i)},i=function(e){var t=new RegExp(/^([0-9A-Fa-f]{2})+$/);if(-1!==(e=e.replace(/\s/g,"")).indexOf(">")&&(e=e.substr(0,e.indexOf(">"))),e.length%2&&(e+="0"),!1===t.test(e))return"";for(var s="",i=0;i<e.length;i+=2)s+=String.fromCharCode("0x"+(e[i]+e[i+1]));return s},n=function(e){for(var t=new Uint8Array(e.length),s=e.length;s--;)t[s]=e.charCodeAt(s);return(t=ib(t)).reduce(function(e,t){return e+String.fromCharCode(t)},"")};e.processDataByFilters=function(e,r){var a=0,o=e||"",l=[];for("string"==typeof(r=r||[])&&(r=[r]),a=0;a<r.length;a+=1)switch(r[a]){case"ASCII85Decode":case"/ASCII85Decode":o=s(o),l.push("/ASCII85Encode");break;case"ASCII85Encode":case"/ASCII85Encode":o=t(o),l.push("/ASCII85Decode");break;case"ASCIIHexDecode":case"/ASCIIHexDecode":o=i(o),l.push("/ASCIIHexEncode");break;case"ASCIIHexEncode":case"/ASCIIHexEncode":o=o.split("").map(function(e){return("0"+e.charCodeAt().toString(16)).slice(-2)}).join("")+">",l.push("/ASCIIHexDecode");break;case"FlateEncode":case"/FlateEncode":o=n(o),l.push("/FlateDecode");break;default:throw new Error('The filter: "'+r[a]+'" is not implemented')}return{data:o,reverseChain:l.reverse().join(" ")}}}(Fb.API),
/**
 * @license
 * jsPDF fileloading PlugIn
 * Copyright (c) 2018 Aras Abbasi (aras.abbasi@gmail.com)
 *
 * Licensed under the MIT License.
 * http://opensource.org/licenses/mit-license
 */
function(e){e.loadFile=function(e,t,s){return function(e,t,s){t=!1!==t,s="function"==typeof s?s:function(){};var i=void 0;try{i=function(e,t,s){var i=new XMLHttpRequest,n=0,r=function(e){var t=e.length,s=[],i=String.fromCharCode;for(n=0;n<t;n+=1)s.push(i(255&e.charCodeAt(n)));return s.join("")};if(i.open("GET",e,!t),i.overrideMimeType("text/plain; charset=x-user-defined"),!1===t&&(i.onload=function(){200===i.status?s(r(this.responseText)):s(void 0)}),i.send(null),t&&200===i.status)return r(i.responseText)}(e,t,s)}catch(n){}return i}(e,t,s)},e.loadImageFile=e.loadFile}(Fb.API),function(e){function t(){return(ab.html2canvas?Promise.resolve(ab.html2canvas):g(()=>import("./html2canvas.esm-BPY6V10C.js"),[])).catch(function(e){return Promise.reject(new Error("Could not load html2canvas: "+e))}).then(function(e){return e.default?e.default:e})}function s(){return(ab.DOMPurify?Promise.resolve(ab.DOMPurify):g(()=>import("./purify.es-DrMIVfJO.js"),[])).catch(function(e){return Promise.reject(new Error("Could not load dompurify: "+e))}).then(function(e){return e.default?e.default:e})}var i=function(e){var t=fy(e);return"undefined"===t?"undefined":"string"===t||e instanceof String?"string":"number"===t||e instanceof Number?"number":"function"===t||e instanceof Function?"function":e&&e.constructor===Array?"array":e&&1===e.nodeType?"element":"object"===t?"object":"unknown"},n=function(e,t){var s=document.createElement(e);for(var i in t.className&&(s.className=t.className),t.innerHTML&&t.dompurify&&(s.innerHTML=t.dompurify.sanitize(t.innerHTML)),t.style)s.style[i]=t.style[i];return s},r=function e(t){var s=Object.assign(e.convert(Promise.resolve()),JSON.parse(JSON.stringify(e.template))),i=e.convert(Promise.resolve(),s);return(i=i.setProgress(1,e,1,[e])).set(t)};(r.prototype=Object.create(Promise.prototype)).constructor=r,r.convert=function(e,t){return e.__proto__=t||r.prototype,e},r.template={prop:{src:null,container:null,overlay:null,canvas:null,img:null,pdf:null,pageSize:null,callback:function(){}},progress:{val:0,state:null,n:0,stack:[]},opt:{filename:"file.pdf",margin:[0,0,0,0],enableLinks:!0,x:0,y:0,html2canvas:{},jsPDF:{},backgroundColor:"transparent"}},r.prototype.from=function(e,t){return this.then(function(){switch(t=t||function(e){switch(i(e)){case"string":return"string";case"element":return"canvas"===e.nodeName.toLowerCase()?"canvas":"element";default:return"unknown"}}(e)){case"string":return this.then(s).then(function(t){return this.set({src:n("div",{innerHTML:e,dompurify:t})})});case"element":return this.set({src:e});case"canvas":return this.set({canvas:e});case"img":return this.set({img:e});default:return this.error("Unknown source type.")}})},r.prototype.to=function(e){switch(e){case"container":return this.toContainer();case"canvas":return this.toCanvas();case"img":return this.toImg();case"pdf":return this.toPdf();default:return this.error("Invalid target.")}},r.prototype.toContainer=function(){return this.thenList([function(){return this.prop.src||this.error("Cannot duplicate - no source HTML.")},function(){return this.prop.pageSize||this.setPageSize()}]).then(function(){var e={position:"relative",display:"inline-block",width:("number"!=typeof this.opt.width||isNaN(this.opt.width)||"number"!=typeof this.opt.windowWidth||isNaN(this.opt.windowWidth)?Math.max(this.prop.src.clientWidth,this.prop.src.scrollWidth,this.prop.src.offsetWidth):this.opt.windowWidth)+"px",left:0,right:0,top:0,margin:"auto",backgroundColor:this.opt.backgroundColor},t=function e(t,s){for(var i=3===t.nodeType?document.createTextNode(t.nodeValue):t.cloneNode(!1),n=t.firstChild;n;n=n.nextSibling)!0!==s&&1===n.nodeType&&"SCRIPT"===n.nodeName||i.appendChild(e(n,s));return 1===t.nodeType&&("CANVAS"===t.nodeName?(i.width=t.width,i.height=t.height,i.getContext("2d").drawImage(t,0,0)):"TEXTAREA"!==t.nodeName&&"SELECT"!==t.nodeName||(i.value=t.value),i.addEventListener("load",function(){i.scrollTop=t.scrollTop,i.scrollLeft=t.scrollLeft},!0)),i}(this.prop.src,this.opt.html2canvas.javascriptEnabled);"BODY"===t.tagName&&(e.height=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight)+"px"),this.prop.overlay=n("div",{className:"html2pdf__overlay",style:{position:"fixed",overflow:"hidden",zIndex:1e3,left:"-100000px",right:0,bottom:0,top:0}}),this.prop.container=n("div",{className:"html2pdf__container",style:e}),this.prop.container.appendChild(t),this.prop.container.firstChild.appendChild(n("div",{style:{clear:"both",border:"0 none transparent",margin:0,padding:0,height:0}})),this.prop.container.style.float="none",this.prop.overlay.appendChild(this.prop.container),document.body.appendChild(this.prop.overlay),this.prop.container.firstChild.style.position="relative",this.prop.container.height=Math.max(this.prop.container.firstChild.clientHeight,this.prop.container.firstChild.scrollHeight,this.prop.container.firstChild.offsetHeight)+"px"})},r.prototype.toCanvas=function(){var e=[function(){return document.body.contains(this.prop.container)||this.toContainer()}];return this.thenList(e).then(t).then(function(e){var t=Object.assign({},this.opt.html2canvas);return delete t.onrendered,e(this.prop.container,t)}).then(function(e){(this.opt.html2canvas.onrendered||function(){})(e),this.prop.canvas=e,document.body.removeChild(this.prop.overlay)})},r.prototype.toContext2d=function(){var e=[function(){return document.body.contains(this.prop.container)||this.toContainer()}];return this.thenList(e).then(t).then(function(e){var t=this.opt.jsPDF,s=this.opt.fontFaces,i="number"!=typeof this.opt.width||isNaN(this.opt.width)||"number"!=typeof this.opt.windowWidth||isNaN(this.opt.windowWidth)?1:this.opt.width/this.opt.windowWidth,n=Object.assign({async:!0,allowTaint:!0,scale:i,scrollX:this.opt.scrollX||0,scrollY:this.opt.scrollY||0,backgroundColor:"#ffffff",imageTimeout:15e3,logging:!0,proxy:null,removeContainer:!0,foreignObjectRendering:!1,useCORS:!1},this.opt.html2canvas);if(delete n.onrendered,t.context2d.autoPaging=void 0===this.opt.autoPaging||this.opt.autoPaging,t.context2d.posX=this.opt.x,t.context2d.posY=this.opt.y,t.context2d.margin=this.opt.margin,t.context2d.fontFaces=s,s)for(var r=0;r<s.length;++r){var a=s[r],o=a.src.find(function(e){return"truetype"===e.format});o&&t.addFont(o.url,a.ref.name,a.ref.style)}return n.windowHeight=n.windowHeight||0,n.windowHeight=0==n.windowHeight?Math.max(this.prop.container.clientHeight,this.prop.container.scrollHeight,this.prop.container.offsetHeight):n.windowHeight,t.context2d.save(!0),e(this.prop.container,n)}).then(function(e){this.opt.jsPDF.context2d.restore(!0),(this.opt.html2canvas.onrendered||function(){})(e),this.prop.canvas=e,document.body.removeChild(this.prop.overlay)})},r.prototype.toImg=function(){return this.thenList([function(){return this.prop.canvas||this.toCanvas()}]).then(function(){var e=this.prop.canvas.toDataURL("image/"+this.opt.image.type,this.opt.image.quality);this.prop.img=document.createElement("img"),this.prop.img.src=e})},r.prototype.toPdf=function(){return this.thenList([function(){return this.toContext2d()}]).then(function(){this.prop.pdf=this.prop.pdf||this.opt.jsPDF})},r.prototype.output=function(e,t,s){return"img"===(s=s||"pdf").toLowerCase()||"image"===s.toLowerCase()?this.outputImg(e,t):this.outputPdf(e,t)},r.prototype.outputPdf=function(e,t){return this.thenList([function(){return this.prop.pdf||this.toPdf()}]).then(function(){return this.prop.pdf.output(e,t)})},r.prototype.outputImg=function(e){return this.thenList([function(){return this.prop.img||this.toImg()}]).then(function(){switch(e){case void 0:case"img":return this.prop.img;case"datauristring":case"dataurlstring":return this.prop.img.src;case"datauri":case"dataurl":return document.location.href=this.prop.img.src;default:throw'Image output type "'+e+'" is not supported.'}})},r.prototype.save=function(e){return this.thenList([function(){return this.prop.pdf||this.toPdf()}]).set(e?{filename:e}:null).then(function(){this.prop.pdf.save(this.opt.filename)})},r.prototype.doCallback=function(){return this.thenList([function(){return this.prop.pdf||this.toPdf()}]).then(function(){this.prop.callback(this.prop.pdf)})},r.prototype.set=function(e){if("object"!==i(e))return this;var t=Object.keys(e||{}).map(function(t){if(t in r.template.prop)return function(){this.prop[t]=e[t]};switch(t){case"margin":return this.setMargin.bind(this,e.margin);case"jsPDF":return function(){return this.opt.jsPDF=e.jsPDF,this.setPageSize()};case"pageSize":return this.setPageSize.bind(this,e.pageSize);default:return function(){this.opt[t]=e[t]}}},this);return this.then(function(){return this.thenList(t)})},r.prototype.get=function(e,t){return this.then(function(){var s=e in r.template.prop?this.prop[e]:this.opt[e];return t?t(s):s})},r.prototype.setMargin=function(e){return this.then(function(){switch(i(e)){case"number":e=[e,e,e,e];case"array":if(2===e.length&&(e=[e[0],e[1],e[0],e[1]]),4===e.length)break;default:return this.error("Invalid margin array.")}this.opt.margin=e}).then(this.setPageSize)},r.prototype.setPageSize=function(e){function t(e,t){return Math.floor(e*t/72*96)}return this.then(function(){(e=e||Fb.getPageSize(this.opt.jsPDF)).hasOwnProperty("inner")||(e.inner={width:e.width-this.opt.margin[1]-this.opt.margin[3],height:e.height-this.opt.margin[0]-this.opt.margin[2]},e.inner.px={width:t(e.inner.width,e.k),height:t(e.inner.height,e.k)},e.inner.ratio=e.inner.height/e.inner.width),this.prop.pageSize=e})},r.prototype.setProgress=function(e,t,s,i){return null!=e&&(this.progress.val=e),null!=t&&(this.progress.state=t),null!=s&&(this.progress.n=s),null!=i&&(this.progress.stack=i),this.progress.ratio=this.progress.val/this.progress.state,this},r.prototype.updateProgress=function(e,t,s,i){return this.setProgress(e?this.progress.val+e:null,t||null,s?this.progress.n+s:null,i?this.progress.stack.concat(i):null)},r.prototype.then=function(e,t){var s=this;return this.thenCore(e,t,function(e,t){return s.updateProgress(null,null,1,[e]),Promise.prototype.then.call(this,function(t){return s.updateProgress(null,e),t}).then(e,t).then(function(e){return s.updateProgress(1),e})})},r.prototype.thenCore=function(e,t,s){s=s||Promise.prototype.then,e&&(e=e.bind(this)),t&&(t=t.bind(this));var i=-1!==Promise.toString().indexOf("[native code]")&&"Promise"===Promise.name?this:r.convert(Object.assign({},this),Promise.prototype),n=s.call(i,e,t);return r.convert(n,this.__proto__)},r.prototype.thenExternal=function(e,t){return Promise.prototype.then.call(this,e,t)},r.prototype.thenList=function(e){var t=this;return e.forEach(function(e){t=t.thenCore(e)}),t},r.prototype.catch=function(e){e&&(e=e.bind(this));var t=Promise.prototype.catch.call(this,e);return r.convert(t,this)},r.prototype.catchExternal=function(e){return Promise.prototype.catch.call(this,e)},r.prototype.error=function(e){return this.then(function(){throw new Error(e)})},r.prototype.using=r.prototype.set,r.prototype.saveAs=r.prototype.save,r.prototype.export=r.prototype.output,r.prototype.run=r.prototype.then,Fb.getPageSize=function(e,t,s){if("object"===fy(e)){var i=e;e=i.orientation,t=i.unit||t,s=i.format||s}t=t||"mm",s=s||"a4",e=(""+(e||"P")).toLowerCase();var n,r=(""+s).toLowerCase(),a={a0:[2383.94,3370.39],a1:[1683.78,2383.94],a2:[1190.55,1683.78],a3:[841.89,1190.55],a4:[595.28,841.89],a5:[419.53,595.28],a6:[297.64,419.53],a7:[209.76,297.64],a8:[147.4,209.76],a9:[104.88,147.4],a10:[73.7,104.88],b0:[2834.65,4008.19],b1:[2004.09,2834.65],b2:[1417.32,2004.09],b3:[1000.63,1417.32],b4:[708.66,1000.63],b5:[498.9,708.66],b6:[354.33,498.9],b7:[249.45,354.33],b8:[175.75,249.45],b9:[124.72,175.75],b10:[87.87,124.72],c0:[2599.37,3676.54],c1:[1836.85,2599.37],c2:[1298.27,1836.85],c3:[918.43,1298.27],c4:[649.13,918.43],c5:[459.21,649.13],c6:[323.15,459.21],c7:[229.61,323.15],c8:[161.57,229.61],c9:[113.39,161.57],c10:[79.37,113.39],dl:[311.81,623.62],letter:[612,792],"government-letter":[576,756],legal:[612,1008],"junior-legal":[576,360],ledger:[1224,792],tabloid:[792,1224],"credit-card":[153,243]};switch(t){case"pt":n=1;break;case"mm":n=72/25.4;break;case"cm":n=72/2.54;break;case"in":n=72;break;case"px":n=.75;break;case"pc":case"em":n=12;break;case"ex":n=6;break;default:throw"Invalid unit: "+t}var o,l=0,c=0;if(a.hasOwnProperty(r))l=a[r][1]/n,c=a[r][0]/n;else try{l=s[1],c=s[0]}catch(Nx){throw new Error("Invalid format: "+s)}if("p"===e||"portrait"===e)e="p",c>l&&(o=c,c=l,l=o);else{if("l"!==e&&"landscape"!==e)throw"Invalid orientation: "+e;e="l",l>c&&(o=c,c=l,l=o)}return{width:c,height:l,unit:t,k:n,orientation:e}},e.html=function(e,t){(t=t||{}).callback=t.callback||function(){},t.html2canvas=t.html2canvas||{},t.html2canvas.canvas=t.html2canvas.canvas||this.canvas,t.jsPDF=t.jsPDF||this,t.fontFaces=t.fontFaces?t.fontFaces.map(Ox):null;var s=new r(t);return t.worker?s:s.from(e).doCallback()}}(Fb.API),Fb.API.addJS=function(e){return Vx=e,this.internal.events.subscribe("postPutResources",function(){zx=this.internal.newObject(),this.internal.out("<<"),this.internal.out("/Names [(EmbeddedJS) "+(zx+1)+" 0 R]"),this.internal.out(">>"),this.internal.out("endobj"),Hx=this.internal.newObject(),this.internal.out("<<"),this.internal.out("/S /JavaScript"),this.internal.out("/JS ("+Vx+")"),this.internal.out(">>"),this.internal.out("endobj")}),this.internal.events.subscribe("putCatalog",function(){void 0!==zx&&void 0!==Hx&&this.internal.out("/Names <</JavaScript "+zx+" 0 R>>")}),this},
/**
 * @license
 * Copyright (c) 2014 Steven Spungin (TwelveTone LLC)  steven@twelvetone.tv
 *
 * Licensed under the MIT License.
 * http://opensource.org/licenses/mit-license
 */
function(e){var t;e.events.push(["postPutResources",function(){var e=this,s=/^(\d+) 0 obj$/;if(this.outline.root.children.length>0)for(var i=e.outline.render().split(/\r\n/),n=0;n<i.length;n++){var r=i[n],a=s.exec(r);if(null!=a){var o=a[1];e.internal.newObjectDeferredBegin(o,!1)}e.internal.write(r)}if(this.outline.createNamedDestinations){var l=this.internal.pages.length,c=[];for(n=0;n<l;n++){var d=e.internal.newObject();c.push(d);var u=e.internal.getPageInfo(n+1);e.internal.write("<< /D["+u.objId+" 0 R /XYZ null null null]>> endobj")}var h=e.internal.newObject();for(e.internal.write("<< /Names [ "),n=0;n<c.length;n++)e.internal.write("(page_"+(n+1)+")"+c[n]+" 0 R");e.internal.write(" ] >>","endobj"),t=e.internal.newObject(),e.internal.write("<< /Dests "+h+" 0 R"),e.internal.write(">>","endobj")}}]),e.events.push(["putCatalog",function(){this.outline.root.children.length>0&&(this.internal.write("/Outlines",this.outline.makeRef(this.outline.root)),this.outline.createNamedDestinations&&this.internal.write("/Names "+t+" 0 R"))}]),e.events.push(["initialized",function(){var e=this;e.outline={createNamedDestinations:!1,root:{children:[]}},e.outline.add=function(e,t,s){var i={title:t,options:s,children:[]};return null==e&&(e=this.root),e.children.push(i),i},e.outline.render=function(){return this.ctx={},this.ctx.val="",this.ctx.pdf=e,this.genIds_r(this.root),this.renderRoot(this.root),this.renderItems(this.root),this.ctx.val},e.outline.genIds_r=function(t){t.id=e.internal.newObjectDeferred();for(var s=0;s<t.children.length;s++)this.genIds_r(t.children[s])},e.outline.renderRoot=function(e){this.objStart(e),this.line("/Type /Outlines"),e.children.length>0&&(this.line("/First "+this.makeRef(e.children[0])),this.line("/Last "+this.makeRef(e.children[e.children.length-1]))),this.line("/Count "+this.count_r({count:0},e)),this.objEnd()},e.outline.renderItems=function(t){for(var s=this.ctx.pdf.internal.getVerticalCoordinateString,i=0;i<t.children.length;i++){var n=t.children[i];this.objStart(n),this.line("/Title "+this.makeString(n.title)),this.line("/Parent "+this.makeRef(t)),i>0&&this.line("/Prev "+this.makeRef(t.children[i-1])),i<t.children.length-1&&this.line("/Next "+this.makeRef(t.children[i+1])),n.children.length>0&&(this.line("/First "+this.makeRef(n.children[0])),this.line("/Last "+this.makeRef(n.children[n.children.length-1])));var r=this.count=this.count_r({count:0},n);if(r>0&&this.line("/Count "+r),n.options&&n.options.pageNumber){var a=e.internal.getPageInfo(n.options.pageNumber);this.line("/Dest ["+a.objId+" 0 R /XYZ 0 "+s(0)+" 0]")}this.objEnd()}for(var o=0;o<t.children.length;o++)this.renderItems(t.children[o])},e.outline.line=function(e){this.ctx.val+=e+"\r\n"},e.outline.makeRef=function(e){return e.id+" 0 R"},e.outline.makeString=function(t){return"("+e.internal.pdfEscape(t)+")"},e.outline.objStart=function(e){this.ctx.val+="\r\n"+e.id+" 0 obj\r\n<<\r\n"},e.outline.objEnd=function(){this.ctx.val+=">> \r\nendobj\r\n"},e.outline.count_r=function(e,t){for(var s=0;s<t.children.length;s++)e.count++,this.count_r(e,t.children[s]);return e.count}}])}(Fb.API),
/**
 * @license
 *
 * Licensed under the MIT License.
 * http://opensource.org/licenses/mit-license
 */
function(e){var t=[192,193,194,195,196,197,198,199];e.processJPEG=function(e,s,i,n,r,a){var o,l=this.decode.DCT_DECODE,c=null;if("string"==typeof e||this.__addimage__.isArrayBuffer(e)||this.__addimage__.isArrayBufferView(e)){switch(e=r||e,e=this.__addimage__.isArrayBuffer(e)?new Uint8Array(e):e,(o=function(e){for(var s,i=256*e.charCodeAt(4)+e.charCodeAt(5),n=e.length,r={width:0,height:0,numcomponents:1},a=4;a<n;a+=2){if(a+=i,-1!==t.indexOf(e.charCodeAt(a+1))){s=256*e.charCodeAt(a+5)+e.charCodeAt(a+6),r={width:256*e.charCodeAt(a+7)+e.charCodeAt(a+8),height:s,numcomponents:e.charCodeAt(a+9)};break}i=256*e.charCodeAt(a+2)+e.charCodeAt(a+3)}return r}(e=this.__addimage__.isArrayBufferView(e)?this.__addimage__.arrayBufferToBinaryString(e):e)).numcomponents){case 1:a=this.color_spaces.DEVICE_GRAY;break;case 4:a=this.color_spaces.DEVICE_CMYK;break;case 3:a=this.color_spaces.DEVICE_RGB}c={data:e,width:o.width,height:o.height,colorSpace:a,bitsPerComponent:8,filter:l,index:s,alias:i}}return c}}(Fb.API);var Jx,Wx,Kx,Yx,Xx,Qx=function(){var e,t,s;function i(e){var t,s,i,n,r,a,o,l,c,d,u,h,f,m;for(this.data=e,this.pos=8,this.palette=[],this.imgData=[],this.transparency={},this.animation=null,this.text={},a=null;;){switch(t=this.readUInt32(),c=function(){var e,t;for(t=[],e=0;e<4;++e)t.push(String.fromCharCode(this.data[this.pos++]));return t}.call(this).join("")){case"IHDR":this.width=this.readUInt32(),this.height=this.readUInt32(),this.bits=this.data[this.pos++],this.colorType=this.data[this.pos++],this.compressionMethod=this.data[this.pos++],this.filterMethod=this.data[this.pos++],this.interlaceMethod=this.data[this.pos++];break;case"acTL":this.animation={numFrames:this.readUInt32(),numPlays:this.readUInt32()||1/0,frames:[]};break;case"PLTE":this.palette=this.read(t);break;case"fcTL":a&&this.animation.frames.push(a),this.pos+=4,a={width:this.readUInt32(),height:this.readUInt32(),xOffset:this.readUInt32(),yOffset:this.readUInt32()},r=this.readUInt16(),n=this.readUInt16()||100,a.delay=1e3*r/n,a.disposeOp=this.data[this.pos++],a.blendOp=this.data[this.pos++],a.data=[];break;case"IDAT":case"fdAT":for("fdAT"===c&&(this.pos+=4,t-=4),e=(null!=a?a.data:void 0)||this.imgData,h=0;0<=t?h<t:h>t;0<=t?++h:--h)e.push(this.data[this.pos++]);break;case"tRNS":switch(this.transparency={},this.colorType){case 3:if(i=this.palette.length/3,this.transparency.indexed=this.read(t),this.transparency.indexed.length>i)throw new Error("More transparent colors than palette size");if((d=i-this.transparency.indexed.length)>0)for(f=0;0<=d?f<d:f>d;0<=d?++f:--f)this.transparency.indexed.push(255);break;case 0:this.transparency.grayscale=this.read(t)[0];break;case 2:this.transparency.rgb=this.read(t)}break;case"tEXt":o=(u=this.read(t)).indexOf(0),l=String.fromCharCode.apply(String,u.slice(0,o)),this.text[l]=String.fromCharCode.apply(String,u.slice(o+1));break;case"IEND":return a&&this.animation.frames.push(a),this.colors=function(){switch(this.colorType){case 0:case 3:case 4:return 1;case 2:case 6:return 3}}.call(this),this.hasAlphaChannel=4===(m=this.colorType)||6===m,s=this.colors+(this.hasAlphaChannel?1:0),this.pixelBitlength=this.bits*s,this.colorSpace=function(){switch(this.colors){case 1:return"DeviceGray";case 3:return"DeviceRGB"}}.call(this),void(this.imgData=new Uint8Array(this.imgData));default:this.pos+=t}if(this.pos+=4,this.pos>this.data.length)throw new Error("Incomplete or corrupt PNG file")}}i.prototype.read=function(e){var t,s;for(s=[],t=0;0<=e?t<e:t>e;0<=e?++t:--t)s.push(this.data[this.pos++]);return s},i.prototype.readUInt32=function(){return this.data[this.pos++]<<24|this.data[this.pos++]<<16|this.data[this.pos++]<<8|this.data[this.pos++]},i.prototype.readUInt16=function(){return this.data[this.pos++]<<8|this.data[this.pos++]},i.prototype.decodePixels=function(e){var t=this.pixelBitlength/8,s=new Uint8Array(this.width*this.height*t),i=0,n=this;if(null==e&&(e=this.imgData),0===e.length)return new Uint8Array(0);function r(r,a,o,l){var c,d,u,h,f,m,p,g,v,y,b,x,w,S,k,_,C,N,T,A,E,j=Math.ceil((n.width-r)/o),P=Math.ceil((n.height-a)/l),I=n.width==j&&n.height==P;for(S=t*j,x=I?s:new Uint8Array(S*P),m=e.length,w=0,d=0;w<P&&i<m;){switch(e[i++]){case 0:for(h=C=0;C<S;h=C+=1)x[d++]=e[i++];break;case 1:for(h=N=0;N<S;h=N+=1)c=e[i++],f=h<t?0:x[d-t],x[d++]=(c+f)%256;break;case 2:for(h=T=0;T<S;h=T+=1)c=e[i++],u=(h-h%t)/t,k=w&&x[(w-1)*S+u*t+h%t],x[d++]=(k+c)%256;break;case 3:for(h=A=0;A<S;h=A+=1)c=e[i++],u=(h-h%t)/t,f=h<t?0:x[d-t],k=w&&x[(w-1)*S+u*t+h%t],x[d++]=(c+Math.floor((f+k)/2))%256;break;case 4:for(h=E=0;E<S;h=E+=1)c=e[i++],u=(h-h%t)/t,f=h<t?0:x[d-t],0===w?k=_=0:(k=x[(w-1)*S+u*t+h%t],_=u&&x[(w-1)*S+(u-1)*t+h%t]),p=f+k-_,g=Math.abs(p-f),y=Math.abs(p-k),b=Math.abs(p-_),v=g<=y&&g<=b?f:y<=b?k:_,x[d++]=(c+v)%256;break;default:throw new Error("Invalid filter algorithm: "+e[i-1])}if(!I){var L=((a+w*l)*n.width+r)*t,R=w*S;for(h=0;h<j;h+=1){for(var O=0;O<t;O+=1)s[L++]=x[R++];L+=(o-1)*t}}w++}}return e=nb(e),1==n.interlaceMethod?(r(0,0,8,8),r(4,0,8,8),r(0,4,4,8),r(2,0,4,4),r(0,2,2,4),r(1,0,2,2),r(0,1,1,2)):r(0,0,1,1),s},i.prototype.decodePalette=function(){var e,t,s,i,n,r,a,o,l;for(s=this.palette,r=this.transparency.indexed||[],n=new Uint8Array((r.length||0)+s.length),i=0,e=0,t=a=0,o=s.length;a<o;t=a+=3)n[i++]=s[t],n[i++]=s[t+1],n[i++]=s[t+2],n[i++]=null!=(l=r[e++])?l:255;return n},i.prototype.copyToImageData=function(e,t){var s,i,n,r,a,o,l,c,d,u,h;if(i=this.colors,d=null,s=this.hasAlphaChannel,this.palette.length&&(d=null!=(h=this._decodedPalette)?h:this._decodedPalette=this.decodePalette(),i=4,s=!0),c=(n=e.data||e).length,a=d||t,r=o=0,1===i)for(;r<c;)l=d?4*t[r/4]:o,u=a[l++],n[r++]=u,n[r++]=u,n[r++]=u,n[r++]=s?a[l++]:255,o=l;else for(;r<c;)l=d?4*t[r/4]:o,n[r++]=a[l++],n[r++]=a[l++],n[r++]=a[l++],n[r++]=s?a[l++]:255,o=l},i.prototype.decode=function(){var e;return e=new Uint8Array(this.width*this.height*4),this.copyToImageData(e,this.decodePixels()),e};var n=function(){if("[object Window]"===Object.prototype.toString.call(ab)){try{t=ab.document.createElement("canvas"),s=t.getContext("2d")}catch(e){return!1}return!0}return!1};return n(),e=function(e){var i;if(!0===n())return s.width=e.width,s.height=e.height,s.clearRect(0,0,e.width,e.height),s.putImageData(e,0,0),(i=new Image).src=t.toDataURL(),i;throw new Error("This method requires a Browser with Canvas-capability.")},i.prototype.decodeFrames=function(t){var s,i,n,r,a,o,l,c;if(this.animation){for(c=[],i=a=0,o=(l=this.animation.frames).length;a<o;i=++a)s=l[i],n=t.createImageData(s.width,s.height),r=this.decodePixels(new Uint8Array(s.data)),this.copyToImageData(n,r),s.imageData=n,c.push(s.image=e(n));return c}},i.prototype.renderFrame=function(e,t){var s,i,n;return s=(i=this.animation.frames)[t],n=i[t-1],0===t&&e.clearRect(0,0,this.width,this.height),1===(null!=n?n.disposeOp:void 0)?e.clearRect(n.xOffset,n.yOffset,n.width,n.height):2===(null!=n?n.disposeOp:void 0)&&e.putImageData(n.imageData,n.xOffset,n.yOffset),0===s.blendOp&&e.clearRect(s.xOffset,s.yOffset,s.width,s.height),e.drawImage(s.image,s.xOffset,s.yOffset)},i.prototype.animate=function(e){var t,s,i,n,r,a,o=this;return s=0,a=this.animation,n=a.numFrames,i=a.frames,r=a.numPlays,(t=function(){var a,l;if(a=s++%n,l=i[a],o.renderFrame(e,a),n>1&&s/n<r)return o.animation._timeout=setTimeout(t,l.delay)})()},i.prototype.stopAnimation=function(){var e;return clearTimeout(null!=(e=this.animation)?e._timeout:void 0)},i.prototype.render=function(e){var t,s;return e._png&&e._png.stopAnimation(),e._png=this,e.width=this.width,e.height=this.height,t=e.getContext("2d"),this.animation?(this.decodeFrames(t),this.animate(t)):(s=t.createImageData(this.width,this.height),this.copyToImageData(s,this.decodePixels()),t.putImageData(s,0,0))},i}();
/**
 * @license
 *
 * Copyright (c) 2014 James Robb, https://github.com/jamesbrobb
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 * ====================================================================
 */
/**
 * @license
 * (c) Dean McNamee <dean@gmail.com>, 2013.
 *
 * https://github.com/deanm/omggif
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to
 * deal in the Software without restriction, including without limitation the
 * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
 * sell copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
 * IN THE SOFTWARE.
 *
 * omggif is a JavaScript implementation of a GIF 89a encoder and decoder,
 * including animation and compression.  It does not rely on any specific
 * underlying system, so should run in the browser, Node, or Plask.
 */function Zx(e){var t=0;if(71!==e[t++]||73!==e[t++]||70!==e[t++]||56!==e[t++]||56!=(e[t++]+1&253)||97!==e[t++])throw new Error("Invalid GIF 87a/89a header.");var s=e[t++]|e[t++]<<8,i=e[t++]|e[t++]<<8,n=e[t++],r=n>>7,a=1<<1+(7&n);e[t++],e[t++];var o=null,l=null;r&&(o=t,l=a,t+=3*a);var c=!0,d=[],u=0,h=null,f=0,m=null;for(this.width=s,this.height=i;c&&t<e.length;)switch(e[t++]){case 33:switch(e[t++]){case 255:if(11!==e[t]||78==e[t+1]&&69==e[t+2]&&84==e[t+3]&&83==e[t+4]&&67==e[t+5]&&65==e[t+6]&&80==e[t+7]&&69==e[t+8]&&50==e[t+9]&&46==e[t+10]&&48==e[t+11]&&3==e[t+12]&&1==e[t+13]&&0==e[t+16])t+=14,m=e[t++]|e[t++]<<8,t++;else for(t+=12;;){if(!((T=e[t++])>=0))throw Error("Invalid block size");if(0===T)break;t+=T}break;case 249:if(4!==e[t++]||0!==e[t+4])throw new Error("Invalid graphics extension block.");var p=e[t++];u=e[t++]|e[t++]<<8,h=e[t++],!(1&p)&&(h=null),f=p>>2&7,t++;break;case 254:for(;;){if(!((T=e[t++])>=0))throw Error("Invalid block size");if(0===T)break;t+=T}break;default:throw new Error("Unknown graphic control label: 0x"+e[t-1].toString(16))}break;case 44:var g=e[t++]|e[t++]<<8,v=e[t++]|e[t++]<<8,y=e[t++]|e[t++]<<8,b=e[t++]|e[t++]<<8,x=e[t++],w=x>>6&1,S=1<<1+(7&x),k=o,_=l,C=!1;x>>7&&(C=!0,k=t,_=S,t+=3*S);var N=t;for(t++;;){var T;if(!((T=e[t++])>=0))throw Error("Invalid block size");if(0===T)break;t+=T}d.push({x:g,y:v,width:y,height:b,has_local_palette:C,palette_offset:k,palette_size:_,data_offset:N,data_length:t-N,transparent_index:h,interlaced:!!w,delay:u,disposal:f});break;case 59:c=!1;break;default:throw new Error("Unknown gif block: 0x"+e[t-1].toString(16))}this.numFrames=function(){return d.length},this.loopCount=function(){return m},this.frameInfo=function(e){if(e<0||e>=d.length)throw new Error("Frame index out of range.");return d[e]},this.decodeAndBlitFrameBGRA=function(t,i){var n=this.frameInfo(t),r=n.width*n.height,a=new Uint8Array(r);ew(e,n.data_offset,a,r);var o=n.palette_offset,l=n.transparent_index;null===l&&(l=256);var c=n.width,d=s-c,u=c,h=4*(n.y*s+n.x),f=4*((n.y+n.height)*s+n.x),m=h,p=4*d;!0===n.interlaced&&(p+=4*s*7);for(var g=8,v=0,y=a.length;v<y;++v){var b=a[v];if(0===u&&(u=c,(m+=p)>=f&&(p=4*d+4*s*(g-1),m=h+(c+d)*(g<<1),g>>=1)),b===l)m+=4;else{var x=e[o+3*b],w=e[o+3*b+1],S=e[o+3*b+2];i[m++]=S,i[m++]=w,i[m++]=x,i[m++]=255}--u}},this.decodeAndBlitFrameRGBA=function(t,i){var n=this.frameInfo(t),r=n.width*n.height,a=new Uint8Array(r);ew(e,n.data_offset,a,r);var o=n.palette_offset,l=n.transparent_index;null===l&&(l=256);var c=n.width,d=s-c,u=c,h=4*(n.y*s+n.x),f=4*((n.y+n.height)*s+n.x),m=h,p=4*d;!0===n.interlaced&&(p+=4*s*7);for(var g=8,v=0,y=a.length;v<y;++v){var b=a[v];if(0===u&&(u=c,(m+=p)>=f&&(p=4*d+4*s*(g-1),m=h+(c+d)*(g<<1),g>>=1)),b===l)m+=4;else{var x=e[o+3*b],w=e[o+3*b+1],S=e[o+3*b+2];i[m++]=x,i[m++]=w,i[m++]=S,i[m++]=255}--u}}}function ew(e,t,s,i){for(var n=e[t++],r=1<<n,a=r+1,o=a+1,l=n+1,c=(1<<l)-1,d=0,u=0,h=0,f=e[t++],m=new Int32Array(4096),p=null;;){for(;d<16&&0!==f;)u|=e[t++]<<d,d+=8,1===f?f=e[t++]:--f;if(d<l)break;var g=u&c;if(u>>=l,d-=l,g!==r){if(g===a)break;for(var v=g<o?g:p,y=0,b=v;b>r;)b=m[b]>>8,++y;var x=b;if(h+y+(v!==g?1:0)>i)return void lb.log("Warning, gif stream longer than expected.");s[h++]=x;var w=h+=y;for(v!==g&&(s[h++]=x),b=v;y--;)b=m[b],s[--w]=255&b,b>>=8;null!==p&&o<4096&&(m[o++]=p<<8|x,o>=c+1&&l<12&&(++l,c=c<<1|1)),p=g}else o=a+1,c=(1<<(l=n+1))-1,p=null}return h!==i&&lb.log("Warning, gif stream shorter than expected."),s
/**
 * @license
  Copyright (c) 2008, Adobe Systems Incorporated
  All rights reserved.

  Redistribution and use in source and binary forms, with or without 
  modification, are permitted provided that the following conditions are
  met:

  * Redistributions of source code must retain the above copyright notice, 
    this list of conditions and the following disclaimer.
  
  * Redistributions in binary form must reproduce the above copyright
    notice, this list of conditions and the following disclaimer in the 
    documentation and/or other materials provided with the distribution.
  
  * Neither the name of Adobe Systems Incorporated nor the names of its 
    contributors may be used to endorse or promote products derived from 
    this software without specific prior written permission.

  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
  IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
  THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR 
  CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
  EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
  PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
  LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
  NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
*/}function tw(e){var t,s,i,n,r,a=Math.floor,o=new Array(64),l=new Array(64),c=new Array(64),d=new Array(64),u=new Array(65535),h=new Array(65535),f=new Array(64),m=new Array(64),p=[],g=0,v=7,y=new Array(64),b=new Array(64),x=new Array(64),w=new Array(256),S=new Array(2048),k=[0,1,5,6,14,15,27,28,2,4,7,13,16,26,29,42,3,8,12,17,25,30,41,43,9,11,18,24,31,40,44,53,10,19,23,32,39,45,52,54,20,22,33,38,46,51,55,60,21,34,37,47,50,56,59,61,35,36,48,49,57,58,62,63],_=[0,0,1,5,1,1,1,1,1,1,0,0,0,0,0,0,0],C=[0,1,2,3,4,5,6,7,8,9,10,11],N=[0,0,2,1,3,3,2,4,3,5,5,4,4,0,0,1,125],T=[1,2,3,0,4,17,5,18,33,49,65,6,19,81,97,7,34,113,20,50,129,145,161,8,35,66,177,193,21,82,209,240,36,51,98,114,130,9,10,22,23,24,25,26,37,38,39,40,41,42,52,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,225,226,227,228,229,230,231,232,233,234,241,242,243,244,245,246,247,248,249,250],A=[0,0,3,1,1,1,1,1,1,1,1,1,0,0,0,0,0],E=[0,1,2,3,4,5,6,7,8,9,10,11],j=[0,0,2,1,2,4,4,3,4,7,5,4,4,0,1,2,119],P=[0,1,2,3,17,4,5,33,49,6,18,65,81,7,97,113,19,34,50,129,8,20,66,145,161,177,193,9,35,51,82,240,21,98,114,209,10,22,36,52,225,37,241,23,24,25,26,38,39,40,41,42,53,54,55,56,57,58,67,68,69,70,71,72,73,74,83,84,85,86,87,88,89,90,99,100,101,102,103,104,105,106,115,116,117,118,119,120,121,122,130,131,132,133,134,135,136,137,138,146,147,148,149,150,151,152,153,154,162,163,164,165,166,167,168,169,170,178,179,180,181,182,183,184,185,186,194,195,196,197,198,199,200,201,202,210,211,212,213,214,215,216,217,218,226,227,228,229,230,231,232,233,234,242,243,244,245,246,247,248,249,250];function I(e,t){for(var s=0,i=0,n=new Array,r=1;r<=16;r++){for(var a=1;a<=e[r];a++)n[t[i]]=[],n[t[i]][0]=s,n[t[i]][1]=r,i++,s++;s*=2}return n}function L(e){for(var t=e[0],s=e[1]-1;s>=0;)t&1<<s&&(g|=1<<v),s--,--v<0&&(255==g?(R(255),R(0)):R(g),v=7,g=0)}function R(e){p.push(e)}function O(e){R(e>>8&255),R(255&e)}function D(e,t,s,i,n){for(var r,a=n[0],o=n[240],l=function(e,t){var s,i,n,r,a,o,l,c,d,u,h=0;for(d=0;d<8;++d){s=e[h],i=e[h+1],n=e[h+2],r=e[h+3],a=e[h+4],o=e[h+5],l=e[h+6];var m=s+(c=e[h+7]),p=s-c,g=i+l,v=i-l,y=n+o,b=n-o,x=r+a,w=r-a,S=m+x,k=m-x,_=g+y,C=g-y;e[h]=S+_,e[h+4]=S-_;var N=.707106781*(C+k);e[h+2]=k+N,e[h+6]=k-N;var T=.382683433*((S=w+b)-(C=v+p)),A=.5411961*S+T,E=1.306562965*C+T,j=.707106781*(_=b+v),P=p+j,I=p-j;e[h+5]=I+A,e[h+3]=I-A,e[h+1]=P+E,e[h+7]=P-E,h+=8}for(h=0,d=0;d<8;++d){s=e[h],i=e[h+8],n=e[h+16],r=e[h+24],a=e[h+32],o=e[h+40],l=e[h+48];var L=s+(c=e[h+56]),R=s-c,O=i+l,D=i-l,M=n+o,U=n-o,F=r+a,B=r-a,q=L+F,$=L-F,z=O+M,H=O-M;e[h]=q+z,e[h+32]=q-z;var V=.707106781*(H+$);e[h+16]=$+V,e[h+48]=$-V;var G=.382683433*((q=B+U)-(H=D+R)),J=.5411961*q+G,W=1.306562965*H+G,K=.707106781*(z=U+D),Y=R+K,X=R-K;e[h+40]=X+J,e[h+24]=X-J,e[h+8]=Y+W,e[h+56]=Y-W,h++}for(d=0;d<64;++d)u=e[d]*t[d],f[d]=u>0?u+.5|0:u-.5|0;return f}(e,t),c=0;c<64;++c)m[k[c]]=l[c];var d=m[0]-s;s=m[0],0==d?L(i[0]):(L(i[h[r=32767+d]]),L(u[r]));for(var p=63;p>0&&0==m[p];)p--;if(0==p)return L(a),s;for(var g,v=1;v<=p;){for(var y=v;0==m[v]&&v<=p;)++v;var b=v-y;if(b>=16){g=b>>4;for(var x=1;x<=g;++x)L(o);b&=15}r=32767+m[v],L(n[(b<<4)+h[r]]),L(u[r]),v++}return 63!=p&&L(a),s}function M(e){e=Math.min(Math.max(e,1),100),r!=e&&(function(e){for(var t=[16,11,10,16,24,40,51,61,12,12,14,19,26,58,60,55,14,13,16,24,40,57,69,56,14,17,22,29,51,87,80,62,18,22,37,56,68,109,103,77,24,35,55,64,81,104,113,92,49,64,78,87,103,121,120,101,72,92,95,98,112,100,103,99],s=0;s<64;s++){var i=a((t[s]*e+50)/100);i=Math.min(Math.max(i,1),255),o[k[s]]=i}for(var n=[17,18,24,47,99,99,99,99,18,21,26,66,99,99,99,99,24,26,56,99,99,99,99,99,47,66,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99,99],r=0;r<64;r++){var u=a((n[r]*e+50)/100);u=Math.min(Math.max(u,1),255),l[k[r]]=u}for(var h=[1,1.387039845,1.306562965,1.175875602,1,.785694958,.5411961,.275899379],f=0,m=0;m<8;m++)for(var p=0;p<8;p++)c[f]=1/(o[k[f]]*h[m]*h[p]*8),d[f]=1/(l[k[f]]*h[m]*h[p]*8),f++}(e<50?Math.floor(5e3/e):Math.floor(200-2*e)),r=e)}this.encode=function(e,r){var a,u;r&&M(r),p=new Array,g=0,v=7,O(65496),O(65504),O(16),R(74),R(70),R(73),R(70),R(0),R(1),R(1),R(0),O(1),O(1),R(0),R(0),function(){O(65499),O(132),R(0);for(var e=0;e<64;e++)R(o[e]);R(1);for(var t=0;t<64;t++)R(l[t])}(),a=e.width,u=e.height,O(65472),O(17),R(8),O(u),O(a),R(3),R(1),R(17),R(0),R(2),R(17),R(1),R(3),R(17),R(1),function(){O(65476),O(418),R(0);for(var e=0;e<16;e++)R(_[e+1]);for(var t=0;t<=11;t++)R(C[t]);R(16);for(var s=0;s<16;s++)R(N[s+1]);for(var i=0;i<=161;i++)R(T[i]);R(1);for(var n=0;n<16;n++)R(A[n+1]);for(var r=0;r<=11;r++)R(E[r]);R(17);for(var a=0;a<16;a++)R(j[a+1]);for(var o=0;o<=161;o++)R(P[o])}(),O(65498),O(12),R(3),R(1),R(0),R(2),R(17),R(3),R(17),R(0),R(63),R(0);var h=0,f=0,m=0;g=0,v=7,this.encode.displayName="_encode_";for(var w,k,I,U,F,B,q,$,z,H=e.data,V=e.width,G=e.height,J=4*V,W=0;W<G;){for(w=0;w<J;){for(F=J*W+w,q=-1,$=0,z=0;z<64;z++)B=F+($=z>>3)*J+(q=4*(7&z)),W+$>=G&&(B-=J*(W+1+$-G)),w+q>=J&&(B-=w+q-J+4),k=H[B++],I=H[B++],U=H[B++],y[z]=(S[k]+S[I+256|0]+S[U+512|0]>>16)-128,b[z]=(S[k+768|0]+S[I+1024|0]+S[U+1280|0]>>16)-128,x[z]=(S[k+1280|0]+S[I+1536|0]+S[U+1792|0]>>16)-128;h=D(y,c,h,t,i),f=D(b,d,f,s,n),m=D(x,d,m,s,n),w+=32}W+=8}if(v>=0){var K=[];K[1]=v+1,K[0]=(1<<v+1)-1,L(K)}return O(65497),new Uint8Array(p)},e=e||50,function(){for(var e=String.fromCharCode,t=0;t<256;t++)w[t]=e(t)}(),t=I(_,C),s=I(A,E),i=I(N,T),n=I(j,P),function(){for(var e=1,t=2,s=1;s<=15;s++){for(var i=e;i<t;i++)h[32767+i]=s,u[32767+i]=[],u[32767+i][1]=s,u[32767+i][0]=i;for(var n=-(t-1);n<=-e;n++)h[32767+n]=s,u[32767+n]=[],u[32767+n][1]=s,u[32767+n][0]=t-1+n;e<<=1,t<<=1}}(),function(){for(var e=0;e<256;e++)S[e]=19595*e,S[e+256|0]=38470*e,S[e+512|0]=7471*e+32768,S[e+768|0]=-11059*e,S[e+1024|0]=-21709*e,S[e+1280|0]=32768*e+8421375,S[e+1536|0]=-27439*e,S[e+1792|0]=-5329*e}(),M(e)}
/**
 * @license
 * Copyright (c) 2017 Aras Abbasi
 *
 * Licensed under the MIT License.
 * http://opensource.org/licenses/mit-license
 */function sw(e,t){if(this.pos=0,this.buffer=e,this.datav=new DataView(e.buffer),this.is_with_alpha=!!t,this.bottom_up=!0,this.flag=String.fromCharCode(this.buffer[0])+String.fromCharCode(this.buffer[1]),this.pos+=2,-1===["BM","BA","CI","CP","IC","PT"].indexOf(this.flag))throw new Error("Invalid BMP File");this.parseHeader(),this.parseBGR()}function iw(e){function t(e){if(!e)throw Error("assert :P")}function s(e,t,s){for(var i=0;4>i;i++)if(e[t+i]!=s.charCodeAt(i))return!0;return!1}function i(e,t,s,i,n){for(var r=0;r<n;r++)e[t+r]=s[i+r]}function n(e,t,s,i){for(var n=0;n<i;n++)e[t+n]=s}function r(e){return new Int32Array(e)}function a(e,t){for(var s=[],i=0;i<e;i++)s.push(new t);return s}function o(e,t){var s=[];return function e(s,i,n){for(var r=n[i],a=0;a<r&&(s.push(n.length>i+1?[]:new t),!(n.length<i+1));a++)e(s[a],i+1,n)}(s,0,e),s}var l=function(){var e=this;function l(e,t){for(var s=1<<t-1>>>0;e&s;)s>>>=1;return s?(e&s-1)+s:e}function c(e,s,i,n,r){t(!(n%i));do{e[s+(n-=i)]=r}while(0<n)}function d(e,s,i,n,a){if(t(2328>=a),512>=a)var o=r(512);else if(null==(o=r(a)))return 0;return function(e,s,i,n,a,o){var d,h,f=s,m=1<<i,p=r(16),g=r(16);for(t(0!=a),t(null!=n),t(null!=e),t(0<i),h=0;h<a;++h){if(15<n[h])return 0;++p[n[h]]}if(p[0]==a)return 0;for(g[1]=0,d=1;15>d;++d){if(p[d]>1<<d)return 0;g[d+1]=g[d]+p[d]}for(h=0;h<a;++h)d=n[h],0<n[h]&&(o[g[d]++]=h);if(1==g[15])return(n=new u).g=0,n.value=o[0],c(e,f,1,m,n),m;var v,y=-1,b=m-1,x=0,w=1,S=1,k=1<<i;for(h=0,d=1,a=2;d<=i;++d,a<<=1){if(w+=S<<=1,0>(S-=p[d]))return 0;for(;0<p[d];--p[d])(n=new u).g=d,n.value=o[h++],c(e,f+x,a,k,n),x=l(x,d)}for(d=i+1,a=2;15>=d;++d,a<<=1){if(w+=S<<=1,0>(S-=p[d]))return 0;for(;0<p[d];--p[d]){if(n=new u,(x&b)!=y){for(f+=k,v=1<<(y=d)-i;15>y&&!(0>=(v-=p[y]));)++y,v<<=1;m+=k=1<<(v=y-i),e[s+(y=x&b)].g=v+i,e[s+y].value=f-s-y}n.g=d-i,n.value=o[h++],c(e,f+(x>>i),a,k,n),x=l(x,d)}}return w!=2*g[15]-1?0:m}(e,s,i,n,a,o)}function u(){this.value=this.g=0}function h(){this.value=this.g=0}function f(){this.G=a(5,u),this.H=r(5),this.jc=this.Qb=this.qb=this.nd=0,this.pd=a(Ms,h)}function m(e,s,i,n){t(null!=e),t(null!=s),t(2147483648>n),e.Ca=254,e.I=0,e.b=-8,e.Ka=0,e.oa=s,e.pa=i,e.Jd=s,e.Yc=i+n,e.Zc=4<=n?i+n-4+1:i,N(e)}function p(e,t){for(var s=0;0<t--;)s|=A(e,128)<<t;return s}function g(e,t){var s=p(e,t);return T(e)?-s:s}function v(e,s,i,n){var r,a=0;for(t(null!=e),t(null!=s),t(4294967288>n),e.Sb=n,e.Ra=0,e.u=0,e.h=0,4<n&&(n=4),r=0;r<n;++r)a+=s[i+r]<<8*r;e.Ra=a,e.bb=n,e.oa=s,e.pa=i}function y(e){for(;8<=e.u&&e.bb<e.Sb;)e.Ra>>>=8,e.Ra+=e.oa[e.pa+e.bb]<<Bs-8>>>0,++e.bb,e.u-=8;k(e)&&(e.h=1,e.u=0)}function b(e,s){if(t(0<=s),!e.h&&s<=Fs){var i=S(e)&Us[s];return e.u+=s,y(e),i}return e.h=1,e.u=0}function x(){this.b=this.Ca=this.I=0,this.oa=[],this.pa=0,this.Jd=[],this.Yc=0,this.Zc=[],this.Ka=0}function w(){this.Ra=0,this.oa=[],this.h=this.u=this.bb=this.Sb=this.pa=0}function S(e){return e.Ra>>>(e.u&Bs-1)>>>0}function k(e){return t(e.bb<=e.Sb),e.h||e.bb==e.Sb&&e.u>Bs}function _(e,t){e.u=t,e.h=k(e)}function C(e){e.u>=qs&&(t(e.u>=qs),y(e))}function N(e){t(null!=e&&null!=e.oa),e.pa<e.Zc?(e.I=(e.oa[e.pa++]|e.I<<8)>>>0,e.b+=8):(t(null!=e&&null!=e.oa),e.pa<e.Yc?(e.b+=8,e.I=e.oa[e.pa++]|e.I<<8):e.Ka?e.b=0:(e.I<<=8,e.b+=8,e.Ka=1))}function T(e){return p(e,1)}function A(e,t){var s=e.Ca;0>e.b&&N(e);var i=e.b,n=s*t>>>8,r=(e.I>>>i>n)+0;for(r?(s-=n,e.I-=n+1<<i>>>0):s=n+1,i=s,n=0;256<=i;)n+=8,i>>=8;return i=7^n+$s[i],e.b-=i,e.Ca=(s<<i)-1,r}function E(e,t,s){e[t+0]=s>>24&255,e[t+1]=s>>16&255,e[t+2]=s>>8&255,e[t+3]=255&s}function j(e,t){return e[t+0]|e[t+1]<<8}function P(e,t){return j(e,t)|e[t+2]<<16}function I(e,t){return j(e,t)|j(e,t+2)<<16}function L(e,s){var i=1<<s;return t(null!=e),t(0<s),e.X=r(i),null==e.X?0:(e.Mb=32-s,e.Xa=s,1)}function R(e,s){t(null!=e),t(null!=s),t(e.Xa==s.Xa),i(s.X,0,e.X,0,1<<s.Xa)}function O(){this.X=[],this.Xa=this.Mb=0}function D(e,s,i,n){t(null!=i),t(null!=n);var r=i[0],a=n[0];return 0==r&&(r=(e*a+s/2)/s),0==a&&(a=(s*r+e/2)/e),0>=r||0>=a?0:(i[0]=r,n[0]=a,1)}function M(e,t){return e+(1<<t)-1>>>t}function U(e,t){return((4278255360&e)+(4278255360&t)>>>0&4278255360)+((16711935&e)+(16711935&t)>>>0&16711935)>>>0}function F(t,s){e[s]=function(s,i,n,r,a,o,l){var c;for(c=0;c<a;++c){var d=e[t](o[l+c-1],n,r+c);o[l+c]=U(s[i+c],d)}}}function B(){this.ud=this.hd=this.jd=0}function q(e,t){return((4278124286&(e^t))>>>1)+(e&t)>>>0}function $(e){return 0<=e&&256>e?e:0>e?0:255<e?255:void 0}function z(e,t){return $(e+(e-t+.5>>1))}function H(e,t,s){return Math.abs(t-s)-Math.abs(e-s)}function V(e,t,s,i,n,r,a){for(i=r[a-1],s=0;s<n;++s)r[a+s]=i=U(e[t+s],i)}function G(e,t,s,i,n){var r;for(r=0;r<s;++r){var a=e[t+r],o=a>>8&255,l=16711935&(l=(l=16711935&a)+((o<<16)+o));i[n+r]=(4278255360&a)+l>>>0}}function J(e,t){t.jd=255&e,t.hd=e>>8&255,t.ud=e>>16&255}function W(e,t,s,i,n,r){var a;for(a=0;a<i;++a){var o=t[s+a],l=o>>>8,c=o,d=255&(d=(d=o>>>16)+((e.jd<<24>>24)*(l<<24>>24)>>>5));c=255&(c=(c+=(e.hd<<24>>24)*(l<<24>>24)>>>5)+((e.ud<<24>>24)*(d<<24>>24)>>>5)),n[r+a]=(4278255360&o)+(d<<16)+c}}function K(t,s,i,n,r){e[s]=function(e,t,s,i,a,o,l,c,d){for(i=l;i<c;++i)for(l=0;l<d;++l)a[o++]=r(s[n(e[t++])])},e[t]=function(t,s,a,o,l,c,d){var u=8>>t.b,h=t.Ea,f=t.K[0],m=t.w;if(8>u)for(t=(1<<t.b)-1,m=(1<<u)-1;s<a;++s){var p,g=0;for(p=0;p<h;++p)p&t||(g=n(o[l++])),c[d++]=r(f[g&m]),g>>=u}else e["VP8LMapColor"+i](o,l,f,m,c,d,s,a,h)}}function Y(e,t,s,i,n){for(s=t+s;t<s;){var r=e[t++];i[n++]=r>>16&255,i[n++]=r>>8&255,i[n++]=255&r}}function X(e,t,s,i,n){for(s=t+s;t<s;){var r=e[t++];i[n++]=r>>16&255,i[n++]=r>>8&255,i[n++]=255&r,i[n++]=r>>24&255}}function Q(e,t,s,i,n){for(s=t+s;t<s;){var r=(a=e[t++])>>16&240|a>>12&15,a=240&a|a>>28&15;i[n++]=r,i[n++]=a}}function Z(e,t,s,i,n){for(s=t+s;t<s;){var r=(a=e[t++])>>16&248|a>>13&7,a=a>>5&224|a>>3&31;i[n++]=r,i[n++]=a}}function ee(e,t,s,i,n){for(s=t+s;t<s;){var r=e[t++];i[n++]=255&r,i[n++]=r>>8&255,i[n++]=r>>16&255}}function te(e,t,s,n,r,a){if(0==a)for(s=t+s;t<s;)E(n,((a=e[t++])[0]>>24|a[1]>>8&65280|a[2]<<8&16711680|a[3]<<24)>>>0),r+=32;else i(n,r,e,t,s)}function se(t,s){e[s][0]=e[t+"0"],e[s][1]=e[t+"1"],e[s][2]=e[t+"2"],e[s][3]=e[t+"3"],e[s][4]=e[t+"4"],e[s][5]=e[t+"5"],e[s][6]=e[t+"6"],e[s][7]=e[t+"7"],e[s][8]=e[t+"8"],e[s][9]=e[t+"9"],e[s][10]=e[t+"10"],e[s][11]=e[t+"11"],e[s][12]=e[t+"12"],e[s][13]=e[t+"13"],e[s][14]=e[t+"0"],e[s][15]=e[t+"0"]}function ie(e){return e==qi||e==$i||e==zi||e==Hi}function ne(){this.eb=[],this.size=this.A=this.fb=0}function re(){this.y=[],this.f=[],this.ea=[],this.F=[],this.Tc=this.Ed=this.Cd=this.Fd=this.lb=this.Db=this.Ab=this.fa=this.J=this.W=this.N=this.O=0}function ae(){this.Rd=this.height=this.width=this.S=0,this.f={},this.f.RGBA=new ne,this.f.kb=new re,this.sd=null}function oe(){this.width=[0],this.height=[0],this.Pd=[0],this.Qd=[0],this.format=[0]}function le(){this.Id=this.fd=this.Md=this.hb=this.ib=this.da=this.bd=this.cd=this.j=this.v=this.Da=this.Sd=this.ob=0}function ce(e){return alert("todo:WebPSamplerProcessPlane"),e.T}function de(e,t){var s=e.T,n=t.ba.f.RGBA,r=n.eb,a=n.fb+e.ka*n.A,o=gn[t.ba.S],l=e.y,c=e.O,d=e.f,u=e.N,h=e.ea,f=e.W,m=t.cc,p=t.dc,g=t.Mc,v=t.Nc,y=e.ka,b=e.ka+e.T,x=e.U,w=x+1>>1;for(0==y?o(l,c,null,null,d,u,h,f,d,u,h,f,r,a,null,null,x):(o(t.ec,t.fc,l,c,m,p,g,v,d,u,h,f,r,a-n.A,r,a,x),++s);y+2<b;y+=2)m=d,p=u,g=h,v=f,u+=e.Rc,f+=e.Rc,a+=2*n.A,o(l,(c+=2*e.fa)-e.fa,l,c,m,p,g,v,d,u,h,f,r,a-n.A,r,a,x);return c+=e.fa,e.j+b<e.o?(i(t.ec,t.fc,l,c,x),i(t.cc,t.dc,d,u,w),i(t.Mc,t.Nc,h,f,w),s--):1&b||o(l,c,null,null,d,u,h,f,d,u,h,f,r,a+n.A,null,null,x),s}function ue(e,s,i){var n=e.F,r=[e.J];if(null!=n){var a=e.U,o=s.ba.S,l=o==Ui||o==zi;s=s.ba.f.RGBA;var c=[0],d=e.ka;c[0]=e.T,e.Kb&&(0==d?--c[0]:(--d,r[0]-=e.width),e.j+e.ka+e.T==e.o&&(c[0]=e.o-e.j-d));var u=s.eb;d=s.fb+d*s.A,e=ki(n,r[0],e.width,a,c,u,d+(l?0:3),s.A),t(i==c),e&&ie(o)&&wi(u,d,l,a,c,s.A)}return 0}function he(e){var t=e.ma,s=t.ba.S,i=11>s,n=s==Oi||s==Mi||s==Ui||s==Fi||12==s||ie(s);if(t.memory=null,t.Ib=null,t.Jb=null,t.Nd=null,!Rs(t.Oa,e,n?11:12))return 0;if(n&&ie(s)&&vs(),e.da)alert("todo:use_scaling");else{if(i){if(t.Ib=ce,e.Kb){if(s=e.U+1>>1,t.memory=r(e.U+2*s),null==t.memory)return 0;t.ec=t.memory,t.fc=0,t.cc=t.ec,t.dc=t.fc+e.U,t.Mc=t.cc,t.Nc=t.dc+s,t.Ib=de,vs()}}else alert("todo:EmitYUV");n&&(t.Jb=ue,i&&ps())}if(i&&!En){for(e=0;256>e;++e)jn[e]=89858*(e-128)+Cn>>_n,Ln[e]=-22014*(e-128)+Cn,In[e]=-45773*(e-128),Pn[e]=113618*(e-128)+Cn>>_n;for(e=Nn;e<Tn;++e)t=76283*(e-16)+Cn>>_n,Rn[e-Nn]=Ve(t,255),On[e-Nn]=Ve(t+8>>4,15);En=1}return 1}function fe(e){var s=e.ma,i=e.U,n=e.T;return t(!(1&e.ka)),0>=i||0>=n?0:(i=s.Ib(e,s),null!=s.Jb&&s.Jb(e,s,i),s.Dc+=i,1)}function me(e){e.ma.memory=null}function pe(e,t,s,i){return 47!=b(e,8)?0:(t[0]=b(e,14)+1,s[0]=b(e,14)+1,i[0]=b(e,1),0!=b(e,3)?0:!e.h)}function ge(e,t){if(4>e)return e+1;var s=e-2>>1;return(2+(1&e)<<s)+b(t,s)+1}function ve(e,t){return 120<t?t-120:1<=(s=((s=Yi[t-1])>>4)*e+(8-(15&s)))?s:1;var s}function ye(e,t,s){var i=S(s),n=e[t+=255&i].g-8;return 0<n&&(_(s,s.u+8),i=S(s),t+=e[t].value,t+=i&(1<<n)-1),_(s,s.u+e[t].g),e[t].value}function be(e,s,i){return i.g+=e.g,i.value+=e.value<<s>>>0,t(8>=i.g),e.g}function xe(e,s,i){var n=e.xc;return t((s=0==n?0:e.vc[e.md*(i>>n)+(s>>n)])<e.Wb),e.Ya[s]}function we(e,s,n,r){var a=e.ab,o=e.c*s,l=e.C;s=l+s;var c=n,d=r;for(r=e.Ta,n=e.Ua;0<a--;){var u=e.gc[a],h=l,f=s,m=c,p=d,g=(d=r,c=n,u.Ea);switch(t(h<f),t(f<=u.nc),u.hc){case 2:Vs(m,p,(f-h)*g,d,c);break;case 0:var v=h,y=f,b=d,x=c,w=(N=u).Ea;0==v&&(zs(m,p,null,null,1,b,x),V(m,p+1,0,0,w-1,b,x+1),p+=w,x+=w,++v);for(var S=1<<N.b,k=S-1,_=M(w,N.b),C=N.K,N=N.w+(v>>N.b)*_;v<y;){var T=C,A=N,E=1;for(Hs(m,p,b,x-w,1,b,x);E<w;){var j=(E&~k)+S;j>w&&(j=w),(0,Ys[T[A++]>>8&15])(m,p+ +E,b,x+E-w,j-E,b,x+E),E=j}p+=w,x+=w,++v&k||(N+=_)}f!=u.nc&&i(d,c-g,d,c+(f-h-1)*g,g);break;case 1:for(g=m,y=p,w=(m=u.Ea)-(x=m&~(b=(p=1<<u.b)-1)),v=M(m,u.b),S=u.K,u=u.w+(h>>u.b)*v;h<f;){for(k=S,_=u,C=new B,N=y+x,T=y+m;y<N;)J(k[_++],C),Xs(C,g,y,p,d,c),y+=p,c+=p;y<T&&(J(k[_++],C),Xs(C,g,y,w,d,c),y+=w,c+=w),++h&b||(u+=v)}break;case 3:if(m==d&&p==c&&0<u.b){for(y=d,m=g=c+(f-h)*g-(x=(f-h)*M(u.Ea,u.b)),p=d,b=c,v=[],x=(w=x)-1;0<=x;--x)v[x]=p[b+x];for(x=w-1;0<=x;--x)y[m+x]=v[x];Gs(u,h,f,d,g,d,c)}else Gs(u,h,f,m,p,d,c)}c=r,d=n}d!=n&&i(r,n,c,d,o)}function Se(e,s){var i=e.V,n=e.Ba+e.c*e.C,r=s-e.C;if(t(s<=e.l.o),t(16>=r),0<r){var a=e.l,o=e.Ta,l=e.Ua,c=a.width;if(we(e,r,i,n),r=l=[l],t((i=e.C)<(n=s)),t(a.v<a.va),n>a.o&&(n=a.o),i<a.j){var d=a.j-i;i=a.j,r[0]+=d*c}if(i>=n?i=0:(r[0]+=4*a.v,a.ka=i-a.j,a.U=a.va-a.v,a.T=n-i,i=1),i){if(l=l[0],11>(i=e.ca).S){var u=i.f.RGBA,h=(n=i.S,r=a.U,a=a.T,d=u.eb,u.A),f=a;for(u=u.fb+e.Ma*u.A;0<f--;){var m=o,p=l,g=r,v=d,y=u;switch(n){case Ri:Qs(m,p,g,v,y);break;case Oi:Zs(m,p,g,v,y);break;case qi:Zs(m,p,g,v,y),wi(v,y,0,g,1,0);break;case Di:si(m,p,g,v,y);break;case Mi:te(m,p,g,v,y,1);break;case $i:te(m,p,g,v,y,1),wi(v,y,0,g,1,0);break;case Ui:te(m,p,g,v,y,0);break;case zi:te(m,p,g,v,y,0),wi(v,y,1,g,1,0);break;case Fi:ei(m,p,g,v,y);break;case Hi:ei(m,p,g,v,y),Si(v,y,g,1,0);break;case Bi:ti(m,p,g,v,y);break;default:t(0)}l+=c,u+=h}e.Ma+=a}else alert("todo:EmitRescaledRowsYUVA");t(e.Ma<=i.height)}}e.C=s,t(e.C<=e.i)}function ke(e){var t;if(0<e.ua)return 0;for(t=0;t<e.Wb;++t){var s=e.Ya[t].G,i=e.Ya[t].H;if(0<s[1][i[1]+0].g||0<s[2][i[2]+0].g||0<s[3][i[3]+0].g)return 0}return 1}function _e(e,s,i,n,r,a){if(0!=e.Z){var o=e.qd,l=e.rd;for(t(null!=pn[e.Z]);s<i;++s)pn[e.Z](o,l,n,r,n,r,a),o=n,l=r,r+=a;e.qd=o,e.rd=l}}function Ce(e,s){var i=e.l.ma,n=0==i.Z||1==i.Z?e.l.j:e.C;if(n=e.C<n?n:e.C,t(s<=e.l.o),s>n){var r=e.l.width,a=i.ca,o=i.tb+r*n,l=e.V,c=e.Ba+e.c*n,d=e.gc;t(1==e.ab),t(3==d[0].hc),Ws(d[0],n,s,l,c,a,o),_e(i,n,s,a,o,r)}e.C=e.Ma=s}function Ne(e,s,i,n,r,a,o){var l=e.$/n,c=e.$%n,d=e.m,u=e.s,h=i+e.$,f=h;r=i+n*r;var m=i+n*a,p=280+u.ua,g=e.Pb?l:16777216,v=0<u.ua?u.Wa:null,y=u.wc,b=h<m?xe(u,c,l):null;t(e.C<a),t(m<=r);var x=!1;e:for(;;){for(;x||h<m;){var w=0;if(l>=g){var N=h-i;t((g=e).Pb),g.wd=g.m,g.xd=N,0<g.s.ua&&R(g.s.Wa,g.s.vb),g=l+Qi}if(c&y||(b=xe(u,c,l)),t(null!=b),b.Qb&&(s[h]=b.qb,x=!0),!x)if(C(d),b.jc){w=d,N=s;var T=h,A=b.pd[S(w)&Ms-1];t(b.jc),256>A.g?(_(w,w.u+A.g),N[T]=A.value,w=0):(_(w,w.u+A.g-256),t(256<=A.value),w=A.value),0==w&&(x=!0)}else w=ye(b.G[0],b.H[0],d);if(d.h)break;if(x||256>w){if(!x)if(b.nd)s[h]=(b.qb|w<<8)>>>0;else{if(C(d),x=ye(b.G[1],b.H[1],d),C(d),N=ye(b.G[2],b.H[2],d),T=ye(b.G[3],b.H[3],d),d.h)break;s[h]=(T<<24|x<<16|w<<8|N)>>>0}if(x=!1,++h,++c>=n&&(c=0,++l,null!=o&&l<=a&&!(l%16)&&o(e,l),null!=v))for(;f<h;)w=s[f++],v.X[(506832829*w&4294967295)>>>v.Mb]=w}else if(280>w){if(w=ge(w-256,d),N=ye(b.G[4],b.H[4],d),C(d),N=ve(n,N=ge(N,d)),d.h)break;if(h-i<N||r-h<w)break e;for(T=0;T<w;++T)s[h+T]=s[h+T-N];for(h+=w,c+=w;c>=n;)c-=n,++l,null!=o&&l<=a&&!(l%16)&&o(e,l);if(t(h<=r),c&y&&(b=xe(u,c,l)),null!=v)for(;f<h;)w=s[f++],v.X[(506832829*w&4294967295)>>>v.Mb]=w}else{if(!(w<p))break e;for(x=w-280,t(null!=v);f<h;)w=s[f++],v.X[(506832829*w&4294967295)>>>v.Mb]=w;w=h,t(!(x>>>(N=v).Xa)),s[w]=N.X[x],x=!0}x||t(d.h==k(d))}if(e.Pb&&d.h&&h<r)t(e.m.h),e.a=5,e.m=e.wd,e.$=e.xd,0<e.s.ua&&R(e.s.vb,e.s.Wa);else{if(d.h)break e;null!=o&&o(e,l>a?a:l),e.a=0,e.$=h-i}return 1}return e.a=3,0}function Te(e){t(null!=e),e.vc=null,e.yc=null,e.Ya=null;var s=e.Wa;null!=s&&(s.X=null),e.vb=null,t(null!=e)}function Ae(){var t=new rs;return null==t?null:(t.a=0,t.xb=mn,se("Predictor","VP8LPredictors"),se("Predictor","VP8LPredictors_C"),se("PredictorAdd","VP8LPredictorsAdd"),se("PredictorAdd","VP8LPredictorsAdd_C"),Vs=G,Xs=W,Qs=Y,Zs=X,ei=Q,ti=Z,si=ee,e.VP8LMapColor32b=Js,e.VP8LMapColor8b=Ks,t)}function Ee(e,s,i,o,l){var c=1,h=[e],m=[s],p=o.m,g=o.s,v=null,y=0;e:for(;;){if(i)for(;c&&b(p,1);){var x=h,w=m,k=o,N=1,T=k.m,A=k.gc[k.ab],E=b(T,2);if(k.Oc&1<<E)c=0;else{switch(k.Oc|=1<<E,A.hc=E,A.Ea=x[0],A.nc=w[0],A.K=[null],++k.ab,t(4>=k.ab),E){case 0:case 1:A.b=b(T,3)+2,N=Ee(M(A.Ea,A.b),M(A.nc,A.b),0,k,A.K),A.K=A.K[0];break;case 3:var j,P=b(T,8)+1,I=16<P?0:4<P?1:2<P?2:3;if(x[0]=M(A.Ea,I),A.b=I,j=N=Ee(P,1,0,k,A.K)){var R,O=P,D=A,F=1<<(8>>D.b),B=r(F);if(null==B)j=0;else{var q=D.K[0],$=D.w;for(B[0]=D.K[0][0],R=1;R<1*O;++R)B[R]=U(q[$+R],B[R-1]);for(;R<4*F;++R)B[R]=0;D.K[0]=null,D.K[0]=B,j=1}}N=j;break;case 2:break;default:t(0)}c=N}}if(h=h[0],m=m[0],c&&b(p,1)&&!(c=1<=(y=b(p,4))&&11>=y)){o.a=3;break e}var z;if(z=c)t:{var H,V,G,J=o,W=h,K=m,Y=y,X=i,Q=J.m,Z=J.s,ee=[null],te=1,se=0,ie=Xi[Y];s:for(;;){if(X&&b(Q,1)){var ne=b(Q,3)+2,re=M(W,ne),ae=M(K,ne),oe=re*ae;if(!Ee(re,ae,0,J,ee))break s;for(ee=ee[0],Z.xc=ne,H=0;H<oe;++H){var le=ee[H]>>8&65535;ee[H]=le,le>=te&&(te=le+1)}}if(Q.h)break s;for(V=0;5>V;++V){var ce=Ji[V];!V&&0<Y&&(ce+=1<<Y),se<ce&&(se=ce)}var de=a(te*ie,u),ue=te,he=a(ue,f);if(null==he)var fe=null;else t(65536>=ue),fe=he;var me=r(se);if(null==fe||null==me||null==de){J.a=1;break s}var pe=de;for(H=G=0;H<te;++H){var ge=fe[H],ve=ge.G,ye=ge.H,xe=0,we=1,Se=0;for(V=0;5>V;++V){ce=Ji[V],ve[V]=pe,ye[V]=G,!V&&0<Y&&(ce+=1<<Y);i:{var ke,_e=ce,Ce=J,Ae=me,je=pe,Pe=G,Ie=0,Le=Ce.m,Re=b(Le,1);if(n(Ae,0,0,_e),Re){var Oe=b(Le,1)+1,De=b(Le,1),Me=b(Le,0==De?1:8);Ae[Me]=1,2==Oe&&(Ae[Me=b(Le,8)]=1);var Ue=1}else{var Fe=r(19),Be=b(Le,4)+4;if(19<Be){Ce.a=3;var qe=0;break i}for(ke=0;ke<Be;++ke)Fe[Ki[ke]]=b(Le,3);var $e=void 0,ze=void 0,He=Ce,Ve=Fe,Ge=_e,Je=Ae,We=0,Ke=He.m,Ye=8,Xe=a(128,u);n:for(;d(Xe,0,7,Ve,19);){if(b(Ke,1)){var Qe=2+2*b(Ke,3);if(($e=2+b(Ke,Qe))>Ge)break n}else $e=Ge;for(ze=0;ze<Ge&&$e--;){C(Ke);var Ze=Xe[0+(127&S(Ke))];_(Ke,Ke.u+Ze.g);var et=Ze.value;if(16>et)Je[ze++]=et,0!=et&&(Ye=et);else{var tt=16==et,st=et-16,it=Gi[st],nt=b(Ke,Vi[st])+it;if(ze+nt>Ge)break n;for(var rt=tt?Ye:0;0<nt--;)Je[ze++]=rt}}We=1;break n}We||(He.a=3),Ue=We}(Ue=Ue&&!Le.h)&&(Ie=d(je,Pe,8,Ae,_e)),Ue&&0!=Ie?qe=Ie:(Ce.a=3,qe=0)}if(0==qe)break s;if(we&&1==Wi[V]&&(we=0==pe[G].g),xe+=pe[G].g,G+=qe,3>=V){var at,ot=me[0];for(at=1;at<ce;++at)me[at]>ot&&(ot=me[at]);Se+=ot}}if(ge.nd=we,ge.Qb=0,we&&(ge.qb=(ve[3][ye[3]+0].value<<24|ve[1][ye[1]+0].value<<16|ve[2][ye[2]+0].value)>>>0,0==xe&&256>ve[0][ye[0]+0].value&&(ge.Qb=1,ge.qb+=ve[0][ye[0]+0].value<<8)),ge.jc=!ge.Qb&&6>Se,ge.jc){var lt,ct=ge;for(lt=0;lt<Ms;++lt){var dt=lt,ut=ct.pd[dt],ht=ct.G[0][ct.H[0]+dt];256<=ht.value?(ut.g=ht.g+256,ut.value=ht.value):(ut.g=0,ut.value=0,dt>>=be(ht,8,ut),dt>>=be(ct.G[1][ct.H[1]+dt],16,ut),dt>>=be(ct.G[2][ct.H[2]+dt],0,ut),be(ct.G[3][ct.H[3]+dt],24,ut))}}}Z.vc=ee,Z.Wb=te,Z.Ya=fe,Z.yc=de,z=1;break t}z=0}if(!(c=z)){o.a=3;break e}if(0<y){if(g.ua=1<<y,!L(g.Wa,y)){o.a=1,c=0;break e}}else g.ua=0;var ft=o,mt=h,pt=m,gt=ft.s,vt=gt.xc;if(ft.c=mt,ft.i=pt,gt.md=M(mt,vt),gt.wc=0==vt?-1:(1<<vt)-1,i){o.xb=fn;break e}if(null==(v=r(h*m))){o.a=1,c=0;break e}c=(c=Ne(o,v,0,h,m,m,null))&&!p.h;break e}return c?(null!=l?l[0]=v:(t(null==v),t(i)),o.$=0,i||Te(g)):Te(g),c}function je(e,s){var i=e.c*e.i,n=i+s+16*s;return t(e.c<=s),e.V=r(n),null==e.V?(e.Ta=null,e.Ua=0,e.a=1,0):(e.Ta=e.V,e.Ua=e.Ba+i+s,1)}function Pe(e,s){var i=e.C,n=s-i,r=e.V,a=e.Ba+e.c*i;for(t(s<=e.l.o);0<n;){var o=16<n?16:n,l=e.l.ma,c=e.l.width,d=c*o,u=l.ca,h=l.tb+c*i,f=e.Ta,m=e.Ua;we(e,o,r,a),_i(f,m,u,h,d),_e(l,i,i+o,u,h,c),n-=o,r+=o*e.c,i+=o}t(i==s),e.C=e.Ma=s}function Ie(){this.ub=this.yd=this.td=this.Rb=0}function Le(){this.Kd=this.Ld=this.Ud=this.Td=this.i=this.c=0}function Re(){this.Fb=this.Bb=this.Cb=0,this.Zb=r(4),this.Lb=r(4)}function Oe(){var e;this.Yb=(function e(t,s,i){for(var n=i[s],r=0;r<n&&(t.push(i.length>s+1?[]:0),!(i.length<s+1));r++)e(t[r],s+1,i)}(e=[],0,[3,11]),e)}function De(){this.jb=r(3),this.Wc=o([4,8],Oe),this.Xc=o([4,17],Oe)}function Me(){this.Pc=this.wb=this.Tb=this.zd=0,this.vd=new r(4),this.od=new r(4)}function Ue(){this.ld=this.La=this.dd=this.tc=0}function Fe(){this.Na=this.la=0}function Be(){this.Sc=[0,0],this.Eb=[0,0],this.Qc=[0,0],this.ia=this.lc=0}function qe(){this.ad=r(384),this.Za=0,this.Ob=r(16),this.$b=this.Ad=this.ia=this.Gc=this.Hc=this.Dd=0}function $e(){this.uc=this.M=this.Nb=0,this.wa=Array(new Ue),this.Y=0,this.ya=Array(new qe),this.aa=0,this.l=new Ge}function ze(){this.y=r(16),this.f=r(8),this.ea=r(8)}function He(){this.cb=this.a=0,this.sc="",this.m=new x,this.Od=new Ie,this.Kc=new Le,this.ed=new Me,this.Qa=new Re,this.Ic=this.$c=this.Aa=0,this.D=new $e,this.Xb=this.Va=this.Hb=this.zb=this.yb=this.Ub=this.za=0,this.Jc=a(8,x),this.ia=0,this.pb=a(4,Be),this.Pa=new De,this.Bd=this.kc=0,this.Ac=[],this.Bc=0,this.zc=[0,0,0,0],this.Gd=Array(new ze),this.Hd=0,this.rb=Array(new Fe),this.sb=0,this.wa=Array(new Ue),this.Y=0,this.oc=[],this.pc=0,this.sa=[],this.ta=0,this.qa=[],this.ra=0,this.Ha=[],this.B=this.R=this.Ia=0,this.Ec=[],this.M=this.ja=this.Vb=this.Fc=0,this.ya=Array(new qe),this.L=this.aa=0,this.gd=o([4,2],Ue),this.ga=null,this.Fa=[],this.Cc=this.qc=this.P=0,this.Gb=[],this.Uc=0,this.mb=[],this.nb=0,this.rc=[],this.Ga=this.Vc=0}function Ve(e,t){return 0>e?0:e>t?t:e}function Ge(){this.T=this.U=this.ka=this.height=this.width=0,this.y=[],this.f=[],this.ea=[],this.Rc=this.fa=this.W=this.N=this.O=0,this.ma="void",this.put="VP8IoPutHook",this.ac="VP8IoSetupHook",this.bc="VP8IoTeardownHook",this.ha=this.Kb=0,this.data=[],this.hb=this.ib=this.da=this.o=this.j=this.va=this.v=this.Da=this.ob=this.w=0,this.F=[],this.J=0}function Je(){var e=new He;return null!=e&&(e.a=0,e.sc="OK",e.cb=0,e.Xb=0,tn||(tn=Xe)),e}function We(e,t,s){return 0==e.a&&(e.a=t,e.sc=s,e.cb=0),0}function Ke(e,t,s){return 3<=s&&157==e[t+0]&&1==e[t+1]&&42==e[t+2]}function Ye(e,s){if(null==e)return 0;if(e.a=0,e.sc="OK",null==s)return We(e,2,"null VP8Io passed to VP8GetHeaders()");var i=s.data,r=s.w,a=s.ha;if(4>a)return We(e,7,"Truncated header.");var o=i[r+0]|i[r+1]<<8|i[r+2]<<16,l=e.Od;if(l.Rb=!(1&o),l.td=o>>1&7,l.yd=o>>4&1,l.ub=o>>5,3<l.td)return We(e,3,"Incorrect keyframe parameters.");if(!l.yd)return We(e,4,"Frame not displayable.");r+=3,a-=3;var c=e.Kc;if(l.Rb){if(7>a)return We(e,7,"cannot parse picture header");if(!Ke(i,r,a))return We(e,3,"Bad code word");c.c=16383&(i[r+4]<<8|i[r+3]),c.Td=i[r+4]>>6,c.i=16383&(i[r+6]<<8|i[r+5]),c.Ud=i[r+6]>>6,r+=7,a-=7,e.za=c.c+15>>4,e.Ub=c.i+15>>4,s.width=c.c,s.height=c.i,s.Da=0,s.j=0,s.v=0,s.va=s.width,s.o=s.height,s.da=0,s.ib=s.width,s.hb=s.height,s.U=s.width,s.T=s.height,n((o=e.Pa).jb,0,255,o.jb.length),t(null!=(o=e.Qa)),o.Cb=0,o.Bb=0,o.Fb=1,n(o.Zb,0,0,o.Zb.length),n(o.Lb,0,0,o.Lb)}if(l.ub>a)return We(e,7,"bad partition length");m(o=e.m,i,r,l.ub),r+=l.ub,a-=l.ub,l.Rb&&(c.Ld=T(o),c.Kd=T(o)),c=e.Qa;var d,u=e.Pa;if(t(null!=o),t(null!=c),c.Cb=T(o),c.Cb){if(c.Bb=T(o),T(o)){for(c.Fb=T(o),d=0;4>d;++d)c.Zb[d]=T(o)?g(o,7):0;for(d=0;4>d;++d)c.Lb[d]=T(o)?g(o,6):0}if(c.Bb)for(d=0;3>d;++d)u.jb[d]=T(o)?p(o,8):255}else c.Bb=0;if(o.Ka)return We(e,3,"cannot parse segment header");if((c=e.ed).zd=T(o),c.Tb=p(o,6),c.wb=p(o,3),c.Pc=T(o),c.Pc&&T(o)){for(u=0;4>u;++u)T(o)&&(c.vd[u]=g(o,6));for(u=0;4>u;++u)T(o)&&(c.od[u]=g(o,6))}if(e.L=0==c.Tb?0:c.zd?1:2,o.Ka)return We(e,3,"cannot parse filter header");var h=a;if(a=d=r,r=d+h,c=h,e.Xb=(1<<p(e.m,2))-1,h<3*(u=e.Xb))i=7;else{for(d+=3*u,c-=3*u,h=0;h<u;++h){var f=i[a+0]|i[a+1]<<8|i[a+2]<<16;f>c&&(f=c),m(e.Jc[+h],i,d,f),d+=f,c-=f,a+=3}m(e.Jc[+u],i,d,c),i=d<r?0:5}if(0!=i)return We(e,i,"cannot parse partitions");for(i=p(d=e.m,7),a=T(d)?g(d,4):0,r=T(d)?g(d,4):0,c=T(d)?g(d,4):0,u=T(d)?g(d,4):0,d=T(d)?g(d,4):0,h=e.Qa,f=0;4>f;++f){if(h.Cb){var v=h.Zb[f];h.Fb||(v+=i)}else{if(0<f){e.pb[f]=e.pb[0];continue}v=i}var y=e.pb[f];y.Sc[0]=Zi[Ve(v+a,127)],y.Sc[1]=en[Ve(v+0,127)],y.Eb[0]=2*Zi[Ve(v+r,127)],y.Eb[1]=101581*en[Ve(v+c,127)]>>16,8>y.Eb[1]&&(y.Eb[1]=8),y.Qc[0]=Zi[Ve(v+u,117)],y.Qc[1]=en[Ve(v+d,127)],y.lc=v+d}if(!l.Rb)return We(e,4,"Not a key frame.");for(T(o),l=e.Pa,i=0;4>i;++i){for(a=0;8>a;++a)for(r=0;3>r;++r)for(c=0;11>c;++c)u=A(o,ln[i][a][r][c])?p(o,8):an[i][a][r][c],l.Wc[i][a].Yb[r][c]=u;for(a=0;17>a;++a)l.Xc[i][a]=l.Wc[i][cn[a]]}return e.kc=T(o),e.kc&&(e.Bd=p(o,8)),e.cb=1}function Xe(e,t,s,i,n,r,a){var o=t[n].Yb[s];for(s=0;16>n;++n){if(!A(e,o[s+0]))return n;for(;!A(e,o[s+1]);)if(o=t[++n].Yb[0],s=0,16==n)return 16;var l=t[n+1].Yb;if(A(e,o[s+2])){var c=e,d=0;if(A(c,(h=o)[(u=s)+3]))if(A(c,h[u+6])){for(o=0,u=2*(d=A(c,h[u+8]))+(h=A(c,h[u+9+d])),d=0,h=sn[u];h[o];++o)d+=d+A(c,h[o]);d+=3+(8<<u)}else A(c,h[u+7])?(d=7+2*A(c,165),d+=A(c,145)):d=5+A(c,159);else d=A(c,h[u+4])?3+A(c,h[u+5]):2;o=l[2]}else d=1,o=l[1];l=a+nn[n],0>(c=e).b&&N(c);var u,h=c.b,f=(u=c.Ca>>1)-(c.I>>h)>>31;--c.b,c.Ca+=f,c.Ca|=1,c.I-=(u+1&f)<<h,r[l]=((d^f)-f)*i[(0<n)+0]}return 16}function Qe(e){var t=e.rb[e.sb-1];t.la=0,t.Na=0,n(e.zc,0,0,e.zc.length),e.ja=0}function Ze(e,t,s,i,n){n=e[t+s+32*i]+(n>>3),e[t+s+32*i]=-256&n?0>n?0:255:n}function et(e,t,s,i,n,r){Ze(e,t,0,s,i+n),Ze(e,t,1,s,i+r),Ze(e,t,2,s,i-r),Ze(e,t,3,s,i-n)}function tt(e){return(20091*e>>16)+e}function st(e,t,s,i){var n,a=0,o=r(16);for(n=0;4>n;++n){var l=e[t+0]+e[t+8],c=e[t+0]-e[t+8],d=(35468*e[t+4]>>16)-tt(e[t+12]),u=tt(e[t+4])+(35468*e[t+12]>>16);o[a+0]=l+u,o[a+1]=c+d,o[a+2]=c-d,o[a+3]=l-u,a+=4,t++}for(n=a=0;4>n;++n)l=(e=o[a+0]+4)+o[a+8],c=e-o[a+8],d=(35468*o[a+4]>>16)-tt(o[a+12]),Ze(s,i,0,0,l+(u=tt(o[a+4])+(35468*o[a+12]>>16))),Ze(s,i,1,0,c+d),Ze(s,i,2,0,c-d),Ze(s,i,3,0,l-u),a++,i+=32}function it(e,t,s,i){var n=e[t+0]+4,r=35468*e[t+4]>>16,a=tt(e[t+4]),o=35468*e[t+1]>>16;et(s,i,0,n+a,e=tt(e[t+1]),o),et(s,i,1,n+r,e,o),et(s,i,2,n-r,e,o),et(s,i,3,n-a,e,o)}function nt(e,t,s,i,n){st(e,t,s,i),n&&st(e,t+16,s,i+4)}function rt(e,t,s,i){ni(e,t+0,s,i,1),ni(e,t+32,s,i+128,1)}function at(e,t,s,i){var n;for(e=e[t+0]+4,n=0;4>n;++n)for(t=0;4>t;++t)Ze(s,i,t,n,e)}function ot(e,t,s,i){e[t+0]&&oi(e,t+0,s,i),e[t+16]&&oi(e,t+16,s,i+4),e[t+32]&&oi(e,t+32,s,i+128),e[t+48]&&oi(e,t+48,s,i+128+4)}function lt(e,t,s,i){var n,a=r(16);for(n=0;4>n;++n){var o=e[t+0+n]+e[t+12+n],l=e[t+4+n]+e[t+8+n],c=e[t+4+n]-e[t+8+n],d=e[t+0+n]-e[t+12+n];a[0+n]=o+l,a[8+n]=o-l,a[4+n]=d+c,a[12+n]=d-c}for(n=0;4>n;++n)o=(e=a[0+4*n]+3)+a[3+4*n],l=a[1+4*n]+a[2+4*n],c=a[1+4*n]-a[2+4*n],d=e-a[3+4*n],s[i+0]=o+l>>3,s[i+16]=d+c>>3,s[i+32]=o-l>>3,s[i+48]=d-c>>3,i+=64}function ct(e,t,s){var i,n=t-32,r=Ii,a=255-e[n-1];for(i=0;i<s;++i){var o,l=r,c=a+e[t-1];for(o=0;o<s;++o)e[t+o]=l[c+e[n+o]];t+=32}}function dt(e,t){ct(e,t,4)}function ut(e,t){ct(e,t,8)}function ht(e,t){ct(e,t,16)}function ft(e,t){var s;for(s=0;16>s;++s)i(e,t+32*s,e,t-32,16)}function mt(e,t){var s;for(s=16;0<s;--s)n(e,t,e[t-1],16),t+=32}function pt(e,t,s){var i;for(i=0;16>i;++i)n(t,s+32*i,e,16)}function gt(e,t){var s,i=16;for(s=0;16>s;++s)i+=e[t-1+32*s]+e[t+s-32];pt(i>>5,e,t)}function vt(e,t){var s,i=8;for(s=0;16>s;++s)i+=e[t-1+32*s];pt(i>>4,e,t)}function yt(e,t){var s,i=8;for(s=0;16>s;++s)i+=e[t+s-32];pt(i>>4,e,t)}function bt(e,t){pt(128,e,t)}function xt(e,t,s){return e+2*t+s+2>>2}function wt(e,t){var s,n=t-32;for(n=new Uint8Array([xt(e[n-1],e[n+0],e[n+1]),xt(e[n+0],e[n+1],e[n+2]),xt(e[n+1],e[n+2],e[n+3]),xt(e[n+2],e[n+3],e[n+4])]),s=0;4>s;++s)i(e,t+32*s,n,0,n.length)}function St(e,t){var s=e[t-1],i=e[t-1+32],n=e[t-1+64],r=e[t-1+96];E(e,t+0,16843009*xt(e[t-1-32],s,i)),E(e,t+32,16843009*xt(s,i,n)),E(e,t+64,16843009*xt(i,n,r)),E(e,t+96,16843009*xt(n,r,r))}function kt(e,t){var s,i=4;for(s=0;4>s;++s)i+=e[t+s-32]+e[t-1+32*s];for(i>>=3,s=0;4>s;++s)n(e,t+32*s,i,4)}function _t(e,t){var s=e[t-1+0],i=e[t-1+32],n=e[t-1+64],r=e[t-1-32],a=e[t+0-32],o=e[t+1-32],l=e[t+2-32],c=e[t+3-32];e[t+0+96]=xt(i,n,e[t-1+96]),e[t+1+96]=e[t+0+64]=xt(s,i,n),e[t+2+96]=e[t+1+64]=e[t+0+32]=xt(r,s,i),e[t+3+96]=e[t+2+64]=e[t+1+32]=e[t+0+0]=xt(a,r,s),e[t+3+64]=e[t+2+32]=e[t+1+0]=xt(o,a,r),e[t+3+32]=e[t+2+0]=xt(l,o,a),e[t+3+0]=xt(c,l,o)}function Ct(e,t){var s=e[t+1-32],i=e[t+2-32],n=e[t+3-32],r=e[t+4-32],a=e[t+5-32],o=e[t+6-32],l=e[t+7-32];e[t+0+0]=xt(e[t+0-32],s,i),e[t+1+0]=e[t+0+32]=xt(s,i,n),e[t+2+0]=e[t+1+32]=e[t+0+64]=xt(i,n,r),e[t+3+0]=e[t+2+32]=e[t+1+64]=e[t+0+96]=xt(n,r,a),e[t+3+32]=e[t+2+64]=e[t+1+96]=xt(r,a,o),e[t+3+64]=e[t+2+96]=xt(a,o,l),e[t+3+96]=xt(o,l,l)}function Nt(e,t){var s=e[t-1+0],i=e[t-1+32],n=e[t-1+64],r=e[t-1-32],a=e[t+0-32],o=e[t+1-32],l=e[t+2-32],c=e[t+3-32];e[t+0+0]=e[t+1+64]=r+a+1>>1,e[t+1+0]=e[t+2+64]=a+o+1>>1,e[t+2+0]=e[t+3+64]=o+l+1>>1,e[t+3+0]=l+c+1>>1,e[t+0+96]=xt(n,i,s),e[t+0+64]=xt(i,s,r),e[t+0+32]=e[t+1+96]=xt(s,r,a),e[t+1+32]=e[t+2+96]=xt(r,a,o),e[t+2+32]=e[t+3+96]=xt(a,o,l),e[t+3+32]=xt(o,l,c)}function Tt(e,t){var s=e[t+0-32],i=e[t+1-32],n=e[t+2-32],r=e[t+3-32],a=e[t+4-32],o=e[t+5-32],l=e[t+6-32],c=e[t+7-32];e[t+0+0]=s+i+1>>1,e[t+1+0]=e[t+0+64]=i+n+1>>1,e[t+2+0]=e[t+1+64]=n+r+1>>1,e[t+3+0]=e[t+2+64]=r+a+1>>1,e[t+0+32]=xt(s,i,n),e[t+1+32]=e[t+0+96]=xt(i,n,r),e[t+2+32]=e[t+1+96]=xt(n,r,a),e[t+3+32]=e[t+2+96]=xt(r,a,o),e[t+3+64]=xt(a,o,l),e[t+3+96]=xt(o,l,c)}function At(e,t){var s=e[t-1+0],i=e[t-1+32],n=e[t-1+64],r=e[t-1+96];e[t+0+0]=s+i+1>>1,e[t+2+0]=e[t+0+32]=i+n+1>>1,e[t+2+32]=e[t+0+64]=n+r+1>>1,e[t+1+0]=xt(s,i,n),e[t+3+0]=e[t+1+32]=xt(i,n,r),e[t+3+32]=e[t+1+64]=xt(n,r,r),e[t+3+64]=e[t+2+64]=e[t+0+96]=e[t+1+96]=e[t+2+96]=e[t+3+96]=r}function Et(e,t){var s=e[t-1+0],i=e[t-1+32],n=e[t-1+64],r=e[t-1+96],a=e[t-1-32],o=e[t+0-32],l=e[t+1-32],c=e[t+2-32];e[t+0+0]=e[t+2+32]=s+a+1>>1,e[t+0+32]=e[t+2+64]=i+s+1>>1,e[t+0+64]=e[t+2+96]=n+i+1>>1,e[t+0+96]=r+n+1>>1,e[t+3+0]=xt(o,l,c),e[t+2+0]=xt(a,o,l),e[t+1+0]=e[t+3+32]=xt(s,a,o),e[t+1+32]=e[t+3+64]=xt(i,s,a),e[t+1+64]=e[t+3+96]=xt(n,i,s),e[t+1+96]=xt(r,n,i)}function jt(e,t){var s;for(s=0;8>s;++s)i(e,t+32*s,e,t-32,8)}function Pt(e,t){var s;for(s=0;8>s;++s)n(e,t,e[t-1],8),t+=32}function It(e,t,s){var i;for(i=0;8>i;++i)n(t,s+32*i,e,8)}function Lt(e,t){var s,i=8;for(s=0;8>s;++s)i+=e[t+s-32]+e[t-1+32*s];It(i>>4,e,t)}function Rt(e,t){var s,i=4;for(s=0;8>s;++s)i+=e[t+s-32];It(i>>3,e,t)}function Ot(e,t){var s,i=4;for(s=0;8>s;++s)i+=e[t-1+32*s];It(i>>3,e,t)}function Dt(e,t){It(128,e,t)}function Mt(e,t,s){var i=e[t-s],n=e[t+0],r=3*(n-i)+ji[1020+e[t-2*s]-e[t+s]],a=Pi[112+(r+4>>3)];e[t-s]=Ii[255+i+Pi[112+(r+3>>3)]],e[t+0]=Ii[255+n-a]}function Ut(e,t,s,i){var n=e[t+0],r=e[t+s];return Li[255+e[t-2*s]-e[t-s]]>i||Li[255+r-n]>i}function Ft(e,t,s,i){return 4*Li[255+e[t-s]-e[t+0]]+Li[255+e[t-2*s]-e[t+s]]<=i}function Bt(e,t,s,i,n){var r=e[t-3*s],a=e[t-2*s],o=e[t-s],l=e[t+0],c=e[t+s],d=e[t+2*s],u=e[t+3*s];return 4*Li[255+o-l]+Li[255+a-c]>i?0:Li[255+e[t-4*s]-r]<=n&&Li[255+r-a]<=n&&Li[255+a-o]<=n&&Li[255+u-d]<=n&&Li[255+d-c]<=n&&Li[255+c-l]<=n}function qt(e,t,s,i){var n=2*i+1;for(i=0;16>i;++i)Ft(e,t+i,s,n)&&Mt(e,t+i,s)}function $t(e,t,s,i){var n=2*i+1;for(i=0;16>i;++i)Ft(e,t+i*s,1,n)&&Mt(e,t+i*s,1)}function zt(e,t,s,i){var n;for(n=3;0<n;--n)qt(e,t+=4*s,s,i)}function Ht(e,t,s,i){var n;for(n=3;0<n;--n)$t(e,t+=4,s,i)}function Vt(e,t,s,i,n,r,a,o){for(r=2*r+1;0<n--;){if(Bt(e,t,s,r,a))if(Ut(e,t,s,o))Mt(e,t,s);else{var l=e,c=t,d=s,u=l[c-2*d],h=l[c-d],f=l[c+0],m=l[c+d],p=l[c+2*d],g=27*(y=ji[1020+3*(f-h)+ji[1020+u-m]])+63>>7,v=18*y+63>>7,y=9*y+63>>7;l[c-3*d]=Ii[255+l[c-3*d]+y],l[c-2*d]=Ii[255+u+v],l[c-d]=Ii[255+h+g],l[c+0]=Ii[255+f-g],l[c+d]=Ii[255+m-v],l[c+2*d]=Ii[255+p-y]}t+=i}}function Gt(e,t,s,i,n,r,a,o){for(r=2*r+1;0<n--;){if(Bt(e,t,s,r,a))if(Ut(e,t,s,o))Mt(e,t,s);else{var l=e,c=t,d=s,u=l[c-d],h=l[c+0],f=l[c+d],m=Pi[112+(4+(p=3*(h-u))>>3)],p=Pi[112+(p+3>>3)],g=m+1>>1;l[c-2*d]=Ii[255+l[c-2*d]+g],l[c-d]=Ii[255+u+p],l[c+0]=Ii[255+h-m],l[c+d]=Ii[255+f-g]}t+=i}}function Jt(e,t,s,i,n,r){Vt(e,t,s,1,16,i,n,r)}function Wt(e,t,s,i,n,r){Vt(e,t,1,s,16,i,n,r)}function Kt(e,t,s,i,n,r){var a;for(a=3;0<a;--a)Gt(e,t+=4*s,s,1,16,i,n,r)}function Yt(e,t,s,i,n,r){var a;for(a=3;0<a;--a)Gt(e,t+=4,1,s,16,i,n,r)}function Xt(e,t,s,i,n,r,a,o){Vt(e,t,n,1,8,r,a,o),Vt(s,i,n,1,8,r,a,o)}function Qt(e,t,s,i,n,r,a,o){Vt(e,t,1,n,8,r,a,o),Vt(s,i,1,n,8,r,a,o)}function Zt(e,t,s,i,n,r,a,o){Gt(e,t+4*n,n,1,8,r,a,o),Gt(s,i+4*n,n,1,8,r,a,o)}function es(e,t,s,i,n,r,a,o){Gt(e,t+4,1,n,8,r,a,o),Gt(s,i+4,1,n,8,r,a,o)}function ts(){this.ba=new ae,this.ec=[],this.cc=[],this.Mc=[],this.Dc=this.Nc=this.dc=this.fc=0,this.Oa=new le,this.memory=0,this.Ib="OutputFunc",this.Jb="OutputAlphaFunc",this.Nd="OutputRowFunc"}function ss(){this.data=[],this.offset=this.kd=this.ha=this.w=0,this.na=[],this.xa=this.gb=this.Ja=this.Sa=this.P=0}function is(){this.nc=this.Ea=this.b=this.hc=0,this.K=[],this.w=0}function ns(){this.ua=0,this.Wa=new O,this.vb=new O,this.md=this.xc=this.wc=0,this.vc=[],this.Wb=0,this.Ya=new f,this.yc=new u}function rs(){this.xb=this.a=0,this.l=new Ge,this.ca=new ae,this.V=[],this.Ba=0,this.Ta=[],this.Ua=0,this.m=new w,this.Pb=0,this.wd=new w,this.Ma=this.$=this.C=this.i=this.c=this.xd=0,this.s=new ns,this.ab=0,this.gc=a(4,is),this.Oc=0}function as(){this.Lc=this.Z=this.$a=this.i=this.c=0,this.l=new Ge,this.ic=0,this.ca=[],this.tb=0,this.qd=null,this.rd=0}function os(e,t,s,i,n,r,a){for(e=null==e?0:e[t+0],t=0;t<a;++t)n[r+t]=e+s[i+t]&255,e=n[r+t]}function ls(e,t,s,i,n,r,a){var o;if(null==e)os(null,null,s,i,n,r,a);else for(o=0;o<a;++o)n[r+o]=e[t+o]+s[i+o]&255}function cs(e,t,s,i,n,r,a){if(null==e)os(null,null,s,i,n,r,a);else{var o,l=e[t+0],c=l,d=l;for(o=0;o<a;++o)c=d+(l=e[t+o])-c,d=s[i+o]+(-256&c?0>c?0:255:c)&255,c=l,n[r+o]=d}}function ds(e,s,n,a){var o=s.width,l=s.o;if(t(null!=e&&null!=s),0>n||0>=a||n+a>l)return null;if(!e.Cc){if(null==e.ga){var c;if(e.ga=new as,(c=null==e.ga)||(c=s.width*s.o,t(0==e.Gb.length),e.Gb=r(c),e.Uc=0,null==e.Gb?c=0:(e.mb=e.Gb,e.nb=e.Uc,e.rc=null,c=1),c=!c),!c){c=e.ga;var d=e.Fa,u=e.P,h=e.qc,f=e.mb,m=e.nb,p=u+1,g=h-1,y=c.l;if(t(null!=d&&null!=f&&null!=s),pn[0]=null,pn[1]=os,pn[2]=ls,pn[3]=cs,c.ca=f,c.tb=m,c.c=s.width,c.i=s.height,t(0<c.c&&0<c.i),1>=h)s=0;else if(c.$a=3&d[u+0],c.Z=d[u+0]>>2&3,c.Lc=d[u+0]>>4&3,u=d[u+0]>>6&3,0>c.$a||1<c.$a||4<=c.Z||1<c.Lc||u)s=0;else if(y.put=fe,y.ac=he,y.bc=me,y.ma=c,y.width=s.width,y.height=s.height,y.Da=s.Da,y.v=s.v,y.va=s.va,y.j=s.j,y.o=s.o,c.$a)e:{t(1==c.$a),s=Ae();t:for(;;){if(null==s){s=0;break e}if(t(null!=c),c.mc=s,s.c=c.c,s.i=c.i,s.l=c.l,s.l.ma=c,s.l.width=c.c,s.l.height=c.i,s.a=0,v(s.m,d,p,g),!Ee(c.c,c.i,1,s,null))break t;if(1==s.ab&&3==s.gc[0].hc&&ke(s.s)?(c.ic=1,d=s.c*s.i,s.Ta=null,s.Ua=0,s.V=r(d),s.Ba=0,null==s.V?(s.a=1,s=0):s=1):(c.ic=0,s=je(s,c.c)),!s)break t;s=1;break e}c.mc=null,s=0}else s=g>=c.c*c.i;c=!s}if(c)return null;1!=e.ga.Lc?e.Ga=0:a=l-n}t(null!=e.ga),t(n+a<=l);e:{if(s=(d=e.ga).c,l=d.l.o,0==d.$a){if(p=e.rc,g=e.Vc,y=e.Fa,u=e.P+1+n*s,h=e.mb,f=e.nb+n*s,t(u<=e.P+e.qc),0!=d.Z)for(t(null!=pn[d.Z]),c=0;c<a;++c)pn[d.Z](p,g,y,u,h,f,s),p=h,g=f,f+=s,u+=s;else for(c=0;c<a;++c)i(h,f,y,u,s),p=h,g=f,f+=s,u+=s;e.rc=p,e.Vc=g}else{if(t(null!=d.mc),s=n+a,t(null!=(c=d.mc)),t(s<=c.i),c.C>=s)s=1;else if(d.ic||ps(),d.ic){d=c.V,p=c.Ba,g=c.c;var b=c.i,x=(y=1,u=c.$/g,h=c.$%g,f=c.m,m=c.s,c.$),w=g*b,S=g*s,_=m.wc,N=x<S?xe(m,h,u):null;t(x<=w),t(s<=b),t(ke(m));t:for(;;){for(;!f.h&&x<S;){if(h&_||(N=xe(m,h,u)),t(null!=N),C(f),256>(b=ye(N.G[0],N.H[0],f)))d[p+x]=b,++x,++h>=g&&(h=0,++u<=s&&!(u%16)&&Ce(c,u));else{if(!(280>b)){y=0;break t}b=ge(b-256,f);var T,A=ye(N.G[4],N.H[4],f);if(C(f),!(x>=(A=ve(g,A=ge(A,f)))&&w-x>=b)){y=0;break t}for(T=0;T<b;++T)d[p+x+T]=d[p+x+T-A];for(x+=b,h+=b;h>=g;)h-=g,++u<=s&&!(u%16)&&Ce(c,u);x<S&&h&_&&(N=xe(m,h,u))}t(f.h==k(f))}Ce(c,u>s?s:u);break t}!y||f.h&&x<w?(y=0,c.a=f.h?5:3):c.$=x,s=y}else s=Ne(c,c.V,c.Ba,c.c,c.i,s,Pe);if(!s){a=0;break e}}n+a>=l&&(e.Cc=1),a=1}if(!a)return null;if(e.Cc&&(null!=(a=e.ga)&&(a.mc=null),e.ga=null,0<e.Ga))return alert("todo:WebPDequantizeLevels"),null}return e.nb+n*o}function us(e,t,s,i,n,r){for(;0<n--;){var a,o=e,l=t+(s?1:0),c=e,d=t+(s?0:3);for(a=0;a<i;++a){var u=c[d+4*a];255!=u&&(u*=32897,o[l+4*a+0]=o[l+4*a+0]*u>>23,o[l+4*a+1]=o[l+4*a+1]*u>>23,o[l+4*a+2]=o[l+4*a+2]*u>>23)}t+=r}}function hs(e,t,s,i,n){for(;0<i--;){var r;for(r=0;r<s;++r){var a=e[t+2*r+0],o=15&(c=e[t+2*r+1]),l=4369*o,c=(240&c|c>>4)*l>>16;e[t+2*r+0]=(240&a|a>>4)*l>>16&240|(15&a|a<<4)*l>>16>>4&15,e[t+2*r+1]=240&c|o}t+=n}}function fs(e,t,s,i,n,r,a,o){var l,c,d=255;for(c=0;c<n;++c){for(l=0;l<i;++l){var u=e[t+l];r[a+4*l]=u,d&=u}t+=s,a+=o}return 255!=d}function ms(e,t,s,i,n){var r;for(r=0;r<n;++r)s[i+r]=e[t+r]>>8}function ps(){wi=us,Si=hs,ki=fs,_i=ms}function gs(s,i,n){e[s]=function(e,s,r,a,o,l,c,d,u,h,f,m,p,g,v,y,b){var x,w=b-1>>1,S=o[l+0]|c[d+0]<<16,k=u[h+0]|f[m+0]<<16;t(null!=e);var _=3*S+k+131074>>2;for(i(e[s+0],255&_,_>>16,p,g),null!=r&&(_=3*k+S+131074>>2,i(r[a+0],255&_,_>>16,v,y)),x=1;x<=w;++x){var C=o[l+x]|c[d+x]<<16,N=u[h+x]|f[m+x]<<16,T=S+C+k+N+524296,A=T+2*(C+k)>>3;_=A+S>>1,S=(T=T+2*(S+N)>>3)+C>>1,i(e[s+2*x-1],255&_,_>>16,p,g+(2*x-1)*n),i(e[s+2*x-0],255&S,S>>16,p,g+(2*x-0)*n),null!=r&&(_=T+k>>1,S=A+N>>1,i(r[a+2*x-1],255&_,_>>16,v,y+(2*x-1)*n),i(r[a+2*x+0],255&S,S>>16,v,y+(2*x+0)*n)),S=C,k=N}1&b||(_=3*S+k+131074>>2,i(e[s+b-1],255&_,_>>16,p,g+(b-1)*n),null!=r&&(_=3*k+S+131074>>2,i(r[a+b-1],255&_,_>>16,v,y+(b-1)*n)))}}function vs(){gn[Ri]=vn,gn[Oi]=bn,gn[Di]=yn,gn[Mi]=xn,gn[Ui]=wn,gn[Fi]=Sn,gn[Bi]=kn,gn[qi]=bn,gn[$i]=xn,gn[zi]=wn,gn[Hi]=Sn}function ys(e){return-16384&e?0>e?0:255:e>>An}function bs(e,t){return ys((19077*e>>8)+(26149*t>>8)-14234)}function xs(e,t,s){return ys((19077*e>>8)-(6419*t>>8)-(13320*s>>8)+8708)}function ws(e,t){return ys((19077*e>>8)+(33050*t>>8)-17685)}function Ss(e,t,s,i,n){i[n+0]=bs(e,s),i[n+1]=xs(e,t,s),i[n+2]=ws(e,t)}function ks(e,t,s,i,n){i[n+0]=ws(e,t),i[n+1]=xs(e,t,s),i[n+2]=bs(e,s)}function _s(e,t,s,i,n){var r=xs(e,t,s);t=r<<3&224|ws(e,t)>>3,i[n+0]=248&bs(e,s)|r>>5,i[n+1]=t}function Cs(e,t,s,i,n){var r=240&ws(e,t)|15;i[n+0]=240&bs(e,s)|xs(e,t,s)>>4,i[n+1]=r}function Ns(e,t,s,i,n){i[n+0]=255,Ss(e,t,s,i,n+1)}function Ts(e,t,s,i,n){ks(e,t,s,i,n),i[n+3]=255}function As(e,t,s,i,n){Ss(e,t,s,i,n),i[n+3]=255}function Ve(e,t){return 0>e?0:e>t?t:e}function Es(t,s,i){e[t]=function(e,t,n,r,a,o,l,c,d){for(var u=c+(-2&d)*i;c!=u;)s(e[t+0],n[r+0],a[o+0],l,c),s(e[t+1],n[r+0],a[o+0],l,c+i),t+=2,++r,++o,c+=2*i;1&d&&s(e[t+0],n[r+0],a[o+0],l,c)}}function js(e,t,s){return 0==s?0==e?0==t?6:5:0==t?4:0:s}function Ps(e,t,s,i,n){switch(e>>>30){case 3:ni(t,s,i,n,0);break;case 2:ri(t,s,i,n);break;case 1:oi(t,s,i,n)}}function Is(e,t){var s,r,a=t.M,o=t.Nb,l=e.oc,c=e.pc+40,d=e.oc,u=e.pc+584,h=e.oc,f=e.pc+600;for(s=0;16>s;++s)l[c+32*s-1]=129;for(s=0;8>s;++s)d[u+32*s-1]=129,h[f+32*s-1]=129;for(0<a?l[c-1-32]=d[u-1-32]=h[f-1-32]=129:(n(l,c-32-1,127,21),n(d,u-32-1,127,9),n(h,f-32-1,127,9)),r=0;r<e.za;++r){var m=t.ya[t.aa+r];if(0<r){for(s=-1;16>s;++s)i(l,c+32*s-4,l,c+32*s+12,4);for(s=-1;8>s;++s)i(d,u+32*s-4,d,u+32*s+4,4),i(h,f+32*s-4,h,f+32*s+4,4)}var p=e.Gd,g=e.Hd+r,v=m.ad,y=m.Hc;if(0<a&&(i(l,c-32,p[g].y,0,16),i(d,u-32,p[g].f,0,8),i(h,f-32,p[g].ea,0,8)),m.Za){var b=l,x=c-32+16;for(0<a&&(r>=e.za-1?n(b,x,p[g].y[15],4):i(b,x,p[g+1].y,0,4)),s=0;4>s;s++)b[x+128+s]=b[x+256+s]=b[x+384+s]=b[x+0+s];for(s=0;16>s;++s,y<<=2)b=l,x=c+Dn[s],un[m.Ob[s]](b,x),Ps(y,v,16*+s,b,x)}else if(b=js(r,a,m.Ob[0]),dn[b](l,c),0!=y)for(s=0;16>s;++s,y<<=2)Ps(y,v,16*+s,l,c+Dn[s]);for(s=m.Gc,b=js(r,a,m.Dd),hn[b](d,u),hn[b](h,f),y=v,b=d,x=u,255&(m=s|0)&&(170&m?ai(y,256,b,x):li(y,256,b,x)),m=h,y=f,255&(s>>=8)&&(170&s?ai(v,320,m,y):li(v,320,m,y)),a<e.Ub-1&&(i(p[g].y,0,l,c+480,16),i(p[g].f,0,d,u+224,8),i(p[g].ea,0,h,f+224,8)),s=8*o*e.B,p=e.sa,g=e.ta+16*r+16*o*e.R,v=e.qa,m=e.ra+8*r+s,y=e.Ha,b=e.Ia+8*r+s,s=0;16>s;++s)i(p,g+s*e.R,l,c+32*s,16);for(s=0;8>s;++s)i(v,m+s*e.B,d,u+32*s,8),i(y,b+s*e.B,h,f+32*s,8)}}function Ls(e,i,n,r,a,o,l,c,d){var u=[0],h=[0],f=0,m=null!=d?d.kd:0,p=null!=d?d:new ss;if(null==e||12>n)return 7;p.data=e,p.w=i,p.ha=n,i=[i],n=[n],p.gb=[p.gb];e:{var g=i,y=n,b=p.gb;if(t(null!=e),t(null!=y),t(null!=b),b[0]=0,12<=y[0]&&!s(e,g[0],"RIFF")){if(s(e,g[0]+8,"WEBP")){b=3;break e}var x=I(e,g[0]+4);if(12>x||4294967286<x){b=3;break e}if(m&&x>y[0]-8){b=7;break e}b[0]=x,g[0]+=12,y[0]-=12}b=0}if(0!=b)return b;for(x=0<p.gb[0],n=n[0];;){e:{var S=e;y=i,b=n;var k=u,_=h,C=g=[0];if((A=f=[f])[0]=0,8>b[0])b=7;else{if(!s(S,y[0],"VP8X")){if(10!=I(S,y[0]+4)){b=3;break e}if(18>b[0]){b=7;break e}var N=I(S,y[0]+8),T=1+P(S,y[0]+12);if(2147483648<=T*(S=1+P(S,y[0]+15))){b=3;break e}null!=C&&(C[0]=N),null!=k&&(k[0]=T),null!=_&&(_[0]=S),y[0]+=18,b[0]-=18,A[0]=1}b=0}}if(f=f[0],g=g[0],0!=b)return b;if(y=!!(2&g),!x&&f)return 3;if(null!=o&&(o[0]=!!(16&g)),null!=l&&(l[0]=y),null!=c&&(c[0]=0),l=u[0],g=h[0],f&&y&&null==d){b=0;break}if(4>n){b=7;break}if(x&&f||!x&&!f&&!s(e,i[0],"ALPH")){n=[n],p.na=[p.na],p.P=[p.P],p.Sa=[p.Sa];e:{N=e,b=i,x=n;var A=p.gb;k=p.na,_=p.P,C=p.Sa,T=22,t(null!=N),t(null!=x),S=b[0];var E=x[0];for(t(null!=k),t(null!=C),k[0]=null,_[0]=null,C[0]=0;;){if(b[0]=S,x[0]=E,8>E){b=7;break e}var j=I(N,S+4);if(4294967286<j){b=3;break e}var L=8+j+1&-2;if(T+=L,0<A&&T>A){b=3;break e}if(!s(N,S,"VP8 ")||!s(N,S,"VP8L")){b=0;break e}if(E[0]<L){b=7;break e}s(N,S,"ALPH")||(k[0]=N,_[0]=S+8,C[0]=j),S+=L,E-=L}}if(n=n[0],p.na=p.na[0],p.P=p.P[0],p.Sa=p.Sa[0],0!=b)break}n=[n],p.Ja=[p.Ja],p.xa=[p.xa];e:if(A=e,b=i,x=n,k=p.gb[0],_=p.Ja,C=p.xa,N=b[0],S=!s(A,N,"VP8 "),T=!s(A,N,"VP8L"),t(null!=A),t(null!=x),t(null!=_),t(null!=C),8>x[0])b=7;else{if(S||T){if(A=I(A,N+4),12<=k&&A>k-12){b=3;break e}if(m&&A>x[0]-8){b=7;break e}_[0]=A,b[0]+=8,x[0]-=8,C[0]=T}else C[0]=5<=x[0]&&47==A[N+0]&&!(A[N+4]>>5),_[0]=x[0];b=0}if(n=n[0],p.Ja=p.Ja[0],p.xa=p.xa[0],i=i[0],0!=b)break;if(4294967286<p.Ja)return 3;if(null==c||y||(c[0]=p.xa?2:1),l=[l],g=[g],p.xa){if(5>n){b=7;break}c=l,m=g,y=o,null==e||5>n?e=0:5<=n&&47==e[i+0]&&!(e[i+4]>>5)?(x=[0],A=[0],k=[0],v(_=new w,e,i,n),pe(_,x,A,k)?(null!=c&&(c[0]=x[0]),null!=m&&(m[0]=A[0]),null!=y&&(y[0]=k[0]),e=1):e=0):e=0}else{if(10>n){b=7;break}c=g,null==e||10>n||!Ke(e,i+3,n-3)?e=0:(m=e[i+0]|e[i+1]<<8|e[i+2]<<16,y=16383&(e[i+7]<<8|e[i+6]),e=16383&(e[i+9]<<8|e[i+8]),1&m||3<(m>>1&7)||!(m>>4&1)||m>>5>=p.Ja||!y||!e?e=0:(l&&(l[0]=y),c&&(c[0]=e),e=1))}if(!e)return 3;if(l=l[0],g=g[0],f&&(u[0]!=l||h[0]!=g))return 3;null!=d&&(d[0]=p,d.offset=i-d.w,t(4294967286>i-d.w),t(d.offset==d.ha-n));break}return 0==b||7==b&&f&&null==d?(null!=o&&(o[0]|=null!=p.na&&0<p.na.length),null!=r&&(r[0]=l),null!=a&&(a[0]=g),0):b}function Rs(e,t,s){var i=t.width,n=t.height,r=0,a=0,o=i,l=n;if(t.Da=null!=e&&0<e.Da,t.Da&&(o=e.cd,l=e.bd,r=e.v,a=e.j,11>s||(r&=-2,a&=-2),0>r||0>a||0>=o||0>=l||r+o>i||a+l>n))return 0;if(t.v=r,t.j=a,t.va=r+o,t.o=a+l,t.U=o,t.T=l,t.da=null!=e&&0<e.da,t.da){if(!D(o,l,s=[e.ib],r=[e.hb]))return 0;t.ib=s[0],t.hb=r[0]}return t.ob=null!=e&&e.ob,t.Kb=null==e||!e.Sd,t.da&&(t.ob=t.ib<3*i/4&&t.hb<3*n/4,t.Kb=0),1}function Os(e){if(null==e)return 2;if(11>e.S){var t=e.f.RGBA;t.fb+=(e.height-1)*t.A,t.A=-t.A}else t=e.f.kb,e=e.height,t.O+=(e-1)*t.fa,t.fa=-t.fa,t.N+=(e-1>>1)*t.Ab,t.Ab=-t.Ab,t.W+=(e-1>>1)*t.Db,t.Db=-t.Db,null!=t.F&&(t.J+=(e-1)*t.lb,t.lb=-t.lb);return 0}function Ds(e,t,s,i){if(null==i||0>=e||0>=t)return 2;if(null!=s){if(s.Da){var n=s.cd,a=s.bd,o=-2&s.v,l=-2&s.j;if(0>o||0>l||0>=n||0>=a||o+n>e||l+a>t)return 2;e=n,t=a}if(s.da){if(!D(e,t,n=[s.ib],a=[s.hb]))return 2;e=n[0],t=a[0]}}i.width=e,i.height=t;e:{var c=i.width,d=i.height;if(e=i.S,0>=c||0>=d||!(e>=Ri&&13>e))e=2;else{if(0>=i.Rd&&null==i.sd){o=a=n=t=0;var u=(l=c*Bn[e])*d;if(11>e||(a=(d+1)/2*(t=(c+1)/2),12==e&&(o=(n=c)*d)),null==(d=r(u+2*a+o))){e=1;break e}i.sd=d,11>e?((c=i.f.RGBA).eb=d,c.fb=0,c.A=l,c.size=u):((c=i.f.kb).y=d,c.O=0,c.fa=l,c.Fd=u,c.f=d,c.N=0+u,c.Ab=t,c.Cd=a,c.ea=d,c.W=0+u+a,c.Db=t,c.Ed=a,12==e&&(c.F=d,c.J=0+u+2*a),c.Tc=o,c.lb=n)}if(t=1,n=i.S,a=i.width,o=i.height,n>=Ri&&13>n)if(11>n)e=i.f.RGBA,t&=(l=Math.abs(e.A))*(o-1)+a<=e.size,t&=l>=a*Bn[n],t&=null!=e.eb;else{e=i.f.kb,l=(a+1)/2,u=(o+1)/2,c=Math.abs(e.fa),d=Math.abs(e.Ab);var h=Math.abs(e.Db),f=Math.abs(e.lb),m=f*(o-1)+a;t&=c*(o-1)+a<=e.Fd,t&=d*(u-1)+l<=e.Cd,t=(t&=h*(u-1)+l<=e.Ed)&c>=a&d>=l&h>=l,t&=null!=e.y,t&=null!=e.f,t&=null!=e.ea,12==n&&(t&=f>=a,t&=m<=e.Tc,t&=null!=e.F)}else t=0;e=t?0:2}}return 0!=e||null!=s&&s.fd&&(e=Os(i)),e}var Ms=64,Us=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535,131071,262143,524287,1048575,2097151,4194303,8388607,16777215],Fs=24,Bs=32,qs=8,$s=[0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7];F("Predictor0","PredictorAdd0"),e.Predictor0=function(){return 4278190080},e.Predictor1=function(e){return e},e.Predictor2=function(e,t,s){return t[s+0]},e.Predictor3=function(e,t,s){return t[s+1]},e.Predictor4=function(e,t,s){return t[s-1]},e.Predictor5=function(e,t,s){return q(q(e,t[s+1]),t[s+0])},e.Predictor6=function(e,t,s){return q(e,t[s-1])},e.Predictor7=function(e,t,s){return q(e,t[s+0])},e.Predictor8=function(e,t,s){return q(t[s-1],t[s+0])},e.Predictor9=function(e,t,s){return q(t[s+0],t[s+1])},e.Predictor10=function(e,t,s){return q(q(e,t[s-1]),q(t[s+0],t[s+1]))},e.Predictor11=function(e,t,s){var i=t[s+0];return 0>=H(i>>24&255,e>>24&255,(t=t[s-1])>>24&255)+H(i>>16&255,e>>16&255,t>>16&255)+H(i>>8&255,e>>8&255,t>>8&255)+H(255&i,255&e,255&t)?i:e},e.Predictor12=function(e,t,s){var i=t[s+0];return($((e>>24&255)+(i>>24&255)-((t=t[s-1])>>24&255))<<24|$((e>>16&255)+(i>>16&255)-(t>>16&255))<<16|$((e>>8&255)+(i>>8&255)-(t>>8&255))<<8|$((255&e)+(255&i)-(255&t)))>>>0},e.Predictor13=function(e,t,s){var i=t[s-1];return(z((e=q(e,t[s+0]))>>24&255,i>>24&255)<<24|z(e>>16&255,i>>16&255)<<16|z(e>>8&255,i>>8&255)<<8|z(255&e,255&i))>>>0};var zs=e.PredictorAdd0;e.PredictorAdd1=V,F("Predictor2","PredictorAdd2"),F("Predictor3","PredictorAdd3"),F("Predictor4","PredictorAdd4"),F("Predictor5","PredictorAdd5"),F("Predictor6","PredictorAdd6"),F("Predictor7","PredictorAdd7"),F("Predictor8","PredictorAdd8"),F("Predictor9","PredictorAdd9"),F("Predictor10","PredictorAdd10"),F("Predictor11","PredictorAdd11"),F("Predictor12","PredictorAdd12"),F("Predictor13","PredictorAdd13");var Hs=e.PredictorAdd2;K("ColorIndexInverseTransform","MapARGB","32b",function(e){return e>>8&255},function(e){return e}),K("VP8LColorIndexInverseTransformAlpha","MapAlpha","8b",function(e){return e},function(e){return e>>8&255});var Vs,Gs=e.ColorIndexInverseTransform,Js=e.MapARGB,Ws=e.VP8LColorIndexInverseTransformAlpha,Ks=e.MapAlpha,Ys=e.VP8LPredictorsAdd=[];Ys.length=16,(e.VP8LPredictors=[]).length=16,(e.VP8LPredictorsAdd_C=[]).length=16,(e.VP8LPredictors_C=[]).length=16;var Xs,Qs,Zs,ei,ti,si,ii,ni,ri,ai,oi,li,ci,di,ui,hi,fi,mi,pi,gi,vi,yi,bi,xi,wi,Si,ki,_i,Ci=r(511),Ni=r(2041),Ti=r(225),Ai=r(767),Ei=0,ji=Ni,Pi=Ti,Ii=Ai,Li=Ci,Ri=0,Oi=1,Di=2,Mi=3,Ui=4,Fi=5,Bi=6,qi=7,$i=8,zi=9,Hi=10,Vi=[2,3,7],Gi=[3,3,11],Ji=[280,256,256,256,40],Wi=[0,1,1,1,0],Ki=[17,18,0,1,2,3,4,5,16,6,7,8,9,10,11,12,13,14,15],Yi=[24,7,23,25,40,6,39,41,22,26,38,42,56,5,55,57,21,27,54,58,37,43,72,4,71,73,20,28,53,59,70,74,36,44,88,69,75,52,60,3,87,89,19,29,86,90,35,45,68,76,85,91,51,61,104,2,103,105,18,30,102,106,34,46,84,92,67,77,101,107,50,62,120,1,119,121,83,93,17,31,100,108,66,78,118,122,33,47,117,123,49,63,99,109,82,94,0,116,124,65,79,16,32,98,110,48,115,125,81,95,64,114,126,97,111,80,113,127,96,112],Xi=[2954,2956,2958,2962,2970,2986,3018,3082,3212,3468,3980,5004],Qi=8,Zi=[4,5,6,7,8,9,10,10,11,12,13,14,15,16,17,17,18,19,20,20,21,21,22,22,23,23,24,25,25,26,27,28,29,30,31,32,33,34,35,36,37,37,38,39,40,41,42,43,44,45,46,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,76,77,78,79,80,81,82,83,84,85,86,87,88,89,91,93,95,96,98,100,101,102,104,106,108,110,112,114,116,118,122,124,126,128,130,132,134,136,138,140,143,145,148,151,154,157],en=[4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,60,62,64,66,68,70,72,74,76,78,80,82,84,86,88,90,92,94,96,98,100,102,104,106,108,110,112,114,116,119,122,125,128,131,134,137,140,143,146,149,152,155,158,161,164,167,170,173,177,181,185,189,193,197,201,205,209,213,217,221,225,229,234,239,245,249,254,259,264,269,274,279,284],tn=null,sn=[[173,148,140,0],[176,155,140,135,0],[180,157,141,134,130,0],[254,254,243,230,196,177,153,140,133,130,129,0]],nn=[0,1,4,8,5,2,3,6,9,12,13,10,7,11,14,15],rn=[-0,1,-1,2,-2,3,4,6,-3,5,-4,-5,-6,7,-7,8,-8,-9],an=[[[[128,128,128,128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128,128,128,128]],[[253,136,254,255,228,219,128,128,128,128,128],[189,129,242,255,227,213,255,219,128,128,128],[106,126,227,252,214,209,255,255,128,128,128]],[[1,98,248,255,236,226,255,255,128,128,128],[181,133,238,254,221,234,255,154,128,128,128],[78,134,202,247,198,180,255,219,128,128,128]],[[1,185,249,255,243,255,128,128,128,128,128],[184,150,247,255,236,224,128,128,128,128,128],[77,110,216,255,236,230,128,128,128,128,128]],[[1,101,251,255,241,255,128,128,128,128,128],[170,139,241,252,236,209,255,255,128,128,128],[37,116,196,243,228,255,255,255,128,128,128]],[[1,204,254,255,245,255,128,128,128,128,128],[207,160,250,255,238,128,128,128,128,128,128],[102,103,231,255,211,171,128,128,128,128,128]],[[1,152,252,255,240,255,128,128,128,128,128],[177,135,243,255,234,225,128,128,128,128,128],[80,129,211,255,194,224,128,128,128,128,128]],[[1,1,255,128,128,128,128,128,128,128,128],[246,1,255,128,128,128,128,128,128,128,128],[255,128,128,128,128,128,128,128,128,128,128]]],[[[198,35,237,223,193,187,162,160,145,155,62],[131,45,198,221,172,176,220,157,252,221,1],[68,47,146,208,149,167,221,162,255,223,128]],[[1,149,241,255,221,224,255,255,128,128,128],[184,141,234,253,222,220,255,199,128,128,128],[81,99,181,242,176,190,249,202,255,255,128]],[[1,129,232,253,214,197,242,196,255,255,128],[99,121,210,250,201,198,255,202,128,128,128],[23,91,163,242,170,187,247,210,255,255,128]],[[1,200,246,255,234,255,128,128,128,128,128],[109,178,241,255,231,245,255,255,128,128,128],[44,130,201,253,205,192,255,255,128,128,128]],[[1,132,239,251,219,209,255,165,128,128,128],[94,136,225,251,218,190,255,255,128,128,128],[22,100,174,245,186,161,255,199,128,128,128]],[[1,182,249,255,232,235,128,128,128,128,128],[124,143,241,255,227,234,128,128,128,128,128],[35,77,181,251,193,211,255,205,128,128,128]],[[1,157,247,255,236,231,255,255,128,128,128],[121,141,235,255,225,227,255,255,128,128,128],[45,99,188,251,195,217,255,224,128,128,128]],[[1,1,251,255,213,255,128,128,128,128,128],[203,1,248,255,255,128,128,128,128,128,128],[137,1,177,255,224,255,128,128,128,128,128]]],[[[253,9,248,251,207,208,255,192,128,128,128],[175,13,224,243,193,185,249,198,255,255,128],[73,17,171,221,161,179,236,167,255,234,128]],[[1,95,247,253,212,183,255,255,128,128,128],[239,90,244,250,211,209,255,255,128,128,128],[155,77,195,248,188,195,255,255,128,128,128]],[[1,24,239,251,218,219,255,205,128,128,128],[201,51,219,255,196,186,128,128,128,128,128],[69,46,190,239,201,218,255,228,128,128,128]],[[1,191,251,255,255,128,128,128,128,128,128],[223,165,249,255,213,255,128,128,128,128,128],[141,124,248,255,255,128,128,128,128,128,128]],[[1,16,248,255,255,128,128,128,128,128,128],[190,36,230,255,236,255,128,128,128,128,128],[149,1,255,128,128,128,128,128,128,128,128]],[[1,226,255,128,128,128,128,128,128,128,128],[247,192,255,128,128,128,128,128,128,128,128],[240,128,255,128,128,128,128,128,128,128,128]],[[1,134,252,255,255,128,128,128,128,128,128],[213,62,250,255,255,128,128,128,128,128,128],[55,93,255,128,128,128,128,128,128,128,128]],[[128,128,128,128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128,128,128,128],[128,128,128,128,128,128,128,128,128,128,128]]],[[[202,24,213,235,186,191,220,160,240,175,255],[126,38,182,232,169,184,228,174,255,187,128],[61,46,138,219,151,178,240,170,255,216,128]],[[1,112,230,250,199,191,247,159,255,255,128],[166,109,228,252,211,215,255,174,128,128,128],[39,77,162,232,172,180,245,178,255,255,128]],[[1,52,220,246,198,199,249,220,255,255,128],[124,74,191,243,183,193,250,221,255,255,128],[24,71,130,219,154,170,243,182,255,255,128]],[[1,182,225,249,219,240,255,224,128,128,128],[149,150,226,252,216,205,255,171,128,128,128],[28,108,170,242,183,194,254,223,255,255,128]],[[1,81,230,252,204,203,255,192,128,128,128],[123,102,209,247,188,196,255,233,128,128,128],[20,95,153,243,164,173,255,203,128,128,128]],[[1,222,248,255,216,213,128,128,128,128,128],[168,175,246,252,235,205,255,255,128,128,128],[47,116,215,255,211,212,255,255,128,128,128]],[[1,121,236,253,212,214,255,255,128,128,128],[141,84,213,252,201,202,255,219,128,128,128],[42,80,160,240,162,185,255,205,128,128,128]],[[1,1,255,128,128,128,128,128,128,128,128],[244,1,255,128,128,128,128,128,128,128,128],[238,1,255,128,128,128,128,128,128,128,128]]]],on=[[[231,120,48,89,115,113,120,152,112],[152,179,64,126,170,118,46,70,95],[175,69,143,80,85,82,72,155,103],[56,58,10,171,218,189,17,13,152],[114,26,17,163,44,195,21,10,173],[121,24,80,195,26,62,44,64,85],[144,71,10,38,171,213,144,34,26],[170,46,55,19,136,160,33,206,71],[63,20,8,114,114,208,12,9,226],[81,40,11,96,182,84,29,16,36]],[[134,183,89,137,98,101,106,165,148],[72,187,100,130,157,111,32,75,80],[66,102,167,99,74,62,40,234,128],[41,53,9,178,241,141,26,8,107],[74,43,26,146,73,166,49,23,157],[65,38,105,160,51,52,31,115,128],[104,79,12,27,217,255,87,17,7],[87,68,71,44,114,51,15,186,23],[47,41,14,110,182,183,21,17,194],[66,45,25,102,197,189,23,18,22]],[[88,88,147,150,42,46,45,196,205],[43,97,183,117,85,38,35,179,61],[39,53,200,87,26,21,43,232,171],[56,34,51,104,114,102,29,93,77],[39,28,85,171,58,165,90,98,64],[34,22,116,206,23,34,43,166,73],[107,54,32,26,51,1,81,43,31],[68,25,106,22,64,171,36,225,114],[34,19,21,102,132,188,16,76,124],[62,18,78,95,85,57,50,48,51]],[[193,101,35,159,215,111,89,46,111],[60,148,31,172,219,228,21,18,111],[112,113,77,85,179,255,38,120,114],[40,42,1,196,245,209,10,25,109],[88,43,29,140,166,213,37,43,154],[61,63,30,155,67,45,68,1,209],[100,80,8,43,154,1,51,26,71],[142,78,78,16,255,128,34,197,171],[41,40,5,102,211,183,4,1,221],[51,50,17,168,209,192,23,25,82]],[[138,31,36,171,27,166,38,44,229],[67,87,58,169,82,115,26,59,179],[63,59,90,180,59,166,93,73,154],[40,40,21,116,143,209,34,39,175],[47,15,16,183,34,223,49,45,183],[46,17,33,183,6,98,15,32,183],[57,46,22,24,128,1,54,17,37],[65,32,73,115,28,128,23,128,205],[40,3,9,115,51,192,18,6,223],[87,37,9,115,59,77,64,21,47]],[[104,55,44,218,9,54,53,130,226],[64,90,70,205,40,41,23,26,57],[54,57,112,184,5,41,38,166,213],[30,34,26,133,152,116,10,32,134],[39,19,53,221,26,114,32,73,255],[31,9,65,234,2,15,1,118,73],[75,32,12,51,192,255,160,43,51],[88,31,35,67,102,85,55,186,85],[56,21,23,111,59,205,45,37,192],[55,38,70,124,73,102,1,34,98]],[[125,98,42,88,104,85,117,175,82],[95,84,53,89,128,100,113,101,45],[75,79,123,47,51,128,81,171,1],[57,17,5,71,102,57,53,41,49],[38,33,13,121,57,73,26,1,85],[41,10,67,138,77,110,90,47,114],[115,21,2,10,102,255,166,23,6],[101,29,16,10,85,128,101,196,26],[57,18,10,102,102,213,34,20,43],[117,20,15,36,163,128,68,1,26]],[[102,61,71,37,34,53,31,243,192],[69,60,71,38,73,119,28,222,37],[68,45,128,34,1,47,11,245,171],[62,17,19,70,146,85,55,62,70],[37,43,37,154,100,163,85,160,1],[63,9,92,136,28,64,32,201,85],[75,15,9,9,64,255,184,119,16],[86,6,28,5,64,255,25,248,1],[56,8,17,132,137,255,55,116,128],[58,15,20,82,135,57,26,121,40]],[[164,50,31,137,154,133,25,35,218],[51,103,44,131,131,123,31,6,158],[86,40,64,135,148,224,45,183,128],[22,26,17,131,240,154,14,1,209],[45,16,21,91,64,222,7,1,197],[56,21,39,155,60,138,23,102,213],[83,12,13,54,192,255,68,47,28],[85,26,85,85,128,128,32,146,171],[18,11,7,63,144,171,4,4,246],[35,27,10,146,174,171,12,26,128]],[[190,80,35,99,180,80,126,54,45],[85,126,47,87,176,51,41,20,32],[101,75,128,139,118,146,116,128,85],[56,41,15,176,236,85,37,9,62],[71,30,17,119,118,255,17,18,138],[101,38,60,138,55,70,43,26,142],[146,36,19,30,171,255,97,27,20],[138,45,61,62,219,1,81,188,64],[32,41,20,117,151,142,20,21,163],[112,19,12,61,195,128,48,4,24]]],ln=[[[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[176,246,255,255,255,255,255,255,255,255,255],[223,241,252,255,255,255,255,255,255,255,255],[249,253,253,255,255,255,255,255,255,255,255]],[[255,244,252,255,255,255,255,255,255,255,255],[234,254,254,255,255,255,255,255,255,255,255],[253,255,255,255,255,255,255,255,255,255,255]],[[255,246,254,255,255,255,255,255,255,255,255],[239,253,254,255,255,255,255,255,255,255,255],[254,255,254,255,255,255,255,255,255,255,255]],[[255,248,254,255,255,255,255,255,255,255,255],[251,255,254,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,253,254,255,255,255,255,255,255,255,255],[251,254,254,255,255,255,255,255,255,255,255],[254,255,254,255,255,255,255,255,255,255,255]],[[255,254,253,255,254,255,255,255,255,255,255],[250,255,254,255,254,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]]],[[[217,255,255,255,255,255,255,255,255,255,255],[225,252,241,253,255,255,254,255,255,255,255],[234,250,241,250,253,255,253,254,255,255,255]],[[255,254,255,255,255,255,255,255,255,255,255],[223,254,254,255,255,255,255,255,255,255,255],[238,253,254,254,255,255,255,255,255,255,255]],[[255,248,254,255,255,255,255,255,255,255,255],[249,254,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,253,255,255,255,255,255,255,255,255,255],[247,254,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,253,254,255,255,255,255,255,255,255,255],[252,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,254,254,255,255,255,255,255,255,255,255],[253,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,254,253,255,255,255,255,255,255,255,255],[250,255,255,255,255,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]]],[[[186,251,250,255,255,255,255,255,255,255,255],[234,251,244,254,255,255,255,255,255,255,255],[251,251,243,253,254,255,254,255,255,255,255]],[[255,253,254,255,255,255,255,255,255,255,255],[236,253,254,255,255,255,255,255,255,255,255],[251,253,253,254,254,255,255,255,255,255,255]],[[255,254,254,255,255,255,255,255,255,255,255],[254,254,254,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,254,255,255,255,255,255,255,255,255,255],[254,254,255,255,255,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]]],[[[248,255,255,255,255,255,255,255,255,255,255],[250,254,252,254,255,255,255,255,255,255,255],[248,254,249,253,255,255,255,255,255,255,255]],[[255,253,253,255,255,255,255,255,255,255,255],[246,253,253,255,255,255,255,255,255,255,255],[252,254,251,254,254,255,255,255,255,255,255]],[[255,254,252,255,255,255,255,255,255,255,255],[248,254,253,255,255,255,255,255,255,255,255],[253,255,254,254,255,255,255,255,255,255,255]],[[255,251,254,255,255,255,255,255,255,255,255],[245,251,254,255,255,255,255,255,255,255,255],[253,253,254,255,255,255,255,255,255,255,255]],[[255,251,253,255,255,255,255,255,255,255,255],[252,253,254,255,255,255,255,255,255,255,255],[255,254,255,255,255,255,255,255,255,255,255]],[[255,252,255,255,255,255,255,255,255,255,255],[249,255,254,255,255,255,255,255,255,255,255],[255,255,254,255,255,255,255,255,255,255,255]],[[255,255,253,255,255,255,255,255,255,255,255],[250,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]],[[255,255,255,255,255,255,255,255,255,255,255],[254,255,255,255,255,255,255,255,255,255,255],[255,255,255,255,255,255,255,255,255,255,255]]]],cn=[0,1,2,3,6,4,5,6,6,6,6,6,6,6,6,7,0],dn=[],un=[],hn=[],fn=1,mn=2,pn=[],gn=[];gs("UpsampleRgbLinePair",Ss,3),gs("UpsampleBgrLinePair",ks,3),gs("UpsampleRgbaLinePair",As,4),gs("UpsampleBgraLinePair",Ts,4),gs("UpsampleArgbLinePair",Ns,4),gs("UpsampleRgba4444LinePair",Cs,2),gs("UpsampleRgb565LinePair",_s,2);var vn=e.UpsampleRgbLinePair,yn=e.UpsampleBgrLinePair,bn=e.UpsampleRgbaLinePair,xn=e.UpsampleBgraLinePair,wn=e.UpsampleArgbLinePair,Sn=e.UpsampleRgba4444LinePair,kn=e.UpsampleRgb565LinePair,_n=16,Cn=1<<_n-1,Nn=-227,Tn=482,An=6,En=0,jn=r(256),Pn=r(256),In=r(256),Ln=r(256),Rn=r(Tn-Nn),On=r(Tn-Nn);Es("YuvToRgbRow",Ss,3),Es("YuvToBgrRow",ks,3),Es("YuvToRgbaRow",As,4),Es("YuvToBgraRow",Ts,4),Es("YuvToArgbRow",Ns,4),Es("YuvToRgba4444Row",Cs,2),Es("YuvToRgb565Row",_s,2);var Dn=[0,4,8,12,128,132,136,140,256,260,264,268,384,388,392,396],Mn=[0,2,8],Un=[8,7,6,4,4,2,2,2,1,1,1,1],Fn=1;this.WebPDecodeRGBA=function(e,s,o,l,c){var d=Oi,u=new ts,h=new ae;u.ba=h,h.S=d,h.width=[h.width],h.height=[h.height];var f=h.width,m=h.height,p=new oe;if(null==p||null==e)var g=2;else t(null!=p),g=Ls(e,s,o,p.width,p.height,p.Pd,p.Qd,p.format,null);if(0!=g?f=0:(null!=f&&(f[0]=p.width[0]),null!=m&&(m[0]=p.height[0]),f=1),f){h.width=h.width[0],h.height=h.height[0],null!=l&&(l[0]=h.width),null!=c&&(c[0]=h.height);e:{if(l=new Ge,(c=new ss).data=e,c.w=s,c.ha=o,c.kd=1,s=[0],t(null!=c),(0==(e=Ls(c.data,c.w,c.ha,null,null,null,s,null,c))||7==e)&&s[0]&&(e=4),0==(s=e)){if(t(null!=u),l.data=c.data,l.w=c.w+c.offset,l.ha=c.ha-c.offset,l.put=fe,l.ac=he,l.bc=me,l.ma=u,c.xa){if(null==(e=Ae())){u=1;break e}if(function(e,s){var i=[0],n=[0],r=[0];t:for(;;){if(null==e)return 0;if(null==s)return e.a=2,0;if(e.l=s,e.a=0,v(e.m,s.data,s.w,s.ha),!pe(e.m,i,n,r)){e.a=3;break t}if(e.xb=mn,s.width=i[0],s.height=n[0],!Ee(i[0],n[0],1,e,null))break t;return 1}return t(0!=e.a),0}(e,l)){if(l=0==(s=Ds(l.width,l.height,u.Oa,u.ba))){t:{l=e;s:for(;;){if(null==l){l=0;break t}if(t(null!=l.s.yc),t(null!=l.s.Ya),t(0<l.s.Wb),t(null!=(o=l.l)),t(null!=(c=o.ma)),0!=l.xb){if(l.ca=c.ba,l.tb=c.tb,t(null!=l.ca),!Rs(c.Oa,o,Mi)){l.a=2;break s}if(!je(l,o.width))break s;if(o.da)break s;if((o.da||ie(l.ca.S))&&ps(),11>l.ca.S||(alert("todo:WebPInitConvertARGBToYUV"),null!=l.ca.f.kb.F&&ps()),l.Pb&&0<l.s.ua&&null==l.s.vb.X&&!L(l.s.vb,l.s.Wa.Xa)){l.a=1;break s}l.xb=0}if(!Ne(l,l.V,l.Ba,l.c,l.i,o.o,Se))break s;c.Dc=l.Ma,l=1;break t}t(0!=l.a),l=0}l=!l}l&&(s=e.a)}else s=e.a}else{if(null==(e=new Je)){u=1;break e}if(e.Fa=c.na,e.P=c.P,e.qc=c.Sa,Ye(e,l)){if(0==(s=Ds(l.width,l.height,u.Oa,u.ba))){if(e.Aa=0,o=u.Oa,t(null!=(c=e)),null!=o){if(0<(f=0>(f=o.Md)?0:100<f?255:255*f/100)){for(m=p=0;4>m;++m)12>(g=c.pb[m]).lc&&(g.ia=f*Un[0>g.lc?0:g.lc]>>3),p|=g.ia;p&&(alert("todo:VP8InitRandom"),c.ia=1)}c.Ga=o.Id,100<c.Ga?c.Ga=100:0>c.Ga&&(c.Ga=0)}(function(e,s){if(null==e)return 0;if(null==s)return We(e,2,"NULL VP8Io parameter in VP8Decode().");if(!e.cb&&!Ye(e,s))return 0;if(t(e.cb),null==s.ac||s.ac(s)){s.ob&&(e.L=0);var o=Mn[e.L];if(2==e.L?(e.yb=0,e.zb=0):(e.yb=s.v-o>>4,e.zb=s.j-o>>4,0>e.yb&&(e.yb=0),0>e.zb&&(e.zb=0)),e.Va=s.o+15+o>>4,e.Hb=s.va+15+o>>4,e.Hb>e.za&&(e.Hb=e.za),e.Va>e.Ub&&(e.Va=e.Ub),0<e.L){var l=e.ed;for(o=0;4>o;++o){var c;if(e.Qa.Cb){var d=e.Qa.Lb[o];e.Qa.Fb||(d+=l.Tb)}else d=l.Tb;for(c=0;1>=c;++c){var u=e.gd[o][c],h=d;if(l.Pc&&(h+=l.vd[0],c&&(h+=l.od[0])),0<(h=0>h?0:63<h?63:h)){var f=h;0<l.wb&&(f=4<l.wb?f>>2:f>>1)>9-l.wb&&(f=9-l.wb),1>f&&(f=1),u.dd=f,u.tc=2*h+f,u.ld=40<=h?2:15<=h?1:0}else u.tc=0;u.La=c}}}o=0}else We(e,6,"Frame setup failed"),o=e.a;if(o=0==o){if(o){e.$c=0,0<e.Aa||(e.Ic=Fn);t:{o=e.Ic,l=4*(f=e.za);var m=32*f,p=f+1,g=0<e.L?f*(0<e.Aa?2:1):0,v=(2==e.Aa?2:1)*f;if((u=l+832+(c=3*(16*o+Mn[e.L])/2*m)+(d=null!=e.Fa&&0<e.Fa.length?e.Kc.c*e.Kc.i:0))!=u)o=0;else{if(u>e.Vb){if(e.Vb=0,e.Ec=r(u),e.Fc=0,null==e.Ec){o=We(e,1,"no memory during frame initialization.");break t}e.Vb=u}u=e.Ec,h=e.Fc,e.Ac=u,e.Bc=h,h+=l,e.Gd=a(m,ze),e.Hd=0,e.rb=a(p+1,Fe),e.sb=1,e.wa=g?a(g,Ue):null,e.Y=0,e.D.Nb=0,e.D.wa=e.wa,e.D.Y=e.Y,0<e.Aa&&(e.D.Y+=f),t(!0),e.oc=u,e.pc=h,h+=832,e.ya=a(v,qe),e.aa=0,e.D.ya=e.ya,e.D.aa=e.aa,2==e.Aa&&(e.D.aa+=f),e.R=16*f,e.B=8*f,f=(m=Mn[e.L])*e.R,m=m/2*e.B,e.sa=u,e.ta=h+f,e.qa=e.sa,e.ra=e.ta+16*o*e.R+m,e.Ha=e.qa,e.Ia=e.ra+8*o*e.B+m,e.$c=0,h+=c,e.mb=d?u:null,e.nb=d?h:null,t(h+d<=e.Fc+e.Vb),Qe(e),n(e.Ac,e.Bc,0,l),o=1}}if(o){if(s.ka=0,s.y=e.sa,s.O=e.ta,s.f=e.qa,s.N=e.ra,s.ea=e.Ha,s.Vd=e.Ia,s.fa=e.R,s.Rc=e.B,s.F=null,s.J=0,!Ei){for(o=-255;255>=o;++o)Ci[255+o]=0>o?-o:o;for(o=-1020;1020>=o;++o)Ni[1020+o]=-128>o?-128:127<o?127:o;for(o=-112;112>=o;++o)Ti[112+o]=-16>o?-16:15<o?15:o;for(o=-255;510>=o;++o)Ai[255+o]=0>o?0:255<o?255:o;Ei=1}ii=lt,ni=nt,ai=rt,oi=at,li=ot,ri=it,ci=Jt,di=Wt,ui=Xt,hi=Qt,fi=Kt,mi=Yt,pi=Zt,gi=es,vi=qt,yi=$t,bi=zt,xi=Ht,un[0]=kt,un[1]=dt,un[2]=wt,un[3]=St,un[4]=_t,un[5]=Nt,un[6]=Ct,un[7]=Tt,un[8]=Et,un[9]=At,dn[0]=gt,dn[1]=ht,dn[2]=ft,dn[3]=mt,dn[4]=vt,dn[5]=yt,dn[6]=bt,hn[0]=Lt,hn[1]=ut,hn[2]=jt,hn[3]=Pt,hn[4]=Ot,hn[5]=Rt,hn[6]=Dt,o=1}else o=0}o&&(o=function(e,s){for(e.M=0;e.M<e.Va;++e.M){var a,o=e.Jc[e.M&e.Xb],l=e.m,c=e;for(a=0;a<c.za;++a){var d=l,u=c,h=u.Ac,f=u.Bc+4*a,m=u.zc,p=u.ya[u.aa+a];if(u.Qa.Bb?p.$b=A(d,u.Pa.jb[0])?2+A(d,u.Pa.jb[2]):A(d,u.Pa.jb[1]):p.$b=0,u.kc&&(p.Ad=A(d,u.Bd)),p.Za=!A(d,145)+0,p.Za){var g=p.Ob,v=0;for(u=0;4>u;++u){var y,b=m[0+u];for(y=0;4>y;++y){b=on[h[f+y]][b];for(var x=rn[A(d,b[0])];0<x;)x=rn[2*x+A(d,b[x])];b=-x,h[f+y]=b}i(g,v,h,f,4),v+=4,m[0+u]=b}}else b=A(d,156)?A(d,128)?1:3:A(d,163)?2:0,p.Ob[0]=b,n(h,f,b,4),n(m,0,b,4);p.Dd=A(d,142)?A(d,114)?A(d,183)?1:3:2:0}if(c.m.Ka)return We(e,7,"Premature end-of-partition0 encountered.");for(;e.ja<e.za;++e.ja){if(c=o,d=(l=e).rb[l.sb-1],h=l.rb[l.sb+l.ja],a=l.ya[l.aa+l.ja],f=l.kc?a.Ad:0)d.la=h.la=0,a.Za||(d.Na=h.Na=0),a.Hc=0,a.Gc=0,a.ia=0;else{var w,S;if(d=h,h=c,f=l.Pa.Xc,m=l.ya[l.aa+l.ja],p=l.pb[m.$b],u=m.ad,g=0,v=l.rb[l.sb-1],b=y=0,n(u,g,0,384),m.Za)var k=0,_=f[3];else{x=r(16);var C=d.Na+v.Na;if(C=tn(h,f[1],C,p.Eb,0,x,0),d.Na=v.Na=(0<C)+0,1<C)ii(x,0,u,g);else{var N=x[0]+3>>3;for(x=0;256>x;x+=16)u[g+x]=N}k=1,_=f[0]}var T=15&d.la,E=15&v.la;for(x=0;4>x;++x){var j=1&E;for(N=S=0;4>N;++N)T=T>>1|(j=(C=tn(h,_,C=j+(1&T),p.Sc,k,u,g))>k)<<7,S=S<<2|(3<C?3:1<C?2:0!=u[g+0]),g+=16;T>>=4,E=E>>1|j<<7,y=(y<<8|S)>>>0}for(_=T,k=E>>4,w=0;4>w;w+=2){for(S=0,T=d.la>>4+w,E=v.la>>4+w,x=0;2>x;++x){for(j=1&E,N=0;2>N;++N)C=j+(1&T),T=T>>1|(j=0<(C=tn(h,f[2],C,p.Qc,0,u,g)))<<3,S=S<<2|(3<C?3:1<C?2:0!=u[g+0]),g+=16;T>>=2,E=E>>1|j<<5}b|=S<<4*w,_|=T<<4<<w,k|=(240&E)<<w}d.la=_,v.la=k,m.Hc=y,m.Gc=b,m.ia=43690&b?0:p.ia,f=!(y|b)}if(0<l.L&&(l.wa[l.Y+l.ja]=l.gd[a.$b][a.Za],l.wa[l.Y+l.ja].La|=!f),c.Ka)return We(e,7,"Premature end-of-file encountered.")}if(Qe(e),l=s,c=1,a=(o=e).D,d=0<o.L&&o.M>=o.zb&&o.M<=o.Va,0==o.Aa)t:{if(a.M=o.M,a.uc=d,Is(o,a),c=1,a=(S=o.D).Nb,d=(b=Mn[o.L])*o.R,h=b/2*o.B,x=16*a*o.R,N=8*a*o.B,f=o.sa,m=o.ta-d+x,p=o.qa,u=o.ra-h+N,g=o.Ha,v=o.Ia-h+N,E=0==(T=S.M),y=T>=o.Va-1,2==o.Aa&&Is(o,S),S.uc)for(j=(C=o).D.M,t(C.D.uc),S=C.yb;S<C.Hb;++S){k=S,_=j;var P=(I=(q=C).D).Nb;w=q.R;var I=I.wa[I.Y+k],L=q.sa,R=q.ta+16*P*w+16*k,O=I.dd,D=I.tc;if(0!=D)if(t(3<=D),1==q.L)0<k&&yi(L,R,w,D+4),I.La&&xi(L,R,w,D),0<_&&vi(L,R,w,D+4),I.La&&bi(L,R,w,D);else{var M=q.B,U=q.qa,F=q.ra+8*P*M+8*k,B=q.Ha,q=q.Ia+8*P*M+8*k;P=I.ld,0<k&&(di(L,R,w,D+4,O,P),hi(U,F,B,q,M,D+4,O,P)),I.La&&(mi(L,R,w,D,O,P),gi(U,F,B,q,M,D,O,P)),0<_&&(ci(L,R,w,D+4,O,P),ui(U,F,B,q,M,D+4,O,P)),I.La&&(fi(L,R,w,D,O,P),pi(U,F,B,q,M,D,O,P))}}if(o.ia&&alert("todo:DitherRow"),null!=l.put){if(S=16*T,T=16*(T+1),E?(l.y=o.sa,l.O=o.ta+x,l.f=o.qa,l.N=o.ra+N,l.ea=o.Ha,l.W=o.Ia+N):(S-=b,l.y=f,l.O=m,l.f=p,l.N=u,l.ea=g,l.W=v),y||(T-=b),T>l.o&&(T=l.o),l.F=null,l.J=null,null!=o.Fa&&0<o.Fa.length&&S<T&&(l.J=ds(o,l,S,T-S),l.F=o.mb,null==l.F&&0==l.F.length)){c=We(o,3,"Could not decode alpha data.");break t}S<l.j&&(b=l.j-S,S=l.j,t(!(1&b)),l.O+=o.R*b,l.N+=o.B*(b>>1),l.W+=o.B*(b>>1),null!=l.F&&(l.J+=l.width*b)),S<T&&(l.O+=l.v,l.N+=l.v>>1,l.W+=l.v>>1,null!=l.F&&(l.J+=l.v),l.ka=S-l.j,l.U=l.va-l.v,l.T=T-S,c=l.put(l))}a+1!=o.Ic||y||(i(o.sa,o.ta-d,f,m+16*o.R,d),i(o.qa,o.ra-h,p,u+8*o.B,h),i(o.Ha,o.Ia-h,g,v+8*o.B,h))}if(!c)return We(e,6,"Output aborted.")}return 1}(e,s)),null!=s.bc&&s.bc(s),o&=1}return o?(e.cb=0,o):0})(e,l)||(s=e.a)}}else s=e.a}0==s&&null!=u.Oa&&u.Oa.fd&&(s=Os(u.ba))}u=s}d=0!=u?null:11>d?h.f.RGBA.eb:h.f.kb.y}else d=null;return d};var Bn=[3,4,3,4,4,2,2,4,4,4,2,1,1]};function c(e,t){for(var s="",i=0;i<4;i++)s+=String.fromCharCode(e[t++]);return s}function d(e,t){return(e[t+0]|e[t+1]<<8|e[t+2]<<16)>>>0}function u(e,t){return(e[t+0]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0}new l;var h=[0],f=[0],m=[],p=new l,g=e,v=function(e,t){var s={},i=0,n=!1,r=0,a=0;if(s.frames=[],!
/** @license
       * Copyright (c) 2017 Dominik Homberger
      Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
      The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
      THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
      https://webpjs.appspot.com
      WebPRiffParser dominikhlbg@gmail.com
      */
function(e,t){for(var s=0;s<4;s++)if(e[t+s]!="RIFF".charCodeAt(s))return!0;return!1}(e,t)){var o,l;for(u(e,t+=4),t+=8;t<e.length;){var h=c(e,t),f=u(e,t+=4);t+=4;var m=f+(1&f);switch(h){case"VP8 ":case"VP8L":void 0===s.frames[i]&&(s.frames[i]={}),(v=s.frames[i]).src_off=n?a:t-8,v.src_size=r+f+8,i++,n&&(n=!1,r=0,a=0);break;case"VP8X":(v=s.header={}).feature_flags=e[t];var p=t+4;v.canvas_width=1+d(e,p),p+=3,v.canvas_height=1+d(e,p),p+=3;break;case"ALPH":n=!0,r=m+8,a=t-8;break;case"ANIM":(v=s.header).bgcolor=u(e,t),p=t+4,v.loop_count=(o=e)[(l=p)+0]|o[l+1]<<8,p+=2;break;case"ANMF":var g,v;(v=s.frames[i]={}).offset_x=2*d(e,t),t+=3,v.offset_y=2*d(e,t),t+=3,v.width=1+d(e,t),t+=3,v.height=1+d(e,t),t+=3,v.duration=d(e,t),t+=3,g=e[t++],v.dispose=1&g,v.blend=g>>1&1}"ANMF"!=h&&(t+=m)}return s}}(g,0);v.response=g,v.rgbaoutput=!0,v.dataurl=!1;var y=v.header?v.header:null,b=v.frames?v.frames:null;if(y){y.loop_counter=y.loop_count,h=[y.canvas_height],f=[y.canvas_width];for(var x=0;x<b.length&&0!=b[x].blend;x++);}var w=b[0],S=p.WebPDecodeRGBA(g,w.src_off,w.src_size,f,h);w.rgba=S,w.imgwidth=f[0],w.imgheight=h[0];for(var k=0;k<f[0]*h[0]*4;k++)m[k]=S[k];return this.width=f,this.height=h,this.data=m,this}!function(e){var t=function(t,i,l,c){var d=4,u=r;switch(c){case e.image_compression.FAST:d=1,u=n;break;case e.image_compression.MEDIUM:d=6,u=a;break;case e.image_compression.SLOW:d=9,u=o}var h=ib(t=s(t,i,l,u),{level:d});return e.__addimage__.arrayBufferToBinaryString(h)},s=function(e,t,s,i){for(var n,r,a,o=e.length/t,l=new Uint8Array(e.length+o),u=c(),h=0;h<o;h+=1){if(a=h*t,n=e.subarray(a,a+t),i)l.set(i(n,s,r),a+h);else{for(var f,m=u.length,p=[];f<m;f+=1)p[f]=u[f](n,s,r);var g=d(p.concat());l.set(p[g],a+h)}r=n}return l},i=function(e){var t=Array.apply([],e);return t.unshift(0),t},n=function(e,t){var s,i=[],n=e.length;i[0]=1;for(var r=0;r<n;r+=1)s=e[r-t]||0,i[r+1]=e[r]-s+256&255;return i},r=function(e,t,s){var i,n=[],r=e.length;n[0]=2;for(var a=0;a<r;a+=1)i=s&&s[a]||0,n[a+1]=e[a]-i+256&255;return n},a=function(e,t,s){var i,n,r=[],a=e.length;r[0]=3;for(var o=0;o<a;o+=1)i=e[o-t]||0,n=s&&s[o]||0,r[o+1]=e[o]+256-(i+n>>>1)&255;return r},o=function(e,t,s){var i,n,r,a,o=[],c=e.length;o[0]=4;for(var d=0;d<c;d+=1)i=e[d-t]||0,n=s&&s[d]||0,r=s&&s[d-t]||0,a=l(i,n,r),o[d+1]=e[d]-a+256&255;return o},l=function(e,t,s){if(e===t&&t===s)return e;var i=Math.abs(t-s),n=Math.abs(e-s),r=Math.abs(e+t-s-s);return i<=n&&i<=r?e:n<=r?t:s},c=function(){return[i,n,r,a,o]},d=function(e){var t=e.map(function(e){return e.reduce(function(e,t){return e+Math.abs(t)},0)});return t.indexOf(Math.min.apply(null,t))};e.processPNG=function(s,i,n,r){var a,o,l,c,d,u,h,f,m,p,g,v,y,b,x,w=this.decode.FLATE_DECODE,S="";if(this.__addimage__.isArrayBuffer(s)&&(s=new Uint8Array(s)),this.__addimage__.isArrayBufferView(s)){if(s=(l=new Qx(s)).imgData,o=l.bits,a=l.colorSpace,d=l.colors,-1!==[4,6].indexOf(l.colorType)){if(8===l.bits){m=(f=32==l.pixelBitlength?new Uint32Array(l.decodePixels().buffer):16==l.pixelBitlength?new Uint16Array(l.decodePixels().buffer):new Uint8Array(l.decodePixels().buffer)).length,g=new Uint8Array(m*l.colors),p=new Uint8Array(m);var k,_=l.pixelBitlength-l.bits;for(b=0,x=0;b<m;b++){for(y=f[b],k=0;k<_;)g[x++]=y>>>k&255,k+=l.bits;p[b]=y>>>k&255}}if(16===l.bits){m=(f=new Uint32Array(l.decodePixels().buffer)).length,g=new Uint8Array(m*(32/l.pixelBitlength)*l.colors),p=new Uint8Array(m*(32/l.pixelBitlength)),v=l.colors>1,b=0,x=0;for(var C=0;b<m;)y=f[b++],g[x++]=y>>>0&255,v&&(g[x++]=y>>>16&255,y=f[b++],g[x++]=y>>>0&255),p[C++]=y>>>16&255;o=8}r!==e.image_compression.NONE?(s=t(g,l.width*l.colors,l.colors,r),h=t(p,l.width,1,r)):(s=g,h=p,w=void 0)}if(3===l.colorType&&(a=this.color_spaces.INDEXED,u=l.palette,l.transparency.indexed)){var N=l.transparency.indexed,T=0;for(b=0,m=N.length;b<m;++b)T+=N[b];if((T/=255)==m-1&&-1!==N.indexOf(0))c=[N.indexOf(0)];else if(T!==m){for(f=l.decodePixels(),p=new Uint8Array(f.length),b=0,m=f.length;b<m;b++)p[b]=N[f[b]];h=t(p,l.width,1)}}var A=function(t){var s;switch(t){case e.image_compression.FAST:s=11;break;case e.image_compression.MEDIUM:s=13;break;case e.image_compression.SLOW:s=14;break;default:s=12}return s}(r);return w===this.decode.FLATE_DECODE&&(S="/Predictor "+A+" "),S+="/Colors "+d+" /BitsPerComponent "+o+" /Columns "+l.width,(this.__addimage__.isArrayBuffer(s)||this.__addimage__.isArrayBufferView(s))&&(s=this.__addimage__.arrayBufferToBinaryString(s)),(h&&this.__addimage__.isArrayBuffer(h)||this.__addimage__.isArrayBufferView(h))&&(h=this.__addimage__.arrayBufferToBinaryString(h)),{alias:n,data:s,index:i,filter:w,decodeParameters:S,transparency:c,palette:u,sMask:h,predictor:A,width:l.width,height:l.height,bitsPerComponent:o,colorSpace:a}}}}(Fb.API),function(e){e.processGIF89A=function(t,s,i,n){var r=new Zx(t),a=r.width,o=r.height,l=[];r.decodeAndBlitFrameRGBA(0,l);var c={data:l,width:a,height:o},d=new tw(100).encode(c,100);return e.processJPEG.call(this,d,s,i,n)},e.processGIF87A=e.processGIF89A}(Fb.API),sw.prototype.parseHeader=function(){if(this.fileSize=this.datav.getUint32(this.pos,!0),this.pos+=4,this.reserved=this.datav.getUint32(this.pos,!0),this.pos+=4,this.offset=this.datav.getUint32(this.pos,!0),this.pos+=4,this.headerSize=this.datav.getUint32(this.pos,!0),this.pos+=4,this.width=this.datav.getUint32(this.pos,!0),this.pos+=4,this.height=this.datav.getInt32(this.pos,!0),this.pos+=4,this.planes=this.datav.getUint16(this.pos,!0),this.pos+=2,this.bitPP=this.datav.getUint16(this.pos,!0),this.pos+=2,this.compress=this.datav.getUint32(this.pos,!0),this.pos+=4,this.rawSize=this.datav.getUint32(this.pos,!0),this.pos+=4,this.hr=this.datav.getUint32(this.pos,!0),this.pos+=4,this.vr=this.datav.getUint32(this.pos,!0),this.pos+=4,this.colors=this.datav.getUint32(this.pos,!0),this.pos+=4,this.importantColors=this.datav.getUint32(this.pos,!0),this.pos+=4,16===this.bitPP&&this.is_with_alpha&&(this.bitPP=15),this.bitPP<15){var e=0===this.colors?1<<this.bitPP:this.colors;this.palette=new Array(e);for(var t=0;t<e;t++){var s=this.datav.getUint8(this.pos++,!0),i=this.datav.getUint8(this.pos++,!0),n=this.datav.getUint8(this.pos++,!0),r=this.datav.getUint8(this.pos++,!0);this.palette[t]={red:n,green:i,blue:s,quad:r}}}this.height<0&&(this.height*=-1,this.bottom_up=!1)},sw.prototype.parseBGR=function(){this.pos=this.offset;try{var e="bit"+this.bitPP,t=this.width*this.height*4;this.data=new Uint8Array(t),this[e]()}catch(s){lb.log("bit decode error:"+s)}},sw.prototype.bit1=function(){var e,t=Math.ceil(this.width/8),s=t%4;for(e=this.height-1;e>=0;e--){for(var i=this.bottom_up?e:this.height-1-e,n=0;n<t;n++)for(var r=this.datav.getUint8(this.pos++,!0),a=i*this.width*4+8*n*4,o=0;o<8&&8*n+o<this.width;o++){var l=this.palette[r>>7-o&1];this.data[a+4*o]=l.blue,this.data[a+4*o+1]=l.green,this.data[a+4*o+2]=l.red,this.data[a+4*o+3]=255}0!==s&&(this.pos+=4-s)}},sw.prototype.bit4=function(){for(var e=Math.ceil(this.width/2),t=e%4,s=this.height-1;s>=0;s--){for(var i=this.bottom_up?s:this.height-1-s,n=0;n<e;n++){var r=this.datav.getUint8(this.pos++,!0),a=i*this.width*4+2*n*4,o=r>>4,l=15&r,c=this.palette[o];if(this.data[a]=c.blue,this.data[a+1]=c.green,this.data[a+2]=c.red,this.data[a+3]=255,2*n+1>=this.width)break;c=this.palette[l],this.data[a+4]=c.blue,this.data[a+4+1]=c.green,this.data[a+4+2]=c.red,this.data[a+4+3]=255}0!==t&&(this.pos+=4-t)}},sw.prototype.bit8=function(){for(var e=this.width%4,t=this.height-1;t>=0;t--){for(var s=this.bottom_up?t:this.height-1-t,i=0;i<this.width;i++){var n=this.datav.getUint8(this.pos++,!0),r=s*this.width*4+4*i;if(n<this.palette.length){var a=this.palette[n];this.data[r]=a.red,this.data[r+1]=a.green,this.data[r+2]=a.blue,this.data[r+3]=255}else this.data[r]=255,this.data[r+1]=255,this.data[r+2]=255,this.data[r+3]=255}0!==e&&(this.pos+=4-e)}},sw.prototype.bit15=function(){for(var e=this.width%3,t=parseInt("11111",2),s=this.height-1;s>=0;s--){for(var i=this.bottom_up?s:this.height-1-s,n=0;n<this.width;n++){var r=this.datav.getUint16(this.pos,!0);this.pos+=2;var a=(r&t)/t*255|0,o=(r>>5&t)/t*255|0,l=(r>>10&t)/t*255|0,c=r>>15?255:0,d=i*this.width*4+4*n;this.data[d]=l,this.data[d+1]=o,this.data[d+2]=a,this.data[d+3]=c}this.pos+=e}},sw.prototype.bit16=function(){for(var e=this.width%3,t=parseInt("11111",2),s=parseInt("111111",2),i=this.height-1;i>=0;i--){for(var n=this.bottom_up?i:this.height-1-i,r=0;r<this.width;r++){var a=this.datav.getUint16(this.pos,!0);this.pos+=2;var o=(a&t)/t*255|0,l=(a>>5&s)/s*255|0,c=(a>>11)/t*255|0,d=n*this.width*4+4*r;this.data[d]=c,this.data[d+1]=l,this.data[d+2]=o,this.data[d+3]=255}this.pos+=e}},sw.prototype.bit24=function(){for(var e=this.height-1;e>=0;e--){for(var t=this.bottom_up?e:this.height-1-e,s=0;s<this.width;s++){var i=this.datav.getUint8(this.pos++,!0),n=this.datav.getUint8(this.pos++,!0),r=this.datav.getUint8(this.pos++,!0),a=t*this.width*4+4*s;this.data[a]=r,this.data[a+1]=n,this.data[a+2]=i,this.data[a+3]=255}this.pos+=this.width%4}},sw.prototype.bit32=function(){for(var e=this.height-1;e>=0;e--)for(var t=this.bottom_up?e:this.height-1-e,s=0;s<this.width;s++){var i=this.datav.getUint8(this.pos++,!0),n=this.datav.getUint8(this.pos++,!0),r=this.datav.getUint8(this.pos++,!0),a=this.datav.getUint8(this.pos++,!0),o=t*this.width*4+4*s;this.data[o]=r,this.data[o+1]=n,this.data[o+2]=i,this.data[o+3]=a}},sw.prototype.getData=function(){return this.data},
/**
 * @license
 * Copyright (c) 2018 Aras Abbasi
 *
 * Licensed under the MIT License.
 * http://opensource.org/licenses/mit-license
 */
function(e){e.processBMP=function(t,s,i,n){var r=new sw(t,!1),a=r.width,o=r.height,l={data:r.getData(),width:a,height:o},c=new tw(100).encode(l,100);return e.processJPEG.call(this,c,s,i,n)}}(Fb.API),iw.prototype.getData=function(){return this.data},
/**
 * @license
 * Copyright (c) 2019 Aras Abbasi
 *
 * Licensed under the MIT License.
 * http://opensource.org/licenses/mit-license
 */
function(e){e.processWEBP=function(t,s,i,n){var r=new iw(t),a=r.width,o=r.height,l={data:r.getData(),width:a,height:o},c=new tw(100).encode(l,100);return e.processJPEG.call(this,c,s,i,n)}}(Fb.API),Fb.API.processRGBA=function(e,t,s){for(var i=e.data,n=i.length,r=new Uint8Array(n/4*3),a=new Uint8Array(n/4),o=0,l=0,c=0;c<n;c+=4){var d=i[c],u=i[c+1],h=i[c+2],f=i[c+3];r[o++]=d,r[o++]=u,r[o++]=h,a[l++]=f}var m=this.__addimage__.arrayBufferToBinaryString(r);return{alpha:this.__addimage__.arrayBufferToBinaryString(a),data:m,index:t,alias:s,colorSpace:"DeviceRGB",bitsPerComponent:8,width:e.width,height:e.height}},Fb.API.setLanguage=function(e){return void 0===this.internal.languageSettings&&(this.internal.languageSettings={},this.internal.languageSettings.isSubscribed=!1),void 0!=={af:"Afrikaans",sq:"Albanian",ar:"Arabic (Standard)","ar-DZ":"Arabic (Algeria)","ar-BH":"Arabic (Bahrain)","ar-EG":"Arabic (Egypt)","ar-IQ":"Arabic (Iraq)","ar-JO":"Arabic (Jordan)","ar-KW":"Arabic (Kuwait)","ar-LB":"Arabic (Lebanon)","ar-LY":"Arabic (Libya)","ar-MA":"Arabic (Morocco)","ar-OM":"Arabic (Oman)","ar-QA":"Arabic (Qatar)","ar-SA":"Arabic (Saudi Arabia)","ar-SY":"Arabic (Syria)","ar-TN":"Arabic (Tunisia)","ar-AE":"Arabic (U.A.E.)","ar-YE":"Arabic (Yemen)",an:"Aragonese",hy:"Armenian",as:"Assamese",ast:"Asturian",az:"Azerbaijani",eu:"Basque",be:"Belarusian",bn:"Bengali",bs:"Bosnian",br:"Breton",bg:"Bulgarian",my:"Burmese",ca:"Catalan",ch:"Chamorro",ce:"Chechen",zh:"Chinese","zh-HK":"Chinese (Hong Kong)","zh-CN":"Chinese (PRC)","zh-SG":"Chinese (Singapore)","zh-TW":"Chinese (Taiwan)",cv:"Chuvash",co:"Corsican",cr:"Cree",hr:"Croatian",cs:"Czech",da:"Danish",nl:"Dutch (Standard)","nl-BE":"Dutch (Belgian)",en:"English","en-AU":"English (Australia)","en-BZ":"English (Belize)","en-CA":"English (Canada)","en-IE":"English (Ireland)","en-JM":"English (Jamaica)","en-NZ":"English (New Zealand)","en-PH":"English (Philippines)","en-ZA":"English (South Africa)","en-TT":"English (Trinidad & Tobago)","en-GB":"English (United Kingdom)","en-US":"English (United States)","en-ZW":"English (Zimbabwe)",eo:"Esperanto",et:"Estonian",fo:"Faeroese",fj:"Fijian",fi:"Finnish",fr:"French (Standard)","fr-BE":"French (Belgium)","fr-CA":"French (Canada)","fr-FR":"French (France)","fr-LU":"French (Luxembourg)","fr-MC":"French (Monaco)","fr-CH":"French (Switzerland)",fy:"Frisian",fur:"Friulian",gd:"Gaelic (Scots)","gd-IE":"Gaelic (Irish)",gl:"Galacian",ka:"Georgian",de:"German (Standard)","de-AT":"German (Austria)","de-DE":"German (Germany)","de-LI":"German (Liechtenstein)","de-LU":"German (Luxembourg)","de-CH":"German (Switzerland)",el:"Greek",gu:"Gujurati",ht:"Haitian",he:"Hebrew",hi:"Hindi",hu:"Hungarian",is:"Icelandic",id:"Indonesian",iu:"Inuktitut",ga:"Irish",it:"Italian (Standard)","it-CH":"Italian (Switzerland)",ja:"Japanese",kn:"Kannada",ks:"Kashmiri",kk:"Kazakh",km:"Khmer",ky:"Kirghiz",tlh:"Klingon",ko:"Korean","ko-KP":"Korean (North Korea)","ko-KR":"Korean (South Korea)",la:"Latin",lv:"Latvian",lt:"Lithuanian",lb:"Luxembourgish",mk:"North Macedonia",ms:"Malay",ml:"Malayalam",mt:"Maltese",mi:"Maori",mr:"Marathi",mo:"Moldavian",nv:"Navajo",ng:"Ndonga",ne:"Nepali",no:"Norwegian",nb:"Norwegian (Bokmal)",nn:"Norwegian (Nynorsk)",oc:"Occitan",or:"Oriya",om:"Oromo",fa:"Persian","fa-IR":"Persian/Iran",pl:"Polish",pt:"Portuguese","pt-BR":"Portuguese (Brazil)",pa:"Punjabi","pa-IN":"Punjabi (India)","pa-PK":"Punjabi (Pakistan)",qu:"Quechua",rm:"Rhaeto-Romanic",ro:"Romanian","ro-MO":"Romanian (Moldavia)",ru:"Russian","ru-MO":"Russian (Moldavia)",sz:"Sami (Lappish)",sg:"Sango",sa:"Sanskrit",sc:"Sardinian",sd:"Sindhi",si:"Singhalese",sr:"Serbian",sk:"Slovak",sl:"Slovenian",so:"Somani",sb:"Sorbian",es:"Spanish","es-AR":"Spanish (Argentina)","es-BO":"Spanish (Bolivia)","es-CL":"Spanish (Chile)","es-CO":"Spanish (Colombia)","es-CR":"Spanish (Costa Rica)","es-DO":"Spanish (Dominican Republic)","es-EC":"Spanish (Ecuador)","es-SV":"Spanish (El Salvador)","es-GT":"Spanish (Guatemala)","es-HN":"Spanish (Honduras)","es-MX":"Spanish (Mexico)","es-NI":"Spanish (Nicaragua)","es-PA":"Spanish (Panama)","es-PY":"Spanish (Paraguay)","es-PE":"Spanish (Peru)","es-PR":"Spanish (Puerto Rico)","es-ES":"Spanish (Spain)","es-UY":"Spanish (Uruguay)","es-VE":"Spanish (Venezuela)",sx:"Sutu",sw:"Swahili",sv:"Swedish","sv-FI":"Swedish (Finland)","sv-SV":"Swedish (Sweden)",ta:"Tamil",tt:"Tatar",te:"Teluga",th:"Thai",tig:"Tigre",ts:"Tsonga",tn:"Tswana",tr:"Turkish",tk:"Turkmen",uk:"Ukrainian",hsb:"Upper Sorbian",ur:"Urdu",ve:"Venda",vi:"Vietnamese",vo:"Volapuk",wa:"Walloon",cy:"Welsh",xh:"Xhosa",ji:"Yiddish",zu:"Zulu"}[e]&&(this.internal.languageSettings.languageCode=e,!1===this.internal.languageSettings.isSubscribed&&(this.internal.events.subscribe("putCatalog",function(){this.internal.write("/Lang ("+this.internal.languageSettings.languageCode+")")}),this.internal.languageSettings.isSubscribed=!0)),this},Jx=Fb.API,Wx=Jx.getCharWidthsArray=function(e,t){var s,i,n=(t=t||{}).font||this.internal.getFont(),r=t.fontSize||this.internal.getFontSize(),a=t.charSpace||this.internal.getCharSpace(),o=t.widths?t.widths:n.metadata.Unicode.widths,l=o.fof?o.fof:1,c=t.kerning?t.kerning:n.metadata.Unicode.kerning,d=c.fof?c.fof:1,u=!1!==t.doKerning,h=0,f=e.length,m=0,p=o[0]||l,g=[];for(s=0;s<f;s++)i=e.charCodeAt(s),"function"==typeof n.metadata.widthOfString?g.push((n.metadata.widthOfGlyph(n.metadata.characterToGlyph(i))+a*(1e3/r)||0)/1e3):(h=u&&"object"===fy(c[i])&&!isNaN(parseInt(c[i][m],10))?c[i][m]/d:0,g.push((o[i]||p)/l+h)),m=i;return g},Kx=Jx.getStringUnitWidth=function(e,t){var s=(t=t||{}).fontSize||this.internal.getFontSize(),i=t.font||this.internal.getFont(),n=t.charSpace||this.internal.getCharSpace();return Jx.processArabic&&(e=Jx.processArabic(e)),"function"==typeof i.metadata.widthOfString?i.metadata.widthOfString(e,s,n)/s:Wx.apply(this,arguments).reduce(function(e,t){return e+t},0)},Yx=function(e,t,s,i){for(var n=[],r=0,a=e.length,o=0;r!==a&&o+t[r]<s;)o+=t[r],r++;n.push(e.slice(0,r));var l=r;for(o=0;r!==a;)o+t[r]>i&&(n.push(e.slice(l,r)),o=0,l=r),o+=t[r],r++;return l!==r&&n.push(e.slice(l,r)),n},Xx=function(e,t,s){s||(s={});var i,n,r,a,o,l,c,d=[],u=[d],h=s.textIndent||0,f=0,m=0,p=e.split(" "),g=Wx.apply(this,[" ",s])[0];if(l=-1===s.lineIndent?p[0].length+2:s.lineIndent||0){var v=Array(l).join(" "),y=[];p.map(function(e){(e=e.split(/\s*\n/)).length>1?y=y.concat(e.map(function(e,t){return(t&&e.length?"\n":"")+e})):y.push(e[0])}),p=y,l=Kx.apply(this,[v,s])}for(r=0,a=p.length;r<a;r++){var b=0;if(i=p[r],l&&"\n"==i[0]&&(i=i.substr(1),b=1),h+f+(m=(n=Wx.apply(this,[i,s])).reduce(function(e,t){return e+t},0))>t||b){if(m>t){for(o=Yx.apply(this,[i,n,t-(h+f),t]),d.push(o.shift()),d=[o.pop()];o.length;)u.push([o.shift()]);m=n.slice(i.length-(d[0]?d[0].length:0)).reduce(function(e,t){return e+t},0)}else d=[i];u.push(d),h=m+l,f=g}else d.push(i),h+=f+m,f=g}return c=l?function(e,t){return(t?v:"")+e.join(" ")}:function(e){return e.join(" ")},u.map(c)},Jx.splitTextToSize=function(e,t,s){var i,n=(s=s||{}).fontSize||this.internal.getFontSize(),r=function(e){if(e.widths&&e.kerning)return{widths:e.widths,kerning:e.kerning};var t=this.internal.getFont(e.fontName,e.fontStyle);return t.metadata.Unicode?{widths:t.metadata.Unicode.widths||{0:1},kerning:t.metadata.Unicode.kerning||{}}:{font:t.metadata,fontSize:this.internal.getFontSize(),charSpace:this.internal.getCharSpace()}}.call(this,s);i=Array.isArray(e)?e:String(e).split(/\r?\n/);var a=1*this.internal.scaleFactor*t/n;r.textIndent=s.textIndent?1*s.textIndent*this.internal.scaleFactor/n:0,r.lineIndent=s.lineIndent;var o,l,c=[];for(o=0,l=i.length;o<l;o++)c=c.concat(Xx.apply(this,[i[o],a,r]));return c},function(e){e.__fontmetrics__=e.__fontmetrics__||{};for(var t="klmnopqrstuvwxyz",s={},i={},n=0;n<16;n++)s[t[n]]="0123456789abcdef"[n],i["0123456789abcdef"[n]]=t[n];var r=function(e){return"0x"+parseInt(e,10).toString(16)},a=e.__fontmetrics__.compress=function(e){var t,s,n,o,l=["{"];for(var c in e){if(t=e[c],isNaN(parseInt(c,10))?s="'"+c+"'":(c=parseInt(c,10),s=(s=r(c).slice(2)).slice(0,-1)+i[s.slice(-1)]),"number"==typeof t)t<0?(n=r(t).slice(3),o="-"):(n=r(t).slice(2),o=""),n=o+n.slice(0,-1)+i[n.slice(-1)];else{if("object"!==fy(t))throw new Error("Don't know what to do with value type "+fy(t)+".");n=a(t)}l.push(s+n)}return l.push("}"),l.join("")},o=e.__fontmetrics__.uncompress=function(e){if("string"!=typeof e)throw new Error("Invalid argument passed to uncompress.");for(var t,i,n,r,a={},o=1,l=a,c=[],d="",u="",h=e.length-1,f=1;f<h;f+=1)"'"==(r=e[f])?t?(n=t.join(""),t=void 0):t=[]:t?t.push(r):"{"==r?(c.push([l,n]),l={},n=void 0):"}"==r?((i=c.pop())[0][i[1]]=l,n=void 0,l=i[0]):"-"==r?o=-1:void 0===n?s.hasOwnProperty(r)?(d+=s[r],n=parseInt(d,16)*o,o=1,d=""):d+=r:s.hasOwnProperty(r)?(u+=s[r],l[n]=parseInt(u,16)*o,o=1,n=void 0,u=""):u+=r;return a},l={codePages:["WinAnsiEncoding"],WinAnsiEncoding:o("{19m8n201n9q201o9r201s9l201t9m201u8m201w9n201x9o201y8o202k8q202l8r202m9p202q8p20aw8k203k8t203t8v203u9v2cq8s212m9t15m8w15n9w2dw9s16k8u16l9u17s9z17x8y17y9y}")},c={Unicode:{Courier:l,"Courier-Bold":l,"Courier-BoldOblique":l,"Courier-Oblique":l,Helvetica:l,"Helvetica-Bold":l,"Helvetica-BoldOblique":l,"Helvetica-Oblique":l,"Times-Roman":l,"Times-Bold":l,"Times-BoldItalic":l,"Times-Italic":l}},d={Unicode:{"Courier-Oblique":o("{'widths'{k3w'fof'6o}'kerning'{'fof'-6o}}"),"Times-BoldItalic":o("{'widths'{k3o2q4ycx2r201n3m201o6o201s2l201t2l201u2l201w3m201x3m201y3m2k1t2l2r202m2n2n3m2o3m2p5n202q6o2r1w2s2l2t2l2u3m2v3t2w1t2x2l2y1t2z1w3k3m3l3m3m3m3n3m3o3m3p3m3q3m3r3m3s3m203t2l203u2l3v2l3w3t3x3t3y3t3z3m4k5n4l4m4m4m4n4m4o4s4p4m4q4m4r4s4s4y4t2r4u3m4v4m4w3x4x5t4y4s4z4s5k3x5l4s5m4m5n3r5o3x5p4s5q4m5r5t5s4m5t3x5u3x5v2l5w1w5x2l5y3t5z3m6k2l6l3m6m3m6n2w6o3m6p2w6q2l6r3m6s3r6t1w6u1w6v3m6w1w6x4y6y3r6z3m7k3m7l3m7m2r7n2r7o1w7p3r7q2w7r4m7s3m7t2w7u2r7v2n7w1q7x2n7y3t202l3mcl4mal2ram3man3mao3map3mar3mas2lat4uau1uav3maw3way4uaz2lbk2sbl3t'fof'6obo2lbp3tbq3mbr1tbs2lbu1ybv3mbz3mck4m202k3mcm4mcn4mco4mcp4mcq5ycr4mcs4mct4mcu4mcv4mcw2r2m3rcy2rcz2rdl4sdm4sdn4sdo4sdp4sdq4sds4sdt4sdu4sdv4sdw4sdz3mek3mel3mem3men3meo3mep3meq4ser2wes2wet2weu2wev2wew1wex1wey1wez1wfl3rfm3mfn3mfo3mfp3mfq3mfr3tfs3mft3rfu3rfv3rfw3rfz2w203k6o212m6o2dw2l2cq2l3t3m3u2l17s3x19m3m}'kerning'{cl{4qu5kt5qt5rs17ss5ts}201s{201ss}201t{cks4lscmscnscoscpscls2wu2yu201ts}201x{2wu2yu}2k{201ts}2w{4qx5kx5ou5qx5rs17su5tu}2x{17su5tu5ou}2y{4qx5kx5ou5qx5rs17ss5ts}'fof'-6ofn{17sw5tw5ou5qw5rs}7t{cksclscmscnscoscps4ls}3u{17su5tu5os5qs}3v{17su5tu5os5qs}7p{17su5tu}ck{4qu5kt5qt5rs17ss5ts}4l{4qu5kt5qt5rs17ss5ts}cm{4qu5kt5qt5rs17ss5ts}cn{4qu5kt5qt5rs17ss5ts}co{4qu5kt5qt5rs17ss5ts}cp{4qu5kt5qt5rs17ss5ts}6l{4qu5ou5qw5rt17su5tu}5q{ckuclucmucnucoucpu4lu}5r{ckuclucmucnucoucpu4lu}7q{cksclscmscnscoscps4ls}6p{4qu5ou5qw5rt17sw5tw}ek{4qu5ou5qw5rt17su5tu}el{4qu5ou5qw5rt17su5tu}em{4qu5ou5qw5rt17su5tu}en{4qu5ou5qw5rt17su5tu}eo{4qu5ou5qw5rt17su5tu}ep{4qu5ou5qw5rt17su5tu}es{17ss5ts5qs4qu}et{4qu5ou5qw5rt17sw5tw}eu{4qu5ou5qw5rt17ss5ts}ev{17ss5ts5qs4qu}6z{17sw5tw5ou5qw5rs}fm{17sw5tw5ou5qw5rs}7n{201ts}fo{17sw5tw5ou5qw5rs}fp{17sw5tw5ou5qw5rs}fq{17sw5tw5ou5qw5rs}7r{cksclscmscnscoscps4ls}fs{17sw5tw5ou5qw5rs}ft{17su5tu}fu{17su5tu}fv{17su5tu}fw{17su5tu}fz{cksclscmscnscoscps4ls}}}"),"Helvetica-Bold":o("{'widths'{k3s2q4scx1w201n3r201o6o201s1w201t1w201u1w201w3m201x3m201y3m2k1w2l2l202m2n2n3r2o3r2p5t202q6o2r1s2s2l2t2l2u2r2v3u2w1w2x2l2y1w2z1w3k3r3l3r3m3r3n3r3o3r3p3r3q3r3r3r3s3r203t2l203u2l3v2l3w3u3x3u3y3u3z3x4k6l4l4s4m4s4n4s4o4s4p4m4q3x4r4y4s4s4t1w4u3r4v4s4w3x4x5n4y4s4z4y5k4m5l4y5m4s5n4m5o3x5p4s5q4m5r5y5s4m5t4m5u3x5v2l5w1w5x2l5y3u5z3r6k2l6l3r6m3x6n3r6o3x6p3r6q2l6r3x6s3x6t1w6u1w6v3r6w1w6x5t6y3x6z3x7k3x7l3x7m2r7n3r7o2l7p3x7q3r7r4y7s3r7t3r7u3m7v2r7w1w7x2r7y3u202l3rcl4sal2lam3ran3rao3rap3rar3ras2lat4tau2pav3raw3uay4taz2lbk2sbl3u'fof'6obo2lbp3xbq3rbr1wbs2lbu2obv3rbz3xck4s202k3rcm4scn4sco4scp4scq6ocr4scs4mct4mcu4mcv4mcw1w2m2zcy1wcz1wdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3xek3rel3rem3ren3reo3rep3req5ter3res3ret3reu3rev3rew1wex1wey1wez1wfl3xfm3xfn3xfo3xfp3xfq3xfr3ufs3xft3xfu3xfv3xfw3xfz3r203k6o212m6o2dw2l2cq2l3t3r3u2l17s4m19m3r}'kerning'{cl{4qs5ku5ot5qs17sv5tv}201t{2ww4wy2yw}201w{2ks}201x{2ww4wy2yw}2k{201ts201xs}2w{7qs4qu5kw5os5qw5rs17su5tu7tsfzs}2x{5ow5qs}2y{7qs4qu5kw5os5qw5rs17su5tu7tsfzs}'fof'-6o7p{17su5tu5ot}ck{4qs5ku5ot5qs17sv5tv}4l{4qs5ku5ot5qs17sv5tv}cm{4qs5ku5ot5qs17sv5tv}cn{4qs5ku5ot5qs17sv5tv}co{4qs5ku5ot5qs17sv5tv}cp{4qs5ku5ot5qs17sv5tv}6l{17st5tt5os}17s{2kwclvcmvcnvcovcpv4lv4wwckv}5o{2kucltcmtcntcotcpt4lt4wtckt}5q{2ksclscmscnscoscps4ls4wvcks}5r{2ks4ws}5t{2kwclvcmvcnvcovcpv4lv4wwckv}eo{17st5tt5os}fu{17su5tu5ot}6p{17ss5ts}ek{17st5tt5os}el{17st5tt5os}em{17st5tt5os}en{17st5tt5os}6o{201ts}ep{17st5tt5os}es{17ss5ts}et{17ss5ts}eu{17ss5ts}ev{17ss5ts}6z{17su5tu5os5qt}fm{17su5tu5os5qt}fn{17su5tu5os5qt}fo{17su5tu5os5qt}fp{17su5tu5os5qt}fq{17su5tu5os5qt}fs{17su5tu5os5qt}ft{17su5tu5ot}7m{5os}fv{17su5tu5ot}fw{17su5tu5ot}}}"),Courier:o("{'widths'{k3w'fof'6o}'kerning'{'fof'-6o}}"),"Courier-BoldOblique":o("{'widths'{k3w'fof'6o}'kerning'{'fof'-6o}}"),"Times-Bold":o("{'widths'{k3q2q5ncx2r201n3m201o6o201s2l201t2l201u2l201w3m201x3m201y3m2k1t2l2l202m2n2n3m2o3m2p6o202q6o2r1w2s2l2t2l2u3m2v3t2w1t2x2l2y1t2z1w3k3m3l3m3m3m3n3m3o3m3p3m3q3m3r3m3s3m203t2l203u2l3v2l3w3t3x3t3y3t3z3m4k5x4l4s4m4m4n4s4o4s4p4m4q3x4r4y4s4y4t2r4u3m4v4y4w4m4x5y4y4s4z4y5k3x5l4y5m4s5n3r5o4m5p4s5q4s5r6o5s4s5t4s5u4m5v2l5w1w5x2l5y3u5z3m6k2l6l3m6m3r6n2w6o3r6p2w6q2l6r3m6s3r6t1w6u2l6v3r6w1w6x5n6y3r6z3m7k3r7l3r7m2w7n2r7o2l7p3r7q3m7r4s7s3m7t3m7u2w7v2r7w1q7x2r7y3o202l3mcl4sal2lam3man3mao3map3mar3mas2lat4uau1yav3maw3tay4uaz2lbk2sbl3t'fof'6obo2lbp3rbr1tbs2lbu2lbv3mbz3mck4s202k3mcm4scn4sco4scp4scq6ocr4scs4mct4mcu4mcv4mcw2r2m3rcy2rcz2rdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3rek3mel3mem3men3meo3mep3meq4ser2wes2wet2weu2wev2wew1wex1wey1wez1wfl3rfm3mfn3mfo3mfp3mfq3mfr3tfs3mft3rfu3rfv3rfw3rfz3m203k6o212m6o2dw2l2cq2l3t3m3u2l17s4s19m3m}'kerning'{cl{4qt5ks5ot5qy5rw17sv5tv}201t{cks4lscmscnscoscpscls4wv}2k{201ts}2w{4qu5ku7mu5os5qx5ru17su5tu}2x{17su5tu5ou5qs}2y{4qv5kv7mu5ot5qz5ru17su5tu}'fof'-6o7t{cksclscmscnscoscps4ls}3u{17su5tu5os5qu}3v{17su5tu5os5qu}fu{17su5tu5ou5qu}7p{17su5tu5ou5qu}ck{4qt5ks5ot5qy5rw17sv5tv}4l{4qt5ks5ot5qy5rw17sv5tv}cm{4qt5ks5ot5qy5rw17sv5tv}cn{4qt5ks5ot5qy5rw17sv5tv}co{4qt5ks5ot5qy5rw17sv5tv}cp{4qt5ks5ot5qy5rw17sv5tv}6l{17st5tt5ou5qu}17s{ckuclucmucnucoucpu4lu4wu}5o{ckuclucmucnucoucpu4lu4wu}5q{ckzclzcmzcnzcozcpz4lz4wu}5r{ckxclxcmxcnxcoxcpx4lx4wu}5t{ckuclucmucnucoucpu4lu4wu}7q{ckuclucmucnucoucpu4lu}6p{17sw5tw5ou5qu}ek{17st5tt5qu}el{17st5tt5ou5qu}em{17st5tt5qu}en{17st5tt5qu}eo{17st5tt5qu}ep{17st5tt5ou5qu}es{17ss5ts5qu}et{17sw5tw5ou5qu}eu{17sw5tw5ou5qu}ev{17ss5ts5qu}6z{17sw5tw5ou5qu5rs}fm{17sw5tw5ou5qu5rs}fn{17sw5tw5ou5qu5rs}fo{17sw5tw5ou5qu5rs}fp{17sw5tw5ou5qu5rs}fq{17sw5tw5ou5qu5rs}7r{cktcltcmtcntcotcpt4lt5os}fs{17sw5tw5ou5qu5rs}ft{17su5tu5ou5qu}7m{5os}fv{17su5tu5ou5qu}fw{17su5tu5ou5qu}fz{cksclscmscnscoscps4ls}}}"),Symbol:o("{'widths'{k3uaw4r19m3m2k1t2l2l202m2y2n3m2p5n202q6o3k3m2s2l2t2l2v3r2w1t3m3m2y1t2z1wbk2sbl3r'fof'6o3n3m3o3m3p3m3q3m3r3m3s3m3t3m3u1w3v1w3w3r3x3r3y3r3z2wbp3t3l3m5v2l5x2l5z3m2q4yfr3r7v3k7w1o7x3k}'kerning'{'fof'-6o}}"),Helvetica:o("{'widths'{k3p2q4mcx1w201n3r201o6o201s1q201t1q201u1q201w2l201x2l201y2l2k1w2l1w202m2n2n3r2o3r2p5t202q6o2r1n2s2l2t2l2u2r2v3u2w1w2x2l2y1w2z1w3k3r3l3r3m3r3n3r3o3r3p3r3q3r3r3r3s3r203t2l203u2l3v1w3w3u3x3u3y3u3z3r4k6p4l4m4m4m4n4s4o4s4p4m4q3x4r4y4s4s4t1w4u3m4v4m4w3r4x5n4y4s4z4y5k4m5l4y5m4s5n4m5o3x5p4s5q4m5r5y5s4m5t4m5u3x5v1w5w1w5x1w5y2z5z3r6k2l6l3r6m3r6n3m6o3r6p3r6q1w6r3r6s3r6t1q6u1q6v3m6w1q6x5n6y3r6z3r7k3r7l3r7m2l7n3m7o1w7p3r7q3m7r4s7s3m7t3m7u3m7v2l7w1u7x2l7y3u202l3rcl4mal2lam3ran3rao3rap3rar3ras2lat4tau2pav3raw3uay4taz2lbk2sbl3u'fof'6obo2lbp3rbr1wbs2lbu2obv3rbz3xck4m202k3rcm4mcn4mco4mcp4mcq6ocr4scs4mct4mcu4mcv4mcw1w2m2ncy1wcz1wdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3xek3rel3rem3ren3reo3rep3req5ter3mes3ret3reu3rev3rew1wex1wey1wez1wfl3rfm3rfn3rfo3rfp3rfq3rfr3ufs3xft3rfu3rfv3rfw3rfz3m203k6o212m6o2dw2l2cq2l3t3r3u1w17s4m19m3r}'kerning'{5q{4wv}cl{4qs5kw5ow5qs17sv5tv}201t{2wu4w1k2yu}201x{2wu4wy2yu}17s{2ktclucmucnu4otcpu4lu4wycoucku}2w{7qs4qz5k1m17sy5ow5qx5rsfsu5ty7tufzu}2x{17sy5ty5oy5qs}2y{7qs4qz5k1m17sy5ow5qx5rsfsu5ty7tufzu}'fof'-6o7p{17sv5tv5ow}ck{4qs5kw5ow5qs17sv5tv}4l{4qs5kw5ow5qs17sv5tv}cm{4qs5kw5ow5qs17sv5tv}cn{4qs5kw5ow5qs17sv5tv}co{4qs5kw5ow5qs17sv5tv}cp{4qs5kw5ow5qs17sv5tv}6l{17sy5ty5ow}do{17st5tt}4z{17st5tt}7s{fst}dm{17st5tt}dn{17st5tt}5o{ckwclwcmwcnwcowcpw4lw4wv}dp{17st5tt}dq{17st5tt}7t{5ow}ds{17st5tt}5t{2ktclucmucnu4otcpu4lu4wycoucku}fu{17sv5tv5ow}6p{17sy5ty5ow5qs}ek{17sy5ty5ow}el{17sy5ty5ow}em{17sy5ty5ow}en{5ty}eo{17sy5ty5ow}ep{17sy5ty5ow}es{17sy5ty5qs}et{17sy5ty5ow5qs}eu{17sy5ty5ow5qs}ev{17sy5ty5ow5qs}6z{17sy5ty5ow5qs}fm{17sy5ty5ow5qs}fn{17sy5ty5ow5qs}fo{17sy5ty5ow5qs}fp{17sy5ty5qs}fq{17sy5ty5ow5qs}7r{5ow}fs{17sy5ty5ow5qs}ft{17sv5tv5ow}7m{5ow}fv{17sv5tv5ow}fw{17sv5tv5ow}}}"),"Helvetica-BoldOblique":o("{'widths'{k3s2q4scx1w201n3r201o6o201s1w201t1w201u1w201w3m201x3m201y3m2k1w2l2l202m2n2n3r2o3r2p5t202q6o2r1s2s2l2t2l2u2r2v3u2w1w2x2l2y1w2z1w3k3r3l3r3m3r3n3r3o3r3p3r3q3r3r3r3s3r203t2l203u2l3v2l3w3u3x3u3y3u3z3x4k6l4l4s4m4s4n4s4o4s4p4m4q3x4r4y4s4s4t1w4u3r4v4s4w3x4x5n4y4s4z4y5k4m5l4y5m4s5n4m5o3x5p4s5q4m5r5y5s4m5t4m5u3x5v2l5w1w5x2l5y3u5z3r6k2l6l3r6m3x6n3r6o3x6p3r6q2l6r3x6s3x6t1w6u1w6v3r6w1w6x5t6y3x6z3x7k3x7l3x7m2r7n3r7o2l7p3x7q3r7r4y7s3r7t3r7u3m7v2r7w1w7x2r7y3u202l3rcl4sal2lam3ran3rao3rap3rar3ras2lat4tau2pav3raw3uay4taz2lbk2sbl3u'fof'6obo2lbp3xbq3rbr1wbs2lbu2obv3rbz3xck4s202k3rcm4scn4sco4scp4scq6ocr4scs4mct4mcu4mcv4mcw1w2m2zcy1wcz1wdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3xek3rel3rem3ren3reo3rep3req5ter3res3ret3reu3rev3rew1wex1wey1wez1wfl3xfm3xfn3xfo3xfp3xfq3xfr3ufs3xft3xfu3xfv3xfw3xfz3r203k6o212m6o2dw2l2cq2l3t3r3u2l17s4m19m3r}'kerning'{cl{4qs5ku5ot5qs17sv5tv}201t{2ww4wy2yw}201w{2ks}201x{2ww4wy2yw}2k{201ts201xs}2w{7qs4qu5kw5os5qw5rs17su5tu7tsfzs}2x{5ow5qs}2y{7qs4qu5kw5os5qw5rs17su5tu7tsfzs}'fof'-6o7p{17su5tu5ot}ck{4qs5ku5ot5qs17sv5tv}4l{4qs5ku5ot5qs17sv5tv}cm{4qs5ku5ot5qs17sv5tv}cn{4qs5ku5ot5qs17sv5tv}co{4qs5ku5ot5qs17sv5tv}cp{4qs5ku5ot5qs17sv5tv}6l{17st5tt5os}17s{2kwclvcmvcnvcovcpv4lv4wwckv}5o{2kucltcmtcntcotcpt4lt4wtckt}5q{2ksclscmscnscoscps4ls4wvcks}5r{2ks4ws}5t{2kwclvcmvcnvcovcpv4lv4wwckv}eo{17st5tt5os}fu{17su5tu5ot}6p{17ss5ts}ek{17st5tt5os}el{17st5tt5os}em{17st5tt5os}en{17st5tt5os}6o{201ts}ep{17st5tt5os}es{17ss5ts}et{17ss5ts}eu{17ss5ts}ev{17ss5ts}6z{17su5tu5os5qt}fm{17su5tu5os5qt}fn{17su5tu5os5qt}fo{17su5tu5os5qt}fp{17su5tu5os5qt}fq{17su5tu5os5qt}fs{17su5tu5os5qt}ft{17su5tu5ot}7m{5os}fv{17su5tu5ot}fw{17su5tu5ot}}}"),ZapfDingbats:o("{'widths'{k4u2k1w'fof'6o}'kerning'{'fof'-6o}}"),"Courier-Bold":o("{'widths'{k3w'fof'6o}'kerning'{'fof'-6o}}"),"Times-Italic":o("{'widths'{k3n2q4ycx2l201n3m201o5t201s2l201t2l201u2l201w3r201x3r201y3r2k1t2l2l202m2n2n3m2o3m2p5n202q5t2r1p2s2l2t2l2u3m2v4n2w1t2x2l2y1t2z1w3k3m3l3m3m3m3n3m3o3m3p3m3q3m3r3m3s3m203t2l203u2l3v2l3w4n3x4n3y4n3z3m4k5w4l3x4m3x4n4m4o4s4p3x4q3x4r4s4s4s4t2l4u2w4v4m4w3r4x5n4y4m4z4s5k3x5l4s5m3x5n3m5o3r5p4s5q3x5r5n5s3x5t3r5u3r5v2r5w1w5x2r5y2u5z3m6k2l6l3m6m3m6n2w6o3m6p2w6q1w6r3m6s3m6t1w6u1w6v2w6w1w6x4s6y3m6z3m7k3m7l3m7m2r7n2r7o1w7p3m7q2w7r4m7s2w7t2w7u2r7v2s7w1v7x2s7y3q202l3mcl3xal2ram3man3mao3map3mar3mas2lat4wau1vav3maw4nay4waz2lbk2sbl4n'fof'6obo2lbp3mbq3obr1tbs2lbu1zbv3mbz3mck3x202k3mcm3xcn3xco3xcp3xcq5tcr4mcs3xct3xcu3xcv3xcw2l2m2ucy2lcz2ldl4mdm4sdn4sdo4sdp4sdq4sds4sdt4sdu4sdv4sdw4sdz3mek3mel3mem3men3meo3mep3meq4mer2wes2wet2weu2wev2wew1wex1wey1wez1wfl3mfm3mfn3mfo3mfp3mfq3mfr4nfs3mft3mfu3mfv3mfw3mfz2w203k6o212m6m2dw2l2cq2l3t3m3u2l17s3r19m3m}'kerning'{cl{5kt4qw}201s{201sw}201t{201tw2wy2yy6q-t}201x{2wy2yy}2k{201tw}2w{7qs4qy7rs5ky7mw5os5qx5ru17su5tu}2x{17ss5ts5os}2y{7qs4qy7rs5ky7mw5os5qx5ru17su5tu}'fof'-6o6t{17ss5ts5qs}7t{5os}3v{5qs}7p{17su5tu5qs}ck{5kt4qw}4l{5kt4qw}cm{5kt4qw}cn{5kt4qw}co{5kt4qw}cp{5kt4qw}6l{4qs5ks5ou5qw5ru17su5tu}17s{2ks}5q{ckvclvcmvcnvcovcpv4lv}5r{ckuclucmucnucoucpu4lu}5t{2ks}6p{4qs5ks5ou5qw5ru17su5tu}ek{4qs5ks5ou5qw5ru17su5tu}el{4qs5ks5ou5qw5ru17su5tu}em{4qs5ks5ou5qw5ru17su5tu}en{4qs5ks5ou5qw5ru17su5tu}eo{4qs5ks5ou5qw5ru17su5tu}ep{4qs5ks5ou5qw5ru17su5tu}es{5ks5qs4qs}et{4qs5ks5ou5qw5ru17su5tu}eu{4qs5ks5qw5ru17su5tu}ev{5ks5qs4qs}ex{17ss5ts5qs}6z{4qv5ks5ou5qw5ru17su5tu}fm{4qv5ks5ou5qw5ru17su5tu}fn{4qv5ks5ou5qw5ru17su5tu}fo{4qv5ks5ou5qw5ru17su5tu}fp{4qv5ks5ou5qw5ru17su5tu}fq{4qv5ks5ou5qw5ru17su5tu}7r{5os}fs{4qv5ks5ou5qw5ru17su5tu}ft{17su5tu5qs}fu{17su5tu5qs}fv{17su5tu5qs}fw{17su5tu5qs}}}"),"Times-Roman":o("{'widths'{k3n2q4ycx2l201n3m201o6o201s2l201t2l201u2l201w2w201x2w201y2w2k1t2l2l202m2n2n3m2o3m2p5n202q6o2r1m2s2l2t2l2u3m2v3s2w1t2x2l2y1t2z1w3k3m3l3m3m3m3n3m3o3m3p3m3q3m3r3m3s3m203t2l203u2l3v1w3w3s3x3s3y3s3z2w4k5w4l4s4m4m4n4m4o4s4p3x4q3r4r4s4s4s4t2l4u2r4v4s4w3x4x5t4y4s4z4s5k3r5l4s5m4m5n3r5o3x5p4s5q4s5r5y5s4s5t4s5u3x5v2l5w1w5x2l5y2z5z3m6k2l6l2w6m3m6n2w6o3m6p2w6q2l6r3m6s3m6t1w6u1w6v3m6w1w6x4y6y3m6z3m7k3m7l3m7m2l7n2r7o1w7p3m7q3m7r4s7s3m7t3m7u2w7v3k7w1o7x3k7y3q202l3mcl4sal2lam3man3mao3map3mar3mas2lat4wau1vav3maw3say4waz2lbk2sbl3s'fof'6obo2lbp3mbq2xbr1tbs2lbu1zbv3mbz2wck4s202k3mcm4scn4sco4scp4scq5tcr4mcs3xct3xcu3xcv3xcw2l2m2tcy2lcz2ldl4sdm4sdn4sdo4sdp4sdq4sds4sdt4sdu4sdv4sdw4sdz3mek2wel2wem2wen2weo2wep2weq4mer2wes2wet2weu2wev2wew1wex1wey1wez1wfl3mfm3mfn3mfo3mfp3mfq3mfr3sfs3mft3mfu3mfv3mfw3mfz3m203k6o212m6m2dw2l2cq2l3t3m3u1w17s4s19m3m}'kerning'{cl{4qs5ku17sw5ou5qy5rw201ss5tw201ws}201s{201ss}201t{ckw4lwcmwcnwcowcpwclw4wu201ts}2k{201ts}2w{4qs5kw5os5qx5ru17sx5tx}2x{17sw5tw5ou5qu}2y{4qs5kw5os5qx5ru17sx5tx}'fof'-6o7t{ckuclucmucnucoucpu4lu5os5rs}3u{17su5tu5qs}3v{17su5tu5qs}7p{17sw5tw5qs}ck{4qs5ku17sw5ou5qy5rw201ss5tw201ws}4l{4qs5ku17sw5ou5qy5rw201ss5tw201ws}cm{4qs5ku17sw5ou5qy5rw201ss5tw201ws}cn{4qs5ku17sw5ou5qy5rw201ss5tw201ws}co{4qs5ku17sw5ou5qy5rw201ss5tw201ws}cp{4qs5ku17sw5ou5qy5rw201ss5tw201ws}6l{17su5tu5os5qw5rs}17s{2ktclvcmvcnvcovcpv4lv4wuckv}5o{ckwclwcmwcnwcowcpw4lw4wu}5q{ckyclycmycnycoycpy4ly4wu5ms}5r{cktcltcmtcntcotcpt4lt4ws}5t{2ktclvcmvcnvcovcpv4lv4wuckv}7q{cksclscmscnscoscps4ls}6p{17su5tu5qw5rs}ek{5qs5rs}el{17su5tu5os5qw5rs}em{17su5tu5os5qs5rs}en{17su5qs5rs}eo{5qs5rs}ep{17su5tu5os5qw5rs}es{5qs}et{17su5tu5qw5rs}eu{17su5tu5qs5rs}ev{5qs}6z{17sv5tv5os5qx5rs}fm{5os5qt5rs}fn{17sv5tv5os5qx5rs}fo{17sv5tv5os5qx5rs}fp{5os5qt5rs}fq{5os5qt5rs}7r{ckuclucmucnucoucpu4lu5os}fs{17sv5tv5os5qx5rs}ft{17ss5ts5qs}fu{17sw5tw5qs}fv{17sw5tw5qs}fw{17ss5ts5qs}fz{ckuclucmucnucoucpu4lu5os5rs}}}"),"Helvetica-Oblique":o("{'widths'{k3p2q4mcx1w201n3r201o6o201s1q201t1q201u1q201w2l201x2l201y2l2k1w2l1w202m2n2n3r2o3r2p5t202q6o2r1n2s2l2t2l2u2r2v3u2w1w2x2l2y1w2z1w3k3r3l3r3m3r3n3r3o3r3p3r3q3r3r3r3s3r203t2l203u2l3v1w3w3u3x3u3y3u3z3r4k6p4l4m4m4m4n4s4o4s4p4m4q3x4r4y4s4s4t1w4u3m4v4m4w3r4x5n4y4s4z4y5k4m5l4y5m4s5n4m5o3x5p4s5q4m5r5y5s4m5t4m5u3x5v1w5w1w5x1w5y2z5z3r6k2l6l3r6m3r6n3m6o3r6p3r6q1w6r3r6s3r6t1q6u1q6v3m6w1q6x5n6y3r6z3r7k3r7l3r7m2l7n3m7o1w7p3r7q3m7r4s7s3m7t3m7u3m7v2l7w1u7x2l7y3u202l3rcl4mal2lam3ran3rao3rap3rar3ras2lat4tau2pav3raw3uay4taz2lbk2sbl3u'fof'6obo2lbp3rbr1wbs2lbu2obv3rbz3xck4m202k3rcm4mcn4mco4mcp4mcq6ocr4scs4mct4mcu4mcv4mcw1w2m2ncy1wcz1wdl4sdm4ydn4ydo4ydp4ydq4yds4ydt4sdu4sdv4sdw4sdz3xek3rel3rem3ren3reo3rep3req5ter3mes3ret3reu3rev3rew1wex1wey1wez1wfl3rfm3rfn3rfo3rfp3rfq3rfr3ufs3xft3rfu3rfv3rfw3rfz3m203k6o212m6o2dw2l2cq2l3t3r3u1w17s4m19m3r}'kerning'{5q{4wv}cl{4qs5kw5ow5qs17sv5tv}201t{2wu4w1k2yu}201x{2wu4wy2yu}17s{2ktclucmucnu4otcpu4lu4wycoucku}2w{7qs4qz5k1m17sy5ow5qx5rsfsu5ty7tufzu}2x{17sy5ty5oy5qs}2y{7qs4qz5k1m17sy5ow5qx5rsfsu5ty7tufzu}'fof'-6o7p{17sv5tv5ow}ck{4qs5kw5ow5qs17sv5tv}4l{4qs5kw5ow5qs17sv5tv}cm{4qs5kw5ow5qs17sv5tv}cn{4qs5kw5ow5qs17sv5tv}co{4qs5kw5ow5qs17sv5tv}cp{4qs5kw5ow5qs17sv5tv}6l{17sy5ty5ow}do{17st5tt}4z{17st5tt}7s{fst}dm{17st5tt}dn{17st5tt}5o{ckwclwcmwcnwcowcpw4lw4wv}dp{17st5tt}dq{17st5tt}7t{5ow}ds{17st5tt}5t{2ktclucmucnu4otcpu4lu4wycoucku}fu{17sv5tv5ow}6p{17sy5ty5ow5qs}ek{17sy5ty5ow}el{17sy5ty5ow}em{17sy5ty5ow}en{5ty}eo{17sy5ty5ow}ep{17sy5ty5ow}es{17sy5ty5qs}et{17sy5ty5ow5qs}eu{17sy5ty5ow5qs}ev{17sy5ty5ow5qs}6z{17sy5ty5ow5qs}fm{17sy5ty5ow5qs}fn{17sy5ty5ow5qs}fo{17sy5ty5ow5qs}fp{17sy5ty5qs}fq{17sy5ty5ow5qs}7r{5ow}fs{17sy5ty5ow5qs}ft{17sv5tv5ow}7m{5ow}fv{17sv5tv5ow}fw{17sv5tv5ow}}}")}};e.events.push(["addFont",function(e){var t=e.font,s=d.Unicode[t.postScriptName];s&&(t.metadata.Unicode={},t.metadata.Unicode.widths=s.widths,t.metadata.Unicode.kerning=s.kerning);var i=c.Unicode[t.postScriptName];i&&(t.metadata.Unicode.encoding=i,t.encoding=i.codePages[0])}])}(Fb.API),
/**
 * @license
 * Licensed under the MIT License.
 * http://opensource.org/licenses/mit-license
 */
function(e){var t=function(e){for(var t=e.length,s=new Uint8Array(t),i=0;i<t;i++)s[i]=e.charCodeAt(i);return s};e.API.events.push(["addFont",function(s){var i,n,r=void 0,a=s.font,o=s.instance;if(!a.isStandardFont){if(void 0===o)throw new Error("Font does not exist in vFS, import fonts or remove declaration doc.addFont('"+a.postScriptName+"').");if("string"!=typeof(r=!1===o.existsFileInVFS(a.postScriptName)?o.loadFile(a.postScriptName):o.getFileFromVFS(a.postScriptName)))throw new Error("Font is not stored as string-data in vFS, import fonts or remove declaration doc.addFont('"+a.postScriptName+"').");i=a,n=/^\x00\x01\x00\x00/.test(n=r)?t(n):t(hb(n)),i.metadata=e.API.TTFFont.open(n),i.metadata.Unicode=i.metadata.Unicode||{encoding:{},kerning:{},widths:[]},i.metadata.glyIdsUsed=[0]}}])}(Fb),Fb.API.addSvgAsImage=function(e,t,s,i,n,r,a,o){if(isNaN(t)||isNaN(s))throw lb.error("jsPDF.addSvgAsImage: Invalid coordinates",arguments),new Error("Invalid coordinates passed to jsPDF.addSvgAsImage");if(isNaN(i)||isNaN(n))throw lb.error("jsPDF.addSvgAsImage: Invalid measurements",arguments),new Error("Invalid measurements (width and/or height) passed to jsPDF.addSvgAsImage");var l=document.createElement("canvas");l.width=i,l.height=n;var c=l.getContext("2d");c.fillStyle="#fff",c.fillRect(0,0,l.width,l.height);var d={ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0},u=this;return(ab.canvg?Promise.resolve(ab.canvg):g(()=>import("./index.es-B8PC5nDV.js"),__vite__mapDeps([0,1,2,3,4]))).catch(function(e){return Promise.reject(new Error("Could not load canvg: "+e))}).then(function(e){return e.default?e.default:e}).then(function(t){return t.fromString(c,e,d)},function(){return Promise.reject(new Error("Could not load canvg."))}).then(function(e){return e.render(d)}).then(function(){u.addImage(l.toDataURL("image/jpeg",1),t,s,i,n,a,o)})},Fb.API.putTotalPages=function(e){var t,s=0;parseInt(this.internal.getFont().id.substr(1),10)<15?(t=new RegExp(e,"g"),s=this.internal.getNumberOfPages()):(t=new RegExp(this.pdfEscape16(e,this.internal.getFont()),"g"),s=this.pdfEscape16(this.internal.getNumberOfPages()+"",this.internal.getFont()));for(var i=1;i<=this.internal.getNumberOfPages();i++)for(var n=0;n<this.internal.pages[i].length;n++)this.internal.pages[i][n]=this.internal.pages[i][n].replace(t,s);return this},Fb.API.viewerPreferences=function(e,t){var s;e=e||{},t=t||!1;var i,n,r,a={HideToolbar:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},HideMenubar:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},HideWindowUI:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},FitWindow:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},CenterWindow:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.3},DisplayDocTitle:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.4},NonFullScreenPageMode:{defaultValue:"UseNone",value:"UseNone",type:"name",explicitSet:!1,valueSet:["UseNone","UseOutlines","UseThumbs","UseOC"],pdfVersion:1.3},Direction:{defaultValue:"L2R",value:"L2R",type:"name",explicitSet:!1,valueSet:["L2R","R2L"],pdfVersion:1.3},ViewArea:{defaultValue:"CropBox",value:"CropBox",type:"name",explicitSet:!1,valueSet:["MediaBox","CropBox","TrimBox","BleedBox","ArtBox"],pdfVersion:1.4},ViewClip:{defaultValue:"CropBox",value:"CropBox",type:"name",explicitSet:!1,valueSet:["MediaBox","CropBox","TrimBox","BleedBox","ArtBox"],pdfVersion:1.4},PrintArea:{defaultValue:"CropBox",value:"CropBox",type:"name",explicitSet:!1,valueSet:["MediaBox","CropBox","TrimBox","BleedBox","ArtBox"],pdfVersion:1.4},PrintClip:{defaultValue:"CropBox",value:"CropBox",type:"name",explicitSet:!1,valueSet:["MediaBox","CropBox","TrimBox","BleedBox","ArtBox"],pdfVersion:1.4},PrintScaling:{defaultValue:"AppDefault",value:"AppDefault",type:"name",explicitSet:!1,valueSet:["AppDefault","None"],pdfVersion:1.6},Duplex:{defaultValue:"",value:"none",type:"name",explicitSet:!1,valueSet:["Simplex","DuplexFlipShortEdge","DuplexFlipLongEdge","none"],pdfVersion:1.7},PickTrayByPDFSize:{defaultValue:!1,value:!1,type:"boolean",explicitSet:!1,valueSet:[!0,!1],pdfVersion:1.7},PrintPageRange:{defaultValue:"",value:"",type:"array",explicitSet:!1,valueSet:null,pdfVersion:1.7},NumCopies:{defaultValue:1,value:1,type:"integer",explicitSet:!1,valueSet:null,pdfVersion:1.7}},o=Object.keys(a),l=[],c=0,d=0,u=0;function h(e,t){var s,i=!1;for(s=0;s<e.length;s+=1)e[s]===t&&(i=!0);return i}if(void 0===this.internal.viewerpreferences&&(this.internal.viewerpreferences={},this.internal.viewerpreferences.configuration=JSON.parse(JSON.stringify(a)),this.internal.viewerpreferences.isSubscribed=!1),s=this.internal.viewerpreferences.configuration,"reset"===e||!0===t){var f=o.length;for(u=0;u<f;u+=1)s[o[u]].value=s[o[u]].defaultValue,s[o[u]].explicitSet=!1}if("object"===fy(e))for(n in e)if(r=e[n],h(o,n)&&void 0!==r){if("boolean"===s[n].type&&"boolean"==typeof r)s[n].value=r;else if("name"===s[n].type&&h(s[n].valueSet,r))s[n].value=r;else if("integer"===s[n].type&&Number.isInteger(r))s[n].value=r;else if("array"===s[n].type){for(c=0;c<r.length;c+=1)if(i=!0,1===r[c].length&&"number"==typeof r[c][0])l.push(String(r[c]-1));else if(r[c].length>1){for(d=0;d<r[c].length;d+=1)"number"!=typeof r[c][d]&&(i=!1);!0===i&&l.push([r[c][0]-1,r[c][1]-1].join(" "))}s[n].value="["+l.join(" ")+"]"}else s[n].value=s[n].defaultValue;s[n].explicitSet=!0}return!1===this.internal.viewerpreferences.isSubscribed&&(this.internal.events.subscribe("putCatalog",function(){var e,t=[];for(e in s)!0===s[e].explicitSet&&("name"===s[e].type?t.push("/"+e+" /"+s[e].value):t.push("/"+e+" "+s[e].value));0!==t.length&&this.internal.write("/ViewerPreferences\n<<\n"+t.join("\n")+"\n>>")}),this.internal.viewerpreferences.isSubscribed=!0),this.internal.viewerpreferences.configuration=s,this},
/** ====================================================================
 * @license
 * jsPDF XMP metadata plugin
 * Copyright (c) 2016 Jussi Utunen, u-jussi@suomi24.fi
 *
 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:
 *
 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 * ====================================================================
 */
function(e){var t=function(){var e='<rdf:RDF xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"><rdf:Description rdf:about="" xmlns:jspdf="'+this.internal.__metadata__.namespaceuri+'"><jspdf:metadata>',t=unescape(encodeURIComponent('<x:xmpmeta xmlns:x="adobe:ns:meta/">')),s=unescape(encodeURIComponent(e)),i=unescape(encodeURIComponent(this.internal.__metadata__.metadata)),n=unescape(encodeURIComponent("</jspdf:metadata></rdf:Description></rdf:RDF>")),r=unescape(encodeURIComponent("</x:xmpmeta>")),a=s.length+i.length+n.length+t.length+r.length;this.internal.__metadata__.metadata_object_number=this.internal.newObject(),this.internal.write("<< /Type /Metadata /Subtype /XML /Length "+a+" >>"),this.internal.write("stream"),this.internal.write(t+s+i+n+r),this.internal.write("endstream"),this.internal.write("endobj")},s=function(){this.internal.__metadata__.metadata_object_number&&this.internal.write("/Metadata "+this.internal.__metadata__.metadata_object_number+" 0 R")};e.addMetadata=function(e,i){return void 0===this.internal.__metadata__&&(this.internal.__metadata__={metadata:e,namespaceuri:i||"http://jspdf.default.namespaceuri/"},this.internal.events.subscribe("putCatalog",s),this.internal.events.subscribe("postPutResources",t)),this}}(Fb.API),function(e){var t=e.API,s=t.pdfEscape16=function(e,t){for(var s,i=t.metadata.Unicode.widths,n=["","0","00","000","0000"],r=[""],a=0,o=e.length;a<o;++a){if(s=t.metadata.characterToGlyph(e.charCodeAt(a)),t.metadata.glyIdsUsed.push(s),t.metadata.toUnicode[s]=e.charCodeAt(a),-1==i.indexOf(s)&&(i.push(s),i.push([parseInt(t.metadata.widthOfGlyph(s),10)])),"0"==s)return r.join("");s=s.toString(16),r.push(n[4-s.length],s)}return r.join("")},i=function(e){var t,s,i,n,r,a,o;for(r="/CIDInit /ProcSet findresource begin\n12 dict begin\nbegincmap\n/CIDSystemInfo <<\n  /Registry (Adobe)\n  /Ordering (UCS)\n  /Supplement 0\n>> def\n/CMapName /Adobe-Identity-UCS def\n/CMapType 2 def\n1 begincodespacerange\n<0000><ffff>\nendcodespacerange",i=[],a=0,o=(s=Object.keys(e).sort(function(e,t){return e-t})).length;a<o;a++)t=s[a],i.length>=100&&(r+="\n"+i.length+" beginbfchar\n"+i.join("\n")+"\nendbfchar",i=[]),void 0!==e[t]&&null!==e[t]&&"function"==typeof e[t].toString&&(n=("0000"+e[t].toString(16)).slice(-4),t=("0000"+(+t).toString(16)).slice(-4),i.push("<"+t+"><"+n+">"));return i.length&&(r+="\n"+i.length+" beginbfchar\n"+i.join("\n")+"\nendbfchar\n"),r+"endcmap\nCMapName currentdict /CMap defineresource pop\nend\nend"};t.events.push(["putFont",function(t){!function(t){var s=t.font,n=t.out,r=t.newObject,a=t.putStream;if(s.metadata instanceof e.API.TTFFont&&"Identity-H"===s.encoding){for(var o=s.metadata.Unicode.widths,l=s.metadata.subset.encode(s.metadata.glyIdsUsed,1),c="",d=0;d<l.length;d++)c+=String.fromCharCode(l[d]);var u=r();a({data:c,addLength1:!0,objectId:u}),n("endobj");var h=r();a({data:i(s.metadata.toUnicode),addLength1:!0,objectId:h}),n("endobj");var f=r();n("<<"),n("/Type /FontDescriptor"),n("/FontName /"+Lb(s.fontName)),n("/FontFile2 "+u+" 0 R"),n("/FontBBox "+e.API.PDFObject.convert(s.metadata.bbox)),n("/Flags "+s.metadata.flags),n("/StemV "+s.metadata.stemV),n("/ItalicAngle "+s.metadata.italicAngle),n("/Ascent "+s.metadata.ascender),n("/Descent "+s.metadata.decender),n("/CapHeight "+s.metadata.capHeight),n(">>"),n("endobj");var m=r();n("<<"),n("/Type /Font"),n("/BaseFont /"+Lb(s.fontName)),n("/FontDescriptor "+f+" 0 R"),n("/W "+e.API.PDFObject.convert(o)),n("/CIDToGIDMap /Identity"),n("/DW 1000"),n("/Subtype /CIDFontType2"),n("/CIDSystemInfo"),n("<<"),n("/Supplement 0"),n("/Registry (Adobe)"),n("/Ordering ("+s.encoding+")"),n(">>"),n(">>"),n("endobj"),s.objectNumber=r(),n("<<"),n("/Type /Font"),n("/Subtype /Type0"),n("/ToUnicode "+h+" 0 R"),n("/BaseFont /"+Lb(s.fontName)),n("/Encoding /"+s.encoding),n("/DescendantFonts ["+m+" 0 R]"),n(">>"),n("endobj"),s.isAlreadyPutted=!0}}(t)}]),t.events.push(["putFont",function(t){!function(t){var s=t.font,n=t.out,r=t.newObject,a=t.putStream;if(s.metadata instanceof e.API.TTFFont&&"WinAnsiEncoding"===s.encoding){for(var o=s.metadata.rawData,l="",c=0;c<o.length;c++)l+=String.fromCharCode(o[c]);var d=r();a({data:l,addLength1:!0,objectId:d}),n("endobj");var u=r();a({data:i(s.metadata.toUnicode),addLength1:!0,objectId:u}),n("endobj");var h=r();n("<<"),n("/Descent "+s.metadata.decender),n("/CapHeight "+s.metadata.capHeight),n("/StemV "+s.metadata.stemV),n("/Type /FontDescriptor"),n("/FontFile2 "+d+" 0 R"),n("/Flags 96"),n("/FontBBox "+e.API.PDFObject.convert(s.metadata.bbox)),n("/FontName /"+Lb(s.fontName)),n("/ItalicAngle "+s.metadata.italicAngle),n("/Ascent "+s.metadata.ascender),n(">>"),n("endobj"),s.objectNumber=r();for(var f=0;f<s.metadata.hmtx.widths.length;f++)s.metadata.hmtx.widths[f]=parseInt(s.metadata.hmtx.widths[f]*(1e3/s.metadata.head.unitsPerEm));n("<</Subtype/TrueType/Type/Font/ToUnicode "+u+" 0 R/BaseFont/"+Lb(s.fontName)+"/FontDescriptor "+h+" 0 R/Encoding/"+s.encoding+" /FirstChar 29 /LastChar 255 /Widths "+e.API.PDFObject.convert(s.metadata.hmtx.widths)+">>"),n("endobj"),s.isAlreadyPutted=!0}}(t)}]);var n=function(e){var t,i=e.text||"",n=e.x,r=e.y,a=e.options||{},o=e.mutex||{},l=o.pdfEscape,c=o.activeFontKey,d=o.fonts,u=c,h="",f=0,m="",p=d[u].encoding;if("Identity-H"!==d[u].encoding)return{text:i,x:n,y:r,options:a,mutex:o};for(m=i,u=c,Array.isArray(i)&&(m=i[0]),f=0;f<m.length;f+=1)d[u].metadata.hasOwnProperty("cmap")&&(t=d[u].metadata.cmap.unicode.codeMap[m[f].charCodeAt(0)]),t||m[f].charCodeAt(0)<256&&d[u].metadata.hasOwnProperty("Unicode")?h+=m[f]:h+="";var g="";return parseInt(u.slice(1))<14||"WinAnsiEncoding"===p?g=l(h,u).split("").map(function(e){return e.charCodeAt(0).toString(16)}).join(""):"Identity-H"===p&&(g=s(h,d[u])),o.isHex=!0,{text:g,x:n,y:r,options:a,mutex:o}};t.events.push(["postProcessText",function(e){var t=e.text||"",s=[],i={text:t,x:e.x,y:e.y,options:e.options,mutex:e.mutex};if(Array.isArray(t)){var r=0;for(r=0;r<t.length;r+=1)Array.isArray(t[r])&&3===t[r].length?s.push([n(Object.assign({},i,{text:t[r][0]})).text,t[r][1],t[r][2]]):s.push(n(Object.assign({},i,{text:t[r]})).text);e.text=s}else e.text=n(Object.assign({},i,{text:t})).text}])}(Fb),
/**
 * @license
 * jsPDF virtual FileSystem functionality
 *
 * Licensed under the MIT License.
 * http://opensource.org/licenses/mit-license
 */
function(e){var t=function(){return void 0===this.internal.vFS&&(this.internal.vFS={}),!0};e.existsFileInVFS=function(e){return t.call(this),void 0!==this.internal.vFS[e]},e.addFileToVFS=function(e,s){return t.call(this),this.internal.vFS[e]=s,this},e.getFileFromVFS=function(e){return t.call(this),void 0!==this.internal.vFS[e]?this.internal.vFS[e]:null}}(Fb.API),
/**
 * @license
 * Unicode Bidi Engine based on the work of Alex Shensis (@asthensis)
 * MIT License
 */
function(e){e.__bidiEngine__=e.prototype.__bidiEngine__=function(e){var s,i,n,r,a,o,l,c=t,d=[[0,3,0,1,0,0,0],[0,3,0,1,2,2,0],[0,3,0,17,2,0,1],[0,3,5,5,4,1,0],[0,3,21,21,4,0,1],[0,3,5,5,4,2,0]],u=[[2,0,1,1,0,1,0],[2,0,1,1,0,2,0],[2,0,2,1,3,2,0],[2,0,2,33,3,1,1]],h={L:0,R:1,EN:2,AN:3,N:4,B:5,S:6},f={0:0,5:1,6:2,7:3,32:4,251:5,254:6,255:7},m=["(",")","(","<",">","<","[","]","[","{","}","{","«","»","«","‹","›","‹","⁅","⁆","⁅","⁽","⁾","⁽","₍","₎","₍","≤","≥","≤","〈","〉","〈","﹙","﹚","﹙","﹛","﹜","﹛","﹝","﹞","﹝","﹤","﹥","﹤"],p=new RegExp(/^([1-4|9]|1[0-9]|2[0-9]|3[0168]|4[04589]|5[012]|7[78]|159|16[0-9]|17[0-2]|21[569]|22[03489]|250)$/),g=!1,v=0;this.__bidiEngine__={};var y=function(e){var t=e.charCodeAt(),s=t>>8,i=f[s];return void 0!==i?c[256*i+(255&t)]:252===s||253===s?"AL":p.test(s)?"L":8===s?"R":"N"},b=function(e){for(var t,s=0;s<e.length;s++){if("L"===(t=y(e.charAt(s))))return!1;if("R"===t)return!0}return!1},x=function(e,t,a,o){var l,c,d,u,h=t[o];switch(h){case"L":case"R":case"LRE":case"RLE":case"LRO":case"RLO":case"PDF":g=!1;break;case"N":case"AN":break;case"EN":g&&(h="AN");break;case"AL":g=!0,h="R";break;case"WS":case"BN":h="N";break;case"CS":o<1||o+1>=t.length||"EN"!==(l=a[o-1])&&"AN"!==l||"EN"!==(c=t[o+1])&&"AN"!==c?h="N":g&&(c="AN"),h=c===l?c:"N";break;case"ES":h="EN"===(l=o>0?a[o-1]:"B")&&o+1<t.length&&"EN"===t[o+1]?"EN":"N";break;case"ET":if(o>0&&"EN"===a[o-1]){h="EN";break}if(g){h="N";break}for(d=o+1,u=t.length;d<u&&"ET"===t[d];)d++;h=d<u&&"EN"===t[d]?"EN":"N";break;case"NSM":if(n&&!r){for(u=t.length,d=o+1;d<u&&"NSM"===t[d];)d++;if(d<u){var f=e[o],m=f>=1425&&f<=2303||64286===f;if(l=t[d],m&&("R"===l||"AL"===l)){h="R";break}}}h=o<1||"B"===(l=t[o-1])?"N":a[o-1];break;case"B":g=!1,s=!0,h=v;break;case"S":i=!0,h="N"}return h},w=function(e,t,s){var i=e.split("");return s&&S(i,s,{hiLevel:v}),i.reverse(),t&&t.reverse(),i.join("")},S=function(e,t,n){var r,a,o,l,c,f=-1,m=e.length,p=0,b=[],w=v?u:d,S=[];for(g=!1,s=!1,i=!1,a=0;a<m;a++)S[a]=y(e[a]);for(o=0;o<m;o++){if(c=p,b[o]=x(e,S,b,o),r=240&(p=w[c][h[b[o]]]),p&=15,t[o]=l=w[p][5],r>0)if(16===r){for(a=f;a<o;a++)t[a]=1;f=-1}else f=-1;if(w[p][6])-1===f&&(f=o);else if(f>-1){for(a=f;a<o;a++)t[a]=l;f=-1}"B"===S[o]&&(t[o]=0),n.hiLevel|=l}i&&function(e,t,s){for(var i=0;i<s;i++)if("S"===e[i]){t[i]=v;for(var n=i-1;n>=0&&"WS"===e[n];n--)t[n]=v}}(S,t,m)},k=function(e,t,i,n,r){if(!(r.hiLevel<e)){if(1===e&&1===v&&!s)return t.reverse(),void(i&&i.reverse());for(var a,o,l,c,d=t.length,u=0;u<d;){if(n[u]>=e){for(l=u+1;l<d&&n[l]>=e;)l++;for(c=u,o=l-1;c<o;c++,o--)a=t[c],t[c]=t[o],t[o]=a,i&&(a=i[c],i[c]=i[o],i[o]=a);u=l}u++}}},_=function(e,t,s){var i=e.split(""),n={hiLevel:v};return s||(s=[]),S(i,s,n),function(e,t,s){if(0!==s.hiLevel&&l)for(var i,n=0;n<e.length;n++)1===t[n]&&(i=m.indexOf(e[n]))>=0&&(e[n]=m[i+1])}(i,s,n),k(2,i,t,s,n),k(1,i,t,s,n),i.join("")};return this.__bidiEngine__.doBidiReorder=function(e,t,s){if(function(e,t){if(t)for(var s=0;s<e.length;s++)t[s]=s;void 0===r&&(r=b(e)),void 0===o&&(o=b(e))}(e,t),n||!a||o)if(n&&a&&r^o)v=r?1:0,e=w(e,t,s);else if(!n&&a&&o)v=r?1:0,e=_(e,t,s),e=w(e,t);else if(!n||r||a||o){if(n&&!a&&r^o)e=w(e,t),r?(v=0,e=_(e,t,s)):(v=1,e=_(e,t,s),e=w(e,t));else if(n&&r&&!a&&o)v=1,e=_(e,t,s),e=w(e,t);else if(!n&&!a&&r^o){var i=l;r?(v=1,e=_(e,t,s),v=0,l=!1,e=_(e,t,s),l=i):(v=0,e=_(e,t,s),e=w(e,t),v=1,l=!1,e=_(e,t,s),l=i,e=w(e,t))}}else v=0,e=_(e,t,s);else v=r?1:0,e=_(e,t,s);return e},this.__bidiEngine__.setOptions=function(e){e&&(n=e.isInputVisual,a=e.isOutputVisual,r=e.isInputRtl,o=e.isOutputRtl,l=e.isSymmetricSwapping)},this.__bidiEngine__.setOptions(e),this.__bidiEngine__};var t=["BN","BN","BN","BN","BN","BN","BN","BN","BN","S","B","S","WS","B","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","B","B","B","S","WS","N","N","ET","ET","ET","N","N","N","N","N","ES","CS","ES","CS","CS","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","CS","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","N","BN","BN","BN","BN","BN","BN","B","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","BN","CS","N","ET","ET","ET","ET","N","N","N","N","L","N","N","BN","N","N","ET","ET","EN","EN","N","L","N","N","N","EN","L","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","L","L","L","L","L","L","L","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","L","N","N","N","N","N","ET","N","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","R","NSM","R","NSM","NSM","R","NSM","NSM","R","NSM","N","N","N","N","N","N","N","N","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","N","N","N","N","N","R","R","R","R","R","N","N","N","N","N","N","N","N","N","N","N","AN","AN","AN","AN","AN","AN","N","N","AL","ET","ET","AL","CS","AL","N","N","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AL","AL","N","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AN","AN","AN","AN","AN","AN","AN","AN","AN","AN","ET","AN","AN","AL","AL","AL","NSM","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AN","N","NSM","NSM","NSM","NSM","NSM","NSM","AL","AL","NSM","NSM","N","NSM","NSM","NSM","NSM","AL","AL","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","N","AL","AL","NSM","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","N","N","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","AL","N","N","N","N","N","N","N","N","N","N","N","N","N","N","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","R","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","R","R","N","N","N","N","R","N","N","N","N","N","WS","WS","WS","WS","WS","WS","WS","WS","WS","WS","WS","BN","BN","BN","L","R","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","WS","B","LRE","RLE","PDF","LRO","RLO","CS","ET","ET","ET","ET","ET","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","CS","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","WS","BN","BN","BN","BN","BN","N","LRI","RLI","FSI","PDI","BN","BN","BN","BN","BN","BN","EN","L","N","N","EN","EN","EN","EN","EN","EN","ES","ES","N","N","N","L","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","ES","ES","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","ET","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","L","L","L","L","L","L","L","N","N","N","N","N","N","N","N","N","N","N","N","L","L","L","L","L","N","N","N","N","N","R","NSM","R","R","R","R","R","R","R","R","R","R","ES","R","R","R","R","R","R","R","R","R","R","R","R","R","N","R","R","R","R","R","N","R","N","R","R","N","R","R","N","R","R","R","R","R","R","R","R","R","R","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","NSM","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","CS","N","CS","N","N","CS","N","N","N","N","N","N","N","N","N","ET","N","N","ES","ES","N","N","N","N","N","ET","ET","N","N","N","N","N","AL","AL","AL","AL","AL","N","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","AL","N","N","BN","N","N","N","ET","ET","ET","N","N","N","N","N","ES","CS","ES","CS","CS","EN","EN","EN","EN","EN","EN","EN","EN","EN","EN","CS","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","N","N","N","N","N","N","N","N","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","L","N","N","N","L","L","L","L","L","L","N","N","L","L","L","L","L","L","N","N","L","L","L","L","L","L","N","N","L","L","L","N","N","N","ET","ET","N","N","N","ET","ET","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N","N"],s=new e.__bidiEngine__({isInputVisual:!0});e.API.events.push(["postProcessText",function(e){var t=e.text,i=(e.x,e.y,e.options||{}),n=(e.mutex,i.lang,[]);if(i.isInputVisual="boolean"!=typeof i.isInputVisual||i.isInputVisual,s.setOptions(i),"[object Array]"===Object.prototype.toString.call(t)){var r=0;for(n=[],r=0;r<t.length;r+=1)"[object Array]"===Object.prototype.toString.call(t[r])?n.push([s.doBidiReorder(t[r][0]),t[r][1],t[r][2]]):n.push([s.doBidiReorder(t[r])]);e.text=n}else e.text=s.doBidiReorder(t);s.setOptions({isInputVisual:!0})}])}(Fb),Fb.API.TTFFont=function(){function e(e){var t;if(this.rawData=e,t=this.contents=new rw(e),this.contents.pos=4,"ttcf"===t.readString(4))throw new Error("TTCF not supported.");t.pos=0,this.parse(),this.subset=new _w(this),this.registerTTF()}return e.open=function(t){return new e(t)},e.prototype.parse=function(){return this.directory=new aw(this.contents),this.head=new cw(this),this.name=new gw(this),this.cmap=new uw(this),this.toUnicode={},this.hhea=new hw(this),this.maxp=new vw(this),this.hmtx=new yw(this),this.post=new mw(this),this.os2=new fw(this),this.loca=new kw(this),this.glyf=new xw(this),this.ascender=this.os2.exists&&this.os2.ascender||this.hhea.ascender,this.decender=this.os2.exists&&this.os2.decender||this.hhea.decender,this.lineGap=this.os2.exists&&this.os2.lineGap||this.hhea.lineGap,this.bbox=[this.head.xMin,this.head.yMin,this.head.xMax,this.head.yMax]},e.prototype.registerTTF=function(){var e,t,s,i,n;if(this.scaleFactor=1e3/this.head.unitsPerEm,this.bbox=function(){var t,s,i,n;for(n=[],t=0,s=(i=this.bbox).length;t<s;t++)e=i[t],n.push(Math.round(e*this.scaleFactor));return n}.call(this),this.stemV=0,this.post.exists?(s=255&(i=this.post.italic_angle),!!(32768&(t=i>>16))&&(t=-(1+(65535^t))),this.italicAngle=+(t+"."+s)):this.italicAngle=0,this.ascender=Math.round(this.ascender*this.scaleFactor),this.decender=Math.round(this.decender*this.scaleFactor),this.lineGap=Math.round(this.lineGap*this.scaleFactor),this.capHeight=this.os2.exists&&this.os2.capHeight||this.ascender,this.xHeight=this.os2.exists&&this.os2.xHeight||0,this.familyClass=(this.os2.exists&&this.os2.familyClass||0)>>8,this.isSerif=1===(n=this.familyClass)||2===n||3===n||4===n||5===n||7===n,this.isScript=10===this.familyClass,this.flags=0,this.post.isFixedPitch&&(this.flags|=1),this.isSerif&&(this.flags|=2),this.isScript&&(this.flags|=8),0!==this.italicAngle&&(this.flags|=64),this.flags|=32,!this.cmap.unicode)throw new Error("No unicode cmap for font")},e.prototype.characterToGlyph=function(e){var t;return(null!=(t=this.cmap.unicode)?t.codeMap[e]:void 0)||0},e.prototype.widthOfGlyph=function(e){var t;return t=1e3/this.head.unitsPerEm,this.hmtx.forGlyph(e).advance*t},e.prototype.widthOfString=function(e,t,s){var i,n,r,a;for(r=0,n=0,a=(e=""+e).length;0<=a?n<a:n>a;n=0<=a?++n:--n)i=e.charCodeAt(n),r+=this.widthOfGlyph(this.characterToGlyph(i))+s*(1e3/t)||0;return r*(t/1e3)},e.prototype.lineHeight=function(e,t){var s;return null==t&&(t=!1),s=t?this.lineGap:0,(this.ascender+s-this.decender)/1e3*e},e}();var nw,rw=function(){function e(e){this.data=null!=e?e:[],this.pos=0,this.length=this.data.length}return e.prototype.readByte=function(){return this.data[this.pos++]},e.prototype.writeByte=function(e){return this.data[this.pos++]=e},e.prototype.readUInt32=function(){return 16777216*this.readByte()+(this.readByte()<<16)+(this.readByte()<<8)+this.readByte()},e.prototype.writeUInt32=function(e){return this.writeByte(e>>>24&255),this.writeByte(e>>16&255),this.writeByte(e>>8&255),this.writeByte(255&e)},e.prototype.readInt32=function(){var e;return(e=this.readUInt32())>=2147483648?e-4294967296:e},e.prototype.writeInt32=function(e){return e<0&&(e+=4294967296),this.writeUInt32(e)},e.prototype.readUInt16=function(){return this.readByte()<<8|this.readByte()},e.prototype.writeUInt16=function(e){return this.writeByte(e>>8&255),this.writeByte(255&e)},e.prototype.readInt16=function(){var e;return(e=this.readUInt16())>=32768?e-65536:e},e.prototype.writeInt16=function(e){return e<0&&(e+=65536),this.writeUInt16(e)},e.prototype.readString=function(e){var t,s;for(s=[],t=0;0<=e?t<e:t>e;t=0<=e?++t:--t)s[t]=String.fromCharCode(this.readByte());return s.join("")},e.prototype.writeString=function(e){var t,s,i;for(i=[],t=0,s=e.length;0<=s?t<s:t>s;t=0<=s?++t:--t)i.push(this.writeByte(e.charCodeAt(t)));return i},e.prototype.readShort=function(){return this.readInt16()},e.prototype.writeShort=function(e){return this.writeInt16(e)},e.prototype.readLongLong=function(){var e,t,s,i,n,r,a,o;return e=this.readByte(),t=this.readByte(),s=this.readByte(),i=this.readByte(),n=this.readByte(),r=this.readByte(),a=this.readByte(),o=this.readByte(),128&e?-1*(72057594037927940*(255^e)+281474976710656*(255^t)+1099511627776*(255^s)+4294967296*(255^i)+16777216*(255^n)+65536*(255^r)+256*(255^a)+(255^o)+1):72057594037927940*e+281474976710656*t+1099511627776*s+4294967296*i+16777216*n+65536*r+256*a+o},e.prototype.writeLongLong=function(e){var t,s;return t=Math.floor(e/4294967296),s=4294967295&e,this.writeByte(t>>24&255),this.writeByte(t>>16&255),this.writeByte(t>>8&255),this.writeByte(255&t),this.writeByte(s>>24&255),this.writeByte(s>>16&255),this.writeByte(s>>8&255),this.writeByte(255&s)},e.prototype.readInt=function(){return this.readInt32()},e.prototype.writeInt=function(e){return this.writeInt32(e)},e.prototype.read=function(e){var t,s;for(t=[],s=0;0<=e?s<e:s>e;s=0<=e?++s:--s)t.push(this.readByte());return t},e.prototype.write=function(e){var t,s,i,n;for(n=[],s=0,i=e.length;s<i;s++)t=e[s],n.push(this.writeByte(t));return n},e}(),aw=function(){var e;function t(e){var t,s,i;for(this.scalarType=e.readInt(),this.tableCount=e.readShort(),this.searchRange=e.readShort(),this.entrySelector=e.readShort(),this.rangeShift=e.readShort(),this.tables={},s=0,i=this.tableCount;0<=i?s<i:s>i;s=0<=i?++s:--s)t={tag:e.readString(4),checksum:e.readInt(),offset:e.readInt(),length:e.readInt()},this.tables[t.tag]=t}return t.prototype.encode=function(t){var s,i,n,r,a,o,l,c,d,u,h,f,m;for(m in h=Object.keys(t).length,o=Math.log(2),d=16*Math.floor(Math.log(h)/o),r=Math.floor(d/o),c=16*h-d,(i=new rw).writeInt(this.scalarType),i.writeShort(h),i.writeShort(d),i.writeShort(r),i.writeShort(c),n=16*h,l=i.pos+n,a=null,f=[],t)for(u=t[m],i.writeString(m),i.writeInt(e(u)),i.writeInt(l),i.writeInt(u.length),f=f.concat(u),"head"===m&&(a=l),l+=u.length;l%4;)f.push(0),l++;return i.write(f),s=2981146554-e(i.data),i.pos=a+8,i.writeUInt32(s),i.data},e=function(e){var t,s,i,n;for(e=bw.call(e);e.length%4;)e.push(0);for(i=new rw(e),s=0,t=0,n=e.length;t<n;t=t+=4)s+=i.readUInt32();return 4294967295&s},t}(),ow={}.hasOwnProperty,lw=function(e,t){for(var s in t)ow.call(t,s)&&(e[s]=t[s]);function i(){this.constructor=e}return i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype,e};nw=function(){function e(e){var t;this.file=e,t=this.file.directory.tables[this.tag],this.exists=!!t,t&&(this.offset=t.offset,this.length=t.length,this.parse(this.file.contents))}return e.prototype.parse=function(){},e.prototype.encode=function(){},e.prototype.raw=function(){return this.exists?(this.file.contents.pos=this.offset,this.file.contents.read(this.length)):null},e}();var cw=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return lw(e,nw),e.prototype.tag="head",e.prototype.parse=function(e){return e.pos=this.offset,this.version=e.readInt(),this.revision=e.readInt(),this.checkSumAdjustment=e.readInt(),this.magicNumber=e.readInt(),this.flags=e.readShort(),this.unitsPerEm=e.readShort(),this.created=e.readLongLong(),this.modified=e.readLongLong(),this.xMin=e.readShort(),this.yMin=e.readShort(),this.xMax=e.readShort(),this.yMax=e.readShort(),this.macStyle=e.readShort(),this.lowestRecPPEM=e.readShort(),this.fontDirectionHint=e.readShort(),this.indexToLocFormat=e.readShort(),this.glyphDataFormat=e.readShort()},e.prototype.encode=function(e){var t;return(t=new rw).writeInt(this.version),t.writeInt(this.revision),t.writeInt(this.checkSumAdjustment),t.writeInt(this.magicNumber),t.writeShort(this.flags),t.writeShort(this.unitsPerEm),t.writeLongLong(this.created),t.writeLongLong(this.modified),t.writeShort(this.xMin),t.writeShort(this.yMin),t.writeShort(this.xMax),t.writeShort(this.yMax),t.writeShort(this.macStyle),t.writeShort(this.lowestRecPPEM),t.writeShort(this.fontDirectionHint),t.writeShort(e),t.writeShort(this.glyphDataFormat),t.data},e}(),dw=function(){function e(e,t){var s,i,n,r,a,o,l,c,d,u,h,f,m,p,g,v,y;switch(this.platformID=e.readUInt16(),this.encodingID=e.readShort(),this.offset=t+e.readInt(),d=e.pos,e.pos=this.offset,this.format=e.readUInt16(),this.length=e.readUInt16(),this.language=e.readUInt16(),this.isUnicode=3===this.platformID&&1===this.encodingID&&4===this.format||0===this.platformID&&4===this.format,this.codeMap={},this.format){case 0:for(o=0;o<256;++o)this.codeMap[o]=e.readByte();break;case 4:for(h=e.readUInt16(),u=h/2,e.pos+=6,n=function(){var t,s;for(s=[],o=t=0;0<=u?t<u:t>u;o=0<=u?++t:--t)s.push(e.readUInt16());return s}(),e.pos+=2,m=function(){var t,s;for(s=[],o=t=0;0<=u?t<u:t>u;o=0<=u?++t:--t)s.push(e.readUInt16());return s}(),l=function(){var t,s;for(s=[],o=t=0;0<=u?t<u:t>u;o=0<=u?++t:--t)s.push(e.readUInt16());return s}(),c=function(){var t,s;for(s=[],o=t=0;0<=u?t<u:t>u;o=0<=u?++t:--t)s.push(e.readUInt16());return s}(),i=(this.length-e.pos+this.offset)/2,a=function(){var t,s;for(s=[],o=t=0;0<=i?t<i:t>i;o=0<=i?++t:--t)s.push(e.readUInt16());return s}(),o=g=0,y=n.length;g<y;o=++g)for(p=n[o],s=v=f=m[o];f<=p?v<=p:v>=p;s=f<=p?++v:--v)0===c[o]?r=s+l[o]:0!==(r=a[c[o]/2+(s-f)-(u-o)]||0)&&(r+=l[o]),this.codeMap[s]=65535&r}e.pos=d}return e.encode=function(e,t){var s,i,n,r,a,o,l,c,d,u,h,f,m,p,g,v,y,b,x,w,S,k,_,C,N,T,A,E,j,P,I,L,R,O,D,M,U,F,B,q,$,z,H,V,G,J;switch(E=new rw,r=Object.keys(e).sort(function(e,t){return e-t}),t){case"macroman":for(m=0,p=function(){var e=[];for(f=0;f<256;++f)e.push(0);return e}(),v={0:0},n={},j=0,R=r.length;j<R;j++)null==v[H=e[i=r[j]]]&&(v[H]=++m),n[i]={old:e[i],new:v[e[i]]},p[i]=v[e[i]];return E.writeUInt16(1),E.writeUInt16(0),E.writeUInt32(12),E.writeUInt16(0),E.writeUInt16(262),E.writeUInt16(0),E.write(p),{charMap:n,subtable:E.data,maxGlyphID:m+1};case"unicode":for(T=[],d=[],y=0,v={},s={},g=l=null,P=0,O=r.length;P<O;P++)null==v[x=e[i=r[P]]]&&(v[x]=++y),s[i]={old:x,new:v[x]},a=v[x]-i,null!=g&&a===l||(g&&d.push(g),T.push(i),l=a),g=i;for(g&&d.push(g),d.push(65535),T.push(65535),C=2*(_=T.length),k=2*Math.pow(Math.log(_)/Math.LN2,2),u=Math.log(k/2)/Math.LN2,S=2*_-k,o=[],w=[],h=[],f=I=0,D=T.length;I<D;f=++I){if(N=T[f],c=d[f],65535===N){o.push(0),w.push(0);break}if(N-(A=s[N].new)>=32768)for(o.push(0),w.push(2*(h.length+_-f)),i=L=N;N<=c?L<=c:L>=c;i=N<=c?++L:--L)h.push(s[i].new);else o.push(A-N),w.push(0)}for(E.writeUInt16(3),E.writeUInt16(1),E.writeUInt32(12),E.writeUInt16(4),E.writeUInt16(16+8*_+2*h.length),E.writeUInt16(0),E.writeUInt16(C),E.writeUInt16(k),E.writeUInt16(u),E.writeUInt16(S),$=0,M=d.length;$<M;$++)i=d[$],E.writeUInt16(i);for(E.writeUInt16(0),z=0,U=T.length;z<U;z++)i=T[z],E.writeUInt16(i);for(V=0,F=o.length;V<F;V++)a=o[V],E.writeUInt16(a);for(G=0,B=w.length;G<B;G++)b=w[G],E.writeUInt16(b);for(J=0,q=h.length;J<q;J++)m=h[J],E.writeUInt16(m);return{charMap:s,subtable:E.data,maxGlyphID:y+1}}},e}(),uw=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return lw(e,nw),e.prototype.tag="cmap",e.prototype.parse=function(e){var t,s,i;for(e.pos=this.offset,this.version=e.readUInt16(),i=e.readUInt16(),this.tables=[],this.unicode=null,s=0;0<=i?s<i:s>i;s=0<=i?++s:--s)t=new dw(e,this.offset),this.tables.push(t),t.isUnicode&&null==this.unicode&&(this.unicode=t);return!0},e.encode=function(e,t){var s,i;return null==t&&(t="macroman"),s=dw.encode(e,t),(i=new rw).writeUInt16(0),i.writeUInt16(1),s.table=i.data.concat(s.subtable),s},e}(),hw=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return lw(e,nw),e.prototype.tag="hhea",e.prototype.parse=function(e){return e.pos=this.offset,this.version=e.readInt(),this.ascender=e.readShort(),this.decender=e.readShort(),this.lineGap=e.readShort(),this.advanceWidthMax=e.readShort(),this.minLeftSideBearing=e.readShort(),this.minRightSideBearing=e.readShort(),this.xMaxExtent=e.readShort(),this.caretSlopeRise=e.readShort(),this.caretSlopeRun=e.readShort(),this.caretOffset=e.readShort(),e.pos+=8,this.metricDataFormat=e.readShort(),this.numberOfMetrics=e.readUInt16()},e}(),fw=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return lw(e,nw),e.prototype.tag="OS/2",e.prototype.parse=function(e){if(e.pos=this.offset,this.version=e.readUInt16(),this.averageCharWidth=e.readShort(),this.weightClass=e.readUInt16(),this.widthClass=e.readUInt16(),this.type=e.readShort(),this.ySubscriptXSize=e.readShort(),this.ySubscriptYSize=e.readShort(),this.ySubscriptXOffset=e.readShort(),this.ySubscriptYOffset=e.readShort(),this.ySuperscriptXSize=e.readShort(),this.ySuperscriptYSize=e.readShort(),this.ySuperscriptXOffset=e.readShort(),this.ySuperscriptYOffset=e.readShort(),this.yStrikeoutSize=e.readShort(),this.yStrikeoutPosition=e.readShort(),this.familyClass=e.readShort(),this.panose=function(){var t,s;for(s=[],t=0;t<10;++t)s.push(e.readByte());return s}(),this.charRange=function(){var t,s;for(s=[],t=0;t<4;++t)s.push(e.readInt());return s}(),this.vendorID=e.readString(4),this.selection=e.readShort(),this.firstCharIndex=e.readShort(),this.lastCharIndex=e.readShort(),this.version>0&&(this.ascent=e.readShort(),this.descent=e.readShort(),this.lineGap=e.readShort(),this.winAscent=e.readShort(),this.winDescent=e.readShort(),this.codePageRange=function(){var t,s;for(s=[],t=0;t<2;t=++t)s.push(e.readInt());return s}(),this.version>1))return this.xHeight=e.readShort(),this.capHeight=e.readShort(),this.defaultChar=e.readShort(),this.breakChar=e.readShort(),this.maxContext=e.readShort()},e}(),mw=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return lw(e,nw),e.prototype.tag="post",e.prototype.parse=function(e){var t,s,i;switch(e.pos=this.offset,this.format=e.readInt(),this.italicAngle=e.readInt(),this.underlinePosition=e.readShort(),this.underlineThickness=e.readShort(),this.isFixedPitch=e.readInt(),this.minMemType42=e.readInt(),this.maxMemType42=e.readInt(),this.minMemType1=e.readInt(),this.maxMemType1=e.readInt(),this.format){case 65536:case 196608:break;case 131072:var n;for(s=e.readUInt16(),this.glyphNameIndex=[],n=0;0<=s?n<s:n>s;n=0<=s?++n:--n)this.glyphNameIndex.push(e.readUInt16());for(this.names=[],i=[];e.pos<this.offset+this.length;)t=e.readByte(),i.push(this.names.push(e.readString(t)));return i;case 151552:return s=e.readUInt16(),this.offsets=e.read(s);case 262144:return this.map=function(){var t,s,i;for(i=[],n=t=0,s=this.file.maxp.numGlyphs;0<=s?t<s:t>s;n=0<=s?++t:--t)i.push(e.readUInt32());return i}.call(this)}},e}(),pw=function(e,t){this.raw=e,this.length=e.length,this.platformID=t.platformID,this.encodingID=t.encodingID,this.languageID=t.languageID},gw=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return lw(e,nw),e.prototype.tag="name",e.prototype.parse=function(e){var t,s,i,n,r,a,o,l,c,d,u;for(e.pos=this.offset,e.readShort(),t=e.readShort(),a=e.readShort(),s=[],n=0;0<=t?n<t:n>t;n=0<=t?++n:--n)s.push({platformID:e.readShort(),encodingID:e.readShort(),languageID:e.readShort(),nameID:e.readShort(),length:e.readShort(),offset:this.offset+a+e.readShort()});for(o={},n=c=0,d=s.length;c<d;n=++c)i=s[n],e.pos=i.offset,l=e.readString(i.length),r=new pw(l,i),null==o[u=i.nameID]&&(o[u]=[]),o[i.nameID].push(r);this.strings=o,this.copyright=o[0],this.fontFamily=o[1],this.fontSubfamily=o[2],this.uniqueSubfamily=o[3],this.fontName=o[4],this.version=o[5];try{this.postscriptName=o[6][0].raw.replace(/[\x00-\x19\x80-\xff]/g,"")}catch(h){this.postscriptName=o[4][0].raw.replace(/[\x00-\x19\x80-\xff]/g,"")}return this.trademark=o[7],this.manufacturer=o[8],this.designer=o[9],this.description=o[10],this.vendorUrl=o[11],this.designerUrl=o[12],this.license=o[13],this.licenseUrl=o[14],this.preferredFamily=o[15],this.preferredSubfamily=o[17],this.compatibleFull=o[18],this.sampleText=o[19]},e}(),vw=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return lw(e,nw),e.prototype.tag="maxp",e.prototype.parse=function(e){return e.pos=this.offset,this.version=e.readInt(),this.numGlyphs=e.readUInt16(),this.maxPoints=e.readUInt16(),this.maxContours=e.readUInt16(),this.maxCompositePoints=e.readUInt16(),this.maxComponentContours=e.readUInt16(),this.maxZones=e.readUInt16(),this.maxTwilightPoints=e.readUInt16(),this.maxStorage=e.readUInt16(),this.maxFunctionDefs=e.readUInt16(),this.maxInstructionDefs=e.readUInt16(),this.maxStackElements=e.readUInt16(),this.maxSizeOfInstructions=e.readUInt16(),this.maxComponentElements=e.readUInt16(),this.maxComponentDepth=e.readUInt16()},e}(),yw=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return lw(e,nw),e.prototype.tag="hmtx",e.prototype.parse=function(e){var t,s,i,n,r,a,o;for(e.pos=this.offset,this.metrics=[],t=0,a=this.file.hhea.numberOfMetrics;0<=a?t<a:t>a;t=0<=a?++t:--t)this.metrics.push({advance:e.readUInt16(),lsb:e.readInt16()});for(i=this.file.maxp.numGlyphs-this.file.hhea.numberOfMetrics,this.leftSideBearings=function(){var s,n;for(n=[],t=s=0;0<=i?s<i:s>i;t=0<=i?++s:--s)n.push(e.readInt16());return n}(),this.widths=function(){var e,t,s,i;for(i=[],e=0,t=(s=this.metrics).length;e<t;e++)n=s[e],i.push(n.advance);return i}.call(this),s=this.widths[this.widths.length-1],o=[],t=r=0;0<=i?r<i:r>i;t=0<=i?++r:--r)o.push(this.widths.push(s));return o},e.prototype.forGlyph=function(e){return e in this.metrics?this.metrics[e]:{advance:this.metrics[this.metrics.length-1].advance,lsb:this.leftSideBearings[e-this.metrics.length]}},e}(),bw=[].slice,xw=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return lw(e,nw),e.prototype.tag="glyf",e.prototype.parse=function(){return this.cache={}},e.prototype.glyphFor=function(e){var t,s,i,n,r,a,o,l,c,d;return e in this.cache?this.cache[e]:(n=this.file.loca,t=this.file.contents,s=n.indexOf(e),0===(i=n.lengthOf(e))?this.cache[e]=null:(t.pos=this.offset+s,r=(a=new rw(t.read(i))).readShort(),l=a.readShort(),d=a.readShort(),o=a.readShort(),c=a.readShort(),this.cache[e]=-1===r?new Sw(a,l,d,o,c):new ww(a,r,l,d,o,c),this.cache[e]))},e.prototype.encode=function(e,t,s){var i,n,r,a,o;for(r=[],n=[],a=0,o=t.length;a<o;a++)i=e[t[a]],n.push(r.length),i&&(r=r.concat(i.encode(s)));return n.push(r.length),{table:r,offsets:n}},e}(),ww=function(){function e(e,t,s,i,n,r){this.raw=e,this.numberOfContours=t,this.xMin=s,this.yMin=i,this.xMax=n,this.yMax=r,this.compound=!1}return e.prototype.encode=function(){return this.raw.data},e}(),Sw=function(){function e(e,t,s,i,n){var r,a;for(this.raw=e,this.xMin=t,this.yMin=s,this.xMax=i,this.yMax=n,this.compound=!0,this.glyphIDs=[],this.glyphOffsets=[],r=this.raw;a=r.readShort(),this.glyphOffsets.push(r.pos),this.glyphIDs.push(r.readUInt16()),32&a;)r.pos+=1&a?4:2,128&a?r.pos+=8:64&a?r.pos+=4:8&a&&(r.pos+=2)}return e.prototype.encode=function(){var e,t,s;for(t=new rw(bw.call(this.raw.data)),e=0,s=this.glyphIDs.length;e<s;++e)t.pos=this.glyphOffsets[e];return t.data},e}(),kw=function(){function e(){return e.__super__.constructor.apply(this,arguments)}return lw(e,nw),e.prototype.tag="loca",e.prototype.parse=function(e){var t,s;return e.pos=this.offset,t=this.file.head.indexToLocFormat,this.offsets=0===t?function(){var t,i;for(i=[],s=0,t=this.length;s<t;s+=2)i.push(2*e.readUInt16());return i}.call(this):function(){var t,i;for(i=[],s=0,t=this.length;s<t;s+=4)i.push(e.readUInt32());return i}.call(this)},e.prototype.indexOf=function(e){return this.offsets[e]},e.prototype.lengthOf=function(e){return this.offsets[e+1]-this.offsets[e]},e.prototype.encode=function(e,t){for(var s=new Uint32Array(this.offsets.length),i=0,n=0,r=0;r<s.length;++r)if(s[r]=i,n<t.length&&t[n]==r){++n,s[r]=i;var a=this.offsets[r],o=this.offsets[r+1]-a;o>0&&(i+=o)}for(var l=new Array(4*s.length),c=0;c<s.length;++c)l[4*c+3]=255&s[c],l[4*c+2]=(65280&s[c])>>8,l[4*c+1]=(16711680&s[c])>>16,l[4*c]=(4278190080&s[c])>>24;return l},e}(),_w=function(){function e(e){this.font=e,this.subset={},this.unicodes={},this.next=33}return e.prototype.generateCmap=function(){var e,t,s,i,n;for(t in i=this.font.cmap.tables[0].codeMap,e={},n=this.subset)s=n[t],e[t]=i[s];return e},e.prototype.glyphsFor=function(e){var t,s,i,n,r,a,o;for(i={},r=0,a=e.length;r<a;r++)i[n=e[r]]=this.font.glyf.glyphFor(n);for(n in t=[],i)(null!=(s=i[n])?s.compound:void 0)&&t.push.apply(t,s.glyphIDs);if(t.length>0)for(n in o=this.glyphsFor(t))s=o[n],i[n]=s;return i},e.prototype.encode=function(e,t){var s,i,n,r,a,o,l,c,d,u,h,f,m,p,g;for(i in s=uw.encode(this.generateCmap(),"unicode"),r=this.glyphsFor(e),h={0:0},g=s.charMap)h[(o=g[i]).old]=o.new;for(f in u=s.maxGlyphID,r)f in h||(h[f]=u++);return c=function(e){var t,s;for(t in s={},e)s[e[t]]=t;return s}(h),d=Object.keys(c).sort(function(e,t){return e-t}),m=function(){var e,t,s;for(s=[],e=0,t=d.length;e<t;e++)a=d[e],s.push(c[a]);return s}(),n=this.font.glyf.encode(r,m,h),l=this.font.loca.encode(n.offsets,m),p={cmap:this.font.cmap.raw(),glyf:n.table,loca:l,hmtx:this.font.hmtx.raw(),hhea:this.font.hhea.raw(),maxp:this.font.maxp.raw(),post:this.font.post.raw(),name:this.font.name.raw(),head:this.font.head.encode(t)},this.font.os2.exists&&(p["OS/2"]=this.font.os2.raw()),this.font.directory.encode(p)},e}();Fb.API.PDFObject=function(){var e;function t(){}return e=function(e,t){return(Array(t+1).join("0")+e).slice(-t)},t.convert=function(s){var i,n,r,a;if(Array.isArray(s))return"["+function(){var e,n,r;for(r=[],e=0,n=s.length;e<n;e++)i=s[e],r.push(t.convert(i));return r}().join(" ")+"]";if("string"==typeof s)return"/"+s;if(null!=s?s.isString:void 0)return"("+s+")";if(s instanceof Date)return"(D:"+e(s.getUTCFullYear(),4)+e(s.getUTCMonth(),2)+e(s.getUTCDate(),2)+e(s.getUTCHours(),2)+e(s.getUTCMinutes(),2)+e(s.getUTCSeconds(),2)+"Z)";if("[object Object]"==={}.toString.call(s)){for(n in r=["<<"],s)a=s[n],r.push("/"+n+" "+t.convert(a));return r.push(">>"),r.join("\n")}return""+s},t}();const Cw=({chat:e,isOpen:t,onClose:s,onEndChat:i})=>{var n,r,a,o,l,c,d,u,h,f,m,g,y,b,x,w,S,k,_,C,N,T,A,E,j,P,I,L,R,O,D,M,U,B;const[q,$]=v.useState(null),[z,H]=v.useState(!1),[V,G]=v.useState(null);v.useEffect(()=>{t&&(null==e?void 0:e.chat_id)&&J()},[t,null==e?void 0:e.chat_id]);const J=()=>p(void 0,null,function*(){if(null==e?void 0:e.chat_id){H(!0),G(null);try{const t=yield zl.getChatById(e.chat_id);$(t)}catch(t){G("Failed to load full transcript. Using available data."),$(e)}finally{H(!1)}}});if(!t)return null;const W=q||e,K=(e,t)=>{if(!t)return"Ongoing";const s=t-e;if(s<60)return`${s}s`;if(s<3600){return`${Math.floor(s/60)}m ${s%60}s`}return`${Math.floor(s/3600)}h ${Math.floor(s%3600/60)}m`},Y=e=>{const t=new Date(1e3*e);return{date:t.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),time:t.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",second:"2-digit",hour12:!0})}},{date:X,time:Q}=Y(W.start_timestamp),Z=(null==(r=null==(n=W.chat_analysis)?void 0:n.custom_analysis_data)?void 0:r.phone_number)||(null==(o=null==(a=W.chat_analysis)?void 0:a.custom_analysis_data)?void 0:o.customer_phone_number)||(null==(c=null==(l=W.chat_analysis)?void 0:l.custom_analysis_data)?void 0:c.phone)||(null==(u=null==(d=W.chat_analysis)?void 0:d.custom_analysis_data)?void 0:u.contact_number)||(null==(h=W.metadata)?void 0:h.phone_number)||(null==(f=W.metadata)?void 0:f.customer_phone_number)||(null==(m=W.metadata)?void 0:m.from_phone_number)||(null==(g=W.metadata)?void 0:g.to_phone_number)||(null==(y=W.collected_dynamic_variables)?void 0:y.phone_number)||(null==(b=W.collected_dynamic_variables)?void 0:b.customer_phone_number)||"Unknown Number",ee=(null==(w=null==(x=W.chat_analysis)?void 0:x.custom_analysis_data)?void 0:w.patient_name)||(null==(k=null==(S=W.chat_analysis)?void 0:S.custom_analysis_data)?void 0:k.customer_name)||(null==(C=null==(_=W.chat_analysis)?void 0:_.custom_analysis_data)?void 0:C.caller_name)||(null==(T=null==(N=W.chat_analysis)?void 0:N.custom_analysis_data)?void 0:T.name)||(null==(A=W.metadata)?void 0:A.patient_name)||(null==(E=W.metadata)?void 0:E.customer_name)||(null==(j=W.metadata)?void 0:j.caller_name)||(null==(P=W.metadata)?void 0:P.name)||(null==(I=W.collected_dynamic_variables)?void 0:I.patient_name)||(null==(L=W.collected_dynamic_variables)?void 0:L.customer_name)||(null==(R=W.collected_dynamic_variables)?void 0:R.name)||null||"Caller";return F.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:F.jsxs("div",{className:"bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-hidden",children:[F.jsxs("div",{className:"flex items-center justify-between p-6 border-b border-gray-200",children:[F.jsxs("div",{className:"flex items-center gap-4",children:[F.jsx("div",{className:"w-12 h-12 rounded-full flex items-center justify-center "+("ongoing"===W.chat_status?"bg-blue-100":"ended"===W.chat_status?"bg-green-100":"bg-red-100"),children:"ongoing"===W.chat_status?F.jsx(yo,{className:"w-6 h-6 text-blue-600"}):"ended"===W.chat_status?F.jsx(Vo,{className:"w-6 h-6 text-green-600"}):F.jsx(Co,{className:"w-6 h-6 text-red-600"})}),F.jsxs("div",{children:[F.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:ee}),F.jsxs("div",{className:"text-sm text-gray-600 mb-2",children:[F.jsx(el,{className:"w-4 h-4 inline mr-1"}),Z]}),F.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600",children:[F.jsxs("span",{children:["Chat ID: ",W.chat_id]}),F.jsxs("span",{className:"flex items-center gap-1",children:[F.jsx(bo,{className:"w-4 h-4"}),X," at ",Q]}),z&&F.jsxs("span",{className:"flex items-center gap-1 text-blue-600",children:[F.jsx(nl,{className:"w-3 h-3 animate-spin"}),"Loading full transcript..."]})]})]})]}),F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsxs("button",{onClick:J,disabled:z,className:"flex items-center gap-2 px-3 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50",title:"Refresh full transcript",children:[F.jsx(nl,{className:"w-4 h-4 "+(z?"animate-spin":"")}),"Refresh"]}),F.jsx("button",{onClick:s,className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:F.jsx(_l,{className:"w-5 h-5 text-gray-500"})})]})]}),F.jsx("div",{className:"overflow-y-auto max-h-[calc(90vh-140px)]",children:F.jsxs("div",{className:"p-6 space-y-6",children:[F.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(Eo,{className:"w-4 h-4 text-blue-600"}),F.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Duration"})]}),F.jsx("div",{className:"text-2xl font-bold text-blue-600",children:K(W.start_timestamp,W.end_timestamp)})]}),F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(yl,{className:"w-4 h-4 text-green-600"}),F.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Status"})]}),F.jsx("div",{className:"flex items-center gap-2",children:F.jsxs("span",{className:`inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm font-medium ${(e=>{switch(e){case"ended":return"text-green-600 bg-green-50";case"ongoing":return"text-blue-600 bg-blue-50";case"error":return"text-red-600 bg-red-50";default:return"text-gray-600 bg-gray-50"}})(W.chat_status)}`,children:[(e=>{switch(e){case"ended":return F.jsx(No,{className:"w-4 h-4"});case"ongoing":return F.jsx(To,{className:"w-4 h-4"});case"error":return F.jsx(Co,{className:"w-4 h-4"});default:return F.jsx(Eo,{className:"w-4 h-4"})}})(W.chat_status),W.chat_status]})})]}),F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(Go,{className:"w-4 h-4 text-purple-600"}),F.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Messages"})]}),F.jsx("div",{className:"text-2xl font-bold text-purple-600",children:(null==(O=W.message_with_tool_calls)?void 0:O.length)||0})]}),F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(Po,{className:"w-4 h-4 text-orange-600"}),F.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Cost"})]}),F.jsxs("div",{className:"text-2xl font-bold text-orange-600",children:["$",((null==(D=W.chat_cost)?void 0:D.total_cost)||0).toFixed(3)]})]})]}),F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Chat Information"}),F.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[F.jsxs("div",{children:[F.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Caller Name"}),F.jsx("p",{className:"text-gray-900",children:ee})]}),F.jsxs("div",{children:[F.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Phone Number"}),F.jsx("p",{className:"text-gray-900",children:Z})]}),F.jsxs("div",{children:[F.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Agent ID"}),F.jsx("p",{className:"text-gray-900",children:W.agent_id})]}),F.jsxs("div",{children:[F.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Success Status"}),F.jsx("p",{className:"font-medium "+((null==(M=W.chat_analysis)?void 0:M.chat_successful)?"text-green-600":"text-red-600"),children:(null==(U=W.chat_analysis)?void 0:U.chat_successful)?"Successful":"Unsuccessful"})]})]})]}),W.chat_analysis&&F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Post Chat Analysis"}),F.jsxs("div",{className:"space-y-4",children:[F.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[F.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(No,{className:"w-5 h-5 text-green-600"}),F.jsx("span",{className:"text-sm font-medium text-gray-900",children:"Chat Success"})]}),F.jsx("div",{className:"text-lg font-semibold "+(W.chat_analysis.chat_successful?"text-green-600":"text-red-600"),children:W.chat_analysis.chat_successful?"Successful":"Unsuccessful"})]}),W.chat_analysis.user_sentiment&&F.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(yl,{className:"w-5 h-5 text-purple-600"}),F.jsx("span",{className:"text-sm font-medium text-gray-900",children:"User Sentiment"})]}),F.jsx("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium border ${(e=>{switch(e){case"positive":return"text-green-600 bg-green-50 border-green-200";case"negative":return"text-red-600 bg-red-50 border-red-200";case"neutral":return"text-yellow-600 bg-yellow-50 border-yellow-200";default:return"text-gray-600 bg-gray-50 border-gray-200"}})(W.chat_analysis.user_sentiment)}`,children:W.chat_analysis.user_sentiment})]})]}),W.chat_analysis.chat_summary&&F.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[F.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-2",children:"Conversation Summary"}),F.jsx("p",{className:"text-gray-700 leading-relaxed",children:W.chat_analysis.chat_summary})]}),W.chat_analysis.custom_analysis_data&&Object.keys(W.chat_analysis.custom_analysis_data).length>0&&F.jsxs("div",{className:"bg-white rounded-lg p-4 border",children:[F.jsx("h4",{className:"text-md font-semibold text-gray-900 mb-3",children:"Detailed Analysis"}),F.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:Object.entries(W.chat_analysis.custom_analysis_data).map(([e,t])=>F.jsxs("div",{className:"border-l-4 border-blue-500 pl-3",children:[F.jsx("label",{className:"text-sm font-medium text-gray-700 capitalize",children:e.replace(/_/g," ").replace(/([A-Z])/g," $1").trim()}),F.jsx("p",{className:"text-gray-900 text-sm mt-1",children:"object"==typeof t?JSON.stringify(t,null,2):String(t)})]},e))})]})]})]}),W.collected_dynamic_variables&&Object.keys(W.collected_dynamic_variables).length>0&&F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Collected Information"}),F.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:Object.entries(W.collected_dynamic_variables).map(([e,t])=>F.jsxs("div",{children:[F.jsx("label",{className:"text-sm font-medium text-gray-700 capitalize",children:e.replace(/_/g," ")}),F.jsx("p",{className:"text-gray-900",children:String(t)})]},e))})]}),W.message_with_tool_calls&&W.message_with_tool_calls.length>0&&F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Message Thread"}),F.jsx("div",{className:"bg-white rounded border p-4 max-h-64 overflow-y-auto",children:F.jsx("div",{className:"space-y-3",children:W.message_with_tool_calls.map((e,t)=>F.jsxs("div",{className:"flex items-start gap-3",children:[F.jsx("div",{className:"flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center "+("agent"===e.role?"bg-blue-100":"bg-green-100"),children:"agent"===e.role?F.jsx(yo,{className:"w-4 h-4 text-blue-600"}):F.jsx(Sl,{className:"w-4 h-4 text-green-600"})}),F.jsxs("div",{className:"flex-1",children:[F.jsx("div",{className:"text-xs font-medium mb-1 "+("agent"===e.role?"text-blue-700":"text-green-700"),children:"agent"===e.role?"AI Assistant":"Patient"}),F.jsx("p",{className:"text-gray-800 leading-relaxed",children:e.content}),e.tool_calls&&e.tool_calls.length>0&&F.jsxs("div",{className:"mt-2 p-2 bg-gray-100 rounded text-xs",children:[F.jsx("span",{className:"font-medium",children:"Tool calls:"}),e.tool_calls.map((e,t)=>{var s;return F.jsx("div",{className:"ml-2",children:(null==(s=e.function)?void 0:s.name)||e.type},t)})]})]})]},e.message_id||t))})})]}),W.chat_cost&&W.chat_cost.product_costs&&F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-3",children:"Cost Breakdown"}),F.jsxs("div",{className:"space-y-2",children:[Object.entries(W.chat_cost.product_costs).map(([e,t])=>F.jsxs("div",{className:"flex justify-between items-center",children:[F.jsx("span",{className:"text-sm text-gray-700 capitalize",children:e.replace(/_/g," ")}),F.jsxs("span",{className:"text-sm font-medium text-gray-900",children:["$",("number"==typeof t?t:0).toFixed(3)]})]},e)),F.jsxs("div",{className:"border-t pt-2 flex justify-between items-center font-medium",children:[F.jsx("span",{className:"text-gray-900",children:"Total"}),F.jsxs("span",{className:"text-gray-900",children:["$",((null==(B=W.chat_cost)?void 0:B.total_cost)||0).toFixed(3)]})]})]})]}),F.jsxs("div",{className:"flex flex-wrap gap-3 pt-4 border-t border-gray-200",children:[F.jsxs("button",{onClick:()=>{var e,t;const s=new Fb;let i=20;const n=s.internal.pageSize.width,r=20,a=n-40,o=(e,t,i,n,r=12)=>{s.setFontSize(r);const a=s.splitTextToSize(e,n);return s.text(a,t,i),i+6*a.length},l=(e,t=20)=>e+t>s.internal.pageSize.height-20?(s.addPage(),20):e;try{s.setFontSize(18),s.setFont("helvetica","bold"),s.text("Chat Analysis Report",r,i),i+=15,s.setFontSize(14),s.setFont("helvetica","bold"),s.text("Chat Information",r,i),i+=10,s.setFontSize(11),s.setFont("helvetica","normal");const{date:c,time:d}=Y(W.start_timestamp);i=o(`Chat ID: ${W.chat_id}`,r,i,a,11),i=o(`Date: ${c} at ${d}`,r,i,a,11),i=o(`Caller: ${ee}`,r,i,a,11),i=o(`Phone: ${Z}`,r,i,a,11),i=o(`Status: ${W.chat_status}`,r,i,a,11),i=o(`Duration: ${K(W.start_timestamp,W.end_timestamp)}`,r,i,a,11),i=o(`Cost: $${((null==(e=W.chat_cost)?void 0:e.total_cost)||0).toFixed(3)}`,r,i,a,11),i+=10,W.chat_analysis&&(i=l(i,30),s.setFontSize(14),s.setFont("helvetica","bold"),s.text("Post Chat Analysis",r,i),i+=10,s.setFontSize(11),s.setFont("helvetica","normal"),i=o("Success Status: "+(W.chat_analysis.chat_successful?"Successful":"Unsuccessful"),r,i,a,11),W.chat_analysis.user_sentiment&&(i=o(`User Sentiment: ${W.chat_analysis.user_sentiment}`,r,i,a,11)),i+=5,W.chat_analysis.chat_summary&&(i=l(i,30),s.setFontSize(12),s.setFont("helvetica","bold"),s.text("Conversation Summary:",r,i),i+=8,s.setFont("helvetica","normal"),i=o(W.chat_analysis.chat_summary,r,i,a,11),i+=10),W.chat_analysis.custom_analysis_data&&Object.keys(W.chat_analysis.custom_analysis_data).length>0&&(i=l(i,30),s.setFontSize(12),s.setFont("helvetica","bold"),s.text("Detailed Analysis:",r,i),i+=8,s.setFont("helvetica","normal"),Object.entries(W.chat_analysis.custom_analysis_data).forEach(([e,t])=>{i=l(i,15);const n=e.replace(/_/g," ").replace(/([A-Z])/g," $1").trim(),c="object"==typeof t?JSON.stringify(t,null,2):String(t);s.setFont("helvetica","bold"),i=o(`${n}:`,r,i,a,11),s.setFont("helvetica","normal"),i=o(c,30,i,a-10,11),i+=3}),i+=5)),W.message_with_tool_calls&&W.message_with_tool_calls.length>0&&(i=l(i,40),s.setFontSize(14),s.setFont("helvetica","bold"),s.text("Message Thread",r,i),i+=10,W.message_with_tool_calls.forEach((e,t)=>{i=l(i,25),s.setFontSize(11),s.setFont("helvetica","bold");const n="agent"===e.role?"AI Assistant":"Patient";if(i=o(`${n}:`,r,i,a,11),s.setFont("helvetica","normal"),i=o(e.content,30,i,a-10,11),e.tool_calls&&e.tool_calls.length>0){i+=3,s.setFont("helvetica","italic");const t=`Tool calls: ${e.tool_calls.map(e=>{var t;return(null==(t=e.function)?void 0:t.name)||e.type}).join(", ")}`;i=o(t,30,i,a-10,10)}i+=8})),W.collected_dynamic_variables&&Object.keys(W.collected_dynamic_variables).length>0&&(i=l(i,30),s.setFontSize(14),s.setFont("helvetica","bold"),s.text("Collected Information",r,i),i+=10,s.setFontSize(11),s.setFont("helvetica","normal"),Object.entries(W.collected_dynamic_variables).forEach(([e,t])=>{i=l(i,15);const s=e.replace(/_/g," ");i=o(`${s}: ${String(t)}`,r,i,a,11)}),i+=10),W.chat_cost&&W.chat_cost.product_costs&&(i=l(i,30),s.setFontSize(14),s.setFont("helvetica","bold"),s.text("Cost Breakdown",r,i),i+=10,s.setFontSize(11),s.setFont("helvetica","normal"),Object.entries(W.chat_cost.product_costs).forEach(([e,t])=>{i=l(i,10);const s=e.replace(/_/g," ");i=o(`${s}: $${("number"==typeof t?t:0).toFixed(3)}`,r,i,a,11)}),i+=5,s.setFont("helvetica","bold"),i=o(`Total: $${((null==(t=W.chat_cost)?void 0:t.total_cost)||0).toFixed(3)}`,r,i,a,11));const u=s.getNumberOfPages();for(let e=1;e<=u;e++)s.setPage(e),s.setFontSize(8),s.setFont("helvetica","normal"),s.text(`Generated by CareXPS CRM - Page ${e} of ${u}`,r,s.internal.pageSize.height-10),s.text(`Generated on: ${(new Date).toLocaleString()}`,n-r-60,s.internal.pageSize.height-10);const h=`chat-analysis-${W.chat_id}-${(new Date).toISOString().split("T")[0]}.pdf`;s.save(h)}catch(c){alert("Failed to generate PDF. Please try again.")}},className:"flex items-center gap-2 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:[F.jsx(Io,{className:"w-4 h-4"}),"Export Chat"]}),F.jsxs("div",{className:"ml-auto flex items-center gap-2",children:[F.jsx(No,{className:"w-4 h-4 text-green-500"}),F.jsx("span",{className:"text-sm text-green-600 font-medium",children:"HIPAA Compliant"})]})]})]})})]})})},Nw=({user:e})=>{const[t,s]=v.useState([]),[i,n]=v.useState(!1),[r,a]=v.useState(""),[o,l]=v.useState(""),[c,d]=v.useState("all"),[u,h]=v.useState("all"),[f,m]=v.useState(()=>localStorage.getItem("sms_page_date_range")||"thisMonth"),[g,y]=v.useState({totalChats:0,activeChats:0,completedChats:0,errorChats:0,avgDuration:"0s",totalCost:0,avgCostPerChat:0,successRate:0,positiveSentimentCount:0,totalMessages:0,avgMessagesPerChat:0}),[b,x]=v.useState(null),[w,S]=v.useState(!1),[k,_]=v.useState(1),[C,N]=v.useState(0),T=25,{formatLastRefreshTime:A}=Rl({enabled:!0,interval:6e4,onRefresh:()=>{E()}});v.useEffect(()=>{_(1),E()},[f]),v.useEffect(()=>{E()},[k]);const E=()=>p(void 0,null,function*(){n(!0),a("");try{if(!zl.isConfigured()){const e=JSON.parse(localStorage.getItem("currentUser")||"{}");if(e.id){const t=JSON.parse(localStorage.getItem(`settings_${e.id}`)||"{}");zl.updateCredentials(t.retellApiKey,t.smsAgentId)}if(!zl.isConfigured())return a("API not configured. Go to Settings → API Configuration to set up your credentials."),void n(!1)}if(!zl.isConfigured()){const e=yield zl.testConnection();if(!e.success)return a(`API Connection Error: ${e.message}`),void n(!1)}const{start:e,end:t}=Dl(f),i="agent_643486efd4b5a0e9d7e094ab99",r=yield zl.getChatHistory({limit:500}),o=e.getTime(),l=t.getTime(),c=r.chats.filter(e=>{if(e.agent_id!==i)return!1;let t;const s=e.start_timestamp;return t=s.toString().length<=10?1e3*s:s,t>=o&&t<=l});N(c.length);const d=(k-1)*T,u=d+T,h=c.slice(d,u);s(h);const m=zl.getChatStats(c);y(m)}catch(e){a(e instanceof Error?e.message:"Failed to fetch chat data")}finally{n(!1)}}),j=e=>p(void 0,null,function*(){try{const t=yield zl.endChat(e);if(!t.success)throw new Error(t.error||"Failed to end chat");E()}catch(t){a(t instanceof Error?t.message:"Failed to end chat")}}),P=e=>{let t;t=e.toString().length<=10?1e3*e:e;const s=new Date(t);return{date:s.toLocaleDateString([],{month:"short",day:"numeric",year:"numeric"}),time:s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0})}},I=(e,t)=>{if(!t)return"";const s=t-e;if(s<60)return`${s}s`;if(s<3600){return`${Math.floor(s/60)}m ${s%60}s`}return`${Math.floor(s/3600)}h ${Math.floor(s%3600/60)}m`},L=e=>{switch(e){case"positive":return"text-green-600 bg-green-50 border-green-200";case"negative":return"text-red-600 bg-red-50 border-red-200";case"neutral":return"text-yellow-600 bg-yellow-50 border-yellow-200";default:return"text-gray-600 bg-gray-50 border-gray-200"}},R=e=>{switch(e){case"ended":return"text-green-600 bg-green-50";case"ongoing":return"text-blue-600 bg-blue-50";case"error":return"text-red-600 bg-red-50";default:return"text-gray-600 bg-gray-50"}},O=t.filter(e=>{var t,s,i,n,r,a,l,d,h,f;const m=(null==(t=e.metadata)?void 0:t.phone_number)||(null==(s=e.metadata)?void 0:s.customer_phone_number)||"",p=(null==(i=e.metadata)?void 0:i.patient_name)||(null==(n=e.metadata)?void 0:n.customer_name)||(null==(r=e.metadata)?void 0:r.caller_name)||(null==(a=e.metadata)?void 0:a.name)||(null==(l=e.collected_dynamic_variables)?void 0:l.patient_name)||(null==(d=e.collected_dynamic_variables)?void 0:d.customer_name)||(null==(h=e.collected_dynamic_variables)?void 0:h.name)||null||"",g=!o||m.includes(o)||p.toLowerCase().includes(o.toLowerCase())||e.transcript.toLowerCase().includes(o.toLowerCase())||e.chat_id.toLowerCase().includes(o.toLowerCase()),v="all"===c||e.chat_status===c,y="all"===u||(null==(f=e.chat_analysis)?void 0:f.user_sentiment)===u;return g&&v&&y});return F.jsxs("div",{className:"p-6 space-y-6",children:[F.jsxs("div",{className:"flex items-center justify-between mb-4",children:[F.jsx(Ol,{selectedRange:f,onRangeChange:(e,t,s)=>{m(e),localStorage.setItem("sms_page_date_range",e);const{start:i,end:n}=Dl(e,t,s)}}),F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsxs("button",{onClick:()=>{a(""),n(!0),E()},disabled:i,className:"flex items-center gap-2 px-3 py-2 text-gray-600 hover:text-gray-900 transition-colors disabled:opacity-50",children:[F.jsx(nl,{className:"w-4 h-4 "+(i?"animate-spin":"")}),"Refresh"]}),F.jsxs("button",{className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[F.jsx(Io,{className:"w-4 h-4"}),"Export Chat Report"]})]})]}),F.jsxs("div",{className:"text-xs text-gray-500 mb-6",children:["Last refreshed: ",A()," (Auto-refresh every minute) | ",C," total chats"]}),F.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Total Chats"}),F.jsx(Vo,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:i?"...":g.totalChats}),F.jsx("div",{className:"text-xs text-gray-500",children:g.totalChats>0?`${g.completedChats} completed, ${g.errorChats} failed`:"No chats started"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Active Chats"}),F.jsx(To,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:i?"...":g.activeChats}),F.jsx("div",{className:"text-xs text-gray-500",children:"Currently ongoing conversations"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Avg Cost Per Chat"}),F.jsx(Po,{className:"w-4 h-4 text-gray-400"})]}),F.jsxs("div",{className:"text-3xl font-black text-blue-600 mb-1",children:["$",i?"...":g.avgCostPerChat.toFixed(3)]}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Total cost: $",g.totalCost.toFixed(2)]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Success Rate"}),F.jsx(yl,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:i?"...":`${g.successRate.toFixed(1)}%`}),F.jsx("div",{className:"text-xs text-gray-500",children:g.totalChats>0?`${Math.round(g.totalChats*g.successRate/100)} successful chats`:"0 successful chats"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Avg Duration"}),F.jsx(Eo,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:i?"...":g.avgDuration}),F.jsx("div",{className:"text-xs text-gray-500",children:"Average conversation length"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Positive Sentiment"}),F.jsx(pl,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:i?"...":g.positiveSentimentCount}),F.jsx("div",{className:"text-xs text-gray-500",children:g.totalChats>0?`${(g.positiveSentimentCount/g.totalChats*100).toFixed(1)}% positive`:"0% positive"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Total Messages"}),F.jsx(Go,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:i?"...":g.totalMessages}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Avg ",g.avgMessagesPerChat.toFixed(1)," messages per chat"]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Error Chats"}),F.jsx(Co,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:i?"...":g.errorChats}),F.jsx("div",{className:"text-xs text-gray-500",children:g.totalChats>0?`${(g.errorChats/g.totalChats*100).toFixed(1)}% failure rate`:"0% failure rate"})]})]}),F.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:F.jsxs("div",{className:"flex items-center justify-between mb-4",children:[F.jsxs("div",{children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(Po,{className:"w-5 h-5 text-green-600"}),F.jsx("span",{className:"text-lg font-semibold text-gray-900",children:"Total Chat Costs"})]}),F.jsx("p",{className:"text-sm text-gray-500",children:"Complete cost breakdown for selected date range"})]}),F.jsxs("div",{className:"text-right",children:[F.jsxs("div",{className:"text-3xl font-black text-green-600",children:["$",g.totalCost.toFixed(2)]}),F.jsxs("div",{className:"text-sm text-gray-500",children:[g.totalChats," chats"]})]})]})}),r&&F.jsxs("div",{className:"mb-6 bg-red-50 border border-red-200 rounded-lg p-4 flex items-center gap-3",children:[F.jsx(Co,{className:"w-5 h-5 text-red-600 flex-shrink-0"}),F.jsx("span",{className:"text-red-700",children:r}),F.jsx("button",{onClick:()=>a(""),className:"ml-auto text-red-600 hover:text-red-800 text-xl",children:"×"})]}),F.jsxs("div",{children:[F.jsx("div",{className:"mb-6 bg-white rounded-xl shadow-sm border border-gray-200 p-6",children:F.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[F.jsxs("div",{className:"flex-1 relative",children:[F.jsx(al,{className:"w-5 h-5 text-gray-400 absolute left-3 top-1/2 transform -translate-y-1/2"}),F.jsx("input",{type:"search",placeholder:"Search chats by phone number, patient name, or content...",value:o,onChange:e=>l(e.target.value),className:"w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),F.jsxs("div",{className:"flex gap-3",children:[F.jsxs("select",{value:c,onChange:e=>d(e.target.value),className:"px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[120px]",children:[F.jsx("option",{value:"all",children:"All Status"}),F.jsx("option",{value:"ongoing",children:"Ongoing"}),F.jsx("option",{value:"ended",children:"Ended"}),F.jsx("option",{value:"error",children:"Error"})]}),F.jsxs("select",{value:u,onChange:e=>h(e.target.value),className:"px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-[130px]",children:[F.jsx("option",{value:"all",children:"All Sentiment"}),F.jsx("option",{value:"positive",children:"Positive"}),F.jsx("option",{value:"neutral",children:"Neutral"}),F.jsx("option",{value:"negative",children:"Negative"})]})]})]})}),F.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden",children:i?F.jsxs("div",{className:"text-center py-12",children:[F.jsx("div",{className:"animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"}),F.jsx("p",{className:"text-gray-600 mt-4",children:"Loading chat conversations..."})]}):O.length>0?F.jsxs("div",{className:"overflow-x-auto",children:[F.jsx("div",{className:"bg-gray-50 border-b border-gray-200 px-6 py-3 hidden md:block",children:F.jsxs("div",{className:"grid grid-cols-12 gap-4 text-sm font-medium text-gray-700",children:[F.jsx("div",{className:"col-span-1",children:"#"}),F.jsx("div",{className:"col-span-3",children:"Patient"}),F.jsx("div",{className:"col-span-3",children:"Chat Info"}),F.jsx("div",{className:"col-span-2",children:"Cost"}),F.jsx("div",{className:"col-span-2",children:"Status & Duration"}),F.jsx("div",{className:"col-span-1",children:"Actions"})]})}),F.jsx("div",{className:"divide-y divide-gray-200",children:O.map((e,t)=>{var s,i,n,r,a,o,l,c,d,u,h,f,m,p,g,v,y,b,w,_,C,N,A,E,O,D,M,U,B,q,$,z,H,V,G,J,W,K,Y,X;const Q=(k-1)*T+t+1,Z=t%2==0?"bg-white":"bg-gray-25",ee=(null==(i=null==(s=e.chat_analysis)?void 0:s.custom_analysis_data)?void 0:i.phone_number)||(null==(r=null==(n=e.chat_analysis)?void 0:n.custom_analysis_data)?void 0:r.customer_phone_number)||(null==(o=null==(a=e.chat_analysis)?void 0:a.custom_analysis_data)?void 0:o.phone)||(null==(c=null==(l=e.chat_analysis)?void 0:l.custom_analysis_data)?void 0:c.contact_number)||(null==(d=e.metadata)?void 0:d.phone_number)||(null==(u=e.metadata)?void 0:u.customer_phone_number)||(null==(h=e.metadata)?void 0:h.from_phone_number)||(null==(f=e.metadata)?void 0:f.to_phone_number)||(null==(m=e.metadata)?void 0:m.phone)||(null==(p=e.collected_dynamic_variables)?void 0:p.phone_number)||(null==(g=e.collected_dynamic_variables)?void 0:g.customer_phone_number)||"";let te=(null==(y=null==(v=e.chat_analysis)?void 0:v.custom_analysis_data)?void 0:y.patient_name)||(null==(w=null==(b=e.chat_analysis)?void 0:b.custom_analysis_data)?void 0:w.caller_name)||(null==(C=null==(_=e.chat_analysis)?void 0:_.custom_analysis_data)?void 0:C.customer_name)||(null==(A=null==(N=e.chat_analysis)?void 0:N.custom_analysis_data)?void 0:A.name)||(null==(E=e.metadata)?void 0:E.patient_name)||(null==(O=e.metadata)?void 0:O.customer_name)||(null==(D=e.metadata)?void 0:D.caller_name)||(null==(M=e.metadata)?void 0:M.name)||(null==(U=e.metadata)?void 0:U.first_name)||(null==(B=e.metadata)?void 0:B.last_name)||(null==(q=e.collected_dynamic_variables)?void 0:q.patient_name)||(null==($=e.collected_dynamic_variables)?void 0:$.customer_name)||(null==(z=e.collected_dynamic_variables)?void 0:z.caller_name)||(null==(H=e.collected_dynamic_variables)?void 0:H.name)||(null==(V=e.collected_dynamic_variables)?void 0:V.first_name)||(null==(G=e.collected_dynamic_variables)?void 0:G.last_name)||null;if(!te)if(ee){const e=ee.replace(/\D/g,"").slice(-4);te=`Patient (${e?"***-"+e:ee})`}else te=`Patient #${e.chat_id.slice(0,6)}`;return F.jsxs("div",{className:`px-6 py-4 hover:bg-blue-50 cursor-pointer transition-colors ${Z}`,onClick:()=>{x(e),S(!0)},children:[F.jsxs("div",{className:"hidden md:grid grid-cols-12 gap-4 items-center",children:[F.jsx("div",{className:"col-span-1",children:F.jsxs("span",{className:"text-sm font-medium text-gray-500",children:["#",Q]})}),F.jsx("div",{className:"col-span-3",children:F.jsxs("div",{children:[F.jsx("div",{className:"font-medium text-gray-900",children:te}),F.jsx("div",{className:"text-sm text-gray-500",children:ee||"No phone number"})]})}),F.jsxs("div",{className:"col-span-3",children:[F.jsx("div",{className:"text-sm text-gray-900",children:P(e.start_timestamp).date}),F.jsx("div",{className:"text-xs text-gray-500",children:P(e.start_timestamp).time}),F.jsx("div",{className:"flex items-center gap-2 mt-1",children:(null==(J=e.chat_analysis)?void 0:J.user_sentiment)&&F.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium border ${L(e.chat_analysis.user_sentiment)}`,children:e.chat_analysis.user_sentiment})})]}),F.jsxs("div",{className:"col-span-2",children:[F.jsxs("div",{className:"text-sm font-medium text-gray-900",children:["$",((null==(W=e.chat_cost)?void 0:W.total_cost)||0).toFixed(3)]}),F.jsx("div",{className:"text-xs text-gray-500",children:"SMS Cost"})]}),F.jsxs("div",{className:"col-span-2",children:[F.jsx("div",{className:"flex items-center gap-2 mb-1",children:F.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${R(e.chat_status)}`,children:e.chat_status})}),F.jsx("div",{className:"text-xs text-gray-500",children:I(e.start_timestamp,e.end_timestamp)})]}),F.jsx("div",{className:"col-span-1",children:F.jsxs("div",{className:"flex items-center gap-1",children:[F.jsx("button",{className:"p-1 hover:bg-gray-200 rounded transition-colors",onClick:t=>{t.stopPropagation(),x(e),S(!0)},title:"View Details",children:F.jsx(Ro,{className:"w-4 h-4 text-gray-500"})}),"ongoing"===e.chat_status&&F.jsx("button",{className:"p-1 hover:bg-red-200 rounded transition-colors",onClick:t=>{t.stopPropagation(),j(e.chat_id)},title:"End Chat",children:F.jsx(Ao,{className:"w-4 h-4 text-red-500"})})]})})]}),F.jsxs("div",{className:"md:hidden space-y-3",children:[F.jsxs("div",{className:"flex items-start justify-between",children:[F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsx("div",{className:"w-10 h-10 rounded-full flex items-center justify-center "+("ongoing"===e.chat_status?"bg-blue-100":"ended"===e.chat_status?"bg-green-100":"bg-red-100"),children:"ongoing"===e.chat_status?F.jsx(yo,{className:"w-5 h-5 text-blue-600"}):"ended"===e.chat_status?F.jsx(No,{className:"w-5 h-5 text-green-600"}):F.jsx(Co,{className:"w-5 h-5 text-red-600"})}),F.jsxs("div",{children:[F.jsx("div",{className:"font-semibold text-gray-900",children:te}),F.jsx("div",{className:"text-sm text-gray-500",children:ee||"No phone number"})]})]}),F.jsx("div",{className:"flex items-center gap-1",children:"ongoing"===e.chat_status&&F.jsx("button",{className:"p-1 hover:bg-red-200 rounded transition-colors",onClick:t=>{t.stopPropagation(),j(e.chat_id)},children:F.jsx(Ao,{className:"w-4 h-4 text-red-500"})})})]}),F.jsx("div",{className:"bg-gray-50 rounded p-3",children:F.jsx("p",{className:"text-sm text-gray-900 line-clamp-2",children:e.transcript||"No conversation yet"})}),F.jsxs("div",{className:"flex flex-wrap items-center gap-2 text-sm",children:[F.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${R(e.chat_status)}`,children:e.chat_status}),(null==(K=e.chat_analysis)?void 0:K.user_sentiment)&&F.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium border ${L(e.chat_analysis.user_sentiment)}`,children:e.chat_analysis.user_sentiment}),F.jsxs("span",{className:"text-gray-500",children:[P(e.start_timestamp).date," ",P(e.start_timestamp).time]}),F.jsxs("span",{className:"text-gray-500",children:[(null==(Y=e.message_with_tool_calls)?void 0:Y.length)||0," msgs"]}),F.jsxs("span",{className:"text-gray-500",children:["$",((null==(X=e.chat_cost)?void 0:X.total_cost)||0).toFixed(3)]})]})]})]},e.chat_id)})})]}):F.jsxs("div",{className:"text-center py-16",children:[F.jsx(Vo,{className:"w-16 h-16 text-gray-400 mx-auto mb-4"}),F.jsx("h3",{className:"text-xl font-medium text-gray-900 mb-2",children:"No chat conversations found"}),F.jsx("p",{className:"text-gray-600",children:"No chat conversations have been started yet."})]})})]}),C>T&&F.jsxs("div",{className:"flex items-center justify-between mt-8 bg-white rounded-lg border border-gray-200 px-6 py-4",children:[F.jsx("div",{className:"flex items-center text-sm text-gray-700",children:F.jsxs("span",{children:["Showing ",(k-1)*T+1," to ",Math.min(k*T,C)," of ",C," chats"]})}),F.jsxs("div",{className:"flex items-center space-x-2",children:[F.jsx("button",{onClick:()=>_(e=>Math.max(e-1,1)),disabled:1===k,className:"px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"Previous"}),F.jsx("div",{className:"flex items-center space-x-1",children:(()=>{const e=Math.ceil(C/T),t=[],s=Math.max(1,k-2),i=Math.min(e,k+2);s>1&&(t.push(F.jsx("button",{onClick:()=>_(1),className:"px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50",children:"1"},1)),s>2&&t.push(F.jsx("span",{className:"px-2 text-gray-500",children:"..."},"ellipsis1")));for(let n=s;n<=i;n++)t.push(F.jsx("button",{onClick:()=>_(n),className:"px-3 py-2 text-sm font-medium rounded-lg "+(n===k?"text-blue-600 bg-blue-50 border border-blue-200":"text-gray-700 bg-white border border-gray-300 hover:bg-gray-50"),children:n},n));return i<e&&(i<e-1&&t.push(F.jsx("span",{className:"px-2 text-gray-500",children:"..."},"ellipsis2")),t.push(F.jsx("button",{onClick:()=>_(e),className:"px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50",children:e},e))),t})()}),F.jsx("button",{onClick:()=>_(e=>Math.min(e+1,Math.ceil(C/T))),disabled:k>=Math.ceil(C/T),className:"px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"Next"})]})]}),b&&w&&F.jsx(Cw,{chat:b,isOpen:w,onClose:()=>{S(!1),x(null)},onEndChat:j})]})},Tw=()=>{const[e,t]=v.useState({totalChats:0,activeChats:0,completedChats:0,errorChats:0,avgDuration:"0s",totalCost:0,avgCostPerChat:0,successRate:0,positiveSentimentCount:0,totalMessages:0,avgMessagesPerChat:0}),[s,i]=v.useState(null),[n,r]=v.useState([]),[a,o]=v.useState({positive:0,negative:0,neutral:0}),[l,c]=v.useState([]),[d,u]=v.useState(""),{formatLastRefreshTime:h}=Rl({enabled:!0,interval:6e4,onRefresh:()=>{b()}}),[f,m]=v.useState("today"),[g,y]=v.useState(!0);v.useEffect(()=>{b()},[f]);const b=()=>p(void 0,null,function*(){y(!0),u("");try{if(!zl.isConfigured()){const e=JSON.parse(localStorage.getItem("currentUser")||"{}");if(e.id){const t=JSON.parse(localStorage.getItem(`settings_${e.id}`)||"{}");zl.updateCredentials(t.retellApiKey,t.smsAgentId)}if(!zl.isConfigured())return u("API not configured. Go to Settings → API Configuration to set up your credentials."),void y(!1)}if(!zl.isConfigured()){const e=yield zl.testConnection();if(!e.success)return u(`API Connection Error: ${e.message}`),void y(!1)}const{start:e,end:s}=Dl(f),n="agent_643486efd4b5a0e9d7e094ab99",[a,l]=yield Promise.all([zl.getChatHistory({limit:500}),zl.getChatAnalytics({agent_id:n})]),d=e.getTime(),h=s.getTime(),m=a.chats.filter(e=>{if(e.agent_id!==n)return!1;const t=e.start_timestamp,s=t.toString().length<=10?1e3*t:t;return s>=d&&s<=h}),p=zl.getChatStats(m);t(p),i(l),r(l.trends),o(l.sentimentDistribution),c(l.peakHours)}catch(e){u(e.message||"Failed to fetch chat analytics")}finally{y(!1)}});return F.jsxs("div",{className:"p-6 space-y-6",children:[F.jsxs("div",{className:"flex items-center justify-between mb-4",children:[F.jsx(Ol,{selectedRange:f,onRangeChange:(e,t,s)=>{m(e);const{start:i,end:n}=Dl(e,t,s);b()}}),F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsxs("button",{onClick:b,className:"flex items-center gap-2 px-3 py-2 text-gray-600 hover:text-gray-900 transition-colors",children:[F.jsx(nl,{className:"w-4 h-4"}),"Refresh"]}),F.jsxs("button",{className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors",children:[F.jsx(Io,{className:"w-4 h-4"}),"Export SMS Report"]})]})]}),F.jsxs("div",{className:"text-xs text-gray-500 mb-6",children:["Last refreshed: ",h()," (Auto-refresh every minute) | Chat Analytics Dashboard"]}),d&&F.jsxs("div",{className:"mb-6 bg-red-50 border border-red-200 rounded-lg p-4 flex items-center gap-3",children:[F.jsx(bl,{className:"w-5 h-5 text-red-600 flex-shrink-0"}),F.jsx("span",{className:"text-red-700",children:d}),F.jsx("button",{onClick:()=>u(""),className:"ml-auto text-red-600 hover:text-red-800 text-xl",children:"×"})]}),F.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Total Chats"}),F.jsx(Vo,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:g?"...":e.totalChats}),F.jsx("div",{className:"text-xs text-gray-500",children:e.totalChats>0?`${e.completedChats} completed, ${e.errorChats} failed`:"No chats started"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Success Rate"}),F.jsx(So,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:g?"...":`${e.successRate.toFixed(1)}%`}),F.jsx("div",{className:"text-xs text-gray-500",children:e.totalChats>0?`${Math.round(e.totalChats*e.successRate/100)} successful`:"0 successful"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Avg Cost Per Chat"}),F.jsx(Po,{className:"w-4 h-4 text-gray-400"})]}),F.jsxs("div",{className:"text-3xl font-black text-blue-600 mb-1",children:["$",g?"...":e.avgCostPerChat.toFixed(3)]}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Total cost: $",e.totalCost.toFixed(2)]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Active Chats"}),F.jsx(To,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:g?"...":e.activeChats}),F.jsx("div",{className:"text-xs text-gray-500",children:e.activeChats>0?"Currently ongoing":"None active"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Avg Duration"}),F.jsx(Eo,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:g?"...":e.avgDuration}),F.jsx("div",{className:"text-xs text-gray-500",children:"Average conversation length"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Positive Sentiment"}),F.jsx(pl,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:g?"...":e.positiveSentimentCount}),F.jsx("div",{className:"text-xs text-gray-500",children:e.totalChats>0?`${(e.positiveSentimentCount/e.totalChats*100).toFixed(1)}% positive`:"0% positive"})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Total Messages"}),F.jsx(Go,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:g?"...":e.totalMessages}),F.jsxs("div",{className:"text-xs text-gray-500",children:["Avg ",e.avgMessagesPerChat.toFixed(1)," per chat"]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-2",children:[F.jsx("span",{className:"text-sm text-gray-600",children:"Error Chats"}),F.jsx(bl,{className:"w-4 h-4 text-gray-400"})]}),F.jsx("div",{className:"text-3xl font-black text-blue-600 mb-1",children:g?"...":e.errorChats}),F.jsx("div",{className:"text-xs text-gray-500",children:e.totalChats>0?`${(e.errorChats/e.totalChats*100).toFixed(1)}% failure rate`:"0% failure rate"})]})]}),F.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:F.jsxs("div",{className:"flex items-center justify-between mb-4",children:[F.jsxs("div",{children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(Po,{className:"w-5 h-5 text-green-600"}),F.jsx("span",{className:"text-lg font-semibold text-gray-900",children:"Total Chat Costs"})]}),F.jsx("p",{className:"text-sm text-gray-500",children:"Complete cost breakdown for selected date range"})]}),F.jsxs("div",{className:"text-right",children:[F.jsxs("div",{className:"text-3xl font-black text-green-600",children:["$",e.totalCost.toFixed(2)]}),F.jsxs("div",{className:"text-sm text-gray-500",children:[e.totalChats," chats"]})]})]})})]})},Aw=({user:e,onComplete:t,onCancel:s})=>{const[i,n]=v.useState("setup"),[r,a]=v.useState(""),[o,l]=v.useState(""),[c,d]=v.useState(""),[u,h]=v.useState(!1),[f,m]=v.useState(""),[g,y]=v.useState(!1),[b,x]=v.useState([]),[w,S]=v.useState(!1);v.useEffect(()=>{k()},[]);const k=()=>p(void 0,null,function*(){try{const t=yield ho.generateSecret(e.id,e.email);a(t.manualEntryKey),l(t.qrCodeUrl),t.backupCodes&&t.backupCodes.length>0&&x(t.backupCodes)}catch(t){m("Failed to generate MFA secret: "+(t instanceof Error?t.message:"Unknown error")),yield _()}}),_=()=>p(void 0,null,function*(){try{const t=new Uint8Array(20);crypto.getRandomValues(t);const s=Array.from(t,e=>"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567"[e%32]).join("");a(s);const i=new Pr({issuer:"CareXPS Healthcare CRM",label:e.email,algorithm:"SHA1",digits:6,period:30,secret:s}).toString(),n=yield Ir.toDataURL(i,{width:256,margin:2,color:{dark:"#000000",light:"#FFFFFF"}});l(n);const r=[];for(let e=0;e<10;e++){const e=Math.random().toString().slice(2,10);r.push(e)}x(r),n||m("QR code generation failed, but you can still use manual setup below.")}catch(t){m("Failed to generate MFA secret: "+(t instanceof Error?t.message:"Unknown error"))}}),C=()=>{const e=[];for(let t=0;t<10;t++){const t=Math.random().toString().slice(2,10);e.push(t)}return x(e),e};return F.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:F.jsxs("div",{className:"bg-white rounded-xl max-w-md w-full p-6",children:[F.jsxs("div",{className:"text-center mb-6",children:[F.jsx("div",{className:"w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4",children:F.jsx(ll,{className:"w-8 h-8 text-blue-600"})}),F.jsx("h2",{className:"text-xl font-bold text-gray-900 mb-2",children:"Set Up Multi-Factor Authentication"}),F.jsx("p",{className:"text-gray-600",children:"Secure your account with time-based one-time passwords (TOTP)"})]}),"setup"===i&&F.jsxs("div",{className:"space-y-6",children:[F.jsxs("div",{className:"text-center",children:[F.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Step 1: Scan QR Code"}),F.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Use your authenticator app (Google Authenticator, Authy, etc.) to scan this QR code:"}),o?F.jsx("div",{className:"bg-white p-4 rounded-lg border border-gray-200 inline-block",children:F.jsx("img",{src:o,alt:"MFA QR Code",className:"w-48 h-48"})}):F.jsx("div",{className:"bg-yellow-50 p-4 rounded-lg border border-yellow-200",children:F.jsx("p",{className:"text-yellow-800 text-sm",children:"QR code is generating... If it doesn't appear, use the manual setup below."})})]}),F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsx("h4",{className:"font-medium text-gray-900 mb-2",children:"Manual Setup"}),F.jsx("p",{className:"text-sm text-gray-600 mb-3",children:"If you can't scan the QR code, enter this secret key manually:"}),F.jsxs("div",{className:"bg-white rounded border border-gray-200 p-3 flex items-center justify-between",children:[F.jsx("code",{className:"text-sm font-mono text-gray-900",children:(N=r,(null==(T=N.match(/.{1,4}/g))?void 0:T.join(" "))||N)}),F.jsx("button",{onClick:()=>p(void 0,null,function*(){try{yield navigator.clipboard.writeText(r),y(!0),setTimeout(()=>y(!1),2e3)}catch(e){}}),className:"ml-2 p-1 text-gray-500 hover:text-gray-700",title:"Copy to clipboard",children:F.jsx(jo,{className:"w-4 h-4"})})]}),g&&F.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Copied to clipboard!"})]}),F.jsxs("div",{className:"flex gap-3",children:[F.jsx("button",{onClick:s,className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50",children:"Cancel"}),F.jsx("button",{onClick:()=>n("verify"),className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Next Step"})]})]}),"verify"===i&&F.jsxs("div",{className:"space-y-6",children:[F.jsxs("div",{className:"text-center",children:[F.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Step 2: Verify Setup"}),F.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Enter the 6-digit code from your authenticator app to complete setup:"})]}),F.jsx("div",{children:F.jsx("input",{type:"text",placeholder:"000000",value:c,onChange:e=>{const t=e.target.value.replace(/\D/g,"").slice(0,6);d(t),m("")},className:"w-full px-4 py-3 text-center text-2xl font-mono border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",maxLength:6,autoComplete:"off"})}),f&&F.jsxs("div",{className:"flex items-center gap-2 text-red-600 text-sm",children:[F.jsx(Co,{className:"w-4 h-4"}),f]}),F.jsx("div",{className:"bg-blue-50 rounded-lg p-4",children:F.jsxs("div",{className:"flex items-start gap-3",children:[F.jsx(dl,{className:"w-5 h-5 text-blue-600 mt-0.5"}),F.jsxs("div",{children:[F.jsx("h4",{className:"font-medium text-blue-900 mb-1",children:"Tip"}),F.jsx("p",{className:"text-sm text-blue-800",children:"The code changes every 30 seconds. If it doesn't work, wait for a new code and try again."})]})]})}),F.jsxs("div",{className:"flex gap-3",children:[F.jsx("button",{onClick:()=>n("setup"),className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50",disabled:u,children:"Back"}),F.jsx("button",{onClick:()=>p(void 0,null,function*(){if(c.trim()&&6===c.length){h(!0),m("");try{const t=yield ho.verifyTOTP(e.id,c,!1);t.success?(0===b.length&&C(),n("backup-codes")):m(t.message||"Invalid verification code. Please try again.")}catch(t){try{const t=new Pr({issuer:"CareXPS Healthcare CRM",label:e.email,algorithm:"SHA1",digits:6,period:30,secret:r});null!==t.validate({token:c,window:1})?(0===b.length&&C(),n("backup-codes")):m("Invalid verification code. Please try again.")}catch(s){m("Verification failed. Please try again.")}}finally{h(!1)}}else m("Please enter a valid 6-digit code")}),disabled:6!==c.length||u,className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:u?F.jsxs(F.Fragment,{children:[F.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Verifying..."]}):F.jsxs(F.Fragment,{children:[F.jsx(No,{className:"w-4 h-4"}),"Complete Setup"]})})]})]}),"backup-codes"===i&&F.jsxs("div",{className:"space-y-6",children:[F.jsxs("div",{className:"text-center",children:[F.jsx("h3",{className:"font-semibold text-gray-900 mb-4",children:"Step 3: Save Your Backup Codes"}),F.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Save these backup codes in a safe place. You can use them to access your account if you lose your phone."})]}),F.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[F.jsxs("div",{className:"flex items-center justify-between mb-3",children:[F.jsx("h4",{className:"font-medium text-gray-900",children:"Backup Codes"}),F.jsxs("button",{onClick:()=>p(void 0,null,function*(){try{const e=b.join("\n");yield navigator.clipboard.writeText(e),S(!0),setTimeout(()=>S(!1),2e3)}catch(e){}}),className:"flex items-center gap-2 px-3 py-1 text-sm text-blue-600 hover:text-blue-700",children:[F.jsx(jo,{className:"w-4 h-4"}),w?"Copied!":"Copy All"]})]}),F.jsx("div",{className:"grid grid-cols-2 gap-2",children:b.map((e,t)=>F.jsx("div",{className:"bg-white rounded border border-gray-200 p-2 font-mono text-sm text-center",children:e},t))})]}),F.jsx("div",{className:"bg-yellow-50 rounded-lg p-4",children:F.jsxs("div",{className:"flex items-start gap-3",children:[F.jsx(Co,{className:"w-5 h-5 text-yellow-600 mt-0.5"}),F.jsxs("div",{children:[F.jsx("h4",{className:"font-medium text-yellow-900 mb-1",children:"Important"}),F.jsxs("ul",{className:"text-sm text-yellow-800 space-y-1",children:[F.jsx("li",{children:"• Each backup code can only be used once"}),F.jsx("li",{children:"• Store them in a secure location (password manager, safe, etc.)"}),F.jsx("li",{children:"• Don't share these codes with anyone"}),F.jsx("li",{children:"• Generate new codes if these are compromised"})]})]})]})}),F.jsxs("div",{className:"flex gap-3",children:[F.jsx("button",{onClick:()=>n("verify"),className:"flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50",children:"Back"}),F.jsxs("button",{onClick:()=>{t(r,b)},className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2",children:[F.jsx(No,{className:"w-4 h-4"}),"Complete Setup"]})]})]})]})});var N,T};class Ew{static loadSystemUsers(){return p(this,null,function*(){try{yield W.logSecurityEvent("SYSTEM_USERS_MANAGEMENT_ACCESS","users",!0);const e=yield zi.loadSystemUsers();if("error"===e.status)return e;const t=e.data||[];return{status:"success",data:yield Promise.all(t.map(e=>p(this,null,function*(){const t=yield this.getUserLoginStats(e.id),s=yield this.getUserCredentials(e.id);return u(d({},e),{credentials:s,lastLogin:t.lastLogin,loginAttempts:t.loginAttempts,isLocked:t.isLocked})})))}}catch(e){return yield W.logSecurityEvent("SYSTEM_USERS_MANAGEMENT_ACCESS_FAILED","users",!1,{error:e.message}),{status:"error",error:e.message}}})}static saveSystemUsers(e){return p(this,null,function*(){try{yield W.logSecurityEvent("SYSTEM_USERS_MANAGEMENT_UPDATE","users",!0);for(const t of e){const e=yield zi.saveUserProfile(t);if("error"===e.status)throw new Error(`Failed to update user ${t.email}: ${e.error}`);t.credentials&&(yield this.saveUserCredentials(t.id,t.credentials))}return yield W.logSecurityEvent("SYSTEM_USERS_MANAGEMENT_UPDATED","users",!0,{userCount:e.length}),{status:"success"}}catch(t){return yield W.logSecurityEvent("SYSTEM_USERS_MANAGEMENT_UPDATE_FAILED","users",!1,{error:t.message}),{status:"error",error:t.message}}})}static createSystemUser(e,t){return p(this,null,function*(){try{yield W.logSecurityEvent("SYSTEM_USER_CREATE","users",!0,{email:e.email});const s=yield zi.userExistsByEmail(e.email);if("error"===s.status)return{status:"error",error:`Failed to check for existing user: ${s.error}`};if(s.data)return{status:"error",error:`A user with email ${e.email} already exists`};const i=yield zi.createUser(e);if("error"===i.status)return i;const n=i.data;yield this.saveUserCredentials(n.id,t);const r=u(d({},n),{credentials:t,lastLogin:void 0,loginAttempts:0,isLocked:!1});return yield W.logSecurityEvent("SYSTEM_USER_CREATED","users",!0,{userId:n.id,email:e.email,role:e.role}),{status:"success",data:r}}catch(s){return yield W.logSecurityEvent("SYSTEM_USER_CREATE_FAILED","users",!1,{email:e.email,error:s.message}),{status:"error",error:s.message}}})}static authenticateUser(e,t){return p(this,null,function*(){try{yield W.logSecurityEvent("USER_AUTHENTICATION_ATTEMPT","users",!0,{email:e,timestamp:(new Date).toISOString()});const s=yield zi.getUserByEmail(e);if("error"===s.status)return s;if(!s.data)return yield this.recordFailedLogin(e,"User not found"),{status:"success",data:null};const i=s.data;if("demo@carexps.com"===e||"elmfarrell@yahoo.com"===e||"pierre@phaetonai.com"===e)yield this.forceClearLockout(i.id,e);else{if((yield this.getUserLoginStats(i.id)).isLocked)return yield W.logSecurityEvent("USER_AUTHENTICATION_BLOCKED","users",!1,{email:e,reason:"Account locked"}),{status:"error",error:"Account is temporarily locked due to too many failed login attempts. Contact your administrator to unlock your account."}}const n=yield this.getUserCredentials(i.id);if(!n||!(yield this.verifyPassword(t,n.password)))return yield this.recordFailedLogin(e,"Invalid password"),yield this.incrementLoginAttempts(i.id),{status:"success",data:null};yield this.resetLoginAttempts(i.id),yield this.updateLastLogin(i.id);const r=u(d({},i),{credentials:n,lastLogin:(new Date).toISOString(),loginAttempts:0,isLocked:!1});return yield W.logSecurityEvent("USER_AUTHENTICATION_SUCCESS","users",!0,{userId:i.id,email:e}),{status:"success",data:r}}catch(s){return yield W.logSecurityEvent("USER_AUTHENTICATION_ERROR","users",!1,{email:e,error:s.message}),{status:"error",error:s.message}}})}static updateUserCredentials(e,t){return p(this,null,function*(){try{return yield W.logSecurityEvent("USER_CREDENTIALS_UPDATE","users",!0,{userId:e}),yield this.saveUserCredentials(e,t),yield W.logSecurityEvent("USER_CREDENTIALS_UPDATED","users",!0,{userId:e}),{status:"success"}}catch(s){return yield W.logSecurityEvent("USER_CREDENTIALS_UPDATE_FAILED","users",!1,{userId:e,error:s.message}),{status:"error",error:s.message}}})}static deleteSystemUser(e){return p(this,null,function*(){try{yield W.logSecurityEvent("SYSTEM_USER_DELETE","users",!0,{userId:e});const n=yield zi.deleteUser(e);if("error"===n.status)return n;yield this.removeUserCredentials(e),localStorage.removeItem(`loginStats_${e}`);try{const s=yield this.getUserEmail(e);if(s){const e=localStorage.getItem("failed_login_attempts");if(e){let t=JSON.parse(e);t=t.filter(e=>e.email!==s),localStorage.setItem("failed_login_attempts",JSON.stringify(t))}try{yield Di.from("failed_login_attempts").delete().eq("email",s)}catch(t){}}}catch(s){}const r=localStorage.getItem("deletedUsers");let a=[];if(r)try{a=JSON.parse(r)}catch(i){a=[]}a.includes(e)||(a.push(e),localStorage.setItem("deletedUsers",JSON.stringify(a)));const o=localStorage.getItem("deletedUserEmails");let l=[];if(o)try{l=JSON.parse(o)}catch(i){l=[]}try{const t=yield this.getUserEmail(e);t&&!l.includes(t.toLowerCase())&&(l.push(t.toLowerCase()),localStorage.setItem("deletedUserEmails",JSON.stringify(l)))}catch(s){}return yield W.logSecurityEvent("SYSTEM_USER_DELETED","users",!0,{userId:e}),{status:"success"}}catch(n){return yield W.logSecurityEvent("SYSTEM_USER_DELETE_FAILED","users",!1,{userId:e,error:n.message}),{status:"error",error:n.message}}})}static getUserCredentials(e){return p(this,null,function*(){try{return yield this.getStoredCredentials(e)}catch(t){return null}})}static saveUserCredentials(e,t){return p(this,null,function*(){try{yield this.storeCredentials(e,t)}catch(s){throw new Error(`Failed to save credentials: ${s}`)}})}static removeUserCredentials(e){return p(this,null,function*(){try{yield this.removeStoredCredentials(e)}catch(t){}})}static getUserLoginStats(e){return p(this,null,function*(){try{try{let t=yield this.getUserEmail(e);if(!t){t={"demo-user-123":"demo@carexps.com","super-user-456":"elmfarrell@yahoo.com","pierre-user-789":"pierre@phaetonai.com"}[e]}if(t){const{data:s,error:i}=yield Di.from("failed_login_attempts").select("*").eq("email",t).gte("attempted_at",new Date(Date.now()-this.LOCKOUT_DURATION).toISOString()).order("attempted_at",{ascending:!1});if(!i&&s){const t=s.length,i=t>=this.MAX_LOGIN_ATTEMPTS,{data:n}=yield Di.from("users").select("last_login").eq("id",e).single();return{lastLogin:(null==n?void 0:n.last_login)||void 0,loginAttempts:t,isLocked:i}}}}catch(t){}const s=localStorage.getItem(`loginStats_${e}`);if(s){const e=JSON.parse(s),t=Date.now(),i=e.lockoutUntil?new Date(e.lockoutUntil).getTime():0,n=e.lockoutUntil&&i>t;return{lastLogin:e.lastLogin,loginAttempts:e.loginAttempts||0,isLocked:Boolean(n)}}return{loginAttempts:0,isLocked:!1}}catch(s){return{loginAttempts:0,isLocked:!1}}})}static recordFailedLogin(e,t){return p(this,null,function*(){try{try{const{error:s}=yield Di.from("failed_login_attempts").insert({email:e,ip_address:yield this.getClientIP(),user_agent:navigator.userAgent,reason:t,attempted_at:(new Date).toISOString()});if(!s)return}catch(s){}const i={email:e,ip_address:yield this.getClientIP(),user_agent:navigator.userAgent,reason:t,attempted_at:(new Date).toISOString()},n=localStorage.getItem("failed_login_attempts");let r=[];n&&(r=JSON.parse(n)),r.push(i),r.length>100&&(r=r.slice(-100)),localStorage.setItem("failed_login_attempts",JSON.stringify(r))}catch(i){}})}static incrementLoginAttempts(e){return p(this,null,function*(){try{const t=yield this.getUserEmail(e);if(t){yield this.recordFailedLogin(t,"Invalid password");const s=localStorage.getItem(`loginStats_${e}`);let i={loginAttempts:0,lastLogin:void 0};s&&(i=JSON.parse(s)),i.loginAttempts=(i.loginAttempts||0)+1,i.loginAttempts>=this.MAX_LOGIN_ATTEMPTS&&(i.lockoutUntil=new Date(Date.now()+this.LOCKOUT_DURATION).toISOString()),localStorage.setItem(`loginStats_${e}`,JSON.stringify(i))}}catch(t){}})}static resetLoginAttempts(e){return p(this,null,function*(){try{let s=yield this.getUserEmail(e);if(!s){s={"demo-user-123":"demo@carexps.com","super-user-456":"elmfarrell@yahoo.com","pierre-user-789":"pierre@phaetonai.com"}[e]}if(s){try{yield Di.from("failed_login_attempts").delete().eq("email",s)}catch(t){}const i={loginAttempts:0,lastLogin:(new Date).toISOString(),lockoutUntil:void 0};localStorage.setItem(`loginStats_${e}`,JSON.stringify(i));const n=localStorage.getItem("failed_login_attempts");if(n){let e=JSON.parse(n);e=e.filter(e=>e.email!==s),localStorage.setItem("failed_login_attempts",JSON.stringify(e))}}else{const t={loginAttempts:0,lastLogin:(new Date).toISOString(),lockoutUntil:void 0};localStorage.setItem(`loginStats_${e}`,JSON.stringify(t))}}catch(s){}})}static updateLastLogin(e){return p(this,null,function*(){const t=(new Date).toISOString();try{yield Di.from("users").update({last_login:t}).eq("id",e)}catch(s){}try{const s=`loginStats_${e}`,i=localStorage.getItem(s);let n={loginAttempts:0,lastLogin:void 0,lockoutUntil:void 0};i&&(n=JSON.parse(i)),n.lastLogin=t,localStorage.setItem(s,JSON.stringify(n))}catch(s){}})}static getUserEmail(e){return p(this,null,function*(){try{const{data:t,error:s}=yield Di.from("users").select("email").eq("id",e).single();if(!s&&(null==t?void 0:t.email))return t.email}catch(t){}try{const t=yield this.getStoredCredentials(e);if(null==t?void 0:t.email)return t.email}catch(t){}return null})}static hashPassword(e){return p(this,null,function*(){return yield z.encryptString(e)})}static verifyPassword(e,t){return p(this,null,function*(){try{const s=yield z.decryptString(t);return e===s}catch(s){return!1}})}static changeUserPassword(e,t){return p(this,null,function*(){try{let s=yield this.getUserEmail(e);if(!s){s={"demo-user-123":"demo@carexps.com","super-user-456":"elmfarrell@yahoo.com","pierre-user-789":"pierre@phaetonai.com"}[e]}if(!s)throw new Error(`Cannot change password: User email not found for user ID ${e}`);yield W.logSecurityEvent("USER_PASSWORD_CHANGE_ATTEMPT","users",!0,{userId:e,userEmail:s,timestamp:(new Date).toISOString(),changedBy:"super_user"});const i={email:s,password:t,tempPassword:!1};if(yield this.saveUserCredentials(e,i),s){const t={"demo@carexps.com":"demo-user-123","elmfarrell@yahoo.com":"super-user-456","pierre@phaetonai.com":"pierre-user-789"}[s];t&&t!==e&&(yield this.saveUserCredentials(t,i))}const n=yield this.authenticateUser(s,t);if("success"!==n.status||!n.data)throw new Error("Password change verification failed - new password does not authenticate");return yield this.clearAccountLockout(e),yield W.logSecurityEvent("USER_PASSWORD_CHANGED","users",!0,{userId:e,userEmail:s,timestamp:(new Date).toISOString(),changedBy:"super_user",verified:!0}),{status:"success",data:!0}}catch(s){return yield W.logSecurityEvent("USER_PASSWORD_CHANGE_FAILED","users",!1,{userId:e,error:s.message,timestamp:(new Date).toISOString()}),{status:"error",error:s.message||"Failed to change password"}}})}static getClientIP(){return p(this,null,function*(){try{return"localhost"}catch(e){return"unknown"}})}static storeCredentials(e,t){return p(this,null,function*(){try{yield this.removeStoredCredentials(e);const i=u(d({},t),{password:yield this.hashPassword(t.password)}),n=yield z.encryptString(JSON.stringify(i));let r=!1;try{const{error:t}=yield Di.from("user_profiles").upsert({user_id:e,encrypted_retell_api_key:n});t||(r=!0)}catch(s){}localStorage.setItem(`userCredentials_${e}`,n);const a=yield this.getStoredCredentials(e);if(!a||a.email!==t.email)throw new Error("Credential verification failed - stored credentials could not be retrieved")}catch(i){throw new Error(`Failed to store user credentials: ${i}`)}})}static getStoredCredentials(e){return p(this,null,function*(){try{const{data:t,error:s}=yield Di.from("user_profiles").select("encrypted_retell_api_key").eq("user_id",e).single();if(!s&&(null==t?void 0:t.encrypted_retell_api_key)){const e=yield z.decryptString(t.encrypted_retell_api_key);return JSON.parse(e)}}catch(t){}try{const t=localStorage.getItem(`userCredentials_${e}`);if(!t)return null;const s=yield z.decryptString(t);return JSON.parse(s)}catch(t){return null}})}static removeStoredCredentials(e){return p(this,null,function*(){try{yield Di.from("user_profiles").update({encrypted_retell_api_key:null}).eq("user_id",e)}catch(t){}try{localStorage.removeItem(`userCredentials_${e}`)}catch(t){}try{localStorage.removeItem(`loginStats_${e}`)}catch(t){}try{yield this.getStoredCredentials(e)}catch(t){}})}static clearAccountLockout(e){return p(this,null,function*(){try{let i=yield this.getUserEmail(e);if(!i){i={"demo-user-123":"demo@carexps.com","super-user-456":"elmfarrell@yahoo.com","pierre-user-789":"pierre@phaetonai.com"}[e]}if(i)try{yield Di.from("failed_login_attempts").delete().eq("email",i)}catch(t){}const n=`loginStats_${e}`,r={loginAttempts:0,lastLogin:void 0,lockoutUntil:void 0};if(localStorage.setItem(n,JSON.stringify(r)),i)try{const e=localStorage.getItem("failed_login_attempts");if(e){let t=JSON.parse(e);t.length;t=t.filter(e=>e.email!==i),localStorage.setItem("failed_login_attempts",JSON.stringify(t))}}catch(s){localStorage.removeItem("failed_login_attempts")}try{yield Di.from("users").update({last_login:(new Date).toISOString()}).eq("id",e)}catch(s){}return{status:"success",data:!0}}catch(s){return{status:"error",error:s.message||"Failed to clear account lockout"}}})}static forceClearLockout(e,t){return p(this,null,function*(){try{if(!t&&!(t=yield this.getUserEmail(e))){t={"demo-user-123":"demo@carexps.com","super-user-456":"elmfarrell@yahoo.com","pierre-user-789":"pierre@phaetonai.com"}[e]}if(localStorage.removeItem(`loginStats_${e}`),localStorage.removeItem(`userCredentials_${e}`),t){const e=localStorage.getItem("failed_login_attempts");if(e)try{let s=JSON.parse(e);s=s.filter(e=>e.email!==t),localStorage.setItem("failed_login_attempts",JSON.stringify(s))}catch(Tx){localStorage.removeItem("failed_login_attempts")}}const s={loginAttempts:0,lastLogin:void 0,lockoutUntil:void 0};localStorage.setItem(`loginStats_${e}`,JSON.stringify(s))}catch(s){}})}static debugLockoutStatus(e){return p(this,null,function*(){try{let t=yield this.getUserEmail(e);if(!t){t={"demo-user-123":"demo@carexps.com","super-user-456":"elmfarrell@yahoo.com","pierre-user-789":"pierre@phaetonai.com"}[e]}const s=yield this.getUserLoginStats(e),i=localStorage.getItem(`loginStats_${e}`),n=localStorage.getItem("failed_login_attempts");return{userId:e,userEmail:t,loginStats:s,isCurrentlyLocked:s.isLocked,localStorageData:{loginStats:i?JSON.parse(i):null,failedAttempts:n?JSON.parse(n):null}}}catch(t){return{userId:e,userEmail:null,loginStats:{loginAttempts:0,isLocked:!1},isCurrentlyLocked:!1,localStorageData:null}}})}static fixDoubleEncryptedPasswords(){return p(this,null,function*(){try{const s={fixed:0,errors:[]},i=yield this.loadSystemUsers();if("error"===i.status)return{status:"error",error:`Failed to load users: ${i.error}`};const n=i.data||[];for(const r of n)try{const t=yield this.getUserCredentials(r.id);if(!t)continue;try{const e=yield z.decryptString(t.password),i=(yield z.decryptString(e),{email:t.email,password:e,tempPassword:t.tempPassword||!1});yield this.saveUserCredentials(r.id,i),s.fixed++}catch(e){}}catch(t){const e=`Failed to fix password for user ${r.email}: ${t.message}`;s.errors.push(e)}return yield W.logSecurityEvent("PASSWORD_DOUBLE_ENCRYPTION_FIX","users",!0,{usersFixed:s.fixed,errors:s.errors.length}),{status:"success",data:s}}catch(t){return yield W.logSecurityEvent("PASSWORD_DOUBLE_ENCRYPTION_FIX_FAILED","users",!1,{error:t.message}),{status:"error",error:t.message}}})}static cleanupDuplicateUsers(){return p(this,null,function*(){var e,t;try{yield W.logSecurityEvent("DUPLICATE_CLEANUP_START","users",!0);const s=yield zi.removeDuplicateUsers();return"error"===s.status||(yield W.logSecurityEvent("DUPLICATE_CLEANUP_COMPLETED","users",!0,{removedCount:(null==(e=s.data)?void 0:e.removed)||0,remainingCount:(null==(t=s.data)?void 0:t.remaining)||0})),s}catch(s){return yield W.logSecurityEvent("DUPLICATE_CLEANUP_FAILED","users",!1,{error:s.message}),{status:"error",error:s.message}}})}static initializeDefaultUsers(){return p(this,null,function*(){try{const{data:e,error:t}=yield Di.from("users").select("id").eq("role","admin").eq("is_active",!0);if(t)throw new Error(`Failed to check for admin users: ${t.message}`);if(e&&e.length>0)return{status:"success"};const s={email:"admin@carexps.com",name:"System Administrator",role:"admin",mfa_enabled:!0,settings:{theme:"dark",notifications:{email:!0,sms:!0,push:!0,in_app:!0,call_alerts:!0,sms_alerts:!0,security_alerts:!0}}},i={email:"admin@carexps.com",password:"ChangeMe123!",tempPassword:!0},n=yield this.createSystemUser(s,i);if("error"===n.status)throw new Error(`Failed to create default admin: ${n.error}`);return yield W.logSecurityEvent("DEFAULT_ADMIN_CREATED","users",!0,{email:s.email}),{status:"success"}}catch(e){return yield W.logSecurityEvent("DEFAULT_ADMIN_CREATE_FAILED","users",!1,{error:e.message}),{status:"error",error:e.message}}})}}f(Ew,"MAX_LOGIN_ATTEMPTS",3),f(Ew,"LOCKOUT_DURATION",18e5);const jw=Ew;class Pw{static clearUserCredentials(e,t){localStorage.removeItem(`userCredentials_${e}`);const s={"pierre-user-789":"c550502f-c39d-4bb3-bb8c-d193657fdb24","super-user-456":"","demo-user-123":""}[e];s&&localStorage.removeItem(`userCredentials_${s}`)}static setUserPassword(e,t,s){return p(this,null,function*(){try{const i=yield z.encryptString(s),n={email:t,password:i,tempPassword:!1},r=yield z.encryptString(JSON.stringify(n));localStorage.setItem(`userCredentials_${e}`,r);const a={"pierre-user-789":"c550502f-c39d-4bb3-bb8c-d193657fdb24","super-user-456":"","demo-user-123":""}[e];a&&localStorage.setItem(`userCredentials_${a}`,r)}catch(i){}})}static checkStoredCredentials(e){return p(this,null,function*(){try{const t=localStorage.getItem(`userCredentials_${e}`);if(t){const e=yield z.decryptString(t),s=JSON.parse(e);if(s.password)try{yield z.decryptString(s.password)}catch(Tx){}}const s={"pierre-user-789":"c550502f-c39d-4bb3-bb8c-d193657fdb24","super-user-456":"","demo-user-123":""}[e];if(s){localStorage.getItem(`userCredentials_${s}`)}}catch(t){}})}}"undefined"!=typeof window&&(window.PasswordDebugger={clearUserCredentials:(e,t)=>Pw.clearUserCredentials(e,t),setUserPassword:(e,t,s)=>Pw.setUserPassword(e,t,s),checkStoredCredentials:e=>Pw.checkStoredCredentials(e)},window.setUserPassword=(e,t,s)=>p(void 0,null,function*(){return yield Pw.setUserPassword(e,t,s)}),window.checkCredentials=e=>p(void 0,null,function*(){return yield Pw.checkStoredCredentials(e)}));const Iw=()=>{const[e,t]=v.useState([]),[s,i]=v.useState(!1),[n,r]=v.useState(!1),[a,o]=v.useState(null),l=e=>{if(!e)return"Never";try{const t=new Date(e);if(isNaN(t.getTime()))return"Never";const s=t.toLocaleDateString();return`${s} at ${t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`}catch(t){return"Never"}},[c,h]=v.useState({name:"",email:"",password:"",role:"healthcare_provider"}),[f,m]=v.useState("");v.useEffect(()=>{g()},[]);const g=()=>p(void 0,null,function*(){try{const e=yield jw.loadSystemUsers();"success"===e.status&&e.data&&t(e.data.map(e=>{var t,s,i,n;return{id:e.id,name:e.name,email:e.email,role:e.role,isLocked:"elmfarrell@yahoo.com"!==(null==(t=e.email)?void 0:t.toLowerCase())&&"pierre@phaetonai.com"!==(null==(s=e.email)?void 0:s.toLowerCase())&&"demo@carexps.com"!==(null==(i=e.email)?void 0:i.toLowerCase())&&"guest@email.com"!==(null==(n=e.email)?void 0:n.toLowerCase())&&(e.isLocked||!1),lastLogin:e.lastLogin}}))}catch(e){}});return F.jsxs("div",{className:"space-y-6",children:[F.jsxs("div",{className:"flex justify-between items-center",children:[F.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"User Management"}),F.jsxs("button",{onClick:()=>r(!0),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2",disabled:s,children:[F.jsx(wl,{className:"w-4 h-4"}),"Add User"]})]}),n&&F.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg border border-gray-200",children:[F.jsx("h4",{className:"font-medium mb-3",children:"Add New User"}),F.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[F.jsx("input",{type:"text",placeholder:"Name",value:c.name,onChange:e=>h(u(d({},c),{name:e.target.value})),className:"px-3 py-2 border rounded"}),F.jsx("input",{type:"email",placeholder:"Email",value:c.email,onChange:e=>h(u(d({},c),{email:e.target.value})),className:"px-3 py-2 border rounded"}),F.jsx("input",{type:"password",placeholder:"Password",value:c.password,onChange:e=>h(u(d({},c),{password:e.target.value})),className:"px-3 py-2 border rounded"}),F.jsxs("select",{value:c.role,onChange:e=>h(u(d({},c),{role:e.target.value})),className:"px-3 py-2 border rounded",children:[F.jsx("option",{value:"healthcare_provider",children:"Healthcare Provider"}),F.jsx("option",{value:"admin",children:"Admin"}),F.jsx("option",{value:"super_user",children:"Super User"}),F.jsx("option",{value:"staff",children:"Staff"})]})]}),F.jsxs("div",{className:"mt-3 flex gap-2",children:[F.jsx("button",{onClick:()=>p(void 0,null,function*(){if(c.name&&c.email&&c.password){i(!0);try{const e={name:c.name,email:c.email,role:c.role,mfa_enabled:!1,settings:{}},t={email:c.email,password:c.password,tempPassword:!1},s=yield jw.createSystemUser(e,t);"success"===s.status?(alert(`User ${c.email} created successfully!`),r(!1),h({name:"",email:"",password:"",role:"healthcare_provider"}),yield g()):alert(`Failed to create user: ${s.error}`)}catch(e){alert(`Error creating user: ${e.message}`)}finally{i(!1)}}else alert("Please fill in all fields")}),className:"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700",disabled:s,children:"Create User"}),F.jsx("button",{onClick:()=>{r(!1),h({name:"",email:"",password:"",role:"healthcare_provider"})},className:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600",children:"Cancel"})]})]}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[F.jsxs("table",{className:"w-full",children:[F.jsx("thead",{className:"bg-gray-50 border-b",children:F.jsxs("tr",{children:[F.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-700",children:"Name"}),F.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-700",children:"Email"}),F.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-700",children:"Role"}),F.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-700",children:"Last Login"}),F.jsx("th",{className:"px-4 py-3 text-left text-sm font-medium text-gray-700",children:"Status"}),F.jsx("th",{className:"px-4 py-3 text-right text-sm font-medium text-gray-700",children:"Actions"})]})}),F.jsx("tbody",{children:e.map(e=>F.jsxs(S.Fragment,{children:[F.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[F.jsx("td",{className:"px-4 py-3 text-sm",children:e.name}),F.jsx("td",{className:"px-4 py-3 text-sm",children:e.email}),F.jsx("td",{className:"px-4 py-3 text-sm",children:F.jsx("span",{className:"px-2 py-1 text-xs rounded-full "+("super_user"===e.role?"bg-purple-100 text-purple-700":"admin"===e.role?"bg-blue-100 text-blue-700":"healthcare_provider"===e.role?"bg-green-100 text-green-700":"bg-gray-100 text-gray-700"),children:e.role.replace("_"," ")})}),F.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:F.jsx("span",{className:e.lastLogin?"":"text-gray-400",children:l(e.lastLogin)})}),F.jsx("td",{className:"px-4 py-3 text-sm",children:e.isLocked?F.jsxs("span",{className:"text-red-600 flex items-center gap-1",children:[F.jsx(qo,{className:"w-3 h-3"})," Locked"]}):F.jsx("span",{className:"text-green-600",children:"Active"})}),F.jsx("td",{className:"px-4 py-3 text-sm text-right",children:F.jsxs("div",{className:"flex justify-end gap-2",children:[F.jsx("button",{onClick:()=>o(e.id),className:"p-1 text-purple-600 hover:bg-purple-50 rounded",title:"Change Password",children:F.jsx(Mo,{className:"w-4 h-4"})}),e.isLocked&&F.jsx("button",{onClick:()=>{return t=e.id,s=e.email,p(void 0,null,function*(){i(!0);try{yield jw.clearAccountLockout(t),alert(`Account ${s} unlocked successfully`),yield g()}catch(e){alert(`Failed to unlock account: ${e.message}`)}finally{i(!1)}});var t,s},className:"p-1 text-green-600 hover:bg-green-50 rounded",title:"Unlock Account",children:F.jsx(Bo,{className:"w-4 h-4"})}),F.jsx("button",{onClick:()=>{return t=e.id,s=e.email,p(void 0,null,function*(){if(confirm(`Are you sure you want to delete ${s}?`)){i(!0);try{const e=yield jw.deleteSystemUser(t);"success"===e.status?(alert(`User ${s} deleted successfully`),yield g()):alert(`Failed to delete user: ${e.error}`)}catch(e){alert(`Error deleting user: ${e.message}`)}finally{i(!1)}}});var t,s},className:"p-1 text-red-600 hover:bg-red-50 rounded",title:"Delete User",children:F.jsx(gl,{className:"w-4 h-4"})})]})})]}),a===e.id&&F.jsx("tr",{children:F.jsx("td",{colSpan:6,className:"px-4 py-3 bg-purple-50",children:F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsx("span",{className:"text-sm font-medium",children:"New Password:"}),F.jsx("input",{type:"password",value:f,onChange:e=>m(e.target.value),className:"px-3 py-1 border rounded flex-1 max-w-xs",placeholder:"Enter new password"}),F.jsx("button",{onClick:()=>{return t=e.id,s=e.email,p(void 0,null,function*(){if(f){i(!0);try{yield Pw.setUserPassword(t,s,f),alert(`Password changed successfully for ${s}`),o(null),m("")}catch(e){alert(`Failed to change password: ${e.message}`)}finally{i(!1)}}else alert("Please enter a new password")});var t,s},className:"px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700",disabled:s,children:"Set Password"}),F.jsx("button",{onClick:()=>{o(null),m("")},className:"px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600",children:"Cancel"})]})})})]},e.id))})]}),0===e.length&&F.jsx("div",{className:"p-8 text-center text-gray-500",children:"No users found"})]})]})},Lw=({user:e})=>{var t,s,i,n,r,a,o;const[l,c]=v.useState("profile"),[h,f]=v.useState(!1),[m,g]=v.useState("idle"),[y,b]=v.useState(null),[x,w]=v.useState("synced"),[S,k]=v.useState({theme:"light",mfaEnabled:!1,refreshInterval:3e4}),[_,C]=v.useState(null),[N,T]=v.useState(null),[A,E]=v.useState(!1),[j,P]=v.useState([]),[I,L]=v.useState(!1),R=[{id:"profile",name:"Profile",icon:Sl},{id:"security",name:"Security",icon:cl},{id:"api",name:"API Configuration",icon:Mo},{id:"appearance",name:"Appearance",icon:Xo},{id:"audit",name:"Audit Logs",icon:Oo},..."super_user"===(null==e?void 0:e.role)?[{id:"users",name:"User Management",icon:Sl}]:[]];v.useEffect(()=>{p(void 0,null,function*(){var t,s,i,n;f(!0);try{const a=yield ql.getUserSettingsWithCache(e.id);if("success"===a.status&&a.data){const o=a.data;let l=!1;try{l=yield ho.hasMFAEnabled(e.id)}catch(r){l=(null==e?void 0:e.mfa_enabled)||!1}const c={theme:o.theme||"light",mfaEnabled:l,refreshInterval:3e4,sessionTimeout:(null==(t=o.security_preferences)?void 0:t.session_timeout)||15,notifications:o.notifications||{calls:!0,sms:!0,system:!0},retellApiKey:null==(s=o.retell_config)?void 0:s.api_key,callAgentId:null==(i=o.retell_config)?void 0:i.call_agent_id,smsAgentId:null==(n=o.retell_config)?void 0:n.sms_agent_id};k(c)}else{const t=localStorage.getItem(`settings_${e.id}`);let s=!1;try{s=yield ho.hasMFAEnabled(e.id)}catch(r){s=(null==e?void 0:e.mfa_enabled)||!1}let i={theme:"light",mfaEnabled:s,refreshInterval:3e4};if(t)try{const e=JSON.parse(t);i=d(d({},i),e),i.mfaEnabled=s}catch(r){}k(i),(i.retellApiKey||i.callAgentId||i.smsAgentId)&&$l.updateCredentials(i.retellApiKey,i.callAgentId,i.smsAgentId)}}catch(r){const t=r instanceof Error?r.message:"Unknown error";t.includes("Failed to fetch")||t.includes("fetch")||t.includes("Connection refused")?w("offline"):(w("error"),b(`Failed to load settings from cloud: ${t}`)),k({theme:"light",mfaEnabled:(null==e?void 0:e.mfa_enabled)||!1,refreshInterval:3e4,sessionTimeout:15,notifications:{calls:!0,sms:!0,system:!0}})}finally{f(!1)}}),ql.initializeSync();const t=ql.subscribeToUserSettings(e.id,t=>{var s,i,n,r;const a={theme:t.theme||"light",mfaEnabled:(null==e?void 0:e.mfa_enabled)||!1,refreshInterval:3e4,sessionTimeout:(null==(s=t.security_preferences)?void 0:s.session_timeout)||15,notifications:t.notifications||{calls:!0,sms:!0,system:!0},retellApiKey:null==(i=t.retell_config)?void 0:i.api_key,callAgentId:null==(n=t.retell_config)?void 0:n.call_agent_id,smsAgentId:null==(r=t.retell_config)?void 0:r.sms_agent_id};k(a),(a.retellApiKey||a.callAgentId||a.smsAgentId)&&$l.updateCredentials(a.retellApiKey,a.callAgentId,a.smsAgentId)});return p(void 0,null,function*(){try{const t=yield qi.syncAvatarAcrossDevices(e.id);let s=null;s="success"===t.status&&t.data?t.data:yield qi.getAvatarUrl(e.id),s&&!N&&T(s)}catch(t){(null==e?void 0:e.avatar)&&!N&&T(e.avatar)}}),()=>{t()}},[e.id,null==e?void 0:e.mfa_enabled,null==e?void 0:e.avatar]);const O=t=>p(void 0,null,function*(){var s,i,n;g("saving"),w("syncing"),f(!0),b(null);try{const r=d(d({},S),t);k(r);const a={theme:r.theme,notifications:r.notifications||{email:!0,sms:!1,push:!0,in_app:!0,call_alerts:!0,sms_alerts:!0,security_alerts:!0},security_preferences:{session_timeout:r.sessionTimeout||15,require_mfa:r.mfaEnabled||!1,password_expiry_reminder:!0,login_notifications:!0},retell_config:{api_key:r.retellApiKey,call_agent_id:r.callAgentId,sms_agent_id:r.smsAgentId}},o=yield ql.updateUserSettingsSync(e.id,a,!0);if("success"===o.status)localStorage.setItem(`settings_${e.id}`,JSON.stringify(r)),g("saved"),w("synced"),setTimeout(()=>g("idle"),2e3);else{localStorage.setItem(`settings_${e.id}`,JSON.stringify(r));(null==(s=o.error)?void 0:s.includes("Failed to fetch"))||(null==(i=o.error)?void 0:i.includes("fetch"))||(null==(n=o.error)?void 0:n.includes("Connection refused"))?(g("saved"),w("offline"),setTimeout(()=>g("idle"),2e3)):(g("error"),w("error"),b(`Failed to sync to cloud: ${o.error}. Settings saved locally only.`),setTimeout(()=>g("idle"),3e3)),setTimeout(()=>{b(null)},5e3)}}catch(r){localStorage.setItem(`settings_${e.id}`,JSON.stringify(S));const t=r instanceof Error?r.message:"Unknown error";t.includes("Failed to fetch")||t.includes("fetch")||t.includes("Connection refused")?(g("saved"),w("offline"),setTimeout(()=>g("idle"),2e3)):(g("error"),w("error"),b(`Settings update failed: ${t}`),setTimeout(()=>g("idle"),3e3)),setTimeout(()=>{b(null)},5e3)}finally{f(!1)}}),D=e=>p(void 0,null,function*(){yield O({theme:e})}),M=t=>p(void 0,null,function*(){try{if(t){const t=yield ho.hasMFASetup(e.id),s=yield ho.hasMFAEnabled(e.id);if(t&&!s){if(!(yield ho.enableMFA(e.id)))return void E(!0)}else if(!t)return void E(!0)}else if(!t){(yield ho.hasMFAEnabled(e.id))&&(yield ho.disableMFA(e.id))}}catch(s){if(yield ho.forceSyncFromCloud(e.id))return void(yield M(t))}g("saving"),f(!0);try{yield new Promise(e=>setTimeout(e,1e3));const i=u(d({},e),{mfa_enabled:t});localStorage.setItem("currentUser",JSON.stringify(i));const n=localStorage.getItem("systemUsers");if(n)try{const s=JSON.parse(n).map(s=>s.id===e.id?u(d({},s),{mfa_enabled:t}):s);localStorage.setItem("systemUsers",JSON.stringify(s))}catch(s){}k(e=>u(d({},e),{mfaEnabled:t}));const r=u(d({},S),{mfaEnabled:t});localStorage.setItem(`settings_${e.id}`,JSON.stringify(r)),setTimeout(()=>{k(e=>u(d({},e),{mfaEnabled:t}))},100),g("saved"),setTimeout(()=>g("idle"),2e3),setTimeout(()=>{window.location.reload()},1e3)}catch(s){g("idle")}finally{f(!1)}});v.useEffect(()=>{"audit"===l&&p(void 0,null,function*(){L(!0);try{const e=yield W.getAuditLogs({limit:50,startDate:new Date(Date.now()-2592e6)});P(e.entries)}catch(e){}finally{L(!1)}})},[l]);const U=(e,t)=>p(void 0,null,function*(){const s=u(d({},null==S?void 0:S.notifications),{[e]:t});yield O({notifications:s})});return F.jsxs("div",{className:"p-6 space-y-6",children:[F.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:[F.jsxs("div",{children:[F.jsxs("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-2",children:[F.jsx(ol,{className:"w-7 h-7 text-blue-600"}),"Settings"]}),F.jsx("p",{className:"text-gray-600 mt-1",children:"Manage your account preferences and security settings"})]}),F.jsxs("div",{className:"mt-4 sm:mt-0 flex flex-col items-end gap-2",children:["idle"!==m&&F.jsx("div",{className:"flex items-center gap-2",children:"saving"===m?F.jsxs(F.Fragment,{children:[F.jsx("div",{className:"w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}),F.jsx("span",{className:"text-sm text-gray-600",children:"Saving..."})]}):"saved"===m?F.jsxs(F.Fragment,{children:[F.jsx(So,{className:"w-4 h-4 text-green-600"}),F.jsx("span",{className:"text-sm text-green-600",children:"Saved"})]}):"error"===m?F.jsxs(F.Fragment,{children:[F.jsx(bl,{className:"w-4 h-4 text-red-600"}),F.jsx("span",{className:"text-sm text-red-600",children:"Error"})]}):null}),F.jsx("div",{className:"flex items-center gap-2",children:"synced"===x?F.jsxs(F.Fragment,{children:[F.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),F.jsx("span",{className:"text-xs text-gray-500",children:"Synced"})]}):"syncing"===x?F.jsxs(F.Fragment,{children:[F.jsx("div",{className:"w-2 h-2 rounded-full bg-blue-500 animate-pulse"}),F.jsx("span",{className:"text-xs text-gray-500",children:"Syncing..."})]}):"offline"===x?F.jsxs(F.Fragment,{children:[F.jsx("div",{className:"w-2 h-2 rounded-full bg-yellow-500"}),F.jsx("span",{className:"text-xs text-gray-500",children:"Offline Mode"})]}):"error"===x?F.jsxs(F.Fragment,{children:[F.jsx("div",{className:"w-2 h-2 rounded-full bg-red-500"}),F.jsx("span",{className:"text-xs text-gray-500",children:"Sync Error"})]}):null})]})]}),y&&F.jsxs("div",{className:"border rounded-lg p-4 flex items-start gap-3 "+("offline"===x?"bg-blue-50 border-blue-200":"bg-red-50 border-red-200"),children:[F.jsx(bl,{className:"w-5 h-5 flex-shrink-0 mt-0.5 "+("offline"===x?"text-blue-600":"text-red-600")}),F.jsxs("div",{className:"flex-1",children:[F.jsx("h4",{className:"text-sm font-medium "+("offline"===x?"text-blue-800":"text-red-800"),children:"offline"===x?"Offline Mode":"Settings Error"}),F.jsx("p",{className:"text-sm mt-1 "+("offline"===x?"text-blue-700":"text-red-700"),children:y}),"offline"===x&&F.jsx("p",{className:"text-xs text-blue-600 mt-2",children:"💡 All settings are still functional and will be saved to your browser. To enable cloud sync, set up a Supabase database connection."})]}),F.jsx("button",{onClick:()=>b(null),className:"p-1 hover:opacity-75 "+("offline"===x?"text-blue-600":"text-red-600"),children:"×"})]}),F.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-6",children:[F.jsx("div",{className:"lg:col-span-1",children:F.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-0",children:F.jsx("nav",{className:"space-y-1",children:R.map(e=>{const t=e.icon;return F.jsxs("button",{onClick:()=>c(e.id),className:"w-full flex items-center gap-3 px-4 py-3 text-left transition-colors first:rounded-t-lg last:rounded-b-lg "+(l===e.id?"bg-blue-50 text-blue-700 border-r-2 border-blue-500":"text-gray-600 hover:text-gray-900 hover:bg-gray-50"),children:[F.jsx(t,{className:"w-5 h-5"}),F.jsx("span",{className:"font-medium",children:e.name})]},e.id)})})})}),F.jsxs("div",{className:"lg:col-span-3",children:["profile"===l&&F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[F.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Profile Information"}),F.jsxs("div",{className:"space-y-6",children:[F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-900 mb-3",children:"Profile Picture"}),F.jsxs("div",{className:"flex items-start gap-4",children:[F.jsxs("div",{className:"relative",children:[F.jsx("div",{className:"w-20 h-20 rounded-full overflow-hidden bg-gray-100 flex items-center justify-center",children:N||(null==e?void 0:e.avatar)?F.jsx("img",{src:N||(null==e?void 0:e.avatar),alt:"Profile",className:"w-full h-full object-cover",style:{backgroundColor:"#ffffff"}}):F.jsx(Sl,{className:"w-8 h-8 text-gray-400"})}),(N||(null==e?void 0:e.avatar))&&F.jsx("button",{onClick:()=>p(void 0,null,function*(){g("saving"),f(!0);try{const t=yield qi.removeAvatar(e.id);if("error"===t.status)throw new Error(t.error);g("saved"),setTimeout(()=>g("idle"),2e3),T(null),window.dispatchEvent(new Event("userDataUpdated"))}catch(t){g("idle"),alert(`Failed to remove avatar: ${t instanceof Error?t.message:"Unknown error"}`)}finally{f(!1)}}),disabled:h,className:"absolute -top-1 -right-1 w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs hover:bg-red-600 transition-colors disabled:opacity-50",children:"×"})]}),F.jsxs("div",{className:"flex-1",children:[F.jsxs("div",{className:"flex gap-3",children:[F.jsxs("label",{className:"cursor-pointer",children:[F.jsx("input",{type:"file",accept:"image/*",onChange:e=>{var t;const s=null==(t=e.target.files)?void 0:t[0];if(s){if(s.size>5242880)return void alert("File size must be less than 5MB");if(!s.type.startsWith("image/"))return void alert("Please select an image file");C(s);const e=new FileReader;e.onload=e=>{var t;T(null==(t=e.target)?void 0:t.result)},e.readAsDataURL(s)}},className:"hidden",disabled:h}),F.jsxs("div",{className:"flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors text-gray-700 text-sm font-medium",children:[F.jsx(xo,{className:"w-4 h-4"}),"Choose Photo"]})]}),_&&F.jsxs("button",{onClick:()=>p(void 0,null,function*(){if(_&&N){g("saving"),f(!0);try{const t=yield qi.uploadAvatar(e.id,N);if("error"===t.status)throw new Error(t.error);g("saved"),setTimeout(()=>g("idle"),2e3),C(null),T(t.data),window.dispatchEvent(new Event("userDataUpdated"))}catch(t){g("idle"),alert(`Failed to upload avatar: ${t instanceof Error?t.message:"Unknown error"}`)}finally{f(!1)}}}),disabled:h,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm font-medium disabled:opacity-50",children:[F.jsx(xl,{className:"w-4 h-4"}),h?"Uploading...":"Upload"]})]}),F.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"JPG, PNG or GIF (max 5MB). Recommended size: 200x200px"}),_&&F.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:["Selected: ",_.name]})]})]})]}),F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-900 mb-2",children:"Full Name"}),F.jsx("input",{type:"text",value:(null==e?void 0:e.name)||"Dr. Sarah Johnson",readOnly:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 focus:outline-none"})]}),F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-900 mb-2",children:"Email Address"}),F.jsx("input",{type:"email",value:(null==e?void 0:e.email)||"demo@carexps.com",readOnly:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 focus:outline-none"})]}),F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-900 mb-2",children:"Role"}),F.jsx("input",{type:"text",value:(null==(t=null==e?void 0:e.role)?void 0:t.replace("_"," "))||"Healthcare Provider",readOnly:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-900 focus:outline-none capitalize"})]}),F.jsx("div",{className:"pt-4 border-t border-gray-200",children:F.jsx("p",{className:"text-sm text-gray-600",children:"Profile information is managed by your organization's IT administrator. Contact them to make changes."})})]})]}),"security"===l&&F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[F.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Security Settings"}),F.jsxs("div",{className:"space-y-6",children:[F.jsxs("div",{className:"flex items-center justify-between",children:[F.jsxs("div",{className:"flex-1",children:[F.jsx("h3",{className:"font-medium text-gray-900",children:"Multi-Factor Authentication"}),F.jsx("p",{className:"text-sm text-gray-600",children:"Add an extra layer of security to your account with TOTP authenticator"}),(null==S?void 0:S.mfaEnabled)&&F.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[F.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),F.jsx("span",{className:"text-xs text-green-600",children:"MFA is properly configured"})]})]}),F.jsxs("div",{className:"flex items-center gap-3",children:[!(null==S?void 0:S.mfaEnabled)&&F.jsxs("button",{onClick:()=>E(!0),className:"flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm",children:[F.jsx(il,{className:"w-4 h-4"}),"Setup MFA"]}),F.jsx("button",{onClick:()=>M(!(null==S?void 0:S.mfaEnabled)),disabled:h,className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${(null==S?void 0:S.mfaEnabled)?"bg-green-600":"bg-gray-300"} disabled:opacity-50`,children:F.jsx("span",{className:"inline-block h-4 w-4 transform rounded-full bg-white transition-transform "+((null==S?void 0:S.mfaEnabled)?"translate-x-6":"translate-x-1")})})]})]}),F.jsxs("div",{className:"flex items-center justify-between",children:[F.jsxs("div",{className:"flex-1",children:[F.jsx("h3",{className:"font-medium text-gray-900",children:"Session Timeout"}),F.jsx("p",{className:"text-sm text-gray-600",children:"Automatically log out after inactivity (HIPAA required)"})]}),F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsxs("select",{value:(null==S?void 0:S.sessionTimeout)||15,onChange:e=>{return t=Number(e.target.value),p(void 0,null,function*(){yield O({sessionTimeout:t})});var t},className:"px-3 py-1 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[F.jsx("option",{value:5,children:"5 minutes"}),F.jsx("option",{value:10,children:"10 minutes"}),F.jsx("option",{value:15,children:"15 minutes"}),F.jsx("option",{value:30,children:"30 minutes"}),F.jsx("option",{value:60,children:"1 hour"})]}),F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),F.jsx("span",{className:"text-sm text-gray-600",children:"Active"})]})]})]}),F.jsxs("div",{className:"flex items-center justify-between",children:[F.jsxs("div",{children:[F.jsx("h3",{className:"font-medium text-gray-900",children:"Data Encryption"}),F.jsx("p",{className:"text-sm text-gray-600",children:"All data is encrypted with AES-256 encryption"})]}),F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx("div",{className:"w-2 h-2 rounded-full bg-green-500"}),F.jsx("span",{className:"text-sm text-gray-600",children:"Active"})]})]})]})]}),"api"===l&&F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[F.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"API Configuration"}),F.jsx("p",{className:"text-sm text-gray-600 mb-6",children:"Configure your API credentials for call and SMS services."}),F.jsxs("div",{className:"space-y-6",children:[F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"API Key"}),F.jsxs("div",{className:"flex gap-3",children:[F.jsx("input",{type:"password",value:(null==S?void 0:S.retellApiKey)||"",onChange:e=>{return t=e.target.value,p(void 0,null,function*(){const e={retellApiKey:t};yield O(e);const s=d(d({},S),e);$l.updateCredentials(t,s.callAgentId,s.smsAgentId),window.dispatchEvent(new Event("apiSettingsUpdated"))});var t},placeholder:"Enter your API key",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),F.jsxs("button",{onClick:()=>p(void 0,null,function*(){if(null==S?void 0:S.retellApiKey)try{$l.updateCredentials(S.retellApiKey,S.callAgentId,S.smsAgentId);const e=yield $l.testConnection();e.success?alert("API connection successful!"):alert(`API connection failed: ${e.message}`)}catch(e){alert(`API connection test failed: ${e instanceof Error?e.message:"Unknown error"}`)}else alert("Please enter your API key first")}),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2",children:[F.jsx(Uo,{className:"w-4 h-4"}),"Test Connection"]})]}),F.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Your API key is encrypted and stored securely"})]}),F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Call Agent ID"}),F.jsx("input",{type:"text",value:(null==S?void 0:S.callAgentId)||"",onChange:e=>{return t=e.target.value,p(void 0,null,function*(){const e={callAgentId:t};yield O(e);const s=d(d({},S),e);$l.updateCredentials(s.retellApiKey,t,s.smsAgentId),window.dispatchEvent(new Event("apiSettingsUpdated"))});var t},placeholder:"Enter your Call Agent ID",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),F.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"This agent will be used for all outbound calls"})]}),F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"SMS / Chat Agent ID"}),F.jsx("input",{type:"text",value:(null==S?void 0:S.smsAgentId)||"",onChange:e=>{return t=e.target.value,p(void 0,null,function*(){const e={smsAgentId:t};yield O(e);const s=d(d({},S),e);$l.updateCredentials(s.retellApiKey,s.callAgentId,t),window.dispatchEvent(new Event("apiSettingsUpdated"))});var t},placeholder:"Enter your SMS/Chat Agent ID",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),F.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"This agent will be used for all SMS and chat conversations"})]}),F.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[F.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[F.jsx(Mo,{className:"w-5 h-5 text-blue-600"}),F.jsx("h3",{className:"font-medium text-blue-900",children:"API Status"})]}),F.jsxs("div",{className:"space-y-2",children:[F.jsxs("div",{className:"flex items-center justify-between",children:[F.jsx("span",{className:"text-sm text-blue-700",children:"API Key"}),F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx("div",{className:"w-2 h-2 rounded-full "+((null==S?void 0:S.retellApiKey)?"bg-green-500":"bg-gray-400")}),F.jsx("span",{className:"text-xs text-blue-600",children:(null==S?void 0:S.retellApiKey)?"Configured":"Not configured"})]})]}),F.jsxs("div",{className:"flex items-center justify-between",children:[F.jsx("span",{className:"text-sm text-blue-700",children:"Call Agent ID"}),F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx("div",{className:"w-2 h-2 rounded-full "+((null==S?void 0:S.callAgentId)?"bg-green-500":"bg-gray-400")}),F.jsx("span",{className:"text-xs text-blue-600",children:(null==S?void 0:S.callAgentId)?"Configured":"Not configured"})]})]}),F.jsxs("div",{className:"flex items-center justify-between",children:[F.jsx("span",{className:"text-sm text-blue-700",children:"SMS Agent ID"}),F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx("div",{className:"w-2 h-2 rounded-full "+((null==S?void 0:S.smsAgentId)?"bg-green-500":"bg-gray-400")}),F.jsx("span",{className:"text-xs text-blue-600",children:(null==S?void 0:S.smsAgentId)?"Configured":"Not configured"})]})]})]})]})]})]}),"notifications"===l&&F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[F.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Notification Preferences"}),F.jsxs("div",{className:"space-y-4",children:[F.jsxs("div",{className:"flex items-center justify-between",children:[F.jsxs("div",{children:[F.jsx("h3",{className:"font-medium text-gray-900",children:"Call Notifications"}),F.jsx("p",{className:"text-sm text-gray-600",children:"Get notified about incoming and missed calls"})]}),F.jsx("button",{onClick:()=>{var e;return U("calls",!(null==(e=null==S?void 0:S.notifications)?void 0:e.calls))},disabled:h,className:"relative inline-flex h-6 w-11 items-center rounded-full transition-colors "+((null==(s=null==S?void 0:S.notifications)?void 0:s.calls)?"bg-blue-500":"bg-gray-300"),children:F.jsx("span",{className:"inline-block h-4 w-4 transform rounded-full bg-white transition-transform "+((null==(i=null==S?void 0:S.notifications)?void 0:i.calls)?"translate-x-6":"translate-x-1")})})]}),F.jsxs("div",{className:"flex items-center justify-between",children:[F.jsxs("div",{children:[F.jsx("h3",{className:"font-medium text-gray-900",children:"SMS Notifications"}),F.jsx("p",{className:"text-sm text-gray-600",children:"Get notified about new SMS messages"})]}),F.jsx("button",{onClick:()=>{var e;return U("sms",!(null==(e=null==S?void 0:S.notifications)?void 0:e.sms))},disabled:h,className:"relative inline-flex h-6 w-11 items-center rounded-full transition-colors "+((null==(n=null==S?void 0:S.notifications)?void 0:n.sms)?"bg-blue-500":"bg-gray-300"),children:F.jsx("span",{className:"inline-block h-4 w-4 transform rounded-full bg-white transition-transform "+((null==(r=null==S?void 0:S.notifications)?void 0:r.sms)?"translate-x-6":"translate-x-1")})})]}),F.jsxs("div",{className:"flex items-center justify-between",children:[F.jsxs("div",{children:[F.jsx("h3",{className:"font-medium text-gray-900",children:"System Alerts"}),F.jsx("p",{className:"text-sm text-gray-600",children:"Get notified about system maintenance and security alerts"})]}),F.jsx("button",{onClick:()=>{var e;return U("system",!(null==(e=null==S?void 0:S.notifications)?void 0:e.system))},disabled:h,className:"relative inline-flex h-6 w-11 items-center rounded-full transition-colors "+((null==(a=null==S?void 0:S.notifications)?void 0:a.system)?"bg-blue-500":"bg-gray-300"),children:F.jsx("span",{className:"inline-block h-4 w-4 transform rounded-full bg-white transition-transform "+((null==(o=null==S?void 0:S.notifications)?void 0:o.system)?"translate-x-6":"translate-x-1")})})]})]})]}),"appearance"===l&&F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[F.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Appearance Settings"}),F.jsxs("div",{className:"space-y-6",children:[F.jsxs("div",{children:[F.jsx("h3",{className:"font-medium text-gray-900 mb-3",children:"Theme"}),F.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[F.jsxs("button",{onClick:()=>D("light"),disabled:h,className:"flex flex-col items-center gap-2 p-4 border-2 rounded-lg transition-colors "+("light"===(null==S?void 0:S.theme)?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),children:[F.jsx(fl,{className:"w-6 h-6"}),F.jsx("span",{className:"text-sm font-medium",children:"Light"})]}),F.jsxs("button",{onClick:()=>D("dark"),disabled:h,className:"flex flex-col items-center gap-2 p-4 border-2 rounded-lg transition-colors "+("dark"===(null==S?void 0:S.theme)?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),children:[F.jsx(Yo,{className:"w-6 h-6"}),F.jsx("span",{className:"text-sm font-medium",children:"Dark"})]}),F.jsxs("button",{onClick:()=>D("auto"),disabled:h,className:"flex flex-col items-center gap-2 p-4 border-2 rounded-lg transition-colors "+("auto"===(null==S?void 0:S.theme)?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"),children:[F.jsx(Ko,{className:"w-6 h-6"}),F.jsx("span",{className:"text-sm font-medium",children:"Auto"})]})]})]}),F.jsx("div",{className:"pt-4 border-t border-gray-200",children:F.jsxs("div",{className:"flex items-center gap-2 text-sm text-green-600",children:[F.jsx(dl,{className:"w-4 h-4"}),F.jsx("span",{children:"Settings sync across all your devices"})]})}),F.jsxs("div",{className:"pt-4 border-t border-gray-200",children:[F.jsx("h3",{className:"font-medium text-gray-900 mb-3",children:"Debug & Testing"}),F.jsxs("div",{className:"space-y-3",children:[F.jsxs("button",{onClick:()=>p(void 0,null,function*(){try{const t=yield ql.getUserSettings(e.id);return"success"===t.status?(w("synced"),!0):(w("error"),b(`Database connection failed: ${t.error}`),!1)}catch(t){return w("error"),b(`Database connection error: ${t instanceof Error?t.message:"Unknown error"}`),!1}}),disabled:h,className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",children:[F.jsx(Uo,{className:"w-4 h-4"}),"Test Database Connection"]}),F.jsxs("button",{onClick:()=>p(void 0,null,function*(){const e={theme:"light"===(null==S?void 0:S.theme)?"dark":"light"};yield O(e)}),disabled:h,className:"w-full flex items-center justify-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50",children:[F.jsx(So,{className:"w-4 h-4"}),"Test Settings Persistence"]}),F.jsxs("div",{className:"text-xs text-gray-500 space-y-1",children:[F.jsx("p",{children:'• Use "Test Database Connection" to verify Supabase connectivity'}),F.jsx("p",{children:'• Use "Test Settings Persistence" to toggle theme and verify sync'}),F.jsx("p",{children:"• Watch browser console for detailed logging"}),F.jsx("p",{children:"• Check sync status indicator in header"})]})]})]})]})]}),"audit"===l&&F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:[F.jsxs("div",{className:"flex items-center justify-between mb-4",children:[F.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"HIPAA Audit Logs"}),F.jsxs("button",{onClick:()=>p(void 0,null,function*(){try{const e=yield W.exportAuditLogs({startDate:new Date(Date.now()-2592e6),limit:1e3},"json"),t=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=`audit-logs-${(new Date).toISOString().split("T")[0]}.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}catch(e){alert("Failed to download audit logs. Please try again.")}}),disabled:I,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50",children:[F.jsx(Io,{className:"w-4 h-4"}),"Download Logs"]})]}),F.jsx("div",{className:"mb-4",children:F.jsx("p",{className:"text-sm text-gray-600",children:"Complete audit trail of all system access and PHI data operations. Required for HIPAA compliance and security monitoring."})}),I?F.jsxs("div",{className:"flex items-center justify-center py-8",children:[F.jsx("div",{className:"w-6 h-6 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"}),F.jsx("span",{className:"ml-2 text-gray-600",children:"Loading audit logs..."})]}):j.length>0?F.jsxs("div",{className:"space-y-4",children:[F.jsx("div",{className:"overflow-x-auto",children:F.jsxs("table",{className:"w-full text-sm",children:[F.jsx("thead",{children:F.jsxs("tr",{className:"border-b border-gray-200",children:[F.jsx("th",{className:"text-left py-2 px-3 font-medium text-gray-900",children:"Timestamp"}),F.jsx("th",{className:"text-left py-2 px-3 font-medium text-gray-900",children:"User"}),F.jsx("th",{className:"text-left py-2 px-3 font-medium text-gray-900",children:"Action"}),F.jsx("th",{className:"text-left py-2 px-3 font-medium text-gray-900",children:"Resource"}),F.jsx("th",{className:"text-left py-2 px-3 font-medium text-gray-900",children:"PHI"}),F.jsx("th",{className:"text-left py-2 px-3 font-medium text-gray-900",children:"Outcome"})]})}),F.jsx("tbody",{children:j.slice(0,20).map((e,t)=>F.jsxs("tr",{className:"border-b border-gray-100 hover:bg-gray-50",children:[F.jsx("td",{className:"py-2 px-3 text-gray-900",children:new Date(e.timestamp).toLocaleString()}),F.jsx("td",{className:"py-2 px-3 text-gray-900",children:e.user_name}),F.jsx("td",{className:"py-2 px-3",children:F.jsx("span",{className:"px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800",children:e.action})}),F.jsx("td",{className:"py-2 px-3 text-gray-900",children:e.resource_type}),F.jsx("td",{className:"py-2 px-3",children:e.phi_accessed?F.jsxs("span",{className:"flex items-center gap-1 text-orange-600",children:[F.jsx(bl,{className:"w-3 h-3"}),"Yes"]}):F.jsx("span",{className:"text-gray-500",children:"No"})}),F.jsx("td",{className:"py-2 px-3",children:F.jsx("span",{className:"px-2 py-1 text-xs rounded-full "+("SUCCESS"===e.outcome?"bg-green-100 text-green-800":"FAILURE"===e.outcome?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"),children:e.outcome})})]},t))})]})}),j.length>20&&F.jsx("div",{className:"text-center py-4 border-t border-gray-200",children:F.jsx("p",{className:"text-sm text-gray-600",children:"Showing first 20 entries. Download complete logs for full history."})}),F.jsxs("div",{className:"bg-blue-50 rounded-lg p-4",children:[F.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"Audit Log Information"}),F.jsxs("ul",{className:"text-sm text-blue-800 space-y-1",children:[F.jsx("li",{children:"• All PHI access is logged and encrypted"}),F.jsx("li",{children:"• Logs are retained for 6+ years per HIPAA requirements"}),F.jsx("li",{children:"• Failed access attempts are automatically flagged"}),F.jsx("li",{children:"• Regular compliance reports are generated"})]})]})]}):F.jsxs("div",{className:"text-center py-8",children:[F.jsx(Oo,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),F.jsx("p",{className:"text-gray-500",children:"No audit logs available"}),F.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Audit logging will begin when users start accessing the system"})]})]}),"users"===l&&"super_user"===(null==e?void 0:e.role)&&F.jsx("div",{className:"bg-white rounded-lg border border-gray-200 p-6",children:F.jsx(Iw,{})})]})]}),A&&F.jsx(Aw,{user:e,onComplete:(t,s)=>p(void 0,null,function*(){E(!1),g("saving"),f(!0);try{let n=!1,r=0;const a=3;for(;!n&&r<a;){try{yield new Promise(e=>setTimeout(e,500));const t=yield ho.hasMFASetup(e.id);if(n=yield ho.hasMFAEnabled(e.id),!t&&!n){if(yield ho.forceSyncFromCloud(e.id))n=yield ho.hasMFAEnabled(e.id);else{(localStorage.getItem(`mfa_simple_${e.id}`)||localStorage.getItem(`mfa_data_${e.id}`)||localStorage.getItem(`mfa_global_${e.id}`))&&(n=!0)}}}catch(i){}r++}n||(t||s&&s.length>0)&&(n=!0);const o=u(d({},e),{mfa_enabled:n});localStorage.setItem("currentUser",JSON.stringify(o));const l=localStorage.getItem("systemUsers");if(l)try{const t=JSON.parse(l).map(t=>t.id===e.id?u(d({},t),{mfa_enabled:n}):t);localStorage.setItem("systemUsers",JSON.stringify(t))}catch(i){}k(e=>u(d({},e),{mfaEnabled:n}));const c=u(d({},S),{mfaEnabled:n});localStorage.setItem(`settings_${e.id}`,JSON.stringify(c)),setTimeout(()=>{k(e=>u(d({},e),{mfaEnabled:n}))},100),g("saved"),setTimeout(()=>g("idle"),2e3),window.dispatchEvent(new Event("userDataUpdated"))}catch(i){g("error"),setTimeout(()=>g("idle"),3e3)}finally{f(!1)}}),onCancel:()=>E(!1)})]})};"undefined"!=typeof window&&(window.runDuplicateTests=()=>p(void 0,null,function*(){const e=yield function(){return p(this,null,function*(){var e,t,s,i;let n=0,r=0;const a=[];try{const l=(null==(e=(yield jw.loadSystemUsers()).data)?void 0:e.length)||0;try{const e={email:"demo@carexps.com",name:"Duplicate Test User",role:"staff",mfa_enabled:!1,settings:{theme:"light",notifications:{}}},s={email:"demo@carexps.com",password:"TestPassword123!",tempPassword:!1},i=yield jw.createSystemUser(e,s);"error"===i.status&&(null==(t=i.error)?void 0:t.includes("already exists"))?(a.push("✅ Test 1: Duplicate email prevention works"),n++):(a.push("❌ Test 1: Duplicate email was allowed!"),r++)}catch(o){a.push(`❌ Test 1: Error occurred - ${o}`),r++}try{const e=yield zi.userExistsByEmail("demo@carexps.com");"success"===e.status&&!0===e.data?(a.push("✅ Test 2: userExistsByEmail function works"),n++):(a.push("❌ Test 2: userExistsByEmail function failed"),r++)}catch(o){a.push(`❌ Test 2: Error occurred - ${o}`),r++}try{const e=`test-${Date.now()}@nonexistent.com`,t=yield zi.userExistsByEmail(e);"success"===t.status&&!1===t.data?(a.push("✅ Test 3: userExistsByEmail correctly handles non-existing emails"),n++):(a.push("❌ Test 3: userExistsByEmail gave false positive"),r++)}catch(o){a.push(`❌ Test 3: Error occurred - ${o}`),r++}try{const e=yield jw.cleanupDuplicateUsers();if("success"===e.status){const{removed:t,remaining:i}=e.data||{removed:0,remaining:0};a.push(`✅ Test 4: Cleanup function works (removed ${t} duplicates)`),n++;return{success:0===r,message:0===r?"All duplicate prevention tests passed!":`${r} tests failed`,details:{initialUserCount:l,finalUserCount:(null==(s=(yield jw.loadSystemUsers()).data)?void 0:s.length)||0,duplicatesRemoved:t||0,testsPassed:n,testsFailed:r}}}a.push(`❌ Test 4: Cleanup failed - ${e.error}`),r++}catch(o){a.push(`❌ Test 4: Error occurred - ${o}`),r++}return{success:0===r,message:0===r?"All duplicate prevention tests passed!":`${r} tests failed`,details:{initialUserCount:l,finalUserCount:(null==(i=(yield jw.loadSystemUsers()).data)?void 0:i.length)||0,duplicatesRemoved:0,testsPassed:n,testsFailed:r}}}catch(o){return{success:!1,message:`Test suite failed: ${o.message}`,details:{initialUserCount:0,finalUserCount:0,duplicatesRemoved:0,testsPassed:n,testsFailed:r+1}}}})}();return function(e){const{success:t,message:s,details:i}=e,n=t?`✅ All tests passed!\n\nDuplicate prevention is working correctly.\n\nInitial users: ${i.initialUserCount}\nFinal users: ${i.finalUserCount}\nDuplicates removed: ${i.duplicatesRemoved}`:`❌ ${i.testsFailed} tests failed!\n\nDuplicate prevention may not be working correctly.\n\nTests passed: ${i.testsPassed}\nTests failed: ${i.testsFailed}`;alert(n)}(e),e}));const Rw=class{static fixAllUserIssues(){return p(this,null,function*(){const e={userRecreationFixed:!1,profileImageFixed:!1,issues:[],fixes:[]};try{const s=yield this.fixUserRecreationIssues();e.userRecreationFixed=s.success,e.issues.push(...s.issues),e.fixes.push(...s.fixes);const i=yield this.fixProfileImageIssues();e.profileImageFixed=i.success,e.issues.push(...i.issues),e.fixes.push(...i.fixes);try{const t=yield jw.cleanupDuplicateUsers();if("success"===t.status){const{removed:s,remaining:i}=t.data||{removed:0,remaining:0};s>0&&e.fixes.push(`Removed ${s} duplicate users, ${i} remain`)}}catch(t){e.issues.push(`Duplicate cleanup failed: ${t}`)}return e}catch(t){return e.issues.push(`Global fix error: ${t.message}`),e}})}static fixUserRecreationIssues(){return p(this,null,function*(){const e=[],t=[];try{const i=localStorage.getItem("deletedUsers"),n=localStorage.getItem("deletedUserEmails");i||(localStorage.setItem("deletedUsers",JSON.stringify([])),t.push("Initialized deleted users tracking")),n||(localStorage.setItem("deletedUserEmails",JSON.stringify([])),t.push("Initialized deleted emails tracking"));const r=localStorage.getItem("systemUsers");if(r)try{const s=JSON.parse(r),i=new Map;s.forEach(e=>{const t=e.email.toLowerCase();i.set(t,(i.get(t)||0)+1)});const n=Array.from(i.entries()).filter(([e,t])=>t>1);n.length>0&&(e.push(`Found ${n.length} email addresses with multiple users`),t.push("Flagged duplicate emails for cleanup"))}catch(s){e.push("Failed to parse stored users for duplicate check")}return{success:0===e.length,issues:e,fixes:t}}catch(s){return e.push(`User recreation fix error: ${s.message}`),{success:!1,issues:e,fixes:t}}})}static fixProfileImageIssues(){return p(this,null,function*(){const e=[],t=[];try{const i=yield zi.loadSystemUsers();if("success"!==i.status)return e.push("Failed to load users for avatar check"),{success:!1,issues:e,fixes:t};const n=i.data||[];let r=0;for(const a of n)try{const i=yield qi.getAvatarUrl(a.id),n=!!a.avatar;if(i&&!n){const e=yield zi.fixProfileImagePersistence(a.id);"success"===e.status&&e.data&&(r++,t.push(`Fixed avatar persistence for ${a.name}`))}else if(!i&&n)try{const e=localStorage.getItem(`userProfile_${a.id}`);if(e){const s=JSON.parse(e);delete s.avatar,localStorage.setItem(`userProfile_${a.id}`,JSON.stringify(s)),t.push(`Cleaned up invalid avatar reference for ${a.name}`)}}catch(s){e.push(`Failed to clean avatar reference for ${a.name}`)}const o=localStorage.getItem(`avatar_${a.id}`),l=localStorage.getItem(`avatar_data_${a.id}`);if(l&&!o)try{const e={url:l,storagePath:`avatar_data_${a.id}`,uploadedAt:(new Date).toISOString(),synchronized:!0};localStorage.setItem(`avatar_${a.id}`,JSON.stringify(e)),t.push(`Restored avatar cache for ${a.name}`)}catch(s){e.push(`Failed to restore avatar cache for ${a.name}`)}}catch(s){e.push(`Error checking avatar for ${a.name}: ${s}`)}return r>0&&t.push(`Fixed avatar persistence for ${r} users`),{success:0===e.length,issues:e,fixes:t}}catch(s){return e.push(`Profile image fix error: ${s.message}`),{success:!1,issues:e,fixes:t}}})}static diagnosePotentialIssues(){return p(this,null,function*(){const e=[];let t=!1,s=!1;try{const n=localStorage.getItem("deletedUsers"),r=localStorage.getItem("deletedUserEmails");n&&r||(t=!0,e.push("Deletion tracking not properly initialized"));const a=localStorage.getItem("systemUsers");if(a)try{const s=JSON.parse(a),i=new Set,n=[];s.forEach(e=>{const t=e.email.toLowerCase();i.has(t)&&n.push(t),i.add(t)}),n.length>0&&(t=!0,e.push(`Found duplicate emails: ${n.join(", ")}`))}catch(i){e.push("Unable to parse user data for duplicate check")}try{const t=yield zi.loadSystemUsers();if("success"===t.status){const i=t.data||[];for(const t of i.slice(0,5)){const i=yield qi.getAvatarUrl(t.id),n=t.avatar;(i&&!n||!i&&n)&&(s=!0,e.push(`Avatar mismatch for ${t.name}: storage=${!!i}, profile=${!!n}`))}}}catch(i){e.push(`Avatar consistency check failed: ${i}`)}return{userRecreationRisk:t,profileImageIssues:s,details:e}}catch(i){return e.push(`Diagnostic error: ${i.message}`),{userRecreationRisk:!0,profileImageIssues:!0,details:e}}})}static forceRefreshAllUserData(){return p(this,null,function*(){try{zi.clearCache();const t=yield zi.loadSystemUsers();if("success"!==t.status)return!1;const s=t.data||[];for(const i of s)try{yield qi.syncAvatarAcrossDevices(i.id)}catch(e){}return window.dispatchEvent(new Event("userDataUpdated")),!0}catch(e){return!1}})}};"undefined"!=typeof window&&(window.fixUserIssues=Rw);const Ow=class{static runAllTests(){return p(this,null,function*(){const e=[];e.push(yield this.testDeletionTracking()),e.push(yield this.testDemoUserRecreationPrevention()),e.push(yield this.testProfileImagePersistence()),e.push(yield this.testComprehensiveFix());e.filter(e=>e.passed).length,e.length;return e})}static testDeletionTracking(){return p(this,null,function*(){var e;try{localStorage.removeItem("deletedUsers"),localStorage.removeItem("deletedUserEmails");const t={email:"test-deletion@carexps.com",name:"Test Deletion User",role:"staff",mfa_enabled:!1,settings:{}},s=yield jw.createSystemUser(t,{email:t.email,password:"testpass123",tempPassword:!1});if("success"!==s.status)return{testName:"Deletion Tracking",passed:!1,details:`Failed to create test user: ${s.error}`};const i=s.data.id,n=yield jw.deleteSystemUser(i);if("success"!==n.status)return{testName:"Deletion Tracking",passed:!1,details:`Failed to delete test user: ${n.error}`};const r=localStorage.getItem("deletedUsers"),a=localStorage.getItem("deletedUserEmails"),o=!!r&&JSON.parse(r).includes(i),l=!!a&&JSON.parse(a).includes(t.email.toLowerCase()),c=yield zi.loadSystemUsers(),d="success"===c.status&&(null==(e=c.data)?void 0:e.some(e=>e.id===i||e.email.toLowerCase()===t.email.toLowerCase()));return{testName:"Deletion Tracking",passed:o&&l&&!d,details:`ID tracked: ${o}, Email tracked: ${l}, Still exists: ${d}`}}catch(t){return{testName:"Deletion Tracking",passed:!1,details:`Test error: ${t.message}`}}})}static testDemoUserRecreationPrevention(){return p(this,null,function*(){var e;try{const t="demo-user-123",s="demo@carexps.com",i=JSON.parse(localStorage.getItem("deletedUsers")||"[]"),n=JSON.parse(localStorage.getItem("deletedUserEmails")||"[]");i.includes(t)||i.push(t),n.includes(s.toLowerCase())||n.push(s.toLowerCase()),localStorage.setItem("deletedUsers",JSON.stringify(i)),localStorage.setItem("deletedUserEmails",JSON.stringify(n));const r=localStorage.getItem("systemUsers");if(r){const e=JSON.parse(r).filter(e=>e.id!==t&&e.email.toLowerCase()!==s.toLowerCase());localStorage.setItem("systemUsers",JSON.stringify(e))}const a=yield zi.loadSystemUsers();if("success"!==a.status)return{testName:"Demo User Recreation Prevention",passed:!1,details:`Failed to load users: ${a.error}`};const o=null==(e=a.data)?void 0:e.some(e=>e.id===t||e.email.toLowerCase()===s.toLowerCase());return{testName:"Demo User Recreation Prevention",passed:!o,details:o?"Demo user was recreated despite deletion tracking":"Demo user correctly stayed deleted"}}catch(t){return{testName:"Demo User Recreation Prevention",passed:!1,details:`Test error: ${t.message}`}}})}static testProfileImagePersistence(){return p(this,null,function*(){var e;try{const t={email:"test-avatar@carexps.com",name:"Test Avatar User",role:"staff",mfa_enabled:!1,settings:{}},s=yield jw.createSystemUser(t,{email:t.email,password:"testpass123",tempPassword:!1});if("success"!==s.status)return{testName:"Profile Image Persistence",passed:!1,details:`Failed to create test user: ${s.error}`};const i=s.data.id,n="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==",r={id:i,email:t.email,name:t.name,role:t.role,mfa_enabled:!1,settings:{},avatar:n},a=yield zi.saveUserProfile(r);if("success"!==a.status)return{testName:"Profile Image Persistence",passed:!1,details:`Failed to save profile with avatar: ${a.error}`};const o=yield zi.loadSystemUsers();if("success"!==o.status)return{testName:"Profile Image Persistence",passed:!1,details:`Failed to reload users: ${o.error}`};const l=null==(e=o.data)?void 0:e.find(e=>e.id===i),c=!!(null==l?void 0:l.avatar);return yield jw.deleteSystemUser(i),{testName:"Profile Image Persistence",passed:c,details:c?"Avatar correctly persisted after save/reload":"Avatar was lost after save/reload"}}catch(t){return{testName:"Profile Image Persistence",passed:!1,details:`Test error: ${t.message}`}}})}static testComprehensiveFix(){return p(this,null,function*(){try{const e=yield Rw.diagnosePotentialIssues(),t=yield Rw.fixAllUserIssues(),s=e.userRecreationRisk||e.profileImageIssues,i=t.fixes.length>0,n=t.issues.length>0;return{testName:"Comprehensive Fix Utility",passed:!n&&(i||!s),details:`Issues detected: ${s}, Fixes applied: ${i}, Errors: ${n}. Details: ${t.fixes.join("; ")}`}}catch(e){return{testName:"Comprehensive Fix Utility",passed:!1,details:`Test error: ${e.message}`}}})}static displayResults(e){e.forEach((e,t)=>{e.passed});const t=e.filter(e=>e.passed).length,s=e.length,i=`User Fixes Test Results:\n\n${e.map((e,t)=>`${t+1}. ${e.testName}: ${e.passed?"PASS":"FAIL"}\n   ${e.details}`).join("\n\n")}\n\nSummary: ${t}/${s} tests passed`;alert(i)}};"undefined"!=typeof window&&(window.testUserFixes=Ow);class Dw{static fixAllAuthenticationIssues(){return p(this,null,function*(){const e={success:!0,message:"",details:[],usersFixed:0,errors:[]};try{e.details.push("Step 1: Fixing double-encrypted passwords...");const t=yield jw.fixDoubleEncryptedPasswords();"success"===t.status&&t.data?(e.usersFixed+=t.data.fixed,e.details.push(`✅ Fixed double-encrypted passwords for ${t.data.fixed} users`),e.errors.push(...t.data.errors)):(e.details.push(`❌ Double encryption fix failed: ${t.error}`),e.errors.push(t.error||"Unknown double encryption fix error")),e.details.push("Step 2: Ensuring demo user credentials are properly set...");const s=yield this.fixDemoUserCredentials();e.details.push(...s.details),e.usersFixed+=s.usersFixed,e.errors.push(...s.errors),e.details.push("Step 3: Clearing account lockouts...");const i=yield this.clearAllLockouts();e.details.push(...i.details),e.errors.push(...i.errors),e.details.push("Step 4: Validating authentication for all users...");const n=yield this.validateAllUserAuthentication();return e.details.push(...n.details),e.errors.push(...n.errors),e.details.push("Step 5: Cleaning up localStorage inconsistencies..."),this.cleanupLocalStorage(),e.details.push("✅ localStorage cleanup completed"),0===e.errors.length?e.message=`✅ Authentication system fix completed successfully! Fixed ${e.usersFixed} users.`:(e.success=!1,e.message=`⚠️ Fix completed with ${e.errors.length} errors. Fixed ${e.usersFixed} users.`),yield W.logSecurityEvent("AUTHENTICATION_SYSTEM_FIX","system",e.success,{usersFixed:e.usersFixed,errorsCount:e.errors.length,details:e.details.slice(-5)}),e}catch(t){return e.success=!1,e.message=`❌ Authentication fix failed: ${t.message}`,e.errors.push(t.message),e}})}static fixUserAuthentication(e,t,s){return p(this,null,function*(){const i={success:!0,message:"",details:[],usersFixed:0,errors:[]};try{const n=yield jw.clearAccountLockout(e);if("success"===n.status?i.details.push("✅ Cleared account lockout"):i.details.push(`⚠️ Could not clear lockout: ${n.error}`),yield jw.forceClearLockout(e,t),i.details.push("✅ Force cleared all lockout data"),s){const t=yield jw.changeUserPassword(e,s);"success"===t.status?(i.details.push("✅ Password reset successfully"),i.usersFixed=1):(i.details.push(`❌ Password reset failed: ${t.error}`),i.errors.push(t.error||"Password reset failed"))}if(s){const e=yield jw.authenticateUser(t,s);"success"===e.status&&e.data?(i.details.push("✅ Authentication test successful"),i.message=`✅ User ${t} authentication fixed successfully!`):(i.details.push("❌ Authentication test failed"),i.errors.push("Authentication test failed after fix"),i.success=!1,i.message=`❌ Failed to fix authentication for ${t}`)}else i.message=`✅ Lockout cleared for ${t}. Test login with existing password.`}catch(n){i.success=!1,i.message=`❌ Failed to fix authentication for ${t}: ${n.message}`,i.errors.push(n.message)}return i})}static fixPierreAuthentication(){return p(this,null,function*(){try{const e=yield zi.getUserByEmail("pierre@phaetonai.com");if("error"===e.status||!e.data)return{success:!1,message:"❌ Pierre user not found - cannot fix authentication",details:["User pierre@phaetonai.com does not exist in the system"],usersFixed:0,errors:["Pierre user not found"]};const t=e.data.id;return yield this.fixUserAuthentication(t,"pierre@phaetonai.com","Pierre123!")}catch(e){return{success:!1,message:`❌ Failed to find Pierre user: ${e.message}`,details:[e.message],usersFixed:0,errors:[e.message]}}})}static testAllUserAuthentication(){return p(this,null,function*(){const e={totalUsers:0,workingAuth:0,failedAuth:0,details:[]};try{const s=yield jw.loadSystemUsers();if("error"===s.status||!s.data)throw new Error("Failed to load users for testing");const i=s.data;e.totalUsers=i.length;const n={"pierre@phaetonai.com":"Pierre123!","demo@carexps.com":"Demo123!","elmfarrell@yahoo.com":"Super123!"};for(const r of i){const s=n[r.email];if(s)try{const t=yield jw.authenticateUser(r.email,s);"success"===t.status&&t.data?(e.workingAuth++,e.details.push({email:r.email,status:"SUCCESS",details:"Authentication successful"})):(e.failedAuth++,e.details.push({email:r.email,status:"FAILED",details:t.error||"Authentication failed"}))}catch(t){e.failedAuth++,e.details.push({email:r.email,status:"ERROR",details:t.message})}else e.details.push({email:r.email,status:"SKIPPED",details:"No test password available"})}}catch(t){}return e})}static fixDemoUserCredentials(){return p(this,null,function*(){const e={usersFixed:0,details:[],errors:[]},t=[{email:"pierre@phaetonai.com",password:"Pierre123!"},{email:"demo@carexps.com",password:"Demo123!"},{email:"elmfarrell@yahoo.com",password:"Super123!"}];for(const i of t)try{const t=yield zi.getUserByEmail(i.email);if("success"===t.status&&t.data){const s=t.data.id,n=yield jw.changeUserPassword(s,i.password);"success"===n.status?(e.usersFixed++,e.details.push(`✅ Reset password for ${i.email} (${s})`)):(e.details.push(`❌ Failed to reset password for ${i.email} (${s})`),e.errors.push(`Password reset failed for ${i.email}: ${n.error}`))}else e.details.push(`⚠️ User ${i.email} not found in system`),e.errors.push(`User ${i.email} not found`)}catch(s){e.details.push(`❌ Error resetting ${i.email}`),e.errors.push(`Error for ${i.email}: ${s.message}`)}return e})}static clearAllLockouts(){return p(this,null,function*(){const e={details:[],errors:[]};try{const s=yield jw.loadSystemUsers();if("error"===s.status||!s.data)return e.errors.push("Failed to load users for lockout clearing"),e;const i=s.data;let n=0;for(const r of i)try{yield jw.forceClearLockout(r.id,r.email),n++}catch(t){e.errors.push(`Failed to clear lockout for ${r.email}: ${t.message}`)}e.details.push(`✅ Cleared lockouts for ${n}/${i.length} users`)}catch(t){e.errors.push(`Lockout clearing failed: ${t.message}`)}return e})}static validateAllUserAuthentication(){return p(this,null,function*(){const e={details:[],errors:[]};try{const t=yield this.testAllUserAuthentication();if(e.details.push(`Authentication test completed: ${t.workingAuth}/${t.totalUsers} users can authenticate`),t.failedAuth>0){e.details.push(`⚠️ ${t.failedAuth} users still have authentication issues`);for(const s of t.details.filter(e=>"FAILED"===e.status||"ERROR"===e.status))e.errors.push(`${s.email}: ${s.details}`)}}catch(t){e.errors.push(`Authentication validation failed: ${t.message}`)}return e})}static cleanupLocalStorage(){try{const t=["failed_login_attempts","deletedUsers","deletedUserEmails"];for(const i of t)try{const e=localStorage.getItem(i);e&&JSON.parse(e)}catch(e){localStorage.removeItem(i)}const s=Object.keys(localStorage);s.filter(e=>e.startsWith("loginStats_")),s.filter(e=>e.startsWith("userCredentials_"))}catch(e){}}}"undefined"!=typeof window&&(window.authFixer={fixAll:()=>Dw.fixAllAuthenticationIssues(),fixPierre:()=>Dw.fixPierreAuthentication(),fixUser:(e,t,s)=>Dw.fixUserAuthentication(e,t,s),testAll:()=>Dw.testAllUserAuthentication()});class Mw{static runFullSystemDiagnostic(){return p(this,null,function*(){const e={timestamp:(new Date).toISOString(),overallHealth:"healthy",usersChecked:0,issuesFound:0,fixesApplied:0,userReports:[],systemIssues:[],recommendations:[]};try{const t=yield jw.loadSystemUsers();if("error"===t.status)return e.systemIssues.push(`Failed to load users: ${t.error}`),e.overallHealth="critical",e;const s=t.data||[];e.usersChecked=s.length;for(const i of s){const t=yield this.diagnoseUser(i.id,i.email);e.userReports.push(t),t.issues.length>0&&(e.issuesFound+=t.issues.length),"critical"===t.status?e.overallHealth="critical":"issues_found"===t.status&&"healthy"===e.overallHealth&&(e.overallHealth="degraded")}return yield this.checkSystemWideIssues(e),this.generateRecommendations(e),e}catch(t){return e.systemIssues.push(`Diagnostic failed: ${t.message}`),e.overallHealth="critical",e}})}static diagnoseUser(e,t){return p(this,null,function*(){const s={userId:e,email:t,issues:[],fixes:[],status:"healthy",passwordStatus:"missing",credentialsFound:!1,lockoutStatus:{isLocked:!1,attempts:0,canClearLockout:!1}};try{const i=yield this.getStoredCredentials(e);if(s.credentialsFound=!!i,!i)return s.issues.push("No credentials found in storage"),s.status="critical",s;yield this.checkPasswordEncryption(i.password,s);const n=yield jw.debugLockoutStatus(e);s.lockoutStatus={isLocked:n.isCurrentlyLocked,attempts:n.loginStats.loginAttempts||0,canClearLockout:n.isCurrentlyLocked},s.lockoutStatus.isLocked&&(s.issues.push("Account is locked out"),s.status="issues_found");const r=yield this.tryDecryptPassword(i.password);if(r){const e=yield jw.authenticateUser(t,r);"success"===e.status&&e.data?0===s.issues.length&&(s.status="healthy"):(s.issues.push("Authentication test failed"),s.status="critical")}}catch(i){s.issues.push(`Diagnosis failed: ${i.message}`),s.status="critical"}return s})}static fixAllAuthenticationIssues(){return p(this,null,function*(){var e,t,s;const i={usersFixed:0,issuesFixed:[],errors:[]};try{const n=yield this.runFullSystemDiagnostic(),r=yield jw.fixDoubleEncryptedPasswords();"success"===r.status&&(i.usersFixed+=(null==(e=r.data)?void 0:e.fixed)||0,(null==(t=r.data)?void 0:t.fixed)&&i.issuesFixed.push(`Fixed double-encrypted passwords for ${r.data.fixed} users`),i.errors.push(...(null==(s=r.data)?void 0:s.errors)||[]));for(const e of n.userReports)if(e.lockoutStatus.isLocked&&e.lockoutStatus.canClearLockout){const t=yield jw.clearAccountLockout(e.userId);"success"===t.status?i.issuesFixed.push(`Cleared lockout for ${e.email}`):i.errors.push(`Failed to clear lockout for ${e.email}: ${t.error}`)}return yield this.fixDemoUserCredentials(i),i}catch(n){return i.errors.push(`Fix process failed: ${n.message}`),i}})}static testUserAuthentication(e,t){return p(this,null,function*(){const s={success:!1,details:[],recommendations:[]};try{const i=yield zi.getUserByEmail(e);if("error"===i.status||!i.data)return s.details.push(`❌ User not found: ${e}`),s.recommendations.push("Create the user account first"),s;const n=i.data;s.details.push(`✅ User found: ${n.name} (${n.id})`);const r=yield jw.debugLockoutStatus(n.id);s.details.push("Lockout status: "+(r.isCurrentlyLocked?"LOCKED":"UNLOCKED")),s.details.push(`Login attempts: ${r.loginStats.loginAttempts||0}`),r.isCurrentlyLocked&&(s.details.push("❌ Account is locked"),s.recommendations.push("Clear account lockout before testing"));const a=yield this.getStoredCredentials(n.id);if(!a)return s.details.push("❌ No credentials found in storage"),s.recommendations.push("Reset user password to create new credentials"),s;s.details.push("✅ Credentials found in storage");const o=yield this.tryDecryptPassword(a.password);if(!o)return s.details.push("❌ Failed to decrypt stored password"),s.recommendations.push("Password may be corrupted - reset password"),s;s.details.push("✅ Password decryption successful"),s.details.push(`Stored password matches input: ${o===t}`);const l=yield jw.authenticateUser(e,t);"success"===l.status&&l.data?(s.success=!0,s.details.push("✅ Authentication successful!")):(s.details.push(`❌ Authentication failed: ${l.error||"Unknown error"}`),s.recommendations.push("Check password and clear any lockouts"))}catch(i){s.details.push(`❌ Test failed: ${i.message}`),s.recommendations.push("Check system logs for detailed error information")}return s})}static resetUserPassword(e,t){return p(this,null,function*(){const s={success:!1,details:[]};try{if(t.length<8)return s.details.push("❌ Password must be at least 8 characters long"),s;"success"===(yield jw.clearAccountLockout(e)).status&&s.details.push("✅ Cleared existing lockouts");const i=yield jw.changeUserPassword(e,t);"success"===i.status?(s.success=!0,s.details.push("✅ Password reset successful"),s.details.push("✅ New credentials saved and encrypted")):s.details.push(`❌ Password reset failed: ${i.error}`)}catch(i){s.details.push(`❌ Password reset failed: ${i.message}`)}return s})}static getStoredCredentials(e){return p(this,null,function*(){try{const{supabase:t}=yield g(()=>p(this,null,function*(){const{supabase:e}=yield Promise.resolve().then(()=>Fi);return{supabase:e}}),void 0),{data:s}=yield t.from("user_profiles").select("encrypted_retell_api_key").eq("user_id",e).single();if(null==s?void 0:s.encrypted_retell_api_key){const e=yield z.decryptString(s.encrypted_retell_api_key);return JSON.parse(e)}}catch(t){}try{const t=localStorage.getItem(`userCredentials_${e}`);if(t){const e=yield z.decryptString(t);return JSON.parse(e)}}catch(t){}return null})}static tryDecryptPassword(e){return p(this,null,function*(){try{return yield z.decryptString(e)}catch(t){return null}})}static checkPasswordEncryption(e,t){return p(this,null,function*(){try{const s=yield z.decryptString(e);try{yield z.decryptString(s),t.issues.push("Password is double-encrypted"),t.passwordStatus="double_encrypted",t.status="issues_found"}catch(Tx){t.passwordStatus="working"}}catch(s){t.issues.push("Password decryption failed - may be corrupted"),t.passwordStatus="corrupted",t.status="critical"}})}static checkSystemWideIssues(e){return p(this,null,function*(){try{(yield z.testEncryption())||e.systemIssues.push("Encryption service is not working properly")}catch(t){e.systemIssues.push("Failed to test encryption service")}try{localStorage.setItem("auth_test","test"),localStorage.removeItem("auth_test")}catch(t){e.systemIssues.push("localStorage is not accessible")}})}static generateRecommendations(e){if(0===e.issuesFound)return void e.recommendations.push("Authentication system is healthy!");e.recommendations.push("Run the comprehensive fix to resolve identified issues");const t=e.userReports.filter(e=>"critical"===e.status);t.length>0&&e.recommendations.push(`${t.length} users have critical authentication issues and need immediate attention`);const s=e.userReports.filter(e=>e.lockoutStatus.isLocked);s.length>0&&e.recommendations.push(`${s.length} users are locked out and need lockout clearance`);const i=e.userReports.filter(e=>"double_encrypted"===e.passwordStatus);i.length>0&&e.recommendations.push(`${i.length} users have double-encrypted passwords that need fixing`)}static fixDemoUserCredentials(e){return p(this,null,function*(){const t=[{email:"pierre@phaetonai.com",password:"Pierre123!"},{email:"demo@carexps.com",password:"Demo123!"},{email:"elmfarrell@yahoo.com",password:"Super123!"}];for(const i of t)try{const t=yield zi.getUserByEmail(i.email);if("success"===t.status&&t.data){const s=t.data.id;if(!(yield this.getStoredCredentials(s))){(yield this.resetUserPassword(s,i.password)).success?e.issuesFixed.push(`Created missing credentials for ${i.email} (${s})`):e.errors.push(`Failed to create credentials for ${i.email} (${s})`)}}else e.errors.push(`User ${i.email} not found in system`)}catch(s){e.errors.push(`Error fixing demo user ${i.email}: ${s.message}`)}})}}"undefined"!=typeof window&&(window.authDebugger={runDiagnostic:()=>Mw.runFullSystemDiagnostic(),fixAll:()=>Mw.fixAllAuthenticationIssues(),testUser:(e,t)=>Mw.testUserAuthentication(e,t),resetPassword:(e,t)=>Mw.resetUserPassword(e,t),diagnosePierre:()=>Mw.testUserAuthentication("pierre@phaetonai.com","Pierre123!"),resetPierre:()=>p(void 0,null,function*(){const e=yield zi.getUserByEmail("pierre@phaetonai.com");return"success"===e.status&&e.data?Mw.resetUserPassword(e.data.id,"Pierre123!"):{success:!1,details:["Pierre user not found"]}})});class Uw{static runFullTestSuite(){return p(this,null,function*(){const e=[];e.push(yield this.testCreateNewUser()),e.push(yield this.testQuickCreateUser()),e.push(yield this.testImmediateAuthentication()),e.push(yield this.testAuthAfterLockoutClear()),e.push(yield this.testCredentialEncryptionDecryption()),e.push(yield this.testPasswordChangeAndReauth()),e.push(yield this.testRecreateDeletedUser());const t=e.filter(e=>e.success).length,s=e.filter(e=>!e.success).length,i=`Authentication Test Suite Complete:\n✅ Passed: ${t}/${e.length}\n❌ Failed: ${s}/${e.length}\n${0===s?"🎉 All tests passed!":"⚠️ Some tests failed - check details below"}`;return{totalTests:e.length,passedTests:t,failedTests:s,results:e,summary:i}})}static testCreateNewUser(){return p(this,null,function*(){const e={testName:"Create New User via UserManagementService",success:!1,details:[],errors:[]};try{const t=`test.user.${Date.now()}@carexps.com`,s="TestPassword123!";e.details.push(`Creating user: ${t}`);const i={email:t,name:"Test User",role:"user",mfa_enabled:!1,settings:{theme:"light",notifications:{}}},n={email:t,password:s,tempPassword:!1},r=yield jw.createSystemUser(i,n);if("success"===r.status&&r.data){e.userId=r.data.id,e.email=t,e.details.push("✅ User created successfully");const i=yield jw.authenticateUser(t,s);"success"===i.status&&i.data?(e.details.push("✅ Authentication successful immediately after creation"),e.success=!0):(e.details.push("❌ Authentication failed after creation"),e.errors.push(i.error||"Authentication failed")),yield this.cleanupTestUser(r.data.id),e.details.push("✅ Test user cleaned up")}else e.details.push("❌ User creation failed"),e.errors.push(r.error||"User creation failed")}catch(t){e.details.push("❌ Test failed with exception"),e.errors.push(t.message)}return e})}static testQuickCreateUser(){return p(this,null,function*(){const e={testName:"Quick Create User Test",success:!1,details:[],errors:[]};try{const t=`quicktest.${Date.now()}@carexps.com`,s="QuickTest123!";e.details.push(`Quick creating user: ${t}`);const i={email:t,name:"Quick Test User",role:"user",mfa_enabled:!1,settings:{theme:"light",notifications:{}}},n={email:t,password:s,tempPassword:!1},r=yield jw.createSystemUser(i,n);if("success"===r.status&&r.data){e.userId=r.data.id,e.email=t,e.details.push("✅ Quick create successful");const i=yield jw.authenticateUser(t,s);"success"===i.status&&i.data?(e.details.push("✅ Authentication works with quick created user"),e.success=!0):(e.details.push("❌ Quick created user cannot authenticate"),e.errors.push(i.error||"Authentication failed")),yield this.cleanupTestUser(r.data.id)}else e.details.push("❌ Quick create failed"),e.errors.push(r.error||"Quick create failed")}catch(t){e.details.push("❌ Quick create test failed"),e.errors.push(t.message)}return e})}static testImmediateAuthentication(){return p(this,null,function*(){const e={testName:"Immediate Authentication Test",success:!1,details:[],errors:[]};try{const t=`immediate.${Date.now()}@carexps.com`,s="Immediate123!",i={email:t,name:"Immediate Test User",role:"user",mfa_enabled:!1,settings:{theme:"light",notifications:{}}},n={email:t,password:s,tempPassword:!1},r=yield jw.createSystemUser(i,n);if("success"===r.status&&r.data){e.userId=r.data.id,e.email=t;for(let i=1;i<=3;i++){const n=yield jw.authenticateUser(t,s);"success"===n.status&&n.data?e.details.push(`✅ Authentication attempt ${i} successful`):(e.details.push(`❌ Authentication attempt ${i} failed`),e.errors.push(`Attempt ${i}: ${n.error}`))}e.success=0===e.errors.length,yield this.cleanupTestUser(r.data.id)}else e.errors.push("User creation failed for immediate auth test")}catch(t){e.errors.push(t.message)}return e})}static testAuthAfterLockoutClear(){return p(this,null,function*(){const e={testName:"Authentication After Lockout Clear",success:!1,details:[],errors:[]};try{const t=`lockout.${Date.now()}@carexps.com`,s="Lockout123!",i={email:t,name:"Lockout Test User",role:"user",mfa_enabled:!1,settings:{theme:"light",notifications:{}}},n={email:t,password:s,tempPassword:!1},r=yield jw.createSystemUser(i,n);if("success"===r.status&&r.data){e.userId=r.data.id,e.email=t;const i=yield jw.clearAccountLockout(r.data.id);if("success"===i.status){e.details.push("✅ Lockout cleared successfully");const i=yield jw.authenticateUser(t,s);"success"===i.status&&i.data?(e.details.push("✅ Authentication successful after lockout clear"),e.success=!0):(e.details.push("❌ Authentication failed after lockout clear"),e.errors.push(i.error||"Auth failed after clear"))}else e.details.push("⚠️ Lockout clear had issues"),e.errors.push(i.error||"Lockout clear failed");yield this.cleanupTestUser(r.data.id)}else e.errors.push("User creation failed for lockout test")}catch(t){e.errors.push(t.message)}return e})}static testCredentialEncryptionDecryption(){return p(this,null,function*(){const e={testName:"Credential Encryption/Decryption Test",success:!1,details:[],errors:[]};try{const t=`encryption.${Date.now()}@carexps.com`,s="Encryption123!",i={email:t,name:"Encryption Test User",role:"user",mfa_enabled:!1,settings:{theme:"light",notifications:{}}},n={email:t,password:s,tempPassword:!1},r=yield jw.createSystemUser(i,n);if("success"===r.status&&r.data){e.userId=r.data.id,e.email=t,yield new Promise(e=>setTimeout(e,100)),e.details.push("✅ User created with encrypted credentials");const i=yield jw.authenticateUser(t,s);"success"===i.status&&i.data?(e.details.push("✅ Encrypted credentials successfully decrypted for authentication"),e.success=!0):(e.details.push("❌ Credential decryption/authentication failed"),e.errors.push(i.error||"Credential decryption failed")),yield this.cleanupTestUser(r.data.id)}else e.errors.push("User creation failed for encryption test")}catch(t){e.errors.push(t.message)}return e})}static testPasswordChangeAndReauth(){return p(this,null,function*(){const e={testName:"Password Change and Re-authentication",success:!1,details:[],errors:[]};try{const t=`pwchange.${Date.now()}@carexps.com`,s="OldPassword123!",i="NewPassword123!",n={email:t,name:"Password Change Test User",role:"user",mfa_enabled:!1,settings:{theme:"light",notifications:{}}},r={email:t,password:s,tempPassword:!1},a=yield jw.createSystemUser(n,r);if("success"===a.status&&a.data){e.userId=a.data.id,e.email=t;const n=yield jw.authenticateUser(t,s);if("success"===n.status){e.details.push("✅ Authentication with original password successful");const n=yield jw.changeUserPassword(a.data.id,i);if("success"===n.status){e.details.push("✅ Password changed successfully");const n=yield jw.authenticateUser(t,i);if("success"===n.status&&n.data){e.details.push("✅ Authentication with new password successful");"success"===(yield jw.authenticateUser(t,s)).status?(e.details.push("❌ Old password still works (security issue)"),e.errors.push("Old password still valid after change")):(e.details.push("✅ Old password correctly rejected"),e.success=!0)}else e.details.push("❌ Authentication with new password failed"),e.errors.push(n.error||"New password auth failed")}else e.details.push("❌ Password change failed"),e.errors.push(n.error||"Password change failed")}else e.details.push("❌ Initial authentication failed"),e.errors.push(n.error||"Initial auth failed");yield this.cleanupTestUser(a.data.id)}else e.errors.push("User creation failed for password change test")}catch(t){e.errors.push(t.message)}return e})}static testRecreateDeletedUser(){return p(this,null,function*(){const e={testName:"Recreate Deleted User Test",success:!1,details:[],errors:[]};try{const t=`recreate.${Date.now()}@carexps.com`,s="Recreate123!",i={email:t,name:"Recreate Test User",role:"user",mfa_enabled:!1,settings:{theme:"light",notifications:{}}},n={email:t,password:s,tempPassword:!1},r=yield jw.createSystemUser(i,n);if("success"===r.status&&r.data){const a=r.data.id;e.details.push("✅ First user creation successful");const o=yield jw.deleteSystemUser(a);if("success"===o.status){e.details.push("✅ User deleted successfully");const r=yield jw.createSystemUser(i,n);if("success"===r.status&&r.data){e.userId=r.data.id,e.details.push("✅ User recreated with same email");const i=yield jw.authenticateUser(t,s);"success"===i.status&&i.data?(e.details.push("✅ Recreated user authentication successful"),e.success=!0):(e.details.push("❌ Recreated user authentication failed"),e.errors.push(i.error||"Recreated user auth failed")),yield this.cleanupTestUser(r.data.id)}else e.details.push("❌ User recreation failed"),e.errors.push(r.error||"Recreation failed")}else e.details.push("❌ User deletion failed"),e.errors.push(o.error||"Deletion failed"),yield this.cleanupTestUser(a)}else e.errors.push("Initial user creation failed for recreate test")}catch(t){e.errors.push(t.message)}return e})}static cleanupTestUser(e){return p(this,null,function*(){try{yield jw.deleteSystemUser(e)}catch(t){}})}static displayTestResults(e){e.results.forEach((e,t)=>{e.details.length>0&&e.details.forEach(e=>{}),e.errors.length>0&&e.errors.forEach(e=>{})});const t=`New User Authentication Test Results:\n\n${e.summary}\n\nFailed Tests:\n${e.results.filter(e=>!e.success).map(e=>`• ${e.testName}`).join("\n")||"None!"}\n\nCheck console for detailed results.`;alert(t)}}"undefined"!=typeof window&&(window.newUserAuthTest={runTests:()=>Uw.runFullTestSuite(),displayResults:e=>Uw.displayTestResults(e)});const Fw=({user:e})=>{const[t,s]=v.useState([]),[i,n]=v.useState(!1),[r,a]=v.useState(null),[o,l]=v.useState(!1),[c,h]=v.useState(""),[f,m]=v.useState(!1),[g,y]=v.useState(!1),[b,x]=v.useState(!1),[w,S]=v.useState({name:"",email:"",password:"",role:"user"}),[k,_]=v.useState({name:"",email:"",password:"",role:"healthcare_provider"}),C="super_user"===(null==e?void 0:e.role),N=e=>{if(!e)return"N/A";try{const t=new Date(e);return isNaN(t.getTime())?"N/A":t.toLocaleDateString()}catch(t){return"N/A"}},T=e=>{if(!e)return"Never";try{const t=new Date(e);if(isNaN(t.getTime()))return"Never";const s=t.toLocaleDateString();return`${s} at ${t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}`}catch(t){return"Never"}};v.useEffect(()=>{A()},[]);const A=()=>p(void 0,null,function*(){l(!0);try{const i=yield jw.loadSystemUsers();if("success"===i.status&&i.data)s(i.data);else{const i=localStorage.getItem("systemUsers");if(i)try{const e=JSON.parse(i).map(e=>u(d({},e),{role:"super_user"===e.role?"admin":e.role,settings:e.settings||{},credentials:void 0,isLocked:!1,loginAttempts:0}));s(e)}catch(e){s([])}else try{const e=yield zi.loadSystemUsers();if("success"===e.status&&e.data){const t=e.data.map(e=>u(d({},e),{credentials:void 0,isLocked:!1,loginAttempts:0}));s(t)}else{s([{id:"super-user-456",email:"elmfarrell@yahoo.com",name:"Dr. Farrell",role:"super_user",mfa_enabled:!1,settings:{theme:"dark",notifications:{}},credentials:void 0,isLocked:!1,loginAttempts:0},{id:"pierre-user-789",email:"pierre@phaetonai.com",name:"Pierre PhaetonAI",role:"super_user",mfa_enabled:!1,settings:{theme:"light",notifications:{calls:!0,sms:!0,system:!0}},credentials:void 0,isLocked:!1,loginAttempts:0},{id:"guest-user-456",email:"guest@email.com",name:"Guest User",role:"user",mfa_enabled:!1,settings:{theme:"light",notifications:{}},credentials:void 0,isLocked:!1,loginAttempts:0}])}}catch(t){s([])}}}catch(e){try{const e=yield zi.loadSystemUsers();if("success"===e.status&&e.data){const t=e.data.map(e=>u(d({},e),{credentials:void 0,isLocked:!1,loginAttempts:0}));s(t)}else s([])}catch(t){s([])}}finally{l(!1)}}),E=()=>{const e=localStorage.getItem("deletedUsers");if(e)try{const t=JSON.parse(e);alert(`Deleted Users:\n${t.join("\n")}\n\nCheck console for full details.`)}catch(t){alert("Error parsing deleted users list")}else alert("No users have been permanently deleted yet.")};"undefined"!=typeof window&&(window.viewDeletedUsers=E);const j=t,P=e=>"super_user"===e?"Super User":"User";return C?F.jsxs("div",{className:"p-6 space-y-6",children:[F.jsx("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between",children:F.jsxs("div",{children:[F.jsxs("h1",{className:"text-2xl font-bold text-gray-900 flex items-center gap-2",children:[F.jsx(Sl,{className:"w-7 h-7 text-blue-600"}),"User Management"]}),F.jsx("p",{className:"text-gray-600 mt-1",children:"Manage system users and their permissions"})]})}),F.jsxs("div",{className:"bg-white rounded-lg border border-gray-200 overflow-hidden",children:[F.jsx("div",{className:"p-4 border-b border-gray-200",children:F.jsxs("h2",{className:"text-lg font-semibold text-gray-900",children:["System Users (",j.length,")"]})}),F.jsxs("div",{className:"divide-y divide-gray-200",children:[j.map(e=>{const t="super_user"===e.role?ll:Sl;return F.jsx("div",{className:"p-4 hover:bg-gray-50",children:F.jsx("div",{className:"flex items-center justify-between",children:F.jsxs("div",{className:"flex items-center gap-3",children:[F.jsx("div",{className:"w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center overflow-hidden",children:e.avatar?F.jsx("img",{src:e.avatar,alt:"Profile",className:"w-full h-full object-cover"}):F.jsx(Sl,{className:"w-5 h-5 text-gray-600"})}),F.jsxs("div",{children:[F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx("h3",{className:"font-medium text-gray-900",children:e.name}),F.jsxs("div",{className:"flex items-center gap-1",children:[F.jsx(t,{className:"w-4 h-4 text-blue-600"}),F.jsx("span",{className:"text-xs text-blue-600 font-medium",children:P(e.role)})]}),F.jsx("div",{className:"px-2 py-1 text-xs rounded-full "+(e.isLocked?"bg-red-100 text-red-800":"bg-green-100 text-green-800"),children:e.isLocked?"Locked":"Active"})]}),F.jsxs("div",{className:"flex items-center gap-4 text-sm text-gray-600 mt-1",children:[F.jsxs("div",{className:"flex items-center gap-1",children:[F.jsx(zo,{className:"w-3 h-3"}),e.email]}),F.jsxs("span",{children:["Created: ",N(e.created_at)]}),e.lastLogin?F.jsxs("span",{children:["Last login: ",T(e.lastLogin)]}):F.jsx("span",{className:"text-gray-400",children:"Last login: Never"})]})]})]})})},e.id)}),0===j.length&&F.jsx("div",{className:"p-8 text-center text-gray-500",children:"No users found."})]})]}),i&&F.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:F.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md",children:[F.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Add New User"}),F.jsxs("div",{className:"space-y-4",children:[F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Full Name"}),F.jsx("input",{type:"text",value:k.name,onChange:e=>_(u(d({},k),{name:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter full name"})]}),F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email Address"}),F.jsx("input",{type:"email",value:k.email,onChange:e=>_(u(d({},k),{email:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter email address"})]}),F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Password"}),F.jsx("input",{type:"password",value:k.password,onChange:e=>_(u(d({},k),{password:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter password",minLength:6}),F.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Password must be at least 6 characters long"})]}),F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),F.jsxs("select",{value:k.role,onChange:e=>_(u(d({},k),{role:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[F.jsx("option",{value:"user",children:"User"}),F.jsx("option",{value:"super_user",children:"Super User"})]})]})]})]})}),r&&F.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:F.jsxs("div",{className:"bg-white rounded-lg p-6 w-full max-w-md",children:[F.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:g?"Change User Password":"Edit User"}),F.jsx("div",{className:"space-y-4",children:g?F.jsxs(F.Fragment,{children:[F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"User"}),F.jsxs("div",{className:"w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-gray-600",children:[r.name," (",r.email,")"]})]}),F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"New Password"}),F.jsx("div",{className:"relative",children:F.jsx("input",{type:f?"text":"password",value:c,onChange:e=>h(e.target.value),placeholder:"Enter new password (min 8 characters)",className:"w-full px-3 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500"})}),F.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Password must be at least 8 characters long"})]})]}):F.jsxs(F.Fragment,{children:[F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Full Name"}),F.jsx("input",{type:"text",value:r.name,onChange:e=>a(u(d({},r),{name:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email Address"}),F.jsx("input",{type:"email",value:r.email,onChange:e=>a(u(d({},r),{email:e.target.value})),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),F.jsxs("div",{children:[F.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Role"}),F.jsxs("select",{value:r.role,onChange:e=>a(u(d({},r),{role:e.target.value})),disabled:r.id===e.id,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100",children:[F.jsx("option",{value:"user",children:"User"}),F.jsx("option",{value:"super_user",children:"Super User"})]}),r.id===e.id&&F.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Cannot change your own role"})]})]})})]})})]}):F.jsx("div",{className:"p-6",children:F.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx(cl,{className:"w-5 h-5 text-yellow-600"}),F.jsx("h3",{className:"font-medium text-yellow-800",children:"Access Restricted"})]}),F.jsx("p",{className:"text-yellow-700 mt-2",children:"Only Super Users can manage user accounts. Regular users and healthcare providers cannot add, edit, or delete users."})]})})};function Bw(){return p(this,null,function*(){try{const e={name:"Guest User",email:"guest@email.com",role:"staff",mfa_enabled:!1,settings:{theme:"light",notifications:{}}},t={email:"guest@email.com",password:"Guest1000!",tempPassword:!1},s=yield jw.createSystemUser(e,t);return"success"===s.status?s.data:null}catch(e){return null}})}function qw(){return p(this,null,function*(){try{const e={name:"Pierre PhaetonAI",email:"pierre@phaetonai.com",role:"admin",mfa_enabled:!1,settings:{theme:"light",notifications:{calls:!0,sms:!0,system:!0}}},t={email:"pierre@phaetonai.com",password:"$Ineed1millie$_carexps",tempPassword:!1},s=yield jw.createSystemUser(e,t);return"success"===s.status?s.data:null}catch(e){return null}})}function $w(){return p(this,null,function*(){try{const t=localStorage.getItem("systemUsers");if(!t)return{removed:0,success:!0};let s=[];try{s=JSON.parse(t)}catch(e){return{removed:0,success:!1}}const i=s.filter(e=>e.email&&"guest@email.com"===e.email.toLowerCase()||e.name&&"guest"===e.name.toLowerCase()||e.id&&e.id.toLowerCase().includes("guest"));if(i.length<=1)return{removed:0,success:!0};i.sort((e,t)=>new Date(e.created_at||0).getTime()-new Date(t.created_at||0).getTime());const n=i[0],r=i.slice(1),a=r.map(e=>e.id),o=s.filter(e=>!a.includes(e.id));return localStorage.setItem("systemUsers",JSON.stringify(o)),a.forEach(e=>{localStorage.removeItem(`userProfile_${e}`)}),{removed:r.length,keptUserId:n.id,success:!0}}catch(t){return{removed:0,success:!1}}})}function zw(){return p(this,null,function*(){try{const t=localStorage.getItem("deletedUsers");let s=[];if(t)try{s=JSON.parse(t)}catch(e){}const i=localStorage.getItem("systemUsers");if(i)try{const e=JSON.parse(i);e.filter(e=>e.email&&"guest@email.com"===e.email.toLowerCase()||e.name&&"guest"===e.name.toLowerCase()||e.id&&e.id.toLowerCase().includes("guest")).forEach(e=>{s.includes(e.id)||s.push(e.id)})}catch(e){}return["guest-user-123","Guest","guest"].forEach(e=>{s.includes(e)||s.push(e)}),localStorage.setItem("deletedUsers",JSON.stringify(s)),!0}catch(t){return!1}})}"undefined"!=typeof window&&(window.createGuestUser=Bw),"undefined"!=typeof window&&(window.createPierreUser=qw),"undefined"!=typeof window&&(window.cleanupDuplicateGuests=$w().addGuestToDeletedList=zw().completeGuestCleanup=function(){return p(this,null,function*(){const e=yield $w(),t=yield zw();if(e.success&&t)try{const e=localStorage.getItem("systemUsers");if(e){const t=JSON.parse(e).filter(e=>!(e.email&&"guest@email.com"===e.email.toLowerCase()||e.name&&"guest"===e.name.toLowerCase()||e.id&&e.id.toLowerCase().includes("guest")));localStorage.setItem("systemUsers",JSON.stringify(t))}}catch(s){}return{duplicatesRemoved:e.removed,addedToDeletedList:t,success:e.success&&t}})});const Hw=[{id:"super-user-456",email:"elmfarrell@yahoo.com",password:"Farrell1000!",name:"Dr. Farrell",role:"super_user"},{id:"pierre-user-789",email:"pierre@phaetonai.com",password:"$Ineed1millie$_carexps",name:"Pierre PhaetonAI",role:"super_user"},{id:"guest-user-456",email:"guest@email.com",password:"Guest1000!",name:"Guest User",role:"staff"}];function Vw(){return p(this,null,function*(){try{for(const t of Hw)try{yield Pw.setUserPassword(t.id,t.email,t.password),yield jw.clearAccountLockout(t.id)}catch(e){}return localStorage.removeItem("failed_login_attempts"),Hw.forEach(e=>{}),{success:!0,users:Hw}}catch(e){return{success:!1,error:e.message}}})}function Gw(){return p(this,null,function*(){const e=[];for(const s of Hw)try{const t=yield jw.authenticateUser(s.email,s.password);"success"===t.status&&t.data?e.push({user:s.name,email:s.email,status:"SUCCESS",message:"Authentication successful"}):e.push({user:s.name,email:s.email,status:"FAILED",message:t.error||"Authentication failed"})}catch(t){e.push({user:s.name,email:s.email,status:"ERROR",message:t.message})}return e.forEach(e=>{"SUCCESS"===e.status||e.status}),e})}"undefined"!=typeof window&&(window.setupAllUserCredentials=Vw().testAllUserAuthentication=Gw);const Jw=({onLogin:e})=>{const[t,s]=v.useState(""),[i,n]=v.useState(""),[r,a]=v.useState(!1),[o,l]=v.useState(!1),[c,d]=v.useState("");S.useEffect(()=>{const e=e=>p(void 0,null,function*(){if(e.ctrlKey&&e.shiftKey&&"U"===e.key){e.preventDefault();try{yield jw.forceClearLockout("super-user-456","elmfarrell@yahoo.com"),yield jw.forceClearLockout("pierre-user-789","pierre@phaetonai.com"),yield jw.forceClearLockout("guest-user-456","guest@email.com"),localStorage.removeItem("failed_login_attempts"),alert("Emergency unlock completed for all demo accounts")}catch(t){alert("Emergency unlock failed - check console for details")}}else if(e.ctrlKey&&e.shiftKey&&"S"===e.key){e.preventDefault();try{const e=yield Vw();e.success?alert("All user credentials have been set up successfully!\n\nCheck console for login details."):alert(`Credential setup failed: ${e.error}`)}catch(t){alert(`Credential setup failed: ${t.message}`)}}else if(e.ctrlKey&&e.shiftKey&&"T"===e.key){e.preventDefault();try{yield Gw(),alert("Authentication test completed - check console for results")}catch(t){alert(`Authentication test failed: ${t.message}`)}}});return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),S.useEffect(()=>{p(void 0,null,function*(){try{yield $w();const t=localStorage.getItem("deletedUsers");let s=[];if(t)try{s=JSON.parse(t)}catch(e){}if(!s.some(e=>e.includes("guest")||e.toLowerCase().includes("guest")||"guest-user-123"===e)){let e=yield zi.getUserByEmail("guest@email.com");if(e.data||(e=yield zi.getUserByEmail("Guest@email.com")),e.data){const t=e.data.id;yield Pw.setUserPassword(t,"guest@email.com","Guest1000!")}else yield Bw()}const i=yield zi.getUserByEmail("pierre@phaetonai.com");if(i.data){const e=i.data.id;yield Pw.setUserPassword(e,"pierre@phaetonai.com","$Ineed1millie$_carexps")}else yield qw()}catch(t){}})},[]);const u=(e,t)=>p(void 0,null,function*(){try{const{encryptionService:s}=yield g(()=>p(void 0,null,function*(){const{encryptionService:e}=yield Promise.resolve().then(()=>H);return{encryptionService:e}}),void 0);let i=localStorage.getItem(`userCredentials_${e}`);if(!i){const t={"pierre-user-789":"c550502f-c39d-4bb3-bb8c-d193657fdb24","super-user-456":"c550502f-c39d-4bb3-bb8c-d193657fdb24"}[e];t&&(i=localStorage.getItem(`userCredentials_${t}`))}if(!i)return!1;const n=yield s.decryptString(i),r=JSON.parse(n);if(r.password){const e=yield s.decryptString(r.password);return t===e}return!1}catch(s){return localStorage.removeItem(`userCredentials_${e}`),!1}}),h=(e,t)=>p(void 0,null,function*(){let s=null;if("elmfarrell@yahoo.com"===e||"pierre@phaetonai.com"===e||"guest@email.com"===e){const t=localStorage.getItem("failed_login_attempts");if(t)try{let s=JSON.parse(t);s=s.filter(t=>t.email!==e),localStorage.setItem("failed_login_attempts",JSON.stringify(s))}catch(i){localStorage.removeItem("failed_login_attempts")}"elmfarrell@yahoo.com"===e?localStorage.removeItem("loginStats_super-user-456"):"pierre@phaetonai.com"===e?localStorage.removeItem("loginStats_pierre-user-789"):"guest@email.com"===e&&localStorage.removeItem("loginStats_guest-user-001")}if("elmfarrell@yahoo.com"===e){((yield u("super-user-456",t))||"Farrell1000!"===t)&&(s={id:"super-user-456",email:"elmfarrell@yahoo.com",name:"Dr. Farrell",role:"super_user",mfa_enabled:!1,settings:{theme:"dark",notifications:{}}})}else if("pierre@phaetonai.com"===e){((yield u("pierre-user-789",t))||"$Ineed1millie$_carexps"===t)&&(s={id:"pierre-user-789",email:"pierre@phaetonai.com",name:"Pierre PhaetonAI",role:"admin",mfa_enabled:!1,settings:{theme:"light",notifications:{calls:!0,sms:!0,system:!0}}})}else if("guest@email.com"===e){((yield u("guest-user-456",t))||"Guest1000!"===t)&&(s={id:"guest-user-456",email:"guest@email.com",name:"Guest User",role:"staff",mfa_enabled:!1,settings:{theme:"light",notifications:{}}})}if(s){try{if("success"===(yield zi.saveUserProfile(s)).status){const e=`loginStats_${s.id}`,t={loginAttempts:0,lastLogin:(new Date).toISOString(),lockoutUntil:void 0};return localStorage.setItem(e,JSON.stringify(t)),localStorage.setItem("currentUser",JSON.stringify({id:s.id,email:s.email,name:s.name,role:s.role,mfa_enabled:s.mfa_enabled})),!0}}catch(i){}const e=`loginStats_${s.id}`,t={loginAttempts:0,lastLogin:(new Date).toISOString(),lockoutUntil:void 0};return localStorage.setItem(e,JSON.stringify(t)),localStorage.setItem("currentUser",JSON.stringify({id:s.id,email:s.email,name:s.name,role:s.role,mfa_enabled:s.mfa_enabled})),!0}return!1});return F.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-gray-100 flex flex-col",children:[F.jsx("div",{className:"flex-1 flex items-center justify-center p-4",children:F.jsxs("div",{className:"max-w-md w-full",children:[F.jsx("div",{className:"text-center mb-8",children:F.jsx("div",{className:"flex justify-center mb-6",children:F.jsx("img",{src:"https://carexps.nexasync.ca/images/Logo.png",alt:"CareXPS Logo",className:"h-16 w-auto object-contain"})})}),F.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-8",children:[F.jsxs("div",{className:"text-center mb-6",children:[F.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Welcome Back"}),F.jsx("p",{className:"text-gray-600",children:"Sign in to your healthcare account"})]}),c&&F.jsxs("div",{className:"mb-6 bg-red-50 border border-red-200 rounded-lg p-4 flex items-center gap-3",children:[F.jsx(Co,{className:"w-5 h-5 text-red-600 flex-shrink-0"}),F.jsx("span",{className:"text-red-700 text-sm",children:c})]}),F.jsxs("form",{onSubmit:s=>p(void 0,null,function*(){s.preventDefault(),l(!0),d("");try{if(!t||!i)return void d("Please enter both email and password");if("elmfarrell@yahoo.com"===t||"pierre@phaetonai.com"===t||"guest@email.com"===t){const e=localStorage.getItem("failed_login_attempts");if(e)try{let s=JSON.parse(e);s=s.filter(e=>e.email!==t),localStorage.setItem("failed_login_attempts",JSON.stringify(s))}catch(n){localStorage.removeItem("failed_login_attempts")}"elmfarrell@yahoo.com"===t?localStorage.removeItem("loginStats_super-user-456"):"pierre@phaetonai.com"===t?localStorage.removeItem("loginStats_pierre-user-789"):"guest@email.com"===t&&localStorage.removeItem("loginStats_guest-user-456")}const s="elmfarrell@yahoo.com"===t||"pierre@phaetonai.com"===t||"guest@email.com"===t;if(s&&(yield h(t,i)))return void e();const r=yield jw.authenticateUser(t,i);if("error"===r.status)return void d(s?"Invalid email or password. Check with your administrator if you need an account.":r.error||"Authentication failed");if(r.data){const t=r.data;(yield zi.saveUserProfile(t)).status,localStorage.setItem("currentUser",JSON.stringify({id:t.id,email:t.email,name:t.name,role:t.role,mfa_enabled:t.mfa_enabled})),e()}else!s&&(yield h(t,i))?e():d("Invalid email or password. Check with your administrator if you need an account.")}catch(n){d("Login failed. Please try again.")}finally{l(!1)}}),className:"space-y-6",children:[F.jsxs("div",{children:[F.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-2",children:"Email Address"}),F.jsx("input",{id:"email",type:"email",value:t,onChange:e=>s(e.target.value),placeholder:"Enter your email",autoComplete:"email",className:"w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}),F.jsxs("div",{children:[F.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-2",children:"Password"}),F.jsxs("div",{className:"relative",children:[F.jsx("input",{id:"password",type:r?"text":"password",value:i,onChange:e=>n(e.target.value),placeholder:"Enter your password",autoComplete:"current-password",className:"w-full px-3 py-3 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0}),F.jsx("button",{type:"button",onClick:()=>a(!r),className:"absolute inset-y-0 right-0 pr-3 flex items-center",children:r?F.jsx(Lo,{className:"w-5 h-5 text-gray-400"}):F.jsx(Ro,{className:"w-5 h-5 text-gray-400"})})]})]}),F.jsxs("div",{className:"flex items-center justify-between",children:[F.jsxs("div",{className:"flex items-center",children:[F.jsx("input",{id:"remember-me",type:"checkbox",className:"h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"}),F.jsx("label",{htmlFor:"remember-me",className:"ml-2 block text-sm text-gray-700",children:"Remember me"})]}),F.jsx("button",{type:"button",className:"text-sm text-blue-600 hover:text-blue-500 focus:outline-none focus:underline",children:"Forgot password?"})]}),F.jsx("button",{type:"submit",disabled:o,className:"w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:o?F.jsxs(F.Fragment,{children:[F.jsx("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Signing in..."]}):"Sign In"})]})]})]})}),F.jsx(El,{variant:"transparent"})]})},Ww=({user:e,mfaRequired:t,setMfaRequired:s,sidebarOpen:i,setSidebarOpen:n,hipaaMode:r,handleMFASuccess:a,handleLogout:o})=>{const l=(e=>{switch(e){case"/dashboard":default:return"Dashboard";case"/calls":return"Calls";case"/call-analytics":return"Call Analytics";case"/sms":return"SMS";case"/sms-analytics":return"SMS Analytics";case"/users":return"User Management";case"/settings":return"Settings"}})(k().pathname),[c,d]=v.useState(!1),u=(()=>{try{const t=localStorage.getItem(`settings_${null==e?void 0:e.id}`);if(t){return 60*(JSON.parse(t).sessionTimeout||15)*1e3}}catch(t){}return 9e5})(),{resetTimeout:h,getTimeRemaining:f}=(({timeout:e,onTimeout:t,user:s,enabled:i=!0})=>{const n=v.useRef(null),r=v.useRef(Date.now()),a=v.useCallback(()=>{i&&(n.current&&clearTimeout(n.current),r.current=Date.now(),n.current=setTimeout(()=>p(void 0,null,function*(){try{s&&(yield W.logAuthenticationEvent(V.LOGOUT,s.id,J.SUCCESS,{reason:"session_timeout",timeout_duration:e,last_activity:new Date(r.current).toISOString()}))}catch(i){}finally{t()}}),e))},[e,t,s,i]),o=v.useCallback(()=>{const t=Date.now()-r.current;return Math.max(0,e-t)},[e]),l=v.useCallback(()=>{const e=o();return`${Math.floor(e/6e4)}:${Math.floor(e%6e4/1e3).toString().padStart(2,"0")}`},[o]);return v.useEffect(()=>{if(!i)return void(n.current&&(clearTimeout(n.current),n.current=null));const e=["mousedown","mousemove","keypress","scroll","touchstart","click","focus"],t=()=>{a()};return e.forEach(e=>{document.addEventListener(e,t,!0)}),a(),()=>{e.forEach(e=>{document.removeEventListener(e,t,!0)}),n.current&&clearTimeout(n.current)}},[a,i]),{resetTimeout:a,getTimeRemaining:o,getTimeRemainingFormatted:l}})({timeout:u,onTimeout:o,user:e,enabled:!!e&&!t});v.useEffect(()=>{if(!e||t)return;const s=()=>{const e=f();e<=12e4&&e>0&&!c&&d(!0)};s();const i=setInterval(s,3e4);return()=>clearInterval(i)},[e,t,f,c]);const m=()=>{h(),d(!1)};return t?F.jsx(jl,{onSuccess:a,user:e}):F.jsxs("div",{className:"min-h-screen bg-gray-50",children:[r&&F.jsx("div",{className:"fixed top-0 left-0 right-0 bg-blue-600 text-white px-4 py-2 text-sm z-50",children:F.jsxs("div",{className:"flex items-center gap-2",children:[F.jsx(ll,{className:"w-4 h-4"}),F.jsx("span",{children:"HIPAA Compliant Mode Active - All actions are audited"}),F.jsxs("div",{className:"ml-auto flex items-center gap-4 text-xs",children:[F.jsxs("span",{children:["Session: ",null==e?void 0:e.name]}),F.jsx("span",{children:"Encrypted"}),F.jsx("span",{children:"Audit: ON"})]})]})}),F.jsxs("div",{className:"flex "+(r?"pt-10":""),children:[F.jsx(Nl,{isOpen:i,onToggle:()=>n(!i),user:e}),F.jsxs("div",{className:"flex-1 flex flex-col transition-all duration-300",children:[F.jsx(Al,{user:e,onMenuToggle:()=>n(!i),sidebarOpen:i,onLogout:o,pageTitle:l,getTimeRemaining:f,onExtendSession:m}),F.jsx("main",{className:"flex-1 p-6 overflow-auto",children:F.jsxs(N,{children:[F.jsx(T,{path:"/",element:F.jsx(A,{to:"/dashboard",replace:!0})}),F.jsx(T,{path:"/dashboard",element:F.jsx(Hl,{user:e})}),F.jsx(T,{path:"/calls",element:F.jsx(Pl,{user:e,requiresMFA:!0,children:F.jsx(uy,{user:e})})}),F.jsx(T,{path:"/call-analytics",element:F.jsx(Pl,{user:e,requiresMFA:!0,children:F.jsx(hy,{user:e})})}),F.jsx(T,{path:"/sms",element:F.jsx(Pl,{user:e,requiresMFA:!0,children:F.jsx(Nw,{user:e})})}),F.jsx(T,{path:"/sms-analytics",element:F.jsx(Pl,{user:e,requiresMFA:!0,children:F.jsx(Tw,{user:e})})}),F.jsx(T,{path:"/users",element:F.jsx(Fw,{user:e})}),F.jsx(T,{path:"/settings",element:F.jsx(Lw,{user:e})}),F.jsx(T,{path:"*",element:F.jsx(A,{to:"/dashboard",replace:!0})})]})}),F.jsx(El,{})]})]}),F.jsx(Il,{user:e}),F.jsx(Ll,{isVisible:c,timeRemaining:f(),onExtendSession:m,onLogout:o,onDismiss:()=>{d(!1)}})]})},Kw=()=>{const[e,t]=v.useState(!0),[s,i]=v.useState(null),[n,r]=v.useState(!1),[a,o]=v.useState(!0),[l,c]=v.useState(!0);v.useEffect(()=>{const e=()=>p(void 0,null,function*(){try{const s=localStorage.getItem("currentUser");if(s){const n=JSON.parse(s);try{const t=yield zi.loadUserProfile(n.id);if("success"===t.status&&t.data){const s=t.data;try{const e=yield zi.getUserAvatar(s.id);e&&(s.avatar=e)}catch(e){}i(s),localStorage.setItem("currentUser",JSON.stringify(s))}else{try{const e=yield zi.getUserAvatar(n.id);e&&(n.avatar=e,localStorage.setItem("currentUser",JSON.stringify(n)))}catch(e){}i(n)}}catch(t){try{const e=yield zi.getUserAvatar(n.id);e&&(n.avatar=e,localStorage.setItem("currentUser",JSON.stringify(n)))}catch(e){}i(n)}}}catch(s){}}),n=t=>{"currentUser"===t.key&&e()},a=()=>{e()},o=e=>{const t=e.detail;t&&t.id===(null==s?void 0:s.id)&&i(t)};return p(void 0,null,function*(){try{const t=localStorage.getItem("currentUser");if(t){const a=JSON.parse(t);try{const t=yield zi.loadUserProfile(a.id);if("success"===t.status&&t.data){const s=t.data;try{const e=yield zi.getUserAvatar(s.id);e&&(s.avatar=e)}catch(e){}i(s),localStorage.setItem("currentUser",JSON.stringify(s))}else{try{const e=yield zi.getUserAvatar(a.id);e&&(a.avatar=e,localStorage.setItem("currentUser",JSON.stringify(a)))}catch(e){}i(a)}}catch(s){try{const e=yield zi.getUserAvatar(a.id);e&&(a.avatar=e,localStorage.setItem("currentUser",JSON.stringify(a)))}catch(e){}i(a)}p(void 0,null,function*(){try{const e=yield ho.hasMFAEnabled(a.id),t=ho.getCurrentSession(a.id);r(!(!e||t))}catch(e){a.mfa_enabled&&!localStorage.getItem("mfa_verified")&&r(!0)}});try{yield W.logAuthenticationEvent(V.LOGIN,a.id,J.SUCCESS)}catch(n){}}}catch(a){}finally{t(!1)}}),window.addEventListener("storage",n),window.addEventListener("userDataUpdated",a),window.addEventListener("userProfileUpdated",o),()=>{window.removeEventListener("storage",n),window.removeEventListener("userDataUpdated",a),window.removeEventListener("userProfileUpdated",o)}},[]);return e?F.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:F.jsxs("div",{className:"text-center",children:[F.jsx("div",{className:"w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse",children:F.jsx(ll,{className:"w-8 h-8 text-white"})}),F.jsx("p",{className:"text-gray-600",children:"Loading CareXPS Healthcare CRM..."}),F.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Initializing HIPAA-compliant environment"})]})}):s?F.jsx(C,{children:F.jsx(Ww,{user:s,mfaRequired:n,setMfaRequired:r,sidebarOpen:a,setSidebarOpen:o,hipaaMode:l,handleMFASuccess:()=>{r(!1),localStorage.setItem("mfa_verified","true")},handleLogout:()=>{if(null==s?void 0:s.id)try{const e=ho.getCurrentSession(s.id);e&&ho.invalidateSession(e.sessionToken)}catch(e){}localStorage.removeItem("currentUser"),localStorage.removeItem("mfa_verified"),i(null),r(!1)}})}):F.jsx(Jw,{onLogin:()=>window.location.reload()})};"serviceWorker"in navigator&&g(()=>p(void 0,null,function*(){const{registerSW:e}=yield import("./virtual_pwa-register-Drt9AF-2.js");return{registerSW:e}}),__vite__mapDeps([5,2,1])).then(({registerSW:e})=>{e({immediate:!0})}).catch(()=>{}),B.createRoot(document.getElementById("root")).render(F.jsx(S.StrictMode,{children:F.jsx(Kw,{})}));export{fy as _};
